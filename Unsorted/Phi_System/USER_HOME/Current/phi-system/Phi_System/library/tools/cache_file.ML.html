<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹library/tools/cache_file.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹library/tools/cache_file.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(* Building Cache *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>PHI_CACHE_DB</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>proof_id</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_ID.encoded_ID</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>proof_cache</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Time.time</span><span> * </span><span>string</span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>cache</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>proofs</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>proof_cache</span></span><span> </span><span>Symtab.table</span><span class="main"><span>,</span></span><span>
              </span><span>async_tasks</span><span class="main"><span>:</span></span><span> </span><span>Task_Queue.task</span><span> </span><span>list</span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> get_cache </span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>cache</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> force_reload </span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>cache</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> register_async_task </span><span class="main"><span>:</span></span><span> </span><span>Task_Queue.task</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> store_cache </span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> store_and_close_cache </span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> invalidate_cache </span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> invalidate_proof_cache </span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span class="comment1"><span>(*whether warn*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>proof_id</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span>
</span><span class="comment1"><span>(* val check_cache : string (*Document_ID*) -&gt; Proof.context -&gt; unit *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> report_cache_is_outdated </span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span class="comment1"><span>(*whether warn*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> get_cached_proof </span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>proof_id</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>Time.time</span><span> * </span><span>string</span><span class="main"><span>)</span></span><span> </span><span>option</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> update_cached_proof </span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>proof_id</span></span><span> * </span><span class="main"><span>(</span></span><span>Time.time</span><span> * </span><span>string</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Phi_Cache_DB</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>PHI_CACHE_DB</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>proof_id</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>string</span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>proof_cache</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Time.time</span><span> * </span><span>string</span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>cache</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>proofs</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>Time.time</span><span> * </span><span>string</span><span class="main"><span>)</span></span><span> </span><span>Symtab.table</span><span class="main"><span>,</span></span><span>
              </span><span>async_tasks</span><span class="main"><span>:</span></span><span> </span><span>Task_Queue.task</span><span> </span><span>list</span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty_cache</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>proofs</span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.empty</span><span class="main"><span>,</span></span><span> </span><span>async_tasks</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>cache</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cache_update_proof</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>proofs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>async_tasks</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span class="entity"><span>cache</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>proofs</span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>proofs</span></span><span class="main"><span>,</span></span><span>
         </span><span>async_tasks</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>async_tasks</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>cache</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cache_invalidate_proof</span></span><span> </span><span class="entity"><span>id</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>proofs</span></span><span class="main"><span>,</span></span><span class="entity"><span>async_tasks</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span class="entity"><span>cache</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>proofs</span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.delete_safe</span><span> </span><span class="entity"><span>id</span></span><span> </span><span class="entity"><span>proofs</span></span><span> </span><span class="comment1"><span>(*Symtab.fold (fn (k,_) =&gt;
                      if Phi_ID.dep id k
                      then Symtab.delete k
                      else I) proofs proofs*)</span></span><span class="main"><span>,</span></span><span>
         </span><span>async_tasks</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
        </span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>cache</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cache_add_async</span></span><span> </span><span class="entity"><span>task</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>proofs</span></span><span class="main"><span>,</span></span><span class="entity"><span>async_tasks</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span class="entity"><span>cache</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>proofs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>proofs</span></span><span class="main"><span>,</span></span><span> </span><span>async_tasks</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>task</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>async_tasks</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>cache</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>XML</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>encode_cache</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>proofs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>cache</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Elem</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"cache"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span>
    </span><span>Elem</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"proofs"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
      </span><span>Symtab.fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>prf</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span>Elem</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"prf"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                </span><span class="main"><span>[</span></span><span>Text</span><span> </span><span class="main"><span>(</span></span><span>String.concatWith</span><span> </span><span class="inner_quoted"><span>"|"</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span>string_of_int</span><span> </span><span class="main"><span>(</span></span><span>Time.toMilliseconds</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>prf</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
          </span><span>::</span><span> </span><span class="entity"><span>L</span></span><span class="main"><span>)</span></span><span>
        </span><span class="entity"><span>proofs</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>decode_cache</span></span><span> </span><span class="main"><span>(</span></span><span>Elem</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"cache"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span>
      </span><span>Elem</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"proofs"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>entries</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span> </span><span>proofs</span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>Elem</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"prf"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span>Text</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span class="entity"><span>t'</span></span><span class="main"><span>,</span></span><span class="entity"><span>prf</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>String.fields</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>#"|"</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span>
                   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Symtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>Time.fromMilliseconds</span><span> </span><span class="main"><span>(</span></span><span>Value.parse_nat</span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
               </span><span class="entity"><span>entries</span></span><span> </span><span>Symtab.empty</span><span class="main"><span>,</span></span><span>
      </span><span>async_tasks</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
    </span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>cache</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cache_path</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> 
      </span><span>Path.append</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Resources.master_directory</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Path.basic</span><span> </span><span class="main"><span>(</span></span><span>Context.theory_name</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span>|&gt;</span><span> </span><span>Path.ext</span><span> </span><span class="inner_quoted"><span>"phi-cache"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>openning_caches</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cache</span></span><span> * </span><span>bool</span><span class="main"><span>)</span></span><span> </span><span>Symtab.table</span><span> </span><span>Synchronized.var</span><span>
  </span><span class="main"><span>=</span></span><span> </span><span>Synchronized.var</span><span> </span><span class="inner_quoted"><span>"φ-System.openning_caches"</span></span><span> </span><span>Symtab.empty</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>load_cache_raw</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>path</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cache_path</span></span><span> </span><span class="entity"><span>thy</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>File.is_file</span><span> </span><span class="entity"><span>path</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>decode_cache</span></span><span> </span><span class="main"><span>(</span></span><span>XML.parse</span><span> </span><span class="main"><span>(</span></span><span>Bytes.read</span><span> </span><span class="entity"><span>path</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>XZ.uncompress</span></span><span> </span><span>|&gt;</span><span> </span><span>Bytes.content</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
           </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>er</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>
            </span><span> </span><span>warning</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"corrupted cache : "</span></span><span> </span><span>^</span><span> </span><span>Context.theory_name</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"\n"</span></span><span> </span><span>^</span><span>
                      </span><span>Runtime.exn_message</span><span> </span><span class="entity"><span>er</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
            </span><span> </span><span class="entity"><span>empty_cache</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>empty_cache</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>force_reload</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Synchronized.change_result</span><span> </span><span class="entity"><span>openning_caches</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>load_cache_raw</span></span><span> </span><span class="entity"><span>thy</span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span>Symtab.update</span><span> </span><span class="main"><span>(</span></span><span>Context.theory_name</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tab</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span> </span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_cache_i</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Symtab.lookup</span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="main"><span>(</span></span><span>Context.theory_name</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tab</span></span><span class="main"><span>)</span></span><span>
       </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>load_cache_raw</span></span><span> </span><span class="entity"><span>thy</span></span><span>
               </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span>Symtab.update_new</span><span> </span><span class="main"><span>(</span></span><span>Context.theory_name</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tab</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_cache</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Synchronized.change_result</span><span> </span><span class="entity"><span>openning_caches</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_cache_i</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>register_async_task</span></span><span> </span><span class="entity"><span>task</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Context.theory_name</span><span> </span><span class="entity"><span>thy</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Synchronized.change</span><span> </span><span class="entity"><span>openning_caches</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Symtab.lookup</span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="entity"><span>name</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>flag</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Symtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cache_add_async</span></span><span> </span><span class="entity"><span>task</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>flag</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tab</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cache_add_async</span></span><span> </span><span class="entity"><span>task</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>load_cache_raw</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span>
                 </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Symtab.update_new</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span> </span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>store_cache'</span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Symtab.lookup</span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="main"><span>(</span></span><span>Context.theory_name</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>changed</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>changed</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Bytes.write</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cache_path</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>XZ.compress</span></span><span> </span><span class="main"><span>(</span></span><span>Bytes.string</span><span> </span><span class="main"><span>(</span></span><span>
              </span><span>XML.string_of</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>encode_cache</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
     </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>store_cache</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>store_cache'</span></span><span> </span><span class="main"><span>(</span></span><span>Synchronized.value</span><span> </span><span class="entity"><span>openning_caches</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thy</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>store_and_close_cache</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Synchronized.change</span><span> </span><span class="entity"><span>openning_caches</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>store_cache'</span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>;</span></span><span>
    </span><span> </span><span>Symtab.delete_safe</span><span> </span><span class="main"><span>(</span></span><span>Context.theory_name</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tab</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>invalidate_cache</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Synchronized.change</span><span> </span><span class="entity"><span>openning_caches</span></span><span> </span><span class="main"><span>(</span></span><span>Symtab.update</span><span> </span><span class="main"><span>(</span></span><span>Context.theory_name</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>empty_cache</span></span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_cached_proof</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.lookup</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>proofs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_cache</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>update_cached_proof</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Synchronized.change</span><span> </span><span class="entity"><span>openning_caches</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>
   </span><span> </span><span class="entity"><span>get_cache_i</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>tab</span></span><span class="main"><span>;</span></span><span>
   </span><span> </span><span>Symtab.map_entry</span><span> </span><span class="main"><span>(</span></span><span>Context.theory_name</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span>
                     </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cache_update_proof</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tab</span></span><span>
  </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>report_cache_is_outdated</span></span><span> </span><span class="entity"><span>warn</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>Phi_Envir.runtime_mode</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Envir.PRODUCTION</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>error</span><span>   </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Proof cache of "</span></span><span> </span><span>^</span><span> </span><span>Context.theory_name</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" is outdated!"</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>warn</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>warning</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Proof cache of "</span></span><span> </span><span>^</span><span> </span><span>Context.theory_name</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" is outdated!"</span></span><span class="main"><span>)</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>invalidate_proof_cache</span></span><span> </span><span class="entity"><span>warn</span></span><span> </span><span class="entity"><span>id</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
 </span><span class="main"><span>(</span></span><span class="entity"><span>report_cache_is_outdated</span></span><span> </span><span class="entity"><span>warn</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>;</span></span><span>
 </span><span> </span><span>Synchronized.change</span><span> </span><span class="entity"><span>openning_caches</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>
   </span><span> </span><span class="entity"><span>get_cache_i</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>tab</span></span><span class="main"><span>;</span></span><span>
   </span><span> </span><span>Symtab.map_entry</span><span> </span><span class="main"><span>(</span></span><span>Context.theory_name</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cache_invalidate_proof</span></span><span> </span><span class="entity"><span>id</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tab</span></span><span>
 </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(** Document_ID of each construct to detect if caches are invalid **)</span></span><span>
</span><span class="comment1"><span>(*
val doc_ids : string Phi_ID.Tab.table Synchronized.var
      = Synchronized.var "φ-System.doc_ids" Phi_ID.Tab.empty

fun check_cache' construct doc_id thy =
  let fun clean_tab tab =
            Phi_ID.Tab.fold (fn (k,_) =&gt;
              if Phi_ID.dep' construct k
              then Phi_ID.Tab.delete k
              else I) tab tab
   in if null (snd construct)
         orelse (Synchronized.change_result doc_ids (fn tab =&gt;
            case Phi_ID.Tab.lookup tab construct
              of SOME id' =&gt;
                  if id' = doc_id
                  then (true , tab)
                  else (false, Phi_ID.Tab.update (construct, doc_id) (clean_tab tab))
               | _ =&gt;  (true , Phi_ID.Tab.update (construct, doc_id) tab)))
      then ()
      else invalidate_proof_cache (Phi_ID.encode construct) thy
  end

fun check_cache doc_id ctxt =
  case Phi_ID.get ctxt
    of SOME phid =&gt; check_cache' phid doc_id (Proof_Context.theory_of ctxt)
     | _ =&gt; () *)</span></span><span>

</span><span class="comment1"><span>(*TODO: maybe we need some way to clean up unused cache entries.*)</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Theory.setup</span><span> </span><span class="main"><span>(</span></span><span>Theory.at_end</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>
 </span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>Phi_Envir.runtime_mode</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Envir.PRODUCTION</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tasks</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>async_tasks</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_cache</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>tasks</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>store_and_close_cache</span></span><span> </span><span class="entity"><span>thy</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span>tracing</span><span> </span><span class="inner_quoted"><span>"There are asynchronous proof tasks. The proof cache will be written \
                         \once they are finished."</span></span><span> </span><span class="main"><span>;</span></span><span>
                </span><span> </span><span>Future.forks</span><span> </span><span class="main"><span>{</span></span><span>name</span><span class="main"><span>=</span></span><span class="inner_quoted"><span>"φSystem.store_cache"</span></span><span class="main"><span>,</span></span><span> </span><span>group</span><span class="main"><span>=</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span>deps</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tasks</span></span><span class="main"><span>,</span></span><span> </span><span>pri</span><span class="main"><span>=</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span>interrupts</span><span class="main"><span>=</span></span><span>false</span><span class="main"><span>}</span></span><span>
                  </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>store_and_close_cache</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>;</span></span><span>
                            </span><span> </span><span>tracing</span><span> </span><span class="inner_quoted"><span>"The proof cache has been written."</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>;</span></span><span>
               </span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span></pre>
</body>

</html>