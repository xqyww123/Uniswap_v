<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹library/tools/sledgehammer_solver.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹library/tools/sledgehammer_solver.ML›</h1>
</div>

<pre class="source"><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>PHI_SLEDGEHAMMER_SOLVER</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> auto </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Phi_Cache_DB.proof_id</span></span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context_state</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> assync_proof </span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span>Config.T</span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Phi_Sledgehammer_Solver</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>PHI_SLEDGEHAMMER_SOLVER</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="comment1"><span>(*** Proof cache by hash ***)</span></span><span>
</span><span class="comment1"><span>(*Useful when the user is editing the document causing many cache miss, which could be saved
  by using term-based hash caching*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>hash_cache</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Phi_Cache_DB.proof_cache</span></span><span> </span><span>Symtab.table</span><span> </span><span>Synchronized.var</span><span>
      </span><span class="main"><span>=</span></span><span> </span><span>Synchronized.var</span><span> </span><span class="inner_quoted"><span>"φSystem.proof_cache.hash"</span></span><span> </span><span>Symtab.empty</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>access_hash_cache</span></span><span> </span><span class="entity"><span>hash</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>Phi_Envir.runtime_mode</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Envir.NORMAL</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>hc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Synchronized.value</span><span> </span><span class="entity"><span>hash_cache</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Symtab.lookup</span><span> </span><span class="entity"><span>hc</span></span><span> </span><span class="entity"><span>hash</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>update_hash_cache</span></span><span> </span><span class="entity"><span>hash</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>Phi_Envir.runtime_mode</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Envir.NORMAL</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Synchronized.change</span><span> </span><span class="entity"><span>hash_cache</span></span><span> </span><span class="main"><span>(</span></span><span>Symtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>hash</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>


</span><span class="comment1"><span>(*** Adapter of Sledgehammer ***)</span></span><span>

</span><span class="comment1"><span>(*copied and modified from Isabelle-2022/src/HOL/Tools/Sledgehammer/sledgehammer_proof_methods.ML
  Original Author: Jasmin Blanchette, TU Muenchen
                   Steffen Juilf Smolka, TU Muenchen

  May need to be synced once updated.
*)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Sledgehammer_Proof_Methods</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_proof_method_direct</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Metis_Method</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_proof_method_direct</span></span><span> </span><span class="entity"><span>Meson_Method</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_proof_method_direct</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMT_Method</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_proof_method_direct</span></span><span> </span><span class="entity"><span>Simp_Method</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_proof_method_direct</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_proof_method_multi_goal</span></span><span> </span><span class="entity"><span>Auto_Method</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_proof_method_multi_goal</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>string_of_proof_method</span></span><span> </span><span class="entity"><span>ss</span></span><span> </span><span class="entity"><span>meth</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>meth_s</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>meth</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
       </span><span> </span><span class="entity"><span>Metis_Method</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"metis"</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Metis_Method</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>type_enc_opt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lam_trans_opt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="inner_quoted"><span>"metis ("</span></span><span> </span><span>^</span><span> </span><span>commas</span><span> </span><span class="main"><span>(</span></span><span>map_filter</span><span> </span><span>I</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>type_enc_opt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lam_trans_opt</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>")"</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Meson_Method</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"meson"</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>SMT_Method</span></span><span> </span><span class="entity"><span>SMT_Z3</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"smt (z3)"</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>SMT_Method</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMT_Verit</span></span><span> </span><span class="entity"><span>strategy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="inner_quoted"><span>"smt ("</span></span><span> </span><span>^</span><span> </span><span>commas</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"verit"</span></span><span> </span><span>::</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>strategy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"default"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>strategy</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>")"</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>SATx_Method</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"satx"</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Blast_Method</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"blast"</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Simp_Method</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>ss</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_quoted"><span>"simp"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_quoted"><span>"simp add:"</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Auto_Method</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"auto"</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Fastforce_Method</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"fastforce"</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Force_Method</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"force"</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Moura_Method</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"moura"</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Linarith_Method</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"linarith"</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Presburger_Method</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"presburger"</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Algebra_Method</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"algebra"</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
   </span><span> </span><span>space_implode</span><span> </span><span class="inner_quoted"><span>" "</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>meth_s</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ss</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>proof_method_command</span></span><span> </span><span class="entity"><span>meth</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>extras</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>indirect_ss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>direct_ss</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_proof_method_direct</span></span><span> </span><span class="entity"><span>meth</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extras</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>extras</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
   </span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>indirect_ss</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_quoted"><span>"(insert "</span></span><span> </span><span>^</span><span> </span><span>space_implode</span><span> </span><span class="inner_quoted"><span>" "</span></span><span> </span><span class="entity"><span>indirect_ss</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>")[1], "</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_proof_method_multi_goal</span></span><span> </span><span class="entity"><span>meth</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="inner_numeral"><span>1</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_quoted"><span>"("</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>string_of_proof_method</span></span><span> </span><span class="entity"><span>direct_ss</span></span><span> </span><span class="entity"><span>meth</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>")[1]"</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>string_of_proof_method</span></span><span> </span><span class="entity"><span>direct_ss</span></span><span> </span><span class="entity"><span>meth</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>one_line_proof_text</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>used_facts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>meth</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subgoal_count</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extra</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.partition</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sc</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>sc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ATP_Problem_Generate.Chained</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>used_facts</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
   </span><span> </span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>extra</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>proof_method_command</span></span><span> </span><span class="entity"><span>meth</span></span><span> </span><span class="entity"><span>subgoal_count</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>silence_state</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>Proof.map_contexts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Try0.silence_methods</span></span><span> </span><span>false</span><span> </span><span>#&gt;</span><span> </span><span>Config.put</span><span> </span><span class="entity"><span>SMT_Config.verbose</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sledgehammer_params</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="comment1"><span>(*("preplay_timeout","0")*)</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>time_ord</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span>Time.time</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>EQUAL</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>&lt;</span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>LESS</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>GREATER</span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>preplay_ord</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Sledgehammer_Proof_Methods.Played</span></span><span> </span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                 </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Sledgehammer_Proof_Methods.Played</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>time_ord</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>preplay_ord</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Sledgehammer_Proof_Methods.Played</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                 </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Sledgehammer_Proof_Methods.Play_Timed_Out</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>=</span></span><span> </span><span>LESS</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>preplay_ord</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Sledgehammer_Proof_Methods.Play_Timed_Out</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                 </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Sledgehammer_Proof_Methods.Played</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>=</span></span><span> </span><span>GREATER</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>preplay_ord</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Sledgehammer_Proof_Methods.Play_Timed_Out</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                 </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Sledgehammer_Proof_Methods.Play_Timed_Out</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>=</span></span><span> </span><span>EQUAL</span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>fail_reason</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Too_Many_Subgoals</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Timeout</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Application_Fails</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Unknown</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>Auto_Fail</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>fail_reason</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>eval_prf_str</span></span><span> </span><span class="entity"><span>timeout</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
     </span><span class="main"><span>(</span></span><span>Timeout.apply</span><span> </span><span class="entity"><span>timeout</span></span><span> </span><span class="main"><span>(</span></span><span>Timing.timing</span><span> </span><span class="entity"><span>Phi_Reasoners.auto_obligation_solver1</span></span><span class="main"><span>)</span></span><span>
                                  </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>cpu</span><span class="main"><span>=</span></span><span class="entity"><span>time</span></span><span class="main"><span>,</span></span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>time</span></span><span class="main"><span>,</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>Phi_Reasoners.Automation_Fail</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Auto_Fail</span></span><span> </span><span class="entity"><span>Application_Fails</span></span><span>
                  </span><span class="main"><span>|</span></span><span> </span><span> </span><span>Timeout.TIMEOUT</span><span> </span><span class="main"><span>_</span></span><span>               </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Auto_Fail</span></span><span> </span><span class="entity"><span>Timeout</span></span><span>
                  </span><span class="main"><span>|</span></span><span> </span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>tracing</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Unexpected error, maybe a bug: "</span></span><span> </span><span>^</span><span> </span><span>Runtime.exn_message</span><span> </span><span class="entity"><span>err</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
                            </span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Auto_Fail</span></span><span> </span><span class="entity"><span>Unknown</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>eval_prf_str</span></span><span> </span><span class="entity"><span>timeout</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>meth</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="entity"><span>Method.evaluate</span></span><span> </span><span class="main"><span>(</span></span><span>
              </span><span>Parse.read_embedded</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>Thy_Header.get_keywords</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                                       </span><span class="entity"><span>Method.parse</span></span><span> </span><span class="main"><span>(</span></span><span>Input.string</span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>)</span></span><span>
                </span><span>|&gt;</span><span> </span><span>fst</span><span>
                </span><span>|&gt;</span><span> </span><span class="entity"><span>Method.check_text</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
              </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Timeout.apply</span><span> </span><span class="entity"><span>timeout</span></span><span> </span><span class="main"><span>(</span></span><span>Timing.timing</span><span> </span><span>Seq.pull</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>meth</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span>cpu</span><span class="main"><span>=</span></span><span class="entity"><span>time</span></span><span class="main"><span>,</span></span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Seq.Result</span><span> </span><span class="entity"><span>ret</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>time</span></span><span class="main"><span>,</span></span><span class="entity"><span>prf</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ret</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Auto_Fail</span></span><span> </span><span class="entity"><span>Application_Fails</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Timeout.TIMEOUT</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Auto_Fail</span></span><span> </span><span class="entity"><span>Timeout</span></span><span>
               </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>tracing</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Unexpected error, maybe a bug: "</span></span><span> </span><span>^</span><span> </span><span>Runtime.exn_message</span><span> </span><span class="entity"><span>err</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
                         </span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Auto_Fail</span></span><span> </span><span class="entity"><span>Unknown</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>eval_prf_str_stat</span></span><span> </span><span class="entity"><span>timeout</span></span><span> </span><span class="entity"><span>F_None</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="entity"><span>stat</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Proof.context_of</span></span><span> </span><span class="entity"><span>stat</span></span><span>
       </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>keywords</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thy_Header.get_keywords</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Timeout.apply</span><span> </span><span class="main"><span>(</span></span><span>Time.fromSeconds</span><span> </span><span class="entity"><span>timeout</span></span><span class="main"><span>)</span></span><span>
                </span><span>Seq.pull</span><span>
                </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.apply</span></span><span> </span><span class="main"><span>(</span></span><span>Parse.read_embedded</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>keywords</span></span><span> </span><span class="entity"><span>Method.parse</span></span><span>
                                                  </span><span class="main"><span>(</span></span><span>Input.string</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"("</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>prf</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>")"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>stat</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Seq.Result</span><span> </span><span class="entity"><span>stat'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>stat'</span></span><span class="main"><span>)</span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>F_None</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
                               </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Auto_Fail</span></span><span> </span><span class="entity"><span>Application_Fails</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Timeout.TIMEOUT</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>
         </span><span> </span><span>tracing</span><span> </span><span class="inner_quoted"><span>"The proof fails due to timeout. Re-searching proofs..."</span></span><span class="main"><span>;</span></span><span>
         </span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Auto_Fail</span></span><span> </span><span class="entity"><span>Timeout</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>
         </span><span> </span><span>tracing</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Unexpected error, maybe a bug: "</span></span><span> </span><span>^</span><span> </span><span>Runtime.exn_message</span><span> </span><span class="entity"><span>err</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
         </span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Auto_Fail</span></span><span> </span><span class="entity"><span>Unknown</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>SH_Short_Cut</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>string</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dirty_hack</span></span><span> </span><span class="entity"><span>ret</span></span><span> </span><span class="entity"><span>stat</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>find</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>CharVector.foldri</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ret</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>c'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ret</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>ret</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>s</span></span><span>
     </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>find</span></span><span> </span><span class="inner_quoted"><span>#"\^E"</span></span><span> </span><span class="entity"><span>s</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>length</span><span> </span><span class="entity"><span>inds</span></span><span> </span><span>&lt;</span><span> </span><span class="inner_numeral"><span>4</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>tracing</span><span> </span><span class="entity"><span>s</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
       </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>i2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.nth</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inds</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
       </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>i3</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.nth</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inds</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span class="main"><span>)</span></span><span>
       </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>i4</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.nth</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inds</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>3</span></span><span class="main"><span>)</span></span><span>
       </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>s_prf</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>String.substring</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i2</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i3</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>-</span><span class="entity"><span>i2</span></span><span class="main"><span>)</span></span><span>
       </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>preplay_succeeded</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>is_some</span><span> </span><span class="main"><span>(</span></span><span>CharVector.findi</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>&gt;</span><span> </span><span class="entity"><span>i4</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>#"("</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>trans</span></span><span> </span><span class="entity"><span>toks</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>toks1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>toks</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"internal bug #e12asfwgy43"</span></span><span>
                                     </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tok</span></span><span>::</span><span class="entity"><span>L</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                                 </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Token.is_command</span><span> </span><span class="entity"><span>tok</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>Token.content_of</span><span> </span><span class="entity"><span>tok</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"using"</span></span><span>
                                 </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>tok</span></span><span>::</span><span class="entity"><span>L</span></span><span>
             </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sep</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>find_index</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>tok</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Token.is_command</span><span> </span><span class="entity"><span>tok</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
                                              </span><span class="main"><span>(</span></span><span>Token.content_of</span><span> </span><span class="entity"><span>tok</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"apply"</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
                                               </span><span>Token.content_of</span><span> </span><span class="entity"><span>tok</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"by"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>toks1</span></span><span>
             </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>using</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tac</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>sep</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"internal bug #e12asfwgy44"</span></span><span>
                                 </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span>take</span><span> </span><span class="entity"><span>sep</span></span><span> </span><span class="entity"><span>toks1</span></span><span class="main"><span>,</span></span><span> </span><span>drop</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sep</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>toks1</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unparse</span></span><span> </span><span class="entity"><span>toks</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>String.concatWith</span><span> </span><span class="inner_quoted"><span>" "</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Token.unparse</span><span> </span><span class="entity"><span>toks</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unparse_tac</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tok1</span></span><span>::</span><span class="entity"><span>tok2</span></span><span>::</span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Token.keyword_with</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"["</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tok2</span></span><span>
                       </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>Token.keyword_with</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tok1</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_quoted"><span>"("</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>unparse</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>tok1</span></span><span class="main"><span>]</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>")"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>unparse</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tok2</span></span><span>::</span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>unparse</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tok1</span></span><span>::</span><span class="entity"><span>tok2</span></span><span>::</span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span>
                </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>unparse_tac</span></span><span> </span><span class="entity"><span>toks</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unparse</span></span><span> </span><span class="entity"><span>toks</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>using</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_quoted"><span>"(insert "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>unparse</span></span><span> </span><span class="entity"><span>using</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>")[1], "</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>unparse_tac</span></span><span> </span><span class="entity"><span>tac</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
       </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Proof.context_of</span></span><span> </span><span class="entity"><span>stat</span></span><span>
       </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>keywords</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thy_Header.get_keywords</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
       </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>trans</span></span><span> </span><span class="main"><span>(</span></span><span>Input.string</span><span> </span><span class="entity"><span>s_prf</span></span><span>
                      </span><span>|&gt;</span><span> </span><span>Input.source_explode</span><span>
                      </span><span>|&gt;</span><span> </span><span>Token.tokenize</span><span> </span><span class="entity"><span>keywords</span></span><span> </span><span class="main"><span>{</span></span><span>strict</span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span class="main"><span>}</span></span><span>
                      </span><span>|&gt;</span><span> </span><span>filter</span><span> </span><span>Token.is_proper</span><span class="main"><span>)</span></span><span>
       </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Synchronized.change</span><span> </span><span class="entity"><span>ret</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>prfs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>prfs</span></span><span class="main"><span>)</span></span><span>
       </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>tracing</span><span> </span><span class="entity"><span>s</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>preplay_succeeded</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>can</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eval_prf_str_stat</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span>NONE</span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>stat</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SH_Short_Cut</span></span><span> </span><span class="entity"><span>prf</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>raw_sledgehammer</span></span><span> </span><span class="entity"><span>stat</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>N</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>goal</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.goal</span></span><span> </span><span class="entity"><span>stat</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>Thm.nprems_of</span><span>
     </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>N</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"No subgoal!"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
     </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ret</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span>Synchronized.var</span><span> </span><span class="main"><span>=</span></span><span> </span><span>Synchronized.var</span><span> </span><span class="inner_quoted"><span>"φSystem.raw_sledgehammer"</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Sledgehammer.run_sledgehammer</span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>Sledgehammer_Commands.default_params</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.theory_of</span></span><span> </span><span class="entity"><span>stat</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sledgehammer_params</span></span><span class="main"><span>)</span></span><span>
              </span><span class="entity"><span>Sledgehammer_Prover.Normal</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dirty_hack</span></span><span> </span><span class="entity"><span>ret</span></span><span> </span><span class="entity"><span>stat</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>Sledgehammer_Fact.no_fact_override</span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>silence_state</span></span><span> </span><span class="entity"><span>stat</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span> </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>print</span></span><span class="antiquote"><span>}</span></span></span></span></span></span></span></span></span><span> </span><span class="main"><span>(</span></span><span>Synchronized.value</span><span> </span><span class="entity"><span>ret</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(* For some unknown reason, the return of Sledgehammer.run_sledgehammer doesn't give me everything
   it finds (not match to its output to users), so I have to dirty hijack its output stream and
   recovery the result in a hacking way.
   

  (case Sledgehammer.run_sledgehammer
              (Sledgehammer_Commands.default_params (Proof.theory_of stat) sledgehammer_params)
              Sledgehammer_Prover.Normal (SOME (dirty_hack ret stat)) 1 Sledgehammer_Fact.no_fact_override
              (silence_state stat)
        of (_, (Sledgehammer.SH_Some (result, preplays0), _)) =&gt;
            let val preplays = @{print} preplays0
                            |&gt; filter (fn (_, Sledgehammer_Proof_Methods.Played _, _) =&gt; true
                                        | _ =&gt; false)
                            |&gt; sort preplay_ord
                val alt_output = Synchronized.value ret
             in @{print} alt_output
            end
         | _ =&gt; raise Phi_Reasoners.Automation_Fail NONE)*)</span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>SH_Short_Cut</span></span><span> </span><span class="entity"><span>ret</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>ret</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(*** Proof search using Sledgehammer ***)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>assync_proof</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.setup_config_bool</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="IDE_CP_Core.\&lt;phi&gt;assync_proof|attribute"><span>φassync_proof</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>assync_prove</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>goal_term</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.cprop_of</span><span> </span><span class="entity"><span>sequent</span></span><span> </span><span>|&gt;</span><span> </span><span>Thm.dest_implies</span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Term.maxidx_term</span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="entity"><span>goal_term</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
         </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>assync_proof</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pos'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thread_Position.get</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
              </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Position.make</span><span> </span><span class="entity"><span>pos'</span></span><span>
              </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>hyps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Assumption.all_assms_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
              </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal_term'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Drule.list_implies</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>hyps</span></span><span class="main"><span>,</span></span><span class="entity"><span>goal_term</span></span><span class="main"><span>)</span></span><span>
              </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal_stat</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Goal.init</span><span> </span><span class="entity"><span>goal_term</span></span><span>
              </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>future</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Execution.fork</span><span> </span><span class="main"><span>{</span></span><span>name</span><span class="main"><span>=</span></span><span class="inner_quoted"><span>"φSystem-async-proof"</span></span><span class="main"><span>,</span></span><span> </span><span>pos</span><span class="main"><span>=</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span> </span><span>pri</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                       </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>goal_stat</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="comment1"><span>(*|&gt; Thm.solve_constraints
                    |&gt; Thm.strip_shyps *)</span></span><span>
                    </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span>Thm.implies_intr</span><span> </span><span class="entity"><span>hyps</span></span><span>
                    </span><span>|&gt;</span><span> </span><span>Goal.conclude</span><span> </span><span class="comment1"><span>(*
                    |&gt; (fn th =&gt; (if Thm.prop_of th aconv Thm.term_of goal_term' then () else
                                  error "XXXXXXXXXXXXX!"; th)) *)</span></span><span>
                  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span>
                    </span><span> </span><span class="entity"><span>Auto_Fail</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>
                      </span><span> </span><span>Future.error_message</span><span> </span><span class="entity"><span>pos</span></span><span>
                          </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>serial</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Phi_Reasoners.error_message</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
                      </span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Reasoners.error_message</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Cache_DB.register_async_task</span></span><span> </span><span class="main"><span>(</span></span><span>Future.task_of</span><span> </span><span class="entity"><span>future</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Thm.implies_elim</span><span> </span><span class="entity"><span>sequent</span></span><span> </span><span class="main"><span>(</span></span><span>
                  </span><span>Goal.future_result</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>future</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="entity"><span>goal_term'</span></span><span class="main"><span>)</span></span><span> </span><span class="comment1"><span>(*TODO: optimize this!*)</span></span><span>
                    </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Thm.implies_elim</span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.assume</span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>hyps</span></span><span class="main"><span>)</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>wrapper</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Thm.no_prems</span><span> </span><span class="entity"><span>sequent</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>sequent</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.major_prem_of</span><span> </span><span class="entity"><span>sequent</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.TrueI|fact"><span>TrueI</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>sequent</span></span><span>
     </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../Phi_Logic_Programming_Reasoner.Phi_Logic_Programming_Reasoner.html#Phi_Logic_Programming_Reasoner.Premise|const"><span>Premise</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
         </span><span class="main"><span>=&gt;</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../Phi_Logic_Programming_Reasoner.Phi_Logic_Programming_Reasoner.html#Phi_Logic_Programming_Reasoner.Premise_True|fact"><span>Premise_True</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>sequent</span></span><span>
     </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>assync_prove</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>time_delt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Time.fromMilliseconds</span><span> </span><span class="inner_numeral"><span>1000</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>folerant_time</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Time.scale</span><span> </span><span class="inner_numeral"><span>1.3</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>time_delt</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>funpow'</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>:</span></span><span> </span><span>int</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>x</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>funpow'</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>funpow'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>sledgehammer</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent0</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Envir.freeze_dynamic_lemmas</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
     </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sequent</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../Phi_Logic_Programming_Reasoner.Phi_Logic_Programming_Reasoner.html#Phi_Logic_Programming_Reasoner.Premise_I|fact"><span>Premise_I</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>sequent0</span></span><span> </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>sequent0</span></span><span>
     </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>goal_term</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.dest_implies</span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span>
     </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>stat</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Proof.theorem</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>I</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>goal_term</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>eval_prf_strs_stat</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Auto_Fail</span></span><span> </span><span class="entity"><span>Application_Fails</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>eval_prf_strs_stat</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prf</span></span><span>::</span><span class="entity"><span>L</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>stat</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="entity"><span>eval_prf_str_stat</span></span><span> </span><span class="inner_numeral"><span>30</span></span><span> </span><span>NONE</span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="entity"><span>stat</span></span><span>
            </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>Auto_Fail</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>eval_prf_strs_stat</span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="entity"><span>stat</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>search_prf</span></span><span> </span><span class="entity"><span>prompt</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
         </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prf0</span></span><span class="main"><span>,</span></span><span class="entity"><span>stat0</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eval_prf_str_stat</span></span><span> </span><span class="inner_numeral"><span>5</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span class="entity"><span>stat</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prompt</span></span><span> </span><span class="entity"><span>stat</span></span><span>
         </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>N</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.nprems_of</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>goal</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.raw_goal</span></span><span> </span><span class="entity"><span>stat0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
         </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Ns</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>N</span></span><span>

         </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>N</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>20</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span>tracing</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"The prompt generates too many subgoals ("</span></span><span> </span><span>^</span><span>
                                    </span><span>string_of_int</span><span> </span><span class="entity"><span>N</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"). give up..."</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
                                 </span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Auto_Fail</span></span><span> </span><span class="entity"><span>Too_Many_Subgoals</span></span><span class="main"><span>)</span></span><span>
                            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>

         </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prfs</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="entity"><span>funpow'</span></span><span> </span><span class="entity"><span>N</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ps</span></span><span class="main"><span>,</span></span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>tracing</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Sledgehammering on the "</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span>-</span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span>
                                             </span><span class="inner_quoted"><span>"th goal (total "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>Ns</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>")"</span></span><span class="main"><span>)</span></span><span>
                           </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prfx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>raw_sledgehammer</span></span><span> </span><span class="entity"><span>s</span></span><span>
                           </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p'</span></span><span class="main"><span>,</span></span><span class="entity"><span>s'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eval_prf_strs_stat</span></span><span> </span><span class="entity"><span>prfx</span></span><span> </span><span class="entity"><span>s</span></span><span>
                         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p'</span></span><span>::</span><span class="entity"><span>ps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
                     </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>prf0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>prf0</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>stat0</span></span><span class="main"><span>)</span></span><span>
    
         </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"("</span></span><span> </span><span>^</span><span> </span><span>String.concatWith</span><span> </span><span class="inner_quoted"><span>",\n"</span></span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="entity"><span>prfs</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>")"</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

     </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>local_defs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Help_Lemmas.local_defs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rep_tries</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Auto_Fail</span></span><span> </span><span class="entity"><span>Application_Fails</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rep_tries</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span>::</span><span class="entity"><span>L</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>Auto_Fail</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>rep_tries</span></span><span> </span><span class="entity"><span>L</span></span><span>
     </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rep_tries</span></span><span> </span><span class="main"><span>[</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>search_prf</span></span><span> </span><span class="inner_quoted"><span>"auto simp add: φ φsledgehammer_simps"</span></span><span>
                    </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>Auto_Fail</span></span><span> </span><span class="entity"><span>Too_Many_Subgoals</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                    </span><span class="entity"><span>search_prf</span></span><span> </span><span class="inner_quoted"><span>"(clarsimp simp add: φ φsledgehammer_simps)?, ((rule conjI)+)?"</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>local_defs</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Auto_Fail</span></span><span> </span><span class="entity"><span>Unknown</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span>tracing</span><span> </span><span class="inner_quoted"><span>"Unfolding local definitions..."</span></span><span> </span><span class="main"><span>;</span></span><span>
                         </span><span> </span><span class="entity"><span>search_prf</span></span><span> </span><span class="inner_quoted"><span>"auto simp add: φ φsledgehammer_simps local_defs"</span></span><span>
                          </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>Auto_Fail</span></span><span> </span><span class="entity"><span>Too_Many_Subgoals</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                          </span><span class="entity"><span>search_prf</span></span><span> </span><span class="inner_quoted"><span>"(clarsimp simp add: φ φsledgehammer_simps local_defs)?, ((rule conjI)+)?"</span></span><span>
                          </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>tracing</span><span> </span><span class="inner_quoted"><span>"Still fails... Try more aggresive tactics..."</span></span><span> </span><span class="main"><span>;</span></span><span>
                    </span><span> </span><span class="entity"><span>search_prf</span></span><span> </span><span class="inner_quoted"><span>"insert φ, auto simp add: φsledgehammer_simps"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>local_defs</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Auto_Fail</span></span><span> </span><span class="entity"><span>Unknown</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span>tracing</span><span> </span><span class="inner_quoted"><span>"Still fails... Unfolding local definitions with aggresive tactics..."</span></span><span> </span><span class="main"><span>;</span></span><span>
                         </span><span> </span><span class="entity"><span>search_prf</span></span><span> </span><span class="inner_quoted"><span>"insert φ, auto simp add: local_defs φsledgehammer_simps"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>]</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>eval_prf_str</span></span><span> </span><span>Time.zeroTime</span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>auto'</span></span><span> </span><span class="entity"><span>id</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>tracing</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"auto sledgehammer for "</span></span><span>^</span><span class="entity"><span>id</span></span><span class="main"><span>)</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sequent</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../Phi_Logic_Programming_Reasoner.Phi_Logic_Programming_Reasoner.html#Phi_Logic_Programming_Reasoner.Premise_I|fact"><span>Premise_I</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>sequent'</span></span><span> </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>sequent'</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>try_cached_proof</span></span><span> </span><span class="entity"><span>fallback</span></span><span> </span><span class="main"><span>=</span></span><span>
     </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Phi_Cache_DB.get_cached_proof</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>id</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>fallback</span></span><span> </span><span>true</span><span>
         </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>time</span></span><span class="main"><span>,</span></span><span class="entity"><span>prf</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Phi_Envir.freeze_dynamic_lemmas</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>eval_prf_str</span></span><span> </span><span class="main"><span>(</span></span><span>Time.scale</span><span> </span><span class="inner_numeral"><span>1.5</span></span><span> </span><span class="entity"><span>time</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>time_delt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span>
                  </span><span>|&gt;</span><span> </span><span>snd</span><span> </span><span>|&gt;</span><span> </span><span>snd</span><span>
                </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>Auto_Fail</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>fallback</span></span><span> </span><span>false</span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>find_proof</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
     </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Timeout.apply</span><span> </span><span class="main"><span>(</span></span><span>Time.fromSeconds</span><span> </span><span class="inner_numeral"><span>3</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Timing.timing</span><span> </span><span>Seq.pull</span><span class="main"><span>)</span></span><span>
                            </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Reasoners.auto_obligation_solver</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span>cpu</span><span class="main"><span>=</span></span><span class="entity"><span>time</span></span><span class="main"><span>,</span></span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sequent'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>time</span></span><span class="main"><span>,</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sequent'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>
           </span><span> </span><span>tracing</span><span> </span><span class="inner_quoted"><span>"Proof search by default tactic fails. Invoking sledgehammer..."</span></span><span class="main"><span>;</span></span><span>
           </span><span> </span><span class="entity"><span>sledgehammer</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Timeout.TIMEOUT</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>
       </span><span> </span><span>tracing</span><span> </span><span class="inner_quoted"><span>"Proof search by default tactic is time out. Invoking sledgehammer..."</span></span><span class="main"><span>;</span></span><span>
       </span><span> </span><span class="entity"><span>sledgehammer</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>)</span></span><span>

     </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>update_cache</span></span><span> </span><span class="entity"><span>hash</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prf'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sequent'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>
          </span><span> </span><span>tracing</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Find proof ("</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>id</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>", time: "</span></span><span> </span><span>^</span><span> </span><span>Value.print_time</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>prf'</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"): "</span></span><span> </span><span>^</span><span>
                      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>snd</span><span> </span><span class="entity"><span>prf'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_quoted"><span>"default automation"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_quoted"><span>"\n"</span></span><span> </span><span>^</span><span> </span><span>snd</span><span> </span><span class="entity"><span>prf'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>;</span></span><span>
          </span><span> </span><span class="entity"><span>update_hash_cache</span></span><span> </span><span class="entity"><span>hash</span></span><span> </span><span class="entity"><span>prf'</span></span><span class="main"><span>;</span></span><span>
          </span><span> </span><span class="entity"><span>Phi_Cache_DB.update_cached_proof</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>;</span></span><span>
          </span><span> </span><span class="entity"><span>sequent'</span></span><span class="main"><span>)</span></span><span>


    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>try_cached_proof</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>no_cache'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
         </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>hash</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Hasher.goal</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span>
         </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>no_cache</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf_result'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>access_hash_cache</span></span><span> </span><span class="entity"><span>hash</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Phi_Envir.freeze_dynamic_lemmas</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
                       </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eval_prf_str</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>folerant_time</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                           </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>Auto_Fail</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
                   </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>no_cache'</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
         </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prf_result</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>prf_result'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>ret</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ret</span></span><span>
                   </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>no_cache</span></span><span>
                              </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span>tracing</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Proof cache miss, "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>id</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span>warning</span><span> </span><span class="inner_quoted"><span>"The cached proof fails. Re-searching proofs..."</span></span><span class="main"><span>;</span></span><span>
                                   </span><span> </span><span class="entity"><span>Phi_Cache_DB.invalidate_proof_cache</span></span><span> </span><span class="main"><span>(</span></span><span>not</span><span> </span><span class="entity"><span>no_cache</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>id</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>;</span></span><span>
                             </span><span> </span><span class="entity"><span>find_proof</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>update_cache</span></span><span> </span><span class="entity"><span>hash</span></span><span> </span><span class="entity"><span>prf_result</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span> </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="comment1"><span>(*
if no_cache
          then (tracing ("Proof cache miss, " ^ id))
          else (warning "The cached proof fails. Re-searching proofs...";
                Phi_Cache_DB.invalidate_proof_cache (not no_cache) id thy) ;
          find_proof ())) *)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="comment1"><span>(* val proof = raw_sledgehammer stat *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>auto</span></span><span> </span><span class="entity"><span>id</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>wrapper</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>id</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>id'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>auto'</span></span><span> </span><span class="entity"><span>id'</span></span><span>
                    </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Phi_Reasoners.auto_obligation_solver1</span></span><span> </span><span>#&gt;</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>insert_tac</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>all_tac</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>insert_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>EVERY</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span>Thm.forall_intr_vars</span><span> </span><span class="entity"><span>r</span></span><span> </span><span>COMP_INCR</span><span> </span><span>revcut_rl</span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>facts</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Theory.setup</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Method.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="IDE_CP_Core.auto_sledgehammer|method"><span>auto_sledgehammer</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>Scan.lift</span><span> </span><span class="main"><span>(</span></span><span>Scan.succeed</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
  </span><span class="entity"><span>Method.CONTEXT_METHOD</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>uses</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt0</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Seq.make</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Config.put</span><span> </span><span class="entity"><span>assync_proof</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>ctxt0</span></span><span>
       </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>id</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Hasher.goal</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Reasoners.error_message</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
       </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sequent'</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Seq.pull</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Method.insert_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>uses</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ret</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ret</span></span><span>
                 </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Why the insert_tac can fail?"</span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>
         </span><span class="main"><span>(</span></span><span>Seq.Result</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>auto</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>id</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>Auto_Fail</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Seq.Error</span><span> </span><span class="entity"><span>err</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
         </span><span>Seq.empty</span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="inner_quoted"><span>"Apply sledgehammer transparently and record the outcome."</span></span><span>
</span><span class="main"><span>)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span></pre>
</body>

</html>