<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹library/system/obtain.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹library/system/obtain.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(* FILE: library/system/obtain.ML
   AUTHOR: Qiyuan Xu

   Existential elimination in the IDE-CP.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>NU_OBTAIN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> choose </span><span class="main"><span>:</span></span><span> </span><span>binding</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.state</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.state</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> auto_choose </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.state</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.state</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> enable_auto </span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span>Config.T</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>NuObtain</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>NU_OBTAIN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>eliminate_term</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Phi_Envir</span><span> </span><span>Phi_Syntax</span><span> </span><span>Phi_Help</span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.prop_of</span><span> </span><span class="entity"><span>thm</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Working_Mode.mode1</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>dest_Free</span><span> </span><span>o</span><span> </span><span>Thm.term_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>collect</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.fold_aterms</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>Free</span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>insert</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>I</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bads</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>collect</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="entity"><span>tm</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>#</span></span><span>introduce_existence_in_assembling</span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="entity"><span>bads</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>snd</span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>eliminate</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>thm''</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eliminate_term</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="entity"><span>thm''</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Object_Logic.is_judgment</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.concl_of</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
      </span><span>error</span><span> </span><span class="inner_quoted"><span>"Conclusion in obtained context must be object-logic judgment"</span></span><span>

   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>thm'</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.import</span><span> </span><span>true</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>thm</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Drule.strip_imp_prems</span><span> </span><span class="main"><span>(</span></span><span>Thm.cprop_of</span><span> </span><span class="entity"><span>thm'</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
   </span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Drule.implies_elim_list</span><span> </span><span class="entity"><span>thm'</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Thm.assume</span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>Drule.implies_intr_list</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Drule.norm_hhf_cterm</span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>Drule.forall_intr_list</span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span>
      </span><span>COMP</span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Drule.implies_intr_list</span><span> </span><span class="entity"><span>prems</span></span><span>
    </span><span>|&gt;</span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Variable.export</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>eliminate_nusys</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>eliminate</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>th</span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Exn.reraise</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>print</span></span><span class="antiquote"><span>}</span></span></span></span></span></span></span></span></span><span> </span><span class="entity"><span>e</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>obtain_export</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eliminate_nusys</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>,</span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>expand_exE</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.exE|fact"><span>exE</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span>
    </span><span>Tactic.rule_by_tactic</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>REPEAT</span><span> </span><span class="main"><span>(</span></span><span>Tactic.eresolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>exE</span></span><span class="main"><span>]</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>match_vars</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ret</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>rev</span><span> </span><span class="entity"><span>ret</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>match_vars</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ret</span></span><span> </span><span class="entity"><span>insts'</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span>::</span><span class="entity"><span>insts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>error</span><span> </span><span class="inner_quoted"><span>"unequalled length of instantiations and quantifiers"</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>match_vars</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ret</span></span><span> </span><span class="entity"><span>insts'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>quant</span></span><span>::</span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"quantifier "</span></span><span>^</span><span class="main"><span>(</span></span><span>Syntax.string_of_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>quant</span></span><span class="main"><span>)</span></span><span>^</span><span class="inner_quoted"><span>" is not been instantiated"</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>match_vars</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ret</span></span><span> </span><span class="entity"><span>insts'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>quant</span></span><span>::</span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>insts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>quant</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>match_vars</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span>::</span><span class="entity"><span>ret</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>insts'</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>insts</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>match_vars</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ret</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>insts'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>quant</span></span><span>::</span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>insts</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>trim_var_name</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isSuffix</span><span> </span><span class="inner_quoted"><span>"__"</span></span><span> </span><span class="entity"><span>name</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>String.substring</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span>String.size</span><span> </span><span class="entity"><span>name</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>2</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>name</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>trim_var</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>dest_Free</span><span> </span><span>#&gt;</span><span> </span><span>apfst</span><span> </span><span class="entity"><span>trim_var_name</span></span><span> </span><span>#&gt;</span><span> </span><span>Free</span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>choose</span></span><span> </span><span class="entity"><span>inst_names</span></span><span> </span><span class="entity"><span>stat</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Phi_Envir</span><span> </span><span>Phi_Help</span><span> </span><span>HOLogic</span><span> </span><span>Term</span><span> </span><span>Conv</span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>major</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Envir.the_state_sequent</span></span><span> </span><span class="entity"><span>stat</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Proof.context_of</span></span><span> </span><span class="entity"><span>stat</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>N</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>inst_names</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ExTyp_strip</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../../Calculus_of_Programming.html#Calculus_of_Programming.\&lt;phi&gt;ExTyp_strip|fact"><span>φExTyp_strip</span></a><span> </span><a class="entity_ref" href="../../../../../../Calculus_of_Programming.html#Calculus_of_Programming.\&lt;phi&gt;ExTyp_strip_imp|fact"><span>φExTyp_strip_imp</span></a><span class="antiquote"><span>}</span></span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>exBI_strip</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>all_conv</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>exBI_strip</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>rewrs_conv</span><span> </span><span class="entity"><span>ExTyp_strip</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>exBI_strip</span></span><span> </span><span class="entity"><span>N</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>rewrs_conv</span><span> </span><span class="entity"><span>ExTyp_strip</span></span><span>
                  </span><span>then_conv</span><span> </span><span>binder_conv</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>exBI_strip</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span>-</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>major</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fconv_rule</span><span> </span><span class="main"><span>(</span></span><span>arg_conv</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>exBI_strip</span></span><span> </span><span class="entity"><span>N</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>major</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span class="entity"><span>body</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.prop_of</span><span> </span><span class="entity"><span>major</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>dest_Trueprop</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>strip_binder_raw</span></span><span> </span><span class="inner_quoted"><span>"HOL.Ex"</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>var_tys</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>snd</span><span> </span><span class="entity"><span>vars</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inst_names</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>stat</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>Proof.map_context_result</span></span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.add_fixes</span><span>
            </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span class="entity"><span>nam</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nam</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span>NoSyn</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>var_tys</span></span><span>~~</span><span class="entity"><span>inst_names</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>stat</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>insts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inst_names</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>var_tys</span></span><span class="main"><span>)</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Proof.context_of</span></span><span> </span><span class="entity"><span>stat</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>meta'_term</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span>subst_bounds</span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="entity"><span>insts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                        </span><span>|&gt;</span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>meta'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.assume</span><span>  </span><span class="entity"><span>meta'_term</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>expand_exE</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>major</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cinsts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>insts</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
   </span><span> </span><span class="entity"><span>stat</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>Proof.map_context</span></span><span>
              </span><span class="main"><span>(</span></span><span>Assumption.add_assms</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>obtain_export</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="entity"><span>cinsts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>meta'_term</span></span><span class="main"><span>]</span></span><span> </span><span>#&gt;</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span>
         </span><span>|&gt;</span><span> </span><span class="entity"><span>Phi_Envir.set_state_sequent</span></span><span> </span><span class="entity"><span>meta'</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>enable_auto</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.setup_config_bool</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="IDE_CP_Core.\&lt;phi&gt;auto_\&lt;exists&gt;fix|attribute"><span>φauto_∃fix</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>auto_choose</span></span><span> </span><span class="entity"><span>stat</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Proof.context_of</span></span><span> </span><span class="entity"><span>stat</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sequent</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Envir.the_state_sequent</span></span><span> </span><span class="entity"><span>stat</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Working_Mode.mode1</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>var_names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>spec_of</span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.concl_of</span><span> </span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>Phi_Help.strip_binder_vars</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="../../../../../../Phi_BI.html#Phi_BI.ExSet|const"><span>ExSet</span></a><span class="antiquote"><span>}</span></span></span><span>
          </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Name.clean</span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>var_names'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>fold_map</span><span> </span><span>Name.variant</span><span> </span><span class="entity"><span>var_names</span></span><span> </span><span class="main"><span>(</span></span><span>Variable.names_of</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context_of</span></span><span> </span><span class="entity"><span>stat</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
</span><span class="comment1"><span>(* Binding.name o  *)</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>tracing</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Automatically fixing existential variable(s) ‹"</span></span><span>
             </span><span>^</span><span> </span><span>String.concatWith</span><span> </span><span class="inner_quoted"><span>", "</span></span><span> </span><span class="entity"><span>var_names'</span></span><span>
             </span><span>^</span><span> </span><span class="inner_quoted"><span>"›.\nYou may want to disable automatic behavior temporarily by '!!', \
               \or use '∃ &lt;names&gt;' to fix them by explicit names.\n\
               \If it bothers you, you may disable the feature permanently by setting \
               \φauto_∃fix to false, like ‹note [[φauto_∃fix = false]]›."</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
   </span><span> </span><span class="entity"><span>choose</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Binding.name</span><span> </span><span class="entity"><span>var_names'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>stat</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span></pre>
</body>

</html>