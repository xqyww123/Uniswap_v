<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹library/system/toplevel.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹library/system/toplevel.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(* FILE: library/system/toplevel.ML
   AUTHOR: Qiyuan Xu

   Definition of Isar commands for IDE-CP.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>PHI_TOPLEVEL</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>cond_kind</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Premise</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Assumption</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="main"><span>(</span></span><span>'a</span><span class="main"><span>,</span></span><span>'b</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>modifier</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Mod_by_Rule</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>'a</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Mod_by_Attr</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>'b</span><span>

  </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> Finishing_Modifier_Hooks </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>HOOKS</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> Finishing_Construction_Hooks </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>HOOKS</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> name_of_the_building_procedure </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>binding</span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> begin_proc_cmd </span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span class="comment1"><span>(*whether to define a new constant*)</span></span><span>
        </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Attrib.binding</span></span><span> </span><span class="comment1"><span>(*name*)</span></span><span>
        </span><span class="main"><span>-&gt;</span></span><span> </span><span>xstring</span><span> </span><span class="comment1"><span>(*input*)</span></span><span>
        </span><span class="main"><span>-&gt;</span></span><span> </span><span>xstring</span><span> </span><span class="comment1"><span>(*output*)</span></span><span>
        </span><span class="main"><span>-&gt;</span></span><span> </span><span>xstring</span><span> </span><span>option</span><span> </span><span class="comment1"><span>(*throws*)</span></span><span>
        </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>binding</span><span> * </span><span>string</span><span> </span><span>option</span><span> * </span><span>mixfix</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*for fixes*)</span></span><span>
        </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>xstring</span><span> * </span><span>Position.T</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*includes*)</span></span><span>
        </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Attrib.binding</span></span><span> * </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>string</span><span> </span><span>list</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*local definitions*)</span></span><span>
        </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cond_kind</span></span><span> * </span><span class="main"><span>(</span></span><span class="entity"><span>Attrib.binding</span></span><span> * </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>string</span><span> </span><span>list</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*preconditions*)</span></span><span>
        </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>option</span><span>
        </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>Facts.ref</span><span> * </span><span>Token.src</span><span> </span><span>list</span><span class="main"><span>,</span></span><span> </span><span>Token.src</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>modifier</span></span><span> </span><span>list</span><span>
        </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.state</span></span><span>

</span><span class="comment1"><span>(*
  val begin_rec_proc_cmd : bool (*whether to define a new constant*)
        -&gt; Attrib.binding
        -&gt; xstring (*input*)
        -&gt; xstring (*output*)
        -&gt; xstring option (*throws*)
        -&gt; ((binding * string option * mixfix) list * (*variants*)
            (binding * string option * mixfix) list   (*for fixes*))
        -&gt; (xstring * Position.T) list (*includes*)
        -&gt; (Attrib.binding * (string * string list)) list (*local definitions*)
        -&gt; (cond_kind * (Attrib.binding * (string * string list))) list (*preconditions*)
        -&gt; string option
        -&gt; bool -&gt; local_theory -&gt; Proof.state *)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> begin_block </span><span class="main"><span>:</span></span><span>   </span><span>binding</span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*fixed variables*)</span></span><span>
                    * </span><span class="main"><span>(</span></span><span class="entity"><span>Attrib.binding</span></span><span> * </span><span>term</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*bindings of conditions*)</span></span><span>
        </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.state</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.state</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> begin_block_cmd </span><span class="main"><span>:</span></span><span>   </span><span>binding</span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*fixed variables*)</span></span><span>
                        * </span><span class="main"><span>(</span></span><span class="entity"><span>Attrib.binding</span></span><span> * </span><span>string</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*bindings of conditions*)</span></span><span>
        </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.state</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.state</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> end_block_cmd </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.state</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.state</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> statement_clean_values </span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span>Config.T</span><span> </span><span class="comment1"><span>(*controls whether the statement command <span class="hidden">❙</span><b>;</b>
        cleans all values at its beginning.*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> statement_cmd </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.state</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.state</span></span><span class="main"><span>)</span></span><span> </span><span>parser</span><span>

  </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> Begining_of_Statement </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>HOOKS</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> End_of_Statement </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>HOOKS</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> prove_prem </span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.state</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> * </span><span class="entity"><span>Proof.state</span></span><span>
  </span><span class="comment1"><span>(*val export_LLVM : theory -&gt; theory *)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Phi_Toplevel</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>PHI_TOPLEVEL</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>


</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>v_proc_var</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"𝗉𝗋𝗈𝖼"</span></span><span class="main"><span>,</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span>


</span><span class="comment1"><span>(* Library *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>print_results</span></span><span> </span><span class="entity"><span>int</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Proof_Display.print_results</span></span><span> </span><span class="entity"><span>int</span></span><span> </span><span class="main"><span>(</span></span><span>Position.thread_data</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prep_decls</span></span><span> </span><span class="entity"><span>prep_var</span></span><span> </span><span class="entity"><span>raw_vars</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_map</span><span> </span><span class="entity"><span>prep_var</span></span><span> </span><span class="entity"><span>raw_vars</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>xs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt''</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Context_Position.set_visible</span><span> </span><span>false</span><span>
      </span><span>|&gt;</span><span> </span><span>Proof_Context.add_fixes</span><span> </span><span class="entity"><span>vars</span></span><span>
      </span><span>||&gt;</span><span> </span><span>Context_Position.restore_visible</span><span> </span><span class="entity"><span>ctxt'</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt''</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>cond_kind</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Premise</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Assumption</span></span><span>



</span><span class="comment1"><span>(** Programming Block **)</span></span><span>

</span><span class="comment1"><span>(* Begin Block *)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_backward_mode</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.assert_backward</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>;</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>ERROR</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>strip_fun_args</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>T'</span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>strip_fun_args</span></span><span> </span><span class="entity"><span>T'</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>strip_fun_args</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>strip_fun_ret</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>T'</span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>strip_fun_ret</span></span><span> </span><span class="entity"><span>T'</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>strip_fun_ret</span></span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>T'</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>collect_var_red</span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>L</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>collect_var_red</span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>L</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>collect_var_red</span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>L</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>collect_var_red</span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="main"><span>(</span></span><span>Bound</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>L</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>collect_var_red</span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>collect_var_red</span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="entity"><span>X</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>collect_var_red</span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>X</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>strip_comb</span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>args</span></span><span>
               </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Targs</span></span><span>  </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>strip_fun_args</span></span><span> </span><span class="entity"><span>T</span></span><span>
               </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Targs'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>Bound</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>t</span></span><span>::</span><span class="entity"><span>L</span></span><span class="main"><span>)</span></span><span>
                                              </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>List.take</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Targs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
               </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>strip_fun_ret</span></span><span> </span><span class="entity"><span>T</span></span><span>
                      </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>List.drop</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Targs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                      </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Targs'</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="entity"><span>T'</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>L</span></span><span>
            </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>arg</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>collect_var_red</span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="entity"><span>arg</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>H</span></span><span class="main"><span>,</span></span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>collect_var_red</span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="entity"><span>H</span></span><span>
                   </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>arg</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>collect_var_red</span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="entity"><span>arg</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>red_var</span></span><span> </span><span class="entity"><span>tys</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>red_var</span></span><span> </span><span class="entity"><span>tys</span></span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>red_var</span></span><span> </span><span class="entity"><span>tys</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>X</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
     </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>strip_comb</span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>H</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tys</span></span><span> </span><span class="entity"><span>N</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="entity"><span>T'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                            </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>Bound</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>red_var</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>H</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>red_var</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>H</span></span><span class="main"><span>,</span></span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>H</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>red_var</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>red_var</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>X</span></span><span>

</span><span class="comment1"><span>(* Because we fix universally quantified variables during opening a programming context,
   the quantified variables which are parameters of schematic variables are also fixed.
   (⋀x1 x2. P (?z x1 x2))  becomes   P (?z x1 x2)
   Since it is meaningless for a schematic variables to be parameterized by fixed variables,
   this ML function trims all such fixed variables parameterizing schematic variables.
   The above example will be trimmed to (P ?z). *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>reduce_var</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tys</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>collect_var_red</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>X</span></span><span>
     </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tys'</span></span><span class="main"><span>=</span></span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N'</span></span><span class="main"><span>,</span></span><span class="entity"><span>T'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>N</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="entity"><span>N'</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tys</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>tys'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>red_var</span></span><span> </span><span class="entity"><span>tys'</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>merge_premises_bindings</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>the_default</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.empty</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>R</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>merge_premises_bindings</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span>::</span><span class="entity"><span>R1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>B</span></span><span class="main"><span>,</span></span><span class="entity"><span>A2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>P2</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>R2</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>B</span></span><span class="main"><span>,</span></span><span class="entity"><span>A2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>P2</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>merge_premises_bindings</span></span><span> </span><span class="entity"><span>R1</span></span><span> </span><span class="entity"><span>R2</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>merge_premises_bindings</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>A1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>P1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>R1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>B</span></span><span class="main"><span>,</span></span><span class="entity"><span>A2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>P2</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>R2</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>B</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>A1</span></span><span>@</span><span class="entity"><span>A2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>P1</span></span><span>@</span><span class="entity"><span>P2</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>merge_premises_bindings</span></span><span> </span><span class="entity"><span>R1</span></span><span> </span><span class="entity"><span>R2</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>merge_premises_bindings</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span>::</span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>=</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Too much premises bindings given"</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gen_begin_block</span></span><span> </span><span class="entity"><span>prep_attr</span></span><span> </span><span class="entity"><span>prep_prop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>var_bindings</span></span><span class="main"><span>,</span></span><span class="entity"><span>prem_bindings0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>int</span></span><span> </span><span class="entity"><span>stat</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>is_top</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Envir.under_programming_environ</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context_of</span></span><span> </span><span class="entity"><span>stat</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                 </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>is_backward_mode</span></span><span> </span><span class="entity"><span>stat</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>normalize_tac</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>REPEAT_DETERM</span><span> </span><span class="main"><span>(</span></span><span>HEADGOAL</span><span> </span><span class="main"><span>(</span></span><span>Tactic.resolve_tac</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context_of</span></span><span> </span><span class="entity"><span>stat</span></span><span class="main"><span>)</span></span><span>
              </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../../Phi_Logic_Programming_Reasoner.Phi_Logic_Programming_Reasoner.html#Phi_Logic_Programming_Reasoner.Action_Tag_I|fact"><span>Action_Tag_I</span></a><span> </span><a class="entity_ref" href="../../../../../../IDE_CP_Core.html#IDE_CP_Core.Argument_I|fact"><span>Argument_I</span></a><span> </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.allI|fact"><span>allI</span></a><span> </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.impI|fact"><span>impI</span></a><span> </span><a class="entity_ref" href="../../../../../../IDE_CP_Core.html#IDE_CP_Core.Labelled_I|fact"><span>Labelled_I</span></a><span> </span><a class="entity_ref" href="../../../../../../IDE_CP_Core.html#IDE_CP_Core.Labelled_I&apos;|fact"><span>Labelled_I'</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="comment1"><span>(*TODO: retain the name of the quantified variables*)</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>stat</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_top</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>stat</span></span><span>
                </span><span>|&gt;</span><span> </span><span class="entity"><span>Proof.apply</span></span><span> </span><span class="main"><span>(</span></span><span>
                      </span><span class="entity"><span>Method.Basic</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Method.SIMPLE_METHOD</span></span><span> </span><span class="entity"><span>normalize_tac</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Position.no_range</span><span class="main"><span>)</span></span><span>
                </span><span>|&gt;</span><span> </span><span>Seq.the_result</span><span> </span><span class="inner_quoted"><span>"impossible"</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>stat</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sequent</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_top</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>#</span></span><span>goal</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.raw_goal</span></span><span> </span><span class="entity"><span>stat</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Phi_Envir.the_state_sequent</span></span><span> </span><span class="entity"><span>stat</span></span><span>
                  </span><span>|&gt;</span><span> </span><span>Tactic.rule_by_tactic</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context_of</span></span><span> </span><span class="entity"><span>stat</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>normalize_tac</span></span><span>

   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>stat</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Proof.map_context_result</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="entity"><span>Phi_Working_Mode.infer_working_mode_of_sequent</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span>
                </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>m</span></span><span class="main"><span>,</span></span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>stat</span></span><span>

   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>prem_bindings</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>stat</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Proof.map_context_result</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prem_bindings</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span class="entity"><span>attrs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pats</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Binding.name_of</span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"_"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Binding.empty</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                     </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prep_attr</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>attrs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                   </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prep_prop</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pats</span></span><span class="main"><span>)</span></span><span>
                </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prem_bindings0</span></span><span>
          </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pbs</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Named_Premises.remove_assm_bindings</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>sequent</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>merge_premises_bindings</span></span><span> </span><span class="entity"><span>pbs</span></span><span> </span><span class="entity"><span>prem_bindings</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sequent'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
          </span><span class="entity"><span>Named_Premises.remove_bindings</span></span><span> </span><span class="main"><span>(</span></span><span>map_filter</span><span>
               </span><span class="main"><span>(</span></span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span>Binding.name_of</span><span> </span><span>o</span><span> </span><span>fst</span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pbs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>stat</span></span><span>

   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>stat</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_top</span></span><span>
               </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>Proof.refine_primitive</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>stat</span></span><span>
               </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Phi_Envir.set_state_sequent</span></span><span> </span><span class="entity"><span>sequent</span></span><span> </span><span class="entity"><span>stat</span></span><span>

    </span><span class="comment1"><span>(*Assuming the proof state is in the normal hhf, or else the operation fails.*)</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vars0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>Phi_Help.strip_binder_raw</span></span><span> </span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><span>Pure.all</span><span class="antiquote"><span>}</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Help.leading_antecedent'</span></span><span> </span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vars1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>burrow_fst</span><span> </span><span class="main"><span>(</span></span><span>Name.variant_list</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vars0</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vb_N</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>var_bindings</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>var_names</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>stat</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>Proof.map_context_result</span></span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.add_fixes</span><span>
            </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span>NoSyn</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>List.take</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vars1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vb_N</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>var_bindings</span></span><span>
           </span><span>@</span><span> </span><span>map</span><span>  </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nam</span></span><span class="main"><span>,</span></span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="entity"><span>nam</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span>NoSyn</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>List.drop</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vars1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vb_N</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>stat</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>N</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>var_names</span></span><span> </span><span class="entity"><span>vars1</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>subst_bounds</span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>)</span></span><span>
            </span><span>|&gt;</span><span> </span><span class="entity"><span>reduce_var</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.strip_imp_prems</span><span> </span><span class="entity"><span>goal</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal'</span></span><span>  </span><span class="main"><span>=</span></span><span> </span><span>Logic.strip_imp_concl</span><span> </span><span class="entity"><span>goal</span></span><span>

   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>stat</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_top</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>Proof.enter_forward</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.assert_backward</span></span><span> </span><span class="entity"><span>stat</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>stat</span></span><span class="main"><span>)</span></span><span>
                  </span><span>|&gt;</span><span> </span><span class="entity"><span>Proof.begin_block</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>after_qed</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span class="entity"><span>th</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>stat0</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>stat</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Proof.end_block</span></span><span> </span><span class="entity"><span>stat0</span></span><span>
         </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt''</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Proof.context_of</span></span><span> </span><span class="entity"><span>stat</span></span><span>
         </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>th0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="comment1"><span>(* Drule.eta_contraction_rule *)</span></span><span> </span><span class="entity"><span>th</span></span><span>
         </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th1</span></span><span>::</span><span class="entity"><span>vars'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th0</span></span><span>::</span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Drule.mk_term</span><span> </span><span>o</span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span>
                                   </span><span>|&gt;</span><span> </span><span>Proof_Context.export</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>ctxt''</span></span><span>
         </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>th2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Drule.forall_intr_list</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Drule.dest_term</span><span> </span><span class="entity"><span>vars'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>th1</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gen_sequent</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="comment1"><span>(*val sequent = Phi_Help.beta_eta_contract_leading_antecedent sequent0*)</span></span><span>
               </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>insts</span></span><span> </span><span class="main"><span>=</span></span><span>
                      </span><span class="entity"><span>PLPR_Pattern.match</span></span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt''</span></span><span class="main"><span>)</span></span><span>
                                    </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Help.leading_antecedent'</span></span><span> </span><span class="entity"><span>sequent</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.prop_of</span><span> </span><span class="entity"><span>th2</span></span><span class="main"><span>)</span></span><span>
                                    </span><span class="main"><span>(</span></span><span>Vartab.empty</span><span class="main"><span>,</span></span><span> </span><span>Vartab.empty</span><span class="main"><span>)</span></span><span>
                      </span><span>|&gt;</span><span> </span><span class="entity"><span>Phi_Help.env_to_table</span></span><span> </span><span class="entity"><span>ctxt''</span></span><span>
                </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Pattern.MATCH</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span>Pretty.string_of</span><span> </span><span class="main"><span>(</span></span><span>Pretty.chunks</span><span> </span><span class="main"><span>[</span></span><span>
                      </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"The higher-order pattern match fails"</span></span><span class="main"><span>,</span></span><span>
                      </span><span>Pretty.block</span><span> </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"from "</span></span><span class="main"><span>,</span></span><span>
                                    </span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt''</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Help.leading_antecedent'</span></span><span> </span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
                      </span><span>Pretty.block</span><span> </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"to "</span></span><span class="main"><span>,</span></span><span>
                                    </span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt''</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>th2</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
                      </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"which usually means some schematic variable is instantiated to\
                        \ some universally quantified variables that it has no access."</span></span><span>
                    </span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
               </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sequent'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.instantiate</span><span> </span><span class="entity"><span>insts</span></span><span> </span><span class="entity"><span>sequent</span></span><span> </span><span class="comment1"><span>(*index is considered*)</span></span><span>
               </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sequent''</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.implies_elim</span><span>
                                      </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Help.beta_eta_contract_leading_antecedent</span></span><span> </span><span class="entity"><span>sequent'</span></span><span class="main"><span>)</span></span><span>
                                      </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Help.beta_eta_contract</span></span><span> </span><span class="entity"><span>th2</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="comment1"><span>(*This beta eta contraction may be not good, cuz it may remove names of quantified
                      variables but I cannot find a better and simpler way to do this implication
                      elimination.*)</span></span><span>
               </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt'3</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sequent'3</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Reasoner.reason</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sequent''</span></span><span class="main"><span>)</span></span><span>
                       </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>X</span></span><span>
                            </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Phi_Reasoner.error</span></span><span> </span><span class="main"><span>(</span></span><span>Pretty.string_of</span><span> </span><span class="main"><span>(</span></span><span>Pretty.chunks</span><span> </span><span class="main"><span>[</span></span><span>
                                  </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"Fail to reason the finalization reasoning tasks:"</span></span><span class="main"><span>,</span></span><span>
                                  </span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.major_prem_of</span><span> </span><span class="entity"><span>sequent''</span></span><span class="main"><span>)</span></span><span>
                                </span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
               </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sequent'4</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.major_prem_of</span><span> </span><span class="entity"><span>sequent'3</span></span><span>
                                  </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>
                                      </span><span class="main"><span>=&gt;</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.TrueI|fact"><span>TrueI</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>sequent'3</span></span><span>
                                   </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>sequent'3</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt'3</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sequent'4</span></span><span class="main"><span>)</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_top</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>stat</span></span><span>
                </span><span>|&gt;</span><span> </span><span class="entity"><span>Proof.enter_backward</span></span><span>
                </span><span>|&gt;</span><span> </span><span class="entity"><span>Proof.apply</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Method.Basic</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                        </span><span class="entity"><span>Method.CONTEXT_METHOD</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>Seq.single</span><span> </span><span>o</span><span> </span><span>Seq.Result</span><span> </span><span>o</span><span> </span><span class="entity"><span>gen_sequent</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Position.no_range</span><span class="main"><span>)</span></span><span>
                </span><span>|&gt;</span><span> </span><span>Seq.the_result</span><span> </span><span class="inner_quoted"><span>"never fail"</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Phi_Envir.map_state_sequent</span></span><span> </span><span class="entity"><span>gen_sequent</span></span><span> </span><span class="entity"><span>stat</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bindings</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prem_bindings</span></span><span>
          </span><span>|&gt;</span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>P</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span class="entity"><span>attrs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>pats</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>attrs'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Premises_Attribute.attribute_of</span></span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span class="entity"><span>attrs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>P</span></span><span>
                                                        </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context_of</span></span><span> </span><span class="entity"><span>stat</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>attrs'</span></span><span> </span><span>@</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Attrib.attribute</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context_of</span></span><span> </span><span class="entity"><span>stat</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>attrs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pats</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prems</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
   </span><span> </span><span class="entity"><span>stat</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>Proof.internal_goal</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>print_results</span></span><span> </span><span class="entity"><span>int</span></span><span class="main"><span>)</span></span><span> </span><span>Proof_Context.mode_schematic</span><span> </span><span>true</span><span>
          </span><span class="inner_quoted"><span>""</span></span><span> </span><span>NONE</span><span> </span><span class="entity"><span>after_qed</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
          </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span class="entity"><span>pats</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>prop</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>prop</span></span><span class="main"><span>,</span></span><span class="entity"><span>pats</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bindings</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span>Binding.empty_atts</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>goal'</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span>|&gt;</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>Proof.map_context</span></span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.set_mode</span><span> </span><span>Proof_Context.mode_default</span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>Proof.proof</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Method.Basic</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="entity"><span>Context_Tactic.CONTEXT_TACTIC</span></span><span> </span><span>all_tac</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Position.no_range</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Seq.the_result</span><span> </span><span class="inner_quoted"><span>"never fail"</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>Proof.using_facts</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>Proof.enter_forward</span></span><span> </span><span class="comment1"><span>(*|&gt; Proof.begin_block*)</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>stat</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>stat</span></span><span>
              </span><span>|&gt;</span><span> </span><span class="entity"><span>Proof.map_context</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
                  </span><span>|&gt;</span><span> </span><span class="entity"><span>Phi_Working_Mode.set</span></span><span> </span><span class="entity"><span>mode</span></span><span>
                  </span><span>|&gt;</span><span> </span><span class="entity"><span>Phi_Envir.put_thesis</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.cprem_of</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>goal</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.goal</span></span><span> </span><span class="entity"><span>stat</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
                                              </span><span>|&gt;</span><span> </span><span>Drule.strip_imp_concl</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>Proof.begin_block</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="main"><span>#</span></span><span>initialize_sequent</span><span> </span><span class="entity"><span>mode</span></span><span>
      </span><span>|-&gt;</span><span> </span><span class="entity"><span>Phi_Envir.enter_programming_environ</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>Proof.map_context</span></span><span> </span><span class="entity"><span>Phi_Envir.freeze_dynamic_lemmas</span></span><span>
</span><span class="comment1"><span>(*      |&gt; Generic_Variable_Access.open_value_context' Position.none *)</span></span><span>
      </span><span class="comment1"><span>(* |&gt; NuObtain.obtain_quick_pairs_perhaps_try *)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>begin_block_cmd</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>gen_begin_block</span></span><span> </span><span class="entity"><span>Attrib.check_src</span></span><span>
                      </span><span class="main"><span>(</span></span><span>Syntax.parse_prop</span><span> </span><span>o</span><span> </span><span>Proof_Context.set_mode</span><span> </span><span>Proof_Context.mode_pattern</span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>begin_block</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>gen_begin_block</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>I</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>I</span><span class="main"><span>)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(* End Block *)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>basic_method</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Method.Basic</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>CONTEXT_TACTIC</span></span><span> </span><span class="main"><span>(</span></span><span>PRIMITIVE</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gen_finish_proc</span></span><span> </span><span class="entity"><span>prep_term</span></span><span> </span><span class="entity"><span>qed</span></span><span> </span><span class="entity"><span>spec</span></span><span> </span><span class="entity"><span>int</span></span><span> </span><span class="entity"><span>stat</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Proof.context_of</span></span><span> </span><span class="entity"><span>stat</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Envir.get_thesis</span></span><span> </span><span class="entity"><span>ctxt_</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Working_Mode.mode1</span></span><span> </span><span class="entity"><span>ctxt_</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>stat</span></span><span>
  </span><span>|&gt;</span><span> </span><span class="entity"><span>Proof.map_context_result</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt_pre1</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
       </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sequent_pre1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Envir.the_programming_sequent'</span></span><span> </span><span class="entity"><span>ctxt_pre1</span></span><span>
       </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Thm.no_prems</span><span> </span><span class="entity"><span>sequent_pre1</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt_pre1</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent_pre1</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
           </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Reasoner.info_print</span></span><span> </span><span class="entity"><span>ctxt_pre1</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                      </span><span class="inner_quoted"><span>"solving pending antecedents before closing the programming block..."</span></span><span>
                      </span><span>^</span><span> </span><span>Position.here</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>attack_obligations</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span>Thm.major_prem_of</span><span> </span><span class="entity"><span>sequent</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../Phi_Logic_Programming_Reasoner.Phi_Logic_Programming_Reasoner.html#Phi_Logic_Programming_Reasoner.Premise|const"><span>Premise</span></a><span>›</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                    </span><span class="entity"><span>attack_obligations</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Reasoners.auto_obligation_solver1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                 </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span>
           </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt_pre2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sequent_pre2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>attack_obligations</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt_pre1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sequent_pre1</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>Phi_Reasoner.reason1</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Pretty.string_of</span><span> </span><span class="main"><span>(</span></span><span>Pretty.chunks</span><span> </span><span class="main"><span>[</span></span><span>
                    </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"Fail to solve pending antecedents:"</span></span><span class="main"><span>,</span></span><span>
                    </span><span>Thm.pretty_thm</span><span> </span><span class="entity"><span>ctxt_pre2</span></span><span> </span><span class="entity"><span>sequent_pre2</span></span><span>
               </span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt_pre2</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent_pre2</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
       </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Sys.move_lemmata</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span>
       </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt''</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent''</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent'</span></span><span class="main"><span>)</span></span><span>
              </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>spec</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span>
                     </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt''</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.set_mode</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.mode_pattern</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span>
                           </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>aim</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt''</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prep_term</span></span><span> </span><span class="entity"><span>ctxt''</span></span><span> </span><span class="entity"><span>term</span></span><span class="main"><span>)</span></span><span>
                           </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Reasoner.info_pretty</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Pretty.block</span><span> </span><span class="main"><span>[</span></span><span>
                               </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"transforming to the given specification "</span></span><span class="main"><span>,</span></span><span>
                               </span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt''</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="entity"><span>aim</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                               </span><span>Pretty.block</span><span> </span><span class="main"><span>(</span></span><span>Pretty.here</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span class="main"><span>)</span></span><span>
                            </span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>Phi_Sys.cast</span></span><span> </span><span class="entity"><span>aim</span></span><span>
                        </span><span>#&gt;</span><span> </span><span class="entity"><span>Phi_Reasoners.auto_obligation_solver'</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                             </span><span>error</span><span> </span><span class="main"><span>(</span></span><span>Pretty.string_of</span><span> </span><span class="main"><span>(</span></span><span>Pretty.chunks</span><span> </span><span class="main"><span>[</span></span><span>
                               </span><span>Pretty.str</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Fail to solve the proof obligation generated during "</span></span><span>^</span><span>
                                           </span><span class="inner_quoted"><span>"the cast towards the given specification:"</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                               </span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt''</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Help.leading_antecedent'</span></span><span> </span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                               </span><span>Pretty.block</span><span> </span><span class="main"><span>[</span></span><span>
                                 </span><span>Pretty.str</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Tailing specification of a programming block is "</span></span><span>^</span><span>
                                 </span><span class="inner_quoted"><span>"only sufficient for simple transformations having simple "</span></span><span>^</span><span>
                                 </span><span class="inner_quoted"><span>"proof obligations. More complicated transformation should use "</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                                 </span><span>Pretty.keyword2</span><span> </span><span class="inner_quoted"><span>"assert"</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"command instead."</span></span><span>
                               </span><span class="main"><span>]</span></span><span>
                           </span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
              </span><span>|&gt;</span><span> </span><span class="main"><span>#</span></span><span>vcg_before_assembling</span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="entity"><span>goal</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sequent''</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt''</span></span><span class="main"><span>)</span></span><span>
        </span><span class="comment1"><span>(*The transformation shall generate a poof obligation*)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="main"><span>)</span></span><span>
        </span><span class="comment1"><span>(*and the proof obligation is presented to users here.*)</span></span><span>
    </span><span>|-&gt;</span><span> </span><span class="entity"><span>Phi_Sys.obligation_proof</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>print_results</span></span><span> </span><span class="entity"><span>int</span></span><span class="main"><span>)</span></span><span> </span><span>Proof_Context.mode_schematic</span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span>NONE</span><span>
          </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>sequent</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>stat</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
       </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Proof.context_of</span></span><span> </span><span class="entity"><span>stat</span></span><span>
       </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>stat'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>stat</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>Proof.set_facts</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>Proof.map_context</span></span><span> </span><span class="entity"><span>Phi_Envir.exit_programming_environ</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>Proof.end_block</span></span><span>
       </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt'1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Proof.context_of</span></span><span> </span><span class="entity"><span>stat'</span></span><span>
       </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sequent'1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.export</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ctxt'1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sequent</span></span><span>
       </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>end_tac</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>basic_method</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>goal'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
             </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sequent'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.export</span><span> </span><span class="entity"><span>ctxt'1</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sequent'1</span></span><span>
             </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Reasoner.info_print</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span>Pretty.string_of</span><span> </span><span class="main"><span>(</span></span><span>Pretty.chunks</span><span> </span><span class="main"><span>[</span></span><span>
                    </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"Solving the goal by the resulted sequent from the programming."</span></span><span class="main"><span>,</span></span><span>
                    </span><span>Pretty.item</span><span> </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"goal:"</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
                    </span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="main"><span>(</span></span><span>Logic.dest_implies</span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>goal'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                    </span><span>Pretty.item</span><span> </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"resulted sequent:"</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
                    </span><span>Thm.pretty_thm</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>sequent'</span></span><span class="main"><span>,</span></span><span>
                    </span><span>Pretty.block</span><span> </span><span class="main"><span>(</span></span><span>Pretty.here</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span class="main"><span>)</span></span><span>
                  </span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
               </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>result</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>NuApply.apply</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>sequent'</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span class="entity"><span>goal'</span></span><span class="main"><span>)</span></span><span>
                              </span><span>|&gt;</span><span> </span><span class="entity"><span>Phi_Reasoners.safer_obligation_solver1</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>result</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
              </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>E</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>print</span></span><span class="antiquote"><span>}</span></span></span></span></span></span></span></span></span><span> </span><span class="entity"><span>E</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
       </span><span> </span><span class="entity"><span>stat'</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>qed</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>end_tac</span></span><span class="main"><span>,</span></span><span> </span><span>Position.no_range</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
     </span><span>|&gt;</span><span> </span><span>snd</span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>end_block_cmd</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>gen_finish_proc</span></span><span> </span><span>Syntax.read_term</span><span> </span><span class="entity"><span>Proof.local_qed</span></span><span>

</span><span class="comment1"><span>(* fun gen_finish_proc' prep_specthm qed int stat =
  let val sequent = Proof.the_fact stat
  in if current_block_depth sequent &gt; 1 then
      gen_finish_proc' prep_specthm qed int (end_block_cmd false stat)
    else gen_finish_proc prep_specthm qed int stat end *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>finish_proc_cmd</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>gen_finish_proc</span></span><span> </span><span>Syntax.read_term</span><span> </span><span class="entity"><span>Proof.local_qed</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>



</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prove_prem</span></span><span> </span><span class="entity"><span>int</span></span><span> </span><span class="entity"><span>stat</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sequent</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Envir.the_state_sequent</span></span><span> </span><span class="entity"><span>stat</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>after_qed</span></span><span> </span><span class="entity"><span>sequent</span></span><span> </span><span class="entity"><span>stat</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
       </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>original_auto_level</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Config.get</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context_of</span></span><span> </span><span class="entity"><span>stat</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Phi_Reasoner.auto_level</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
       </span><span> </span><span class="entity"><span>stat</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>Proof.map_context</span></span><span>
                  </span><span class="main"><span>(</span></span><span>Config.put</span><span> </span><span class="entity"><span>Phi_Reasoner.auto_level</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>
                </span><span>#&gt;</span><span> </span><span>Config.put</span><span> </span><span class="entity"><span>Phi_Reasoner.auto_level</span></span><span> </span><span class="entity"><span>original_auto_level</span></span><span class="main"><span>)</span></span><span>
             </span><span>|&gt;</span><span> </span><span class="entity"><span>Phi_Envir.set_state_sequent</span></span><span> </span><span class="entity"><span>sequent</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>Phi_Sys.obligation_proof</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>print_results</span></span><span> </span><span class="entity"><span>int</span></span><span class="main"><span>)</span></span><span> </span><span>Proof_Context.mode_schematic</span><span> </span><span class="inner_quoted"><span>""</span></span><span>
        </span><span>NONE</span><span> </span><span class="entity"><span>after_qed</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>sequent</span></span><span> </span><span class="entity"><span>stat</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
 </span><span class="comment1"><span>(*let open Proof
    val sequent = Phi_Envir.the_state_sequent stat
    val goal = Thm.prop_of sequent
                |&gt; Logic.dest_implies |&gt; #1 (* |&gt; dest_premise_tag |&gt; mk_Trueprop *)
    fun after_qed (ctxt',[[th]]) stat =
      let
        val [th] = Proof_Context.export ctxt' (context_of stat) [th]
        val original_auto_level = Config.get (Proof.context_of stat) Phi_Reasoner.auto_level
      in
        stat |&gt; Proof.map_context_result
                  (Config.put Phi_Reasoner.auto_level 0
                    #&gt; (fn ctxt =&gt; Phi_Processor.process_no_input (ctxt, th RS specthm))
                    #&gt; apfst (Config.put Phi_Reasoner.auto_level original_auto_level)
                    #&gt; swap)
             |-&gt; Phi_Envir.set_state_sequent
      end
  in
    stat |&gt; Phi_Sys.setup_proof (print_results int) Proof_Context.mode_schematic ""
              NONE after_qed [] [] [[(goal,[])]]
         |&gt; apsnd (
              Proof.map_context (Proof_Context.set_mode Proof_Context.mode_default)
           #&gt; Proof.refine (Method.Basic (fn ctxt =&gt; Method.SIMPLE_METHOD (
                HEADGOAL (resolve_tac ctxt @{thms Premise_I})
              ))) #&gt; Seq.the_result "should never fail"
            )
  end*)</span></span><span>


</span><span class="comment1"><span>(** Header of Procedure **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="main"><span>(</span></span><span>'a</span><span class="main"><span>,</span></span><span>'b</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>modifier</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Mod_by_Rule</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>'a</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Mod_by_Attr</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>'b</span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Finishing_Modifier_Hooks</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Hooks</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>arg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>unit</span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Finishing_Construction_Hooks</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Hooks</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>arg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>unit</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Procedure_Building_Envir</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Data</span><span> </span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>binding</span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>init</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name_of_the_building_procedure</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Procedure_Building_Envir.get</span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gen_begin_proc</span></span><span> </span><span class="entity"><span>prep_term</span></span><span> </span><span class="entity"><span>prep_prop</span></span><span> </span><span class="entity"><span>prep_var</span></span><span> </span><span class="entity"><span>prep_attr</span></span><span> </span><span class="entity"><span>post_process</span></span><span> </span><span class="entity"><span>def_const</span></span><span>
      </span><span class="entity"><span>binding</span></span><span> </span><span class="entity"><span>arg</span></span><span> </span><span class="entity"><span>ret</span></span><span> </span><span class="entity"><span>throws</span></span><span> </span><span class="entity"><span>rawfixes</span></span><span> </span><span class="entity"><span>includes</span></span><span> </span><span class="entity"><span>raw_defines</span></span><span> </span><span class="entity"><span>raw_preconds</span></span><span> </span><span class="entity"><span>action</span></span><span> </span><span class="entity"><span>raw_modifiers</span></span><span>
      </span><span class="entity"><span>int</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>includes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>includes</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Bundle.check</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>fixes</span></span><span class="main"><span>,</span></span><span class="entity"><span>var_names</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt_parse</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
                                       </span><span>|&gt;</span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span class="entity"><span>includes</span></span><span class="main"><span>)</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>Bundle.includes</span></span><span> </span><span class="entity"><span>includes</span></span><span>
                                       </span><span>|&gt;</span><span> </span><span class="entity"><span>prep_decls</span></span><span> </span><span class="entity"><span>prep_var</span></span><span> </span><span class="entity"><span>rawfixes</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>binding</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>binding</span></span><span> </span><span>|&gt;</span><span> </span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Attrib.check_src</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_term</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prep_term</span></span><span> </span><span class="entity"><span>ctxt_parse</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_prop</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prep_prop</span></span><span> </span><span class="entity"><span>ctxt_parse</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>apply_modifier</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span>
         </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>Mod_by_Rule</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                          </span><span class="entity"><span>Phi_Modifier.by_rule</span></span><span> </span><span class="main"><span>(</span></span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Attrib.eval_thms</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span>
                 </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Mod_by_Attr</span></span><span> </span><span class="entity"><span>attr</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                          </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Modifier.apply_wrapped_attribute</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>prep_attr</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>attr</span></span><span>
               </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_modifiers</span></span><span>
         </span><span>|&gt;</span><span> </span><span class="entity"><span>Finishing_Modifier_Hooks.invoke</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prep_attrterm</span></span><span> </span><span class="entity"><span>prep</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span class="entity"><span>attrs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>prop</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pats</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Attrib.check_src</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>attrs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prep</span></span><span> </span><span class="entity"><span>prop</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>parse_term</span></span><span> </span><span class="entity"><span>pats</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prep_precond</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Premise</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>prep_attrterm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>parse_prop</span></span><span> </span><span>#&gt;</span><span>
                  </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span>
                        </span><span class="main"><span>=&gt;</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>term</span></span><span> </span><span class="quoted"><a class="entity_ref" href="../../../../../../Phi_Logic_Programming_Reasoner.Phi_Logic_Programming_Reasoner.html#Phi_Logic_Programming_Reasoner.Normal_Premise|const"><span>Normal_Premise</span></a></span><span class="antiquote"><span>}</span></span></span><span> </span><span>$</span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Premise must be atomic HOL assertion (meaning you cannot use \
                                 \meta connectivities like ‹⟹› or ‹⋀›). You may want to \
                                 \use keyword ‹assume› for introducing advanced arbitrary \
                                 \antecedents."</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>c</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>prep_precond</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Assumption</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prep_attrterm</span></span><span> </span><span class="entity"><span>parse_prop</span></span><span> </span><span class="entity"><span>c</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>preconds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>prep_precond</span></span><span> </span><span class="entity"><span>raw_preconds</span></span><span>

   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>arg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Procedure_Syntax.translate_arg</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>parse_term</span></span><span> </span><span class="entity"><span>arg</span></span><span class="main"><span>)</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ret</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Procedure_Syntax.translate_ret</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>parse_term</span></span><span> </span><span class="entity"><span>ret</span></span><span class="main"><span>)</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>v_proc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v_proc_var</span></span><span class="main"><span>,</span></span><span> </span><span>dummyT</span><span class="main"><span>)</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>throws</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>throws</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>thr</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>parse_term</span></span><span> </span><span class="entity"><span>thr</span></span><span>
                     </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/Groups.html#Groups.zero_class.zero|const"><span>Groups.zero_class.zero</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span>dummyT</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span><span> </span><span>$</span><span>
                  </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="../../../../../../Spec_Framework.html#Spec_Framework.\&lt;phi&gt;Procedure|const"><span>φProcedure</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span>dummyT</span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>v_proc</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>arg</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>ret</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>throws</span></span><span class="main"><span>)</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>action</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>goal0</span></span><span>
                   </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../Phi_Logic_Programming_Reasoner.Phi_Logic_Programming_Reasoner.html#Phi_Logic_Programming_Reasoner.Action_Tag|const"><span>Action_Tag</span></a><span>›</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>goal0</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>parse_term</span></span><span> </span><span class="entity"><span>A</span></span><span class="main"><span>)</span></span><span>
            </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>P</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.imp</span><span>›</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>P</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>preconds</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>post_process'</span></span><span> </span><span class="entity"><span>binding</span></span><span> </span><span class="entity"><span>int</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>,</span></span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="entity"><span>Finishing_Construction_Hooks.invoke</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>swap</span><span>
        </span><span>|-&gt;</span><span> </span><span class="entity"><span>Phi_Procedure.define</span></span><span> </span><span class="entity"><span>def_const</span></span><span> </span><span class="entity"><span>binding</span></span><span>
        </span><span>|-&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>Proof_Display.print_results</span></span><span> </span><span class="entity"><span>int</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.pos_of</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>binding</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
                </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"φprocedure"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>th</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>defines</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prep_attrterm</span></span><span> </span><span class="entity"><span>parse_prop</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_defines</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>elems</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Element.Fixes</span></span><span> </span><span class="entity"><span>fixes</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Element.Defines</span></span><span> </span><span class="entity"><span>defines</span></span><span class="main"><span>]</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>concls</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Element.Shows</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span>Binding.empty_atts</span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>goal</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>after_qed</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span class="entity"><span>th</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>post_process'</span></span><span> </span><span class="entity"><span>binding</span></span><span> </span><span class="entity"><span>int</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>th</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
   </span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>Specification.schematic_theorem</span></span><span> </span><span>false</span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span>NONE</span><span> </span><span class="entity"><span>after_qed</span></span><span> </span><span>Binding.empty_atts</span><span>
              </span><span class="entity"><span>includes</span></span><span> </span><span class="entity"><span>elems</span></span><span> </span><span class="entity"><span>concls</span></span><span> </span><span class="entity"><span>int</span></span><span>
         </span><span>|&gt;</span><span> </span><span class="entity"><span>Proof.map_context</span></span><span> </span><span class="main"><span>(</span></span><span>
              </span><span>Context.proof_map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Named_Theorems.clear</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">named_theorems</span><span class="hidden">&gt;</span></span></span><span>‹φlemmata›</span></span><span class="main"><span>)</span></span><span>
            </span><span>#&gt;</span><span>Procedure_Building_Envir.put</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>binding</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>)</span></span><span>
         </span><span>|&gt;</span><span> </span><span class="entity"><span>Proof.refine</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Method.Basic</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>s</span></span><span>
              </span><span>|&gt;</span><span> </span><span class="entity"><span>Named_Premises.bind_sequent_assms</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>preconds</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
              </span><span>|&gt;</span><span> </span><span class="entity"><span>apply_modifier</span></span><span>
              </span><span>|&gt;</span><span> </span><span>Seq.single</span><span> </span><span>o</span><span> </span><span>Seq.Result</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
         </span><span>|&gt;</span><span> </span><span>Seq.the_result</span><span> </span><span class="inner_quoted"><span>"should never fail #gn9[q3"</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>begin_proc</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>gen_begin_proc</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>I</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>I</span><span class="main"><span>)</span></span><span> </span><span>Proof_Context.cert_var</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>I</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>I</span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>begin_proc_cmd</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>gen_begin_proc</span></span><span> </span><span>Syntax.parse_term</span><span> </span><span>Syntax.parse_prop</span><span> </span><span>Proof_Context.read_var</span><span>
                     </span><span class="entity"><span>Attrib.attribute_cmd</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>I</span><span class="main"><span>)</span></span><span>



</span><span class="comment1"><span>(** Statement **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Begining_of_Statement</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Hooks</span></span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>arg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>unit</span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>End_of_Statement</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Hooks</span></span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>arg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>unit</span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(*Whether to remove all values at the beginning of the command <span class="hidden">❙</span><b>;</b>*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>statement_clean_values</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.setup_config_bool</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="IDE_CP_Core.\&lt;phi&gt;statement_clean_values|attribute"><span>φstatement_clean_values</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>clean_values</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>can</span><span> </span><span class="entity"><span>Phi_Syntax.dest_CurrentConstruction</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span>
         </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>statement_clean_values</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Generic_Variable_Access.collect_and_clean_value</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>sequent</span></span><span> </span><span>|&gt;</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>statement_cmd</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Phi_Processor.powerful_process_p</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>stat</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="entity"><span>stat</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>Phi_Envir.map_state_sequent</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Begining_of_Statement.invoke</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
         </span><span>|&gt;</span><span> </span><span class="entity"><span>f</span></span><span>
         </span><span>|&gt;</span><span> </span><span class="entity"><span>Phi_Envir.map_state_sequent</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>End_of_Statement.invoke</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Theory.setup</span><span> </span><span class="main"><span>(</span></span><span>Context.theory_map</span><span> </span><span class="main"><span>(</span></span><span>
   </span><span class="entity"><span>Begining_of_Statement.add</span></span><span> </span><span class="inner_numeral"><span>50</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="entity"><span>clean_values</span></span><span class="main"><span>)</span></span><span>
</span><span>#&gt;</span><span> </span><span class="entity"><span>End_of_Statement.add</span></span><span> </span><span class="inner_numeral"><span>100</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span class="entity"><span>Phi_Envir.freeze_dynamic_lemmas</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>




</span><span class="comment1"><span>(* fun export_LLVM thy =
  let
    fun eval code = ML_Context.exec (fn () =&gt;
                      ML_Context.eval_source ML_Compiler.flags (Input.string code))

    val base = Path.expand (Resources.master_directory thy)
    val path = File.full_path base (Path.basic (Context.theory_name thy ^ ".ll"))

    val codegen = eval ("NuCG.codegen NuCG_" ^ Context.theory_name thy ^ ".gen"
                    ^ "(" ^ ML_Syntax.print_path path ^ ")" )
    val _ = tracing("generating LLVM IR: " ^ Path.print path)
  in
    thy |&gt; Context.theory_map (eval (NuCompilation.compile thy(* |&gt; (fn s =&gt; (tracing s; s))*)))
        |&gt; Context.theory_map codegen
  end *)</span></span><span>



</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Scan</span><span> </span><span>Phi_Sys</span><span> </span><span>Parse</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>is_props</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.repeat1</span><span> </span><span class="main"><span>(</span></span><span>$$$</span><span> </span><span class="inner_quoted"><span>"is"</span></span><span> </span><span>|--</span><span> </span><span>prop</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ppats</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span>$$$</span><span> </span><span class="inner_quoted"><span>"("</span></span><span> </span><span>|--</span><span> </span><span>!!!</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_props</span></span><span> </span><span>--|</span><span> </span><span>$$$</span><span> </span><span class="inner_quoted"><span>")"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>attrib</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>token</span><span> </span><span>liberal_name</span><span> </span><span>:::</span><span> </span><span>!!!</span><span> </span><span>args</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>attribs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>[</span></span><span>›</span></span></span><span> </span><span>--</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>]</span></span><span>›</span></span></span><span class="main"><span>)</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Attrib.internal</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
           </span><span>||</span><span> </span><span class="main"><span>(</span></span><span>$$$</span><span> </span><span class="inner_quoted"><span>"["</span></span><span> </span><span>|--</span><span> </span><span>list</span><span> </span><span class="entity"><span>attrib</span></span><span> </span><span>--|</span><span> </span><span>$$$</span><span> </span><span class="inner_quoted"><span>"]"</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>opt_attribs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.optional</span><span> </span><span class="entity"><span>attribs</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>opt_thm_name</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Scan.optional</span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Parse.binding</span><span> </span><span>--</span><span> </span><span class="entity"><span>opt_attribs</span></span><span> </span><span>||</span><span> </span><span class="entity"><span>attribs</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>pair</span><span> </span><span>Binding.empty</span><span class="main"><span>)</span></span><span> </span><span>--|</span><span> </span><span>Parse.$$$</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
    </span><span>Binding.empty_atts</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>statement1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Parse.and_list1</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>opt_thm_name</span></span><span> </span><span class="inner_quoted"><span>":"</span></span><span> </span><span>--</span><span> </span><span>Parse.propp</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>requires_statement</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>assumes</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Parse.!!!</span><span> </span><span class="entity"><span>statement1</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>premises_statement</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>premises</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Parse.!!!</span><span> </span><span class="entity"><span>statement1</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>precond_statements</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Scan.repeat</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>premises_statement</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span class="entity"><span>Premise</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                </span><span>||</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>requires_statement</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span class="entity"><span>Assumption</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>flat</span><span class="main"><span>;</span></span><span>
</span><span class="comment1"><span>(* val requires_opt1 = Scan.option (<span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span>‹assumes› |-- Parse.term); *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>where_statement</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>where</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Parse.!!!</span><span> </span><span class="entity"><span>statement1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.option</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>@action</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Parse.term</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>includes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.optional</span><span> </span><span class="entity"><span>Parse_Spec.includes</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>input</span></span><span>  </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>input</span></span><span>›</span></span></span><span>  </span><span>|--</span><span> </span><span>Parse.term</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>output</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>output</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Parse.term</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>throws</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.option</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>throws</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Parse.term</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rec_vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>var</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>!!!</span><span> </span><span>vars</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>def_const_flag</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>(</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span class="entity"><span>Phi_Parse.$$$</span></span><span> </span><span class="inner_quoted"><span>"nodef"</span></span><span> </span><span>--|</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>)</span></span><span>›</span></span></span><span class="main"><span>)</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>true</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>modifier</span></span><span>  </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Parse.attribs</span><span> </span><span>&gt;&gt;</span><span> </span><span class="entity"><span>Mod_by_Attr</span></span><span class="main"><span>)</span></span><span> </span><span>||</span><span> </span><span class="main"><span>(</span></span><span>Parse.thm</span><span> </span><span>&gt;&gt;</span><span> </span><span class="entity"><span>Mod_by_Rule</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>modifiers</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>repeat</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>is</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span class="entity"><span>modifier</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Outer_Syntax.local_theory_to_proof'</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword1"><span>proc</span></span><span>›</span></span></span><span> </span><span class="inner_quoted"><span>"begin a procedure construction"</span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>def_const_flag</span></span><span> </span><span>--</span><span> </span><span class="entity"><span>Parse_Spec.opt_thm_name</span></span><span> </span><span class="inner_quoted"><span>":"</span></span><span>
      </span><span>--</span><span> </span><span class="entity"><span>includes</span></span><span>
      </span><span>--</span><span> </span><span class="entity"><span>precond_statements</span></span><span>
      </span><span>--</span><span> </span><span class="entity"><span>input</span></span><span>
      </span><span>--</span><span> </span><span class="entity"><span>precond_statements</span></span><span>
      </span><span>--</span><span> </span><span class="entity"><span>output</span></span><span>
      </span><span>--</span><span> </span><span class="entity"><span>throws</span></span><span>
      </span><span>--</span><span> </span><span class="entity"><span>goal</span></span><span>
      </span><span>--</span><span> </span><span class="entity"><span>where_statement</span></span><span>
      </span><span>--</span><span> </span><span>Parse.for_fixes</span><span>
      </span><span>--</span><span> </span><span class="entity"><span>modifiers</span></span><span class="main"><span>)</span></span><span> </span><span>&gt;&gt;</span><span>
      </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>def_const</span></span><span class="main"><span>,</span></span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>includes</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>prec1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>arg</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>prec2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>ret</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>throws</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>G</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>defs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>fixes</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>mods</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>begin_proc_cmd</span></span><span> </span><span class="entity"><span>def_const</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>arg</span></span><span> </span><span class="entity"><span>ret</span></span><span> </span><span class="entity"><span>throws</span></span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span class="entity"><span>includes</span></span><span> </span><span class="entity"><span>defs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prec1</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>prec2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>G</span></span><span> </span><span class="entity"><span>mods</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(*
val _ =
  Outer_Syntax.local_theory_to_proof' <span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span>‹rec_proc›
    "begin a recursive procedure construction"
    ((def_const_flag -- Parse_Spec.opt_thm_name ":"
      -- includes
      -- precond_statements
      -- input
      -- rec_vars
      -- precond_statements
      -- output
      -- throws
      -- goal
      -- where_statement
      -- Parse.for_fixes
     ) &gt;&gt; (
     fn (((((((((((def_const,b),includes),prec1),arg),vars),prec2),ret),throws),G),defs),fixes) =&gt;
        begin_rec_proc_cmd def_const b arg ret throws (vars,fixes) includes defs (prec1 @ prec2) G))
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Outer_Syntax.command</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword1"><span>;;</span></span><span>›</span></span></span><span> </span><span class="inner_quoted"><span>"Lead statements of φ programs"</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>statement_cmd</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="entity"><span>Toplevel.proof</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Outer_Syntax.command</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword1"><span>❴</span></span><span>›</span></span></span><span> </span><span class="inner_quoted"><span>"Begin a φ program block"</span></span><span>
   </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>  </span><span>optional</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>for</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>list1</span><span> </span><span>Parse.binding</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
     </span><span>--</span><span> </span><span>optional</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>premises</span></span><span>›</span></span></span><span> </span><span>|--</span><span>
            </span><span>and_list</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>binding</span><span> </span><span>--</span><span> </span><span class="entity"><span>opt_attribs</span></span><span> </span><span>||</span><span> </span><span class="entity"><span>attribs</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>pair</span><span> </span><span>Binding.empty</span><span class="main"><span>)</span></span><span> </span><span>--</span><span> </span><span class="entity"><span>ppats</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span>&gt;&gt;</span><span> </span><span class="entity"><span>begin_block_cmd</span></span><span class="main"><span>)</span></span><span>
   </span><span>--</span><span> </span><span class="entity"><span>Phi_Processor.powerful_process_p_inert</span></span><span class="main"><span>)</span></span><span>
   </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>blk</span></span><span class="main"><span>,</span></span><span class="entity"><span>prcs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Toplevel.proof'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prcs</span></span><span> </span><span>oo</span><span> </span><span class="entity"><span>blk</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Outer_Syntax.command</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword1"><span>❵</span></span><span>›</span></span></span><span> </span><span class="inner_quoted"><span>"End a φ program block"</span></span><span>
    </span><span class="main"><span>(</span></span><span>option</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>for</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>term</span><span class="main"><span>)</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Toplevel.proof'</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>end_block_cmd</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>repeat_future_proof</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>Proof.goal_finished</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>s</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>s</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>Proof.using_facts</span></span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.get_thms</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context_of</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"φ"</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>Proof.local_future_terminal_proof</span></span><span>
          </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>Method.Basic</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SIMPLE_METHOD</span></span><span> </span><span>o</span><span> </span><span>CHANGED_PROP</span><span> </span><span>o</span><span> </span><span class="entity"><span>auto_tac</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Position.no_range</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>repeat_future_proof0</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>Proof.goal_finished</span></span><span> </span><span class="entity"><span>s</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>Proof.local_done_proof</span></span><span> </span><span class="entity"><span>s</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>repeat_future_proof</span></span><span> </span><span class="entity"><span>s</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
 </span><span> </span><span class="entity"><span>Outer_Syntax.command</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword1"><span>❵.</span></span><span>›</span></span></span><span> </span><span class="inner_quoted"><span>"End a φ program block using default tactic"</span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>option</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>for</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>term</span><span class="main"><span>)</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>cast</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>int</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>stat</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
       </span><span class="entity"><span>stat</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>end_block_cmd</span></span><span> </span><span class="entity"><span>cast</span></span><span> </span><span class="entity"><span>int</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>repeat_future_proof0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span>--</span><span> </span><span class="entity"><span>Phi_Processor.powerful_process_p_inert</span></span><span class="main"><span>)</span></span><span>
   </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>blk</span></span><span class="main"><span>,</span></span><span class="entity"><span>prcs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Toplevel.proof'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prcs</span></span><span> </span><span>oo</span><span> </span><span class="entity"><span>blk</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(* val _ =
  Outer_Syntax.command <span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span>‹φinterface› "declare φinterface"
      (Parse.binding --| $$$ "=" -- Parse.const -- option ($$$ ":" |-- Parse.typ --| $$$ "⟼" -- Parse.typ)
        &gt;&gt; (Toplevel.theory o Phi_Procedure.add_interface_command))

val _ =
  Outer_Syntax.command <span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span>‹φexport_llvm› "export LLVM target"
      (Scan.succeed (Toplevel.theory (Phi_Toplevel.export_LLVM))) *)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span></pre>
</body>

</html>