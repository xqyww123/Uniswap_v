<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹library/reasoner.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹library/reasoner.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*
The engine of the Phi Logic Programming Reasoner
Author: Qiyuan Xu
*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>NU_REASONER</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="comment1"><span>(* This file is the major hot point of the whole system.
     TODO: optimize it as much as possible! *)</span></span><span>


  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>priority</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>int</span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>pattern</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>reasoners</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>reasoner</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>name</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span>
                 </span><span>pos</span><span class="main"><span>:</span></span><span> </span><span>Position.T</span><span class="main"><span>,</span></span><span>
                 </span><span>pattern</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pattern</span></span><span> * </span><span class="entity"><span>priority</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
                 </span><span>blacklist</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>pattern</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
                 </span><span>tactic</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>context_state</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context_state</span></span><span> </span><span>Seq.seq</span><span class="main"><span>)</span></span><span class="main"><span>}</span></span><span>


  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> trace </span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span>Config.T</span><span> </span><span class="comment1"><span>(*Prints the state of every reasoning step.*)</span></span><span>
                     </span><span class="comment1"><span>(*trace level: 0 - none; 1 - less info; 2 - more info; 3 - much more info*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> count_performance </span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span>Config.T</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> step_limit </span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span>Config.T</span><span> </span><span class="comment1"><span>(*limit of the number of reasoning steps*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> info_print </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="comment1"><span>(*level*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>unit</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> info_pretty</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="comment1"><span>(*level*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>unit</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> info_pretty_generic </span><span class="main"><span>:</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="comment1"><span>(*level*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>unit</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> error </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>'a</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> bad_config </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>'a</span><span>

  </span><span class="comment1"><span>(*auto level: 2 - fully auto, 1 - partially auto, 0 - fully manual*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> auto_level </span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span>Config.T</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> reduce_auto_level </span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> Success </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>context_state</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> Global_Cut </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>context_state</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> Global_Cut_Handlers </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>PLPR_HANDLERS</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> Success_Handlers </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>PLPR_HANDLERS</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> disable_global_cut </span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>serial</span><span> * </span><span class="entity"><span>Proof.context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> disable_success    </span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>serial</span><span> * </span><span class="entity"><span>Proof.context</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>reasoner</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_lthy </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>reasoner</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> del_reasoners</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span class="comment1"><span>(*pattern*)</span></span><span>
                  </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>reasoner</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span class="main"><span>)</span></span><span> </span><span class="comment1"><span>(*filter, returning true to delete one*)</span></span><span>
                  </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> has_reasoner </span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>reasoner</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> reasoners </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>reasoners</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> content </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>reasoners</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>reasoner</span></span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> get_reasoners </span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>reasoners</span></span><span>
                   </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="comment1"><span>(*pattern*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>reasoner</span></span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> pretty </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>reasoner</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span>
  </span><span class="comment1"><span>(*val call_reasoners : context_state -&gt; (Position.T * context_state Seq.seq) list*)</span></span><span>

  </span><span class="comment1"><span>(* Interfaces for Reasoning *)</span></span><span>
  </span><span class="comment1"><span>(*N: number of premises to be attacked at most, if it is positive;
       to attack all if it is None;
       to attack until a sequent remains at most |N| premises, if N is negative*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> reason  </span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span>option</span><span> </span><span class="comment1"><span>(*N*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context_state</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context_state</span></span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> reason1 </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>unit</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span class="main"><span>)</span></span><span> </span><span class="comment1"><span>(*error message*)</span></span><span>
             </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span>option</span><span> </span><span class="comment1"><span>(*N*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context_state</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context_state</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> reason_s </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="comment1"><span>(*the context for accessing reasoner db*)</span></span><span>
              </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>'a</span><span> * </span><span class="entity"><span>context_state</span></span><span> </span><span>Seq.seq</span><span> </span><span>list</span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>-&gt;</span></span><span> </span><span>'a</span><span> * </span><span class="entity"><span>context_state</span></span><span> </span><span>option</span><span>
  </span><span class="comment1"><span>(*Note it returns at most one state in the returned sequence.*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> reason_tac </span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span>option</span><span> </span><span class="comment1"><span>(*N*)</span></span><span>
                </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="comment1"><span>(*the context for accessing reasoner db*)</span></span><span>
                </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context_tactic</span></span><span>

  </span><span class="comment1"><span>(*The nested level of the current reasoning*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> nested_level </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="comment1"><span>(*Starting from 1*)</span></span><span>


  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_intro_rule </span><span class="main"><span>:</span></span><span> </span><span>Position.T</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>priority</span></span><span>
                    </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pattern</span></span><span> * </span><span class="entity"><span>priority</span></span><span> </span><span>option</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span class="entity"><span>pattern</span></span><span> </span><span>list</span><span>
                    </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>context_state</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span class="main"><span>)</span></span><span> </span><span>option</span><span>
                    </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span>
                    </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_intro_rules</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>thm</span><span> </span><span>list</span><span> * </span><span>Position.T</span><span> * </span><span class="entity"><span>priority</span></span><span> * </span><span class="main"><span>(</span></span><span class="entity"><span>pattern</span></span><span> * </span><span class="entity"><span>priority</span></span><span> </span><span>option</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span class="entity"><span>pattern</span></span><span> </span><span>list</span><span>
                       * </span><span class="main"><span>(</span></span><span class="entity"><span>context_state</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span class="main"><span>)</span></span><span> </span><span>option</span><span class="main"><span>)</span></span><span> </span><span>list</span><span>
                    </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> setup_cmd </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string</span><span> </span><span class="comment1"><span>(*name term*)</span></span><span> * </span><span>Position.T</span><span class="main"><span>)</span></span><span> * </span><span class="entity"><span>priority</span></span><span> </span><span class="comment1"><span>(*default priority*)</span></span><span class="main"><span>)</span></span><span>
                   * </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>bool</span><span> </span><span class="comment1"><span>(*true for matching, false for not matching*)</span></span><span>
                      * </span><span>string</span><span> </span><span class="comment1"><span>(*pattern term*)</span></span><span class="main"><span>)</span></span><span>
                      * </span><span class="entity"><span>priority</span></span><span> </span><span>option</span><span class="main"><span>)</span></span><span> </span><span>list</span><span>
                  </span><span class="main"><span>)</span></span><span> * </span><span>Input.source</span><span> </span><span class="comment1"><span>(* tactic source*)</span></span><span>
        </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span>

  </span><span class="comment1"><span>(* Default Pattern of Introduction Rule *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_default_pattern </span><span class="main"><span>:</span></span><span>
                  </span><span class="main"><span>(</span></span><span>int</span><span> </span><span class="comment1"><span>(*priority*)</span></span><span> * </span><span>term</span><span> </span><span class="comment1"><span>(*pattern P*)</span></span><span> * </span><span>term</span><span> </span><span class="comment1"><span>(*the default pattern X*)</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span>
               </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
      </span><span class="comment1"><span>(*The default pattern of an introduction rule whose conclusion matches P is X.*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> remove_default_pattern </span><span class="main"><span>:</span></span><span> </span><span>int</span><span> * </span><span>term</span><span> * </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> the_default_pattern_of </span><span class="main"><span>:</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>option</span><span>

  </span><span class="comment1"><span>(* Helpful Tools *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> chop_seq_head' </span><span class="main"><span>:</span></span><span> </span><span>'a</span><span> </span><span>Seq.seq</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>'a</span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> chop_seq_head  </span><span class="main"><span>:</span></span><span> </span><span>'a</span><span> </span><span>Seq.seq</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>'a</span><span> </span><span>Seq.seq</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> single_RS' </span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span class="comment1"><span>(*rule*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context_state</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context_state</span></span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> single_RS  </span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span class="comment1"><span>(*rule*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context_state</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context_state</span></span><span> </span><span>Seq.seq</span><span>
        </span><span class="comment1"><span>(*The resolution that returns at most one solution.*)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(*A special name to prevent someone overriding this structure, whose visibility is essential
  for parsing ML guard, see the ML_guard parser in declaring the φreason attribute*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>PLP_Reasoner_Guard_Parse_Sender_Qiyuan_Xu</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Data</span><span> </span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>context_state</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>init</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span>
</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Phi_Reasoner</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>NU_REASONER</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="comment1"><span>(*** Preliminaries ***)</span></span><span>

</span><span class="comment1"><span>(* Types *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>priority</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>int</span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>pattern</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>term</span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>term</span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>reasoner</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>name</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>,</span></span><span>
                 </span><span>pos</span><span class="main"><span>:</span></span><span> </span><span>Position.T</span><span class="main"><span>,</span></span><span>
                 </span><span>pattern</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> * </span><span>int</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
                 </span><span>blacklist</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
                 </span><span>tactic</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>context_state</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context_state</span></span><span> </span><span>Seq.seq</span><span class="main"><span>)</span></span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>trick</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_aterms</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isPrefix</span><span> </span><span class="inner_quoted"><span>"var_"</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>~</span><span class="entity"><span>i</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
                         </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>normalize_reasoner</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span class="entity"><span>pattern</span></span><span class="main"><span>,</span></span><span class="entity"><span>blacklist</span></span><span class="main"><span>,</span></span><span class="entity"><span>tactic</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span class="entity"><span>reasoner</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span>name</span><span class="main"><span>=</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span>pos</span><span class="main"><span>=</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span> </span><span>pattern</span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>trick</span></span><span> </span><span class="main"><span>(</span></span><span>Envir.beta_eta_contract</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pattern</span></span><span class="main"><span>,</span></span><span>
    </span><span>blacklist</span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>trick</span></span><span> </span><span>o</span><span> </span><span>Envir.beta_eta_contract</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>blacklist</span></span><span class="main"><span>,</span></span><span> </span><span>tactic</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tactic</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span class="entity"><span>reasoner</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>transform_reasoner</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span class="entity"><span>pattern</span></span><span class="main"><span>,</span></span><span class="entity"><span>blacklist</span></span><span class="main"><span>,</span></span><span class="entity"><span>tactic</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span class="entity"><span>reasoner</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span>name</span><span class="main"><span>=</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span>pos</span><span class="main"><span>=</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span>
    </span><span>pattern</span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>Morphism.term</span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pattern</span></span><span class="main"><span>,</span></span><span>
    </span><span>blacklist</span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Morphism.term</span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>blacklist</span></span><span class="main"><span>,</span></span><span>
    </span><span>tactic</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tactic</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span class="entity"><span>reasoner</span></span><span class="main"><span>)</span></span><span>


</span><span class="comment1"><span>(* Attributes *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>auto_level</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.setup_config_int</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Phi_Logic_Programming_Reasoner.\&lt;phi&gt;auto_level|attribute"><span>φauto_level</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="inner_numeral"><span>2</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>reduce_auto_level</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Config.map</span><span> </span><span class="entity"><span>auto_level</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Int.min</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.setup_config_int</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Phi_Logic_Programming_Reasoner.\&lt;phi&gt;trace_reasoning|attribute"><span>φtrace_reasoning</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>count_performance</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.setup_config_bool</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Phi_Logic_Programming_Reasoner.\&lt;phi&gt;count_performance|attribute"><span>φcount_performance</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>step_limit</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.setup_config_int</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Phi_Logic_Programming_Reasoner.\&lt;phi&gt;reasoning_step_limit|attribute"><span>φreasoning_step_limit</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="inner_numeral"><span>1000</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* Debug Info *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>info_pretty</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="entity"><span>G</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span>&lt;=</span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>trace</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>tracing</span><span> </span><span class="main"><span>(</span></span><span>Pretty.string_of</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>G</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>info_print</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="entity"><span>G</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>info_pretty</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>G</span></span><span> </span><span>#&gt;</span><span> </span><span>Pretty.str</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>info_pretty_generic</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="entity"><span>G</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>&lt;=</span><span> </span><span>Config.get_generic</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>trace</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>tracing</span><span> </span><span class="main"><span>(</span></span><span>Pretty.string_of</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>G</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>error</span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Exn.error</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>msg</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"\nReasoning Fail! You may turn on φtrace_reasoning or\
      \ φtrace_reasoning_candidates to debug."</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>bad_config</span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Exn.error</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>msg</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"\nSome rule is configured incorrectly!"</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(* Reasoning Environ *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Environ</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Data</span><span> </span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>int</span><span> </span><span class="comment1"><span>(*nested level*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>init</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span class="inner_numeral"><span>0</span></span><span>
</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>enter_reasoning_envir</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Environ.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>exit_reasoning_envir</span></span><span>  </span><span class="main"><span>=</span></span><span> </span><span>Environ.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nested_level</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Environ.get</span><span>

</span><span class="comment1"><span>(* Cut, Abrupt Termination, and Handlers *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>Success</span></span><span>    </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>context_state</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>Global_Cut</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>context_state</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>Local_Cut</span></span><span>  </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>priority</span></span><span> * </span><span>Position.T</span><span> * </span><span class="entity"><span>context_state</span></span><span> </span><span>Seq.seq</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Global_Cut_Handlers</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>PLPR_Handlers</span></span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>domT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>context_state</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>retT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Position.T</span><span> * </span><span class="entity"><span>context_state</span></span><span> </span><span>Seq.seq</span><span class="main"><span>)</span></span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>default</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Global_Cut</span></span><span> </span><span class="entity"><span>s</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>current_level</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nested_level</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt_of</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fst</span><span>
</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Success_Handlers</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>PLPR_Handlers</span></span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>domT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>context_state</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>retT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Position.T</span><span> * </span><span class="entity"><span>context_state</span></span><span> </span><span>Seq.seq</span><span class="main"><span>)</span></span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>default</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Success</span></span><span> </span><span class="entity"><span>s</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>current_level</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nested_level</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt_of</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fst</span><span>
</span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(*delt: 0 for the current reasoning context
        1 for the sub-calling environment*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>disable_global_cut</span></span><span> </span><span class="entity"><span>delt</span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Global_Cut_Handlers.push_localctxt</span></span><span> </span><span class="entity"><span>delt</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>bad_config</span></span><span> </span><span class="entity"><span>msg</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>disable_success</span></span><span>    </span><span class="entity"><span>delt</span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Success_Handlers.push_localctxt</span></span><span> </span><span class="entity"><span>delt</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>bad_config</span></span><span> </span><span class="entity"><span>msg</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(*** Reasoner Registry ***)</span></span><span>

</span><span class="comment1"><span>(** Hasher **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>reasoner_id</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>serial</span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>hasher_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>s1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>s2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s2</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>hasher_net</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Synchronized.var</span><span> </span><span class="inner_quoted"><span>"Phi_Reasoner.reasoner_hasher"</span></span><span>
                                  </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>Net.empty</span><span> </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span> * </span><span class="entity"><span>reasoner_id</span></span><span class="main"><span>)</span></span><span> </span><span>Net.net</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>hash</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Synchronized.change_result</span><span> </span><span class="entity"><span>hasher_net</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="entity"><span>net</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>find_first</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Net.lookup</span><span> </span><span class="entity"><span>net</span></span><span> </span><span class="main"><span>(</span></span><span>Net.key_of_term</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="entity"><span>net</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
       </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span>Net.insert_term</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>N</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>net</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>)</span></span><span>


</span><span class="comment1"><span>(** Main Registry **)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>registry_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>c1</span></span><span class="main"><span>,</span></span><span class="entity"><span>pat1</span></span><span class="main"><span>,</span></span><span class="entity"><span>id1</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>c2</span></span><span class="main"><span>,</span></span><span class="entity"><span>pat2</span></span><span class="main"><span>,</span></span><span class="entity"><span>id2</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>c2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>pat1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pat2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>id1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>id2</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>reasoners</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>priority</span></span><span> * </span><span class="entity"><span>pattern</span></span><span> * </span><span class="entity"><span>reasoner_id</span></span><span> * </span><span class="entity"><span>reasoner</span></span><span class="main"><span>)</span></span><span> </span><span>Net.net</span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Reasoners</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Generic_Data</span><span> </span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>reasoners</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Net.empty</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>merge</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> * </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Net.merge</span><span> </span><span class="entity"><span>registry_eq</span></span><span>
</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>reasoners</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Reasoners.get</span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>content</span></span><span> </span><span class="entity"><span>net</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Net.content</span><span> </span><span class="entity"><span>net</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pretty</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span class="main"><span>:</span></span><span class="entity"><span>reasoner</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Pretty.chunks</span><span> </span><span class="main"><span>(</span></span><span>
    </span><span>Pretty.block</span><span> </span><span class="main"><span>(</span></span><span>Pretty.here</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>pos</span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>" "</span></span><span class="main"><span>,</span></span><span> </span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>name</span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span>
    </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pat</span></span><span class="main"><span>,</span></span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Pretty.item</span><span> </span><span class="main"><span>[</span></span><span>
          </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"("</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.str</span><span> </span><span class="main"><span>(</span></span><span>string_of_int</span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"): "</span></span><span class="main"><span>,</span></span><span>
          </span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>pat</span></span><span>
        </span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>pattern</span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pretty'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>priority</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pat</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span class="main"><span>:</span></span><span class="entity"><span>reasoner</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
   </span><span>Pretty.block</span><span> </span><span class="main"><span>(</span></span><span>
     </span><span>Pretty.here</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>pos</span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span>
    </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"("</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.str</span><span> </span><span class="main"><span>(</span></span><span>string_of_int</span><span> </span><span class="entity"><span>priority</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>") on pattern "</span></span><span class="main"><span>,</span></span><span>
     </span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>pat</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>" : "</span></span><span class="main"><span>,</span></span><span>
     </span><span>Pretty.fbrk</span><span class="main"><span>,</span></span><span>
     </span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>name</span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>insert_net</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>reasoner</span></span><span class="main"><span>:</span></span><span class="entity"><span>reasoner</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pat</span></span><span class="main"><span>,</span></span><span class="entity"><span>priority</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>net</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>priority</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pat</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>hash</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>name</span><span> </span><span class="entity"><span>reasoner</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>reasoner</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Net.insert_term</span><span> </span><span class="entity"><span>registry_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pat</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>net</span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Net.INSERT</span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dups</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Net.lookup</span><span> </span><span class="entity"><span>net</span></span><span> </span><span class="main"><span>(</span></span><span>Net.key_of_term</span><span> </span><span class="entity"><span>pat</span></span><span class="main"><span>)</span></span><span>
                   </span><span>|&gt;</span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>y</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>registry_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
           </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Context.proof_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Exn.error</span><span> </span><span class="main"><span>(</span></span><span>Pretty.string_of</span><span> </span><span class="main"><span>(</span></span><span>Pretty.chunks</span><span> </span><span class="main"><span>(</span></span><span>
              </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"Clash with existing reasoner!"</span></span><span> </span><span>::</span><span>
              </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>d</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>pretty'</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>d</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>dups</span></span><span>
           </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="entity"><span>reasoner0</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>reasoner</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>normalize_reasoner</span></span><span> </span><span>I</span><span> </span><span class="entity"><span>reasoner0</span></span><span>
     </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>info_pretty_generic</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span>Pretty.chunks</span><span> </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"Installing φ-LPR reasoner:"</span></span><span class="main"><span>,</span></span><span>
                               </span><span class="entity"><span>pretty</span></span><span> </span><span class="main"><span>(</span></span><span>Context.proof_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>reasoner</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Reasoners.map</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>insert_net</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>reasoner</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>pattern</span><span> </span><span class="entity"><span>reasoner</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>adds</span></span><span> </span><span class="entity"><span>reasoners</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Reasoners.map</span><span> </span><span class="main"><span>(</span></span><span>
      </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>reasoner0</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>reasoner</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>normalize_reasoner</span></span><span> </span><span>I</span><span> </span><span class="entity"><span>reasoner0</span></span><span>
           </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>info_pretty_generic</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span>Pretty.chunks</span><span> </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"Installing φ-LPR reasoner:"</span></span><span class="main"><span>,</span></span><span>
                               </span><span class="entity"><span>pretty</span></span><span> </span><span class="main"><span>(</span></span><span>Context.proof_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>reasoner</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>insert_net</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>reasoner</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>pattern</span><span> </span><span class="entity"><span>reasoner</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>reasoners</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_lthy</span></span><span> </span><span class="entity"><span>reasoner</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Local_Theory.declaration</span><span> </span><span class="main"><span>{</span></span><span>syntax</span><span class="main"><span>=</span></span><span>false</span><span class="main"><span>,</span></span><span> </span><span>pervasive</span><span class="main"><span>=</span></span><span>false</span><span class="main"><span>}</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="entity"><span>add</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>transform_reasoner</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>reasoner</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(*** Implementing Functions ***)</span></span><span>

</span><span class="comment1"><span>(* Main Reasoning Function *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>debug</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>reasoner</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>tracing</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"reasoning candicates ("</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>c</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"):\n"</span></span><span>
              </span><span>^</span><span> </span><span>Syntax.string_of_term</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.set_mode</span><span> </span><span>Proof_Context.mode_abbrev</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_var</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>A</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>is_var</span></span><span> </span><span class="entity"><span>A</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_var</span></span><span> </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_var</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>match_term</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>pat_obj</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>tms</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>PLPR_Pattern.match</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>pat_obj</span></span><span> </span><span class="main"><span>(</span></span><span>Vartab.empty</span><span class="main"><span>,</span></span><span> </span><span>Vartab.empty</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Vartab.fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>flag</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>&lt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="comment1"><span>(* String.isPrefix "var_" name *)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>flag</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>is_var</span></span><span> </span><span class="main"><span>(</span></span><span>Envir.beta_eta_contract</span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>flag</span></span><span>
     </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tms</span></span><span> </span><span>true</span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Pattern.MATCH</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>concl_of_goal</span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>gi</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rfrees</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.goal_params</span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="entity"><span>i</span></span><span>
     </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>B</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.strip_assums_concl</span><span> </span><span class="entity"><span>gi</span></span><span>
      </span><span class="comment1"><span>(*val As = Logic.strip_assums_hyp gi*)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>subst_bounds</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rfrees</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>B</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(* fun beta_eta_contract_leading_antecedent th =
  if (case Thm.prop_of th
        of <span class="hidden">\&lt;^</span><span class="control">const</span><span class="hidden">&gt;</span>‹Pure.imp› $ X $ _ =&gt; Term.could_beta_eta_contract X
         | _ =&gt; false)
  then Thm.equal_elim (Conv.implies_conv Drule.beta_eta_conversion
                                         Conv.all_conv (Thm.cprop_of th)) th
  else th *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>distinct_rev</span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="entity"><span>lst</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dist</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rev_seen</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rev_seen</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dist</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rev_seen</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>dist</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rev_seen</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>dist</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>rev_seen</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>dist</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lst</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_reasoners'</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>tactics</span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Net.match_term</span><span> </span><span class="entity"><span>tactics</span></span><span> </span><span class="entity"><span>term</span></span><span>
    </span><span>|&gt;</span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>pat</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>reasoner</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>match_term</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pat</span></span><span class="main"><span>,</span></span><span class="entity"><span>term</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>pat</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>match_term</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pat</span></span><span class="main"><span>,</span></span><span class="entity"><span>term</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>blacklist</span><span> </span><span class="entity"><span>reasoner</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>sort</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>c1</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>c2</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>int_ord</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c1</span></span><span class="main"><span>,</span></span><span class="entity"><span>c2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>distinct_rev</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>3</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>3</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_reasoners</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>tactics</span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>get_reasoners'</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>tactics</span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>del_reasoners</span></span><span> </span><span class="entity"><span>pattern</span></span><span> </span><span class="entity"><span>filter</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Reasoners.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>all_reasoners</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>to_remove</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Net.match_term</span><span> </span><span class="entity"><span>all_reasoners</span></span><span> </span><span class="entity"><span>pattern</span></span><span>
                     </span><span>|&gt;</span><span> </span><span>List.filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>filter</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Net.delete_term</span><span> </span><span class="entity"><span>registry_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
             </span><span class="entity"><span>to_remove</span></span><span> </span><span class="entity"><span>all_reasoners</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>has_reasoner</span></span><span> </span><span class="entity"><span>pattern</span></span><span> </span><span class="entity"><span>filter</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Net.match_term</span><span> </span><span class="main"><span>(</span></span><span>Reasoners.get</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pattern</span></span><span>
    </span><span>|&gt;</span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>filter</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gen_call_reasoners</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>score</span></span><span> </span><span class="entity"><span>tactics</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Thm.major_prem_of</span><span> </span><span class="entity"><span>th</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Envir.beta_eta_contract</span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>get_reasoners'</span></span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tactics</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="inner_numeral"><span>3</span></span><span> </span><span>&lt;=</span><span> </span><span class="entity"><span>trace</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>rs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>List.app</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>debug</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rs</span></span><span class="main"><span>;</span></span><span> </span><span class="entity"><span>rs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>priority</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>reasoner</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>priority</span></span><span> </span><span>&gt;=</span><span> </span><span class="inner_numeral"><span>1000000</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
         </span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Seq.pull</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>tactic</span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Global_Cut</span></span><span> </span><span class="entity"><span>x</span></span><span>
             </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>priority</span></span><span> </span><span>&gt;=</span><span> </span><span class="inner_numeral"><span>1000</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
         </span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Seq.pull</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>tactic</span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Local_Cut</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>score</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>priority</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span>pos</span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>,</span></span><span> </span><span>Seq.cons</span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
             </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>priority</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>score</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span>pos</span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>,</span></span><span> </span><span>Seq.make</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Seq.pull</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>tactic</span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>)</span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>Local_Cut</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span class="entity"><span>seq</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span class="entity"><span>seq</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
       </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Success</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Success_Handlers.invoke</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span>
                   </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>score</span></span><span class="main"><span>,</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
       </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Global_Cut</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Global_Cut_Handlers.invoke</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span>
                      </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>score</span></span><span class="main"><span>,</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>call_reasoners'</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>score</span></span><span> </span><span class="entity"><span>N</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>tactics</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Thm.nprems_of</span><span> </span><span class="entity"><span>th</span></span><span> </span><span>&lt;=</span><span> </span><span class="entity"><span>N</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Success</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>gen_call_reasoners</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>score</span></span><span> </span><span class="entity"><span>tactics</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>th</span></span><span>

</span><span class="comment1"><span>(*fun call_reasoners (ctxt,th) =
  gen_call_reasoners (Config.get ctxt trace) (Reasoners.get (Context.Proof ctxt)) ctxt th *)</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gen_reason</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>gen_reason</span></span><span> </span><span class="entity"><span>N</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>limit</span></span><span> </span><span class="entity"><span>iter</span></span><span> </span><span class="entity"><span>tactics</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>::</span><span class="entity"><span>L</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span>&lt;=</span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>tracing</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Backtracking..."</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span> </span><span class="entity"><span>gen_reason</span></span><span> </span><span class="entity"><span>N</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>limit</span></span><span> </span><span class="entity"><span>iter</span></span><span> </span><span class="entity"><span>tactics</span></span><span> </span><span class="entity"><span>L</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>gen_reason</span></span><span> </span><span class="entity"><span>N</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>limit</span></span><span> </span><span class="entity"><span>iter</span></span><span> </span><span class="entity"><span>tactics</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>score</span></span><span class="main"><span>,</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span class="entity"><span>seq</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>L'</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>L</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> 
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>iter</span></span><span> </span><span>&gt;</span><span> </span><span class="entity"><span>limit</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>error</span></span><span> </span><span class="inner_quoted"><span>"The reasoning reaches the limit of the number of reasoning steps.\n\
                       \Perhaps an infinite loop is encountered.\nOtherwise, \
                       \you can set φreasoning_step_limit to increase the limit of the steps\
                       \if it is too small."</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
   </span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Seq.pull</span><span> </span><span class="entity"><span>seq</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>seq'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
           </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span>&lt;=</span><span> </span><span class="entity"><span>trace</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>tracing</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"φreasoning("</span></span><span>^</span><span>string_of_int</span><span> </span><span class="entity"><span>score</span></span><span>^</span><span class="inner_quoted"><span>"):"</span></span><span>^</span><span>
                                  </span><span>Position.here</span><span> </span><span class="entity"><span>pos</span></span><span> </span><span>^</span><span class="inner_quoted"><span>"\n"</span></span><span> </span><span>^</span><span> </span><span>Thm.string_of_thm</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
           </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Z</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>call_reasoners'</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>score</span></span><span> </span><span class="entity"><span>N</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>tactics</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span>
                  </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>Z</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Z</span></span><span>::</span><span class="main"><span>(</span></span><span>
                        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>pointer_eq</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>seq'</span></span><span class="main"><span>,</span></span><span>Seq.empty</span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>L'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>score</span></span><span class="main"><span>,</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span class="entity"><span>seq'</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>L'</span></span><span>
                        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>t</span></span><span>::</span><span class="entity"><span>L</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>Success</span></span><span> </span><span class="entity"><span>ret</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Success</span></span><span> </span><span class="entity"><span>ret</span></span><span>
                     </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Global_Cut</span></span><span> </span><span class="entity"><span>stat</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                         </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span>&lt;=</span><span> </span><span class="entity"><span>trace</span></span><span>
                                  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>tracing</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"φreasoning cut:\n"</span></span><span>
                                          </span><span>^</span><span> </span><span>Thm.string_of_thm</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span class="entity"><span>stat</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                                  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
                        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                         </span><span> </span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span> </span><span>Seq.single</span><span> </span><span class="entity"><span>stat</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span>
                        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
           </span><span> </span><span class="entity"><span>gen_reason</span></span><span> </span><span class="entity"><span>N</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>limit</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>iter</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tactics</span></span><span> </span><span class="entity"><span>Z</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
       </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>gen_reason</span></span><span> </span><span class="entity"><span>N</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="entity"><span>limit</span></span><span> </span><span class="entity"><span>iter</span></span><span> </span><span class="entity"><span>tactics</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>L'</span></span><span>::</span><span class="entity"><span>L</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(*Entry point*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gen_reason'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>N</span></span><span> </span><span class="entity"><span>states</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Timing.cond_timeit</span><span> </span><span class="main"><span>(</span></span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>count_performance</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"Time spent by φ-LPR reasoning:"</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
     </span><span class="main"><span>(</span></span><span class="entity"><span>gen_reason</span></span><span> </span><span class="entity"><span>N</span></span><span> </span><span class="main"><span>(</span></span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>trace</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>step_limit</span></span><span class="main"><span>)</span></span><span>
                 </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="main"><span>(</span></span><span>Reasoners.get</span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                 </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>seq</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span>Position.none</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>seq</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>states</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>Success</span></span><span> </span><span class="entity"><span>ret</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>ret</span></span><span class="main"><span>)</span></span><span>
     </span><span>|&gt;</span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span class="entity"><span>exit_reasoning_envir</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>)</span></span><span>



</span><span class="comment1"><span>(* Various Interfaces for Invoking Reasoning *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>num_of_protected_prems</span></span><span>  </span><span class="main"><span>_</span></span><span>  </span><span>NONE</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>num_of_protected_prems</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>N</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>N</span></span><span> </span><span>&gt;=</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Thm.nprems_of</span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>N</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>~</span><span class="entity"><span>N</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>reason</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>S</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>S</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>reason</span></span><span> </span><span class="entity"><span>N</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>gen_reason'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>num_of_protected_prems</span></span><span> </span><span class="entity"><span>sequent</span></span><span> </span><span class="entity"><span>N</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span>Seq.single</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>enter_reasoning_envir</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>reason1</span></span><span> </span><span class="entity"><span>G</span></span><span> </span><span class="entity"><span>N</span></span><span> </span><span class="entity"><span>stat</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>reason</span></span><span> </span><span class="entity"><span>N</span></span><span> </span><span class="entity"><span>stat</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>error</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>G</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>reason_s</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>seqs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ret</span></span><span class="main"><span>,</span></span><span class="entity"><span>seqs'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>seqs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>enter_reasoning_envir</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ret</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gen_reason'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>seqs'</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>reason_tac</span></span><span> </span><span class="entity"><span>N</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>stat</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Seq.make</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="entity"><span>gen_reason'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>num_of_protected_prems</span></span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span class="entity"><span>stat</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>N</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span>Seq.single</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span class="entity"><span>enter_reasoning_envir</span></span><span> </span><span class="entity"><span>stat</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span>
       </span><span>|&gt;</span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span>rpair</span><span> </span><span>Seq.empty</span><span> </span><span>o</span><span> </span><span>Seq.Result</span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>)</span></span><span>



</span><span class="comment1"><span>(*** Command Interface ***)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>setup_method_cmd</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>priority</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>raw_patterns</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>method</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.set_mode</span><span> </span><span>Proof_Context.mode_pattern</span><span> </span><span class="entity"><span>lthy</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>terms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_patterns</span></span><span>
             </span><span>|&gt;</span><span> </span><span>Syntax.read_props</span><span> </span><span class="entity"><span>ctxt</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>patterns</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>flag</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>flag</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>tm</span></span><span class="main"><span>,</span></span><span> </span><span>the_default</span><span> </span><span class="entity"><span>priority</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                        </span><span class="entity"><span>raw_patterns</span></span><span> </span><span class="entity"><span>terms</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pos_pats</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>patterns</span></span><span> </span><span>|&gt;</span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sgn</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pat</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>sgn</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>pat</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>neg_pats</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>patterns</span></span><span> </span><span>|&gt;</span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sgn</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pat</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>sgn</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>NONE</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>pat</span></span><span class="main"><span>)</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Free</span><span class="main"><span>(</span></span><span>Binding.name_of</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span>dummyT</span><span class="main"><span>)</span></span><span>

   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>method'</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Method_Closure.method_cmd</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>method</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>method''</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Method_Closure.apply_method</span></span><span> </span><span class="entity"><span>lthy'</span></span><span> </span><span class="entity"><span>method'</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>method'''</span></span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>method''</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>Seq.filter_results</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>add_lthy</span></span><span> </span><span class="main"><span>{</span></span><span>name</span><span class="main"><span>=</span></span><span class="entity"><span>name'</span></span><span class="main"><span>,</span></span><span> </span><span>pos</span><span class="main"><span>=</span></span><span>Binding.pos_of</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span>
               </span><span>pattern</span><span class="main"><span>=</span></span><span class="entity"><span>pos_pats</span></span><span class="main"><span>,</span></span><span> </span><span>blacklist</span><span class="main"><span>=</span></span><span class="entity"><span>neg_pats</span></span><span class="main"><span>,</span></span><span> </span><span>tactic</span><span class="main"><span>=</span></span><span class="entity"><span>method'''</span></span><span class="main"><span>}</span></span><span> </span><span class="entity"><span>lthy'</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>setup_cmd</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>priority</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>raw_patterns</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>tactic_src</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.set_mode</span><span> </span><span>Proof_Context.mode_pattern</span><span> </span><span class="entity"><span>lthy</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax.read_term</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>name</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>terms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_patterns</span></span><span>
             </span><span>|&gt;</span><span> </span><span>Syntax.read_props</span><span> </span><span class="entity"><span>ctxt</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>patterns</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>flag</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>flag</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>tm</span></span><span class="main"><span>,</span></span><span> </span><span>the_default</span><span> </span><span class="entity"><span>priority</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                        </span><span class="entity"><span>raw_patterns</span></span><span> </span><span class="entity"><span>terms</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pos_pats</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>patterns</span></span><span> </span><span>|&gt;</span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sign</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pat</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>sign</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>pat</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>neg_pats</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>patterns</span></span><span> </span><span>|&gt;</span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sign</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pat</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>sign</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>NONE</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>pat</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>ML_Syntax</span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
   </span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span>|&gt;</span><span> </span><span>Context.proof_map</span><span> </span><span class="main"><span>(</span></span><span>
      </span><span>ML_Context.expression</span><span> </span><span class="main"><span>(</span></span><span>Input.pos_of</span><span> </span><span class="entity"><span>tactic_src</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span>ML_Lex.read</span><span>
          </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Theory.local_setup (Phi_Reasoner.add_lthy {name=("</span></span><span> </span><span>^</span><span>
          </span><span>print_term</span><span> </span><span class="entity"><span>name</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"), pos=("</span></span><span>^</span><span>
          </span><span>print_position</span><span> </span><span class="entity"><span>pos</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"), pattern=("</span></span><span> </span><span>^</span><span>
          </span><span>print_list</span><span> </span><span class="main"><span>(</span></span><span>print_pair</span><span> </span><span>print_term</span><span> </span><span>print_int</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pos_pats</span></span><span>
          </span><span>^</span><span> </span><span class="inner_quoted"><span>"), blacklist=("</span></span><span>^</span><span>
          </span><span>print_list</span><span> </span><span>print_term</span><span> </span><span class="entity"><span>neg_pats</span></span><span>
          </span><span>^</span><span class="inner_quoted"><span>"), tactic=(let in "</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span>
          </span><span>ML_Lex.read_source</span><span> </span><span class="entity"><span>tactic_src</span></span><span> </span><span>@</span><span>
          </span><span>ML_Lex.read</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>" end):(context_state -&gt; context_state Seq.seq)})"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>patterns</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Parse.$$$</span><span> </span><span class="inner_quoted"><span>"("</span></span><span> </span><span>|--</span><span> </span><span>Parse.enum</span><span> </span><span class="inner_quoted"><span>"|"</span></span><span>
      </span><span class="main"><span>(</span></span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>except</span></span><span>›</span></span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span>true</span><span> </span><span>--</span><span> </span><span>Parse.term</span><span>
                </span><span>--</span><span> </span><span>Scan.option</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>(</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Parse.int</span><span> </span><span>--|</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>)</span></span><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>--|</span><span> </span><span>Parse.$$$</span><span> </span><span class="inner_quoted"><span>")"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Outer_Syntax.local_theory</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>command_keyword</span></span><span> </span><span class="keyword1"><span>φreasoner_ML</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="inner_quoted"><span>"define φreasoner"</span></span><span>
    </span><span class="main"><span>(</span></span><span>Parse.position</span><span> </span><span>Parse.term</span><span> </span><span>--</span><span> </span><span>Parse.int</span><span> </span><span>--</span><span> </span><span class="entity"><span>patterns</span></span><span>
        </span><span>--|</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>keyword</span></span><span> </span><span class="keyword2"><span>=</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span>--</span><span> </span><span>Parse.ML_source</span><span>
      </span><span>&gt;&gt;</span><span> </span><span class="entity"><span>setup_cmd</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Outer_Syntax.local_theory</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>command_keyword</span></span><span> </span><span class="keyword1"><span>φreasoner</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="inner_quoted"><span>"define φreasoner"</span></span><span>
    </span><span class="main"><span>(</span></span><span>Parse.binding</span><span> </span><span>--</span><span> </span><span>Parse.int</span><span> </span><span>--</span><span> </span><span class="entity"><span>patterns</span></span><span>
        </span><span>--|</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>keyword</span></span><span> </span><span class="keyword2"><span>=</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span>--</span><span> </span><span>Parse.args1</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span>
      </span><span>&gt;&gt;</span><span> </span><span class="entity"><span>setup_method_cmd</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Outer_Syntax.command</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword1"><span>print_φreasoners</span></span><span>›</span></span></span><span>
    </span><span class="inner_quoted"><span>"print φreasoner matching the given pattern"</span></span><span>
    </span><span class="main"><span>(</span></span><span>Parse.term</span><span> </span><span>--</span><span> </span><span class="main"><span>(</span></span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span>Args.query</span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>raw_pattern</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>strict</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="entity"><span>Toplevel.keep</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>top</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Toplevel.context_of</span></span><span> </span><span class="entity"><span>top</span></span><span>
           </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pattern</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax.read_prop</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.set_mode</span><span> </span><span>Proof_Context.mode_pattern</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_pattern</span></span><span>
           </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>all_reasoners</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Reasoners.get</span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
           </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>reasoners</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>strict</span></span><span>
                            </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>get_reasoners'</span></span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>all_reasoners</span></span><span> </span><span class="entity"><span>pattern</span></span><span>
                            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Net.match_term</span><span> </span><span class="entity"><span>all_reasoners</span></span><span> </span><span class="entity"><span>pattern</span></span><span>
                                  </span><span>|&gt;</span><span> </span><span>sort</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>c1</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>c2</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>int_ord</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c1</span></span><span class="main"><span>,</span></span><span class="entity"><span>c2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>reasoners</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>writeln</span><span> </span><span class="inner_quoted"><span>"No reasoner found."</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>writeln</span><span> </span><span class="main"><span>(</span></span><span>Pretty.string_of</span><span> </span><span class="main"><span>(</span></span><span>Pretty.chunks</span><span>
                              </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>pretty</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>reasoners</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(*** Default Pattern for Introduction Reasoning Rule ***)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Default_Pattern</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Pattern_Translation</span></span><span> </span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>multi_translation_err_msg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"Fail to determine which pattern is preferable. \
                                \Please indicate the pattern manually using syntax \
                                \‹φreason for ‹pattern››"</span></span><span>
</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>add_default_pattern</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Default_Pattern.add</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>remove_default_pattern</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Default_Pattern.remove</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>the_default_pattern_of</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Default_Pattern.translate</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Theory.setup</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Default_Pattern.setup_attribute</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Phi_Logic_Programming_Reasoner.\&lt;phi&gt;reason_default_pattern|attribute"><span>φreason_default_pattern</span></span><span>›</span></span></span><span>
          </span><span class="inner_quoted"><span>"set the default pattern of a reasoning rule once its conclusion matches some pattern"</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(*** Reasoner for Introduction Reasoning Rule ***)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>chop_seq_head'</span></span><span> </span><span class="entity"><span>seq</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Seq.chop</span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="entity"><span>seq</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>ret</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>ret</span></span><span>
       </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
       </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ret</span></span><span>::</span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>warning</span><span> </span><span class="inner_quoted"><span>"Multi Resolution! For performance consideration, PLPR only takes\
                                 \ the first solution and discards the remains."</span></span><span class="main"><span>;</span></span><span>
                        </span><span> </span><span>SOME</span><span> </span><span class="entity"><span>ret</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>chop_seq_head</span></span><span> </span><span class="entity"><span>seq</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Seq.make</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span>rpair</span><span> </span><span>Seq.empty</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>chop_seq_head'</span></span><span> </span><span class="entity"><span>seq</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>single_RS'</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Thm.biresolution</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span>false</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>thm</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>chop_seq_head'</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>single_RS</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Seq.make</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span>rpair</span><span> </span><span>Seq.empty</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>single_RS'</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>name_of_intro_reasoner</span></span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="comment1"><span>(*Free ("φIntro_Rule", <span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span>‹prop ⇒ prop›) $ *)</span></span><span> </span><span>Logic.mk_conjunction_list</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Thm.prop_of</span><span> </span><span class="entity"><span>rules</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>intro_reasoner</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>priority</span></span><span class="main"><span>:</span></span><span class="entity"><span>priority</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>patterns</span></span><span> </span><span class="entity"><span>blacklist</span></span><span> </span><span class="entity"><span>guard</span></span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rules</span></span><span>
             </span><span>|&gt;</span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>Thm.is_free_dummy</span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>Thm.is_dummy</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
             </span><span>|&gt;</span><span> </span><span>Drule.zero_var_indexes_list</span><span>
             </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span>Thm.trim_context</span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>error</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"No rule is given!"</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pats</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>patterns</span></span><span>
               </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>rules</span></span><span>
                      </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rule</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.concl_of</span><span> </span><span class="entity"><span>rule</span></span><span>
                           </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pat</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the_default</span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>the_default_pattern_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>)</span></span><span>
                           </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>info_pretty_generic</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Pretty.chunks</span><span> </span><span class="main"><span>[</span></span><span>
                                    </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"No pattern is given, use the default pattern:"</span></span><span class="main"><span>,</span></span><span>
                                    </span><span>Syntax.pretty_term</span><span> </span><span class="main"><span>(</span></span><span>Context.proof_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pat</span></span><span>
                                </span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>pat</span></span><span class="main"><span>,</span></span><span class="entity"><span>priority</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
                       </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>error</span></span><span> </span><span class="inner_quoted"><span>"Pattern of the reasoner is required"</span></span><span>
               </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>the_default</span><span> </span><span class="entity"><span>priority</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>patterns</span></span><span>

   </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rules_with_flag</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_Require</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Phi_Logic_Programming_Reasoner.Phi_Logic_Programming_Reasoner.html#Phi_Logic_Programming_Reasoner.\&lt;r&gt;Require|const"><span>𝗋Require</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_Require</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.imp</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>is_Require</span></span><span> </span><span class="entity"><span>X</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_Require</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.all</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>is_Require</span></span><span> </span><span class="entity"><span>X</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_Require</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
       </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.prems_of</span><span> </span><span class="entity"><span>rule</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>    </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>
             </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span>::</span><span class="entity"><span>L</span></span><span class="main"><span>)</span></span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>exists</span><span> </span><span class="entity"><span>is_Require</span></span><span> </span><span class="entity"><span>L</span></span><span>
                        </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>error</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"A reasoning rule can contain one 𝗋Require antecedent at \
                                   \the leading position."</span></span><span class="main"><span>)</span></span><span>
                        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>is_Require</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rules</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tactic</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Seq.empty</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>tactic</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>has_semantic_guard</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Seq.make</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="entity"><span>single_RS'</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="entity"><span>s</span></span><span>
            </span><span>|&gt;</span><span> </span><span class="entity"><span>has_semantic_guard</span></span><span> </span><span>?</span><span> </span><span>Option.mapPartial</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>reason</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Seq.pull</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tactic</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
                 </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>ret</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ret</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tactic</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>guarded_tac</span></span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>guard</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>tactic</span></span><span> </span><span class="entity"><span>rules</span></span><span>
                  </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>G</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tactic</span></span><span> </span><span class="entity"><span>rules</span></span><span>
                               </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>G</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Seq.empty</span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>{</span></span><span>name</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>name_of_intro_reasoner</span></span><span> </span><span class="entity"><span>rules</span></span><span class="main"><span>,</span></span><span>
      </span><span>pos</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span>
      </span><span>pattern</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pats</span></span><span class="main"><span>,</span></span><span>
      </span><span>blacklist</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>blacklist</span></span><span class="main"><span>,</span></span><span>
      </span><span>tactic</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>guarded_tac</span></span><span> </span><span class="entity"><span>rules_with_flag</span></span><span>
      </span><span class="main"><span>}</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_intro_rule</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="entity"><span>priority</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pattern</span></span><span class="main"><span>,</span></span><span class="entity"><span>blacklist</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>guard</span></span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>add</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>intro_reasoner</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="entity"><span>priority</span></span><span> </span><span class="entity"><span>pattern</span></span><span> </span><span class="entity"><span>blacklist</span></span><span> </span><span class="entity"><span>guard</span></span><span> </span><span class="entity"><span>rules</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_intro_rules</span></span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>adds</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span class="entity"><span>priority</span></span><span class="main"><span>,</span></span><span class="entity"><span>pattern</span></span><span class="main"><span>,</span></span><span class="entity"><span>blacklist</span></span><span class="main"><span>,</span></span><span class="entity"><span>guard</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="entity"><span>intro_reasoner</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="entity"><span>priority</span></span><span> </span><span class="entity"><span>pattern</span></span><span> </span><span class="entity"><span>blacklist</span></span><span> </span><span class="entity"><span>guard</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rules</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>attr_add_intro</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>priority</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>additional_rules</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>action</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pattern</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>blacklist</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>guard</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Thm.declaration_attribute</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rule</span></span><span>::</span><span class="entity"><span>additional_rules</span></span><span class="main"><span>)</span></span><span>
                   </span><span>|&gt;</span><span> </span><span>is_some</span><span> </span><span class="entity"><span>action</span></span><span> </span><span>?</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                        </span><span class="entity"><span>th</span></span><span> </span><span>RS</span><span> </span><span class="main"><span>(</span></span><span>Thm.instantiate</span><span> </span><span class="main"><span>(</span></span><span>TVars.empty</span><span class="main"><span>,</span></span><span>
                                                </span><span>Vars.make</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"A"</span></span><span class="main"><span>,</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Phi_Logic_Programming_Reasoner.Phi_Logic_Programming_Reasoner.html#Phi_Logic_Programming_Reasoner.action|type"><span>action</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>the</span><span> </span><span class="entity"><span>action</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                                  </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Phi_Logic_Programming_Reasoner.Phi_Logic_Programming_Reasoner.html#Phi_Logic_Programming_Reasoner.Action_Tag_I|fact"><span>Action_Tag_I</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>add_intro_rule</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="entity"><span>priority</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pattern</span></span><span class="main"><span>,</span></span><span class="entity"><span>blacklist</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>guard</span></span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>



</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Theory.setup</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Attrib.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Phi_Logic_Programming_Reasoner.\&lt;phi&gt;reason|attribute"><span>φreason</span></span><span>›</span></span></span><span>
</span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Args</span><span> </span><span>Scan</span><span> </span><span>Parse</span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>read_term_mode</span></span><span> </span><span class="entity"><span>mode'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax.read_term</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.set_mode</span><span> </span><span class="entity"><span>mode'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tm</span></span><span>
 </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>read_term_pattern</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>read_term_mode</span></span><span> </span><span>Proof_Context.mode_pattern</span><span>
 </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>term_pattern</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.peek</span><span> </span><span class="main"><span>(</span></span><span>named_term</span><span> </span><span>o</span><span> </span><span class="entity"><span>read_term_pattern</span></span><span> </span><span>o</span><span> </span><span>Context.proof_of</span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>read_prop_mode</span></span><span> </span><span class="entity"><span>mode'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax.read_prop</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.set_mode</span><span> </span><span class="entity"><span>mode'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tm</span></span><span>
 </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>read_prop_pattern</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>read_prop_mode</span></span><span> </span><span>Proof_Context.mode_pattern</span><span>
 </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prop_pattern</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.peek</span><span> </span><span class="main"><span>(</span></span><span>named_term</span><span> </span><span>o</span><span> </span><span class="entity"><span>read_prop_pattern</span></span><span> </span><span>o</span><span> </span><span>Context.proof_of</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cterm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>toks</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>term</span></span><span class="main"><span>,</span></span><span class="entity"><span>ret</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>term_pattern</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>toks</span></span><span class="main"><span>)</span></span><span>
                           </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span>Context.cases</span><span> </span><span>Thm.global_cterm_of</span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>term</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ret</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
 </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pos_parser</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Reasoner_Helpers.pos_parser</span></span><span> </span><span class="inner_quoted"><span>"φreasoner"</span></span><span>
 </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ML_guard</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>depend</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt0</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>ML_source</span><span> </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>src</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Context.Proof</span><span> </span><span class="main"><span>(</span></span><span>Context.proof_of</span><span> </span><span class="entity"><span>ctxt0</span></span><span class="main"><span>)</span></span><span>
            </span><span>|&gt;</span><span> </span><span>ML_Context.expression</span><span> </span><span class="main"><span>(</span></span><span>Input.pos_of</span><span> </span><span class="entity"><span>src</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>(</span></span><span>ML_Lex.read</span><span> </span><span class="inner_quoted"><span>"Theory.local_setup (PLP_Reasoner_Guard_Parse_Sender_Qiyuan_Xu.put ("</span></span><span> </span><span>@</span><span>
               </span><span>ML_Lex.read_source</span><span> </span><span class="entity"><span>src</span></span><span> </span><span>@</span><span>
               </span><span>ML_Lex.read</span><span> </span><span class="inner_quoted"><span>"))"</span></span><span class="main"><span>)</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt0</span></span><span class="main"><span>,</span></span><span> </span><span>PLP_Reasoner_Guard_Parse_Sender_Qiyuan_Xu.get</span><span> </span><span class="main"><span>(</span></span><span>Context.the_proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
     </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
 </span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>priority</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.lift</span><span> </span><span class="main"><span>(</span></span><span>Scan.option</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>(</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Parse.int</span><span> </span><span>--|</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>)</span></span><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
  </span><span class="main"><span>(</span></span><span>lift</span><span> </span><span class="entity"><span>pos_parser</span></span><span>
  </span><span>--</span><span> </span><span>lift</span><span> </span><span class="main"><span>(</span></span><span>option</span><span> </span><span>add</span><span> </span><span>|--</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>!</span></span><span>›</span></span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="inner_numeral"><span>2000000</span></span><span class="main"><span>)</span></span><span> </span><span>||</span><span> </span><span>optional</span><span> </span><span>Parse.int</span><span> </span><span class="inner_numeral"><span>100</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span>--</span><span> </span><span class="entity"><span>Attrib.thms</span></span><span>
  </span><span>--</span><span> </span><span>option</span><span> </span><span class="main"><span>(</span></span><span>lift</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>for</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"action"</span></span><span class="main"><span>)</span></span><span> </span><span>|--</span><span> </span><span class="entity"><span>cterm</span></span><span class="main"><span>)</span></span><span>
  </span><span>--</span><span> </span><span class="main"><span>(</span></span><span> </span><span>optional</span><span> </span><span class="main"><span>(</span></span><span>lift</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>for</span></span><span>›</span></span></span><span class="main"><span>)</span></span><span> </span><span>|--</span><span> </span><span>Scan.repeat</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prop_pattern</span></span><span> </span><span>--</span><span> </span><span class="entity"><span>priority</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
    </span><span>--</span><span> </span><span>optional</span><span> </span><span class="main"><span>(</span></span><span>lift</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>except</span></span><span>›</span></span></span><span class="main"><span>)</span></span><span> </span><span>|--</span><span> </span><span>Scan.repeat</span><span> </span><span class="entity"><span>prop_pattern</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span>--</span><span> </span><span>option</span><span> </span><span class="main"><span>(</span></span><span>lift</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>if</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span class="entity"><span>ML_guard</span></span><span class="main"><span>)</span></span><span>
  </span><span>&gt;&gt;</span><span> </span><span class="entity"><span>attr_add_intro</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
</span><span class="inner_quoted"><span>"Decalre or remove introduction rules in φ-LPR."</span></span><span>

</span><span>#&gt;</span><span> </span><span class="entity"><span>Method.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Phi_Logic_Programming_Reasoner.\&lt;phi&gt;reason|method"><span>φreason</span></span><span>›</span></span></span><span>
</span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Scan</span><span> </span><span>Parse</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
 </span><span> </span><span>Scan.lift</span><span> </span><span class="main"><span>(</span></span><span>Scan.option</span><span> </span><span>Parse.nat</span><span class="main"><span>)</span></span><span> </span><span>--|</span><span>
  </span><span class="entity"><span>Method.sections</span></span><span> </span><span class="main"><span>[</span></span><span>
    </span><span>Parse.position</span><span> </span><span>Args.add</span><span> </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
               </span><span class="entity"><span>Method.modifier</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>attr_add_intro</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span class="inner_numeral"><span>100</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span class="main"><span>)</span></span><span>
</span><span class="main"><span>]</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>num_prems</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ths</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>reason_tac</span></span><span> </span><span class="entity"><span>num_prems</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
</span><span class="inner_quoted"><span>"Apply φ-LPR as a proof method."</span></span><span>

</span><span class="main"><span>)</span></span><span>



</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span></pre>
</body>

</html>