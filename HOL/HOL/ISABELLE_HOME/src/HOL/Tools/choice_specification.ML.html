<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Tools/choice_specification.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Tools/choice_specification.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      HOL/Tools/choice_specification.ML
    Author:     Sebastian Skalberg, TU Muenchen

Package for defining constants by specification.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>CHOICE_SPECIFICATION</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> close_form </span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_specification</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>bstring</span><span> * </span><span>xstring</span><span> * </span><span>bool</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> * </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> * </span><span>thm</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Choice_Specification</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>CHOICE_SPECIFICATION</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_definitional</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>arg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>arg</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk_definitional</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>thname</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cname</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>covld</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>cos</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thy</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.concl_of</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.Ex|const"><span>Ex</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>P</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctype</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>domain_type</span><span> </span><span class="main"><span>(</span></span><span>type_of</span><span> </span><span class="entity"><span>P</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cname_full</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Sign.intern_const</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>cname</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cdefname</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>thname</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Thm.def_name</span><span> </span><span class="main"><span>(</span></span><span>Long_Name.base_name</span><span> </span><span class="entity"><span>cname</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>thname</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>def_eq</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span>Logic.mk_equals</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cname_full</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctype</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>HOLogic.choice_const</span></span><span> </span><span class="entity"><span>ctype</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>P</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span>Global_Theory.add_defs</span><span> </span><span class="entity"><span>covld</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="entity"><span>cdefname</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>def_eq</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>thy</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>thm</span></span><span class="main"><span>,</span></span><span>hd</span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>]</span></span><span> </span><span>MRS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../Hilbert_Choice.html#Hilbert_Choice.exE_some|fact"><span>exE_some</span></a><span class="antiquote"><span>}</span></span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="entity"><span>mk_definitional</span></span><span> </span><span class="entity"><span>cos</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thy'</span></span><span class="main"><span>,</span></span><span class="entity"><span>thm'</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Bad specification theorem"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>thm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_specification</span></span><span> </span><span class="entity"><span>cos</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>mk_definitional</span></span><span> </span><span class="entity"><span>cos</span></span><span> </span><span>#&gt;</span><span> </span><span>apsnd</span><span> </span><span>Drule.export_without_context</span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(* Collect all intances of constants in term *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>collect_consts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tms</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>collect_consts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>collect_consts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>collect_consts</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tms</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>collect_consts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tms</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>collect_consts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tm</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tms</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>insert</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconv</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="entity"><span>tms</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>collect_consts</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tms</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tms</span></span><span>


</span><span class="comment1"><span>(* Complementing Type.varify_global... *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unvarify_global</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>fmap</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fmap'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>Library.swap</span><span> </span><span class="entity"><span>fmap</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unthaw</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fmap'</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>TVar</span><span> </span><span class="entity"><span>f</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>TFree</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>map_types</span><span> </span><span class="main"><span>(</span></span><span>map_type_tvar</span><span> </span><span class="entity"><span>unthaw</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(* The syntactic meddling needed to setup add_specification for work *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>close_form</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>HOLogic.mk_all</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>dest_Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Misc_Legacy.term_frees</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>zip3</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>zip3</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span>::</span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>y</span></span><span>::</span><span class="entity"><span>ys</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>z</span></span><span>::</span><span class="entity"><span>zs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span class="entity"><span>y</span></span><span class="main"><span>,</span></span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>zip3</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="entity"><span>ys</span></span><span> </span><span class="entity"><span>zs</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>zip3</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"Choice_Specification.process_spec internal error"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>myfoldr</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>x</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>x</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>myfoldr</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span>::</span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span class="entity"><span>myfoldr</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>myfoldr</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"Choice_Specification.process_spec internal error"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>process_spec</span></span><span> </span><span class="entity"><span>cos</span></span><span> </span><span class="entity"><span>alt_props</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.init_global</span><span> </span><span class="entity"><span>thy</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rew_imps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>alt_props</span></span><span> </span><span>|&gt;</span><span>
      </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Object_Logic.atomize</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>o</span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>o</span><span> </span><span>Syntax.read_prop_global</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>props'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rew_imps</span></span><span> </span><span>|&gt;</span><span>
      </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span>o</span><span> </span><span>Thm.term_of</span><span> </span><span>o</span><span> </span><span>snd</span><span> </span><span>o</span><span> </span><span>Thm.dest_equals</span><span> </span><span>o</span><span> </span><span>Thm.cprop_of</span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>proc_single</span></span><span> </span><span class="entity"><span>prop</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>frees</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Misc_Legacy.term_frees</span></span><span> </span><span class="entity"><span>prop</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Sign.of_sort</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span>type_of</span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">sort</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.type|class"><span>type</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>frees</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Specificaton: Only free variables of sort 'type' allowed"</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prop_closed</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>close_form</span></span><span> </span><span class="entity"><span>prop</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prop_closed</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>frees</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>props''</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>proc_single</span></span><span> </span><span class="entity"><span>props'</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>frees</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>snd</span><span> </span><span class="entity"><span>props''</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prop</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>myfoldr</span></span><span> </span><span class="entity"><span>HOLogic.mk_conj</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>props''</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vmap</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prop_thawed</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Type.varify_global</span><span> </span><span>TFrees.empty</span><span> </span><span class="entity"><span>prop</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thawed_prop_consts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>collect_consts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prop_thawed</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>altcos</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>overloaded</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>split_list</span><span> </span><span class="entity"><span>cos</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>names</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sconsts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>split_list</span><span> </span><span class="entity"><span>altcos</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>consts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Syntax.read_term_global</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sconsts</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>Library.exists</span><span> </span><span class="main"><span>(</span></span><span>not</span><span> </span><span>o</span><span> </span><span>Term.is_Const</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>consts</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Specification: Non-constant found as parameter"</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>proc_const</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Type.varify_global</span><span> </span><span>TFrees.empty</span><span> </span><span class="entity"><span>c</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cname</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctyp</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>dest_Const</span><span> </span><span class="entity"><span>c'</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>dest_Const</span><span> </span><span class="entity"><span>t</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cname</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>Sign.typ_equiv</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>typ</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctyp</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thawed_prop_consts</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Specification: No suitable instances of constant \""</span></span><span> </span><span>^</span><span>
              </span><span>Syntax.string_of_term_global</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"\" found"</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>cf</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>unvarify_global</span></span><span> </span><span class="entity"><span>cf</span></span><span> </span><span class="entity"><span>vmap</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Specification: Several variations of \""</span></span><span> </span><span>^</span><span>
            </span><span>Syntax.string_of_term_global</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"\" found (try applying explicit type constraints)"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>proc_consts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>proc_const</span></span><span> </span><span class="entity"><span>consts</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_exist</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="entity"><span>prop</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>type_of</span><span> </span><span class="entity"><span>c</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cname</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Long_Name.base_name</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="main"><span>(</span></span><span>dest_Const</span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vname</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Symbol_Pos.is_identifier</span><span> </span><span class="entity"><span>cname</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>cname</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_quoted"><span>"x"</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>HOLogic.exists_const</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span class="main"><span>(</span></span><span class="entity"><span>vname</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span>Term.abstract_over</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prop</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ex_prop</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span class="entity"><span>mk_exist</span></span><span> </span><span class="entity"><span>proc_consts</span></span><span> </span><span class="entity"><span>prop</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cnames</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span>dest_Const</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>proc_consts</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>post_process</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arg</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thy</span></span><span class="main"><span>,</span></span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>inst_all</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cv</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.global_cterm_of</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>v</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.ctyp_of_cterm</span><span> </span><span class="entity"><span>cv</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>spec'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.instantiate'</span><span> </span><span class="main"><span>[</span></span><span>SOME</span><span> </span><span class="entity"><span>cT</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>cv</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>spec</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>spec'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>remove_alls</span></span><span> </span><span class="entity"><span>frees</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inst_all</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>frees</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>process_single</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>atts</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rew_imp</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>frees</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>undo_imps</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.equal_elim</span><span> </span><span class="main"><span>(</span></span><span>Thm.symmetric</span><span> </span><span class="entity"><span>rew_imp</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span>

            </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_final</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span>writeln</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"  "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>name</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>": "</span></span><span> </span><span>^</span><span> </span><span>Thm.string_of_thm_global</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
                </span><span>Global_Theory.store_thm</span><span> </span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span>swap</span><span> </span><span class="entity"><span>args</span></span><span>
            </span><span>|&gt;</span><span> </span><span class="entity"><span>remove_alls</span></span><span> </span><span class="entity"><span>frees</span></span><span>
            </span><span>|&gt;</span><span> </span><span>apfst</span><span> </span><span class="entity"><span>undo_imps</span></span><span>
            </span><span>|&gt;</span><span> </span><span>apfst</span><span> </span><span>Drule.export_without_context</span><span>
            </span><span>|-&gt;</span><span> </span><span>Thm.theory_attributes</span><span>
              </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Attrib.attribute_cmd_global</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span>
                </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="../../../../HOL.html#HOL.nitpick_choice_spec|attribute"><span class="operator"><span>nitpick_choice_spec</span></span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span>@</span><span> </span><span class="entity"><span>atts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span>|&gt;</span><span> </span><span class="entity"><span>add_final</span></span><span>
            </span><span>|&gt;</span><span> </span><span>swap</span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>process_all</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>proc_arg</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="entity"><span>process_single</span></span><span> </span><span class="entity"><span>proc_arg</span></span><span> </span><span class="entity"><span>args</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>process_all</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>proc_arg</span></span><span>::</span><span class="entity"><span>rest</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thy</span></span><span class="main"><span>,</span></span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>single_th</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>conjunct1</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rest_th</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>conjunct2</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thy'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>process_single</span></span><span> </span><span class="entity"><span>proc_arg</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thy</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>single_th</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>process_all</span></span><span> </span><span class="entity"><span>rest</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thy'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rest_th</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>process_all</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"Choice_Specification.process_spec internal error"</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>alt_names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>alt_props</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>alt_names</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>writeln</span><span> </span><span class="inner_quoted"><span>"specification"</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>arg</span></span><span>
        </span><span>|&gt;</span><span> </span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>Thm.unvarify_global</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="entity"><span>process_all</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>zip3</span></span><span> </span><span class="entity"><span>alt_names</span></span><span> </span><span class="entity"><span>rew_imps</span></span><span> </span><span class="entity"><span>frees</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>after_qed</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span class="entity"><span>thm</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.background_theory</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>post_process</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_specification</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>zip3</span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="entity"><span>cnames</span></span><span> </span><span class="entity"><span>overloaded</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thy</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>thy</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Proof_Context.init_global</span><span>
    </span><span>|&gt;</span><span> </span><span>Variable.declare_term</span><span> </span><span class="entity"><span>ex_prop</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>Proof.theorem</span></span><span> </span><span>NONE</span><span> </span><span class="entity"><span>after_qed</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="entity"><span>ex_prop</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(* outer syntax *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>opt_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span>Parse.name</span><span> </span><span>--|</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>:</span></span><span>›</span></span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>opt_overloaded</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Parse.opt_keyword</span><span> </span><span class="inner_quoted"><span>"overloaded"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Outer_Syntax.command</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword1"><span>specification</span></span><span>›</span></span></span><span> </span><span class="inner_quoted"><span>"define constants by specification"</span></span><span>
    </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>(</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Scan.repeat1</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>opt_name</span></span><span> </span><span>--</span><span> </span><span>Parse.term</span><span> </span><span>--</span><span> </span><span class="entity"><span>opt_overloaded</span></span><span class="main"><span>)</span></span><span> </span><span>--|</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>)</span></span><span>›</span></span></span><span> </span><span>--</span><span>
      </span><span>Scan.repeat1</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>Parse_Spec.opt_thm_name</span></span><span> </span><span class="inner_quoted"><span>":"</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>apfst</span><span> </span><span>Binding.name_of</span><span class="main"><span>)</span></span><span> </span><span>--</span><span> </span><span>Parse.prop</span><span class="main"><span>)</span></span><span>
      </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cos</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>alt_props</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Toplevel.theory_to_proof</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>process_spec</span></span><span> </span><span class="entity"><span>cos</span></span><span> </span><span class="entity"><span>alt_props</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span></pre>
</body>

</html>