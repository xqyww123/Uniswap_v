<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Tools/SMT/z3_proof.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Tools/SMT/z3_proof.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      HOL/Tools/SMT/z3_proof.ML
    Author:     Sascha Boehme, TU Muenchen

Z3 proofs: parsing and abstract syntax tree.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>Z3_PROOF</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="comment1"><span>(*proof rules*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>z3_rule</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>True_Axiom</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Asserted</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Goal</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Modus_Ponens</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Reflexivity</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Symmetry</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Transitivity</span></span><span> </span><span class="main"><span>|</span></span><span>
    </span><span class="entity"><span>Transitivity_Star</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Monotonicity</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Quant_Intro</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Distributivity</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>And_Elim</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Not_Or_Elim</span></span><span> </span><span class="main"><span>|</span></span><span>
    </span><span class="entity"><span>Rewrite</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Rewrite_Star</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Pull_Quant</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Pull_Quant_Star</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Push_Quant</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Elim_Unused_Vars</span></span><span> </span><span class="main"><span>|</span></span><span>
    </span><span class="entity"><span>Dest_Eq_Res</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Quant_Inst</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Hypothesis</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Lemma</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Unit_Resolution</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Iff_True</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Iff_False</span></span><span> </span><span class="main"><span>|</span></span><span>
    </span><span class="entity"><span>Commutativity</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Def_Axiom</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Intro_Def</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Apply_Def</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Iff_Oeq</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Nnf_Pos</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Nnf_Neg</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Nnf_Star</span></span><span> </span><span class="main"><span>|</span></span><span>
    </span><span class="entity"><span>Cnf_Star</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Skolemize</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Modus_Ponens_Oeq</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Th_Lemma</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> string

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> is_assumption</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>z3_rule</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> string_of_rule</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>z3_rule</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span>

  </span><span class="comment1"><span>(*proofs*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>z3_step</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Z3_Step</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>{</span></span><span>
    id</span><span class="main"><span>:</span></span><span> int</span><span class="main"><span>,</span></span><span>
    rule</span><span class="main"><span>:</span></span><span> z3_rule</span><span class="main"><span>,</span></span><span>
    prems</span><span class="main"><span>:</span></span><span> int list</span><span class="main"><span>,</span></span><span>
    concl</span><span class="main"><span>:</span></span><span> term</span><span class="main"><span>,</span></span><span>
    fixes</span><span class="main"><span>:</span></span><span> string list</span><span class="main"><span>,</span></span><span>
    is_fix_step</span><span class="main"><span>:</span></span><span> bool</span><span class="main"><span>}</span></span><span>

  </span><span class="comment1"><span>(*proof parser*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> parse</span><span class="main"><span>:</span></span><span> </span><span>typ</span><span> </span><span>Symtab.table</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>Symtab.table</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>z3_step</span></span><span> </span><span>list</span><span> * </span><span class="entity"><span>Proof.context</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Z3_Proof</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Z3_PROOF</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>SMTLIB_Proof</span><span>


</span><span class="comment1"><span>(* proof rules *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>z3_rule</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>True_Axiom</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Asserted</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Goal</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Modus_Ponens</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Reflexivity</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Symmetry</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Transitivity</span></span><span> </span><span class="main"><span>|</span></span><span>
  </span><span class="entity"><span>Transitivity_Star</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Monotonicity</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Quant_Intro</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Distributivity</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>And_Elim</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Not_Or_Elim</span></span><span> </span><span class="main"><span>|</span></span><span>
  </span><span class="entity"><span>Rewrite</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Rewrite_Star</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Pull_Quant</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Pull_Quant_Star</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Push_Quant</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Elim_Unused_Vars</span></span><span> </span><span class="main"><span>|</span></span><span>
  </span><span class="entity"><span>Dest_Eq_Res</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Quant_Inst</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Hypothesis</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Lemma</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Unit_Resolution</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Iff_True</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Iff_False</span></span><span> </span><span class="main"><span>|</span></span><span>
  </span><span class="entity"><span>Commutativity</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Def_Axiom</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Intro_Def</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Apply_Def</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Iff_Oeq</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Nnf_Pos</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Nnf_Neg</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Nnf_Star</span></span><span> </span><span class="main"><span>|</span></span><span>
  </span><span class="entity"><span>Cnf_Star</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Skolemize</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Modus_Ponens_Oeq</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Th_Lemma</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> string
  </span><span class="comment1"><span>(* some proof rules include further information that is currently dropped by the parser *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rule_names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.make</span><span> </span><span class="main"><span>[</span></span><span>
  </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"true-axiom"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>True_Axiom</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"asserted"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Asserted</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"goal"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Goal</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"mp"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Modus_Ponens</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"refl"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Reflexivity</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"symm"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Symmetry</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"trans"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Transitivity</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"trans*"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Transitivity_Star</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"monotonicity"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Monotonicity</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"quant-intro"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Quant_Intro</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"distributivity"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Distributivity</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"and-elim"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>And_Elim</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"not-or-elim"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Not_Or_Elim</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"rewrite"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Rewrite</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"rewrite*"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Rewrite_Star</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"pull-quant"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Pull_Quant</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"pull-quant*"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Pull_Quant_Star</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"push-quant"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Push_Quant</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"elim-unused"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Elim_Unused_Vars</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"der"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Dest_Eq_Res</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"quant-inst"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Quant_Inst</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"hypothesis"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Hypothesis</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"lemma"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Lemma</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"unit-resolution"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Unit_Resolution</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"iff-true"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Iff_True</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"iff-false"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Iff_False</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"commutativity"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Commutativity</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"def-axiom"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Def_Axiom</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"intro-def"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Intro_Def</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"apply-def"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Apply_Def</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"iff~"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Iff_Oeq</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"nnf-pos"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Nnf_Pos</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"nnf-neg"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Nnf_Neg</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"nnf*"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Nnf_Star</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"cnf*"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Cnf_Star</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"sk"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Skolemize</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"mp~"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Modus_Ponens_Oeq</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_assumption</span></span><span> </span><span class="entity"><span>Asserted</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_assumption</span></span><span> </span><span class="entity"><span>Goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_assumption</span></span><span> </span><span class="entity"><span>Hypothesis</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_assumption</span></span><span> </span><span class="entity"><span>Intro_Def</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_assumption</span></span><span> </span><span class="entity"><span>Skolemize</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_assumption</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rule_of_string</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Symtab.lookup</span><span> </span><span class="entity"><span>rule_names</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>rule</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"unknown Z3 proof rule "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>string_of_rule</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Th_Lemma</span></span><span> </span><span class="entity"><span>kind</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"th-lemma"</span></span><span> </span><span>^</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>kind</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_quoted"><span>" "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>kind</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>string_of_rule</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>eq_rule</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>r'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>the</span><span> </span><span class="main"><span>(</span></span><span>Symtab.get_first</span><span> </span><span class="entity"><span>eq_rule</span></span><span> </span><span class="entity"><span>rule_names</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(* proofs *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>z3_node</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Z3_Node</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>{</span></span><span>
  id</span><span class="main"><span>:</span></span><span> int</span><span class="main"><span>,</span></span><span>
  rule</span><span class="main"><span>:</span></span><span> z3_rule</span><span class="main"><span>,</span></span><span>
  prems</span><span class="main"><span>:</span></span><span> z3_node list</span><span class="main"><span>,</span></span><span>
  concl</span><span class="main"><span>:</span></span><span> term</span><span class="main"><span>,</span></span><span>
  bounds</span><span class="main"><span>:</span></span><span> string list</span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_node</span></span><span> </span><span class="entity"><span>id</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Z3_Node</span></span><span> </span><span class="main"><span>{</span></span><span>id</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span>rule</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span> </span><span>prems</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span> </span><span>concl</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>,</span></span><span> </span><span>bounds</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>bounds</span></span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>string_of_node</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>str</span></span><span> </span><span class="entity"><span>depth</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Z3_Node</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bounds</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>replicate_string</span><span> </span><span class="entity"><span>depth</span></span><span> </span><span class="inner_quoted"><span>"  "</span></span><span> </span><span>^</span><span>
      </span><span>enclose</span><span> </span><span class="inner_quoted"><span>"{"</span></span><span> </span><span class="inner_quoted"><span>"}"</span></span><span> </span><span class="main"><span>(</span></span><span>commas</span><span>
        </span><span class="main"><span>[</span></span><span>string_of_int</span><span> </span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span>
         </span><span class="entity"><span>string_of_rule</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span>
         </span><span>enclose</span><span> </span><span class="inner_quoted"><span>"["</span></span><span> </span><span class="inner_quoted"><span>"]"</span></span><span> </span><span class="main"><span>(</span></span><span>space_implode</span><span> </span><span class="inner_quoted"><span>" "</span></span><span> </span><span class="entity"><span>bounds</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
         </span><span>Syntax.string_of_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>]</span></span><span> </span><span>^</span><span>
        </span><span>cat_lines</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>prefix</span><span> </span><span class="inner_quoted"><span>"\n"</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>str</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>depth</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>str</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>z3_step</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Z3_Step</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>{</span></span><span>
  id</span><span class="main"><span>:</span></span><span> int</span><span class="main"><span>,</span></span><span>
  rule</span><span class="main"><span>:</span></span><span> z3_rule</span><span class="main"><span>,</span></span><span>
  prems</span><span class="main"><span>:</span></span><span> int list</span><span class="main"><span>,</span></span><span>
  concl</span><span class="main"><span>:</span></span><span> term</span><span class="main"><span>,</span></span><span>
  fixes</span><span class="main"><span>:</span></span><span> string list</span><span class="main"><span>,</span></span><span>
  is_fix_step</span><span class="main"><span>:</span></span><span> bool</span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_step</span></span><span> </span><span class="entity"><span>id</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span class="entity"><span>is_fix_step</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Z3_Step</span></span><span> </span><span class="main"><span>{</span></span><span>id</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span>rule</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span> </span><span>prems</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span> </span><span>concl</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>,</span></span><span> </span><span>fixes</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fixes</span></span><span class="main"><span>,</span></span><span>
    </span><span>is_fix_step</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>is_fix_step</span></span><span class="main"><span>}</span></span><span>


</span><span class="comment1"><span>(* proof parser *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rule_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rule_of_string</span></span><span> </span><span class="entity"><span>name</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rule_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"_"</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"th-lemma"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="entity"><span>kind</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Th_Lemma</span></span><span> </span><span class="entity"><span>kind</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>rule_of_string</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rule_of</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SMTLIB_PARSE</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"bad Z3 proof rule format"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>node_of</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>lookup_binding</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="entity"><span>Proof</span></span><span> </span><span class="entity"><span>node</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>node</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Tree</span></span><span> </span><span class="entity"><span>p'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="entity"><span>cx</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>node_of</span></span><span> </span><span class="entity"><span>p'</span></span><span>
          </span><span>|-&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>node</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>pair</span><span> </span><span class="entity"><span>node</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>update_binding</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Proof</span></span><span> </span><span class="entity"><span>node</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SMTLIB_PARSE</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"bad Z3 proof format"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"let"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="entity"><span>bindings</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="entity"><span>with_bindings</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>dest_binding</span></span><span> </span><span class="entity"><span>bindings</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>node_of</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>parts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>split_last</span><span> </span><span class="entity"><span>parts</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rule_of</span></span><span> </span><span class="entity"><span>name</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>cx</span></span><span>
        </span><span>|&gt;</span><span> </span><span>fold_map</span><span> </span><span class="entity"><span>node_of</span></span><span> </span><span class="entity"><span>ps</span></span><span>
        </span><span>||&gt;&gt;</span><span> </span><span>`</span><span class="main"><span>(</span></span><span class="entity"><span>with_fresh_names</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>term_of</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span>||&gt;&gt;</span><span> </span><span class="entity"><span>next_id</span></span><span>
        </span><span>|&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ns</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>id</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>mk_node</span></span><span> </span><span class="entity"><span>id</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>ns</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SMTLIB_PARSE</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"bad Z3 proof format"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_name</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>name</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dest_name</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SMTLIB_PARSE</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"bad name"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_seq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ts</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dest_seq</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SMTLIB_PARSE</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"bad Z3 proof format"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parse'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"set-logic"</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parse'</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="entity"><span>cx</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>parse'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"declare-fun"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>]</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_name</span></span><span> </span><span class="entity"><span>n</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>type_of</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest_seq</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>type_of</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="entity"><span>ty</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>parse'</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>declare_fun</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ts</span></span><span> </span><span>---&gt;</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>parse'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"proof"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>]</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>node_of</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>cx</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>parse'</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SMTLIB_PARSE</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"bad Z3 proof declarations"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parse_proof</span></span><span> </span><span class="entity"><span>typs</span></span><span> </span><span class="entity"><span>funs</span></span><span> </span><span class="entity"><span>lines</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_seq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.parse</span></span><span> </span><span class="entity"><span>lines</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>node</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parse'</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>empty_context</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>typs</span></span><span> </span><span class="entity"><span>funs</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>node</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt_of</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>SMTLIB.PARSE</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>msg</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"parsing error at line "</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>l</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>": "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>msg</span></span><span class="main"><span>)</span></span><span>
       </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>SMTLIB_PARSE</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>msg</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>msg</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>": "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>SMTLIB.str_of</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>


</span><span class="comment1"><span>(* handling of bound variables *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>subst_of</span></span><span> </span><span class="entity"><span>tyenv</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ix</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>S</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>cons</span><span> </span><span class="main"><span>(</span></span><span>TVar</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ix</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Vartab.fold</span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="entity"><span>tyenv</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>substTs_same</span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>applyT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Same.function</span><span> </span><span class="main"><span>(</span></span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>subst</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Term_Subst.map_atypsT_same</span><span> </span><span class="entity"><span>applyT</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>subst_types</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>match</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Sign.typ_match</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>objT_of</span></span><span> </span><span class="entity"><span>bound</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Symtab.lookup</span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="entity"><span>bound</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>SOME</span><span> </span><span class="entity"><span>objT</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>objT</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Replaying the proof trace produced by Z3 failed: "</span></span><span> </span><span>^</span><span>
          </span><span class="inner_quoted"><span>"the bound "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>bound</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" is undeclared; this indicates a bug in Z3"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Variable.polymorphic</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>patTs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>snd</span><span> </span><span class="main"><span>(</span></span><span>Term.strip_qnt_vars</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.all</span><span>›</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>objTs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>objT_of</span></span><span> </span><span class="entity"><span>bounds</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>subst_of</span></span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="entity"><span>match</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>patTs</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>objTs</span></span><span class="main"><span>)</span></span><span> </span><span>Vartab.empty</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Same.commit</span><span> </span><span class="main"><span>(</span></span><span>Term_Subst.map_types_same</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>substTs_same</span></span><span> </span><span class="entity"><span>subst</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>eq_quant</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.All|const"><span>HOL.All</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.All|const"><span>HOL.All</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>eq_quant</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Ex|const"><span>HOL.Ex</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Ex|const"><span>HOL.Ex</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>eq_quant</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>opp_quant</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.All|const"><span>HOL.All</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Ex|const"><span>HOL.Ex</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>opp_quant</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Ex|const"><span>HOL.Ex</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.All|const"><span>HOL.All</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>opp_quant</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>with_quant</span></span><span> </span><span class="entity"><span>pred</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="entity"><span>q1</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Const</span><span> </span><span class="entity"><span>q2</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>pred</span></span><span> </span><span class="entity"><span>q1</span></span><span> </span><span class="entity"><span>q2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T1</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>apply2</span><span> </span><span>Term.subst_bound</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>with_quant</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_quant_pair</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>HOL.Not</span></a><span>›</span></span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span class="entity"><span>HOLogic.mk_not</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>with_quant</span></span><span> </span><span class="entity"><span>opp_quant</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dest_quant_pair</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>with_quant</span></span><span> </span><span class="entity"><span>eq_quant</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_quant</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>dest_quant_pair</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.dest_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"lift_quant"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>match_types</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>pat</span></span><span> </span><span class="entity"><span>obj</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span>Vartab.empty</span><span class="main"><span>,</span></span><span> </span><span>Vartab.empty</span><span class="main"><span>)</span></span><span>
  </span><span>|&gt;</span><span> </span><span>Pattern.first_order_match</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pat</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>obj</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>strip_match</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>pat</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>obj</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>match_types</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>pat</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>obj</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tyenv</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>subst_of</span></span><span> </span><span class="entity"><span>tyenv</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>strip_match</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>pat</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest_quant</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>obj</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_all</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.all</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>dest_all</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Term.betapply</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dest_all</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_alls</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_all</span></span><span> </span><span class="main"><span>(</span></span><span>Term.maxidx_of_term</span><span> </span><span class="entity"><span>t</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>match_rule</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Z3_Node</span></span><span> </span><span class="main"><span>{</span></span><span>bounds</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>bs'</span></span><span class="main"><span>,</span></span><span> </span><span>concl</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t''</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Variable.polymorphic</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t'</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>obj</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_alls</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>subst_types</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>strip_match</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest_alls</span></span><span> </span><span class="entity"><span>t''</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>obj</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>applyT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Same.commit</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>substTs_same</span></span><span> </span><span class="entity"><span>subst</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>patTs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>snd</span><span> </span><span class="main"><span>(</span></span><span>Term.strip_qnt_vars</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.all</span><span>›</span></span><span> </span><span class="entity"><span>t''</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Symtab.make</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bs'</span></span><span> </span><span>~~</span><span> </span><span>map</span><span> </span><span class="entity"><span>applyT</span></span><span> </span><span class="entity"><span>patTs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(* linearizing proofs and resolving types of bound variables *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>has_step</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tab</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Inttab.defined</span><span> </span><span class="entity"><span>tab</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_step</span></span><span> </span><span class="entity"><span>id</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="entity"><span>is_fix_step</span></span><span> </span><span class="entity"><span>ids</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tab</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>step</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_step</span></span><span> </span><span class="entity"><span>id</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="entity"><span>ids</span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="entity"><span>is_fix_step</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>Inttab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tab</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>step</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>sts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_fix_rule</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Quant_Intro</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Nnf_Pos</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Nnf_Neg</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>length</span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lin_proof</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Z3_Node</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bounds</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>steps</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>has_step</span></span><span> </span><span class="entity"><span>steps</span></span><span> </span><span class="entity"><span>id</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>steps</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>subst_types</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="entity"><span>concl</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_step</span></span><span> </span><span class="entity"><span>id</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="entity"><span>t</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rec_apply</span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lin_proof</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>e</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span>#-&gt;</span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="entity"><span>b</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_fix_rule</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>match_rule</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>rec_apply</span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>steps</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>env'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>rec_apply</span></span><span> </span><span class="entity"><span>env'</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>steps</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>rec_apply</span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>steps</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>linearize</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>node</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>rev</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lin_proof</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>Symtab.empty</span><span> </span><span class="entity"><span>node</span></span><span> </span><span class="main"><span>(</span></span><span>Inttab.empty</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>


</span><span class="comment1"><span>(* overall proof parser *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parse</span></span><span> </span><span class="entity"><span>typs</span></span><span> </span><span class="entity"><span>funs</span></span><span> </span><span class="entity"><span>lines</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>node</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parse_proof</span></span><span> </span><span class="entity"><span>typs</span></span><span> </span><span class="entity"><span>funs</span></span><span> </span><span class="entity"><span>lines</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>linearize</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>node</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
</span></pre>
</body>

</html>