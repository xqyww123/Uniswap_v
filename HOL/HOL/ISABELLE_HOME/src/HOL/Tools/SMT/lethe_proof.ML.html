<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Tools/SMT/lethe_proof.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Tools/SMT/lethe_proof.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      HOL/Tools/SMT/lethe_proof.ML
    Author:     Mathias Fleury, ENS Rennes
    Author:     Sascha Boehme, TU Muenchen

Lethe proofs: parsing and abstract syntax tree.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>LETHE_PROOF</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="comment1"><span>(*proofs*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>lethe_step</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Lethe_Step</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>{</span></span><span>
    id</span><span class="main"><span>:</span></span><span> string</span><span class="main"><span>,</span></span><span>
    rule</span><span class="main"><span>:</span></span><span> string</span><span class="main"><span>,</span></span><span>
    prems</span><span class="main"><span>:</span></span><span> string list</span><span class="main"><span>,</span></span><span>
    proof_ctxt</span><span class="main"><span>:</span></span><span> term list</span><span class="main"><span>,</span></span><span>
    concl</span><span class="main"><span>:</span></span><span> term</span><span class="main"><span>,</span></span><span>
    fixes</span><span class="main"><span>:</span></span><span> string list</span><span class="main"><span>}</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>lethe_replay_node</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Lethe_Replay_Node</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>{</span></span><span>
    id</span><span class="main"><span>:</span></span><span> string</span><span class="main"><span>,</span></span><span>
    rule</span><span class="main"><span>:</span></span><span> string</span><span class="main"><span>,</span></span><span>
    args</span><span class="main"><span>:</span></span><span> term list</span><span class="main"><span>,</span></span><span>
    prems</span><span class="main"><span>:</span></span><span> string list</span><span class="main"><span>,</span></span><span>
    proof_ctxt</span><span class="main"><span>:</span></span><span> term list</span><span class="main"><span>,</span></span><span>
    concl</span><span class="main"><span>:</span></span><span> term</span><span class="main"><span>,</span></span><span>
    bounds</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string * typ</span><span class="main"><span>)</span></span><span> list</span><span class="main"><span>,</span></span><span>
    declarations</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string * term</span><span class="main"><span>)</span></span><span> list</span><span class="main"><span>,</span></span><span>
    insts</span><span class="main"><span>:</span></span><span> term Symtab.table</span><span class="main"><span>,</span></span><span>
    subproof</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string * typ</span><span class="main"><span>)</span></span><span> list * term list * term list * lethe_replay_node list</span><span class="main"><span>}</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_replay_node</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
     </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>Symtab.table</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>term</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
     </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span>term</span><span> </span><span>list</span><span> * </span><span>term</span><span> </span><span>list</span><span> * </span><span class="entity"><span>lethe_replay_node</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>lethe_replay_node</span></span><span>

  </span><span class="comment1"><span>(*proof parser*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> parse</span><span class="main"><span>:</span></span><span> </span><span>typ</span><span> </span><span>Symtab.table</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>Symtab.table</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>lethe_step</span></span><span> </span><span>list</span><span> * </span><span class="entity"><span>Proof.context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> parse_replay</span><span class="main"><span>:</span></span><span> </span><span>typ</span><span> </span><span>Symtab.table</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>Symtab.table</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>lethe_replay_node</span></span><span> </span><span>list</span><span> * </span><span class="entity"><span>Proof.context</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> step_prefix </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> input_rule</span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> keep_app_symbols</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> keep_raw_lifting</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> normalized_input_rule</span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> la_generic_rule </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> rewrite_rule </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> simp_arith_rule </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> lethe_deep_skolemize_rule </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> lethe_def </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> is_lethe_def </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> subproof_rule </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> local_input_rule </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> not_not_rule </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> contract_rule </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> ite_intro_rule </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> eq_congruent_rule </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> eq_congruent_pred_rule </span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> skolemization_steps </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> theory_resolution2_rule</span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> equiv_pos2_rule</span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> and_pos_rule</span><span class="main"><span>:</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> th_resolution_rule</span><span class="main"><span>:</span></span><span> </span><span>string</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> is_skolemization</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> is_skolemization_step</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>lethe_replay_node</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> number_of_steps</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>lethe_replay_node</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Lethe_Proof</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>LETHE_PROOF</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>SMTLIB_Proof</span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>raw_lethe_node</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Raw_Lethe_Node</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>{</span></span><span>
  id</span><span class="main"><span>:</span></span><span> string</span><span class="main"><span>,</span></span><span>
  rule</span><span class="main"><span>:</span></span><span> string</span><span class="main"><span>,</span></span><span>
  args</span><span class="main"><span>:</span></span><span> SMTLIB.tree</span><span class="main"><span>,</span></span><span>
  prems</span><span class="main"><span>:</span></span><span> string list</span><span class="main"><span>,</span></span><span>
  concl</span><span class="main"><span>:</span></span><span> SMTLIB.tree</span><span class="main"><span>,</span></span><span>
  declarations</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string * SMTLIB.tree</span><span class="main"><span>)</span></span><span> list</span><span class="main"><span>,</span></span><span>
  subproof</span><span class="main"><span>:</span></span><span> raw_lethe_node list</span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_raw_node</span></span><span> </span><span class="entity"><span>id</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="entity"><span>declarations</span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="entity"><span>subproof</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Raw_Lethe_Node</span></span><span> </span><span class="main"><span>{</span></span><span>id</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span>rule</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span> </span><span>args</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>,</span></span><span> </span><span>prems</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span> </span><span>declarations</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>declarations</span></span><span class="main"><span>,</span></span><span>
    </span><span>concl</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>,</span></span><span> </span><span>subproof</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>subproof</span></span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>lethe_node</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Lethe_Node</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>{</span></span><span>
  id</span><span class="main"><span>:</span></span><span> string</span><span class="main"><span>,</span></span><span>
  rule</span><span class="main"><span>:</span></span><span> string</span><span class="main"><span>,</span></span><span>
  prems</span><span class="main"><span>:</span></span><span> string list</span><span class="main"><span>,</span></span><span>
  proof_ctxt</span><span class="main"><span>:</span></span><span> term list</span><span class="main"><span>,</span></span><span>
  concl</span><span class="main"><span>:</span></span><span> term</span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_node</span></span><span> </span><span class="entity"><span>id</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="entity"><span>proof_ctxt</span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Lethe_Node</span></span><span> </span><span class="main"><span>{</span></span><span>id</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span>rule</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span> </span><span>prems</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span> </span><span>proof_ctxt</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>proof_ctxt</span></span><span class="main"><span>,</span></span><span> </span><span>concl</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>lethe_replay_node</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Lethe_Replay_Node</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>{</span></span><span>
  id</span><span class="main"><span>:</span></span><span> string</span><span class="main"><span>,</span></span><span>
  rule</span><span class="main"><span>:</span></span><span> string</span><span class="main"><span>,</span></span><span>
  args</span><span class="main"><span>:</span></span><span> term list</span><span class="main"><span>,</span></span><span>
  prems</span><span class="main"><span>:</span></span><span> string list</span><span class="main"><span>,</span></span><span>
  proof_ctxt</span><span class="main"><span>:</span></span><span> term list</span><span class="main"><span>,</span></span><span>
  concl</span><span class="main"><span>:</span></span><span> term</span><span class="main"><span>,</span></span><span>
  bounds</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string * typ</span><span class="main"><span>)</span></span><span> list</span><span class="main"><span>,</span></span><span>
  insts</span><span class="main"><span>:</span></span><span> term Symtab.table</span><span class="main"><span>,</span></span><span>
  declarations</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string * term</span><span class="main"><span>)</span></span><span> list</span><span class="main"><span>,</span></span><span>
  subproof</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string * typ</span><span class="main"><span>)</span></span><span> list * term list * term list * lethe_replay_node list</span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_replay_node</span></span><span> </span><span class="entity"><span>id</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="entity"><span>proof_ctxt</span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="entity"><span>insts</span></span><span> </span><span class="entity"><span>declarations</span></span><span> </span><span class="entity"><span>subproof</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Lethe_Replay_Node</span></span><span> </span><span class="main"><span>{</span></span><span>id</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span>rule</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span> </span><span>args</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>,</span></span><span> </span><span>prems</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span> </span><span>proof_ctxt</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>proof_ctxt</span></span><span class="main"><span>,</span></span><span>
    </span><span>concl</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>,</span></span><span> </span><span>bounds</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>bounds</span></span><span class="main"><span>,</span></span><span> </span><span>insts</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>insts</span></span><span class="main"><span>,</span></span><span> </span><span>declarations</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>declarations</span></span><span class="main"><span>,</span></span><span>
    </span><span>subproof</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>subproof</span></span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>lethe_step</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Lethe_Step</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>{</span></span><span>
  id</span><span class="main"><span>:</span></span><span> string</span><span class="main"><span>,</span></span><span>
  rule</span><span class="main"><span>:</span></span><span> string</span><span class="main"><span>,</span></span><span>
  prems</span><span class="main"><span>:</span></span><span> string list</span><span class="main"><span>,</span></span><span>
  proof_ctxt</span><span class="main"><span>:</span></span><span> term list</span><span class="main"><span>,</span></span><span>
  concl</span><span class="main"><span>:</span></span><span> term</span><span class="main"><span>,</span></span><span>
  fixes</span><span class="main"><span>:</span></span><span> string list</span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_step</span></span><span> </span><span class="entity"><span>id</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="entity"><span>proof_ctxt</span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Lethe_Step</span></span><span> </span><span class="main"><span>{</span></span><span>id</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span>rule</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span> </span><span>prems</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span> </span><span>proof_ctxt</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>proof_ctxt</span></span><span class="main"><span>,</span></span><span> </span><span>concl</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>,</span></span><span>
    </span><span>fixes</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fixes</span></span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>step_prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>".c"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>input_rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"input"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>la_generic_rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"la_generic"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>normalized_input_rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"__normalized_input"</span></span><span> </span><span class="comment1"><span>(*arbitrary*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rewrite_rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"__rewrite"</span></span><span> </span><span class="comment1"><span>(*arbitrary*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>subproof_rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"subproof"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>local_input_rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"__local_input"</span></span><span> </span><span class="comment1"><span>(*arbitrary*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>simp_arith_rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"simp_arith"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lethe_def</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"__skolem_definition"</span></span><span> </span><span class="comment1"><span>(*arbitrary*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>not_not_rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"not_not"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>contract_rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"contraction"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eq_congruent_pred_rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"eq_congruent_pred"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eq_congruent_rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"eq_congruent"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ite_intro_rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"ite_intro"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>default_skolem_rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"sko_forall"</span></span><span> </span><span class="comment1"><span>(*arbitrary, but must be one of the skolems*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>theory_resolution2_rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"__theory_resolution2"</span></span><span> </span><span class="comment1"><span>(*arbitrary*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>equiv_pos2_rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"equiv_pos2"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>th_resolution_rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"th_resolution"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>and_pos_rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"and_pos"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>is_lethe_def</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>String.isSuffix</span><span> </span><span class="entity"><span>lethe_def</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>skolemization_steps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"sko_forall"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"sko_ex"</span></span><span class="main"><span>]</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>is_skolemization</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>skolemization_steps</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>keep_app_symbols</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>eq_congruent_pred_rule</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eq_congruent_rule</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ite_intro_rule</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>and_pos_rule</span></span><span class="main"><span>]</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>keep_raw_lifting</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>eq_congruent_pred_rule</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eq_congruent_rule</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ite_intro_rule</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>and_pos_rule</span></span><span class="main"><span>]</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>is_SH_trivial</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>not_not_rule</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>contract_rule</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_skolemization_step</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Lethe_Replay_Node</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>is_skolemization</span></span><span> </span><span class="entity"><span>id</span></span><span>

</span><span class="comment1"><span>(* Even the lethe developers do not know if the following rule can still appear in proofs: *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lethe_deep_skolemize_rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"deep_skolemize"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>number_of_steps</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>number_of_steps</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>Lethe_Replay_Node</span></span><span> </span><span class="main"><span>{</span></span><span>subproof</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subproof</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>pf</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="inner_numeral"><span>1</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>number_of_steps</span></span><span> </span><span class="entity"><span>subproof</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>number_of_steps</span></span><span> </span><span class="entity"><span>pf</span></span><span>

</span><span class="comment1"><span>(* proof parser *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>node_of</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span>
  </span><span>||&gt;&gt;</span><span> </span><span>`</span><span class="main"><span>(</span></span><span class="entity"><span>with_fresh_names</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>term_of</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span>|&gt;&gt;</span><span> </span><span>snd</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>synctactic_var_subst</span></span><span> </span><span class="entity"><span>old_name</span></span><span> </span><span class="entity"><span>new_name</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>synctactic_var_subst</span></span><span> </span><span class="entity"><span>old_name</span></span><span> </span><span class="entity"><span>new_name</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>synctactic_var_subst</span></span><span> </span><span class="entity"><span>old_name</span></span><span> </span><span class="entity"><span>new_name</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>synctactic_var_subst</span></span><span> </span><span class="entity"><span>old_name</span></span><span> </span><span class="entity"><span>new_name</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isPrefix</span><span> </span><span class="entity"><span>old_name</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>new_name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span>
      </span><span class="entity"><span>synctactic_var_subst</span></span><span> </span><span class="entity"><span>old_name</span></span><span> </span><span class="entity"><span>new_name</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>synctactic_var_subst</span></span><span> </span><span class="entity"><span>old_name</span></span><span> </span><span class="entity"><span>new_name</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isPrefix</span><span> </span><span class="entity"><span>old_name</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>new_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>synctactic_var_subst</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>synctatic_rew_in_lhs_subst</span></span><span> </span><span class="entity"><span>old_name</span></span><span> </span><span class="entity"><span>new_name</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
     </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>synctactic_var_subst</span></span><span> </span><span class="entity"><span>old_name</span></span><span> </span><span class="entity"><span>new_name</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>synctatic_rew_in_lhs_subst</span></span><span> </span><span class="entity"><span>old_name</span></span><span> </span><span class="entity"><span>new_name</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
     </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>synctatic_rew_in_lhs_subst</span></span><span> </span><span class="entity"><span>old_name</span></span><span> </span><span class="entity"><span>new_name</span></span><span> </span><span class="entity"><span>t1</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>synctatic_rew_in_lhs_subst</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_bound_variables_to_ctxt</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>update_binding</span></span><span> </span><span>o</span><span>
    </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Term</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>type_of</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>extract_symbols</span></span><span> </span><span class="entity"><span>bds</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>bds</span></span><span>
    </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"="</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="main"><span>(</span></span><span>Fail</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"match error "</span></span><span> </span><span>^</span><span> </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>make_string</span></span><span class="antiquote"><span>}</span></span></span></span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>flat</span><span>

  </span><span class="comment1"><span>(* onepoint can bind a variable to another variable or to a constant *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>extract_qnt_symbols</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="entity"><span>bds</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>bds</span></span><span>
    </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"="</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>node_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                  </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>x</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
                </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
             </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"="</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>x</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
             </span><span class="main"><span>|</span></span><span>  </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="main"><span>(</span></span><span>Fail</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"match error "</span></span><span> </span><span>^</span><span> </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>make_string</span></span><span class="antiquote"><span>}</span></span></span></span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>flat</span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>extract_symbols_map</span></span><span> </span><span class="entity"><span>bds</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>bds</span></span><span>
    </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"="</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>x</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>flat</span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>declared_csts</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="inner_quoted"><span>"__skolem_definition"</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>declared_csts</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="inner_quoted"><span>"__skolem_definition"</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="main"><span>(</span></span><span>Fail</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"unrecognized skolem_definition "</span></span><span> </span><span>^</span><span> </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>make_string</span></span><span class="antiquote"><span>}</span></span></span></span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>declared_csts</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>skolems_introduced_by_rule</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="entity"><span>bds</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"="</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>::</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bds</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>

</span><span class="comment1"><span>(*FIXME there is probably a way to use the information given by onepoint*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>bound_vars_by_rule</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="inner_quoted"><span>"bind"</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bds</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>extract_symbols</span></span><span> </span><span class="entity"><span>bds</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>bound_vars_by_rule</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="inner_quoted"><span>"onepoint"</span></span><span> </span><span class="entity"><span>bds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>extract_qnt_symbols</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="entity"><span>bds</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>bound_vars_by_rule</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="inner_quoted"><span>"sko_forall"</span></span><span> </span><span class="entity"><span>bds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>extract_symbols_map</span></span><span> </span><span class="entity"><span>bds</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>bound_vars_by_rule</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="inner_quoted"><span>"sko_ex"</span></span><span> </span><span class="entity"><span>bds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>extract_symbols_map</span></span><span> </span><span class="entity"><span>bds</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>bound_vars_by_rule</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="inner_quoted"><span>"__skolem_definition"</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>x</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>bound_vars_by_rule</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="inner_quoted"><span>"__skolem_definition"</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>x</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>bound_vars_by_rule</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>

</span><span class="comment1"><span>(* Lethe adds "?" before some variables. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>remove_all_qm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="main"><span>(</span></span><span>perhaps</span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span class="main"><span>(</span></span><span>unprefix</span><span> </span><span class="inner_quoted"><span>"?"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>remove_all_qm</span></span><span> </span><span class="entity"><span>l</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>remove_all_qm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>l'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>remove_all_qm</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>remove_all_qm</span></span><span> </span><span class="entity"><span>l'</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>remove_all_qm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Key</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>SMTLIB.Key</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>remove_all_qm</span></span><span> </span><span class="entity"><span>l</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>remove_all_qm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>remove_all_qm</span></span><span> </span><span class="entity"><span>l</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>remove_all_qm</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>remove_all_qm2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="main"><span>(</span></span><span>perhaps</span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span class="main"><span>(</span></span><span>unprefix</span><span> </span><span class="inner_quoted"><span>"?"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>remove_all_qm2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>remove_all_qm</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>remove_all_qm2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Key</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>SMTLIB.Key</span></span><span> </span><span class="entity"><span>v</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>remove_all_qm2</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>v</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>step_kind</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ASSUME</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ANCHOR</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>NO_STEP</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>NORMAL_STEP</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>SKOLEM</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parse_raw_proof_steps</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>limit</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span>option</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ls</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>SMTLIB.tree</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>name_bindings</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>:</span></span><span>
     </span><span class="main"><span>(</span></span><span class="entity"><span>raw_lethe_node</span></span><span> </span><span>list</span><span> * </span><span class="entity"><span>SMTLIB.tree</span></span><span> </span><span>list</span><span> * </span><span class="entity"><span>name_bindings</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rotate_pair</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>step_kind</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>NO_STEP</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>step_kind</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"anchor"</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ANCHOR</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>step_kind</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"assume"</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ASSUME</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>step_kind</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"step"</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>NORMAL_STEP</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>step_kind</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"define-fun"</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SKOLEM</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>step_kind</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="main"><span>(</span></span><span>Fail</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"step_kind unrec: "</span></span><span> </span><span>^</span><span> </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>make_string</span></span><span class="antiquote"><span>}</span></span></span></span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parse_skolem</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"define-fun"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span>  </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>,</span></span><span>
           </span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"!"</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>t</span></span><span> </span><span>::</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>SMTLIB.Key</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span>
         </span><span class="comment1"><span>(*replace the name binding by the constant instead of the full term in order to reduce
           the size of the generated terms and therefore the reconstruction time*)</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>oo</span><span> </span><span class="entity"><span>SMTLIB_Proof.extract_and_update_name_bindings</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>cx</span></span><span>
            </span><span>|&gt;</span><span> </span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB_Proof.update_name_binding</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="entity"><span>id</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
           </span><span class="main"><span>(</span></span><span class="entity"><span>mk_raw_node</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>id</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>lethe_def</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lethe_def</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"="</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>parse_skolem</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"define-fun"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span>  </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>oo</span><span> </span><span class="entity"><span>SMTLIB_Proof.extract_and_update_name_bindings</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
           </span><span class="main"><span>(</span></span><span class="entity"><span>mk_raw_node</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>id</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>lethe_def</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lethe_def</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"="</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>parse_skolem</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"unrecognized Lethe proof "</span></span><span> </span><span>^</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span class="entity"><span><span class="hidden">\&lt;^</span><span class="control">make_string</span><span class="hidden">&gt;</span></span></span></span></span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_id_cx</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="entity"><span>id</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>get_id_cx</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"unrecognized Lethe proof "</span></span><span> </span><span>^</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span class="entity"><span><span class="hidden">\&lt;^</span><span class="control">make_string</span><span class="hidden">&gt;</span></span></span></span></span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_id</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="entity"><span>id</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>get_id</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"unrecognized Lethe proof "</span></span><span> </span><span>^</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span class="entity"><span><span class="hidden">\&lt;^</span><span class="control">make_string</span><span class="hidden">&gt;</span></span></span></span></span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parse_source</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Key</span></span><span> </span><span class="inner_quoted"><span>"premises"</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="entity"><span>source</span></span><span> </span><span>::</span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="entity"><span>id</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>id</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>source</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>parse_source</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parse_rule</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Key</span></span><span> </span><span class="inner_quoted"><span>"rule"</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>parse_rule</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"unrecognized Lethe proof "</span></span><span> </span><span>^</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span class="entity"><span><span class="hidden">\&lt;^</span><span class="control">make_string</span><span class="hidden">&gt;</span></span></span></span></span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parse_anchor_step</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"anchor"</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>SMTLIB.Key</span></span><span> </span><span class="inner_quoted"><span>"step"</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>parse_anchor_step</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"unrecognized Lethe proof "</span></span><span> </span><span>^</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span class="entity"><span><span class="hidden">\&lt;^</span><span class="control">make_string</span><span class="hidden">&gt;</span></span></span></span></span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parse_args</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Key</span></span><span> </span><span class="inner_quoted"><span>"args"</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>args</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>args</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>SMTLIB_Proof.extract_and_update_name_bindings</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="entity"><span>cx</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>args</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>parse_args</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parse_and_clausify_conclusion</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"cl"</span></span><span> </span><span>::</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"false"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>parse_and_clausify_conclusion</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"cl"</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>concl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>oo</span><span> </span><span class="entity"><span>SMTLIB_Proof.extract_and_update_name_bindings</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="entity"><span>cx</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"or"</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>parse_and_clausify_conclusion</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"unrecognized Lethe proof "</span></span><span> </span><span>^</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span class="entity"><span><span class="hidden">\&lt;^</span><span class="control">make_string</span><span class="hidden">&gt;</span></span></span></span></span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_normal_step</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>get_id_cx</span></span><span>
        </span><span>##&gt;</span><span> </span><span class="entity"><span>parse_and_clausify_conclusion</span></span><span>
        </span><span>#&gt;</span><span> </span><span class="entity"><span>rotate_pair</span></span><span>
        </span><span>##&gt;</span><span> </span><span class="entity"><span>parse_rule</span></span><span>
        </span><span>#&gt;</span><span> </span><span class="entity"><span>rotate_pair</span></span><span>
        </span><span>##&gt;</span><span> </span><span class="entity"><span>parse_source</span></span><span>
        </span><span>#&gt;</span><span> </span><span class="entity"><span>rotate_pair</span></span><span>
        </span><span>##&gt;</span><span> </span><span class="entity"><span>parse_args</span></span><span>
        </span><span>#&gt;</span><span> </span><span class="entity"><span>rotate_pair</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>to_raw_node</span></span><span> </span><span class="entity"><span>subproof</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>mk_raw_node</span></span><span> </span><span class="entity"><span>id</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>(</span></span><span>the_default</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="entity"><span>subproof</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>at_discharge</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>at_discharge</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>id</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>get_id</span></span><span> </span><span>|&gt;</span><span> </span><span>fst</span><span> </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>id2</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>id</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>id2</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>step_kind</span></span><span> </span><span class="entity"><span>ls</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>NO_STEP</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>NORMAL_STEP</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>at_discharge</span></span><span> </span><span class="entity"><span>limit</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
             </span><span class="comment1"><span>(*ignores content of "discharge": Isabelle is keeping track of it via the context*)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>  </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span>
                </span><span>|&gt;</span><span> </span><span class="entity"><span>parse_normal_step</span></span><span>
                </span><span>|&gt;&gt;</span><span>  </span><span class="main"><span>(</span></span><span class="entity"><span>to_raw_node</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rp</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parse_raw_proof_steps</span></span><span> </span><span class="entity"><span>limit</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="entity"><span>cx</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>rp</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ASSUME</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>::</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>p</span></span><span>
              </span><span>|&gt;</span><span> </span><span class="entity"><span>get_id</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>SMTLIB_Proof.extract_and_update_name_bindings</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>cx</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_raw_node</span></span><span> </span><span class="entity"><span>id</span></span><span> </span><span class="entity"><span>input_rule</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rp</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parse_raw_proof_steps</span></span><span> </span><span class="entity"><span>limit</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="entity"><span>cx</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>rp</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ANCHOR</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>anchor_id</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>anchor_args</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>parse_anchor_step</span></span><span> </span><span>##&gt;</span><span> </span><span class="entity"><span>parse_args</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>subproof</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>discharge_step</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>remaining_proof</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parse_raw_proof_steps</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>anchor_id</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="entity"><span>cx</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>curss</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parse_normal_step</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>discharge_step</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>to_raw_node</span></span><span> </span><span class="entity"><span>subproof</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>curss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>anchor_args</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rp</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parse_raw_proof_steps</span></span><span> </span><span class="entity"><span>limit</span></span><span> </span><span class="entity"><span>remaining_proof</span></span><span> </span><span class="entity"><span>cx</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>rp</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SKOLEM</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parse_skolem</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>cx</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rp</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parse_raw_proof_steps</span></span><span> </span><span class="entity"><span>limit</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="entity"><span>cx</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>rp</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>proof_ctxt_of_rule</span></span><span> </span><span class="inner_quoted"><span>"bind"</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>proof_ctxt_of_rule</span></span><span> </span><span class="inner_quoted"><span>"sko_forall"</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>proof_ctxt_of_rule</span></span><span> </span><span class="inner_quoted"><span>"sko_ex"</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>proof_ctxt_of_rule</span></span><span> </span><span class="inner_quoted"><span>"let"</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>proof_ctxt_of_rule</span></span><span> </span><span class="inner_quoted"><span>"onepoint"</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>proof_ctxt_of_rule</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>args_of_rule</span></span><span> </span><span class="inner_quoted"><span>"bind"</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>args_of_rule</span></span><span> </span><span class="inner_quoted"><span>"la_generic"</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>args_of_rule</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>insts_of_forall_inst</span></span><span> </span><span class="inner_quoted"><span>"forall_inst"</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>insts_of_forall_inst</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>id_of_last_step</span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Lethe_Replay_Node</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.last</span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>id</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>extract_assumptions_from_subproof</span></span><span> </span><span class="entity"><span>subproof</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>extract_assumptions_from_subproof</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Lethe_Replay_Node</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>assms</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>local_input_rule</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>assms</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>assms</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>fold</span><span> </span><span class="entity"><span>extract_assumptions_from_subproof</span></span><span> </span><span class="entity"><span>subproof</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>normalized_rule_name</span></span><span> </span><span class="entity"><span>id</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>input_rule</span></span><span class="main"><span>,</span></span><span> </span><span>can</span><span> </span><span class="entity"><span>SMTLIB_Interface.role_and_index_of_assert_name</span></span><span> </span><span class="entity"><span>id</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="main"><span>(</span></span><span>true</span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>normalized_input_rule</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>true</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>local_input_rule</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_assm_repetition</span></span><span> </span><span class="entity"><span>id</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>input_rule</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>can</span><span> </span><span class="entity"><span>SMTLIB_Interface.role_and_index_of_assert_name</span></span><span> </span><span class="entity"><span>id</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>extract_skolem</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="entity"><span>var</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>choice</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>var</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>choice</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>extract_skolem</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"fail to parse type"</span></span><span> </span><span>^</span><span> </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>make_string</span></span><span class="antiquote"><span>}</span></span></span></span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(* The preprocessing takes care of:
     1. unfolding the shared terms
     2. extract the declarations of skolems to make sure that there are not unfolded
*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>preprocess</span></span><span> </span><span class="entity"><span>compress</span></span><span> </span><span class="entity"><span>step</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>expand_assms</span></span><span> </span><span class="entity"><span>cs</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cs</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>expand_lonely_arguments</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>args</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"="</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>args</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>expand_lonely_arguments</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="entity"><span>var</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"="</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="entity"><span>var</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>preprocess</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Raw_Lethe_Node</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subproof</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cx</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>remap_assms</span></span><span class="main"><span>)</span></span><span>  </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>skolem_names</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>stripped_args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>args</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>map</span><span>
              </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>SMTLIB.Key</span></span><span> </span><span class="inner_quoted"><span>"="</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"="</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>]</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"bind"</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"onepoint"</span></span><span class="main"><span>)</span></span><span> </span><span>?</span><span> </span><span>flat</span><span> </span><span>o</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>expand_lonely_arguments</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>`</span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lethe_def</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>single</span><span> </span><span>o</span><span> </span><span class="entity"><span>extract_skolem</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>K</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
          </span><span>||&gt;</span><span> </span><span class="entity"><span>SMTLIB.S</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>subproof</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cx</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_map</span><span> </span><span class="entity"><span>preprocess</span></span><span> </span><span class="entity"><span>subproof</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cx</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>remap_assms</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>apfst</span><span> </span><span>flat</span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>remap_assms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"or"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span>hd</span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>remap_assms</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>remap_assms</span></span><span class="main"><span>)</span></span><span>
        </span><span class="comment1"><span>(* declare variables in the context *)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>declarations</span></span><span> </span><span class="main"><span>=</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lethe_def</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>skolem_names</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>choice</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>choice</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>compress</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"or"</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cx</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>remap_assms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>Raw_Lethe_Node</span></span><span> </span><span class="main"><span>{</span></span><span>id</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span>rule</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span> </span><span>args</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>stripped_args</span></span><span class="main"><span>,</span></span><span>
           </span><span>prems</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>expand_assms</span></span><span> </span><span class="entity"><span>remap_assms</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span> </span><span>declarations</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>declarations</span></span><span class="main"><span>,</span></span><span> </span><span>concl</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>,</span></span><span> </span><span>subproof</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>subproof</span></span><span class="main"><span>}</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>cx</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>remap_assms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>preprocess</span></span><span> </span><span class="entity"><span>step</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>filter_split</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>filter_split</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
     </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>::</span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>::</span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>filter_split</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>extract_types_of_args</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>var</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"choice"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>var</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>single</span><span>
 </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>extract_types_of_args</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>extract_types_of_arg</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>var</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>var</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>extract_types_of_arg</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>t</span></span><span>
    </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="entity"><span>extract_types_of_arg</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>collect_skolem_defs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Raw_Lethe_Node</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span> </span><span>subproof</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>subproof</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_skolemization</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>id</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>id</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>lethe_def</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>skolems_introduced_by_rule</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span>
  </span><span>flat</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>collect_skolem_defs</span></span><span> </span><span class="entity"><span>subproof</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(*The postprocessing does:
  1. translate the terms to Isabelle syntax, taking care of free variables
  2. remove the ambiguity in the proof terms:
       x ↝ y |- x = x
    means y = x. To remove ambiguity, we use the fact that y is a free variable and replace the term
    by:
      xy ↝ y |- xy = x.
    This is now does not have an ambiguity and we can safely move the "xy ↝ y" to the proof
    assumptions.
*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>postprocess_proof</span></span><span> </span><span class="entity"><span>compress</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>step</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>postprocess</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Raw_Lethe_Node</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>declarations</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subproof</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cx</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rew</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMT_Config.verit_msg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>print</span></span><span class="antiquote"><span>}</span></span></span></span></span></span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"id ="</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"concl ="</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>extract_types_of_args</span></span><span> </span><span class="entity"><span>args</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>globally_bound_vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>declared_csts</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="entity"><span>args</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>update_binding</span></span><span> </span><span>o</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Term</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>type_of</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
           </span><span class="entity"><span>globally_bound_vars</span></span><span> </span><span class="entity"><span>cx</span></span><span>

      </span><span class="comment1"><span>(*find rebound variables specific to the LHS of the equivalence symbol*)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bound_vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>bound_vars_by_rule</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="entity"><span>args</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bound_vars_no_typ</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>bound_vars</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rhs_vars</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="entity"><span>t'</span></span><span> </span><span>?</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>::</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bound_vars_no_typ</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>not_already_bound</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>SMTLIB_Proof.lookup_binding</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>None</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
          </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rhs_vars</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>shadowing_vars</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rebound_lhs_vars</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>bound_vars</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="entity"><span>filter_split</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>not_already_bound</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>hd</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span>@</span><span> </span><span>flat</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bound_vars</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>subproof_rew</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>::</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>rebound_lhs_vars</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rew</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>subproof_rewriter</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>synctatic_rew_in_lhs_subst</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span>
         </span><span class="entity"><span>subproof_rew</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>concl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bounds</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>node_of</span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="entity"><span>cx</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>extra_lhs_vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>b</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>a</span></span><span>^</span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rebound_lhs_vars</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>old_lhs_vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>extra_lhs_vars</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>new_lhs_vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>newvar</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>newvar</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>extra_lhs_vars</span></span><span>

      </span><span class="comment1"><span>(* postprocess conclusion *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>SMTLIB_Isar.unskolemize_names</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>subproof_rewriter</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMT_Config.verit_msg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span><span class="hidden">\&lt;^</span><span class="control">print</span><span class="hidden">&gt;</span></span></span></span></span></span></span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"id ="</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"concl ="</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMT_Config.verit_msg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span><span class="hidden">\&lt;^</span><span class="control">print</span><span class="hidden">&gt;</span></span></span></span></span></span></span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"id ="</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"cx' ="</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx'</span></span><span class="main"><span>,</span></span><span>
        </span><span class="inner_quoted"><span>"bound_vars ="</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bound_vars</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bound_tvars</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>type_of</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>shadowing_vars</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>new_lhs_vars</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>subproof_cx</span></span><span> </span><span class="main"><span>=</span></span><span>
         </span><span class="entity"><span>add_bound_variables_to_ctxt</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>shadowing_vars</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>new_lhs_vars</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>could_unify</span></span><span> </span><span class="main"><span>(</span></span><span>Bound</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span>Bound</span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>j</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>could_unify</span></span><span> </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span>Var</span><span> </span><span class="entity"><span>v'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>v'</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>could_unify</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span>Free</span><span> </span><span class="entity"><span>v'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>v'</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>could_unify</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>v'</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ty'</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>could_unify</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bdy</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bdy'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ty'</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>could_unify</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bdy</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bdy'</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>could_unify</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u'</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>v'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>could_unify</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>could_unify</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>v'</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>could_unify</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_alpha_renaming</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>t</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>HOLogic.dest_eq</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>could_unify</span></span><span>
        </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>alpha_conversion</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"bind"</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>is_alpha_renaming</span></span><span> </span><span class="entity"><span>concl</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>can_remove_subproof</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>compress</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_skolemization</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>alpha_conversion</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fixed_subproof</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>lethe_replay_node</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
         </span><span>fold_map</span><span> </span><span class="entity"><span>postprocess</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>can_remove_subproof</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>subproof</span></span><span class="main"><span>)</span></span><span>
           </span><span class="main"><span>(</span></span><span class="entity"><span>subproof_cx</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subproof_rew</span></span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>unsk_and_rewrite</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>SMTLIB_Isar.unskolemize_names</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>subproof_rewriter</span></span><span>

      </span><span class="comment1"><span>(* postprocess assms *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>stripped_args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>args</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sanitized_args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>proof_ctxt_of_rule</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="entity"><span>stripped_args</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>arg_cx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_bound_variables_to_ctxt</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>shadowing_vars</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>old_lhs_vars</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>subproof_cx</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>termified_args</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_map</span><span> </span><span class="entity"><span>node_of</span></span><span> </span><span class="entity"><span>sanitized_args</span></span><span> </span><span class="entity"><span>arg_cx</span></span><span> </span><span>|&gt;</span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>normalized_args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>unsk_and_rewrite</span></span><span> </span><span class="entity"><span>termified_args</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>subproof_assms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>proof_ctxt_of_rule</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="entity"><span>normalized_args</span></span><span>

      </span><span class="comment1"><span>(* postprocess arguments *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rule_args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>args_of_rule</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="entity"><span>stripped_args</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>termified_args</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_map</span><span> </span><span class="entity"><span>term_of</span></span><span> </span><span class="entity"><span>rule_args</span></span><span> </span><span class="entity"><span>subproof_cx</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>normalized_args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>unsk_and_rewrite</span></span><span> </span><span class="entity"><span>termified_args</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rule_args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>subproof_rewriter</span></span><span> </span><span class="entity"><span>normalized_args</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>raw_insts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>insts_of_forall_inst</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="entity"><span>stripped_args</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>termify_term</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>term_of</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>termified_args</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_map</span><span> </span><span class="entity"><span>termify_term</span></span><span> </span><span class="entity"><span>raw_insts</span></span><span> </span><span class="entity"><span>subproof_cx</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>insts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.empty</span><span>
        </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>insts</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Symtab.update_new</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>insts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>termified_args</span></span><span>
        </span><span>|&gt;</span><span> </span><span>Symtab.map</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="entity"><span>unsk_and_rewrite</span></span><span class="main"><span>)</span></span><span>

      </span><span class="comment1"><span>(* declarations *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>declarations</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_map</span><span> </span><span class="entity"><span>termify_term</span></span><span> </span><span class="entity"><span>declarations</span></span><span> </span><span class="entity"><span>cx</span></span><span>
        </span><span>|&gt;</span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="entity"><span>unsk_and_rewrite</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

      </span><span class="comment1"><span>(* fix step *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="main"><span>(</span></span><span>Fail</span><span> </span><span class="inner_quoted"><span>"found dangling variable in concl"</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>skolem_defs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_skolemization</span></span><span> </span><span class="entity"><span>rule</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>id</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>id</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>lethe_def</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>skolems_introduced_by_rule</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>skolems_of_subproof</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>compress</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>is_skolemization</span></span><span> </span><span class="entity"><span>rule</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>flat</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>collect_skolem_defs</span></span><span> </span><span class="entity"><span>subproof</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fixed_prems</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>prems</span></span><span> </span><span>@</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_assm_repetition</span></span><span> </span><span class="entity"><span>id</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>id</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span>
        </span><span class="entity"><span>skolem_defs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>skolems_of_subproof</span></span><span> </span><span>@</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>id_of_last_step</span></span><span> </span><span class="entity"><span>fixed_subproof</span></span><span class="main"><span>)</span></span><span>

      </span><span class="comment1"><span>(* fix subproof *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>normalized_rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>normalized_rule_name</span></span><span> </span><span class="entity"><span>id</span></span><span> </span><span class="entity"><span>rule</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>compress</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>alpha_conversion</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>K</span><span> </span><span class="inner_quoted"><span>"refl"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>extra_assms2</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>subproof_rule</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>extract_assumptions_from_subproof</span></span><span> </span><span class="entity"><span>fixed_subproof</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>step</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_replay_node</span></span><span> </span><span class="entity"><span>id</span></span><span> </span><span class="entity"><span>normalized_rule</span></span><span> </span><span class="entity"><span>rule_args</span></span><span> </span><span class="entity"><span>fixed_prems</span></span><span> </span><span class="entity"><span>subproof_assms</span></span><span> </span><span class="entity"><span>concl</span></span><span>
        </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>insts</span></span><span> </span><span class="entity"><span>declarations</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bound_tvars</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subproof_assms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extra_assms2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fixed_subproof</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
       </span><span class="main"><span>(</span></span><span class="entity"><span>step</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cx'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rew</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>postprocess</span></span><span> </span><span class="entity"><span>step</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cx</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>step</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cx</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>step</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>combine_proof_steps</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>step1</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>lethe_replay_node</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>step2</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>steps</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Lethe_Replay_Node</span></span><span> </span><span class="main"><span>{</span></span><span>id</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>id1</span></span><span class="main"><span>,</span></span><span> </span><span>rule</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rule1</span></span><span class="main"><span>,</span></span><span> </span><span>args</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>args1</span></span><span class="main"><span>,</span></span><span> </span><span>prems</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prems1</span></span><span class="main"><span>,</span></span><span>
            </span><span>proof_ctxt</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>proof_ctxt1</span></span><span class="main"><span>,</span></span><span> </span><span>concl</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>concl1</span></span><span class="main"><span>,</span></span><span> </span><span>bounds</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>bounds1</span></span><span class="main"><span>,</span></span><span> </span><span>insts</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>insts1</span></span><span class="main"><span>,</span></span><span>
            </span><span>declarations</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>declarations1</span></span><span class="main"><span>,</span></span><span>
            </span><span>subproof</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bound_sub1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>assms_sub1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>assms_extra1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subproof1</span></span><span class="main"><span>)</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>step1</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Lethe_Replay_Node</span></span><span> </span><span class="main"><span>{</span></span><span>id</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>id2</span></span><span class="main"><span>,</span></span><span> </span><span>rule</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rule2</span></span><span class="main"><span>,</span></span><span> </span><span>args</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>args2</span></span><span class="main"><span>,</span></span><span> </span><span>prems</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prems2</span></span><span class="main"><span>,</span></span><span>
            </span><span>proof_ctxt</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>proof_ctxt2</span></span><span class="main"><span>,</span></span><span> </span><span>concl</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>concl2</span></span><span class="main"><span>,</span></span><span> </span><span>bounds</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>bounds2</span></span><span class="main"><span>,</span></span><span> </span><span>insts</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>insts2</span></span><span class="main"><span>,</span></span><span>
            </span><span>declarations</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>declarations2</span></span><span class="main"><span>,</span></span><span>
            </span><span>subproof</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bound_sub2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>assms_sub2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>assms_extra2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subproof2</span></span><span class="main"><span>)</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>step2</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goals1</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>concl1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.disj|const"><span>HOL.disj</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span>
                  </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.disj|const"><span>HOL.disj</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>HOL.Not</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>b</span></span><span class="main"><span>]</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>concl2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>rule1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>equiv_pos2_rule</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>rule2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>th_resolution_rule</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prems2</span></span><span> </span><span class="entity"><span>id1</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>goals1</span></span><span> </span><span class="entity"><span>goal2</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="entity"><span>mk_replay_node</span></span><span> </span><span class="entity"><span>id2</span></span><span> </span><span class="entity"><span>theory_resolution2_rule</span></span><span> </span><span class="entity"><span>args2</span></span><span> </span><span class="main"><span>(</span></span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>id1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prems2</span></span><span class="main"><span>)</span></span><span>
            </span><span class="entity"><span>proof_ctxt2</span></span><span> </span><span class="entity"><span>concl2</span></span><span> </span><span class="entity"><span>bounds2</span></span><span> </span><span class="entity"><span>insts2</span></span><span> </span><span class="entity"><span>declarations2</span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>bound_sub2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>assms_sub2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>assms_extra2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>combine_proof_steps</span></span><span> </span><span class="entity"><span>subproof2</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span>
          </span><span class="entity"><span>combine_proof_steps</span></span><span> </span><span class="entity"><span>steps</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="entity"><span>mk_replay_node</span></span><span> </span><span class="entity"><span>id1</span></span><span> </span><span class="entity"><span>rule1</span></span><span> </span><span class="entity"><span>args1</span></span><span> </span><span class="entity"><span>prems1</span></span><span>
            </span><span class="entity"><span>proof_ctxt1</span></span><span> </span><span class="entity"><span>concl1</span></span><span> </span><span class="entity"><span>bounds1</span></span><span> </span><span class="entity"><span>insts1</span></span><span> </span><span class="entity"><span>declarations1</span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>bound_sub1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>assms_sub1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>assms_extra1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>combine_proof_steps</span></span><span> </span><span class="entity"><span>subproof1</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span>
          </span><span class="entity"><span>combine_proof_steps</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>step2</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>steps</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>combine_proof_steps</span></span><span> </span><span class="entity"><span>steps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>steps</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>linearize_proof</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_node_concl</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Lethe_Node</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>proof_ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
       </span><span class="entity"><span>mk_node</span></span><span> </span><span class="entity"><span>id</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="entity"><span>proof_ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>linearize</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Lethe_Replay_Node</span></span><span> </span><span class="main"><span>{</span></span><span>id</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span>rule</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span> </span><span>args</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>prems</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span>
        </span><span>proof_ctxt</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>proof_ctxt</span></span><span class="main"><span>,</span></span><span> </span><span>concl</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>,</span></span><span> </span><span>bounds</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>bounds</span></span><span class="main"><span>,</span></span><span> </span><span>insts</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>declarations</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span>
        </span><span>subproof</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bounds'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>assms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>inputs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subproof</span></span><span class="main"><span>)</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>distinct</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bounds</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bounds'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>distinct</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bounds'</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_prop_of_term</span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>concl</span></span><span> </span><span>|&gt;</span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span></span><span> </span><span>?</span><span> </span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>$</span><span class="main"><span>)</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>remove_assumption_id</span></span><span> </span><span class="entity"><span>assumption_id</span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>assumption_id</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prems</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_assumption</span></span><span> </span><span class="entity"><span>assumption</span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.imp</span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>mk_prop_of_term</span></span><span> </span><span class="entity"><span>assumption</span></span><span>›</span></span><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>mk_prop_of_term</span></span><span> </span><span class="entity"><span>concl</span></span><span>›</span></span><span>›</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>inline_assumption</span></span><span> </span><span class="entity"><span>assumption</span></span><span> </span><span class="entity"><span>assumption_id</span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>Lethe_Node</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>proof_ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>mk_node</span></span><span> </span><span class="entity"><span>id</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>remove_assumption_id</span></span><span> </span><span class="entity"><span>assumption_id</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>proof_ctxt</span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>add_assumption</span></span><span> </span><span class="entity"><span>assumption</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>find_input_steps_and_inline</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>find_input_steps_and_inline</span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>Lethe_Node</span></span><span> </span><span class="main"><span>{</span></span><span>id</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>id'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>steps</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>input_rule</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
              </span><span class="entity"><span>find_input_steps_and_inline</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inline_assumption</span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="entity"><span>id'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>steps</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
              </span><span class="entity"><span>mk_node</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>id'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>find_input_steps_and_inline</span></span><span> </span><span class="entity"><span>steps</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>free_bounds</span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>concl</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>var</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Logic.all</span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>var</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="entity"><span>concl</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>subproof</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>subproof</span></span><span>
          </span><span>|&gt;</span><span> </span><span>flat</span><span> </span><span>o</span><span> </span><span>map</span><span> </span><span class="entity"><span>linearize</span></span><span>
          </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_node_concl</span></span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="entity"><span>add_assumption</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>assms</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>inputs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_node_concl</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>free_bounds</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bounds</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>bounds'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>find_input_steps_and_inline</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>free_bounds</span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="entity"><span>concl</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>subproof</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>mk_node</span></span><span> </span><span class="entity"><span>id</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="entity"><span>proof_ctxt</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>]</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>linearize</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rule_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Lethe_Replay_Node</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rule</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>subproof_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Lethe_Replay_Node</span></span><span> </span><span class="main"><span>{</span></span><span>subproof</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subproof</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>subproof</span></span><span>


</span><span class="comment1"><span>(* Massage Skolems for Sledgehammer.

We have to make sure that there is an "arrow" in the graph for skolemization steps.


A. The normal easy case

This function detects the steps of the form
  P ⟷ Q :skolemization
  Q       :resolution with P
and replace them by
  Q       :skolemization
Throwing away the step "P ⟷ Q" completely. This throws away a lot of information, but it does not
matter too much for Sledgehammer.


B. Skolems in subproofs
Supporting this is more or less hopeless as long as the Isar reconstruction of Sledgehammer
does not support more features like definitions. lethe is able to generate proofs with skolemization
happening in subproofs inside the formula.
  (assume "A ∨ P"
   ...
   P ⟷ Q :skolemization in the subproof
   ...)
  hence A ∨ P ⟶ A ∨ Q :lemma
  ...
  R :something with some rule
and replace them by
  R :skolemization with some rule
Without any subproof
*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>remove_skolem_definitions_proof</span></span><span> </span><span class="entity"><span>steps</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>replace_equivalent_by_imp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>judgement</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>arg1</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>arg2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
       </span><span class="entity"><span>judgement</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.implies|const"><span>HOL.implies</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>arg1</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>arg2</span></span><span class="main"><span>)</span></span><span>
     </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>replace_equivalent_by_imp</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="comment1"><span>(*This case is probably wrong*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>remove_skolem_definitions</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Lethe_Replay_Node</span></span><span> </span><span class="main"><span>{</span></span><span>id</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span>rule</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span> </span><span>args</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>,</span></span><span>
         </span><span>prems</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span>
        </span><span>proof_ctxt</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>proof_ctxt</span></span><span class="main"><span>,</span></span><span> </span><span>concl</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>,</span></span><span> </span><span>bounds</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>bounds</span></span><span class="main"><span>,</span></span><span> </span><span>insts</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>insts</span></span><span class="main"><span>,</span></span><span>
        </span><span>declarations</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>declarations</span></span><span class="main"><span>,</span></span><span>
        </span><span>subproof</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>assms'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extra_assms'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subproof</span></span><span class="main"><span>)</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prems_to_remove</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>skolems</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prems</span></span><span>
        </span><span>|&gt;</span><span> </span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prems_to_remove</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>trivial_step</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>is_SH_trivial</span></span><span> </span><span class="entity"><span>rule</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>has_skolem_substep</span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_skolemization</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rule_of</span></span><span> </span><span class="entity"><span>st</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rule_of</span></span><span> </span><span class="entity"><span>st</span></span><span class="main"><span>)</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>has_skolem_substep</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>subproof_of</span></span><span> </span><span class="entity"><span>st</span></span><span class="main"><span>)</span></span><span> </span><span>NONE</span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>has_skolem_substep</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>a</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>promote_to_skolem</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>skolems</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prems</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>promote_from_assms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>has_skolem_substep</span></span><span> </span><span class="entity"><span>subproof</span></span><span> </span><span>NONE</span><span> </span><span>&lt;&gt;</span><span> </span><span>NONE</span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>promote_step</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>promote_to_skolem</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>promote_from_assms</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>skolem_step_to_skip</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>is_skolemization</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>promote_from_assms</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>length</span><span> </span><span class="entity"><span>prems</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>is_skolem</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>is_skolemization</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>promote_step</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prems</span></span><span>
        </span><span>|&gt;</span><span> </span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>skolems</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="entity"><span>is_skolem</span></span><span> </span><span>?</span><span> </span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span>String.isPrefix</span><span> </span><span class="entity"><span>id</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>promote_step</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>default_skolem_rule</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>subproof</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>subproof</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_skolem</span></span><span> </span><span>?</span><span> </span><span>K</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="comment1"><span>(*subproofs of skolemization steps are useless for SH*)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>remove_skolem_definitions</span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prems_to_remove</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>skolems</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
             </span><span class="comment1"><span>(*no new definitions in subproofs*)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>flat</span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>concl</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="entity"><span>is_skolem</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>replace_equivalent_by_imp</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>step</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>skolem_step_to_skip</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lethe_def</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>trivial_step</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>mk_replay_node</span></span><span> </span><span class="entity"><span>id</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="entity"><span>proof_ctxt</span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="entity"><span>insts</span></span><span> </span><span class="entity"><span>declarations</span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>assms'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extra_assms'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subproof</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>single</span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>defs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lethe_def</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>trivial_step</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>id</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>prems_to_remove</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>prems_to_remove</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>skolems</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>skolem_step_to_skip</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>id</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>skolems</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>skolems</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>step</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>defs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>skolems</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>fold_map</span><span> </span><span class="entity"><span>remove_skolem_definitions</span></span><span> </span><span class="entity"><span>steps</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>fst</span><span>
    </span><span>|&gt;</span><span> </span><span>flat</span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
  </span><span class="comment1"><span>(*TODO useful?*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>remove_pattern</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.Sym</span></span><span> </span><span class="inner_quoted"><span>"!"</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>t</span></span><span> </span><span>::</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>SMTLIB.Key</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>remove_pattern</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>SMTLIB.S</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>remove_pattern</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>remove_pattern</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>p</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>import_proof_and_post_process</span></span><span> </span><span class="entity"><span>typs</span></span><span> </span><span class="entity"><span>funs</span></span><span> </span><span class="entity"><span>lines</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>compress</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>SMT_Config.compress_verit_proofs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>smtlib_lines_without_qm</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>lines</span></span><span>
        </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span>single</span><span>
        </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="entity"><span>SMTLIB.parse</span></span><span>
        </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="entity"><span>remove_all_qm2</span></span><span>
        </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="entity"><span>remove_pattern</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>raw_steps</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>parse_raw_proof_steps</span></span><span> </span><span>NONE</span><span> </span><span class="entity"><span>smtlib_lines_without_qm</span></span><span> </span><span class="entity"><span>SMTLIB_Proof.empty_name_binding</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>process</span></span><span> </span><span class="entity"><span>step</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cx</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>postprocess</span></span><span> </span><span class="entity"><span>step</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cx</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>step</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>postprocess_proof</span></span><span> </span><span class="entity"><span>compress</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>step</span></span><span> </span><span class="entity"><span>cx</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>step</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cx</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>uncurry</span><span> </span><span class="main"><span>(</span></span><span>fold_map</span><span> </span><span class="entity"><span>postprocess</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>preprocess</span></span><span> </span><span class="entity"><span>compress</span></span><span> </span><span class="entity"><span>step</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cx</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>step</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>empty_context</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>typs</span></span><span> </span><span class="entity"><span>funs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>fold_map</span><span> </span><span class="entity"><span>process</span></span><span> </span><span class="entity"><span>raw_steps</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>steps</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cx</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>flat</span><span> </span><span class="entity"><span>steps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="entity"><span>compress</span></span><span>?</span><span> </span><span>apfst</span><span> </span><span class="entity"><span>combine_proof_steps</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>step</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parse</span></span><span> </span><span class="entity"><span>typs</span></span><span> </span><span class="entity"><span>funs</span></span><span> </span><span class="entity"><span>lines</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>env</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>import_proof_and_post_process</span></span><span> </span><span class="entity"><span>typs</span></span><span> </span><span class="entity"><span>funs</span></span><span> </span><span class="entity"><span>lines</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>u</span></span><span>
       </span><span>|&gt;</span><span> </span><span class="entity"><span>remove_skolem_definitions_proof</span></span><span>
       </span><span>|&gt;</span><span> </span><span>flat</span><span> </span><span>o</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>linearize_proof</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>node_to_step</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Lethe_Node</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>mk_step</span></span><span> </span><span class="entity"><span>id</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>node_to_step</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt_of</span></span><span> </span><span class="entity"><span>env</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parse_replay</span></span><span> </span><span class="entity"><span>typs</span></span><span> </span><span class="entity"><span>funs</span></span><span> </span><span class="entity"><span>lines</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>env</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>import_proof_and_post_process</span></span><span> </span><span class="entity"><span>typs</span></span><span> </span><span class="entity"><span>funs</span></span><span> </span><span class="entity"><span>lines</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMT_Config.verit_msg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span><span class="hidden">\&lt;^</span><span class="control">print</span><span class="hidden">&gt;</span></span></span></span></span></span></span></span></span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt_of</span></span><span> </span><span class="entity"><span>env</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
</span></pre>
</body>

</html>