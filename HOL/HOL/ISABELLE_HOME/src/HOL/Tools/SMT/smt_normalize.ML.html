<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Tools/SMT/smt_normalize.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Tools/SMT/smt_normalize.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      HOL/Tools/SMT/smt_normalize.ML
    Author:     Sascha Boehme, TU Muenchen

Normalization steps on theorems required by SMT solvers.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>SMT_NORMALIZE</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> drop_fact_warning</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> atomize_conv</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>conv</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> special_quant_table</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> case_bool_entry</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> * </span><span>thm</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> abs_min_max_table</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span> </span><span>list</span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>extra_norm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> * </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> * </span><span>thm</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_extra_norm</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>SMT_Util.class</span></span><span> * </span><span class="entity"><span>extra_norm</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> normalize</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMT_Util.role</span></span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>int</span><span> * </span><span class="entity"><span>SMT_Util.role</span></span><span class="main"><span>)</span></span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span> </span><span>list</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>SMT_Normalize</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>SMT_NORMALIZE</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>drop_fact_warning</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>SMT_Config.verbose_msg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>prefix</span><span> </span><span class="inner_quoted"><span>"Warning: dropping assumption: "</span></span><span> </span><span>o</span><span>
    </span><span>Thm.string_of_thm</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>


</span><span class="comment1"><span>(* general theorem normalizations *)</span></span><span>

</span><span class="comment1"><span>(** instantiate elimination rules **)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cpfalse</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cfalse</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>`</span><span class="entity"><span>SMT_Util.mk_cprop</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">cterm</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.False|const"><span>False</span></a><span>›</span></span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>inst</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cv</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span>Drule.strip_imp_concl</span><span> </span><span class="main"><span>(</span></span><span>Thm.cprop_of</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Thm.instantiate</span><span> </span><span class="main"><span>(</span></span><span>TVars.empty</span><span class="main"><span>,</span></span><span> </span><span>Vars.make</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span>dest_Var</span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="entity"><span>cv</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ct</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>instantiate_elim</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.concl_of</span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="quoted"><span>‹</span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span><span class="main"><span>)</span></span><span>›</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>inst</span></span><span> </span><span>Thm.dest_arg</span><span> </span><span class="entity"><span>cfalse</span></span><span> </span><span class="entity"><span>thm</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>Var</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>inst</span></span><span> </span><span>I</span><span> </span><span class="entity"><span>cpfalse</span></span><span> </span><span class="entity"><span>thm</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(** normalize definitions **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>norm_def</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.prop_of</span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span> </span><span class="main"><span>_</span></span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="quoted"><span>‹</span><span>Abs</span><span> </span><span class="main"><span>_</span></span><span>›</span></span><span>›</span></span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>norm_def</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.fun_cong|fact"><span>fun_cong</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.eq</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="quoted"><span>‹</span><span>Abs</span><span> </span><span class="main"><span>_</span></span><span>›</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>norm_def</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_obj_eq</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span>


</span><span class="comment1"><span>(** atomization **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>atomize_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.imp</span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span>Conv.binop_conv</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>atomize_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span>then_conv</span><span> </span><span>Conv.rewr_conv</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.atomize_imp|fact"><span>atomize_imp</span></a><span class="antiquote"><span>}</span></span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.eq</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span>Conv.binop_conv</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>atomize_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span>then_conv</span><span> </span><span>Conv.rewr_conv</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.atomize_eq|fact"><span>atomize_eq</span></a><span class="antiquote"><span>}</span></span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.all</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="quoted"><span>‹</span><span>Abs</span><span> </span><span class="main"><span>_</span></span><span>›</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span>Conv.binder_conv</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>atomize_conv</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>then_conv</span><span> </span><span>Conv.rewr_conv</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.atomize_all|fact"><span>atomize_all</span></a><span class="antiquote"><span>}</span></span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Conv.all_conv</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ct</span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>CTERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Conv.all_conv</span><span> </span><span class="entity"><span>ct</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>setup_atomize</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>fold</span><span> </span><span class="entity"><span>SMT_Builtin.add_builtin_fun_ext''</span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.imp</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.eq</span><span>›</span></span><span class="main"><span>,</span></span><span>
    </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.all</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span><span class="main"><span>]</span></span><span>


</span><span class="comment1"><span>(** unfold special quantifiers **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>special_quant_table</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span>
  </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Ex1|const"><span>Ex1</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../SMT.html#SMT.Ex1_def_raw|fact"><span>Ex1_def_raw</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Set.html#Set.Ball|const"><span>Ball</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../SMT.html#SMT.Ball_def_raw|fact"><span>Ball_def_raw</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Set.html#Set.Bex|const"><span>Bex</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../SMT.html#SMT.Bex_def_raw|fact"><span>Bex_def_raw</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>special_quant</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>special_quant_table</span></span><span> </span><span class="entity"><span>n</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>special_quant</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>special_quant_conv</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>special_quant</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="entity"><span>ct</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>SOME</span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Conv.rewr_conv</span><span> </span><span class="entity"><span>thm</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Conv.all_conv</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ct</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unfold_special_quants_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>SMT_Util.if_exists_conv</span></span><span> </span><span class="main"><span>(</span></span><span>is_some</span><span> </span><span>o</span><span> </span><span class="entity"><span>special_quant</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Conv.top_conv</span><span> </span><span class="entity"><span>special_quant_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>setup_unfolded_quants</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMT_Builtin.add_builtin_fun_ext''</span></span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>special_quant_table</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(** trigger inference **)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
  </span><span class="comment1"><span>(*** check trigger syntax ***)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_trigger</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../SMT.html#SMT.pat|const"><span>pat</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span>true</span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dest_trigger</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../SMT.html#SMT.nopat|const"><span>nopat</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span>false</span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dest_trigger</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>eq_list</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>eq_list</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>bs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span>equal</span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bs</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>proper_trigger</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>t</span></span><span>
    </span><span>|&gt;</span><span> </span><span>these</span><span> </span><span>o</span><span> </span><span>try</span><span> </span><span class="entity"><span>SMT_Util.dest_symb_list</span></span><span>
    </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map_filter</span><span> </span><span class="entity"><span>dest_trigger</span></span><span> </span><span>o</span><span> </span><span>these</span><span> </span><span>o</span><span> </span><span>try</span><span> </span><span class="entity"><span>SMT_Util.dest_symb_list</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>bss</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>forall</span><span> </span><span class="entity"><span>eq_list</span></span><span> </span><span class="entity"><span>bss</span></span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>proper_quant</span></span><span> </span><span class="entity"><span>inside</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.All|const"><span>All</span></a><span> </span><span class="main"><span>_</span></span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="quoted"><span>‹</span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>›</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>proper_quant</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>u</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Ex|const"><span>Ex</span></a><span> </span><span class="main"><span>_</span></span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="quoted"><span>‹</span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>›</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>proper_quant</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>u</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../SMT.html#SMT.trigger|const"><span>trigger</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>u</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>inside</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>proper_quant</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>u</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>proper_quant</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>u</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>u1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u2</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>proper_quant</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>u1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>proper_quant</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>u2</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_trigger_error</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"SMT triggers must only occur under quantifier and multipatterns "</span></span><span> </span><span>^</span><span>
      </span><span class="inner_quoted"><span>"must have the same kind: "</span></span><span> </span><span>^</span><span> </span><span>Syntax.string_of_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_trigger_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>proper_quant</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>proper_trigger</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMT_Util.term_of</span></span><span> </span><span class="entity"><span>ct</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Conv.all_conv</span><span> </span><span class="entity"><span>ct</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>check_trigger_error</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="entity"><span>ct</span></span><span class="main"><span>)</span></span><span>


  </span><span class="comment1"><span>(*** infer simple triggers ***)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_cond_eq</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Thm.dest_binop</span><span> </span><span class="entity"><span>ct</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.implies|const"><span>implies</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>dest_cond_eq</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.dest_arg</span><span> </span><span class="entity"><span>ct</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>CTERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"no equation"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>ct</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_constrs</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>these</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>BNF_LFP_Compat.get_constrs</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>get_constrs</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_constr</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>match</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>U</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>Sign.typ_instance</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>U</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>can</span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span>o</span><span> </span><span>find_first</span><span> </span><span class="entity"><span>match</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>get_constrs</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span>o</span><span> </span><span>Term.body_type</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_constr_pat</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Term.strip_comb</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>is_constr</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_constr_pat</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ts</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_simp_lhs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Term.strip_comb</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMT_Builtin.is_builtin_fun_ext</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
        </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_constr_pat</span></span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ts</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>has_all_vars</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>subset</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconv</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vs</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span>Term.add_frees</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>minimal_pats</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>has_all_vars</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="entity"><span>ct</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>apply2</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>minimal_pats</span></span><span> </span><span class="entity"><span>vs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.dest_comb</span><span> </span><span class="entity"><span>ct</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span class="entity"><span>ct</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctss'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>union</span><span> </span><span class="main"><span>(</span></span><span>eq_set</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconvc</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctss</span></span><span> </span><span class="entity"><span>ctss'</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>proper_mpat</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>proper_mpat</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>gen</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="entity"><span>cts</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>~~</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>`</span><span class="entity"><span>gen</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>cts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>some_match</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tps</span></span><span> </span><span>|&gt;</span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span>Pattern.matches</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span>aconv</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>Term.exists_subterm</span><span> </span><span class="entity"><span>some_match</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pat</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>SMT_Util.mk_const_pat</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span><span class="hidden">\&lt;^</span><span class="control">theory</span><span class="hidden">&gt;</span></span></span></span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../SMT.html#SMT.pat|const"><span>pat</span></a><span>›</span></span><span> </span><span>Thm.dest_ctyp0</span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_pat</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.apply</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMT_Util.instT'</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="entity"><span>pat</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ct</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_clist</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>apply2</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span><span class="hidden">\&lt;^</span><span class="control">context</span><span class="hidden">&gt;</span></span></span></span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMT_Util.symb_cons_const</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>SMT_Util.symb_nil_const</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_list</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ccons</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cnil</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>cts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span>Thm.mk_binop</span><span> </span><span class="entity"><span>ccons</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cts</span></span><span> </span><span class="entity"><span>cnil</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mk_pat_list</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_list</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_clist</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../SMT.html#SMT.pattern|type"><span>pattern</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mk_mpat_list</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_list</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_clist</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../SMT.html#SMT.pattern|type"><span>pattern</span></a><span> </span><a class="entity_ref" href="../../../../../SMT.html#SMT.symb_list|type"><span>symb_list</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_trigger</span></span><span> </span><span class="entity"><span>ctss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_mpat_list</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_pat_list</span></span><span> </span><span class="entity"><span>mk_pat</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctss</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>trigger_eq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_meta_eq</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>lemma</span></span><span> </span><span class="quoted"><span>"</span><span class="free"><span>p</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>=</span></a></span><span> </span><a class="entity_ref" href="../../../../../SMT.html#SMT.trigger|const"><span>trigger</span></a><span> </span><span class="free"><span>t</span></span><span> </span><span class="free"><span>p</span></span><span>"</span></span><span> </span><span class="quasi_keyword"><span>by</span></span><span> </span><span class="main"><span>(</span></span><span class="operator"><span>simp</span></span><span> </span><span class="quasi_keyword"><span>add</span></span><span class="main"><span>:</span></span><span> </span><a class="entity_ref" href="../../../../../SMT.html#SMT.trigger_def|fact"><span>trigger_def</span></a><span class="main"><span>)</span></span><span class="antiquote"><span>}</span></span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>insert_trigger_conv</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Conv.all_conv</span><span> </span><span class="entity"><span>ct</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>insert_trigger_conv</span></span><span> </span><span class="entity"><span>ctss</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cp</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.dest_binop</span><span> </span><span class="main"><span>(</span></span><span>Thm.rhs_of</span><span> </span><span class="entity"><span>trigger_eq</span></span><span class="main"><span>)</span></span><span> </span><span>||&gt;</span><span> </span><span>rpair</span><span> </span><span class="entity"><span>ct</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inst</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>dest_Var</span><span> </span><span>o</span><span> </span><span>Thm.term_of</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>cp</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_trigger</span></span><span> </span><span class="entity"><span>ctss</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Thm.instantiate</span><span> </span><span class="main"><span>(</span></span><span>TVars.empty</span><span class="main"><span>,</span></span><span> </span><span>Vars.make</span><span> </span><span class="entity"><span>inst</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>trigger_eq</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>infer_trigger_eq_conv</span></span><span> </span><span class="entity"><span>outer_ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cvs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_cond_eq</span></span><span> </span><span class="entity"><span>ct</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>cvs</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_mpats</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_simp_lhs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="entity"><span>ct</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>minimal_pats</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="entity"><span>ct</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>gen</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.export_terms</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>outer_ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>filter_mpats</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>proper_mpat</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>gen</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>insert_trigger_conv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>filter_mpats</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_mpats</span></span><span> </span><span class="entity"><span>lhs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>has_trigger</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../SMT.html#SMT.trigger|const"><span>trigger</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>has_trigger</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>try_trigger_conv</span></span><span> </span><span class="entity"><span>cv</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>SMT_Util.under_quant</span></span><span> </span><span class="entity"><span>has_trigger</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMT_Util.term_of</span></span><span> </span><span class="entity"><span>ct</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Conv.all_conv</span><span> </span><span class="entity"><span>ct</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Conv.try_conv</span><span> </span><span class="entity"><span>cv</span></span><span> </span><span class="entity"><span>ct</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>infer_trigger_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>SMT_Config.infer_triggers</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="entity"><span>try_trigger_conv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMT_Util.under_quant_conv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>infer_trigger_eq_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Conv.all_conv</span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>trigger_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>SMT_Util.prop_conv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>check_trigger_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>then_conv</span><span> </span><span class="entity"><span>infer_trigger_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>setup_trigger</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>fold</span><span> </span><span class="entity"><span>SMT_Builtin.add_builtin_fun_ext''</span></span><span>
    </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../SMT.html#SMT.pat|const"><span>pat</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../SMT.html#SMT.nopat|const"><span>nopat</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../SMT.html#SMT.trigger|const"><span>trigger</span></a><span>›</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(** combined general normalizations **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gen_normalize1_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>atomize_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>then_conv</span><span>
  </span><span class="entity"><span>unfold_special_quants_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>then_conv</span><span>
  </span><span>Thm.beta_conversion</span><span> </span><span>true</span><span> </span><span>then_conv</span><span>
  </span><span class="entity"><span>trigger_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gen_normalize1</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>instantiate_elim</span></span><span> </span><span>#&gt;</span><span>
  </span><span class="entity"><span>norm_def</span></span><span> </span><span>#&gt;</span><span>
  </span><span>Conv.fconv_rule</span><span> </span><span class="main"><span>(</span></span><span>Thm.beta_conversion</span><span> </span><span>true</span><span> </span><span>then_conv</span><span> </span><span>Thm.eta_conversion</span><span class="main"><span>)</span></span><span> </span><span>#&gt;</span><span>
  </span><span>Thm.forall_intr_vars</span><span> </span><span>#&gt;</span><span>
  </span><span>Conv.fconv_rule</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>gen_normalize1_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span>#&gt;</span><span>
  </span><span class="comment1"><span>(* Z3 4.3.1 silently normalizes "P --&gt; Q --&gt; R" to "P &amp; Q --&gt; R" *)</span></span><span>
  </span><span>Raw_Simplifier.rewrite_rule</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.imp_conjL|fact"><span>HOL.imp_conjL</span></a><span class="main"><span>[</span></span><span class="operator"><span>symmetric</span></span><span class="main"><span>,</span></span><span> </span><span class="operator"><span>THEN</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq_reflection|fact"><span>eq_reflection</span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gen_norm1_safe</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>gen_normalize1</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="entity"><span>thm'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm'</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>drop_fact_warning</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gen_normalize</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>iwthms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>gen_norm1_safe</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>iwthms</span></span><span>


</span><span class="comment1"><span>(* unfolding of definitions and theory-specific rewritings *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>expand_head_conv</span></span><span> </span><span class="entity"><span>cv</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span>Conv.fun_conv</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>expand_head_conv</span></span><span> </span><span class="entity"><span>cv</span></span><span class="main"><span>)</span></span><span> </span><span>then_conv</span><span>
      </span><span>Conv.try_conv</span><span> </span><span class="main"><span>(</span></span><span>Thm.beta_conversion</span><span> </span><span>false</span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>cv</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ct</span></span><span>


</span><span class="comment1"><span>(** rewrite bool case expressions as if expressions **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>case_bool_entry</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.bool.case_bool|const"><span>bool.case_bool</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../SMT.html#SMT.case_bool_if|fact"><span>case_bool_if</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_case_bool</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.bool.case_bool|const"><span>bool.case_bool</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_case_bool</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unfold_conv</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>SMT_Util.if_true_conv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_case_bool</span></span><span> </span><span>o</span><span> </span><span>Term.head_of</span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>expand_head_conv</span></span><span> </span><span class="main"><span>(</span></span><span>Conv.rewr_conv</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../SMT.html#SMT.case_bool_if|fact"><span>case_bool_if</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rewrite_case_bool_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>SMT_Util.if_exists_conv</span></span><span> </span><span class="entity"><span>is_case_bool</span></span><span> </span><span class="main"><span>(</span></span><span>Conv.top_conv</span><span> </span><span class="entity"><span>unfold_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>setup_case_bool</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>SMT_Builtin.add_builtin_fun_ext''</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.bool.case_bool|const"><span>bool.case_bool</span></a><span>›</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(** unfold abs, min and max **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>abs_min_max_table</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span>
  </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Orderings.html#Orderings.ord_class.min|const"><span>min</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../SMT.html#SMT.min_def_raw|fact"><span>min_def_raw</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Orderings.html#Orderings.ord_class.max|const"><span>max</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../SMT.html#SMT.max_def_raw|fact"><span>max_def_raw</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Groups.html#Groups.abs_class.abs|const"><span>abs</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../SMT.html#SMT.abs_if_raw|fact"><span>abs_if_raw</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>abs_min_max</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>abs_min_max_table</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>SMT_Builtin.is_builtin_typ_ext</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>abs_min_max</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unfold_amm_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>abs_min_max</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>Term.head_of</span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="entity"><span>ct</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>SOME</span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>expand_head_conv</span></span><span> </span><span class="main"><span>(</span></span><span>Conv.rewr_conv</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Conv.all_conv</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ct</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unfold_abs_min_max_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>SMT_Util.if_exists_conv</span></span><span> </span><span class="main"><span>(</span></span><span>is_some</span><span> </span><span>o</span><span> </span><span class="entity"><span>abs_min_max</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Conv.top_conv</span><span> </span><span class="entity"><span>unfold_amm_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>setup_abs_min_max</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMT_Builtin.add_builtin_fun_ext''</span></span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>abs_min_max_table</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(** embedding of standard natural number operations into integer operations **)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>simple_nat_ops</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span>
    </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Nat.html#Nat.nat|type"><span>nat</span></a><span>›</span></span></span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Orderings.html#Orderings.ord_class.less|const"><span>less</span></a><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Nat.html#Nat.nat|type"><span>nat</span></a><span>›</span></span></span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Orderings.html#Orderings.ord_class.less_eq|const"><span>less_eq</span></a><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Nat.html#Nat.nat|type"><span>nat</span></a><span>›</span></span></span><span>›</span></span><span class="main"><span>,</span></span><span>
    </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Nat.html#Nat.Suc|const"><span>Suc</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Groups.html#Groups.plus_class.plus|const"><span>plus</span></a><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Nat.html#Nat.nat|type"><span>nat</span></a><span>›</span></span></span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Groups.html#Groups.minus_class.minus|const"><span>minus</span></a><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Nat.html#Nat.nat|type"><span>nat</span></a><span>›</span></span></span><span>›</span></span><span class="main"><span>]</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nat_consts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>simple_nat_ops</span></span><span> </span><span>@</span><span>
    </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Num.html#Num.numeral_class.numeral|const"><span>numeral</span></a><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Nat.html#Nat.nat|type"><span>nat</span></a><span>›</span></span></span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Groups.html#Groups.zero_class.zero|const"><span>zero_class.zero</span></a><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Nat.html#Nat.nat|type"><span>nat</span></a><span>›</span></span></span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Groups.html#Groups.one_class.one|const"><span>one_class.one</span></a><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Nat.html#Nat.nat|type"><span>nat</span></a><span>›</span></span></span><span>›</span></span><span class="main"><span>]</span></span><span> </span><span>@</span><span>
    </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Groups.html#Groups.times_class.times|const"><span>times</span></a><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Nat.html#Nat.nat|type"><span>nat</span></a><span>›</span></span></span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Rings.html#Rings.divide_class.divide|const"><span>divide</span></a><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Nat.html#Nat.nat|type"><span>nat</span></a><span>›</span></span></span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Rings.html#Rings.modulo_class.modulo|const"><span>modulo</span></a><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Nat.html#Nat.nat|type"><span>nat</span></a><span>›</span></span></span><span>›</span></span><span class="main"><span>]</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>is_nat_const</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconv</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>nat_consts</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nat_int_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.symmetric</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_meta_eq</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Int.html#Int.nat_int|fact"><span>nat_int</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nat_int_comp_thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>mk_meta_eq</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../SMT.html#SMT.nat_int_comparison|fact"><span>nat_int_comparison</span></a><span class="antiquote"><span>}</span></span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>int_ops_thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>mk_meta_eq</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../SMT.html#SMT.int_ops|fact"><span>int_ops</span></a><span class="antiquote"><span>}</span></span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>int_if_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_meta_eq</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../SMT.html#SMT.int_if|fact"><span>int_if</span></a><span class="antiquote"><span>}</span></span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>if_conv</span></span><span> </span><span class="entity"><span>cv1</span></span><span> </span><span class="entity"><span>cv2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Conv.combination_conv</span><span> </span><span class="main"><span>(</span></span><span>Conv.combination_conv</span><span> </span><span class="main"><span>(</span></span><span>Conv.arg_conv</span><span> </span><span class="entity"><span>cv1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cv2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cv2</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>int_ops_conv</span></span><span> </span><span class="entity"><span>cv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Nat.html#Nat.semiring_1_class.of_nat|const"><span>of_nat</span></a><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Int.html#Int.int|type"><span>int</span></a><span>›</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="quoted"><span>‹</span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.If|const"><span>If</span></a><span> </span><span class="main"><span>_</span></span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span>›</span></span><span>›</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span>Conv.rewr_conv</span><span> </span><span class="entity"><span>int_if_thm</span></span><span> </span><span>then_conv</span><span>
        </span><span class="entity"><span>if_conv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>int_ops_conv</span></span><span> </span><span class="entity"><span>cv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Nat.html#Nat.semiring_1_class.of_nat|const"><span>of_nat</span></a><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Int.html#Int.int|type"><span>int</span></a><span>›</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="main"><span>_</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="main"><span>(</span></span><span>Conv.rewrs_conv</span><span> </span><span class="entity"><span>int_ops_thms</span></span><span> </span><span>then_conv</span><span>
          </span><span>Conv.top_sweep_conv</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>int_ops_conv</span></span><span> </span><span class="entity"><span>cv</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span>else_conv</span><span>
        </span><span>Conv.arg_conv</span><span> </span><span class="main"><span>(</span></span><span>Conv.sub_conv</span><span> </span><span class="entity"><span>cv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Conv.no_conv</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ct</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>unfold_nat_let_conv</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Conv.rewr_conv</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>lemma</span></span><span> </span><span class="quoted"><span>"</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Let|const"><span>Let</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span>n</span></span><span class="main"><span>::</span></span><a class="entity_ref" href="../../../../../Nat.html#Nat.nat|type"><span>nat</span></a><span class="main"><span>)</span></span><span> </span><span class="free"><span>f</span></span><span> </span><span class="main"><span>≡</span></span><span> </span><span class="free"><span>f</span></span><span> </span><span class="free"><span>n</span></span><span>"</span></span><span> </span><span class="quasi_keyword"><span>by</span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../../Provers/classical.ML.html#HOL.rule|method"><span class="operator"><span>rule</span></span></a><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.Let_def|fact"><span>Let_def</span></a><span class="main"><span>)</span></span><span class="antiquote"><span>}</span></span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>drop_nat_int_conv</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Conv.rewr_conv</span><span> </span><span class="main"><span>(</span></span><span>Thm.symmetric</span><span> </span><span class="entity"><span>nat_int_thm</span></span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>nat_to_int_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>
    </span><span>Conv.top_conv</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>Conv.try_conv</span><span> </span><span class="entity"><span>unfold_nat_let_conv</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>then_conv</span><span>
    </span><span>Conv.top_sweep_conv</span><span> </span><span class="entity"><span>nat_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>then_conv</span><span>
    </span><span>Conv.top_conv</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>Conv.try_conv</span><span> </span><span class="entity"><span>drop_nat_int_conv</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ct</span></span><span>

  </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>nat_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>
      </span><span>Conv.rewrs_conv</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nat_int_thm</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>nat_int_comp_thms</span></span><span class="main"><span>)</span></span><span> </span><span>then_conv</span><span>
      </span><span>Conv.top_sweep_conv</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>int_ops_conv</span></span><span> </span><span class="entity"><span>nat_to_int_conv</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ct</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_int_of_nat</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="entity"><span>cu</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>q</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Nat.html#Nat.semiring_1_class.of_nat|const"><span>of_nat</span></a><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Int.html#Int.int|type"><span>int</span></a><span>›</span></span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Term.exists_subterm</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconv</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="entity"><span>cu</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span>true</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cts</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>q</span></span><span class="main"><span>,</span></span><span> </span><span>insert</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconvc</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cu</span></span><span> </span><span class="entity"><span>cts</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>q</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_apps</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=</span></span><span> 
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cu1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cu2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.dest_comb</span><span> </span><span class="entity"><span>ct</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="entity"><span>cu1</span></span><span> </span><span class="entity"><span>cu2</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>add_apps</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="entity"><span>cu1</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>add_apps</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="entity"><span>cu2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cv</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cu</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.dest_abs_global</span><span> </span><span class="entity"><span>ct</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>add_apps</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="entity"><span>cv</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>vs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cu</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>int_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>lemma</span></span><span> </span><span class="quoted"><span>"</span><span class="main"><span>(</span></span><span class="main"><a class="entity_ref" href="../../../../../Groups.html#Groups.zero_class.zero|const"><span>0</span></a></span><span class="main"><span>::</span></span><a class="entity_ref" href="../../../../../Int.html#Int.int|type"><span>int</span></a><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../Orderings.html#Orderings.ord_class.less_eq|const"><span>&lt;=</span></a></span><span> </span><a class="entity_ref" href="../../../../../Int.html#Int.int|const"><span>int</span></a><span> </span><span class="main"><span>(</span></span><span class="free"><span>n</span></span><span class="main"><span>::</span></span><a class="entity_ref" href="../../../../../Nat.html#Nat.nat|type"><span>nat</span></a><span class="main"><span>)</span></span><span>"</span></span><span> </span><span class="quasi_keyword"><span>by</span></span><span> </span><span class="operator"><span>simp</span></span><span class="antiquote"><span>}</span></span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nat_int_thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>lemma</span></span><span>
    </span><span class="quoted"><span>"</span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.All|const"><span>∀</span></a></span><span class="bound"><span>n</span></span><span class="main"><span>::</span></span><a class="entity_ref" href="../../../../../Nat.html#Nat.nat|type"><span>nat</span></a><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.All|const"><span>.</span></a></span><span> </span><span class="main"><span>(</span></span><span class="main"><a class="entity_ref" href="../../../../../Groups.html#Groups.zero_class.zero|const"><span>0</span></a></span><span class="main"><span>::</span></span><a class="entity_ref" href="../../../../../Int.html#Int.int|type"><span>int</span></a><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../Orderings.html#Orderings.ord_class.less_eq|const"><span>&lt;=</span></a></span><span> </span><a class="entity_ref" href="../../../../../Int.html#Int.int|const"><span>int</span></a><span> </span><span class="bound"><span>n</span></span><span>"</span></span><span>
    </span><span class="quoted"><span>"</span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.All|const"><span>∀</span></a></span><span class="bound"><span>n</span></span><span class="main"><span>::</span></span><a class="entity_ref" href="../../../../../Nat.html#Nat.nat|type"><span>nat</span></a><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.All|const"><span>.</span></a></span><span> </span><a class="entity_ref" href="../../../../../Int.html#Int.nat|const"><span>nat</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../../../../Int.html#Int.int|const"><span>int</span></a><span> </span><span class="bound"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>=</span></a></span><span> </span><span class="bound"><span>n</span></span><span>"</span></span><span>
    </span><span class="quoted"><span>"</span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.All|const"><span>∀</span></a></span><span class="bound"><span>i</span></span><span class="main"><span>::</span></span><a class="entity_ref" href="../../../../../Int.html#Int.int|type"><span>int</span></a><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.All|const"><span>.</span></a></span><span> </span><a class="entity_ref" href="../../../../../Int.html#Int.int|const"><span>int</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../../../../Int.html#Int.nat|const"><span>nat</span></a><span> </span><span class="bound"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>=</span></a></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><a class="entity_ref" href="../../../../../HOL.html#HOL.If|const"><span>if</span></a></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../Groups.html#Groups.zero_class.zero|const"><span>0</span></a></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../Orderings.html#Orderings.ord_class.less_eq|const"><span>&lt;=</span></a></span><span> </span><span class="bound"><span>i</span></span><span> </span><span class="keyword1"><a class="entity_ref" href="../../../../../HOL.html#HOL.If|const"><span>then</span></a></span><span> </span><span class="bound"><span>i</span></span><span> </span><span class="keyword1"><a class="entity_ref" href="../../../../../HOL.html#HOL.If|const"><span>else</span></a></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../Groups.html#Groups.zero_class.zero|const"><span>0</span></a></span><span class="main"><span>)</span></span><span>"</span></span><span>
    </span><span class="quasi_keyword"><span>by</span></span><span> </span><span class="operator"><span>simp_all</span></span><span class="antiquote"><span>}</span></span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>var</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.dest_Var</span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="main"><span>(</span></span><span>funpow</span><span> </span><span class="inner_numeral"><span>3</span></span><span> </span><span>Thm.dest_arg</span><span> </span><span class="main"><span>(</span></span><span>Thm.cprop_of</span><span> </span><span class="entity"><span>int_thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>nat_as_int_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>SMT_Util.if_exists_conv</span></span><span> </span><span class="entity"><span>is_nat_const</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nat_to_int_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_int_of_nat_constraints</span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>q</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_apps</span></span><span> </span><span class="entity"><span>add_int_of_nat</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span>o</span><span> </span><span>Thm.cprop_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>q</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nat_int_thms</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thms</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Thm.instantiate</span><span> </span><span class="main"><span>(</span></span><span>TVars.empty</span><span class="main"><span>,</span></span><span> </span><span>Vars.make</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>var</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ct</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>int_thm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cts</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>setup_nat_as_int</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>SMT_Builtin.add_builtin_typ_ext</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Nat.html#Nat.nat|type"><span>nat</span></a><span>›</span></span></span><span class="main"><span>,</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>SMT_Config.nat_as_int</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>#&gt;</span><span>
  </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMT_Builtin.add_builtin_fun_ext'</span></span><span> </span><span>o</span><span> </span><span>Term.dest_Const</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>simple_nat_ops</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(** normalize numerals **)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
  </span><span class="comment1"><span>(*
    rewrite Numeral1 into 1
    rewrite - 0 into 0
  *)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_irregular_number</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Num.html#Num.numeral_class.numeral|const"><span>numeral</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Num.html#Num.num.One|const"><span>num.One</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>true</span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_irregular_number</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Groups.html#Groups.uminus_class.uminus|const"><span>uminus</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Groups.html#Groups.zero_class.zero|const"><span>Groups.zero</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>true</span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_irregular_number</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_strange_number</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>is_irregular_number</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>SMT_Builtin.is_builtin_num</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>proper_num_ss</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>simpset_of</span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>HOL_ss</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span><span class="hidden">\&lt;^</span><span class="control">context</span><span class="hidden">&gt;</span></span></span></span></span><span> </span><span>addsimps</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Num.html#Num.numeral_class.numeral.numeral_One|fact"><span>Num.numeral_One</span></a><span> </span><a class="entity_ref" href="../../../../../Groups.html#Groups.group_add_class.minus_zero|fact"><span>minus_zero</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>norm_num_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>SMT_Util.if_conv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_strange_number</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Simplifier.rewrite</span></span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>proper_num_ss</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>Conv.no_conv</span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>normalize_numerals_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>SMT_Util.if_exists_conv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_strange_number</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Conv.top_sweep_conv</span><span> </span><span class="entity"><span>norm_num_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(** combined unfoldings and rewritings **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>burrow_ids</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>ithms</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>split_list</span><span> </span><span class="entity"><span>ithms</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thms'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extra_thms</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>thms</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>thms'</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>SMT_Util.Axiom</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>extra_thms</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unfold_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>rewrite_case_bool_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>then_conv</span><span>
  </span><span class="entity"><span>unfold_abs_min_max_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>then_conv</span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>SMT_Config.nat_as_int</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>nat_as_int_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Conv.all_conv</span><span class="main"><span>)</span></span><span> </span><span>then_conv</span><span>
  </span><span>Thm.beta_conversion</span><span> </span><span>true</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unfold_polymorph</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>Conv.fconv_rule</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unfold_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unfold_monomorph</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>Conv.fconv_rule</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>normalize_numerals_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span>#&gt;</span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>SMT_Config.nat_as_int</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>burrow_ids</span></span><span> </span><span class="entity"><span>add_int_of_nat_constraints</span></span><span>


</span><span class="comment1"><span>(* overall normalization *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>extra_norm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> * </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> * </span><span>thm</span><span> </span><span>list</span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Extra_Norms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Generic_Data</span><span>
</span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>extra_norm</span></span><span> </span><span class="entity"><span>SMT_Util.dict</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>merge</span></span><span> </span><span class="entity"><span>data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>SMT_Util.dict_merge</span></span><span> </span><span>fst</span><span> </span><span class="entity"><span>data</span></span><span>
</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_extra_norm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>norm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Extra_Norms.map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SMT_Util.dict_update</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>norm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>apply_extra_norms</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ithms</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>SMT_Config.solver_class_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>es</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>SMT_Util.dict_lookup</span></span><span> </span><span class="main"><span>(</span></span><span>Extra_Norms.get</span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cs</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>burrow_ids</span></span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>es</span></span><span> </span><span>o</span><span> </span><span>rpair</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ithms</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ignored</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.All|const"><span>All</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Ex|const"><span>Ex</span></a><span>›</span></span><span class="main"><span>,</span></span><span>
    </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Let|const"><span>Let</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.If|const"><span>If</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span class="main"><span>]</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>schematic_consts_of</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>collect</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../SMT.html#SMT.trigger|const"><span>trigger</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>t</span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>collect_trigger</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>collect</span></span><span> </span><span class="entity"><span>t</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>collect</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>collect</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>collect</span></span><span> </span><span class="entity"><span>u</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>collect</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>collect</span></span><span> </span><span class="entity"><span>t</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>collect</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ignored</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>Monomorph.add_schematic_consts_of</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>I</span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>collect</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>
      </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>collect_trigger</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dest</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>these</span><span> </span><span>o</span><span> </span><span>try</span><span> </span><span class="entity"><span>SMT_Util.dest_symb_list</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="entity"><span>collect_pat</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>dest</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>collect_pat</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../SMT.html#SMT.pat|const"><span>pat</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>collect</span></span><span> </span><span class="entity"><span>t</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>collect_pat</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../SMT.html#SMT.nopat|const"><span>nopat</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>collect</span></span><span> </span><span class="entity"><span>t</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>collect_pat</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>collect</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>Symtab.empty</span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>monomorph</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>xthms</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>xs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>split_list</span><span> </span><span class="entity"><span>xthms</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thms</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>Monomorph.monomorph</span></span><span> </span><span class="entity"><span>schematic_consts_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span>|&gt;</span><span> </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span>uncurry</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>o</span><span> </span><span>pair</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>map2</span><span> </span><span>pair</span><span> </span><span class="entity"><span>xs</span></span><span> </span><span>o</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>normalize</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>wthms</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>wthms</span></span><span>
  </span><span>|&gt;</span><span> </span><span>map_index</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>role</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>role</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span>|&gt;</span><span> </span><span class="entity"><span>gen_normalize</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span>|&gt;</span><span> </span><span class="entity"><span>unfold_polymorph</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span>|&gt;</span><span> </span><span class="entity"><span>monomorph</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span>|&gt;</span><span> </span><span class="entity"><span>unfold_monomorph</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span>|&gt;</span><span> </span><span class="entity"><span>apply_extra_norms</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Theory.setup</span><span> </span><span class="main"><span>(</span></span><span>Context.theory_map</span><span> </span><span class="main"><span>(</span></span><span>
  </span><span class="entity"><span>setup_atomize</span></span><span> </span><span>#&gt;</span><span>
  </span><span class="entity"><span>setup_unfolded_quants</span></span><span> </span><span>#&gt;</span><span>
  </span><span class="entity"><span>setup_trigger</span></span><span> </span><span>#&gt;</span><span>
  </span><span class="entity"><span>setup_case_bool</span></span><span> </span><span>#&gt;</span><span>
  </span><span class="entity"><span>setup_abs_min_max</span></span><span> </span><span>#&gt;</span><span>
  </span><span class="entity"><span>setup_nat_as_int</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
</span></pre>
</body>

</html>