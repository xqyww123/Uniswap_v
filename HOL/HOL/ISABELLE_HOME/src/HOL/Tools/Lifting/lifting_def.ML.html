<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Tools/Lifting/lifting_def.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Tools/Lifting/lifting_def.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      HOL/Tools/Lifting/lifting_def.ML
    Author:     Ondrej Kuncar

Definitions for constants on quotient types.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>LIFTING_DEF</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>code_eq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>UNKNOWN_EQ</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>NONE_EQ</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ABS_EQ</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>REP_EQ</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>lift_def</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> rty_of_lift_def</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>lift_def</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> qty_of_lift_def</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>lift_def</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> rhs_of_lift_def</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>lift_def</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> lift_const_of_lift_def</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>lift_def</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> def_thm_of_lift_def</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>lift_def</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> rsp_thm_of_lift_def</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>lift_def</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> abs_eq_of_lift_def</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>lift_def</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> rep_eq_of_lift_def</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>lift_def</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> code_eq_of_lift_def</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>lift_def</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>code_eq</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> transfer_rules_of_lift_def</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>lift_def</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> morph_lift_def</span><span class="main"><span>:</span></span><span> </span><span>morphism</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>lift_def</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>lift_def</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> inst_of_lift_def</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>lift_def</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>lift_def</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_lift_const_of_lift_def</span><span class="main"><span>:</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>lift_def</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>config</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span> </span><span>notes</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>}</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> map_config</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>config</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>config</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> default_config</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>config</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> generate_parametric_transfer_rule</span><span class="main"><span>:</span></span><span>
    </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_lift_def</span><span class="main"><span>:</span></span><span>
    </span><span class="entity"><span>config</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>binding</span><span> * </span><span>mixfix</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span>
      </span><span class="entity"><span>lift_def</span></span><span> * </span><span>local_theory</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> prepare_lift_def</span><span class="main"><span>:</span></span><span>
    </span><span class="main"><span>(</span></span><span>binding</span><span> * </span><span>mixfix</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
      </span><span class="entity"><span>lift_def</span></span><span> * </span><span>local_theory</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span>binding</span><span> * </span><span>mixfix</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span>term</span><span> </span><span>option</span><span> * </span><span class="main"><span>(</span></span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>lift_def</span></span><span> * </span><span>local_theory</span><span class="main"><span>)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> gen_lift_def</span><span class="main"><span>:</span></span><span>
    </span><span class="main"><span>(</span></span><span>binding</span><span> * </span><span>mixfix</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span>
      </span><span class="entity"><span>lift_def</span></span><span> * </span><span>local_theory</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span>binding</span><span> * </span><span>mixfix</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>lift_def</span></span><span> * </span><span>local_theory</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> lift_def</span><span class="main"><span>:</span></span><span>
    </span><span class="entity"><span>config</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>binding</span><span> * </span><span>mixfix</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>lift_def</span></span><span> * </span><span>local_theory</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> can_generate_code_cert</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Lifting_Def</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>LIFTING_DEF</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Lifting_Util</span><span>

</span><span class="keyword1"><span class="keyword"><span>infix</span></span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> MRSL

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>code_eq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>UNKNOWN_EQ</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>NONE_EQ</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ABS_EQ</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>REP_EQ</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>lift_def</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LIFT_DEF</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>{</span></span><span>
  rty</span><span class="main"><span>:</span></span><span> typ</span><span class="main"><span>,</span></span><span>
  qty</span><span class="main"><span>:</span></span><span> typ</span><span class="main"><span>,</span></span><span>
  rhs</span><span class="main"><span>:</span></span><span> term</span><span class="main"><span>,</span></span><span>
  lift_const</span><span class="main"><span>:</span></span><span> term</span><span class="main"><span>,</span></span><span>
  def_thm</span><span class="main"><span>:</span></span><span> thm</span><span class="main"><span>,</span></span><span>
  rsp_thm</span><span class="main"><span>:</span></span><span> thm</span><span class="main"><span>,</span></span><span>
  abs_eq</span><span class="main"><span>:</span></span><span> thm</span><span class="main"><span>,</span></span><span>
  rep_eq</span><span class="main"><span>:</span></span><span> thm option</span><span class="main"><span>,</span></span><span>
  code_eq</span><span class="main"><span>:</span></span><span> code_eq</span><span class="main"><span>,</span></span><span>
  transfer_rules</span><span class="main"><span>:</span></span><span> thm list
</span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rep_lift_def</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>LIFT_DEF</span></span><span> </span><span class="entity"><span>lift_def</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lift_def</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rty_of_lift_def</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>rty</span><span> </span><span>o</span><span> </span><span class="entity"><span>rep_lift_def</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>qty_of_lift_def</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>qty</span><span> </span><span>o</span><span> </span><span class="entity"><span>rep_lift_def</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rhs_of_lift_def</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>rhs</span><span> </span><span>o</span><span> </span><span class="entity"><span>rep_lift_def</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lift_const_of_lift_def</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>lift_const</span><span> </span><span>o</span><span> </span><span class="entity"><span>rep_lift_def</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>def_thm_of_lift_def</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>def_thm</span><span> </span><span>o</span><span> </span><span class="entity"><span>rep_lift_def</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rsp_thm_of_lift_def</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>rsp_thm</span><span> </span><span>o</span><span> </span><span class="entity"><span>rep_lift_def</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>abs_eq_of_lift_def</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>abs_eq</span><span> </span><span>o</span><span> </span><span class="entity"><span>rep_lift_def</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rep_eq_of_lift_def</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>rep_eq</span><span> </span><span>o</span><span> </span><span class="entity"><span>rep_lift_def</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>code_eq_of_lift_def</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>code_eq</span><span> </span><span>o</span><span> </span><span class="entity"><span>rep_lift_def</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>transfer_rules_of_lift_def</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>transfer_rules</span><span> </span><span>o</span><span> </span><span class="entity"><span>rep_lift_def</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_lift_def</span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="entity"><span>qty</span></span><span> </span><span class="entity"><span>rhs</span></span><span> </span><span class="entity"><span>lift_const</span></span><span> </span><span class="entity"><span>def_thm</span></span><span> </span><span class="entity"><span>rsp_thm</span></span><span> </span><span class="entity"><span>abs_eq</span></span><span> </span><span class="entity"><span>rep_eq</span></span><span> </span><span class="entity"><span>code_eq</span></span><span> </span><span class="entity"><span>transfer_rules</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>LIFT_DEF</span></span><span> </span><span class="main"><span>{</span></span><span>rty</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span>qty</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>,</span></span><span>
            </span><span>rhs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>,</span></span><span> </span><span>lift_const</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lift_const</span></span><span class="main"><span>,</span></span><span>
            </span><span>def_thm</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>def_thm</span></span><span class="main"><span>,</span></span><span> </span><span>rsp_thm</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rsp_thm</span></span><span class="main"><span>,</span></span><span> </span><span>abs_eq</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>abs_eq</span></span><span class="main"><span>,</span></span><span> </span><span>rep_eq</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rep_eq</span></span><span class="main"><span>,</span></span><span>
            </span><span>code_eq</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>code_eq</span></span><span class="main"><span>,</span></span><span> </span><span>transfer_rules</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>transfer_rules</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_lift_def</span></span><span> </span><span class="entity"><span>f1</span></span><span> </span><span class="entity"><span>f2</span></span><span> </span><span class="entity"><span>f3</span></span><span> </span><span class="entity"><span>f4</span></span><span> </span><span class="entity"><span>f5</span></span><span> </span><span class="entity"><span>f6</span></span><span> </span><span class="entity"><span>f7</span></span><span> </span><span class="entity"><span>f8</span></span><span> </span><span class="entity"><span>f9</span></span><span> </span><span class="entity"><span>f10</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>LIFT_DEF</span></span><span> </span><span class="main"><span>{</span></span><span>rty</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span>qty</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>,</span></span><span> </span><span>rhs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>,</span></span><span> </span><span>lift_const</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lift_const</span></span><span class="main"><span>,</span></span><span>
  </span><span>def_thm</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>def_thm</span></span><span class="main"><span>,</span></span><span> </span><span>rsp_thm</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rsp_thm</span></span><span class="main"><span>,</span></span><span> </span><span>abs_eq</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>abs_eq</span></span><span class="main"><span>,</span></span><span> </span><span>rep_eq</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rep_eq</span></span><span class="main"><span>,</span></span><span> </span><span>code_eq</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>code_eq</span></span><span class="main"><span>,</span></span><span>
  </span><span>transfer_rules</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>transfer_rules</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>LIFT_DEF</span></span><span> </span><span class="main"><span>{</span></span><span>rty</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f1</span></span><span> </span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span>qty</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f2</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>,</span></span><span> </span><span>rhs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f3</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>,</span></span><span> </span><span>lift_const</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f4</span></span><span> </span><span class="entity"><span>lift_const</span></span><span class="main"><span>,</span></span><span>
            </span><span>def_thm</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f5</span></span><span> </span><span class="entity"><span>def_thm</span></span><span class="main"><span>,</span></span><span> </span><span>rsp_thm</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f6</span></span><span> </span><span class="entity"><span>rsp_thm</span></span><span class="main"><span>,</span></span><span> </span><span>abs_eq</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f7</span></span><span> </span><span class="entity"><span>abs_eq</span></span><span class="main"><span>,</span></span><span> </span><span>rep_eq</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f8</span></span><span> </span><span class="entity"><span>rep_eq</span></span><span class="main"><span>,</span></span><span>
            </span><span>code_eq</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f9</span></span><span> </span><span class="entity"><span>code_eq</span></span><span class="main"><span>,</span></span><span> </span><span>transfer_rules</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f10</span></span><span> </span><span class="entity"><span>transfer_rules</span></span><span> </span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>morph_lift_def</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mtyp</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Morphism.typ</span><span> </span><span class="entity"><span>phi</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mterm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Morphism.term</span><span> </span><span class="entity"><span>phi</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mthm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Morphism.thm</span><span> </span><span class="entity"><span>phi</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>map_lift_def</span></span><span> </span><span class="entity"><span>mtyp</span></span><span> </span><span class="entity"><span>mtyp</span></span><span> </span><span class="entity"><span>mterm</span></span><span> </span><span class="entity"><span>mterm</span></span><span> </span><span class="entity"><span>mthm</span></span><span> </span><span class="entity"><span>mthm</span></span><span> </span><span class="entity"><span>mthm</span></span><span> </span><span class="main"><span>(</span></span><span>Option.map</span><span> </span><span class="entity"><span>mthm</span></span><span class="main"><span>)</span></span><span> </span><span>I</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>mthm</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_inst_of_lift_def</span></span><span> </span><span class="entity"><span>qty</span></span><span> </span><span class="entity"><span>lift_def</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Vartab.empty</span><span> </span><span>|&gt;</span><span> </span><span>Type.raw_match</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>qty_of_lift_def</span></span><span> </span><span class="entity"><span>lift_def</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_lift_const_of_lift_def</span></span><span> </span><span class="entity"><span>qty</span></span><span> </span><span class="entity"><span>lift_def</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Envir.subst_term_types</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_inst_of_lift_def</span></span><span> </span><span class="entity"><span>qty</span></span><span> </span><span class="entity"><span>lift_def</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>lift_const_of_lift_def</span></span><span> </span><span class="entity"><span>lift_def</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>inst_of_lift_def</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>qty</span></span><span> </span><span class="entity"><span>lift_def</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>instT</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Vartab.fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>S</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>cons</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.ctyp_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>mk_inst_of_lift_def</span></span><span> </span><span class="entity"><span>qty</span></span><span> </span><span class="entity"><span>lift_def</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Morphism.instantiate_morphism</span><span> </span><span class="main"><span>(</span></span><span>TVars.make</span><span> </span><span class="entity"><span>instT</span></span><span class="main"><span>,</span></span><span> </span><span>Vars.empty</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>morph_lift_def</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>lift_def</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(* Config *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>config</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span> </span><span>notes</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_config</span></span><span> </span><span class="entity"><span>f1</span></span><span> </span><span class="main"><span>{</span></span><span> </span><span>notes</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>notes</span></span><span> </span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span> </span><span>notes</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f1</span></span><span> </span><span class="entity"><span>notes</span></span><span> </span><span class="main"><span>}</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>default_config</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span> </span><span>notes</span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span> </span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* Reflexivity prover *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mono_eq_prover</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>prop</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>refl_rules</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Lifting_Info.get_reflexivity_rules</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>transfer_rules</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Transfer.get_transfer_raw</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>main_tac</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>REPEAT_ALL_NEW</span><span> </span><span class="main"><span>(</span></span><span>DETERM</span><span> </span><span>o</span><span> </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>refl_rules</span></span><span class="main"><span>)</span></span><span> </span><span>THEN_ALL_NEW</span><span>
      </span><span class="main"><span>(</span></span><span>REPEAT_ALL_NEW</span><span> </span><span class="main"><span>(</span></span><span>DETERM</span><span> </span><span>o</span><span> </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>transfer_rules</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Goal.prove</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>prop</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>main_tac</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>ERROR</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>try_prove_refl_rel</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rel</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_ge_eq</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>x</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Orderings.html#Orderings.ord_class.less_eq|const"><span>less_eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>HOLogic.boolT</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span>
          </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>x</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_ge_eq</span></span><span> </span><span class="entity"><span>rel</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
     </span><span class="entity"><span>mono_eq_prover</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>goal</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>try_prove_reflexivity</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>prop</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cprop</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>prop</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../BNF_Def.html#BNF_Def.ge_eq_refl|fact"><span>ge_eq_refl</span></a><span class="antiquote"><span>}</span></span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>concl_pat</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Drule.strip_imp_concl</span><span> </span><span class="main"><span>(</span></span><span>Thm.cprop_of</span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>insts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.first_order_match</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>concl_pat</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cprop</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Drule.instantiate_normalize</span><span> </span><span class="entity"><span>insts</span></span><span> </span><span class="entity"><span>rule</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prop</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>hd</span><span> </span><span class="main"><span>(</span></span><span>Thm.prems_of</span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>mono_eq_prover</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>prop</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>SOME</span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(*
  Generates a parametrized transfer rule.
  transfer_rule - of the form T t f
  parametric_transfer_rule - of the form par_R t' t

  Result: par_T t' f, after substituing op= for relations in par_R that relate
    a type constructor to the same type constructor, it is a merge of (par_R' OO T) t' f
    using Lifting_Term.merge_transfer_relations
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>generate_parametric_transfer_rule</span></span><span> </span><span class="entity"><span>ctxt0</span></span><span> </span><span class="entity"><span>transfer_rule</span></span><span> </span><span class="entity"><span>parametric_transfer_rule</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>preprocess</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>strip_args</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span>o</span><span> </span><span>Thm.concl_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>param_rel</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>o</span><span> </span><span>dest_comb</span><span> </span><span>o</span><span> </span><span>fst</span><span> </span><span>o</span><span> </span><span>dest_comb</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>free_vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.add_vars</span><span> </span><span class="entity"><span>param_rel</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_subst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>xi</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rty'</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>binder_types</span><span> </span><span class="entity"><span>typ</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Term.is_TVar</span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>Term.is_Type</span><span> </span><span class="entity"><span>rty'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>xi</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.eq_const</span></span><span> </span><span class="entity"><span>rty'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>subst</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
              </span><span class="entity"><span>subst</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inst_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>infer_instantiate</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="entity"><span>make_subst</span></span><span> </span><span class="entity"><span>free_vars</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>Conv.fconv_rule</span><span>
          </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Conv.concl_conv</span><span> </span><span class="main"><span>(</span></span><span>Thm.nprems_of</span><span> </span><span class="entity"><span>inst_thm</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span>
            </span><span class="entity"><span>HOLogic.Trueprop_conv</span></span><span> </span><span>o</span><span> </span><span>Conv.fun2_conv</span><span> </span><span>o</span><span> </span><span>Conv.arg1_conv</span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>(</span></span><span>Raw_Simplifier.rewrite</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>false</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Transfer.get_sym_relator_eq</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>inst_thm</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>inst_relcomppI</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ant1</span></span><span> </span><span class="entity"><span>ant2</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span>o</span><span> </span><span>Thm.concl_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ant1</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span>o</span><span> </span><span>Thm.prop_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ant2</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fun1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>strip_args</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="entity"><span>t1</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>args1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_args</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="entity"><span>t1</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fun2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>strip_args</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>args2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_args</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>relcomppI</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Drule.incr_indexes2</span><span> </span><span class="entity"><span>ant1</span></span><span> </span><span class="entity"><span>ant2</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Relation.html#Relation.relcomppI|fact"><span>relcomppI</span></a><span class="antiquote"><span>}</span></span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="main"><span>(</span></span><span>Term.add_vars</span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>relcomppI</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>infer_instantiate</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vars</span></span><span> </span><span>~~</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>fun1</span></span><span class="main"><span>]</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>args1</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>fun2</span></span><span class="main"><span>]</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>args2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>relcomppI</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>zip_transfer_rules</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_POS</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.POS|const"><span>POS</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>ty</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>HOLogic.boolT</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rel</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.dest_fun2</span><span> </span><span>o</span><span> </span><span>Thm.dest_arg</span><span> </span><span>o</span><span> </span><span>Thm.cprop_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>typ</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.typ_of_cterm</span><span> </span><span class="entity"><span>rel</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>POS_const</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_POS</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>var</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"X"</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.maxidx_of_cterm</span><span> </span><span class="entity"><span>rel</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>Thm.apply</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>HOLogic.Trueprop</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.apply</span><span> </span><span class="main"><span>(</span></span><span>Thm.apply</span><span> </span><span class="entity"><span>POS_const</span></span><span> </span><span class="entity"><span>rel</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>var</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>[</span></span><span class="entity"><span>Lifting_Term.merge_transfer_relations</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>MRSL</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.POS_apply|fact"><span>POS_apply</span></a><span class="antiquote"><span>}</span></span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>inst_relcomppI</span></span><span> </span><span class="entity"><span>ctxt0</span></span><span> </span><span class="entity"><span>parametric_transfer_rule</span></span><span> </span><span class="entity"><span>transfer_rule</span></span><span>
        </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>parametric_transfer_rule</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>transfer_rule</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>preprocessed_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>preprocess</span></span><span> </span><span class="entity"><span>ctxt0</span></span><span> </span><span class="entity"><span>thm</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fixed_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt0</span></span><span>
      </span><span>|&gt;</span><span> </span><span>yield_singleton</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span>snd</span><span> </span><span>oo</span><span> </span><span>Variable.import</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>preprocessed_thm</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>assms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>cprems_of</span><span> </span><span class="entity"><span>fixed_thm</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>add_transfer_rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.attribute_declaration</span><span> </span><span class="entity"><span>Transfer.transfer_add</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt1</span></span><span> </span><span>|&gt;</span><span> </span><span>fold_map</span><span> </span><span>Thm.assume_hyps</span><span> </span><span class="entity"><span>assms</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt3</span></span><span> </span><span class="main"><span>=</span></span><span>  </span><span class="entity"><span>ctxt2</span></span><span> </span><span>|&gt;</span><span> </span><span>Context.proof_map</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="entity"><span>add_transfer_rule</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>zipped_thm</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>fixed_thm</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>undisch_all</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>zip_transfer_rules</span></span><span> </span><span class="entity"><span>ctxt3</span></span><span>
      </span><span>|&gt;</span><span> </span><span>implies_intr_list</span><span> </span><span class="entity"><span>assms</span></span><span>
      </span><span>|&gt;</span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Variable.export</span><span> </span><span class="entity"><span>ctxt3</span></span><span> </span><span class="entity"><span>ctxt0</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>zipped_thm</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>print_generate_transfer_info</span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>error_msg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>cat_lines</span><span>
      </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"Generation of a parametric transfer rule failed."</span></span><span class="main"><span>,</span></span><span>
      </span><span class="main"><span>(</span></span><span>Pretty.string_of</span><span> </span><span class="main"><span>(</span></span><span>Pretty.block</span><span>
         </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"Reason:"</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>msg</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>error</span><span> </span><span class="entity"><span>error_msg</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_ter</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>x</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>map_ter</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>xs</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>generate_transfer_rules</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span> </span><span class="entity"><span>rsp_thm</span></span><span> </span><span class="entity"><span>def_thm</span></span><span> </span><span class="entity"><span>par_thms</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>transfer_rule</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>quot_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rsp_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>def_thm</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>MRSL</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.Quotient_to_transfer|fact"><span>Quotient_to_transfer</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>Lifting_Term.parametrize_transfer_rule</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>map_ter</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>generate_parametric_transfer_rule</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>transfer_rule</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>transfer_rule</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>par_thms</span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>Lifting_Term.MERGE_TRANSFER_REL</span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>print_generate_transfer_info</span></span><span> </span><span class="entity"><span>msg</span></span><span class="main"><span>;</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>transfer_rule</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(* Generation of the code certificate from the rsp theorem *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_body_types</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"fun"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>U</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"fun"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>V</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_body_types</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>U</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>V</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>get_body_types</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>U</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>V</span></span><span class="main"><span>)</span></span><span>  </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>U</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>V</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_binder_types</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"fun"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>U</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"fun"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>V</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>W</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>V</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>get_binder_types</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>U</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>W</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>get_binder_types</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_binder_types_by_rel</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../BNF_Def.html#BNF_Def.rel_fun|const"><span>rel_fun</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"fun"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>U</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"fun"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>V</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>W</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>V</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>get_binder_types_by_rel</span></span><span> </span><span class="entity"><span>S</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>U</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>W</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>get_binder_types_by_rel</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_body_type_by_rel</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../BNF_Def.html#BNF_Def.rel_fun|const"><span>rel_fun</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"fun"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>U</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"fun"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>V</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>get_body_type_by_rel</span></span><span> </span><span class="entity"><span>S</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>U</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>V</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>get_body_type_by_rel</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>U</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>V</span></span><span class="main"><span>)</span></span><span>  </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>U</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>V</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_binder_rels</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../BNF_Def.html#BNF_Def.rel_fun|const"><span>rel_fun</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>R</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>get_binder_rels</span></span><span> </span><span class="entity"><span>S</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>get_binder_rels</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>force_rty_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="entity"><span>rhs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rhs_schematic</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Variable.polymorphic</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rhs</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rty_schematic</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>rhs_schematic</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>match</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Sign.typ_match</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty_schematic</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rty</span></span><span class="main"><span>)</span></span><span> </span><span>Vartab.empty</span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>Envir.subst_term_types</span><span> </span><span class="entity"><span>match</span></span><span> </span><span class="entity"><span>rhs_schematic</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unabs_def</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>def</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.dest_equals</span><span> </span><span class="main"><span>(</span></span><span>Thm.cprop_of</span><span> </span><span class="entity"><span>def</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_abs</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>var_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>var_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dest_abs</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"get_abs_var"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>tm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>var_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_abs</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>new_var_names</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.variant_fixes</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>var_name</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>refl_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.reflexive</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>new_var_names</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>Thm.combination</span><span> </span><span class="entity"><span>def</span></span><span> </span><span class="entity"><span>refl_thm</span></span><span> </span><span>|&gt;</span><span>
    </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.export</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unabs_all_def</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>def</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.dest_equals</span><span> </span><span class="main"><span>(</span></span><span>Thm.cprop_of</span><span> </span><span class="entity"><span>def</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>strip_abs_vars</span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unabs_def</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="entity"><span>def</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>map_fun_unfolded</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Fun.html#Fun.map_fun_def|fact"><span>map_fun_def</span></a><span class="main"><span>[</span></span><span class="operator"><span>abs_def</span></span><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span>|&gt;</span><span>
  </span><span class="entity"><span>unabs_def</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span><span class="hidden">\&lt;^</span><span class="control">context</span><span class="hidden">&gt;</span></span></span></span></span><span> </span><span>|&gt;</span><span>
  </span><span class="entity"><span>unabs_def</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span><span class="hidden">\&lt;^</span><span class="control">context</span><span class="hidden">&gt;</span></span></span></span></span><span> </span><span>|&gt;</span><span>
  </span><span>Local_Defs.unfold0</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span><span class="hidden">\&lt;^</span><span class="control">context</span><span class="hidden">&gt;</span></span></span></span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Fun.html#Fun.comp_def|fact"><span>comp_def</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unfold_fun_maps</span></span><span> </span><span class="entity"><span>ctm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unfold_conv</span></span><span> </span><span class="entity"><span>ctm</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="entity"><span>ctm</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Fun.html#Fun.map_fun|const"><span>map_fun</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="main"><span>(</span></span><span>Conv.arg_conv</span><span> </span><span class="entity"><span>unfold_conv</span></span><span> </span><span>then_conv</span><span> </span><span>Conv.rewr_conv</span><span> </span><span class="entity"><span>map_fun_unfolded</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctm</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Conv.all_conv</span><span> </span><span class="entity"><span>ctm</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span>Conv.fun_conv</span><span> </span><span class="entity"><span>unfold_conv</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctm</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unfold_fun_maps_beta</span></span><span> </span><span class="entity"><span>ctm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>try_beta_conv</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Conv.try_conv</span><span> </span><span class="main"><span>(</span></span><span>Thm.beta_conversion</span><span> </span><span>false</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>unfold_fun_maps</span></span><span> </span><span>then_conv</span><span> </span><span class="entity"><span>try_beta_conv</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctm</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prove_rel</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rsp_thm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ty_args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_binder_types</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>disch_arg</span></span><span> </span><span class="entity"><span>args_ty</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>quot_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Lifting_Term.prove_quot_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>args_ty</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>[</span></span><span class="entity"><span>quot_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>MRSL</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.apply_rsp&apos;&apos;|fact"><span>apply_rsp''</span></a><span class="antiquote"><span>}</span></span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>fold</span><span> </span><span class="entity"><span>disch_arg</span></span><span> </span><span class="entity"><span>ty_args</span></span><span> </span><span class="entity"><span>rsp_thm</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>CODE_CERT_GEN</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>string</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>simplify_code_eq</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>def_thm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Local_Defs.unfold0</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Fun.html#Fun.o_apply|fact"><span>o_apply</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Fun.html#Fun.map_fun_def|fact"><span>map_fun_def</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Fun.html#Fun.id_apply|fact"><span>id_apply</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>def_thm</span></span><span>

</span><span class="comment1"><span>(*
  quot_thm - quotient theorem (Quotient R Abs Rep T).
  returns: whether the Lifting package is capable to generate code for the abstract type
    represented by quot_thm
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>can_generate_code_cert</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span>  </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>quot_thm_rel</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../BNF_Def.html#BNF_Def.eq_onp|const"><span>eq_onp</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span>  </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>generate_rep_eq</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>def_thm</span></span><span> </span><span class="entity"><span>rsp_thm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>unfolded_def</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Conv.fconv_rule</span><span> </span><span class="main"><span>(</span></span><span>Conv.arg_conv</span><span> </span><span class="entity"><span>unfold_fun_maps_beta</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>def_thm</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>unabs_def</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unabs_all_def</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>unfolded_def</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>body_type</span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>body_type</span><span> </span><span class="entity"><span>qty</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>simplify_code_eq</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_obj_eq</span></span><span> </span><span class="entity"><span>unabs_def</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>quot_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Lifting_Term.prove_quot_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_body_types</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rel_fun</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prove_rel</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rsp_thm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rep_abs_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>quot_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rel_fun</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>MRSL</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.Quotient_rep_abs_eq|fact"><span>Quotient_rep_abs_eq</span></a><span class="antiquote"><span>}</span></span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>mono_eq_prover</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="main"><span>(</span></span><span>Thm.prems_of</span><span> </span><span class="entity"><span>rep_abs_thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span>SOME</span><span> </span><span class="entity"><span>mono_eq_thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rep_abs_eq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mono_eq_thm</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>rep_abs_thm</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rep</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>quot_thm_rep</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rep_refl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.mk_obj_eq</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.reflexive</span><span> </span><span class="entity"><span>rep</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>repped_eq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rep_refl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>HOLogic.mk_obj_eq</span></span><span> </span><span class="entity"><span>unabs_def</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>MRSL</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.cong|fact"><span>cong</span></a><span class="antiquote"><span>}</span></span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>code_cert</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>repped_eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rep_abs_eq</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>MRSL</span></span><span> </span><span class="entity"><span>trans</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>simplify_code_eq</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>code_cert</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>generate_abs_eq</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>def_thm</span></span><span> </span><span class="entity"><span>rsp_thm</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>abs_eq_with_assms</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>quot_thm_rty_qty</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rel</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>quot_thm_rel</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ty_args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_binder_types_by_rel</span></span><span> </span><span class="entity"><span>rel</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>body_type</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_body_type_by_rel</span></span><span> </span><span class="entity"><span>rel</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>quot_ret_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Lifting_Term.prove_quot_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>body_type</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rep_abs_folded_unmapped_thm</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rep_id</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>quot_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>def_thm</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>MRSL</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.Quotient_Rep_eq|fact"><span>Quotient_Rep_eq</span></a><span class="antiquote"><span>}</span></span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.dest_equals_lhs</span><span> </span><span class="main"><span>(</span></span><span>Thm.cprop_of</span><span> </span><span class="entity"><span>rep_id</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>unfolded_maps_eq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unfold_fun_maps</span></span><span> </span><span class="entity"><span>ctm</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>quot_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>def_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rsp_thm</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>MRSL</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.Quotient_rep_abs_fold_unmap|fact"><span>Quotient_rep_abs_fold_unmap</span></a><span class="antiquote"><span>}</span></span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prems_pat</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span>o</span><span> </span><span>Drule.cprems_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t1</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>insts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.first_order_match</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prems_pat</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.cprop_of</span><span> </span><span class="entity"><span>unfolded_maps_eq</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="entity"><span>unfolded_maps_eq</span></span><span> </span><span>RS</span><span> </span><span class="main"><span>(</span></span><span>Drule.instantiate_normalize</span><span> </span><span class="entity"><span>insts</span></span><span> </span><span class="entity"><span>t1</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>rep_abs_folded_unmapped_thm</span></span><span>
        </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Transfer.html#Transfer.rel_funD2|fact"><span>rel_funD2</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ty_args</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span>RS</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.Quotient_rel_abs2|fact"><span>Quotient_rel_abs2</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>quot_ret_thm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prem_rels</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_binder_rels</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>quot_thm_rel</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>proved_assms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prem_rels</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>try_prove_refl_rel</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>map_index</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span>is_some</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span>the</span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>assm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>assm</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../BNF_Def.html#BNF_Def.ge_eq_refl|fact"><span>ge_eq_refl</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>abs_eq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>assm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>assm</span></span><span> </span><span>RSN</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>proved_assms</span></span><span> </span><span class="entity"><span>abs_eq_with_assms</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>simplify_code_eq</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>abs_eq</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>register_code_eq_thy</span></span><span> </span><span class="entity"><span>abs_eq_thm</span></span><span> </span><span class="entity"><span>opt_rep_eq_thm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>no_abstr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>no_abstr</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>no_abstr</span></span><span> </span><span class="entity"><span>u</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>no_abstr</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>no_abstr</span></span><span> </span><span class="entity"><span>t</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>no_abstr</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Code.is_abstr</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>no_abstr</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_valid_eq</span></span><span> </span><span class="entity"><span>eqn</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>can</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Code.assert_eqn</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_meta_eq</span></span><span> </span><span class="entity"><span>eqn</span></span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>no_abstr</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>eqn</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_valid_abs_eq</span></span><span> </span><span class="entity"><span>abs_eq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>can</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Code.assert_abs_eqn</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_meta_eq</span></span><span> </span><span class="entity"><span>abs_eq</span></span><span class="main"><span>)</span></span><span>

  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_valid_eq</span></span><span> </span><span class="entity"><span>abs_eq_thm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>ABS_EQ</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Code.declare_default_eqns_global</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>abs_eq_thm</span></span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty_body</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty_body</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_body_types</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>rty_body</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>qty_body</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>REP_EQ</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Code.declare_default_eqns_global</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="entity"><span>opt_rep_eq_thm</span></span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>is_some</span><span> </span><span class="entity"><span>opt_rep_eq_thm</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>is_valid_abs_eq</span></span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="entity"><span>opt_rep_eq_thm</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>REP_EQ</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Code.declare_abstract_eqn_global</span></span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="entity"><span>opt_rep_eq_thm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>NONE_EQ</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>no_no_code</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>same_type_constrs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>no_no_code</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Targs</span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>Targs</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Term.is_Type</span><span> </span><span class="entity"><span>qty</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>Lifting_Info.is_no_code_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Tname</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>false</span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rtyq</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Lifting_Term.instantiate_rtys</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty's</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rtyqs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Targs</span></span><span> </span><span class="entity"><span>rty'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Targs</span></span><span> </span><span class="entity"><span>rtyq</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>no_no_code</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty's</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>rtyqs</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span>true</span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>encode_code_eq</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>abs_eq</span></span><span> </span><span class="entity"><span>opt_rep_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_type</span></span><span> </span><span class="entity"><span>typ</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>typ</span></span><span> </span><span>|&gt;</span><span> </span><span>Logic.mk_type</span><span> </span><span>|&gt;</span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>|&gt;</span><span> </span><span>Drule.mk_term</span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span>Conjunction.intr_balanced</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>abs_eq</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>the_default</span><span> </span><span class="entity"><span>TrueI</span></span><span> </span><span class="entity"><span>opt_rep_eq</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_type</span></span><span> </span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_type</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>DECODE</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>decode_code_eq</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Thm.nprems_of</span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>DECODE</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>abs_eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rep_eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Conjunction.elim_balanced</span><span> </span><span class="inner_numeral"><span>4</span></span><span> </span><span class="entity"><span>thm</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>opt_rep_eq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Thm.eq_thm_prop</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rep_eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>TrueI</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>NONE</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>rep_eq</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_type</span></span><span> </span><span class="entity"><span>typ</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>typ</span></span><span> </span><span>|&gt;</span><span> </span><span>Drule.dest_term</span><span> </span><span>|&gt;</span><span> </span><span>Thm.term_of</span><span> </span><span>|&gt;</span><span> </span><span>Logic.dest_type</span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>abs_eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>opt_rep_eq</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest_type</span></span><span> </span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>dest_type</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Generic_Data</span><span>
  </span><span class="main"><span>(</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>code_eq</span></span><span> </span><span>option</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>merge</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>
  </span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>register_encoded_code_eq</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>abs_eq_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>opt_rep_eq_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>decode_code_eq</span></span><span> </span><span class="entity"><span>thm</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>code_eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>register_code_eq_thy</span></span><span> </span><span class="entity"><span>abs_eq_thm</span></span><span> </span><span class="entity"><span>opt_rep_eq_thm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thy</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span>Context.theory_map</span><span> </span><span class="main"><span>(</span></span><span>Data.put</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>code_eq</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thy</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>DECODE</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>thy</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>register_code_eq_attribute</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.declaration_attribute</span><span>
    </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Context.mapping</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>register_encoded_code_eq</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>register_code_eq_attrib</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.internal</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="entity"><span>register_code_eq_attribute</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>register_code_eq</span></span><span> </span><span class="entity"><span>abs_eq_thm</span></span><span> </span><span class="entity"><span>opt_rep_eq_thm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>encoded_code_eq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>encode_code_eq</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>abs_eq_thm</span></span><span> </span><span class="entity"><span>opt_rep_eq_thm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>no_no_code</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lthy'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span>oo</span><span> </span><span>Local_Theory.note</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.empty</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>register_code_eq_attrib</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>encoded_code_eq</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>opt_code_eq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Data.get</span><span> </span><span class="main"><span>(</span></span><span>Context.Theory</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>code_eq</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>is_some</span><span> </span><span class="entity"><span>opt_code_eq</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>the</span><span> </span><span class="entity"><span>opt_code_eq</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>UNKNOWN_EQ</span></span><span> </span><span class="comment1"><span>(* UNKNOWN_EQ means that we are in a locale and we do not know
            which code equation is going to be used. This is going to be resolved at the
            point when an interpretation of the locale is executed. *)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lthy''</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lthy'</span></span><span>
          </span><span>|&gt;</span><span> </span><span>Local_Theory.declaration</span><span> </span><span class="main"><span>{</span></span><span>syntax</span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span> </span><span>pervasive</span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span class="main"><span>}</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>Data.put</span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>code_eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy''</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>NONE_EQ</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(*
  Defines an operation on an abstract type in terms of a corresponding operation
    on a representation type.

  var - a binding and a mixfix of the new constant being defined
  qty - an abstract type of the new constant
  rhs - a term representing the new constant on the raw level
  rsp_thm - a respectfulness theorem in the internal tagged form (like '(R ===&gt; R ===&gt; R) f f'),
    i.e. "(Lifting_Term.equiv_relation (fastype_of rhs, qty)) $ rhs $ rhs"
  par_thms - a parametricity theorem for rhs
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_lift_def</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>config</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>config</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>binding</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mx</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>qty</span></span><span> </span><span class="entity"><span>rhs</span></span><span> </span><span class="entity"><span>rsp_thm</span></span><span> </span><span class="entity"><span>par_thms</span></span><span> </span><span class="entity"><span>lthy0</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>rhs</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>quot_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Lifting_Term.prove_quot_thm</span></span><span> </span><span class="entity"><span>lthy0</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>absrep_trm</span></span><span> </span><span class="main"><span>=</span></span><span>  </span><span class="entity"><span>quot_thm_abs</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rty_forced</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>domain_type</span><span> </span><span>o</span><span> </span><span>fastype_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>absrep_trm</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>forced_rhs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>force_rty_type</span></span><span> </span><span class="entity"><span>lthy0</span></span><span> </span><span class="entity"><span>rty_forced</span></span><span> </span><span class="entity"><span>rhs</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lhs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span>Binding.name_of</span><span> </span><span class="entity"><span>binding</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prop</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.mk_equals</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>absrep_trm</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>forced_rhs</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prop'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Local_Defs.cert_def</span><span> </span><span class="entity"><span>lthy0</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prop</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>newrhs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Local_Defs.abs_def</span><span> </span><span class="entity"><span>prop'</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>var</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>notes</span><span> </span><span class="entity"><span>config</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span> </span><span>?</span><span> </span><span>Binding.concealed</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>binding</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mx</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>def_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.make_def_binding</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>notes</span><span> </span><span class="entity"><span>config</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>var</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>lift_const</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span> </span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>def_thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lthy0</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Local_Theory.define</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>var</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>def_name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>newrhs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>transfer_rules</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>generate_transfer_rules</span></span><span> </span><span class="entity"><span>lthy1</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span> </span><span class="entity"><span>rsp_thm</span></span><span> </span><span class="entity"><span>def_thm</span></span><span> </span><span class="entity"><span>par_thms</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>abs_eq_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>generate_abs_eq</span></span><span> </span><span class="entity"><span>lthy1</span></span><span> </span><span class="entity"><span>def_thm</span></span><span> </span><span class="entity"><span>rsp_thm</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>opt_rep_eq_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>generate_rep_eq</span></span><span> </span><span class="entity"><span>lthy1</span></span><span> </span><span class="entity"><span>def_thm</span></span><span> </span><span class="entity"><span>rsp_thm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty_forced</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>notes</span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lhs_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Binding.reset_pos</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>var</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rsp_thmN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Binding.qualify_name</span><span> </span><span>true</span><span> </span><span class="entity"><span>lhs_name</span></span><span> </span><span class="inner_quoted"><span>"rsp"</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>abs_eq_thmN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Binding.qualify_name</span><span> </span><span>true</span><span> </span><span class="entity"><span>lhs_name</span></span><span> </span><span class="inner_quoted"><span>"abs_eq"</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rep_eq_thmN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Binding.qualify_name</span><span> </span><span>true</span><span> </span><span class="entity"><span>lhs_name</span></span><span> </span><span class="inner_quoted"><span>"rep_eq"</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>transfer_ruleN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Binding.qualify_name</span><span> </span><span>true</span><span> </span><span class="entity"><span>lhs_name</span></span><span> </span><span class="inner_quoted"><span>"transfer"</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>notes</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>rsp_thmN</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rsp_thm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>transfer_ruleN</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="../Transfer/transfer.ML.html#Transfer.transfer_rule|attribute"><span class="operator"><span>transfer_rule</span></span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>transfer_rules</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>abs_eq_thmN</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>abs_eq_thm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
          </span><span>@</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>opt_rep_eq_thm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>rep_eq_thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>rep_eq_thmN</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rep_eq_thm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>attrs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>attrs</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>notes</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>attrs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>attrs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>NONE</span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Binding.empty_atts</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>attrs</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>notes</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>code_eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lthy1</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>register_code_eq</span></span><span> </span><span class="entity"><span>abs_eq_thm</span></span><span> </span><span class="entity"><span>opt_rep_eq_thm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty_forced</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lift_def</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_lift_def</span></span><span> </span><span class="entity"><span>rty_forced</span></span><span> </span><span class="entity"><span>qty</span></span><span> </span><span class="entity"><span>newrhs</span></span><span> </span><span class="entity"><span>lift_const</span></span><span> </span><span class="entity"><span>def_thm</span></span><span> </span><span class="entity"><span>rsp_thm</span></span><span> </span><span class="entity"><span>abs_eq_thm</span></span><span>
          </span><span class="entity"><span>opt_rep_eq_thm</span></span><span> </span><span class="entity"><span>code_eq</span></span><span> </span><span class="entity"><span>transfer_rules</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>lthy2</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>o</span><span> </span><span>Local_Theory.begin_nested</span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Local_Theory.notes</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>notes</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>notes</span><span> </span><span class="entity"><span>config</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>snd</span><span>
    </span><span>|&gt;</span><span> </span><span>`</span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>morph_lift_def</span></span><span> </span><span class="main"><span>(</span></span><span>Local_Theory.target_morphism</span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lift_def</span></span><span class="main"><span>)</span></span><span>
    </span><span>||&gt;</span><span> </span><span>Local_Theory.end_nested</span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(* This is not very cheap way of getting the rules but we have only few active
  liftings in the current setting *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_cr_pcr_eqs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>collect</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>data</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Lifting_Info.quotient</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>is_some</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>pcr_info</span><span> </span><span class="entity"><span>data</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Thm.symmetric</span><span> </span><span>o</span><span> </span><span class="entity"><span>safe_mk_meta_eq</span></span><span> </span><span>o</span><span> </span><span>Thm.transfer'</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>pcr_cr_eq</span><span> </span><span>o</span><span> </span><span>the</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>pcr_info</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>data</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>l</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>table</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Lifting_Info.get_quotients</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>Symtab.fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>data</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>collect</span></span><span> </span><span class="entity"><span>data</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>table</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prepare_lift_def</span></span><span> </span><span class="entity"><span>add_lift_def</span></span><span> </span><span class="entity"><span>var</span></span><span> </span><span class="entity"><span>qty</span></span><span> </span><span class="entity"><span>rhs</span></span><span> </span><span class="entity"><span>par_thms</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rsp_rel</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Lifting_Term.equiv_relation</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rty_forced</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>domain_type</span><span> </span><span>o</span><span> </span><span>fastype_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rsp_rel</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>forced_rhs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>force_rty_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rty_forced</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cr_to_pcr_conv</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.Trueprop_conv</span></span><span> </span><span class="main"><span>(</span></span><span>Conv.fun2_conv</span><span>
      </span><span class="main"><span>(</span></span><span>Raw_Simplifier.rewrite</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>false</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_cr_pcr_eqs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prsp_tm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rsp_prsp_eq</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rsp_rel</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>forced_rhs</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>forced_rhs</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>cr_to_pcr_conv</span></span><span>
      </span><span>|&gt;</span><span> </span><span>`</span><span>Thm.concl_of</span><span>
      </span><span>|&gt;&gt;</span><span> </span><span>Logic.dest_equals</span><span>
      </span><span>|&gt;&gt;</span><span> </span><span>snd</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>to_rsp</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rsp_prsp_eq</span></span><span> </span><span>RS</span><span> </span><span>Drule.equal_elim_rule2</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>opt_proven_rsp_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>try_prove_reflexivity</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>prsp_tm</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>after_qed</span></span><span> </span><span class="entity"><span>internal_rsp_thm</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>add_lift_def</span></span><span> </span><span class="entity"><span>var</span></span><span> </span><span class="entity"><span>qty</span></span><span> </span><span class="entity"><span>rhs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>internal_rsp_thm</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>to_rsp</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>par_thms</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>opt_proven_rsp_thm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>SOME</span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>after_qed</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>prsp_tm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>after_qed</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gen_lift_def</span></span><span> </span><span class="entity"><span>add_lift_def</span></span><span> </span><span class="entity"><span>var</span></span><span> </span><span class="entity"><span>qty</span></span><span> </span><span class="entity"><span>rhs</span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="entity"><span>par_thms</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>goal</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>after_qed</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prepare_lift_def</span></span><span> </span><span class="entity"><span>add_lift_def</span></span><span> </span><span class="entity"><span>var</span></span><span> </span><span class="entity"><span>qty</span></span><span> </span><span class="entity"><span>rhs</span></span><span> </span><span class="entity"><span>par_thms</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>SOME</span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rsp_thm</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span>Goal.prove_sorry</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tac</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>context</span><span class="main"><span>)</span></span><span>
            </span><span>|&gt;</span><span> </span><span>Thm.close_derivation</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="entity"><span>after_qed</span></span><span> </span><span class="entity"><span>rsp_thm</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>after_qed</span></span><span> </span><span>Drule.dummy_thm</span><span> </span><span class="entity"><span>lthy</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lift_def</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>gen_lift_def</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>add_lift_def</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span> </span><span class="comment1"><span>(* structure *)</span></span><span>
</span></pre>
</body>

</html>