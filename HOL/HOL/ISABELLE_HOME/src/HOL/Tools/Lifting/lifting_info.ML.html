<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Tools/Lifting/lifting_info.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Tools/Lifting/lifting_info.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      HOL/Tools/Lifting/lifting_info.ML
    Author:     Ondrej Kuncar

Context data for the lifting package.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>LIFTING_INFO</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>quot_map</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>rel_quot_thm</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>}</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> lookup_quot_maps</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>quot_map</span></span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> print_quot_maps</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>pcr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>pcrel_def</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span> </span><span>pcr_cr_eq</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>}</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>quotient</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>quot_thm</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span> </span><span>pcr_info</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>pcr</span></span><span> </span><span>option</span><span class="main"><span>}</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> pcr_eq</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>pcr</span></span><span> * </span><span class="entity"><span>pcr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> quotient_eq</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>quotient</span></span><span> * </span><span class="entity"><span>quotient</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> transform_quotient</span><span class="main"><span>:</span></span><span> </span><span>morphism</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>quotient</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>quotient</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> lookup_quotients</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>quotient</span></span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> lookup_quot_thm_quotients</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>quotient</span></span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> update_quotients</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>quotient</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> delete_quotients</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> print_quotients</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>restore_data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>quotient</span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>quotient</span></span><span class="main"><span>,</span></span><span> </span><span>transfer_rules</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>Item_Net.T</span><span class="main"><span>}</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> lookup_restore_data</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>restore_data</span></span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> init_restore_data</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>quotient</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_transfer_rules_in_restore_data</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>Item_Net.T</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> get_relator_eq_onp_rules</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> get_reflexivity_rules</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_reflexivity_rule_attribute</span><span class="main"><span>:</span></span><span> </span><span>attribute</span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>relator_distr_data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>pos_mono_rule</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span> </span><span>neg_mono_rule</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span>
    </span><span>pos_distr_rules</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span> </span><span>neg_distr_rules</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>}</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> lookup_relator_distr_data</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>relator_distr_data</span></span><span> </span><span>option</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_no_code_type</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> is_no_code_type</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> get_quot_maps           </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>quot_map</span></span><span> </span><span>Symtab.table</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> get_quotients           </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>quotient</span></span><span> </span><span>Symtab.table</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> get_relator_distr_data  </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>relator_distr_data</span></span><span> </span><span>Symtab.table</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> get_restore_data        </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>restore_data</span></span><span> </span><span>Symtab.table</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> get_no_code_types       </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span> </span><span>Symtab.table</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Lifting_Info</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>LIFTING_INFO</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Lifting_Util</span><span>


</span><span class="comment1"><span>(* context data *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>quot_map</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>rel_quot_thm</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>}</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>pcr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>pcrel_def</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span> </span><span>pcr_cr_eq</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>}</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>quotient</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>quot_thm</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span> </span><span>pcr_info</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>pcr</span></span><span> </span><span>option</span><span class="main"><span>}</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>relator_distr_data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>pos_mono_rule</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span> </span><span>neg_mono_rule</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span>
  </span><span>pos_distr_rules</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span> </span><span>neg_distr_rules</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>}</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>restore_data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>quotient</span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>quotient</span></span><span class="main"><span>,</span></span><span> </span><span>transfer_rules</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>Item_Net.T</span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pcr_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span>pcrel_def</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pcrel_def1</span></span><span class="main"><span>,</span></span><span> </span><span>pcr_cr_eq</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pcr_cr_eq1</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span>
           </span><span class="main"><span>{</span></span><span>pcrel_def</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pcrel_def2</span></span><span class="main"><span>,</span></span><span> </span><span>pcr_cr_eq</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pcr_cr_eq2</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
           </span><span>Thm.eq_thm</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pcrel_def1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pcrel_def2</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>Thm.eq_thm</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pcr_cr_eq1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pcr_cr_eq2</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>quotient_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span>quot_thm</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>quot_thm1</span></span><span class="main"><span>,</span></span><span> </span><span>pcr_info</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pcr_info1</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span>
                </span><span class="main"><span>{</span></span><span>quot_thm</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>quot_thm2</span></span><span class="main"><span>,</span></span><span> </span><span>pcr_info</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pcr_info2</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span>Thm.eq_thm</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>quot_thm1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>quot_thm2</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>eq_option</span><span> </span><span class="entity"><span>pcr_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pcr_info1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pcr_info2</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>join_restore_data</span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rd1</span></span><span class="main"><span>:</span></span><span class="entity"><span>restore_data</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rd2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>pointer_eq</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rd1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rd2</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Symtab.SAME</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>quotient_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>quotient</span><span> </span><span class="entity"><span>rd1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span>quotient</span><span> </span><span class="entity"><span>rd2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Symtab.DUP</span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="main"><span>{</span></span><span> </span><span>quotient</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>quotient</span><span> </span><span class="entity"><span>rd1</span></span><span class="main"><span>,</span></span><span>
      </span><span>transfer_rules</span><span> </span><span class="main"><span>=</span></span><span> </span><span>Item_Net.merge</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>transfer_rules</span><span> </span><span class="entity"><span>rd1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span>transfer_rules</span><span> </span><span class="entity"><span>rd2</span></span><span class="main"><span>)</span></span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Generic_Data</span><span>
</span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>{</span></span><span> </span><span>quot_maps</span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>quot_map</span></span><span> </span><span>Symtab.table</span><span class="main"><span>,</span></span><span>
      </span><span>quotients</span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>quotient</span></span><span> </span><span>Symtab.table</span><span class="main"><span>,</span></span><span>
      </span><span>reflexivity_rules</span><span> </span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>Item_Net.T</span><span class="main"><span>,</span></span><span>
      </span><span>relator_distr_data</span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>relator_distr_data</span></span><span> </span><span>Symtab.table</span><span class="main"><span>,</span></span><span>
      </span><span>restore_data</span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>restore_data</span></span><span> </span><span>Symtab.table</span><span class="main"><span>,</span></span><span>
      </span><span>no_code_types</span><span> </span><span class="main"><span>:</span></span><span> </span><span>unit</span><span> </span><span>Symtab.table</span><span>
    </span><span class="main"><span>}</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>{</span></span><span> </span><span>quot_maps</span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.empty</span><span class="main"><span>,</span></span><span>
      </span><span>quotients</span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.empty</span><span class="main"><span>,</span></span><span>
      </span><span>reflexivity_rules</span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.item_net</span><span class="main"><span>,</span></span><span>
      </span><span>relator_distr_data</span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.empty</span><span class="main"><span>,</span></span><span>
      </span><span>restore_data</span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.empty</span><span class="main"><span>,</span></span><span>
      </span><span>no_code_types</span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.empty</span><span>
    </span><span class="main"><span>}</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>merge</span></span><span>
    </span><span class="main"><span>(</span></span><span> </span><span class="main"><span>{</span></span><span> </span><span>quot_maps</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>qm1</span></span><span class="main"><span>,</span></span><span> </span><span>quotients</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>q1</span></span><span class="main"><span>,</span></span><span> </span><span>reflexivity_rules</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rr1</span></span><span class="main"><span>,</span></span><span> </span><span>relator_distr_data</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rdd1</span></span><span class="main"><span>,</span></span><span>
        </span><span>restore_data</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rd1</span></span><span class="main"><span>,</span></span><span> </span><span>no_code_types</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nct1</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span>
      </span><span class="main"><span>{</span></span><span> </span><span>quot_maps</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>qm2</span></span><span class="main"><span>,</span></span><span> </span><span>quotients</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>q2</span></span><span class="main"><span>,</span></span><span> </span><span>reflexivity_rules</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rr2</span></span><span class="main"><span>,</span></span><span> </span><span>relator_distr_data</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rdd2</span></span><span class="main"><span>,</span></span><span>
        </span><span>restore_data</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rd2</span></span><span class="main"><span>,</span></span><span> </span><span>no_code_types</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nct2</span></span><span> </span><span class="main"><span>}</span></span><span> </span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>{</span></span><span> </span><span>quot_maps</span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.merge</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>qm1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qm2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
      </span><span>quotients</span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.merge</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>q1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>q2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
      </span><span>reflexivity_rules</span><span> </span><span class="main"><span>=</span></span><span> </span><span>Item_Net.merge</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rr1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rr2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
      </span><span>relator_distr_data</span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.merge</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rdd1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rdd2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
      </span><span>restore_data</span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.join</span><span> </span><span class="entity"><span>join_restore_data</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rd1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rd2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
      </span><span>no_code_types</span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.merge</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nct1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nct2</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>}</span></span><span>
</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_data</span></span><span> </span><span class="entity"><span>f1</span></span><span> </span><span class="entity"><span>f2</span></span><span> </span><span class="entity"><span>f3</span></span><span> </span><span class="entity"><span>f4</span></span><span> </span><span class="entity"><span>f5</span></span><span> </span><span class="entity"><span>f6</span></span><span>
  </span><span class="main"><span>{</span></span><span> </span><span class="entity"><span>quot_maps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>quotients</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>reflexivity_rules</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>relator_distr_data</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>restore_data</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>no_code_types</span></span><span> </span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span> </span><span>quot_maps</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f1</span></span><span> </span><span class="entity"><span>quot_maps</span></span><span class="main"><span>,</span></span><span>
    </span><span>quotients</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f2</span></span><span> </span><span class="entity"><span>quotients</span></span><span class="main"><span>,</span></span><span>
    </span><span>reflexivity_rules</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f3</span></span><span> </span><span class="entity"><span>reflexivity_rules</span></span><span class="main"><span>,</span></span><span>
    </span><span>relator_distr_data</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f4</span></span><span> </span><span class="entity"><span>relator_distr_data</span></span><span class="main"><span>,</span></span><span>
    </span><span>restore_data</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f5</span></span><span> </span><span class="entity"><span>restore_data</span></span><span class="main"><span>,</span></span><span>
    </span><span>no_code_types</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f6</span></span><span> </span><span class="entity"><span>no_code_types</span></span><span>
  </span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_quot_maps</span></span><span>           </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_data</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span>I</span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_quotients</span></span><span>           </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_data</span></span><span> </span><span>I</span><span> </span><span class="entity"><span>f</span></span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span>I</span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_reflexivity_rules</span></span><span>   </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_data</span></span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span class="entity"><span>f</span></span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span>I</span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_relator_distr_data</span></span><span>  </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_data</span></span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span class="entity"><span>f</span></span><span> </span><span>I</span><span> </span><span>I</span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_restore_data</span></span><span>        </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_data</span></span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span class="entity"><span>f</span></span><span> </span><span>I</span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_no_code_types</span></span><span>       </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_data</span></span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span class="entity"><span>f</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get_quot_maps'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>quot_maps</span><span> </span><span>o</span><span> </span><span>Data.get</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get_quotients'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>quotients</span><span> </span><span>o</span><span> </span><span>Data.get</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get_reflexivity_rules'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>reflexivity_rules</span><span> </span><span>o</span><span> </span><span>Data.get</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get_relator_distr_data'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>relator_distr_data</span><span> </span><span>o</span><span> </span><span>Data.get</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get_restore_data'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>restore_data</span><span> </span><span>o</span><span> </span><span>Data.get</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get_no_code_types'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>no_code_types</span><span> </span><span>o</span><span> </span><span>Data.get</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get_quot_maps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_quot_maps'</span></span><span> </span><span>o</span><span> </span><span>Context.Proof</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get_quotients</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_quotients'</span></span><span> </span><span>o</span><span> </span><span>Context.Proof</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get_relator_distr_data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_relator_distr_data'</span></span><span> </span><span>o</span><span> </span><span>Context.Proof</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get_restore_data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_restore_data'</span></span><span> </span><span>o</span><span> </span><span>Context.Proof</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get_no_code_types</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_no_code_types'</span></span><span> </span><span>o</span><span> </span><span>Context.Proof</span><span>


</span><span class="comment1"><span>(* info about Quotient map theorems *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lookup_quot_maps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.lookup</span><span> </span><span>o</span><span> </span><span class="entity"><span>get_quot_maps</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>quot_map_thm_sanity_check</span></span><span> </span><span class="entity"><span>rel_quot_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>quot_term_absT</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>quot_term</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>abs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest_Quotient</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>quot_term</span></span><span>
          </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span>Pretty.string_of</span><span> </span><span class="main"><span>(</span></span><span>Pretty.block</span><span>
            </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"The Quotient map theorem is not in the right form."</span></span><span class="main"><span>,</span></span><span>
             </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>
             </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"The following term is not the Quotient predicate:"</span></span><span class="main"><span>,</span></span><span>
             </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>
             </span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>fastype_of</span><span> </span><span class="entity"><span>abs</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rel_quot_thm_fixed</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.importT</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rel_quot_thm</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rel_quot_thm_prop</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.prop_of</span><span> </span><span class="entity"><span>rel_quot_thm_fixed</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rel_quot_thm_concl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.strip_imp_concl</span><span> </span><span class="entity"><span>rel_quot_thm_prop</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rel_quot_thm_prems</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.strip_imp_prems</span><span> </span><span class="entity"><span>rel_quot_thm_prop</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>concl_absT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>quot_term_absT</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>rel_quot_thm_concl</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>concl_tfrees</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.add_tfree_namesT</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>concl_absT</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prems_tfrees</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>typ</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>list</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Term.add_tfree_namesT</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>quot_term_absT</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>list</span></span><span class="main"><span>)</span></span><span>
                          </span><span class="entity"><span>rel_quot_thm_prems</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>extra_prem_tfrees</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>subtract</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>concl_tfrees</span></span><span> </span><span class="entity"><span>prems_tfrees</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>extras</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span>Pretty.block</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"Extra type variables in the premises:"</span></span><span class="main"><span>,</span></span><span>
                                 </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>]</span></span><span> </span><span>@</span><span>
                                 </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Pretty.commas</span><span> </span><span>o</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Pretty.str</span><span> </span><span>o</span><span> </span><span>quote</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>extras</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span>
                                 </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"."</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>errs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>extra_prem_tfrees</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>errs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span>cat_lines</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"Sanity check of the quotient map theorem failed:"</span></span><span class="main"><span>,</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>]</span></span><span>
                                                 </span><span>@</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Pretty.string_of</span><span> </span><span class="entity"><span>errs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_quot_map</span></span><span> </span><span class="entity"><span>rel_quot_thm</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Context.cases</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>quot_map_thm_sanity_check</span></span><span> </span><span class="entity"><span>rel_quot_thm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rel_quot_thm_concl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Logic.strip_imp_concl</span><span> </span><span>o</span><span> </span><span>Thm.prop_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rel_quot_thm</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>abs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest_Quotient</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rel_quot_thm_concl</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>relatorT_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span>dest_Type</span><span> </span><span>o</span><span> </span><span>fst</span><span> </span><span>o</span><span> </span><span>dest_funT</span><span> </span><span>o</span><span> </span><span>fastype_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>abs</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>minfo</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>rel_quot_thm</span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.trim_context</span><span> </span><span class="entity"><span>rel_quot_thm</span></span><span class="main"><span>}</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>Data.map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_quot_maps</span></span><span> </span><span class="main"><span>(</span></span><span>Symtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>relatorT_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>minfo</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Theory.setup</span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>Attrib.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Lifting.quot_map|attribute"><span>quot_map</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>Scan.succeed</span><span> </span><span class="main"><span>(</span></span><span>Thm.declaration_attribute</span><span> </span><span class="entity"><span>add_quot_map</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="inner_quoted"><span>"declaration of the Quotient map theorem"</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>print_quot_maps</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prt_map</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty_name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>rel_quot_thm</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Pretty.block</span><span> </span><span class="main"><span>(</span></span><span>separate</span><span> </span><span class="main"><span>(</span></span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>2</span></span><span class="main"><span>)</span></span><span>
         </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"type:"</span></span><span class="main"><span>,</span></span><span>
          </span><span>Pretty.str</span><span> </span><span class="entity"><span>ty_name</span></span><span class="main"><span>,</span></span><span>
          </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"quot. theorem:"</span></span><span class="main"><span>,</span></span><span>
          </span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>rel_quot_thm</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>map</span><span> </span><span class="entity"><span>prt_map</span></span><span> </span><span class="main"><span>(</span></span><span>Symtab.dest</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_quot_maps</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Pretty.big_list</span><span> </span><span class="inner_quoted"><span>"maps for type constructors:"</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Pretty.writeln</span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(* info about quotient types *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>transform_pcr_info</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>pcrel_def</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pcr_cr_eq</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>pcrel_def</span><span> </span><span class="main"><span>=</span></span><span> </span><span>Morphism.thm</span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>pcrel_def</span></span><span class="main"><span>,</span></span><span> </span><span>pcr_cr_eq</span><span> </span><span class="main"><span>=</span></span><span> </span><span>Morphism.thm</span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>pcr_cr_eq</span></span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>transform_quotient</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>quot_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pcr_info</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>quot_thm</span><span> </span><span class="main"><span>=</span></span><span> </span><span>Morphism.thm</span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span class="main"><span>,</span></span><span> </span><span>pcr_info</span><span> </span><span class="main"><span>=</span></span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>transform_pcr_info</span></span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pcr_info</span></span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lookup_quotients</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>type_name</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Symtab.lookup</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_quotients</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>type_name</span></span><span>
  </span><span>|&gt;</span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>transform_quotient</span></span><span> </span><span class="main"><span>(</span></span><span>Morphism.transfer_morphism'</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lookup_quot_thm_quotients</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qtyp</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>quot_thm_rty_qty</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>qty_full_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span>dest_Type</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>qtyp</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>compare_data</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>data</span></span><span class="main"><span>:</span></span><span class="entity"><span>quotient</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.eq_thm_prop</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>quot_thm</span><span> </span><span class="entity"><span>data</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>lookup_quotients</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>qty_full_name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>SOME</span><span> </span><span class="entity"><span>quotient</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>compare_data</span></span><span> </span><span class="entity"><span>quotient</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>quotient</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>update_quotients</span></span><span> </span><span class="entity"><span>type_name</span></span><span> </span><span class="entity"><span>qinfo</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>qinfo'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>transform_quotient</span></span><span> </span><span>Morphism.trim_context_morphism</span><span> </span><span class="entity"><span>qinfo</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Data.map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_quotients</span></span><span> </span><span class="main"><span>(</span></span><span>Symtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>type_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qinfo'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>delete_quotients</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qtyp</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>quot_thm_rty_qty</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>qty_full_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span>dest_Type</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>qtyp</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>is_some</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lookup_quot_thm_quotients</span></span><span> </span><span class="main"><span>(</span></span><span>Context.proof_of</span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Data.map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_quotients</span></span><span> </span><span class="main"><span>(</span></span><span>Symtab.delete</span><span> </span><span class="entity"><span>qty_full_name</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>context</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>print_quotients</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prt_quot</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>qty_name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>quot_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pcr_info</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>quotient</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Pretty.block</span><span> </span><span class="main"><span>(</span></span><span>separate</span><span> </span><span class="main"><span>(</span></span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>2</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"type:"</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.str</span><span> </span><span class="entity"><span>qty_name</span></span><span class="main"><span>,</span></span><span>
          </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"quot thm:"</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.pretty_thm</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span class="main"><span>]</span></span><span> </span><span>@</span><span>
         </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>pcr_info</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
           </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>pcrel_def</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pcr_cr_eq</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"pcrel_def thm:"</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.pretty_thm</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>pcrel_def</span></span><span class="main"><span>,</span></span><span>
             </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"pcr_cr_eq thm:"</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.pretty_thm</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>pcr_cr_eq</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>map</span><span> </span><span class="entity"><span>prt_quot</span></span><span> </span><span class="main"><span>(</span></span><span>Symtab.dest</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_quotients</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Pretty.big_list</span><span> </span><span class="inner_quoted"><span>"quotients:"</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Pretty.writeln</span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Theory.setup</span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>Attrib.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Lifting.quot_del|attribute"><span>quot_del</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>Scan.succeed</span><span> </span><span class="main"><span>(</span></span><span>Thm.declaration_attribute</span><span> </span><span class="entity"><span>delete_quotients</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="inner_quoted"><span>"deletes the Quotient theorem"</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(* data for restoring Transfer/Lifting context *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lookup_restore_data</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>bundle_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.lookup</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_restore_data</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bundle_name</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>update_restore_data</span></span><span> </span><span class="entity"><span>bundle_name</span></span><span> </span><span class="entity"><span>restore_data</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Data.map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_restore_data</span></span><span> </span><span class="main"><span>(</span></span><span>Symtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bundle_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>restore_data</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>init_restore_data</span></span><span> </span><span class="entity"><span>bundle_name</span></span><span> </span><span class="entity"><span>qinfo</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>update_restore_data</span></span><span> </span><span class="entity"><span>bundle_name</span></span><span> </span><span class="main"><span>{</span></span><span> </span><span>quotient</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>qinfo</span></span><span class="main"><span>,</span></span><span> </span><span>transfer_rules</span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.item_net</span><span> </span><span class="main"><span>}</span></span><span> </span><span class="entity"><span>context</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_transfer_rules_in_restore_data</span></span><span> </span><span class="entity"><span>bundle_name</span></span><span> </span><span class="entity"><span>transfer_rules</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Symtab.lookup</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_restore_data'</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bundle_name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="entity"><span>restore_data</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="entity"><span>update_restore_data</span></span><span> </span><span class="entity"><span>bundle_name</span></span><span> </span><span class="main"><span>{</span></span><span> </span><span>quotient</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>quotient</span><span> </span><span class="entity"><span>restore_data</span></span><span class="main"><span>,</span></span><span>
        </span><span>transfer_rules</span><span> </span><span class="main"><span>=</span></span><span> </span><span>Item_Net.merge</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>transfer_rules</span><span> </span><span class="entity"><span>restore_data</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>transfer_rules</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>}</span></span><span> </span><span class="entity"><span>context</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"The restore data "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>bundle_name</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" is not defined."</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>


</span><span class="comment1"><span>(* theorems that a relator of an eq_onp is an eq_onp of the corresponding predicate *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_relator_eq_onp_rules</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>map</span><span> </span><span class="entity"><span>safe_mk_meta_eq</span></span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Named_Theorems.get</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">named_theorems</span><span class="hidden">&gt;</span></span></span><span>‹relator_eq_onp›</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>


</span><span class="comment1"><span>(* info about reflexivity rules *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_reflexivity_rules</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Item_Net.content</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_reflexivity_rules'</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Thm.transfer'</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_reflexivity_rule</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Data.map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_reflexivity_rules</span></span><span> </span><span class="main"><span>(</span></span><span>Item_Net.update</span><span> </span><span class="main"><span>(</span></span><span>Thm.trim_context</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>add_reflexivity_rule_attribute</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.declaration_attribute</span><span> </span><span class="entity"><span>add_reflexivity_rule</span></span><span>


</span><span class="comment1"><span>(* info about relator distributivity theorems *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_relator_distr_data'</span></span><span> </span><span class="entity"><span>f1</span></span><span> </span><span class="entity"><span>f2</span></span><span> </span><span class="entity"><span>f3</span></span><span> </span><span class="entity"><span>f4</span></span><span>
  </span><span class="main"><span>{</span></span><span class="entity"><span>pos_mono_rule</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>neg_mono_rule</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos_distr_rules</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>neg_distr_rules</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>pos_mono_rule</span><span>   </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f1</span></span><span> </span><span class="entity"><span>pos_mono_rule</span></span><span class="main"><span>,</span></span><span>
   </span><span>neg_mono_rule</span><span>   </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f2</span></span><span> </span><span class="entity"><span>neg_mono_rule</span></span><span class="main"><span>,</span></span><span>
   </span><span>pos_distr_rules</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f3</span></span><span> </span><span class="entity"><span>pos_distr_rules</span></span><span class="main"><span>,</span></span><span>
   </span><span>neg_distr_rules</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f4</span></span><span> </span><span class="entity"><span>neg_distr_rules</span></span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_pos_mono_rule</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_relator_distr_data'</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span>I</span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_neg_mono_rule</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_relator_distr_data'</span></span><span> </span><span>I</span><span> </span><span class="entity"><span>f</span></span><span> </span><span>I</span><span> </span><span>I</span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_pos_distr_rules</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_relator_distr_data'</span></span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span class="entity"><span>f</span></span><span> </span><span>I</span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_neg_distr_rules</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_relator_distr_data'</span></span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span>I</span><span> </span><span class="entity"><span>f</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>introduce_polarities</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dest_less_eq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.dest_bin</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Orderings.html#Orderings.ord_class.less_eq|const"><span>less_eq</span></a><span>›</span></span><span> </span><span>dummyT</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prems_pairs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest_less_eq</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prems_of</span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>equal_prems</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>filter</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prems_pairs</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>equal_prems</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"The rule contains reflexive assumptions."</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>concl_pairs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rule</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Thm.concl_of</span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>dest_less_eq</span></span><span>
      </span><span>|&gt;</span><span> </span><span>apply2</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>o</span><span> </span><span>strip_comb</span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>~~</span><span>
      </span><span>|&gt;</span><span> </span><span>filter_out</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>has_duplicates</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>concl_pairs</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"The rule contains duplicated variables in the conlusion."</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rewrite_prem</span></span><span> </span><span class="entity"><span>prem_pair</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>concl_pairs</span></span><span> </span><span class="entity"><span>prem_pair</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>HOLogic.Trueprop_conv</span></span><span> </span><span class="main"><span>(</span></span><span>Conv.rewr_conv</span><span> </span><span class="main"><span>(</span></span><span>Thm.symmetric</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.POS_def|fact"><span>POS_def</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>concl_pairs</span></span><span> </span><span class="main"><span>(</span></span><span>swap</span><span> </span><span class="entity"><span>prem_pair</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>HOLogic.Trueprop_conv</span></span><span> </span><span class="main"><span>(</span></span><span>Conv.rewr_conv</span><span> </span><span class="main"><span>(</span></span><span>Thm.symmetric</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.NEG_def|fact"><span>NEG_def</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"The rule contains a non-relevant assumption."</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rewrite_prems</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Conv.all_conv</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rewrite_prems</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span>::</span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Conv.implies_conv</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rewrite_prem</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rewrite_prems</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rewrite_prems_conv</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rewrite_prems</span></span><span> </span><span class="entity"><span>prems_pairs</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rewrite_concl_conv</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Conv.concl_conv</span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.Trueprop_conv</span></span><span> </span><span class="main"><span>(</span></span><span>Conv.rewr_conv</span><span> </span><span class="main"><span>(</span></span><span>Thm.symmetric</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.POS_def|fact"><span>POS_def</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span>Conv.fconv_rule</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rewrite_prems_conv</span></span><span> </span><span>then_conv</span><span> </span><span class="entity"><span>rewrite_concl_conv</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rule</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span>
    </span><span>TERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"The rule has a wrong format."</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>CTERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"The rule has a wrong format."</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>negate_mono_rule</span></span><span> </span><span class="entity"><span>mono_rule</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rewr_conv</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.Trueprop_conv</span></span><span> </span><span class="main"><span>(</span></span><span>Conv.rewrs_conv</span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.POS_NEG|fact"><span>POS_NEG</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.NEG_POS|fact"><span>NEG_POS</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>Conv.fconv_rule</span><span> </span><span class="main"><span>(</span></span><span>Conv.prems_conv</span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="entity"><span>rewr_conv</span></span><span> </span><span>then_conv</span><span> </span><span>Conv.concl_conv</span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="entity"><span>rewr_conv</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>mono_rule</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_reflexivity_rules</span></span><span> </span><span class="entity"><span>mono_rule</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Context.proof_of</span><span> </span><span class="entity"><span>context</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Context.theory_of</span><span> </span><span class="entity"><span>context</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>find_eq_rule</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>concl_rhs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span>o</span><span> </span><span class="entity"><span>get_args</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span>o</span><span> </span><span>Thm.concl_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Transfer.retrieve_relator_eq</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>concl_rhs</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>find_first</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Pattern.matches</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>concl_rhs</span></span><span class="main"><span>,</span></span><span>
          </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span class="entity"><span>HOLogic.dest_eq</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span>o</span><span> </span><span>Thm.concl_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rules</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eq_rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>find_eq_rule</span></span><span> </span><span class="entity"><span>mono_rule</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eq_rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>is_some</span><span> </span><span class="entity"><span>eq_rule</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>the</span><span> </span><span class="entity"><span>eq_rule</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>error</span><span>
      </span><span class="inner_quoted"><span>"No corresponding rule that the relator preserves equality was found."</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>context</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>add_reflexivity_rule</span></span><span> </span><span class="main"><span>(</span></span><span>Drule.zero_var_indexes</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Orderings.html#Orderings.ord_class.ord_le_eq_trans|fact"><span>ord_le_eq_trans</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>mono_rule</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eq_rule</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>add_reflexivity_rule</span></span><span>
      </span><span class="main"><span>(</span></span><span>Drule.zero_var_indexes</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Orderings.html#Orderings.ord_class.ord_eq_le_trans|fact"><span>ord_eq_le_trans</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>sym</span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>eq_rule</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mono_rule</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_mono_rule</span></span><span> </span><span class="entity"><span>mono_rule</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pol_mono_rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>introduce_polarities</span></span><span> </span><span class="entity"><span>mono_rule</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mono_ruleT_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span>dest_Type</span><span> </span><span>o</span><span> </span><span>fst</span><span> </span><span>o</span><span> </span><span class="entity"><span>relation_types</span></span><span> </span><span>o</span><span> </span><span>fst</span><span> </span><span>o</span><span> </span><span class="entity"><span>relation_types</span></span><span> </span><span>o</span><span> </span><span>snd</span><span> </span><span>o</span><span>
      </span><span>dest_Const</span><span> </span><span>o</span><span> </span><span>head_of</span><span> </span><span>o</span><span> </span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span>o</span><span> </span><span>Thm.concl_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pol_mono_rule</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Symtab.defined</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_relator_distr_data'</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>mono_ruleT_name</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Context_Position.is_visible_generic</span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span>warning</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Monotonicity rule for type "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>mono_ruleT_name</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" is already_defined."</span></span><span class="main"><span>)</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>neg_mono_rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>negate_mono_rule</span></span><span> </span><span class="entity"><span>pol_mono_rule</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>relator_distr_data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>pos_mono_rule</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pol_mono_rule</span></span><span class="main"><span>,</span></span><span> </span><span>neg_mono_rule</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>neg_mono_rule</span></span><span class="main"><span>,</span></span><span>
          </span><span>pos_distr_rules</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span>neg_distr_rules</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>}</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>context</span></span><span>
        </span><span>|&gt;</span><span> </span><span>Data.map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_relator_distr_data</span></span><span> </span><span class="main"><span>(</span></span><span>Symtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mono_ruleT_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>relator_distr_data</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="entity"><span>add_reflexivity_rules</span></span><span> </span><span class="entity"><span>mono_rule</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_distr_rule</span></span><span> </span><span class="entity"><span>update_entry</span></span><span> </span><span class="entity"><span>distr_rule</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>distr_ruleT_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span>dest_Type</span><span> </span><span>o</span><span> </span><span>fst</span><span> </span><span>o</span><span> </span><span class="entity"><span>relation_types</span></span><span> </span><span>o</span><span> </span><span>fst</span><span> </span><span>o</span><span> </span><span class="entity"><span>relation_types</span></span><span> </span><span>o</span><span> </span><span>snd</span><span> </span><span>o</span><span>
        </span><span>dest_Const</span><span> </span><span>o</span><span> </span><span>head_of</span><span> </span><span>o</span><span> </span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span>o</span><span> </span><span>Thm.concl_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>distr_rule</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Symtab.defined</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_relator_distr_data'</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>distr_ruleT_name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span>Data.map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_relator_distr_data</span></span><span> </span><span class="main"><span>(</span></span><span>Symtab.map_entry</span><span> </span><span class="entity"><span>distr_ruleT_name</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>update_entry</span></span><span> </span><span class="entity"><span>distr_rule</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="entity"><span>context</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"The monotonicity rule is not defined."</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rewrite_concl_conv</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>ctm</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>Conv.concl_conv</span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.Trueprop_conv</span></span><span> </span><span class="main"><span>(</span></span><span>Conv.rewr_conv</span><span> </span><span class="main"><span>(</span></span><span>Thm.symmetric</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctm</span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>CTERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"The rule has a wrong format."</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_pos_distr_rule</span></span><span> </span><span class="entity"><span>distr_rule</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>distr_rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Conv.fconv_rule</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rewrite_concl_conv</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.POS_def|fact"><span>POS_def</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>distr_rule</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>update_entry</span></span><span> </span><span class="entity"><span>distr_rule</span></span><span> </span><span class="entity"><span>data</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>map_pos_distr_rules</span></span><span> </span><span class="main"><span>(</span></span><span>cons</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.POS_trans|fact"><span>POS_trans</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>distr_rule</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span>pos_mono_rule</span><span> </span><span class="entity"><span>data</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>data</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>add_distr_rule</span></span><span> </span><span class="entity"><span>update_entry</span></span><span> </span><span class="entity"><span>distr_rule</span></span><span> </span><span class="entity"><span>context</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Combining of the distr. rule and the monotonicity rule together has failed."</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_neg_distr_rule</span></span><span> </span><span class="entity"><span>distr_rule</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>distr_rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Conv.fconv_rule</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rewrite_concl_conv</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.NEG_def|fact"><span>NEG_def</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>distr_rule</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>update_entry</span></span><span> </span><span class="entity"><span>distr_rule</span></span><span> </span><span class="entity"><span>data</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>map_neg_distr_rules</span></span><span> </span><span class="main"><span>(</span></span><span>cons</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.NEG_trans|fact"><span>NEG_trans</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>distr_rule</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span>neg_mono_rule</span><span> </span><span class="entity"><span>data</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>data</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>add_distr_rule</span></span><span> </span><span class="entity"><span>update_entry</span></span><span> </span><span class="entity"><span>distr_rule</span></span><span> </span><span class="entity"><span>context</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Combining of the distr. rule and the monotonicity rule together has failed."</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eq_refl2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>sym</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Orderings.html#Orderings.preorder_class.eq_refl|fact"><span>eq_refl</span></a><span class="antiquote"><span>}</span></span></span></span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_eq_distr_rule</span></span><span> </span><span class="entity"><span>distr_rule</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pos_distr_rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Orderings.html#Orderings.preorder_class.eq_refl|fact"><span>eq_refl</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>distr_rule</span></span><span class="main"><span>]</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>neg_distr_rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eq_refl2</span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>distr_rule</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>context</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>add_pos_distr_rule</span></span><span> </span><span class="entity"><span>pos_distr_rule</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>add_neg_distr_rule</span></span><span> </span><span class="entity"><span>neg_distr_rule</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>sanity_check</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>assms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>perhaps</span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prems_of</span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>perhaps</span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.concl_of</span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Orderings.html#Orderings.ord_class.less_eq|const"><span>less_eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lhs</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Relation.html#Relation.relcompp|const"><span>relcompp</span></a><span>›</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>rhs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Orderings.html#Orderings.ord_class.less_eq|const"><span>less_eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>rhs</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lhs</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Relation.html#Relation.relcompp|const"><span>relcompp</span></a><span>›</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lhs</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Relation.html#Relation.relcompp|const"><span>relcompp</span></a><span>›</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>rhs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"The rule has a wrong format."</span></span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lhs_vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.add_vars</span><span> </span><span class="entity"><span>lhs</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rhs_vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.add_vars</span><span> </span><span class="entity"><span>rhs</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>assms_vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span>Term.add_vars</span><span> </span><span class="entity"><span>assms</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>has_duplicates</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lhs_vars</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Left-hand side has variable duplicates"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>subset</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rhs_vars</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lhs_vars</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Extra variables in the right-hand side of the rule"</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>subset</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>assms_vars</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lhs_vars</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Extra variables in the assumptions of the rule"</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rhs_args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>o</span><span> </span><span>strip_comb</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_comp</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Relation.html#Relation.relcompp|const"><span>relcompp</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Var</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span>Var</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"There is an argument on the rhs that is not a composition."</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>check_comp</span></span><span> </span><span class="entity"><span>rhs_args</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_distr_rule</span></span><span> </span><span class="entity"><span>distr_rule</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>sanity_check</span></span><span> </span><span class="entity"><span>distr_rule</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>perhaps</span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.concl_of</span><span> </span><span class="entity"><span>distr_rule</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Orderings.html#Orderings.ord_class.less_eq|const"><span>less_eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Relation.html#Relation.relcompp|const"><span>relcompp</span></a><span>›</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="entity"><span>add_pos_distr_rule</span></span><span> </span><span class="entity"><span>distr_rule</span></span><span> </span><span class="entity"><span>context</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Orderings.html#Orderings.ord_class.less_eq|const"><span>less_eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Relation.html#Relation.relcompp|const"><span>relcompp</span></a><span>›</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="entity"><span>add_neg_distr_rule</span></span><span> </span><span class="entity"><span>distr_rule</span></span><span> </span><span class="entity"><span>context</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Relation.html#Relation.relcompp|const"><span>relcompp</span></a><span>›</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="entity"><span>add_eq_distr_rule</span></span><span> </span><span class="entity"><span>distr_rule</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_distr_rules_raw</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Symtab.fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>pos_distr_rules</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>neg_distr_rules</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="entity"><span>pos_distr_rules</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>neg_distr_rules</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>rules</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>get_relator_distr_data'</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Thm.transfer''</span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_mono_rules_raw</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Symtab.fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>pos_mono_rule</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>neg_mono_rule</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="main"><span>[</span></span><span class="entity"><span>pos_mono_rule</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>neg_mono_rule</span></span><span class="main"><span>]</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>rules</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>get_relator_distr_data'</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Thm.transfer''</span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lookup_relator_distr_data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.lookup</span><span> </span><span>o</span><span> </span><span class="entity"><span>get_relator_distr_data</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Theory.setup</span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>Attrib.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Lifting.relator_mono|attribute"><span>relator_mono</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>Scan.succeed</span><span> </span><span class="main"><span>(</span></span><span>Thm.declaration_attribute</span><span> </span><span class="entity"><span>add_mono_rule</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="inner_quoted"><span>"declaration of relator's monotonicity"</span></span><span>
    </span><span>#&gt;</span><span> </span><span class="entity"><span>Attrib.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Lifting.relator_distr|attribute"><span>relator_distr</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>Scan.succeed</span><span> </span><span class="main"><span>(</span></span><span>Thm.declaration_attribute</span><span> </span><span class="entity"><span>add_distr_rule</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="inner_quoted"><span>"declaration of relator's distributivity over OO"</span></span><span>
    </span><span>#&gt;</span><span> </span><span>Global_Theory.add_thms_dynamic</span><span>
       </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Lifting.relator_distr_raw|fact"><span>relator_distr_raw</span></span><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>get_distr_rules_raw</span></span><span class="main"><span>)</span></span><span>
    </span><span>#&gt;</span><span> </span><span>Global_Theory.add_thms_dynamic</span><span>
       </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Lifting.relator_mono_raw|fact"><span>relator_mono_raw</span></span><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>get_mono_rules_raw</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>


</span><span class="comment1"><span>(* no_code types *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_no_code_type</span></span><span> </span><span class="entity"><span>type_name</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Data.map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_no_code_types</span></span><span> </span><span class="main"><span>(</span></span><span>Symtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>type_name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_no_code_type</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="entity"><span>type_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Symtab.defined</span><span> </span><span>o</span><span> </span><span class="entity"><span>get_no_code_types</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="entity"><span>type_name</span></span><span>


</span><span class="comment1"><span>(* setup fixed eq_onp rules *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Context.&gt;&gt;</span><span>
  </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Named_Theorems.add_thm</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">named_theorems</span><span class="hidden">&gt;</span></span></span><span>‹relator_eq_onp›</span></span><span> </span><span>o</span><span>
    </span><span class="entity"><span>Transfer.prep_transfer_domain_thm</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span><span class="hidden">\&lt;^</span><span class="control">context</span><span class="hidden">&gt;</span></span></span></span></span><span class="main"><span>)</span></span><span>
  </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.composed_equiv_rel_eq_onp|fact"><span>composed_equiv_rel_eq_onp</span></a><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.composed_equiv_rel_eq_eq_onp|fact"><span>composed_equiv_rel_eq_eq_onp</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>


</span><span class="comment1"><span>(* setup fixed reflexivity rules *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Context.&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="entity"><span>add_reflexivity_rule</span></span><span>
  </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Orderings.html#Orderings.preorder_class.order_refl|fact"><span>order_refl</span></a><span class="main"><span>[</span></span><span class="operator"><span>of</span></span><span> </span><span class="quoted"><span>"</span><span class="main"><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>(=)</span></a></span><span>"</span></span><span class="main"><span>]</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.eq_onp_le_eq|fact"><span>eq_onp_le_eq</span></a><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.Quotient_composition_le_eq|fact"><span>Quotient_composition_le_eq</span></a><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.Quotient_composition_ge_eq|fact"><span>Quotient_composition_ge_eq</span></a><span>
    </span><a class="entity_ref" href="../../../../../Transfer.html#Transfer.bi_unique_OO|fact"><span>bi_unique_OO</span></a><span> </span><a class="entity_ref" href="../../../../../Transfer.html#Transfer.bi_total_OO|fact"><span>bi_total_OO</span></a><span> </span><a class="entity_ref" href="../../../../../Transfer.html#Transfer.right_unique_OO|fact"><span>right_unique_OO</span></a><span> </span><a class="entity_ref" href="../../../../../Transfer.html#Transfer.right_total_OO|fact"><span>right_total_OO</span></a><span> </span><a class="entity_ref" href="../../../../../Transfer.html#Transfer.left_unique_OO|fact"><span>left_unique_OO</span></a><span> </span><a class="entity_ref" href="../../../../../Transfer.html#Transfer.left_total_OO|fact"><span>left_total_OO</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>


</span><span class="comment1"><span>(* outer syntax commands *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Outer_Syntax.command</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword1"><span>print_quot_maps</span></span><span>›</span></span></span><span> </span><span class="inner_quoted"><span>"print quotient map functions"</span></span><span>
    </span><span class="main"><span>(</span></span><span>Scan.succeed</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Toplevel.keep</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>print_quot_maps</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>Toplevel.context_of</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Outer_Syntax.command</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword1"><span>print_quotients</span></span><span>›</span></span></span><span> </span><span class="inner_quoted"><span>"print quotients"</span></span><span>
    </span><span class="main"><span>(</span></span><span>Scan.succeed</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Toplevel.keep</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>print_quotients</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>Toplevel.context_of</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span></pre>
</body>

</html>