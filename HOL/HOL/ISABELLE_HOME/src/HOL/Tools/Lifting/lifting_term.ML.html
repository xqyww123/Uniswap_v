<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Tools/Lifting/lifting_term.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Tools/Lifting/lifting_term.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      HOL/Tools/Lifting/lifting_term.ML
    Author:     Ondrej Kuncar

Proves Quotient theorem.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>LIFTING_TERM</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> QUOT_THM </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>typ</span><span> * </span><span>typ</span><span> * </span><span>Pretty.T</span><span>
  </span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> PARAM_QUOT_THM </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>typ</span><span> * </span><span>Pretty.T</span><span>
  </span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> MERGE_TRANSFER_REL </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>Pretty.T</span><span>
  </span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> CHECK_RTY </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>typ</span><span> * </span><span>typ</span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span>'a</span><span> </span><span class="entity"><span>fold_quot_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span> </span><span>constr</span><span class="main"><span>:</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> * </span><span>'a</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> * </span><span>'a</span><span class="main"><span>,</span></span><span> </span><span>lift</span><span class="main"><span>:</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> * </span><span>'a</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> * </span><span>'a</span><span class="main"><span>,</span></span><span> 
  </span><span>comp_lift</span><span class="main"><span>:</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> * </span><span>'a</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> * </span><span>'a</span><span> </span><span class="main"><span>}</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>quotients</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Lifting_Info.quotient</span></span><span> </span><span>Symtab.table</span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> force_qty_type</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> prove_schematic_quot_thm</span><span class="main"><span>:</span></span><span> </span><span>'a</span><span> </span><span class="entity"><span>fold_quot_thm</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>quotients</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 
    </span><span>typ</span><span> * </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>'a</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> * </span><span>'a</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> instantiate_rtys</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> * </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> * </span><span>typ</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> prove_quot_thm</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> * </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> abs_fun</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> * </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> equiv_relation</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> * </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> prove_param_quot_thm</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> * </span><span class="main"><span>(</span></span><span>typ</span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span class="entity"><span>Proof.context</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> generate_parametrized_relator</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> * </span><span>term</span><span> </span><span>list</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> merge_transfer_relations</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>cterm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> parametrize_transfer_rule</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Lifting_Term</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>LIFTING_TERM</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Lifting_Util</span><span>

</span><span class="keyword1"><span class="keyword"><span>infix</span></span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> MRSL

</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>QUOT_THM_INTERNAL</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>Pretty.T</span><span>
</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>QUOT_THM</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>typ</span><span> * </span><span>typ</span><span> * </span><span>Pretty.T</span><span>
</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>PARAM_QUOT_THM</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>typ</span><span> * </span><span>Pretty.T</span><span>
</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>MERGE_TRANSFER_REL</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>Pretty.T</span><span>
</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>CHECK_RTY</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>typ</span><span> * </span><span>typ</span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>quotients</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Lifting_Info.quotient</span></span><span> </span><span>Symtab.table</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>match</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="entity"><span>ty_pat</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Sign.typ_match</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty_pat</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span>Vartab.empty</span><span>
    </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Type.TYPE_MATCH</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ty_pat</span></span><span> </span><span class="entity"><span>ty</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>equiv_match_err</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ty_pat</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ty_pat_str</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax.string_of_typ</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ty_pat</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ty_str</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax.string_of_typ</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ty</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>QUOT_THM_INTERNAL</span></span><span> </span><span class="main"><span>(</span></span><span>Pretty.block</span><span>
      </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"The quotient type "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>ty_str</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
       </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>
       </span><span>Pretty.str</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"and the quotient type pattern "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>ty_pat_str</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
       </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>
       </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"don't match."</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_quot_data</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>quotients</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>quotients</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Symtab.lookup</span><span> </span><span class="entity"><span>quotients</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="entity"><span>qdata</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>qdata</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>QUOT_THM_INTERNAL</span></span><span> </span><span class="main"><span>(</span></span><span>Pretty.block</span><span> 
    </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"No quotient type "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> 
     </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> 
     </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"found."</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_quot_thm</span></span><span> </span><span class="entity"><span>quotients</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Thm.transfer'</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>quot_thm</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_quot_data</span></span><span> </span><span class="entity"><span>quotients</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>has_pcrel_info</span></span><span> </span><span class="entity"><span>quotients</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>is_some</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>pcr_info</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_quot_data</span></span><span> </span><span class="entity"><span>quotients</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_pcrel_info</span></span><span> </span><span class="entity"><span>quotients</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>#</span></span><span>pcr_info</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_quot_data</span></span><span> </span><span class="entity"><span>quotients</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="entity"><span>pcr_info</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>pcr_info</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>QUOT_THM_INTERNAL</span></span><span> </span><span class="main"><span>(</span></span><span>Pretty.block</span><span> 
    </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"No parametrized correspondce relation for "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> 
     </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> 
     </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"found."</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_pcrel_def</span></span><span> </span><span class="entity"><span>quotients</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Thm.transfer'</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>pcrel_def</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_pcrel_info</span></span><span> </span><span class="entity"><span>quotients</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_pcr_cr_eq</span></span><span> </span><span class="entity"><span>quotients</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Thm.transfer'</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>pcr_cr_eq</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_pcrel_info</span></span><span> </span><span class="entity"><span>quotients</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_rel_quot_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Lifting_Info.lookup_quot_maps</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="entity"><span>map_data</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Thm.transfer'</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>rel_quot_thm</span><span> </span><span class="entity"><span>map_data</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>QUOT_THM_INTERNAL</span></span><span> </span><span class="main"><span>(</span></span><span>Pretty.block</span><span> 
      </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"No relator for the type "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> 
       </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>
       </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"found."</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_rel_distr_rules</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Lifting_Info.lookup_relator_distr_data</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="entity"><span>rel_distr_thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.POS|const"><span>POS</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Thm.transfer'</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>pos_distr_rules</span><span> </span><span class="entity"><span>rel_distr_thm</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.NEG|const"><span>NEG</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Thm.transfer'</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>neg_distr_rules</span><span> </span><span class="entity"><span>rel_distr_thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>QUOT_THM_INTERNAL</span></span><span> </span><span class="main"><span>(</span></span><span>Pretty.block</span><span>
      </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"No relator distr. data for the type "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> 
       </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>
       </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"found."</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_id_quot</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.eq_thm_prop</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.identity_quotient|fact"><span>identity_quotient</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>zip_Tvars</span></span><span> </span><span class="entity"><span>ctxt0</span></span><span> </span><span class="entity"><span>type_name</span></span><span> </span><span class="entity"><span>rty_Tvars</span></span><span> </span><span class="entity"><span>qty_Tvars</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_rel_quot_thm</span></span><span> </span><span class="entity"><span>ctxt0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>type_name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>rty_Tvars</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>qty_Tvars</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>rel_quot_thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> 
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>quot_term_absT</span></span><span> </span><span class="entity"><span>quot_term</span></span><span> </span><span class="main"><span>=</span></span><span> 
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> 
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>abs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest_Quotient</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>quot_term</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span>fastype_of</span><span> </span><span class="entity"><span>abs</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>equiv_univ_err</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ty_pat</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ty_pat_str</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax.string_of_typ</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ty_pat</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ty_str</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax.string_of_typ</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ty</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>QUOT_THM_INTERNAL</span></span><span> </span><span class="main"><span>(</span></span><span>Pretty.block</span><span>
              </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"The type "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>ty_str</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
               </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>
               </span><span>Pretty.str</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"and the relator type pattern "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>ty_pat_str</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
               </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>
               </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"don't unify."</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>raw_match</span></span><span> </span><span class="main"><span>(</span></span><span>TVar</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>subs</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Vartab.defined</span><span> </span><span class="entity"><span>subs</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                </span><span>false</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Vartab.update_new</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>S</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>subs</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span>true</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>subs</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>raw_match</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Us</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>subs</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="entity"><span>raw_matches</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Us</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>subs</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>raw_match</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>subs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>subs</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>raw_matches</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>U</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>Us</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>subs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>raw_matches</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Us</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>raw_match</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>U</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>subs</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>raw_matches</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>subs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>subs</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>type_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rty_Tvars</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>qty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>type_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty_Tvars</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rel_quot_thm_concl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Logic.strip_imp_concl</span><span> </span><span>o</span><span> </span><span>Thm.prop_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rel_quot_thm</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>schematic_rel_absT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>quot_term_absT</span></span><span> </span><span class="entity"><span>rel_quot_thm_concl</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>absT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>qty</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>schematic_absT</span></span><span> </span><span class="main"><span>=</span></span><span> 
          </span><span class="entity"><span>absT</span></span><span> 
          </span><span>|&gt;</span><span> </span><span>Logic.type_map</span><span> </span><span class="main"><span>(</span></span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Variable.polymorphic</span><span> </span><span class="entity"><span>ctxt0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>Logic.incr_tvar</span><span> </span><span class="main"><span>(</span></span><span>maxidx_of_typ</span><span> </span><span class="entity"><span>schematic_rel_absT</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> 
            </span><span class="comment1"><span>(* because absT can already contain schematic variables from rty patterns *)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>maxidx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.maxidx_of_typs</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>schematic_rel_absT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>schematic_absT</span></span><span class="main"><span>]</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>Sign.typ_unify</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt0</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>schematic_rel_absT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>schematic_absT</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>(</span></span><span>Vartab.empty</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>maxidx</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Type.TUNIFY</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>equiv_univ_err</span></span><span> </span><span class="entity"><span>ctxt0</span></span><span> </span><span class="entity"><span>schematic_rel_absT</span></span><span> </span><span class="entity"><span>schematic_absT</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>subs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>raw_match</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>schematic_rel_absT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>absT</span></span><span class="main"><span>)</span></span><span> </span><span>Vartab.empty</span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rel_quot_thm_prems</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Logic.strip_imp_prems</span><span> </span><span>o</span><span> </span><span>Thm.prop_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rel_quot_thm</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>dest_funT</span><span> </span><span>o</span><span> </span><span>Envir.subst_type</span><span> </span><span class="entity"><span>subs</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>quot_term_absT</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rel_quot_thm_prems</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gen_rty_is_TVar</span></span><span> </span><span class="entity"><span>quotients</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>qty</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>qty</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>Tname</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>get_quot_thm</span></span><span> </span><span class="entity"><span>quotients</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span>|&gt;</span><span> </span><span class="entity"><span>quot_thm_rty_qty</span></span><span> </span><span>|&gt;</span><span> </span><span>fst</span><span> </span><span>|&gt;</span><span> </span><span>is_TVar</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gen_instantiate_rtys</span></span><span> </span><span class="entity"><span>quotients</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>qty</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>qty_name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>quot_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_quot_thm</span></span><span> </span><span class="entity"><span>quotients</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>qty_name</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty_pat</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty_pat</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>quot_thm_rty_qty</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>inst_rty</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tys'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> 
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s'</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>inst_rty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tys</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>tys'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>QUOT_THM_INTERNAL</span></span><span> </span><span class="main"><span>(</span></span><span>Pretty.block</span><span> 
          </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"The type"</span></span><span class="main"><span>,</span></span><span>
           </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>
           </span><span>Syntax.pretty_typ</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span>
           </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>
           </span><span>Pretty.str</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"is not a raw type for the quotient type "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>qty_name</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>";"</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>
           </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"the correct raw type must be an instance of"</span></span><span class="main"><span>,</span></span><span>
           </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>
           </span><span>Syntax.pretty_typ</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rty_pat</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>inst_rty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>TFree</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>inst_rty</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>TVar</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rty</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>inst_rty</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>TFree</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rty</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>inst_rty</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"check_raw_types: we should not be here"</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>qtyenv</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>match</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>equiv_match_err</span></span><span> </span><span class="entity"><span>qty_pat</span></span><span> </span><span class="entity"><span>qty</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>inst_rty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty_pat</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rty</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Envir.subst_type</span><span> </span><span class="entity"><span>qtyenv</span></span><span> </span><span class="entity"><span>rty_pat</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>gen_instantiate_rtys</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"gen_instantiate_rtys: not Type"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>instantiate_rtys</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> 
  </span><span class="entity"><span>gen_instantiate_rtys</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Lifting_Info.get_quotients</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span>'a</span><span> </span><span class="entity"><span>fold_quot_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span> </span><span>constr</span><span class="main"><span>:</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> * </span><span>'a</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> * </span><span>'a</span><span class="main"><span>,</span></span><span> </span><span>lift</span><span class="main"><span>:</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> * </span><span>'a</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> * </span><span>'a</span><span class="main"><span>,</span></span><span> 
  </span><span>comp_lift</span><span class="main"><span>:</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> * </span><span>'a</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> * </span><span>'a</span><span> </span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prove_schematic_quot_thm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>actions</span></span><span class="main"><span>:</span></span><span> </span><span>'a</span><span> </span><span class="entity"><span>fold_quot_thm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>quotients</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fold_val</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lifting_step</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rtyq</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>gen_instantiate_rtys</span></span><span> </span><span class="entity"><span>quotients</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty's</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rtyqs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>gen_rty_is_TVar</span></span><span> </span><span class="entity"><span>quotients</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>qty</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>rty'</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>rtyq</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> 
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Targs</span></span><span> </span><span class="entity"><span>rty'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Targs</span></span><span> </span><span class="entity"><span>rtyq</span></span><span class="main"><span>)</span></span><span> 
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>args</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fold_val</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> 
          </span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prove_schematic_quot_thm</span></span><span> </span><span class="entity"><span>actions</span></span><span> </span><span class="entity"><span>quotients</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty's</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>rtyqs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fold_val</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>forall</span><span> </span><span class="entity"><span>is_id_quot</span></span><span> </span><span class="entity"><span>args</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>quot_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_quot_thm</span></span><span> </span><span class="entity"><span>quotients</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Tname</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="main"><span>#</span></span><span>lift</span><span> </span><span class="entity"><span>actions</span></span><span> </span><span class="entity"><span>qty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>quot_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fold_val</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>quot_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_quot_thm</span></span><span> </span><span class="entity"><span>quotients</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Tname</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rel_quot_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>gen_rty_is_TVar</span></span><span> </span><span class="entity"><span>quotients</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>qty</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>the_single</span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
              </span><span class="entity"><span>args</span></span><span> </span><span class="entity"><span>MRSL</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_rel_quot_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Tname</span></span><span> </span><span class="entity"><span>rty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>comp_quot_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rel_quot_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>MRSL</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.Quotient_compose|fact"><span>Quotient_compose</span></a><span class="antiquote"><span>}</span></span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="main"><span>#</span></span><span>comp_lift</span><span> </span><span class="entity"><span>actions</span></span><span> </span><span class="entity"><span>qty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>comp_quot_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fold_val</span></span><span class="main"><span>)</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tys'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s'</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>args</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fold_val</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> 
              </span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prove_schematic_quot_thm</span></span><span> </span><span class="entity"><span>actions</span></span><span> </span><span class="entity"><span>quotients</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> 
                </span><span class="main"><span>(</span></span><span class="entity"><span>zip_Tvars</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>tys</span></span><span> </span><span class="entity"><span>tys'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fold_val</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>forall</span><span> </span><span class="entity"><span>is_id_quot</span></span><span> </span><span class="entity"><span>args</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
              </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.identity_quotient|fact"><span>identity_quotient</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fold_val</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>quot_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="entity"><span>MRSL</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_rel_quot_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                </span><span class="main"><span>#</span></span><span>constr</span><span> </span><span class="entity"><span>actions</span></span><span> </span><span class="entity"><span>qty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>quot_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fold_val</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="entity"><span>lifting_step</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tys'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> 
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_quot_thm</span></span><span> </span><span class="entity"><span>quotients</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span>SOME</span><span> </span><span class="entity"><span>quot_thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> 
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rty_pat</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span class="entity"><span>quot_thm_rty_qty</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span class="entity"><span>lifting_step</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty_pat</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span>              
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>                                               
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rty_pat</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s'</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>TFree</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"a"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tys'</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span class="entity"><span>prove_schematic_quot_thm</span></span><span> </span><span class="entity"><span>actions</span></span><span> </span><span class="entity"><span>quotients</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty_pat</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fold_val</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.identity_quotient|fact"><span>identity_quotient</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fold_val</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>QUOT_THM_INTERNAL</span></span><span> </span><span class="entity"><span>pretty_msg</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>QUOT_THM</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pretty_msg</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>force_qty_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>qty</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty_schematic</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>quot_thm_rty_qty</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>match_env</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Sign.typ_match</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>qty_schematic</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span> </span><span>Vartab.empty</span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prep_ty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>S</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.ctyp_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ty_inst</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Vartab.fold</span><span> </span><span class="main"><span>(</span></span><span>cons</span><span> </span><span>o</span><span> </span><span class="entity"><span>prep_ty</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>match_env</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Thm.instantiate</span><span> </span><span class="main"><span>(</span></span><span>TVars.make</span><span> </span><span class="entity"><span>ty_inst</span></span><span class="main"><span>,</span></span><span> </span><span>Vars.empty</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_rty_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>  
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty_forced</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>quot_thm_rty_qty</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rty_schematic</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.type_map</span><span> </span><span class="main"><span>(</span></span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Variable.polymorphic</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rty</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Sign.typ_match</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty_schematic</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rty_forced</span></span><span class="main"><span>)</span></span><span> </span><span>Vartab.empty</span><span>
      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Type.TYPE_MATCH</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>CHECK_RTY</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty_schematic</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rty_forced</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(*
  The function tries to prove that rty and qty form a quotient.

  Returns: Quotient theorem; an abstract type of the theorem is exactly
    qty, a representation type of the theorem is an instance of rty in general.
*)</span></span><span>


</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>id_actions</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span> </span><span>constr</span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span>I</span><span class="main"><span>,</span></span><span> </span><span>lift</span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span>I</span><span class="main"><span>,</span></span><span> </span><span>comp_lift</span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span>I</span><span> </span><span class="main"><span>}</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prove_quot_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>quotients</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Lifting_Info.get_quotients</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>schematic_quot_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prove_schematic_quot_thm</span></span><span> </span><span class="entity"><span>id_actions</span></span><span> </span><span class="entity"><span>quotients</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>quot_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>force_qty_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>qty</span></span><span> </span><span class="entity"><span>schematic_quot_thm</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>check_rty_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>quot_thm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(*
  Computes the composed abstraction function for rty and qty.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>abs_fun</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>quot_thm_abs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prove_quot_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(*
  Computes the composed equivalence relation for rty and qty.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>equiv_relation</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>quot_thm_rel</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prove_quot_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get_fresh_Q_t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Q_t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.Quotient|const"><span>Quotient</span></a><span> </span><span class="free"><span>R</span></span><span> </span><span class="free"><span>Abs</span></span><span> </span><span class="free"><span>Rep</span></span><span> </span><span class="free"><span>T</span></span><span class="main"><span>)</span></span><span>›</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>frees_Q_t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.add_free_names</span><span> </span><span class="entity"><span>Q_t</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tfrees_Q_t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>rev</span><span> </span><span class="main"><span>(</span></span><span>Term.add_tfree_names</span><span> </span><span class="entity"><span>Q_t</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rename_free_var</span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span>the_default</span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>(</span></span><span>AList.lookup</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rename_free_var</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rename_free_vars</span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_aterms</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rename_free_var</span></span><span> </span><span class="entity"><span>tab</span></span><span class="main"><span>)</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rename_free_tvars</span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>map_types</span><span> </span><span class="main"><span>(</span></span><span>map_type_tfree</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sort</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span>TFree</span><span> </span><span class="main"><span>(</span></span><span>the_default</span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>(</span></span><span>AList.lookup</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sort</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>new_frees_Q_t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.variant_fixes</span><span> </span><span class="entity"><span>frees_Q_t</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tab_frees</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>frees_Q_t</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>new_frees_Q_t</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>new_tfrees_Q_t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt''</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.invent_types</span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>tfrees_Q_t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tab_tfrees</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tfrees_Q_t</span></span><span> </span><span>~~</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span>split_list</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>new_tfrees_Q_t</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>renamed_Q_t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rename_free_vars</span></span><span> </span><span class="entity"><span>tab_frees</span></span><span> </span><span class="entity"><span>Q_t</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>renamed_Q_t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rename_free_tvars</span></span><span> </span><span class="entity"><span>tab_tfrees</span></span><span> </span><span class="entity"><span>renamed_Q_t</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>renamed_Q_t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt''</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(*
  For the given type, it proves a composed Quotient map theorem, where for each type variable
  extra Quotient assumption is generated. E.g., for 'a list it generates exactly
  the Quotient map theorem for the list type. The function generalizes this for the whole
  type universe. New fresh variables in the assumptions are fixed in the returned context.

  Returns: the composed Quotient map theorem and list mapping each type variable in ty
  to the corresponding assumption in the returned theorem.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prove_param_quot_thm</span></span><span> </span><span class="entity"><span>ctxt0</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span> 
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> 
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>generate</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tys</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>table</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>tys</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> 
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>instantiated_id_quot_thm</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span>Thm.instantiate'</span><span> </span><span class="main"><span>[</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Thm.ctyp_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.identity_quotient|fact"><span>identity_quotient</span></a><span class="antiquote"><span>}</span></span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>instantiated_id_quot_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>table</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>args</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>table_ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_map</span><span> </span><span class="entity"><span>generate</span></span><span> </span><span class="entity"><span>tys</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>table</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>args</span></span><span> </span><span class="entity"><span>MRSL</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_rel_quot_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>table_ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>generate</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>table</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>AList.defined</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>table</span></span><span> </span><span class="entity"><span>ty</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="main"><span>(</span></span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>table</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>table</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Q_t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_fresh_Q_t</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Q_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.assume</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>Q_t</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>table'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Q_thm</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>table</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Q_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>table'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>param_quot_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>table</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>generate</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt0</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>param_quot_thm</span></span><span class="main"><span>,</span></span><span> </span><span>rev</span><span> </span><span class="entity"><span>table</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt1</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>QUOT_THM_INTERNAL</span></span><span> </span><span class="entity"><span>pretty_msg</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>PARAM_QUOT_THM</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pretty_msg</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(*
  It computes a parametrized relator for the given type ty. E.g., for 'a dlist:
  list_all2 ?R OO cr_dlist with parameters [?R].
  
  Returns: the definitional term and list of parameters (relations).
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>generate_parametrized_relator</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>quot_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>table</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prove_param_quot_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ty</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parametrized_relator</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>quot_thm_crel</span></span><span> </span><span class="entity"><span>quot_thm</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>q_thm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>quot_thm_crel</span></span><span> </span><span class="entity"><span>q_thm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>table</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>exported_terms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.exportT_terms</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>parametrized_relator</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>exported_terms</span></span><span class="main"><span>,</span></span><span> </span><span>tl</span><span> </span><span class="entity"><span>exported_terms</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(* Parametrization *)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_lhs</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.dest_fun</span><span> </span><span>o</span><span> </span><span>Thm.dest_arg</span><span> </span><span>o</span><span> </span><span>strip_imp_concl</span><span> </span><span>o</span><span> </span><span>Thm.cprop_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>;</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>no_imp</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>CTERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"no implication"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>infix</span></span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> else_imp

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cv1</span></span><span> </span><span class="entity"><span>else_imp</span></span><span> </span><span class="entity"><span>cv2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>cv1</span></span><span> </span><span class="entity"><span>ct</span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>cv2</span></span><span> </span><span class="entity"><span>ct</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>CTERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>cv2</span></span><span> </span><span class="entity"><span>ct</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>cv2</span></span><span> </span><span class="entity"><span>ct</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>TYPE</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>cv2</span></span><span> </span><span class="entity"><span>ct</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>first_imp</span></span><span> </span><span class="entity"><span>cvs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="entity"><span>else_imp</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cvs</span></span><span> </span><span class="entity"><span>no_imp</span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rewr_imp</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=</span></span><span> 
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rule1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.incr_indexes</span><span> </span><span class="main"><span>(</span></span><span>Thm.maxidx_of_cterm</span><span> </span><span class="entity"><span>ct</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lhs_rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_lhs</span></span><span> </span><span class="entity"><span>rule1</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rule2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.rename_boundvars</span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="entity"><span>lhs_rule</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="entity"><span>ct</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rule1</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lhs_ct</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.dest_fun</span><span> </span><span class="entity"><span>ct</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>Thm.instantiate</span><span> </span><span class="main"><span>(</span></span><span>Thm.match</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lhs_rule</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lhs_ct</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rule2</span></span><span>
          </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Pattern.MATCH</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>CTERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"rewr_imp"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>lhs_rule</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lhs_ct</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rewrs_imp</span></span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>first_imp</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>rewr_imp</span></span><span> </span><span class="entity"><span>rules</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gen_merge_transfer_relations</span></span><span> </span><span class="entity"><span>quotients</span></span><span> </span><span class="entity"><span>ctxt0</span></span><span> </span><span class="entity"><span>ctm</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.dest_arg</span><span> </span><span class="entity"><span>ctm</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>ctm</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rel</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span>o</span><span> </span><span class="entity"><span>get_args</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tm</span></span><span>
  
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>same_constants</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n1</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n2</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>n1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>n2</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>same_constants</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span>  </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prove_extra_assms</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ctm</span></span><span> </span><span class="entity"><span>distr_rule</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prove_assm</span></span><span> </span><span class="entity"><span>assm</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span>try</span><span> </span><span class="main"><span>(</span></span><span>Goal.prove</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="entity"><span>assm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>goal_ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span>SOLVED'</span><span> </span><span class="main"><span>(</span></span><span>REPEAT_ALL_NEW</span><span> </span><span class="main"><span>(</span></span><span>resolve_tac</span><span> </span><span class="entity"><span>goal_ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Transfer.get_transfer_raw</span></span><span> </span><span class="entity"><span>goal_ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
  
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_POS_or_NEG</span></span><span> </span><span class="entity"><span>ctm</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span>head_of</span><span> </span><span>o</span><span> </span><span>Thm.term_of</span><span> </span><span>o</span><span> </span><span>Thm.dest_arg</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.POS|const"><span>POS</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span>
            </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.NEG|const"><span>NEG</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span>
  
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inst_distr_rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rewr_imp</span></span><span> </span><span class="entity"><span>distr_rule</span></span><span> </span><span class="entity"><span>ctm</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>extra_assms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>filter_out</span><span> </span><span class="entity"><span>is_POS_or_NEG</span></span><span> </span><span class="main"><span>(</span></span><span>cprems_of</span><span> </span><span class="entity"><span>inst_distr_rule</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>proved_assms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_interrupt</span></span><span> </span><span class="entity"><span>prove_assm</span></span><span> </span><span class="entity"><span>extra_assms</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>OF</span><span> </span><span class="entity"><span>inst_distr_rule</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>proved_assms</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>CTERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
  
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cannot_merge_error_msg</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pretty.block</span><span>
         </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"Rewriting (merging) of this term has failed:"</span></span><span class="main"><span>,</span></span><span>
          </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>
          </span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt0</span></span><span> </span><span class="entity"><span>rel</span></span><span class="main"><span>]</span></span><span>
  
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>get_args</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="entity"><span>rel</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span class="main"><span>[</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>rewrs_imp</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.neg_eq_OO|fact"><span>neg_eq_OO</span></a><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.pos_eq_OO|fact"><span>pos_eq_OO</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="entity"><span>ctm</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>rewrs_imp</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.neg_OO_eq|fact"><span>neg_OO_eq</span></a><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.pos_OO_eq|fact"><span>pos_OO_eq</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="entity"><span>ctm</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trans_rel</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>relation_types</span></span><span> </span><span>o</span><span> </span><span>fastype_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>trans_rel</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>same_type_constrs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>distr_rules</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_rel_distr_rules</span></span><span> </span><span class="entity"><span>ctxt0</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span>dest_Type</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rty'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>head_of</span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>distr_rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>get_first</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prove_extra_assms</span></span><span> </span><span class="entity"><span>ctxt0</span></span><span> </span><span class="entity"><span>ctm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>distr_rules</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>distr_rule</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                    </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>MERGE_TRANSFER_REL</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cannot_merge_error_msg</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>distr_rule</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                      </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>gen_merge_transfer_relations</span></span><span> </span><span class="entity"><span>quotients</span></span><span> </span><span class="entity"><span>ctxt0</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>cprems_of</span><span> </span><span class="entity"><span>distr_rule</span></span><span class="main"><span>)</span></span><span>
                        </span><span class="entity"><span>MRSL</span></span><span> </span><span class="entity"><span>distr_rule</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> 
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pcrel_def</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_pcrel_def</span></span><span> </span><span class="entity"><span>quotients</span></span><span> </span><span class="entity"><span>ctxt0</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span>dest_Type</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pcrel_const</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>head_of</span><span> </span><span>o</span><span> </span><span>fst</span><span> </span><span>o</span><span> </span><span>Logic.dest_equals</span><span> </span><span>o</span><span> </span><span>Thm.prop_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pcrel_def</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>same_constants</span></span><span> </span><span class="entity"><span>pcrel_const</span></span><span> </span><span class="main"><span>(</span></span><span>head_of</span><span> </span><span class="entity"><span>trans_rel</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>unfolded_ctm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.rhs_of</span><span> </span><span class="main"><span>(</span></span><span>Conv.arg1_conv</span><span> </span><span class="main"><span>(</span></span><span>Conv.arg_conv</span><span> </span><span class="main"><span>(</span></span><span>Conv.rewr_conv</span><span> </span><span class="entity"><span>pcrel_def</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctm</span></span><span class="main"><span>)</span></span><span>
                      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>distr_rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rewrs_imp</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.POS_pcr_rule|fact"><span>POS_pcr_rule</span></a><span> </span><a class="entity_ref" href="../../../../../Lifting.html#Lifting.NEG_pcr_rule|fact"><span>NEG_pcr_rule</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="entity"><span>unfolded_ctm</span></span><span>
                      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>result</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>gen_merge_transfer_relations</span></span><span> </span><span class="entity"><span>quotients</span></span><span> </span><span class="entity"><span>ctxt0</span></span><span class="main"><span>)</span></span><span> 
                        </span><span class="main"><span>(</span></span><span>cprems_of</span><span> </span><span class="entity"><span>distr_rule</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>MRSL</span></span><span> </span><span class="entity"><span>distr_rule</span></span><span>
                      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fold_pcr_rel</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Conv.rewr_conv</span><span> </span><span class="main"><span>(</span></span><span>Thm.symmetric</span><span> </span><span class="entity"><span>pcrel_def</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>  
                      </span><span>Conv.fconv_rule</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.Trueprop_conv</span></span><span> </span><span class="main"><span>(</span></span><span>Conv.combination_conv</span><span> 
                        </span><span class="main"><span>(</span></span><span>Conv.arg_conv</span><span> </span><span class="main"><span>(</span></span><span>Conv.arg_conv</span><span> </span><span class="entity"><span>fold_pcr_rel</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fold_pcr_rel</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>result</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                    </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>MERGE_TRANSFER_REL</span></span><span> </span><span class="main"><span>(</span></span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"Non-parametric correspondence relation used."</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>QUOT_THM_INTERNAL</span></span><span> </span><span class="entity"><span>pretty_msg</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>MERGE_TRANSFER_REL</span></span><span> </span><span class="entity"><span>pretty_msg</span></span><span>

  </span><span class="comment1"><span>(*
    ctm - of the form "[POS|NEG] (par_R OO T) t f) ?X", where par_R is a parametricity transfer 
    relation for t and T is a transfer relation between t and f, which consists only from
    parametrized transfer relations (i.e., pcr_?) and equalities op=. POS or NEG encodes
    co-variance or contra-variance.
    
    The function merges par_R OO T using definitions of parametrized correspondence relations
    (e.g., (rel_S R) OO (pcr_T op=) --&gt; pcr_T R using the definition pcr_T R = (rel_S R) OO cr_T).
  *)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>merge_transfer_relations</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ctm</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>gen_merge_transfer_relations</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Lifting_Info.get_quotients</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ctm</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gen_parametrize_transfer_rule</span></span><span> </span><span class="entity"><span>quotients</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parametrize_relation_conv</span></span><span> </span><span class="entity"><span>ctm</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>relation_types</span></span><span> </span><span>o</span><span> </span><span>fastype_of</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="entity"><span>ctm</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>same_type_constrs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>forall</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Targs</span></span><span> </span><span class="entity"><span>rty</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>Targs</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span>Conv.all_conv</span><span> </span><span class="entity"><span>ctm</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span class="entity"><span>all_args_conv</span></span><span> </span><span class="entity"><span>parametrize_relation_conv</span></span><span> </span><span class="entity"><span>ctm</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>is_Type</span><span> </span><span class="entity"><span>qty</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>q</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span>dest_Type</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>qty</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rtyq</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>gen_instantiate_rtys</span></span><span> </span><span class="entity"><span>quotients</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>qty</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty's</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rtyqs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>gen_rty_is_TVar</span></span><span> </span><span class="entity"><span>quotients</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>qty</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>rty'</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>rtyq</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> 
                  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Targs</span></span><span> </span><span class="entity"><span>rty'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Targs</span></span><span> </span><span class="entity"><span>rtyq</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>forall</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rty's</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>rtyqs</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pcr_cr_eq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.symmetric</span><span> </span><span>o</span><span> </span><span class="entity"><span>mk_meta_eq</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_pcr_cr_eq</span></span><span> </span><span class="entity"><span>quotients</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>q</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>      
                    </span><span>Conv.rewr_conv</span><span> </span><span class="entity"><span>pcr_cr_eq</span></span><span> </span><span class="entity"><span>ctm</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
                  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>QUOT_THM_INTERNAL</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Conv.all_conv</span><span> </span><span class="entity"><span>ctm</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>has_pcrel_info</span></span><span> </span><span class="entity"><span>quotients</span></span><span> </span><span class="entity"><span>q</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> 
                      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pcrel_def</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.symmetric</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_pcrel_def</span></span><span> </span><span class="entity"><span>quotients</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>q</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                      </span><span class="main"><span>(</span></span><span>Conv.rewr_conv</span><span> </span><span class="entity"><span>pcrel_def</span></span><span> </span><span>then_conv</span><span> </span><span class="entity"><span>all_args_conv</span></span><span> </span><span class="entity"><span>parametrize_relation_conv</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctm</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Conv.arg1_conv</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>all_args_conv</span></span><span> </span><span class="entity"><span>parametrize_relation_conv</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctm</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>  
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Conv.all_conv</span><span> </span><span class="entity"><span>ctm</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span>Conv.fconv_rule</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.Trueprop_conv</span></span><span> </span><span class="main"><span>(</span></span><span>Conv.fun2_conv</span><span> </span><span class="entity"><span>parametrize_relation_conv</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(*
  It replaces cr_T by pcr_T op= in the transfer relation. For composed
  abstract types, it replaces T_rel R OO cr_T by pcr_T R. If the parametrized
  correspondce relation does not exist, the original relation is kept.

  thm - a transfer rule
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parametrize_transfer_rule</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> 
  </span><span class="entity"><span>gen_parametrize_transfer_rule</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Lifting_Info.get_quotients</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span></pre>
</body>

</html>