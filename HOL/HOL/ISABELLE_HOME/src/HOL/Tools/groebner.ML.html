<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Tools/groebner.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Tools/groebner.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      HOL/Tools/groebner.ML
    Author:     Amine Chaieb, TU Muenchen
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>GROEBNER</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> ring_and_ideal_conv</span><span class="main"><span>:</span></span><span>
    </span><span class="main"><span>{</span></span><span>idom</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span> </span><span>ring</span><span class="main"><span>:</span></span><span> </span><span>cterm</span><span> </span><span>list</span><span> * </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span> </span><span>field</span><span class="main"><span>:</span></span><span> </span><span>cterm</span><span> </span><span>list</span><span> * </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     </span><span>vars</span><span class="main"><span>:</span></span><span> </span><span>cterm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span> </span><span>semiring</span><span class="main"><span>:</span></span><span> </span><span>cterm</span><span> </span><span>list</span><span> * </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span> </span><span>ideal</span><span> </span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>}</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span>cterm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Rat.rat</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>Rat.rat</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>cterm</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span>conv</span><span> </span><span class="main"><span>-&gt;</span></span><span>  </span><span>conv</span><span> </span><span class="main"><span>-&gt;</span></span><span>
     </span><span class="main"><span>{</span></span><span>ring_conv</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>conv</span><span class="main"><span>,</span></span><span>
     </span><span>simple_ideal</span><span class="main"><span>:</span></span><span> </span><span>cterm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>cterm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>cterm</span><span> </span><span>ord</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>cterm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     </span><span>multi_ideal</span><span class="main"><span>:</span></span><span> </span><span>cterm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>cterm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>cterm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>cterm</span><span> * </span><span>cterm</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     </span><span>poly_eq_ss</span><span class="main"><span>:</span></span><span> </span><span>simpset</span><span class="main"><span>,</span></span><span> </span><span>unwind_conv</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>conv</span><span class="main"><span>}</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> ring_tac</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> ideal_tac</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> algebra_tac</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Groebner</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>GROEBNER</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.cprop_of</span><span> </span><span>#&gt;</span><span> </span><span>Thm.dest_arg</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_binop</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="entity"><span>ct'</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>ct'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="entity"><span>c</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>ct</span></span><span> </span><span>aconv</span><span> </span><span class="entity"><span>c</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_binary</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="entity"><span>ct'</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_binop</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="entity"><span>ct'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Thm.dest_binop</span><span> </span><span class="entity"><span>ct'</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>CTERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"dest_binary: bad binop"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>ct</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ct'</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>denominator_rat</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Rat.dest</span><span> </span><span>#&gt;</span><span> </span><span>snd</span><span> </span><span>#&gt;</span><span> </span><span>Rat.of_int</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>int_of_rat</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Rat.dest</span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"int_of_rat: not an int"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lcm_rat</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>y</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Rat.of_int</span><span> </span><span class="main"><span>(</span></span><span>Integer.lcm</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>int_of_rat</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>int_of_rat</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eqF_intr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eqF_elim</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>th1</span></span><span class="main"><span>,</span></span><span class="entity"><span>th2</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../Groebner_Basis.html#Groebner_Basis.PFalse|fact"><span>PFalse</span></a><span class="antiquote"><span>}</span></span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span>COMP</span><span> </span><span class="entity"><span>th2</span></span><span class="main"><span>,</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span>COMP</span><span> </span><span class="entity"><span>th1</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>PFalse</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>PFalse'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>PFalse_eq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>nth</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../HOL.html#HOL.simp_thms|fact"><span>simp_thms</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="inner_numeral"><span>13</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>PFalse_eq</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>iffD1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>PFalse_eq</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>iffD2</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* Type for recording history, i.e. how a polynomial was obtained. *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>history</span></span><span> </span><span class="main"><span>=</span></span><span>
   </span><span class="entity"><span>Start</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> int
 </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Mmul</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span>Rat.rat * int list</span><span class="main"><span>)</span></span><span> * history
 </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Add</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> history * history</span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* Monomial ordering. *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>morder_lt</span></span><span> </span><span class="entity"><span>m1</span></span><span> </span><span class="entity"><span>m2</span></span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lexorder</span></span><span> </span><span class="entity"><span>l1</span></span><span> </span><span class="entity"><span>l2</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l1</span></span><span class="main"><span>,</span></span><span class="entity"><span>l2</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x1</span></span><span>::</span><span class="entity"><span>o1</span></span><span class="main"><span>,</span></span><span class="entity"><span>x2</span></span><span>::</span><span class="entity"><span>o2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x1</span></span><span> </span><span>&gt;</span><span> </span><span class="entity"><span>x2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>x1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>x2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>lexorder</span></span><span> </span><span class="entity"><span>o1</span></span><span> </span><span class="entity"><span>o2</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"morder: inconsistent monomial lengths"</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>n1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Integer.sum</span><span> </span><span class="entity"><span>m1</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>n2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Integer.sum</span><span> </span><span class="entity"><span>m2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>n1</span></span><span> </span><span>&lt;</span><span> </span><span class="entity"><span>n2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>n1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>n2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>lexorder</span></span><span> </span><span class="entity"><span>m1</span></span><span> </span><span class="entity"><span>m2</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* Arithmetic on canonical polynomials. *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>grob_neg</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="entity"><span>m</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>Rat.neg</span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="entity"><span>m</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>grob_add</span></span><span> </span><span class="entity"><span>l1</span></span><span> </span><span class="entity"><span>l2</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l1</span></span><span class="main"><span>,</span></span><span class="entity"><span>l2</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="entity"><span>l2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>l2</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l1</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>l1</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>c1</span></span><span class="main"><span>,</span></span><span class="entity"><span>m1</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>o1</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>c2</span></span><span class="main"><span>,</span></span><span class="entity"><span>m2</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>o2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>m1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>m2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>c1</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>c2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rest</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>grob_add</span></span><span> </span><span class="entity"><span>o1</span></span><span> </span><span class="entity"><span>o2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@</span></span><span>0</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>rest</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="entity"><span>m1</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>rest</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>morder_lt</span></span><span> </span><span class="entity"><span>m2</span></span><span> </span><span class="entity"><span>m1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c1</span></span><span class="main"><span>,</span></span><span class="entity"><span>m1</span></span><span class="main"><span>)</span></span><span>::</span><span class="main"><span>(</span></span><span class="entity"><span>grob_add</span></span><span> </span><span class="entity"><span>o1</span></span><span> </span><span class="entity"><span>l2</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c2</span></span><span class="main"><span>,</span></span><span class="entity"><span>m2</span></span><span class="main"><span>)</span></span><span>::</span><span class="main"><span>(</span></span><span class="entity"><span>grob_add</span></span><span> </span><span class="entity"><span>l1</span></span><span> </span><span class="entity"><span>o2</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>grob_sub</span></span><span> </span><span class="entity"><span>l1</span></span><span> </span><span class="entity"><span>l2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>grob_add</span></span><span> </span><span class="entity"><span>l1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>grob_neg</span></span><span> </span><span class="entity"><span>l2</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>grob_mmul</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c1</span></span><span class="main"><span>,</span></span><span class="entity"><span>m1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c2</span></span><span class="main"><span>,</span></span><span class="entity"><span>m2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c1</span></span><span> </span><span>*</span><span> </span><span class="entity"><span>c2</span></span><span class="main"><span>,</span></span><span> </span><span>ListPair.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>+</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>grob_cmul</span></span><span> </span><span class="entity"><span>cm</span></span><span> </span><span class="entity"><span>pol</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>grob_mmul</span></span><span> </span><span class="entity"><span>cm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pol</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>grob_mul</span></span><span> </span><span class="entity"><span>l1</span></span><span> </span><span class="entity"><span>l2</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>l1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>h1</span></span><span>::</span><span class="entity"><span>t1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>grob_add</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>grob_cmul</span></span><span> </span><span class="entity"><span>h1</span></span><span> </span><span class="entity"><span>l2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>grob_mul</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>l2</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>grob_inv</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="entity"><span>vs</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="main"><span>(</span></span><span>forall</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vs</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@</span></span><span>0</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"grob_inv: division by zero"</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@</span></span><span>1</span></span></span><span> </span><span>/</span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="entity"><span>vs</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"grob_inv: non-constant divisor polynomial"</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"grob_inv: non-constant divisor polynomial"</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>grob_div</span></span><span> </span><span class="entity"><span>l1</span></span><span> </span><span class="entity"><span>l2</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>l2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="main"><span>(</span></span><span>forall</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                 </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@</span></span><span>0</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"grob_div: division by zero"</span></span><span>
                 </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>grob_cmul</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@</span></span><span>1</span></span></span><span> </span><span>/</span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>l1</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"grob_div: non-constant divisor polynomial"</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"grob_div: non-constant divisor polynomial"</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>grob_pow</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>&lt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"grob_pow: negative power"</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@</span></span><span>1</span></span></span><span class="main"><span>,</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>grob_mul</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>grob_pow</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* Monomial division operation. *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mdiv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c1</span></span><span class="main"><span>,</span></span><span class="entity"><span>m1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c2</span></span><span class="main"><span>,</span></span><span class="entity"><span>m2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>c1</span></span><span> </span><span>/</span><span> </span><span class="entity"><span>c2</span></span><span class="main"><span>,</span></span><span>
   </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>n1</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>n2</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n1</span></span><span> </span><span>&lt;</span><span> </span><span class="entity"><span>n2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"mdiv"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>n1</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>n2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>m1</span></span><span> </span><span class="entity"><span>m2</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* Lowest common multiple of two monomials. *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mlcm</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>m1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>m2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@</span></span><span>1</span></span></span><span class="main"><span>,</span></span><span> </span><span>ListPair.map</span><span> </span><span>Int.max</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* Reduce monomial cm by polynomial pol, returning replacement for cm.  *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>reduce1</span></span><span> </span><span class="entity"><span>cm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pol</span></span><span class="main"><span>,</span></span><span class="entity"><span>hpol</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>pol</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"reduce1"</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cm1</span></span><span>::</span><span class="entity"><span>cms</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="entity"><span>m</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mdiv</span></span><span> </span><span class="entity"><span>cm</span></span><span> </span><span class="entity"><span>cm1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                    </span><span class="main"><span>(</span></span><span class="entity"><span>grob_cmul</span></span><span> </span><span class="main"><span>(</span></span><span>~</span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cms</span></span><span class="main"><span>,</span></span><span>
                     </span><span class="entity"><span>Mmul</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>~</span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="entity"><span>m</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>hpol</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span>  </span><span>ERROR</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"reduce1"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* Try this for all polynomials in a basis.  *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tryfind</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"tryfind"</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>h</span></span><span>::</span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>h</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>ERROR</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>tryfind</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>reduceb</span></span><span> </span><span class="entity"><span>cm</span></span><span> </span><span class="entity"><span>basis</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tryfind</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>reduce1</span></span><span> </span><span class="entity"><span>cm</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>basis</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* Reduction of a polynomial (always picking largest monomial possible).     *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>reduce</span></span><span> </span><span class="entity"><span>basis</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pol</span></span><span class="main"><span>,</span></span><span class="entity"><span>hist</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>pol</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pol</span></span><span class="main"><span>,</span></span><span class="entity"><span>hist</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cm</span></span><span>::</span><span class="entity"><span>ptl</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>q</span></span><span class="main"><span>,</span></span><span class="entity"><span>hnew</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>reduceb</span></span><span> </span><span class="entity"><span>cm</span></span><span> </span><span class="entity"><span>basis</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                   </span><span class="entity"><span>reduce</span></span><span> </span><span class="entity"><span>basis</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>grob_add</span></span><span> </span><span class="entity"><span>q</span></span><span> </span><span class="entity"><span>ptl</span></span><span class="main"><span>,</span></span><span class="entity"><span>Add</span></span><span class="main"><span>(</span></span><span class="entity"><span>hnew</span></span><span class="main"><span>,</span></span><span class="entity"><span>hist</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
               </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="main"><span>(</span></span><span>ERROR</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                   </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>q</span></span><span class="main"><span>,</span></span><span class="entity"><span>hist'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>reduce</span></span><span> </span><span class="entity"><span>basis</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ptl</span></span><span class="main"><span>,</span></span><span class="entity"><span>hist</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                       </span><span class="main"><span>(</span></span><span class="entity"><span>cm</span></span><span>::</span><span class="entity"><span>q</span></span><span class="main"><span>,</span></span><span class="entity"><span>hist'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* Check for orthogonality w.r.t. LCM.                                       *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>orthogonal</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="entity"><span>p1</span></span><span> </span><span class="entity"><span>p2</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>snd</span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>snd</span><span class="main"><span>(</span></span><span class="entity"><span>grob_mmul</span></span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>p1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>p2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* Compute S-polynomial of two polynomials.                                  *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>spoly</span></span><span> </span><span class="entity"><span>cm</span></span><span> </span><span class="entity"><span>ph1</span></span><span> </span><span class="entity"><span>ph2</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ph1</span></span><span class="main"><span>,</span></span><span class="entity"><span>ph2</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="entity"><span>h</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="entity"><span>h</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="entity"><span>h</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="entity"><span>h</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>cm1</span></span><span>::</span><span class="entity"><span>ptl1</span></span><span class="main"><span>,</span></span><span class="entity"><span>his1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>cm2</span></span><span>::</span><span class="entity"><span>ptl2</span></span><span class="main"><span>,</span></span><span class="entity"><span>his2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>grob_sub</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>grob_cmul</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mdiv</span></span><span> </span><span class="entity"><span>cm</span></span><span> </span><span class="entity"><span>cm1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ptl1</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="main"><span>(</span></span><span class="entity"><span>grob_cmul</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mdiv</span></span><span> </span><span class="entity"><span>cm</span></span><span> </span><span class="entity"><span>cm2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ptl2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
         </span><span class="entity"><span>Add</span></span><span class="main"><span>(</span></span><span class="entity"><span>Mmul</span></span><span class="main"><span>(</span></span><span class="entity"><span>mdiv</span></span><span> </span><span class="entity"><span>cm</span></span><span> </span><span class="entity"><span>cm1</span></span><span class="main"><span>,</span></span><span class="entity"><span>his1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
             </span><span class="entity"><span>Mmul</span></span><span class="main"><span>(</span></span><span class="entity"><span>mdiv</span></span><span> </span><span class="main"><span>(</span></span><span>~</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>cm</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>snd</span><span> </span><span class="entity"><span>cm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cm2</span></span><span class="main"><span>,</span></span><span class="entity"><span>his2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* Make a polynomial monic.                                                  *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>monic</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pol</span></span><span class="main"><span>,</span></span><span class="entity"><span>hist</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>pol</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pol</span></span><span class="main"><span>,</span></span><span class="entity"><span>hist</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c'</span></span><span class="main"><span>,</span></span><span class="entity"><span>m'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>hd</span><span> </span><span class="entity"><span>pol</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
  </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="entity"><span>m</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span> </span><span>/</span><span> </span><span class="entity"><span>c'</span></span><span class="main"><span>,</span></span><span class="entity"><span>m</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pol</span></span><span class="main"><span>,</span></span><span>
   </span><span class="entity"><span>Mmul</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@</span></span><span>1</span></span></span><span> </span><span>/</span><span> </span><span class="entity"><span>c'</span></span><span class="main"><span>,</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>m'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>hist</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* The most popular heuristic is to order critical pairs by LCM monomial.    *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>forder</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>m1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>m2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>morder_lt</span></span><span> </span><span class="entity"><span>m1</span></span><span> </span><span class="entity"><span>m2</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>poly_lt</span></span><span>  </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>q</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span class="entity"><span>q</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>c1</span></span><span class="main"><span>,</span></span><span class="entity"><span>m1</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>o1</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>c2</span></span><span class="main"><span>,</span></span><span class="entity"><span>m2</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>o2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>c1</span></span><span> </span><span>&lt;</span><span> </span><span class="entity"><span>c2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
        </span><span class="entity"><span>c1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>c2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>morder_lt</span></span><span> </span><span class="entity"><span>m1</span></span><span> </span><span class="entity"><span>m2</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>m1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>m2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>poly_lt</span></span><span> </span><span class="entity"><span>o1</span></span><span> </span><span class="entity"><span>o2</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>align</span></span><span>  </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span class="entity"><span>hp</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>q</span></span><span class="main"><span>,</span></span><span class="entity"><span>hq</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>poly_lt</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>q</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span class="entity"><span>hp</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>q</span></span><span class="main"><span>,</span></span><span class="entity"><span>hq</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>q</span></span><span class="main"><span>,</span></span><span class="entity"><span>hq</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span class="entity"><span>hp</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>poly_eq</span></span><span> </span><span class="entity"><span>p1</span></span><span> </span><span class="entity"><span>p2</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>eq_list</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>c1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>c1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>c2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m1</span></span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>m2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p2</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>memx</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>p1</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>p2</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ppairs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>q1</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>q2</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>poly_eq</span></span><span> </span><span class="entity"><span>p1</span></span><span> </span><span class="entity"><span>q1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>poly_eq</span></span><span> </span><span class="entity"><span>p2</span></span><span> </span><span class="entity"><span>q2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ppairs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* Buchberger's second criterion.                                            *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>criterion2</span></span><span> </span><span class="entity"><span>basis</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lcm</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>p1</span></span><span class="main"><span>,</span></span><span class="entity"><span>h1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>p2</span></span><span class="main"><span>,</span></span><span class="entity"><span>h2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>opairs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>g</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>not</span><span class="main"><span>(</span></span><span class="entity"><span>poly_eq</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>g</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>p1</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>not</span><span class="main"><span>(</span></span><span class="entity"><span>poly_eq</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>g</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>p2</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
                   </span><span>can</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mdiv</span></span><span> </span><span class="entity"><span>lcm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>hd</span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>g</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
                   </span><span>not</span><span class="main"><span>(</span></span><span class="entity"><span>memx</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>align</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>g</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>p1</span></span><span class="main"><span>,</span></span><span class="entity"><span>h1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>snd</span><span> </span><span class="entity"><span>opairs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
                   </span><span>not</span><span class="main"><span>(</span></span><span class="entity"><span>memx</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>align</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>g</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>p2</span></span><span class="main"><span>,</span></span><span class="entity"><span>h2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>snd</span><span> </span><span class="entity"><span>opairs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>basis</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* Test for hitting constant polynomial.                                     *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>constant_poly</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>length</span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>snd</span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* Grobner basis algorithm.                                                  *)</span></span><span>

</span><span class="comment1"><span>(* FIXME: try to get rid of mergesort? *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>merge</span></span><span> </span><span class="entity"><span>ord</span></span><span> </span><span class="entity"><span>l1</span></span><span> </span><span class="entity"><span>l2</span></span><span> </span><span class="main"><span>=</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>l1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
  </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>l2</span></span><span>
 </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>h1</span></span><span>::</span><span class="entity"><span>t1</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>l2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>l1</span></span><span>
   </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>h2</span></span><span>::</span><span class="entity"><span>t2</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>ord</span></span><span> </span><span class="entity"><span>h1</span></span><span> </span><span class="entity"><span>h2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>h1</span></span><span>::</span><span class="main"><span>(</span></span><span class="entity"><span>merge</span></span><span> </span><span class="entity"><span>ord</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>l2</span></span><span class="main"><span>)</span></span><span>
               </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>h2</span></span><span>::</span><span class="main"><span>(</span></span><span class="entity"><span>merge</span></span><span> </span><span class="entity"><span>ord</span></span><span> </span><span class="entity"><span>l1</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mergesort</span></span><span> </span><span class="entity"><span>ord</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>=</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
 </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mergepairs</span></span><span> </span><span class="entity"><span>l1</span></span><span> </span><span class="entity"><span>l2</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l1</span></span><span class="main"><span>,</span></span><span class="entity"><span>l2</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
   </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>s</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>s</span></span><span>
 </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>mergepairs</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>l</span></span><span>
 </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>s1</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>mergepairs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s1</span></span><span>::</span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
 </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>s1</span></span><span>::</span><span class="entity"><span>s2</span></span><span>::</span><span class="entity"><span>ss</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>mergepairs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>merge</span></span><span> </span><span class="entity"><span>ord</span></span><span> </span><span class="entity"><span>s1</span></span><span> </span><span class="entity"><span>s2</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ss</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>l</span></span><span>  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>mergepairs</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>x</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>grobner_basis</span></span><span> </span><span class="entity"><span>basis</span></span><span> </span><span class="entity"><span>pairs</span></span><span> </span><span class="main"><span>=</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>pairs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
   </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>basis</span></span><span>
 </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>p1</span></span><span class="main"><span>,</span></span><span class="entity"><span>p2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>opairs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sph</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sp</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>monic</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>reduce</span></span><span> </span><span class="entity"><span>basis</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>spoly</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="entity"><span>p1</span></span><span> </span><span class="entity"><span>p2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>sp</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>criterion2</span></span><span> </span><span class="entity"><span>basis</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>p1</span></span><span class="main"><span>,</span></span><span class="entity"><span>p2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>opairs</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>grobner_basis</span></span><span> </span><span class="entity"><span>basis</span></span><span> </span><span class="entity"><span>opairs</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>constant_poly</span></span><span> </span><span class="entity"><span>sp</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>grobner_basis</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sph</span></span><span>::</span><span class="entity"><span>basis</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rawcps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mlcm</span></span><span> </span><span class="main"><span>(</span></span><span>hd</span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>sp</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>align</span></span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span class="entity"><span>sph</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                              </span><span class="entity"><span>basis</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>newcps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span class="entity"><span>q</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>not</span><span class="main"><span>(</span></span><span class="entity"><span>orthogonal</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>q</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                        </span><span class="entity"><span>rawcps</span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>grobner_basis</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sph</span></span><span>::</span><span class="entity"><span>basis</span></span><span class="main"><span>)</span></span><span>
                 </span><span class="main"><span>(</span></span><span class="entity"><span>merge</span></span><span> </span><span class="entity"><span>forder</span></span><span> </span><span class="entity"><span>opairs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mergesort</span></span><span> </span><span class="entity"><span>forder</span></span><span> </span><span class="entity"><span>newcps</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* Interreduce initial polynomials.                                          *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>grobner_interreduce</span></span><span> </span><span class="entity"><span>rpols</span></span><span> </span><span class="entity"><span>ipols</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>ipols</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>monic</span></span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="entity"><span>rpols</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>p</span></span><span>::</span><span class="entity"><span>ps</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>p'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>reduce</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rpols</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>ps</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>p'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>grobner_interreduce</span></span><span> </span><span class="entity"><span>rpols</span></span><span> </span><span class="entity"><span>ps</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>grobner_interreduce</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p'</span></span><span>::</span><span class="entity"><span>rpols</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ps</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* Overall function.                                                         *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>grobner</span></span><span> </span><span class="entity"><span>pols</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>npols</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_index</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Start</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pols</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>phists</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>npols</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bas</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>grobner_interreduce</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>monic</span></span><span> </span><span class="entity"><span>phists</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prs0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_product</span><span> </span><span>pair</span><span> </span><span class="entity"><span>bas</span></span><span> </span><span class="entity"><span>bas</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prs1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>y</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>poly_lt</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prs0</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prs2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span class="entity"><span>q</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mlcm</span></span><span> </span><span class="main"><span>(</span></span><span>hd</span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>hd</span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>q</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span class="entity"><span>q</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prs1</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prs3</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span class="entity"><span>q</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>not</span><span class="main"><span>(</span></span><span class="entity"><span>orthogonal</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>q</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prs2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>grobner_basis</span></span><span> </span><span class="entity"><span>bas</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mergesort</span></span><span> </span><span class="entity"><span>forder</span></span><span> </span><span class="entity"><span>prs3</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* Get proof of contradiction from Grobner basis.                            *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>find</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"find"</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>h</span></span><span>::</span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>(</span></span><span class="entity"><span>h</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>h</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>find</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>grobner_refute</span></span><span> </span><span class="entity"><span>pols</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>gb</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>grobner</span></span><span> </span><span class="entity"><span>pols</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
  </span><span>snd</span><span class="main"><span>(</span></span><span class="entity"><span>find</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>=</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>snd</span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>gb</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* Turn proof into a certificate as sum of multipliers.                      *)</span></span><span>
</span><span class="comment1"><span>(* In principle this is very inefficient: in a heavily shared proof it may   *)</span></span><span>
</span><span class="comment1"><span>(* make the same calculation many times. Could put in a cache or something.  *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>resolve_proof</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="entity"><span>Start</span></span><span class="main"><span>(</span></span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Start</span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>m</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@</span></span><span>1</span></span></span><span class="main"><span>,</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Mmul</span></span><span class="main"><span>(</span></span><span class="entity"><span>pol</span></span><span class="main"><span>,</span></span><span class="entity"><span>lin</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lis</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>resolve_proof</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>lin</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span class="entity"><span>grob_cmul</span></span><span> </span><span class="entity"><span>pol</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lis</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Add</span></span><span class="main"><span>(</span></span><span class="entity"><span>lin1</span></span><span class="main"><span>,</span></span><span class="entity"><span>lin2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lis1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>resolve_proof</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>lin1</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lis2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>resolve_proof</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>lin2</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dom</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>distinct</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>union</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>lis1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>lis2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>these</span><span> </span><span class="main"><span>(</span></span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lis1</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span>
                             </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>these</span><span> </span><span class="main"><span>(</span></span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lis2</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span>
                         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span class="entity"><span>grob_add</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>dom</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* Run the procedure and produce Weak Nullstellensatz certificate.           *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>grobner_weak</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>pols</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cert</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>resolve_proof</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>grobner_refute</span></span><span> </span><span class="entity"><span>pols</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lcm_rat</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>denominator_rat</span></span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cert</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@</span></span><span>1</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>d</span></span><span class="main"><span>,</span></span><span class="entity"><span>m</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span> </span><span>*</span><span> </span><span class="entity"><span>d</span></span><span class="main"><span>,</span></span><span class="entity"><span>m</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cert</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* Prove a polynomial is in ideal generated by others, using Grobner basis.  *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>grobner_ideal</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>pols</span></span><span> </span><span class="entity"><span>pol</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pol'</span></span><span class="main"><span>,</span></span><span class="entity"><span>h</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>reduce</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>grobner</span></span><span> </span><span class="entity"><span>pols</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>grob_neg</span></span><span> </span><span class="entity"><span>pol</span></span><span class="main"><span>,</span></span><span class="entity"><span>Start</span></span><span class="main"><span>(</span></span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span class="entity"><span>pol'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"grobner_ideal: not in the ideal"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
  </span><span class="entity"><span>resolve_proof</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>h</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* Produce Strong Nullstellensatz certificate for a power of pol.            *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>grobner_strong</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>pols</span></span><span> </span><span class="entity"><span>pol</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vars'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">cterm</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span></span></span><span>::</span><span class="entity"><span>vars</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>grob_z</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@</span></span><span>1</span></span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>::</span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>grob_1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@</span></span><span>1</span></span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vars'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>augment</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="entity"><span>m</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="inner_numeral"><span>0</span></span><span>::</span><span class="entity"><span>m</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>p</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pols'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>augment</span></span><span> </span><span class="entity"><span>pols</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pol'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>augment</span></span><span> </span><span class="entity"><span>pol</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>allpols</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>grob_sub</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>grob_mul</span></span><span> </span><span class="entity"><span>grob_z</span></span><span> </span><span class="entity"><span>pol'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>grob_1</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>pols'</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span class="entity"><span>cert</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>grobner_weak</span></span><span> </span><span class="entity"><span>vars'</span></span><span> </span><span class="entity"><span>allpols</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>d</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>Integer.max</span><span> </span><span>o</span><span> </span><span>hd</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cert</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>transform_monomial</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="entity"><span>m</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="entity"><span>grob_cmul</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span>tl</span><span> </span><span class="entity"><span>m</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>grob_pow</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>pol</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>d</span></span><span> </span><span>-</span><span> </span><span>hd</span><span> </span><span class="entity"><span>m</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>transform_polynomial</span></span><span> </span><span class="entity"><span>q</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>grob_add</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>transform_monomial</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>q</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cert'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="entity"><span>q</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span>-</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span class="entity"><span>transform_polynomial</span></span><span> </span><span class="entity"><span>q</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                        </span><span class="main"><span>(</span></span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cert</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>d</span></span><span class="main"><span>,</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span class="entity"><span>cert'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* Overall parametrized universal procedure for (semi)rings.                 *)</span></span><span>
</span><span class="comment1"><span>(* We return an ideal_conv and the actual ring prover.                       *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>refute_disj</span></span><span> </span><span class="entity"><span>rfn</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
  </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.disj|const"><span>HOL.disj</span></a><span>›</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>$</span><span class="main"><span>_</span></span><span>$</span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
   </span><span>Drule.compose</span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>refute_disj</span></span><span> </span><span class="entity"><span>rfn</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.dest_arg</span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span class="main"><span>,</span></span><span>
      </span><span>Drule.compose</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>refute_disj</span></span><span> </span><span class="entity"><span>rfn</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.dest_arg1</span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>disjE</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>rfn</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>notnotD</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../HOL.html#HOL.notnotD|fact"><span>notnotD</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_binop</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="entity"><span>y</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.apply</span><span> </span><span class="main"><span>(</span></span><span>Thm.apply</span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>y</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_neg</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.Not|const"><span>Not</span></a><span>›</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>$</span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span>  </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_eq</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
 </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>$</span><span class="main"><span>_</span></span><span>$</span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span>
</span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span>  </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>end_itlist</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>     </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"end_itlist"</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>x</span></span><span class="main"><span>]</span></span><span>    </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>h</span></span><span>::</span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>h</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>end_itlist</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>list_mk_binop</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>end_itlist</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_binop</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>list_dest_binop</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>h</span></span><span> </span><span class="entity"><span>acc</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_binary</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>h</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>h</span></span><span> </span><span class="entity"><span>acc</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>CTERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span>::</span><span class="entity"><span>acc</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="comment1"><span>(* Why had I handle _ =&gt; ? *)</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>h</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>strip_exists</span></span><span> </span><span class="main"><span>=</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>h</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>acc</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
       </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.Ex|const"><span>Ex</span></a><span> </span><span class="main"><span>_</span></span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="quoted"><span>‹</span><span>Abs</span><span> </span><span class="main"><span>_</span></span><span>›</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>h</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.dest_abs_global</span><span> </span><span class="main"><span>(</span></span><span>Thm.dest_arg</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>v</span></span><span>::</span><span class="entity"><span>acc</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
     </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>acc</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>h</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_forall</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
  </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.All|const"><span>All</span></a><span>›</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>$</span><span>Abs</span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span>
</span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nnf_simps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../Groebner_Basis.html#Groebner_Basis.nnf_simps|fact"><span>nnf_simps</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>weak_dnf_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Simplifier.rewrite</span></span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>HOL_basic_ss</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>addsimps</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../Groebner_Basis.html#Groebner_Basis.weak_dnf_simps|fact"><span>weak_dnf_simps</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>initial_ss</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>simpset_of</span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>HOL_basic_ss</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span><span class="hidden">\&lt;^</span><span class="control">context</span><span class="hidden">&gt;</span></span></span></span></span><span>
    </span><span>addsimps</span><span> </span><span class="entity"><span>nnf_simps</span></span><span>
    </span><span>addsimps</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>not_all</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>not_ex</span></span><span class="main"><span>]</span></span><span>
    </span><span>addsimps</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../HOL.html#HOL.ex_simps|fact"><span>ex_simps</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>@</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../HOL.html#HOL.all_simps|fact"><span>all_simps</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>initial_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Simplifier.rewrite</span></span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>initial_ss</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>specl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Thm.instantiate'</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span>SOME</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>spec</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cTrp</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">cterm</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cConj</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">cterm</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.conj|const"><span>HOL.conj</span></a><span>›</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cNot</span></span><span class="main"><span>,</span></span><span class="entity"><span>false_tm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">cterm</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.Not|const"><span>Not</span></a><span>›</span></span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">cterm</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.False|const"><span>False</span></a><span>›</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>assume_Trueprop</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.apply</span><span> </span><span class="entity"><span>cTrp</span></span><span> </span><span>#&gt;</span><span> </span><span>Thm.assume</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>list_mk_conj</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>list_mk_binop</span></span><span> </span><span class="entity"><span>cConj</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>conjs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>list_dest_binop</span></span><span> </span><span class="entity"><span>cConj</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mk_neg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.apply</span><span> </span><span class="entity"><span>cNot</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>striplist</span></span><span> </span><span class="entity"><span>dest</span></span><span> </span><span class="main"><span>=</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>h</span></span><span> </span><span class="entity"><span>acc</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="entity"><span>dest</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>h</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>h</span></span><span> </span><span class="entity"><span>acc</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>a</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span>::</span><span class="entity"><span>acc</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>h</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>list_mk_binop</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>foldr1</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Thm.apply</span><span> </span><span class="main"><span>(</span></span><span>Thm.apply</span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eq_commute</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_meta_eq</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../HOL.html#HOL.eq_commute|fact"><span>eq_commute</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>sym_conv</span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="main"><span>=</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.dest_binop</span><span> </span><span class="entity"><span>eq</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Thm.instantiate'</span><span> </span><span class="main"><span>[</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Thm.ctyp_of_cterm</span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span>SOME</span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>eq_commute</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

  </span><span class="comment1"><span>(* FIXME : copied from cqe.ML -- complex QE*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>conjuncts</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
  </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.conj|const"><span>HOL.conj</span></a><span>›</span></span></span><span>$</span><span class="main"><span>_</span></span><span>$</span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.dest_arg1</span><span> </span><span class="entity"><span>ct</span></span><span class="main"><span>)</span></span><span>::</span><span class="main"><span>(</span></span><span class="entity"><span>conjuncts</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.dest_arg</span><span> </span><span class="entity"><span>ct</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
</span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>ct</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fold1</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>foldr1</span><span> </span><span class="main"><span>(</span></span><span>uncurry</span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_conj_tab</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>h</span></span><span> </span><span class="entity"><span>acc</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.prop_of</span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
   </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span></span><span>$</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.conj|const"><span>HOL.conj</span></a><span>›</span></span></span><span>$</span><span class="main"><span>_</span></span><span>$</span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
     </span><span class="entity"><span>h</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>h</span></span><span> </span><span class="entity"><span>acc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>conjunct2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>conjunct1</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span></span><span>$</span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>acc</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>Termtab.insert</span><span> </span><span>Thm.eq_thm</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>h</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span> </span><span>Termtab.empty</span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_conj</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.conj|const"><span>HOL.conj</span></a><span>›</span></span></span><span>$</span><span class="main"><span>_</span></span><span>$</span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_conj</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prove_conj</span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="entity"><span>cjs</span></span><span> </span><span class="main"><span>=</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>cjs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
   </span><span class="main"><span>[</span></span><span class="entity"><span>c</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_conj</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>prove_conj</span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>conjuncts</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="entity"><span>c</span></span><span>
 </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>c</span></span><span>::</span><span class="entity"><span>cs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>conjI</span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>prove_conj</span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>c</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prove_conj</span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="entity"><span>cs</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>conj_ac_rule</span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="main"><span>=</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.dest_equals</span><span> </span><span class="entity"><span>eq</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctabl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_conj_tab</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.assume</span><span> </span><span class="main"><span>(</span></span><span>Thm.apply</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">cterm</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span></span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctabr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_conj_tab</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.assume</span><span> </span><span class="main"><span>(</span></span><span>Thm.apply</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">cterm</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span></span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tabl</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the</span><span> </span><span class="main"><span>(</span></span><span>Termtab.lookup</span><span> </span><span class="entity"><span>ctabl</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tabr</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the</span><span> </span><span class="main"><span>(</span></span><span>Termtab.lookup</span><span> </span><span class="entity"><span>ctabr</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thl</span></span><span>  </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prove_conj</span></span><span> </span><span class="entity"><span>tabl</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>conjuncts</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>implies_intr_hyps</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thr</span></span><span>  </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prove_conj</span></span><span> </span><span class="entity"><span>tabr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>conjuncts</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>implies_intr_hyps</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eqI</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.instantiate'</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span>SOME</span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>]</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../HOL.html#HOL.iffI|fact"><span>iffI</span></a><span class="antiquote"><span>}</span></span></span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Thm.implies_elim</span><span> </span><span class="main"><span>(</span></span><span>Thm.implies_elim</span><span> </span><span class="entity"><span>eqI</span></span><span> </span><span class="entity"><span>thl</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thr</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>mk_meta_eq</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

 </span><span class="comment1"><span>(* END FIXME.*)</span></span><span>

   </span><span class="comment1"><span>(* Conversion for the equivalence of existential statements where
      EX quantifiers are rearranged differently *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ext</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.Ex|const"><span>Ex</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span>--&gt;</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span> </span><span>--&gt;</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_ex</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.apply</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ext</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.typ_of_cterm</span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.lambda</span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>choose</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="entity"><span>th'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.concl_of</span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
  </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.Ex|const"><span>Ex</span></a><span>›</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>$</span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>funpow</span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span>Thm.dest_arg</span><span> </span><span>o</span><span> </span><span>Thm.cprop_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>th</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.dest_ctyp0</span><span> </span><span class="main"><span>(</span></span><span>Thm.ctyp_of_cterm</span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>th0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Conv.fconv_rule</span><span> </span><span class="main"><span>(</span></span><span>Thm.beta_conversion</span><span> </span><span>true</span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span>Thm.instantiate'</span><span> </span><span class="main"><span>[</span></span><span>SOME</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span>SOME</span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span>o</span><span> </span><span>Thm.dest_arg</span><span> </span><span>o</span><span> </span><span>Thm.cprop_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>th'</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>exE</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pv</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.rhs_of</span><span> </span><span>o</span><span> </span><span>Thm.beta_conversion</span><span> </span><span>true</span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>(</span></span><span>Thm.apply</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">cterm</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span></span></span><span> </span><span class="main"><span>(</span></span><span>Thm.apply</span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>th1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.forall_intr</span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.implies_intr</span><span> </span><span class="entity"><span>pv</span></span><span> </span><span class="entity"><span>th'</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Thm.implies_elim</span><span> </span><span class="main"><span>(</span></span><span>Thm.implies_elim</span><span> </span><span class="entity"><span>th0</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>th1</span></span><span>  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>""</span></span><span>  </span><span class="comment1"><span>(* FIXME ? *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>simple_choose</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span>
   </span><span class="entity"><span>choose</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.assume</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Thm.apply</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">cterm</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span></span></span><span> </span><span>o</span><span> </span><span class="entity"><span>mk_ex</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>(</span></span><span>Thm.dest_arg</span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="main"><span>(</span></span><span>Thm.chyps_of</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>th</span></span><span>


 </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mkexi</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
   </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.lambda</span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.dest_arg</span><span> </span><span class="main"><span>(</span></span><span>Thm.cprop_of</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Thm.implies_elim</span><span>
    </span><span class="main"><span>(</span></span><span>Conv.fconv_rule</span><span> </span><span class="main"><span>(</span></span><span>Thm.beta_conversion</span><span> </span><span>true</span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span>Thm.instantiate'</span><span> </span><span class="main"><span>[</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Thm.ctyp_of_cterm</span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span>SOME</span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>]</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../HOL.html#HOL.exI|fact"><span>exI</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="entity"><span>th</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
 </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ex_eq_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p0</span></span><span class="main"><span>,</span></span><span class="entity"><span>q0</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.dest_binop</span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vs'</span></span><span class="main"><span>,</span></span><span class="entity"><span>P</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>strip_exists</span></span><span> </span><span class="entity"><span>p0</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vs</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>strip_exists</span></span><span> </span><span class="entity"><span>q0</span></span><span>
   </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.assume</span><span> </span><span class="main"><span>(</span></span><span>Thm.apply</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">cterm</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span></span></span><span> </span><span class="entity"><span>P</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>th1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>implies_intr_hyps</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>simple_choose</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vs'</span></span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="entity"><span>mkexi</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>th2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>implies_intr_hyps</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>simple_choose</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="entity"><span>mkexi</span></span><span> </span><span class="entity"><span>vs'</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.dest_arg</span><span> </span><span>o</span><span> </span><span>Thm.dest_arg1</span><span> </span><span>o</span><span> </span><span>Thm.cprop_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>th1</span></span><span>
   </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>q</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.dest_arg</span><span> </span><span>o</span><span> </span><span>Thm.dest_arg</span><span> </span><span>o</span><span> </span><span>Thm.cprop_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>th1</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Thm.implies_elim</span><span> </span><span class="main"><span>(</span></span><span>Thm.implies_elim</span><span> </span><span class="main"><span>(</span></span><span>Thm.instantiate'</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span>SOME</span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>q</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>iffI</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>th1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>th2</span></span><span>
     </span><span>|&gt;</span><span> </span><span class="entity"><span>mk_meta_eq</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


 </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>getname</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
  </span><span>Free</span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>s</span></span><span>
 </span><span class="main"><span>|</span></span><span> </span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>s</span></span><span>
 </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"x"</span></span><span>
 </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_eq</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.apply</span><span> </span><span class="main"><span>(</span></span><span>Thm.apply</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">cterm</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><span class="main"><span>(≡)</span></span><span> </span><span class="main"><span>::</span></span><span> </span><a class="entity_ref" href="../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span> </span><span class="main"><span>⇒</span></span><span> </span><span class="main"><span>_</span></span><span>›</span></span></span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span>
 </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_exists</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Drule.arg_cong_rule</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ext</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.typ_of_cterm</span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span class="main"><span>(</span></span><span>Thm.abstract_rule</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>getname</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span>
 </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>simp_ex_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
   </span><span class="entity"><span>Simplifier.rewrite</span></span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>HOL_basic_ss</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>addsimps</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../HOL.html#HOL.simp_thms|fact"><span>simp_thms</span></a><span class="main"><span>(</span></span><span>39</span><span class="main"><span>)</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>free_in</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Cterms.defined</span><span> </span><span class="main"><span>(</span></span><span>Cterms.build</span><span> </span><span class="main"><span>(</span></span><span>Drule.add_frees_cterm</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vsubst</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
 </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>vsubst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span>
   </span><span class="main"><span>(</span></span><span>Thm.rhs_of</span><span> </span><span>o</span><span> </span><span>Thm.beta_conversion</span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.apply</span><span> </span><span class="main"><span>(</span></span><span>Thm.lambda</span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>vsubst</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(** main **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ring_and_ideal_conv</span></span><span>
  </span><span class="main"><span>{</span></span><span>vars</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>semiring</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sr_ops</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>ring</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r_ops</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span>field</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f_ops</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>idom</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ideal</span></span><span class="main"><span>}</span></span><span>
  </span><span class="entity"><span>dest_const</span></span><span> </span><span class="entity"><span>mk_const</span></span><span> </span><span class="entity"><span>ring_eq_conv</span></span><span> </span><span class="entity"><span>ring_normalize_conv</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>add_pat</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mul_pat</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pow_pat</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>zero_tm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>one_tm</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>sr_ops</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>ring_add_tm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ring_mul_tm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ring_pow_tm</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>map</span><span> </span><span>Thm.dest_fun2</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>add_pat</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mul_pat</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pow_pat</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ring_sub_tm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ring_neg_tm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>r_ops</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
     </span><span class="main"><span>[</span></span><span class="entity"><span>sub_pat</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>neg_pat</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.dest_fun2</span><span> </span><span class="entity"><span>sub_pat</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.dest_fun</span><span> </span><span class="entity"><span>neg_pat</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span class="main"><span>_</span></span><span>  </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">cterm</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">cterm</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>field_div_tm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>field_inv_tm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>f_ops</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
       </span><span class="main"><span>[</span></span><span class="entity"><span>div_pat</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>inv_pat</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.dest_fun2</span><span> </span><span class="entity"><span>div_pat</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.dest_fun</span><span> </span><span class="entity"><span>inv_pat</span></span><span class="main"><span>)</span></span><span>
     </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">cterm</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">cterm</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>idom_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>neq_thm</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>idom</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>idl_sub</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>idl_add0</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>length</span><span> </span><span class="entity"><span>ideal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>ideal</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>eq_commute</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eq_commute</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ring_dest_neg</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.dest_comb</span><span> </span><span class="entity"><span>t</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Term.could_unify</span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>ring_neg_tm</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>r</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>CTERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"ring_dest_neg"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

 </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>field_dest_inv</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.dest_comb</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Term.could_unify</span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>field_inv_tm</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>r</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>CTERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"field_dest_inv"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
 </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ring_dest_add</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_binary</span></span><span> </span><span class="entity"><span>ring_add_tm</span></span><span class="main"><span>;</span></span><span>
 </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ring_mk_add</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_binop</span></span><span> </span><span class="entity"><span>ring_add_tm</span></span><span class="main"><span>;</span></span><span>
 </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ring_dest_sub</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_binary</span></span><span> </span><span class="entity"><span>ring_sub_tm</span></span><span class="main"><span>;</span></span><span>
 </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ring_dest_mul</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_binary</span></span><span> </span><span class="entity"><span>ring_mul_tm</span></span><span class="main"><span>;</span></span><span>
 </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ring_mk_mul</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_binop</span></span><span> </span><span class="entity"><span>ring_mul_tm</span></span><span class="main"><span>;</span></span><span>
 </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>field_dest_div</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_binary</span></span><span> </span><span class="entity"><span>field_div_tm</span></span><span class="main"><span>;</span></span><span>
 </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ring_dest_pow</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_binary</span></span><span> </span><span class="entity"><span>ring_pow_tm</span></span><span class="main"><span>;</span></span><span>
 </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ring_mk_pow</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_binop</span></span><span> </span><span class="entity"><span>ring_pow_tm</span></span><span> </span><span class="main"><span>;</span></span><span>
 </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>grobvars</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="entity"><span>acc</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>can</span><span> </span><span class="entity"><span>dest_const</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>acc</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>can</span><span> </span><span class="entity"><span>ring_dest_neg</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>grobvars</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.dest_arg</span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>acc</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>can</span><span> </span><span class="entity"><span>ring_dest_pow</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>grobvars</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.dest_arg1</span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>acc</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>can</span><span> </span><span class="entity"><span>ring_dest_add</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>can</span><span> </span><span class="entity"><span>ring_dest_sub</span></span><span> </span><span class="entity"><span>tm</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>can</span><span> </span><span class="entity"><span>ring_dest_mul</span></span><span> </span><span class="entity"><span>tm</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>grobvars</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.dest_arg1</span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>grobvars</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.dest_arg</span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>acc</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>can</span><span> </span><span class="entity"><span>field_dest_inv</span></span><span> </span><span class="entity"><span>tm</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>gvs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>grobvars</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.dest_arg</span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>gvs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>acc</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>tm</span></span><span>::</span><span class="entity"><span>acc</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>can</span><span> </span><span class="entity"><span>field_dest_div</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lvs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>grobvars</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.dest_arg1</span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>acc</span></span><span>
             </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>gvs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>grobvars</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.dest_arg</span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>gvs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>lvs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>tm</span></span><span>::</span><span class="entity"><span>acc</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>tm</span></span><span>::</span><span class="entity"><span>acc</span></span><span> </span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>grobify_term</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconvc</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>CTERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Not a variable"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>tm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
     </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@</span></span><span>1</span></span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>aconvc</span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span>  </span><span>CTERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
 </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_const</span></span><span> </span><span class="entity"><span>tm</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@</span></span><span>0</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
 </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>ERROR</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
  </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>grob_neg</span></span><span class="main"><span>(</span></span><span class="entity"><span>grobify_term</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ring_dest_neg</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>CTERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
   </span><span class="main"><span>(</span></span><span>
   </span><span class="main"><span>(</span></span><span class="entity"><span>grob_inv</span></span><span class="main"><span>(</span></span><span class="entity"><span>grobify_term</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>field_dest_inv</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>CTERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ring_dest_add</span></span><span> </span><span class="entity"><span>tm</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>grob_add</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>grobify_term</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>grobify_term</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>CTERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
     </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ring_dest_sub</span></span><span> </span><span class="entity"><span>tm</span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>grob_sub</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>grobify_term</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>grobify_term</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
     </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span>  </span><span>CTERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ring_dest_mul</span></span><span> </span><span class="entity"><span>tm</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>grob_mul</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>grobify_term</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>grobify_term</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
       </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>CTERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="main"><span>(</span></span><span>  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>field_dest_div</span></span><span> </span><span class="entity"><span>tm</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>grob_div</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>grobify_term</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>grobify_term</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
         </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>CTERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ring_dest_pow</span></span><span> </span><span class="entity"><span>tm</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>grob_pow</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>grobify_term</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>HOLogic.dest_number</span></span><span> </span><span>#&gt;</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
           </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>CTERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"grobify_term: unknown or invalid term"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eq_tm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>idom_thm</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>concl</span></span><span> </span><span>|&gt;</span><span> </span><span>Thm.dest_arg</span><span> </span><span>|&gt;</span><span> </span><span>Thm.dest_arg</span><span> </span><span>|&gt;</span><span> </span><span>Thm.dest_fun2</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dest_eq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_binary</span></span><span> </span><span class="entity"><span>eq_tm</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>grobify_equation</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_binary</span></span><span> </span><span class="entity"><span>eq_tm</span></span><span> </span><span class="entity"><span>tm</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>grob_sub</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>grobify_term</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>grobify_term</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>grobify_equations</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cjs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>conjs</span></span><span> </span><span class="entity"><span>tm</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span>  </span><span class="entity"><span>rawvars</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>grobvars</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.dest_arg1</span><span> </span><span class="entity"><span>eq</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>grobvars</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.dest_arg</span><span> </span><span class="entity"><span>eq</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cjs</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>sort</span><span> </span><span>Thm.term_ord</span><span> </span><span class="main"><span>(</span></span><span>distinct</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconvc</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rawvars</span></span><span class="main"><span>)</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>grobify_equation</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cjs</span></span><span class="main"><span>)</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>holify_polynomial</span></span><span> </span><span class="main"><span>=</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>holify_varpow</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>ring_mk_pow</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Numeral.mk_cnumber</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">ctyp</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../Nat.html#Nat.nat|type"><span>nat</span></a><span>›</span></span></span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span>  </span><span class="comment1"><span>(* FIXME *)</span></span><span>
 </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>holify_monomial</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="entity"><span>m</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>xps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>holify_varpow</span></span><span> </span><span class="main"><span>(</span></span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vars</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>m</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>end_itlist</span></span><span> </span><span class="entity"><span>ring_mk_mul</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_const</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>xps</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
 </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>holify_polynomial</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=</span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>mk_const</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@</span></span><span>0</span></span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>end_itlist</span></span><span> </span><span class="entity"><span>ring_mk_add</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>holify_monomial</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>holify_polynomial</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span> </span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>idom_rule</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>simplify</span></span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>HOL_basic_ss</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>addsimps</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>idom_thm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prove_nz</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eqF_elim</span></span><span>
                 </span><span class="main"><span>(</span></span><span class="entity"><span>ring_eq_conv</span></span><span class="main"><span>(</span></span><span class="entity"><span>mk_binop</span></span><span> </span><span class="entity"><span>eq_tm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_const</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_const</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@</span></span><span>0</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>neq_01</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prove_nz</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@</span></span><span>1</span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>neq_rule</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>prove_nz</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>]</span></span><span> </span><span>MRS</span><span> </span><span class="entity"><span>neq_thm</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_add</span></span><span> </span><span class="entity"><span>th1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.combination</span><span> </span><span class="main"><span>(</span></span><span>Drule.arg_cong_rule</span><span> </span><span class="entity"><span>ring_add_tm</span></span><span> </span><span class="entity"><span>th1</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>refute</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span>aconvc</span><span> </span><span class="entity"><span>false_tm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>assume_Trueprop</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
 </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
   </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nths0</span></span><span class="main"><span>,</span></span><span class="entity"><span>eths0</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.partition</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_neg</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.conj_elims</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>assume_Trueprop</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span>  </span><span class="entity"><span>nths</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_eq</span></span><span> </span><span>o</span><span> </span><span>Thm.dest_arg</span><span> </span><span>o</span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>nths0</span></span><span>
   </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eths</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_eq</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eths0</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>eths</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>th1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>end_itlist</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>th1</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>th2</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>idom_rule</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.conj_intr</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>th1</span></span><span> </span><span class="entity"><span>th2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>nths</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>th2</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>Conv.fconv_rule</span><span>
          </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Conv.arg_conv</span><span> </span><span>#&gt;</span><span> </span><span>Conv.arg_conv</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Conv.binop_conv</span><span> </span><span class="entity"><span>ring_normalize_conv</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>th1</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>conc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>th2</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>concl</span></span><span> </span><span>|&gt;</span><span> </span><span>Thm.dest_arg</span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>conc</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>dest_eq</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Thm.implies_intr</span><span> </span><span class="main"><span>(</span></span><span>Thm.apply</span><span> </span><span class="entity"><span>cTrp</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="main"><span>(</span></span><span>Thm.equal_elim</span><span> </span><span class="main"><span>(</span></span><span>Drule.arg_cong_rule</span><span> </span><span class="entity"><span>cTrp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eqF_intr</span></span><span> </span><span class="entity"><span>th2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                           </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_obj_eq</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.reflexive</span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span class="entity"><span>cert</span></span><span class="main"><span>,</span></span><span class="entity"><span>noteqth</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>(</span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>nths</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span class="entity"><span>pols</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>grobify_equations</span></span><span class="main"><span>(</span></span><span class="entity"><span>list_mk_conj</span></span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="entity"><span>eths</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span class="entity"><span>cert</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>grobner_weak</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>pols</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span class="entity"><span>cert</span></span><span class="main"><span>,</span></span><span class="entity"><span>neq_01</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
       </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nth</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>end_itlist</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>th1</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>th2</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>idom_rule</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.conj_intr</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>th1</span></span><span> </span><span class="entity"><span>th2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>nths</span></span><span>
       </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span class="entity"><span>pol</span></span><span>::</span><span class="entity"><span>pols</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>grobify_equations</span></span><span class="main"><span>(</span></span><span class="entity"><span>list_mk_conj</span></span><span class="main"><span>(</span></span><span>Thm.dest_arg</span><span class="main"><span>(</span></span><span class="entity"><span>concl</span></span><span> </span><span class="entity"><span>nth</span></span><span class="main"><span>)</span></span><span>::</span><span>map</span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="entity"><span>eths</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
       </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>deg</span></span><span class="main"><span>,</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span class="entity"><span>cert</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>grobner_strong</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>pols</span></span><span> </span><span class="entity"><span>pol</span></span><span>
       </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>th1</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>Conv.fconv_rule</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Conv.arg_conv</span><span> </span><span>o</span><span> </span><span>Conv.arg_conv</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Conv.binop_conv</span><span> </span><span class="entity"><span>ring_normalize_conv</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>nth</span></span><span>
       </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>th2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>funpow</span><span> </span><span class="entity"><span>deg</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>idom_rule</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>HOLogic.conj_intr</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>th1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>neq_01</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span class="entity"><span>cert</span></span><span class="main"><span>,</span></span><span class="entity"><span>th2</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cert_pos</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span>&gt;</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@</span></span><span>0</span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cert</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cert_neg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="entity"><span>m</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>~</span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="entity"><span>m</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                                            </span><span class="main"><span>(</span></span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span>&lt;</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@</span></span><span>0</span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cert</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span>  </span><span class="entity"><span>herts_pos</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>holify_polynomial</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cert_pos</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span>  </span><span class="entity"><span>herts_neg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>holify_polynomial</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cert_neg</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>thm_fn</span></span><span> </span><span class="entity"><span>pols</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>pols</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Thm.reflexive</span><span class="main"><span>(</span></span><span class="entity"><span>mk_const</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@</span></span><span>0</span></span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="entity"><span>end_itlist</span></span><span> </span><span class="entity"><span>mk_add</span></span><span>
            </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Drule.arg_cong_rule</span><span> </span><span class="main"><span>(</span></span><span>Thm.apply</span><span> </span><span class="entity"><span>ring_mul_tm</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>eths</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>mk_meta_eq</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pols</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>th1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thm_fn</span></span><span> </span><span class="entity"><span>herts_pos</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>th2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thm_fn</span></span><span> </span><span class="entity"><span>herts_neg</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>th3</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.conj_intr</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_obj_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_add</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.symmetric</span><span> </span><span class="entity"><span>th1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>th2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>noteqth</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>th4</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Conv.fconv_rule</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Conv.arg_conv</span><span> </span><span>o</span><span> </span><span>Conv.arg_conv</span><span> </span><span>o</span><span> </span><span>Conv.binop_conv</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ring_normalize_conv</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>neq_rule</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="entity"><span>th3</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_eq</span></span><span class="main"><span>(</span></span><span>Thm.dest_arg</span><span class="main"><span>(</span></span><span class="entity"><span>concl</span></span><span> </span><span class="entity"><span>th4</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Thm.implies_intr</span><span> </span><span class="main"><span>(</span></span><span>Thm.apply</span><span> </span><span class="entity"><span>cTrp</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span>
                        </span><span class="main"><span>(</span></span><span>Thm.equal_elim</span><span> </span><span class="main"><span>(</span></span><span>Drule.arg_cong_rule</span><span> </span><span class="entity"><span>cTrp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eqF_intr</span></span><span> </span><span class="entity"><span>th4</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                   </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_obj_eq</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.reflexive</span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span> </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>ERROR</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>CTERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Groebner-refute: unable to refute"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>tm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ring</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_forall</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.typ_of_cterm</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>all</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.All|const"><span>All</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span>--&gt;</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span> </span><span>--&gt;</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Thm.apply</span><span> </span><span class="entity"><span>all</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.lambda</span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>avs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Cterms.build</span><span> </span><span class="main"><span>(</span></span><span>Drule.add_frees_cterm</span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>P'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>mk_forall</span></span><span> </span><span class="main"><span>(</span></span><span>Cterms.list_set_rev</span><span> </span><span class="entity"><span>avs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tm</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>th1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>initial_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_neg</span></span><span> </span><span class="entity"><span>P'</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>evs</span></span><span class="main"><span>,</span></span><span class="entity"><span>bod</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>strip_exists</span></span><span class="main"><span>(</span></span><span class="entity"><span>concl</span></span><span> </span><span class="entity"><span>th1</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_forall</span></span><span> </span><span class="entity"><span>bod</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>CTERM</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"ring: non-universal formula"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>tm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>th1a</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>weak_dnf_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>bod</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>boda</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="entity"><span>th1a</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>th2a</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>refute_disj</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>refute</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>boda</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>th2b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>HOLogic.mk_obj_eq</span></span><span> </span><span class="entity"><span>th1a</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th2a</span></span><span> </span><span>COMP</span><span> </span><span class="entity"><span>notI</span></span><span class="main"><span>)</span></span><span> </span><span>COMP</span><span> </span><span class="entity"><span>PFalse'</span></span><span class="main"><span>]</span></span><span> </span><span>MRS</span><span> </span><span class="entity"><span>trans</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>th2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.forall_intr</span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span> </span><span>COMP</span><span> </span><span class="entity"><span>allI</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>evs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th2b</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>PFalse</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>th3</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Thm.equal_elim</span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>Simplifier.rewrite</span></span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>HOL_basic_ss</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>addsimps</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>not_ex</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>th2</span></span><span> </span><span>|&gt;</span><span> </span><span>Thm.cprop_of</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>th2</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>specl</span></span><span> </span><span class="main"><span>(</span></span><span>Cterms.list_set_rev</span><span> </span><span class="entity"><span>avs</span></span><span class="main"><span>)</span></span><span>
             </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span class="entity"><span>HOLogic.mk_obj_eq</span></span><span> </span><span class="entity"><span>th1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>th3</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>PFalse'</span></span><span class="main"><span>]</span></span><span> </span><span>MRS</span><span> </span><span class="entity"><span>trans</span></span><span class="main"><span>]</span></span><span> </span><span>MRS</span><span> </span><span class="entity"><span>PFalse</span></span><span class="main"><span>]</span></span><span> </span><span>MRS</span><span> </span><span class="entity"><span>notnotD</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ideal</span></span><span> </span><span class="entity"><span>tms</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="entity"><span>ord</span></span><span> </span><span class="main"><span>=</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rawvars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span class="entity"><span>grobvars</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tm</span></span><span>::</span><span class="entity"><span>tms</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>sort</span><span> </span><span class="entity"><span>ord</span></span><span> </span><span class="main"><span>(</span></span><span>distinct</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span>aconv</span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rawvars</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pols</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>grobify_term</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tms</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pol</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>grobify_term</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>tm</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cert</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>grobner_ideal</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>pols</span></span><span> </span><span class="entity"><span>pol</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>map_range</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>these</span><span> </span><span class="main"><span>(</span></span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cert</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>holify_polynomial</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span>
   </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>pols</span></span><span class="main"><span>)</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>poly_eq_conv</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.dest_binop</span><span> </span><span class="entity"><span>t</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Conv.fconv_rule</span><span> </span><span class="main"><span>(</span></span><span>Conv.arg_conv</span><span> </span><span class="main"><span>(</span></span><span>Conv.arg1_conv</span><span> </span><span class="entity"><span>ring_normalize_conv</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
     </span><span class="main"><span>(</span></span><span>Thm.instantiate'</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span>SOME</span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>idl_sub</span></span><span class="main"><span>)</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>poly_eq_simproc</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>proc</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>poly_eq_conv</span></span><span> </span><span class="entity"><span>ct</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Thm.is_reflexive</span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>NONE</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>Simplifier.cert_simproc</span><span> </span><span class="main"><span>(</span></span><span>Thm.theory_of_thm</span><span> </span><span class="entity"><span>idl_sub</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"poly_eq_simproc"</span></span><span>
     </span><span class="main"><span>{</span></span><span>lhss</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span>Thm.term_of</span><span> </span><span class="main"><span>(</span></span><span>Thm.lhs_of</span><span> </span><span class="entity"><span>idl_sub</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
      </span><span>proc</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>proc</span></span><span class="main"><span>}</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>poly_eq_ss</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>simpset_of</span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>HOL_basic_ss</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span><span class="hidden">\&lt;^</span><span class="control">context</span><span class="hidden">&gt;</span></span></span></span></span><span>
    </span><span>addsimps</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../HOL.html#HOL.simp_thms|fact"><span>simp_thms</span></a><span class="antiquote"><span>}</span></span></span></span><span>
    </span><span>addsimprocs</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>poly_eq_simproc</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

 </span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_defined</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
   </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mons</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>striplist</span></span><span class="main"><span>(</span></span><span class="entity"><span>dest_binary</span></span><span> </span><span class="entity"><span>ring_add_tm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconvc</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>mons</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
    </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span>aconvc</span><span> </span><span class="entity"><span>m</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>not</span><span class="main"><span>(</span></span><span>Cterms.defined</span><span> </span><span class="main"><span>(</span></span><span>Cterms.build</span><span> </span><span class="main"><span>(</span></span><span>Drule.add_frees_cterm</span><span> </span><span class="entity"><span>m</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>mons</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>isolate_variable</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
   </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>poly_eq_conv</span></span><span> </span><span class="entity"><span>tm</span></span><span>
   </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>th'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sym_conv</span></span><span> </span><span>then_conv</span><span> </span><span class="entity"><span>poly_eq_conv</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tm</span></span><span>
   </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span class="entity"><span>th1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>find_first</span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>is_defined</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.dest_arg1</span><span> </span><span class="main"><span>(</span></span><span>Thm.rhs_of</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span class="entity"><span>th'</span></span><span class="main"><span>)</span></span><span>
   </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="main"><span>(</span></span><span>find_first</span><span>
          </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>is_defined</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.dest_arg1</span><span> </span><span class="main"><span>(</span></span><span>Thm.rhs_of</span><span> </span><span class="entity"><span>th'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>,</span></span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>th2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.transitive</span><span> </span><span class="entity"><span>th1</span></span><span>
        </span><span class="main"><span>(</span></span><span>Thm.instantiate'</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>  </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span>o</span><span> </span><span>Thm.dest_arg1</span><span> </span><span>o</span><span> </span><span>Thm.rhs_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>th1</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>]</span></span><span>
          </span><span class="entity"><span>idl_add0</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Conv.fconv_rule</span><span class="main"><span>(</span></span><span>funpow</span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span>Conv.arg_conv</span><span> </span><span class="entity"><span>ring_normalize_conv</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>th2</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
 </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unwind_polys_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span class="entity"><span>bod</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>strip_exists</span></span><span> </span><span class="entity"><span>tm</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cjs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>striplist</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest_binary</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">cterm</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.conj|const"><span>HOL.conj</span></a><span>›</span></span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bod</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>th1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="main"><span>(</span></span><span>get_first</span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>isolate_variable</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cjs</span></span><span class="main"><span>)</span></span><span>
             </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Option.Option</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>CTERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"unwind_polys_conv"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>tm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.lhs_of</span><span> </span><span class="entity"><span>th1</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bod'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>list_mk_binop</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">cterm</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.conj|const"><span>HOL.conj</span></a><span>›</span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eq</span></span><span>::</span><span class="main"><span>(</span></span><span>remove</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconvc</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="entity"><span>cjs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>th2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>conj_ac_rule</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_eq</span></span><span> </span><span class="entity"><span>bod</span></span><span> </span><span class="entity"><span>bod'</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>th3</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>Thm.transitive</span><span> </span><span class="entity"><span>th2</span></span><span>
      </span><span class="main"><span>(</span></span><span>Drule.binop_cong_rule</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">cterm</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.conj|const"><span>HOL.conj</span></a><span>›</span></span></span></span><span> </span><span class="entity"><span>th1</span></span><span>
        </span><span class="main"><span>(</span></span><span>Thm.reflexive</span><span> </span><span class="main"><span>(</span></span><span>Thm.dest_arg</span><span> </span><span class="main"><span>(</span></span><span>Thm.rhs_of</span><span> </span><span class="entity"><span>th2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.dest_arg1</span><span class="main"><span>(</span></span><span>Thm.dest_arg1</span><span class="main"><span>(</span></span><span>Thm.rhs_of</span><span> </span><span class="entity"><span>th3</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>th4</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Conv.fconv_rule</span><span> </span><span class="main"><span>(</span></span><span>Conv.arg_conv</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>simp_ex_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_exists</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="entity"><span>th3</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>th5</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ex_eq_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_eq</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_ex</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>remove</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconvc</span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.lhs_of</span><span> </span><span class="entity"><span>th4</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Thm.transitive</span><span> </span><span class="entity"><span>th5</span></span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_exists</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>remove</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconvc</span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>th4</span></span><span class="main"><span>)</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
 </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>scrub_var</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
   </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>striplist</span></span><span> </span><span class="entity"><span>ring_dest_mul</span></span><span> </span><span class="entity"><span>m</span></span><span>
   </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ps'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>remove</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconvc</span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="entity"><span>ps</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>ps'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>one_tm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>fold1</span></span><span> </span><span class="entity"><span>ring_mk_mul</span></span><span> </span><span class="entity"><span>ps'</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
 </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>find_multipliers</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="entity"><span>mons</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
   </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mons1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>free_in</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="entity"><span>m</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>mons</span></span><span>
   </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mons2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>scrub_var</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>mons1</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>mons2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>zero_tm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>fold1</span></span><span> </span><span class="entity"><span>ring_mk_add</span></span><span> </span><span class="entity"><span>mons2</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

 </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>isolate_monomials</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vmons</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cmons</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>List.partition</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>frees</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Cterms.build</span><span> </span><span class="main"><span>(</span></span><span>Drule.add_frees_cterm</span><span> </span><span class="entity"><span>m</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span>Cterms.defined</span><span> </span><span class="entity"><span>frees</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>striplist</span></span><span> </span><span class="entity"><span>ring_dest_add</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cofactors</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>find_multipliers</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="entity"><span>vmons</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vars</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cnc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>cmons</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>zero_tm</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Thm.apply</span><span> </span><span class="entity"><span>ring_neg_tm</span></span><span>
                    </span><span class="main"><span>(</span></span><span class="entity"><span>list_mk_binop</span></span><span> </span><span class="entity"><span>ring_add_tm</span></span><span> </span><span class="entity"><span>cmons</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cofactors</span></span><span class="main"><span>,</span></span><span class="entity"><span>cnc</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>isolate_variables</span></span><span> </span><span class="entity"><span>evs</span></span><span> </span><span class="entity"><span>ps</span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="main"><span>=</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>free_in</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="entity"><span>eq</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>evs</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>qs</span></span><span class="main"><span>,</span></span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>isolate_monomials</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>eq</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ideal</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>qs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>ps</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span>Thm.term_ord</span><span>
 </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eq</span></span><span class="main"><span>,</span></span><span> </span><span>take</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>qs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rs</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
 </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>subst_in_poly</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.rhs_of</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ring_normalize_conv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vsubst</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
 </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>solve_idealism</span></span><span> </span><span class="entity"><span>evs</span></span><span> </span><span class="entity"><span>ps</span></span><span> </span><span class="entity"><span>eqs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>evs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
   </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eq</span></span><span class="main"><span>,</span></span><span class="entity"><span>cfs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>get_first</span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>isolate_variables</span></span><span> </span><span class="entity"><span>evs</span></span><span> </span><span class="entity"><span>ps</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eqs</span></span><span> </span><span>|&gt;</span><span> </span><span>the</span><span>
   </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>evs'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>subtract</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconvc</span><span> </span><span class="entity"><span>evs</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>snd</span><span> </span><span class="entity"><span>cfs</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eqs'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>subst_in_poly</span></span><span> </span><span class="entity"><span>cfs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>remove</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconvc</span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="entity"><span>eqs</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>cfs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>solve_idealism</span></span><span> </span><span class="entity"><span>evs'</span></span><span> </span><span class="entity"><span>ps</span></span><span> </span><span class="entity"><span>eqs'</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>{</span></span><span>ring_conv</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ring</span></span><span class="main"><span>,</span></span><span> </span><span>simple_ideal</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ideal</span></span><span class="main"><span>,</span></span><span> </span><span>multi_ideal</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>solve_idealism</span></span><span class="main"><span>,</span></span><span>
    </span><span>poly_eq_ss</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>poly_eq_ss</span></span><span class="main"><span>,</span></span><span> </span><span>unwind_conv</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unwind_polys_conv</span></span><span class="main"><span>}</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>find_term</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>domain_type</span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.boolT</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>find_args</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span>Thm.dest_arg</span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.Not|const"><span>Not</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>find_term</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.dest_arg</span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.All|const"><span>All</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>find_body</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.dest_arg</span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.Ex|const"><span>Ex</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>find_body</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.dest_arg</span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.conj|const"><span>HOL.conj</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>find_args</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.disj|const"><span>HOL.disj</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>find_args</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.implies|const"><span>HOL.implies</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>find_args</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><span>Pure.imp</span><span>›</span></span></span><span> </span><span>$</span><span class="main"><span>_</span></span><span>$</span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>find_args</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"(==)"</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>$</span><span class="main"><span>_</span></span><span>$</span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>find_args</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>  </span><span class="comment1"><span>(* FIXME proper const name *)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span></span><span>$</span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>find_term</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.dest_arg</span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"find_term"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>find_args</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.dest_binop</span><span> </span><span class="entity"><span>tm</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>find_term</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>find_term</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>find_body</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>b'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.dest_abs_cterm</span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>find_term</span></span><span> </span><span class="entity"><span>b'</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_ring_ideal_convs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>form</span></span><span> </span><span class="main"><span>=</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">try</span><span class="hidden">&gt;</span></span></span><span class="entity"><span>‹</span><span class="entity"><span>find_term</span></span><span> </span><span class="entity"><span>form</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>›</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
  </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
</span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Semiring_Normalizer.match</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>res</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>theory</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>{</span></span><span>is_const</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>dest_const</span></span><span class="main"><span>,</span></span><span>
          </span><span class="entity"><span>mk_const</span></span><span class="main"><span>,</span></span><span> </span><span>conv</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ring_eq_conv</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
     </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ring_and_ideal_conv</span></span><span> </span><span class="entity"><span>theory</span></span><span>
          </span><span class="entity"><span>dest_const</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_const</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.ctyp_of_cterm</span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ring_eq_conv</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>Semiring_Normalizer.semiring_normalize_wrapper</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>res</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>presimplify</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>add_thms</span></span><span> </span><span class="entity"><span>del_thms</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>asm_full_simp_tac</span></span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>HOL_basic_ss</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span>addsimps</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Named_Theorems.get</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">named_theorems</span><span class="hidden">&gt;</span></span></span><span>‹algebra›</span></span><span class="main"><span>)</span></span><span>
    </span><span>delsimps</span><span> </span><span class="entity"><span>del_thms</span></span><span> </span><span>addsimps</span><span> </span><span class="entity"><span>add_thms</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ring_tac</span></span><span> </span><span class="entity"><span>add_ths</span></span><span> </span><span class="entity"><span>del_ths</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Object_Logic.full_atomize_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span>THEN'</span><span> </span><span class="entity"><span>presimplify</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>add_ths</span></span><span> </span><span class="entity"><span>del_ths</span></span><span>
  </span><span>THEN'</span><span> </span><span>CSUBGOAL</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>form</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Object_Logic.dest_judgment</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>p</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>get_ring_ideal_convs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>form</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
           </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Thm.reflexive</span><span> </span><span class="entity"><span>form</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>#</span></span><span>ring_conv</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>form</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>i</span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>no_tac</span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>CTERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>no_tac</span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>THM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>no_tac</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
 </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lhs</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
  </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>$</span><span class="main"><span>_</span></span><span>$</span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Thm.dest_arg1</span><span> </span><span class="entity"><span>t</span></span><span>
 </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>CTERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"ideal_tac - lhs"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
 </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>exitac</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=</span></span><span> </span><span>no_tac</span><span>
   </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>exitac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span>Thm.instantiate'</span><span> </span><span class="main"><span>[</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Thm.ctyp_of_cterm</span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span>NONE</span><span class="main"><span>,</span></span><span>SOME</span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>exI</span></span><span class="main"><span>]</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>

 </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>claset</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>claset_of</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span><span class="hidden">\&lt;^</span><span class="control">context</span><span class="hidden">&gt;</span></span></span></span></span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ideal_tac</span></span><span> </span><span class="entity"><span>add_ths</span></span><span> </span><span class="entity"><span>del_ths</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>presimplify</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>add_ths</span></span><span> </span><span class="entity"><span>del_ths</span></span><span>
 </span><span>THEN'</span><span>
 </span><span>CSUBGOAL</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>get_ring_ideal_convs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
   </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>no_tac</span><span>
 </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
   </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>poly_exists_tac</span></span><span> </span><span class="main"><span>{</span></span><span>asms</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>asms</span></span><span class="main"><span>,</span></span><span> </span><span>concl</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>,</span></span><span> </span><span>prems</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span>
            </span><span>params</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>context</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span>schematics</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
     </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>evs</span></span><span class="main"><span>,</span></span><span class="entity"><span>bod</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>strip_exists</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.dest_arg</span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>)</span></span><span>
     </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lhs</span></span><span> </span><span>o</span><span> </span><span>Thm.dest_arg</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>asms</span></span><span>
     </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cfs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>swap</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>multi_ideal</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>evs</span></span><span> </span><span class="entity"><span>ps</span></span><span class="main"><span>)</span></span><span>
                   </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Thm.dest_arg1</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>conjuncts</span></span><span> </span><span class="entity"><span>bod</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
     </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ws</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>exitac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>o</span><span> </span><span>AList.lookup</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconvc</span><span> </span><span class="entity"><span>cfs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>evs</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>EVERY</span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="entity"><span>ws</span></span><span class="main"><span>)</span></span><span> </span><span>THEN</span><span> </span><span class="entity"><span>Method.insert_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
        </span><span>THEN</span><span> </span><span class="entity"><span>ring_tac</span></span><span> </span><span class="entity"><span>add_ths</span></span><span> </span><span class="entity"><span>del_ths</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
     </span><span class="entity"><span>clarify_tac</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>put_claset</span></span><span> </span><span class="entity"><span>claset</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span>
     </span><span>THEN</span><span> </span><span>Object_Logic.full_atomize_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span>
     </span><span>THEN</span><span> </span><span class="entity"><span>asm_full_simp_tac</span></span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>poly_eq_ss</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span>
     </span><span>THEN</span><span> </span><span class="entity"><span>clarify_tac</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>put_claset</span></span><span> </span><span class="entity"><span>claset</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span>
     </span><span>THEN</span><span> </span><span class="main"><span>(</span></span><span>REPEAT</span><span> </span><span class="main"><span>(</span></span><span>CONVERSION</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>unwind_conv</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
     </span><span>THEN</span><span> </span><span class="entity"><span>SUBPROOF</span></span><span> </span><span class="entity"><span>poly_exists_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
 </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>no_tac</span><span>
     </span><span class="main"><span>|</span></span><span> </span><span>CTERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>no_tac</span><span>
     </span><span class="main"><span>|</span></span><span> </span><span>THM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>no_tac</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>algebra_tac</span></span><span> </span><span class="entity"><span>add_ths</span></span><span> </span><span class="entity"><span>del_ths</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span>
 </span><span class="entity"><span>ring_tac</span></span><span> </span><span class="entity"><span>add_ths</span></span><span> </span><span class="entity"><span>del_ths</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>ORELSE</span><span> </span><span class="entity"><span>ideal_tac</span></span><span> </span><span class="entity"><span>add_ths</span></span><span> </span><span class="entity"><span>del_ths</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
</span></pre>
</body>

</html>