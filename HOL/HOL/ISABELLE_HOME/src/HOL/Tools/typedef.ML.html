<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Tools/typedef.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Tools/typedef.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      HOL/Tools/typedef.ML
    Author:     Markus Wenzel and Stefan Berghofer, TU Muenchen

Gordon/HOL-style type definitions: create a new syntactic type
represented by a non-empty set.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>TYPEDEF</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>info</span></span><span> </span><span class="main"><span>=</span></span><span>
   </span><span class="main"><span>{</span></span><span>rep_type</span><span class="main"><span>:</span></span><span> </span><span>typ</span><span class="main"><span>,</span></span><span> </span><span>abs_type</span><span class="main"><span>:</span></span><span> </span><span>typ</span><span class="main"><span>,</span></span><span> </span><span>Rep_name</span><span class="main"><span>:</span></span><span> </span><span>string</span><span class="main"><span>,</span></span><span> </span><span>Abs_name</span><span class="main"><span>:</span></span><span> </span><span>string</span><span class="main"><span>,</span></span><span> </span><span>axiom_name</span><span class="main"><span>:</span></span><span> </span><span>string</span><span class="main"><span>}</span></span><span> *
   </span><span class="main"><span>{</span></span><span>inhabited</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span> </span><span>type_definition</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span> </span><span>Rep</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span> </span><span>Rep_inverse</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span> </span><span>Abs_inverse</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span>
    </span><span>Rep_inject</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span> </span><span>Abs_inject</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span> </span><span>Rep_cases</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span> </span><span>Abs_cases</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span>
    </span><span>Rep_induct</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span> </span><span>Abs_induct</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>}</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> transform_info</span><span class="main"><span>:</span></span><span> </span><span>morphism</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>info</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>info</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> get_info</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>info</span></span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> get_info_global</span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>info</span></span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> interpretation</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>bindings</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>Rep_name</span><span class="main"><span>:</span></span><span> </span><span>binding</span><span class="main"><span>,</span></span><span> </span><span>Abs_name</span><span class="main"><span>:</span></span><span> </span><span>binding</span><span class="main"><span>,</span></span><span> </span><span>type_definition_name</span><span class="main"><span>:</span></span><span> </span><span>binding</span><span class="main"><span>}</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> default_bindings</span><span class="main"><span>:</span></span><span> </span><span>binding</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>bindings</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> make_bindings</span><span class="main"><span>:</span></span><span> </span><span>binding</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>bindings</span></span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>bindings</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> make_morphisms</span><span class="main"><span>:</span></span><span> </span><span>binding</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>binding</span><span> * </span><span>binding</span><span class="main"><span>)</span></span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>bindings</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> overloaded</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span>Config.T</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_typedef</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>{</span></span><span>overloaded</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>}</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>binding</span><span> * </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>sort</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span>mixfix</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>bindings</span></span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span class="entity"><span>info</span></span><span class="main"><span>)</span></span><span> * </span><span>local_theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_typedef_global</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>{</span></span><span>overloaded</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>}</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>binding</span><span> * </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>sort</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span>mixfix</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>bindings</span></span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span class="entity"><span>info</span></span><span class="main"><span>)</span></span><span> * </span><span>theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> typedef</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>{</span></span><span>overloaded</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>}</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>binding</span><span> * </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>sort</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span>mixfix</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>bindings</span></span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.state</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> typedef_cmd</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>{</span></span><span>overloaded</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>}</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>binding</span><span> * </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>string</span><span> </span><span>option</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span>mixfix</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>bindings</span></span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.state</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Typedef</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>TYPEDEF</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="comment1"><span>(** type definitions **)</span></span><span>

</span><span class="comment1"><span>(* theory data *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>info</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="comment1"><span>(*global part*)</span></span><span>
  </span><span class="main"><span>{</span></span><span>rep_type</span><span class="main"><span>:</span></span><span> </span><span>typ</span><span class="main"><span>,</span></span><span> </span><span>abs_type</span><span class="main"><span>:</span></span><span> </span><span>typ</span><span class="main"><span>,</span></span><span> </span><span>Rep_name</span><span class="main"><span>:</span></span><span> </span><span>string</span><span class="main"><span>,</span></span><span> </span><span>Abs_name</span><span class="main"><span>:</span></span><span> </span><span>string</span><span class="main"><span>,</span></span><span> </span><span>axiom_name</span><span class="main"><span>:</span></span><span> </span><span>string</span><span class="main"><span>}</span></span><span> *
  </span><span class="comment1"><span>(*local part*)</span></span><span>
  </span><span class="main"><span>{</span></span><span>inhabited</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span> </span><span>type_definition</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span> </span><span>Rep</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span> </span><span>Rep_inverse</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span> </span><span>Abs_inverse</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span>
    </span><span>Rep_inject</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span> </span><span>Abs_inject</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span> </span><span>Rep_cases</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span> </span><span>Abs_cases</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span>
    </span><span>Rep_induct</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span> </span><span>Abs_induct</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>transform_info</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>info</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>info</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Morphism.thm</span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>global_info</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>inhabited</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>type_definition</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Rep</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Rep_inverse</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Abs_inverse</span></span><span class="main"><span>,</span></span><span>
      </span><span class="entity"><span>Rep_inject</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Abs_inject</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Rep_cases</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Abs_cases</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Rep_induct</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Abs_induct</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>info</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>global_info</span></span><span class="main"><span>,</span></span><span>
     </span><span class="main"><span>{</span></span><span>inhabited</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>inhabited</span></span><span class="main"><span>,</span></span><span> </span><span>type_definition</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>type_definition</span></span><span class="main"><span>,</span></span><span>
      </span><span>Rep</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>Rep</span></span><span class="main"><span>,</span></span><span> </span><span>Rep_inverse</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>Rep_inverse</span></span><span class="main"><span>,</span></span><span> </span><span>Abs_inverse</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>Abs_inverse</span></span><span class="main"><span>,</span></span><span>
      </span><span>Rep_inject</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>Rep_inject</span></span><span class="main"><span>,</span></span><span> </span><span>Abs_inject</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>Abs_inject</span></span><span class="main"><span>,</span></span><span>
      </span><span>Rep_cases</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>Rep_cases</span></span><span class="main"><span>,</span></span><span> </span><span>Abs_cases</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>Abs_cases</span></span><span class="main"><span>,</span></span><span>
      </span><span>Rep_induct</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>Rep_induct</span></span><span class="main"><span>,</span></span><span> </span><span>Abs_induct</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>Abs_induct</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Generic_Data</span><span>
</span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>info</span></span><span> </span><span>list</span><span> </span><span>Symtab.table</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.empty</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>merge</span></span><span> </span><span class="entity"><span>data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.merge_list</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>data</span></span><span class="main"><span>;</span></span><span>
</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_info_generic</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Symtab.lookup_list</span><span> </span><span class="main"><span>(</span></span><span>Data.get</span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span>#&gt;</span><span>
  </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>transform_info</span></span><span> </span><span class="main"><span>(</span></span><span>Morphism.transfer_morphism''</span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get_info</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_info_generic</span></span><span> </span><span>o</span><span> </span><span>Context.Proof</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get_info_global</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_info_generic</span></span><span> </span><span>o</span><span> </span><span>Context.Theory</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>put_info</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>info</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Data.map</span><span> </span><span class="main"><span>(</span></span><span>Symtab.cons_list</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>transform_info</span></span><span> </span><span>Morphism.trim_context_morphism</span><span> </span><span class="entity"><span>info</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* global interpretation *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Typedef_Plugin</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Plugin</span></span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>string</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>typedef_plugin</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Plugin_Name.declare_setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>typedef</span><span>›</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>interpretation</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Typedef_Plugin.interpretation</span></span><span> </span><span class="entity"><span>typedef_plugin</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="entity"><span>lthy</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Local_Theory.map_background_naming</span><span>
          </span><span class="main"><span>(</span></span><span>Name_Space.root_path</span><span> </span><span>#&gt;</span><span> </span><span>Name_Space.add_path</span><span> </span><span class="main"><span>(</span></span><span>Long_Name.qualifier</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>name</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Local_Theory.restore_background_naming</span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* primitive typedef axiomatization -- for fresh typedecl *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>typedef_overloaded</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.setup_config_bool</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Typedef.typedef_overloaded|attribute"><span>typedef_overloaded</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_inhabited</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.dest_setT</span></span><span> </span><span class="main"><span>(</span></span><span>Term.fastype_of</span><span> </span><span class="entity"><span>A</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.exists_const</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"x"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>HOLogic.mk_mem</span></span><span> </span><span class="main"><span>(</span></span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>A</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_typedef</span></span><span> </span><span class="entity"><span>newT</span></span><span> </span><span class="entity"><span>oldT</span></span><span> </span><span class="entity"><span>RepC</span></span><span> </span><span class="entity"><span>AbsC</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>typedefC</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../Typedef.html#Typedef.type_definition|const"><span>type_definition</span></a><span>›</span></span><span class="main"><span>,</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>newT</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>oldT</span></span><span class="main"><span>)</span></span><span> </span><span>--&gt;</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>oldT</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>newT</span></span><span class="main"><span>)</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>HOLogic.mk_setT</span></span><span> </span><span class="entity"><span>oldT</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>HOLogic.boolT</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Logic.mk_implies</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_inhabited</span></span><span> </span><span class="entity"><span>A</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>typedefC</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>RepC</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>AbsC</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>A</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>primitive_typedef</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>overloaded</span></span><span class="main"><span>}</span></span><span> </span><span class="entity"><span>type_definition_name</span></span><span> </span><span class="entity"><span>newT</span></span><span> </span><span class="entity"><span>oldT</span></span><span> </span><span class="entity"><span>Rep_name</span></span><span> </span><span class="entity"><span>Abs_name</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="comment1"><span>(* errors *)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>show_names</span></span><span> </span><span class="entity"><span>pairs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>commas_quote</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>pairs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lhs_tfrees</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.add_tfreesT</span><span> </span><span class="entity"><span>newT</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rhs_tfrees</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.add_tfreesT</span><span> </span><span class="entity"><span>oldT</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>remove</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lhs_tfrees</span></span><span> </span><span class="entity"><span>rhs_tfrees</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>extras</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Extra type variables in representing set: "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>show_names</span></span><span> </span><span class="entity"><span>extras</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Term.add_frees</span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Illegal variables in representing set: "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>show_names</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


    </span><span class="comment1"><span>(* axiomatization *)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>RepC</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>AbsC</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>consts_lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Local_Theory.background_theory_result</span><span>
        </span><span class="main"><span>(</span></span><span>Sign.declare_const</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>Rep_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>newT</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>oldT</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>NoSyn</span><span class="main"><span>)</span></span><span> </span><span>##&gt;&gt;</span><span>
          </span><span>Sign.declare_const</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>Abs_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>oldT</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>newT</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>NoSyn</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>const_dep</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Theory.const_dep</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>consts_lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>defs_context</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.defs_context</span><span> </span><span class="entity"><span>consts_lthy</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>A_consts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_aterms</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>Const</span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>insert</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>const_dep</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>A_types</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span>fold_types</span><span> </span><span>o</span><span> </span><span>fold_subtypes</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>Type</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>insert</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Theory.type_dep</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>typedef_deps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>A_consts</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>A_types</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>newT_dep</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Theory.type_dep</span><span> </span><span class="main"><span>(</span></span><span>dest_Type</span><span> </span><span class="entity"><span>newT</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>axiom_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>axiom</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>axiom_lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>consts_lthy</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Local_Theory.background_theory_result</span><span>
        </span><span class="main"><span>(</span></span><span>Thm.add_axiom</span><span> </span><span class="entity"><span>consts_lthy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>type_definition_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_typedef</span></span><span> </span><span class="entity"><span>newT</span></span><span> </span><span class="entity"><span>oldT</span></span><span> </span><span class="entity"><span>RepC</span></span><span> </span><span class="entity"><span>AbsC</span></span><span> </span><span class="entity"><span>A</span></span><span class="main"><span>)</span></span><span> </span><span>##&gt;</span><span>
          </span><span>Theory.add_deps</span><span> </span><span class="entity"><span>defs_context</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="entity"><span>newT_dep</span></span><span> </span><span class="entity"><span>typedef_deps</span></span><span> </span><span>##&gt;</span><span>
          </span><span>Theory.add_deps</span><span> </span><span class="entity"><span>defs_context</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>const_dep</span></span><span> </span><span class="main"><span>(</span></span><span>dest_Const</span><span> </span><span class="entity"><span>RepC</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>newT_dep</span></span><span class="main"><span>]</span></span><span> </span><span>##&gt;</span><span>
          </span><span>Theory.add_deps</span><span> </span><span class="entity"><span>defs_context</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>const_dep</span></span><span> </span><span class="main"><span>(</span></span><span>dest_Const</span><span> </span><span class="entity"><span>AbsC</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>newT_dep</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>axiom_defs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Theory.defs_of</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>axiom_lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>newT_deps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>maps</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span class="main"><span>(</span></span><span>Defs.get_deps</span><span> </span><span class="entity"><span>axiom_defs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>newT_dep</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>newT_deps</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>overloaded</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>typedef_overloaded</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span>error</span><span> </span><span class="main"><span>(</span></span><span>Pretty.string_of</span><span> </span><span class="main"><span>(</span></span><span>Pretty.chunks</span><span>
          </span><span class="main"><span>[</span></span><span>Pretty.paragraph</span><span>
            </span><span class="main"><span>(</span></span><span>Pretty.text</span><span> </span><span class="inner_quoted"><span>"Type definition with open dependencies, use"</span></span><span> </span><span>@</span><span>
             </span><span class="main"><span>[</span></span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"\""</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.keyword1</span><span> </span><span class="inner_quoted"><span>"typedef"</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>
              </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"("</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.keyword2</span><span> </span><span class="inner_quoted"><span>"overloaded"</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>")\""</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>]</span></span><span> </span><span>@</span><span>
             </span><span>Pretty.text</span><span> </span><span class="inner_quoted"><span>"or enable configuration option \"typedef_overloaded\" in the context."</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span>Pretty.block</span><span> </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"  Type:"</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>2</span></span><span class="main"><span>,</span></span><span> </span><span>Syntax.pretty_typ</span><span> </span><span class="entity"><span>axiom_lthy</span></span><span> </span><span class="entity"><span>newT</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
           </span><span>Pretty.block</span><span> </span><span class="main"><span>(</span></span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"  Deps:"</span></span><span> </span><span>::</span><span> </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span>::</span><span>
             </span><span>Pretty.commas</span><span>
              </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Defs.pretty_entry</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.defs_context</span><span> </span><span class="entity"><span>axiom_lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>newT_deps</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>RepC</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>AbsC</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>axiom_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>axiom</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>axiom_lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* derived bindings *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>bindings</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>Rep_name</span><span class="main"><span>:</span></span><span> </span><span>binding</span><span class="main"><span>,</span></span><span> </span><span>Abs_name</span><span class="main"><span>:</span></span><span> </span><span>binding</span><span class="main"><span>,</span></span><span> </span><span>type_definition_name</span><span class="main"><span>:</span></span><span> </span><span>binding</span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prefix_binding</span></span><span> </span><span class="entity"><span>prfx</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Binding.reset_pos</span><span> </span><span class="main"><span>(</span></span><span>Binding.qualify_name</span><span> </span><span>false</span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prfx</span></span><span> </span><span>^</span><span> </span><span>Binding.name_of</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>qualify_binding</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Binding.qualify</span><span> </span><span>false</span><span> </span><span class="main"><span>(</span></span><span>Binding.name_of</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>default_bindings</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span>
 </span><span class="main"><span>{</span></span><span>Rep_name</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prefix_binding</span></span><span> </span><span class="inner_quoted"><span>"Rep_"</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span>
  </span><span>Abs_name</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prefix_binding</span></span><span> </span><span class="inner_quoted"><span>"Abs_"</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span>
  </span><span>type_definition_name</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prefix_binding</span></span><span> </span><span class="inner_quoted"><span>"type_definition_"</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_bindings</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>default_bindings</span></span><span> </span><span class="entity"><span>name</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>make_bindings</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>bindings</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>bindings</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_morphisms</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>default_bindings</span></span><span> </span><span class="entity"><span>name</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>make_morphisms</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Rep_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Abs_name</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
     </span><span class="main"><span>{</span></span><span>Rep_name</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>qualify_binding</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>Rep_name</span></span><span class="main"><span>,</span></span><span>
      </span><span>Abs_name</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>qualify_binding</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>Abs_name</span></span><span class="main"><span>,</span></span><span>
      </span><span>type_definition_name</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>type_definition_name</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>default_bindings</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* prepare_typedef *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prepare_typedef</span></span><span> </span><span class="entity"><span>prep_term</span></span><span> </span><span class="entity"><span>overloaded</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>raw_args</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mx</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_set</span></span><span> </span><span class="entity"><span>opt_bindings</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="comment1"><span>(* rhs *)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tmp_ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>Variable.declare_typ</span><span> </span><span>o</span><span> </span><span>TFree</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_args</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>set</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prep_term</span></span><span> </span><span class="entity"><span>tmp_ctxt</span></span><span> </span><span class="entity"><span>raw_set</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tmp_ctxt'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tmp_ctxt</span></span><span> </span><span>|&gt;</span><span> </span><span>Variable.declare_term</span><span> </span><span class="entity"><span>set</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>setT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.fastype_of</span><span> </span><span class="entity"><span>set</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>oldT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.dest_setT</span></span><span> </span><span class="entity"><span>setT</span></span><span> </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>TYPE</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Not a set type: "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="main"><span>(</span></span><span>Syntax.string_of_typ</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>setT</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bname</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Binding.name_of</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_inhabited</span></span><span> </span><span class="entity"><span>set</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal_pat</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_inhabited</span></span><span> </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="main"><span>(</span></span><span>the_default</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bname</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Lexicon.read_variable</span><span> </span><span class="entity"><span>bname</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>setT</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


    </span><span class="comment1"><span>(* lhs *)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.check_tfree</span><span> </span><span class="entity"><span>tmp_ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_args</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>newT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typedecl_lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>Typedecl.typedecl</span></span><span> </span><span class="main"><span>{</span></span><span>final</span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>}</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mx</span></span><span class="main"><span>)</span></span><span>
      </span><span>||&gt;</span><span> </span><span>Variable.declare_term</span><span> </span><span class="entity"><span>set</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>full_name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>newT</span></span><span class="main"><span>;</span></span><span>


    </span><span class="comment1"><span>(* axiomatization *)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>Rep_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Abs_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>type_definition_name</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>make_bindings</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>opt_bindings</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>RepC</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>AbsC</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>axiom_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typedef</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typedef_lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>typedecl_lthy</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>primitive_typedef</span></span><span> </span><span class="entity"><span>overloaded</span></span><span> </span><span class="entity"><span>type_definition_name</span></span><span> </span><span class="entity"><span>newT</span></span><span> </span><span class="entity"><span>oldT</span></span><span> </span><span class="entity"><span>Rep_name</span></span><span> </span><span class="entity"><span>Abs_name</span></span><span> </span><span class="entity"><span>set</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>alias_lthy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>typedef_lthy</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Local_Theory.const_alias</span><span> </span><span class="entity"><span>Rep_name</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>(</span></span><span>Term.dest_Const</span><span> </span><span class="entity"><span>RepC</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Local_Theory.const_alias</span><span> </span><span class="entity"><span>Abs_name</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>(</span></span><span>Term.dest_Const</span><span> </span><span class="entity"><span>AbsC</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


    </span><span class="comment1"><span>(* result *)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>note</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>atts</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Local_Theory.note</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>atts</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>th</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span>#&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>th'</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>th'</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>typedef_result</span></span><span> </span><span class="entity"><span>inhabited</span></span><span> </span><span class="entity"><span>lthy1</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>type_definition</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lthy1</span></span><span>
          </span><span>|&gt;</span><span> </span><span>Local_Theory.note</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>type_definition_name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>inhabited</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>typedef</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Goal.norm_result</span><span> </span><span class="entity"><span>lthy2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>type_definition</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>Rep</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Rep_inverse</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Abs_inverse</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Rep_inject</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Abs_inject</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Rep_cases</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
            </span><span class="entity"><span>Abs_cases</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Rep_induct</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Abs_induct</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy3</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lthy2</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>note</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>Rep_name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>make</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../Typedef.html#Typedef.type_definition.Rep|fact"><span>type_definition.Rep</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>
          </span><span>||&gt;&gt;</span><span> </span><span class="entity"><span>note</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.suffix_name</span><span> </span><span class="inner_quoted"><span>"_inverse"</span></span><span> </span><span class="entity"><span>Rep_name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
              </span><span class="entity"><span>make</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../Typedef.html#Typedef.type_definition.Rep_inverse|fact"><span>type_definition.Rep_inverse</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>
          </span><span>||&gt;&gt;</span><span> </span><span class="entity"><span>note</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.suffix_name</span><span> </span><span class="inner_quoted"><span>"_inverse"</span></span><span> </span><span class="entity"><span>Abs_name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
              </span><span class="entity"><span>make</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../Typedef.html#Typedef.type_definition.Abs_inverse|fact"><span>type_definition.Abs_inverse</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>
          </span><span>||&gt;&gt;</span><span> </span><span class="entity"><span>note</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.suffix_name</span><span> </span><span class="inner_quoted"><span>"_inject"</span></span><span> </span><span class="entity"><span>Rep_name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
              </span><span class="entity"><span>make</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../Typedef.html#Typedef.type_definition.Rep_inject|fact"><span>type_definition.Rep_inject</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>
          </span><span>||&gt;&gt;</span><span> </span><span class="entity"><span>note</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.suffix_name</span><span> </span><span class="inner_quoted"><span>"_inject"</span></span><span> </span><span class="entity"><span>Abs_name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
              </span><span class="entity"><span>make</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../Typedef.html#Typedef.type_definition.Abs_inject|fact"><span>type_definition.Abs_inject</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>
          </span><span>||&gt;&gt;</span><span> </span><span class="entity"><span>note</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.suffix_name</span><span> </span><span class="inner_quoted"><span>"_cases"</span></span><span> </span><span class="entity"><span>Rep_name</span></span><span class="main"><span>,</span></span><span>
                </span><span class="main"><span>[</span></span><span class="entity"><span>Attrib.case_names</span></span><span> </span><span class="main"><span>[</span></span><span>Binding.name_of</span><span> </span><span class="entity"><span>Rep_name</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
                 </span><span class="entity"><span>Attrib.internal</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Induct.cases_pred</span></span><span> </span><span class="entity"><span>full_name</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
              </span><span class="entity"><span>make</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../Typedef.html#Typedef.type_definition.Rep_cases|fact"><span>type_definition.Rep_cases</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>
          </span><span>||&gt;&gt;</span><span> </span><span class="entity"><span>note</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.suffix_name</span><span> </span><span class="inner_quoted"><span>"_cases"</span></span><span> </span><span class="entity"><span>Abs_name</span></span><span class="main"><span>,</span></span><span>
                </span><span class="main"><span>[</span></span><span class="entity"><span>Attrib.case_names</span></span><span> </span><span class="main"><span>[</span></span><span>Binding.name_of</span><span> </span><span class="entity"><span>Abs_name</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
                 </span><span class="entity"><span>Attrib.internal</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Induct.cases_type</span></span><span> </span><span class="entity"><span>full_name</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
              </span><span class="entity"><span>make</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../Typedef.html#Typedef.type_definition.Abs_cases|fact"><span>type_definition.Abs_cases</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>
          </span><span>||&gt;&gt;</span><span> </span><span class="entity"><span>note</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.suffix_name</span><span> </span><span class="inner_quoted"><span>"_induct"</span></span><span> </span><span class="entity"><span>Rep_name</span></span><span class="main"><span>,</span></span><span>
                </span><span class="main"><span>[</span></span><span class="entity"><span>Attrib.case_names</span></span><span> </span><span class="main"><span>[</span></span><span>Binding.name_of</span><span> </span><span class="entity"><span>Rep_name</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
                 </span><span class="entity"><span>Attrib.internal</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Induct.induct_pred</span></span><span> </span><span class="entity"><span>full_name</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
              </span><span class="entity"><span>make</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../Typedef.html#Typedef.type_definition.Rep_induct|fact"><span>type_definition.Rep_induct</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>
          </span><span>||&gt;&gt;</span><span> </span><span class="entity"><span>note</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.suffix_name</span><span> </span><span class="inner_quoted"><span>"_induct"</span></span><span> </span><span class="entity"><span>Abs_name</span></span><span class="main"><span>,</span></span><span>
                </span><span class="main"><span>[</span></span><span class="entity"><span>Attrib.case_names</span></span><span> </span><span class="main"><span>[</span></span><span>Binding.name_of</span><span> </span><span class="entity"><span>Abs_name</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
                 </span><span class="entity"><span>Attrib.internal</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Induct.induct_type</span></span><span> </span><span class="entity"><span>full_name</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
              </span><span class="entity"><span>make</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../Typedef.html#Typedef.type_definition.Abs_induct|fact"><span>type_definition.Abs_induct</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>info</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span>rep_type</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>oldT</span></span><span class="main"><span>,</span></span><span> </span><span>abs_type</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>newT</span></span><span class="main"><span>,</span></span><span> </span><span>Rep_name</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>(</span></span><span>Term.dest_Const</span><span> </span><span class="entity"><span>RepC</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
            </span><span>Abs_name</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>(</span></span><span>Term.dest_Const</span><span> </span><span class="entity"><span>AbsC</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>axiom_name</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>axiom_name</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span>
           </span><span class="main"><span>{</span></span><span>inhabited</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>inhabited</span></span><span class="main"><span>,</span></span><span> </span><span>type_definition</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>type_definition</span></span><span class="main"><span>,</span></span><span>
            </span><span>Rep</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Rep</span></span><span class="main"><span>,</span></span><span> </span><span>Rep_inverse</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Rep_inverse</span></span><span class="main"><span>,</span></span><span> </span><span>Abs_inverse</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Abs_inverse</span></span><span class="main"><span>,</span></span><span>
            </span><span>Rep_inject</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Rep_inject</span></span><span class="main"><span>,</span></span><span> </span><span>Abs_inject</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Abs_inject</span></span><span class="main"><span>,</span></span><span> </span><span>Rep_cases</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Rep_cases</span></span><span class="main"><span>,</span></span><span>
          </span><span>Abs_cases</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Abs_cases</span></span><span class="main"><span>,</span></span><span> </span><span>Rep_induct</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Rep_induct</span></span><span class="main"><span>,</span></span><span> </span><span>Abs_induct</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Abs_induct</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>lthy3</span></span><span>
        </span><span>|&gt;</span><span> </span><span>Local_Theory.declaration</span><span> </span><span class="main"><span>{</span></span><span>syntax</span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span> </span><span>pervasive</span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span class="main"><span>}</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>put_info</span></span><span> </span><span class="entity"><span>full_name</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>transform_info</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>info</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="entity"><span>Typedef_Plugin.data</span></span><span> </span><span class="entity"><span>Plugin_Name.default_filter</span></span><span> </span><span class="entity"><span>full_name</span></span><span>
        </span><span>|&gt;</span><span> </span><span>pair</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>full_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>info</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>goal</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>goal_pat</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typedef_result</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>alias_lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>ERROR</span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span>cat_error</span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"The error(s) above occurred in typedef "</span></span><span> </span><span>^</span><span> </span><span>Binding.print</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* add_typedef: tactic interface *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_typedef</span></span><span> </span><span class="entity"><span>overloaded</span></span><span> </span><span class="entity"><span>typ</span></span><span> </span><span class="entity"><span>set</span></span><span> </span><span class="entity"><span>opt_bindings</span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>goal</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typedef_result</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>prepare_typedef</span></span><span> </span><span>Syntax.check_term</span><span> </span><span class="entity"><span>overloaded</span></span><span> </span><span class="entity"><span>typ</span></span><span> </span><span class="entity"><span>set</span></span><span> </span><span class="entity"><span>opt_bindings</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inhabited</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Goal.prove</span><span> </span><span class="entity"><span>lthy'</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tac</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>context</span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>Goal.norm_result</span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>typedef_result</span></span><span> </span><span class="entity"><span>inhabited</span></span><span> </span><span class="entity"><span>lthy'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_typedef_global</span></span><span> </span><span class="entity"><span>overloaded</span></span><span> </span><span class="entity"><span>typ</span></span><span> </span><span class="entity"><span>set</span></span><span> </span><span class="entity"><span>opt_bindings</span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Named_Target.theory_map_result</span></span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span>o</span><span> </span><span class="entity"><span>transform_info</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>add_typedef</span></span><span> </span><span class="entity"><span>overloaded</span></span><span> </span><span class="entity"><span>typ</span></span><span> </span><span class="entity"><span>set</span></span><span> </span><span class="entity"><span>opt_bindings</span></span><span> </span><span class="entity"><span>tac</span></span><span class="main"><span>)</span></span><span>


</span><span class="comment1"><span>(* typedef: proof interface *)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gen_typedef</span></span><span> </span><span class="entity"><span>prep_term</span></span><span> </span><span class="entity"><span>prep_constraint</span></span><span> </span><span class="entity"><span>overloaded</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>raw_args</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mx</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>set</span></span><span> </span><span class="entity"><span>opt_bindings</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prep_constraint</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_args</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>goal</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>goal_pat</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typedef_result</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>prepare_typedef</span></span><span> </span><span class="entity"><span>prep_term</span></span><span> </span><span class="entity"><span>overloaded</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mx</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>set</span></span><span> </span><span class="entity"><span>opt_bindings</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>after_qed</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span class="entity"><span>th</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>snd</span><span> </span><span>o</span><span> </span><span class="entity"><span>typedef_result</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>Proof.theorem</span></span><span> </span><span>NONE</span><span> </span><span class="entity"><span>after_qed</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>goal</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>goal_pat</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>lthy'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>typedef</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>gen_typedef</span></span><span> </span><span>Syntax.check_term</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>I</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>typedef_cmd</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>gen_typedef</span></span><span> </span><span>Syntax.read_term</span><span> </span><span class="entity"><span>Typedecl.read_constraint</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>



</span><span class="comment1"><span>(** outer syntax **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Outer_Syntax.local_theory_to_proof</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword1"><span>typedef</span></span><span>›</span></span></span><span>
    </span><span class="inner_quoted"><span>"HOL type definition (requires non-emptiness proof)"</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>Parse_Spec.overloaded</span></span><span> </span><span>--</span><span> </span><span>Parse.type_args_constrained</span><span> </span><span>--</span><span> </span><span>Parse.binding</span><span> </span><span>--</span><span> </span><span>Parse.opt_mixfix</span><span> </span><span>--</span><span>
      </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>=</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Parse.term</span><span class="main"><span>)</span></span><span> </span><span>--</span><span>
      </span><span>Scan.option</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>morphisms</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Parse.!!!</span><span> </span><span class="main"><span>(</span></span><span>Parse.binding</span><span> </span><span>--</span><span> </span><span>Parse.binding</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>overloaded</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mx</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>A</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>opt_morphs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>typedef_cmd</span></span><span> </span><span class="main"><span>{</span></span><span>overloaded</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>overloaded</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mx</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>A</span></span><span>
          </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>make_morphisms</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>opt_morphs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>overloaded</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>typedef_overloaded</span></span><span class="main"><span>;</span></span><span>



</span><span class="comment1"><span>(** theory export **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span>Theory.setup</span><span> </span><span>o</span><span> </span><span class="entity"><span>Thy_Info.add_presentation</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>Export_Theory.export_enabled</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parent_spaces</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>Sign.type_space</span><span> </span><span class="main"><span>(</span></span><span>Theory.parents_of</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>typedefs</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>Name_Space.dest_table</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>types</span><span> </span><span class="main"><span>(</span></span><span>Type.rep_tsig</span><span> </span><span class="main"><span>(</span></span><span>Sign.tsig_of</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>space</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Name_Space.declared</span><span> </span><span class="entity"><span>space</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>parent_spaces</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                </span><span class="entity"><span>get_info_global</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>name</span></span><span>
                </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>rep_type</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>abs_type</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Rep_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Abs_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>axiom_name</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rep_type</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>abs_type</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Rep_name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Abs_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>axiom_name</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>encode</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>XML.Encode</span><span> </span><span>Term_XML.Encode</span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>list</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span>string</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span>typ</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span>typ</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span>string</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span>string</span><span> </span><span>string</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>typedefs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Export_Theory.export_body</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="inner_quoted"><span>"typedefs"</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>encode</span></span><span> </span><span class="entity"><span>typedefs</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
</span></pre>
</body>

</html>