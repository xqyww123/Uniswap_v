<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Tools/Function/partial_function.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Tools/Function/partial_function.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      HOL/Tools/Function/partial_function.ML
    Author:     Alexander Krauss, TU Muenchen

Partial function definitions based on least fixed points in ccpos.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>PARTIAL_FUNCTION</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> init</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>declaration</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mono_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_partial_function</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>binding</span><span> * </span><span>typ</span><span> </span><span>option</span><span> * </span><span>mixfix</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="entity"><span>Attrib.binding</span></span><span> * </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span> * </span><span>local_theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_partial_function_cmd</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>binding</span><span> * </span><span>string</span><span> </span><span>option</span><span> * </span><span>mixfix</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="entity"><span>Attrib.binding</span></span><span> * </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span> * </span><span>local_theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> transform_result</span><span class="main"><span>:</span></span><span> </span><span>morphism</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> * </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> * </span><span>thm</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Partial_Function</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>PARTIAL_FUNCTION</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Function_Lib</span><span>


</span><span class="comment1"><span>(*** Context Data ***)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>setup_data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Setup_Data</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
 </span><span class="main"><span>{</span></span><span>fixp</span><span class="main"><span>:</span></span><span> term</span><span class="main"><span>,</span></span><span>
  mono</span><span class="main"><span>:</span></span><span> term</span><span class="main"><span>,</span></span><span>
  fixp_eq</span><span class="main"><span>:</span></span><span> thm</span><span class="main"><span>,</span></span><span>
  fixp_induct</span><span class="main"><span>:</span></span><span> thm</span><span class="main"><span>,</span></span><span>
  fixp_induct_user</span><span class="main"><span>:</span></span><span> thm option</span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>transform_setup_data</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Setup_Data</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>fixp</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mono</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fixp_eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fixp_induct</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fixp_induct_user</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Morphism.term</span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Morphism.thm</span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>Setup_Data</span></span><span>
     </span><span class="main"><span>{</span></span><span>fixp</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="entity"><span>fixp</span></span><span class="main"><span>,</span></span><span> </span><span>mono</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="entity"><span>mono</span></span><span class="main"><span>,</span></span><span> </span><span>fixp_eq</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>fixp_eq</span></span><span class="main"><span>,</span></span><span>
      </span><span>fixp_induct</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>fixp_induct</span></span><span class="main"><span>,</span></span><span> </span><span>fixp_induct_user</span><span> </span><span class="main"><span>=</span></span><span> </span><span>Option.map</span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>fixp_induct_user</span></span><span class="main"><span>}</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Modes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Generic_Data</span><span>
</span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>setup_data</span></span><span> </span><span>Symtab.table</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.empty</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>merge</span></span><span> </span><span class="entity"><span>data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.merge</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>data</span></span><span class="main"><span>;</span></span><span>
</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>init</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="entity"><span>fixp</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="entity"><span>fixp_eq</span></span><span> </span><span class="entity"><span>fixp_induct</span></span><span> </span><span class="entity"><span>fixp_induct_user</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>data'</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>Setup_Data</span></span><span>
       </span><span class="main"><span>{</span></span><span>fixp</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fixp</span></span><span class="main"><span>,</span></span><span> </span><span>mono</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mono</span></span><span class="main"><span>,</span></span><span> </span><span>fixp_eq</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fixp_eq</span></span><span class="main"><span>,</span></span><span>
        </span><span>fixp_induct</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fixp_induct</span></span><span class="main"><span>,</span></span><span> </span><span>fixp_induct_user</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fixp_induct_user</span></span><span class="main"><span>}</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>transform_setup_data</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>phi</span></span><span> </span><span>$&gt;</span><span> </span><span>Morphism.trim_context_morphism</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Modes.map</span><span> </span><span class="main"><span>(</span></span><span>Symtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>data'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>known_modes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.keys</span><span> </span><span>o</span><span> </span><span>Modes.get</span><span> </span><span>o</span><span> </span><span>Context.Proof</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lookup_mode</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Symtab.lookup</span><span> </span><span class="main"><span>(</span></span><span>Modes.get</span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span>#&gt;</span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>transform_setup_data</span></span><span> </span><span class="main"><span>(</span></span><span>Morphism.transfer_morphism'</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(*** Automated monotonicity proofs ***)</span></span><span>

</span><span class="comment1"><span>(*rewrite conclusion with k-th assumtion*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rewrite_with_asm_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Subgoal.FOCUS</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span>Local_Defs.unfold0_tac</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>[</span></span><span>nth</span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_case</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>strip_comb</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>case_comb</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Ctr_Sugar.ctr_sugar_of_case</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>case_comb</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
         </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
       </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>case_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
             </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lhs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.prop_of</span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>case_thms</span></span><span class="main"><span>)</span></span><span>
               </span><span>|&gt;</span><span> </span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>HOLogic.dest_eq</span></span><span> </span><span>|&gt;</span><span> </span><span>fst</span><span class="main"><span>;</span></span><span>
             </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>arity</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span class="main"><span>(</span></span><span>strip_comb</span><span> </span><span class="entity"><span>lhs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
             </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>conv</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>funpow</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>args</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>arity</span></span><span class="main"><span>)</span></span><span> </span><span>Conv.fun_conv</span><span>
               </span><span class="main"><span>(</span></span><span>Conv.rewrs_conv</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>mk_meta_eq</span></span><span> </span><span class="entity"><span>case_thms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
             </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arity</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>conv</span></span><span class="main"><span>)</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*split on case expressions*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>split_cases_tac</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Subgoal.FOCUS_PARAMS</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
  </span><span>SUBGOAL</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>dest_case</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>body</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
         </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>no_tac</span><span>
       </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arg</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>conv</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Conv</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Term.is_open</span><span> </span><span class="entity"><span>arg</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>no_tac</span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>DETERM</span><span> </span><span>o</span><span> </span><span class="entity"><span>Induct.cases_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>false</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span>SOME</span><span> </span><span class="entity"><span>arg</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                </span><span>THEN_ALL_NEW</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rewrite_with_asm_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span>
                </span><span>THEN_ALL_NEW</span><span> </span><span>eresolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><span>thin_rl</span><span class="antiquote"><span>}</span></span></span></span><span>
                </span><span>THEN_ALL_NEW</span><span> </span><span class="main"><span>(</span></span><span>CONVERSION</span><span>
                  </span><span class="main"><span>(</span></span><span>params_conv</span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                    </span><span>arg_conv</span><span> </span><span class="main"><span>(</span></span><span>arg_conv</span><span> </span><span class="main"><span>(</span></span><span>abs_conv</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="entity"><span>conv</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>no_tac</span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*monotonicity proof: apply rules + split case expressions*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mono_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>K</span><span> </span><span class="main"><span>(</span></span><span>Local_Defs.unfold0_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.curry_def|fact"><span>curry_def</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span>THEN'</span><span> </span><span class="main"><span>(</span></span><span>TRY</span><span> </span><span>o</span><span> </span><span>REPEAT_ALL_NEW</span><span>
   </span><span class="main"><span>(</span></span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Named_Theorems.get</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">named_theorems</span><span class="hidden">&gt;</span></span></span><span>‹partial_function_mono›</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
     </span><span>ORELSE'</span><span> </span><span class="entity"><span>split_cases_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(*** Auxiliary functions ***)</span></span><span>

</span><span class="comment1"><span>(*Returns t $ u, but instantiates the type of t to make the
application type correct*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>apply_inst</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>domain_type</span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Sign.typ_match</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>)</span></span><span> </span><span>Vartab.empty</span><span>
      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Type.TYPE_MATCH</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TYPE</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"apply_inst"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>map_types</span><span> </span><span class="main"><span>(</span></span><span>Envir.norm_type</span><span> </span><span class="entity"><span>subst</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>head_conv</span></span><span> </span><span class="entity"><span>cv</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>can</span><span> </span><span>Thm.dest_comb</span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Conv.fun_conv</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>head_conv</span></span><span> </span><span class="entity"><span>cv</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>cv</span></span><span> </span><span class="entity"><span>ct</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(*** currying transformation ***)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>curry_const</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>A</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>B</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>C</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.curry|const"><span>Product_Type.curry</span></a><span>›</span></span><span class="main"><span>,</span></span><span>
    </span><span class="main"><span>[</span></span><span class="entity"><span>HOLogic.mk_prodT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>A</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>B</span></span><span class="main"><span>)</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>C</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>A</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>B</span></span><span class="main"><span>]</span></span><span> </span><span>---&gt;</span><span> </span><span class="entity"><span>C</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_curry</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"fun"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>S</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>U</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="entity"><span>curry_const</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>S</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>U</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>f</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TYPE</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"mk_curry"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>f</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* iterated versions. Nonstandard left-nested tuples arise naturally
from "split o split o split"*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>curry_n</span></span><span> </span><span class="entity"><span>arity</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>funpow</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arity</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>mk_curry</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>uncurry_n</span></span><span> </span><span class="entity"><span>arity</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>funpow</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arity</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>HOLogic.mk_case_prod</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>curry_uncurry_ss</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>simpset_of</span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>HOL_basic_ss</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span><span class="hidden">\&lt;^</span><span class="control">context</span><span class="hidden">&gt;</span></span></span></span></span><span>
    </span><span>addsimps</span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.curry_case_prod|fact"><span>Product_Type.curry_case_prod</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.case_prod_curry|fact"><span>Product_Type.case_prod_curry</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>split_conv_ss</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>simpset_of</span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>HOL_basic_ss</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span><span class="hidden">\&lt;^</span><span class="control">context</span><span class="hidden">&gt;</span></span></span></span></span><span>
    </span><span>addsimps</span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.split_conv|fact"><span>Product_Type.split_conv</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>curry_K_ss</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>simpset_of</span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>HOL_basic_ss</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span><span class="hidden">\&lt;^</span><span class="control">context</span><span class="hidden">&gt;</span></span></span></span></span><span>
    </span><span>addsimps</span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.curry_K|fact"><span>Product_Type.curry_K</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* instantiate generic fixpoint induction and eliminate the canonical assumptions;
  curry induction predicate *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>specialize_fixp_induct</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>fT</span></span><span> </span><span class="entity"><span>fT_uc</span></span><span> </span><span class="entity"><span>curry</span></span><span> </span><span class="entity"><span>uncurry</span></span><span> </span><span class="entity"><span>mono_thm</span></span><span> </span><span class="entity"><span>f_def</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>P</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.variant_fixes</span><span> </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"P"</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>P_inst</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"f"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fT_uc</span></span><span class="main"><span>,</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>P</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fT</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>HOLogic.boolT</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>curry</span></span><span> </span><span>$</span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="comment1"><span>(* FIXME ctxt vs. ctxt' (!?) *)</span></span><span>
    </span><span class="entity"><span>rule</span></span><span>
    </span><span>|&gt;</span><span> </span><span>infer_instantiate'</span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>map</span><span> </span><span>o</span><span> </span><span>Option.map</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span>SOME</span><span> </span><span class="entity"><span>uncurry</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>curry</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>P_inst</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Tactic.rule_by_tactic</span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>Simplifier.simp_tac</span></span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>curry_uncurry_ss</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>3</span></span><span> </span><span class="comment1"><span>(* discharge U (C f) = f *)</span></span><span>
       </span><span>THEN</span><span> </span><span class="entity"><span>Simplifier.simp_tac</span></span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>curry_K_ss</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>4</span></span><span> </span><span class="comment1"><span>(* simplify bot case *)</span></span><span>
       </span><span>THEN</span><span> </span><span class="entity"><span>Simplifier.full_simp_tac</span></span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>curry_uncurry_ss</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>5</span></span><span class="main"><span>)</span></span><span> </span><span class="comment1"><span>(* simplify induction step *)</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>mono_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f_def</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Conv.fconv_rule</span><span> </span><span class="main"><span>(</span></span><span>Conv.concl_conv</span><span> </span><span class="inner_numeral"><span>~1</span></span><span>    </span><span class="comment1"><span>(* simplify conclusion *)</span></span><span>
         </span><span class="main"><span>(</span></span><span>Raw_Simplifier.rewrite</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>false</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>mk_meta_eq</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.curry_case_prod|fact"><span>Product_Type.curry_case_prod</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Variable.export</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_curried_induct</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>inst_rule</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cert</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="comment1"><span>(* FIXME ctxt vs. ctxt' (!?) *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>P</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.variant_fixes</span><span> </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"P"</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>split_paired_all_conv</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Conv.every_conv</span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>args</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Conv.rewr_conv</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.split_paired_all|fact"><span>split_paired_all</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>split_params_conv</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Conv.params_conv</span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Conv.implies_conv</span><span> </span><span class="entity"><span>split_paired_all_conv</span></span><span> </span><span>Conv.all_conv</span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>P_var</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x_var</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
       </span><span>Thm.prop_of</span><span> </span><span class="entity"><span>inst_rule</span></span><span> </span><span>|&gt;</span><span> </span><span>Logic.strip_imp_concl</span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span>
      </span><span>|&gt;</span><span> </span><span>strip_comb</span><span> </span><span>|&gt;</span><span> </span><span>apsnd</span><span> </span><span>hd</span><span>
      </span><span>|&gt;</span><span> </span><span>apply2</span><span> </span><span>dest_Var</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>P_rangeT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>range_type</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span class="entity"><span>P_var</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>PT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>o</span><span> </span><span>dest_Free</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span>---&gt;</span><span> </span><span class="entity"><span>P_rangeT</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>x_inst</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cert</span></span><span> </span><span class="main"><span>(</span></span><span>foldl1</span><span> </span><span class="entity"><span>HOLogic.mk_prod</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>P_inst</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cert</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>uncurry_n</span></span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>P</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>PT</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inst_rule'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>inst_rule</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Tactic.rule_by_tactic</span><span> </span><span class="entity"><span>ctxt</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>Simplifier.simp_tac</span></span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>curry_uncurry_ss</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>4</span></span><span>
         </span><span>THEN</span><span> </span><span class="entity"><span>Simplifier.simp_tac</span></span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>curry_uncurry_ss</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>3</span></span><span>
         </span><span>THEN</span><span> </span><span>CONVERSION</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>split_params_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
           </span><span>then_conv</span><span> </span><span class="main"><span>(</span></span><span>Conv.forall_conv</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="entity"><span>split_paired_all_conv</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>3</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Thm.instantiate</span><span> </span><span class="main"><span>(</span></span><span>TVars.empty</span><span class="main"><span>,</span></span><span> </span><span>Vars.make</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>P_var</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>P_inst</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x_var</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x_inst</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>Simplifier.full_simplify</span></span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>split_conv_ss</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Variable.export</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>inst_rule'</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(*** partial_function definition ***)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>transform_result</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Morphism.term</span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span>Morphism.thm</span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gen_add_partial_function</span></span><span> </span><span class="entity"><span>prep</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="entity"><span>fixes_raw</span></span><span> </span><span class="entity"><span>eqn_raw</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>setup_data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lookup_mode</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>mode</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Option.Option</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span>cat_lines</span><span> </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"Unknown mode "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>mode</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"."</span></span><span class="main"><span>,</span></span><span>
        </span><span class="inner_quoted"><span>"Known modes are "</span></span><span> </span><span>^</span><span> </span><span>commas_quote</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>known_modes</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"."</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Setup_Data</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>fixp</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mono</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fixp_eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fixp_induct</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fixp_induct_user</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>setup_data</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>fixes</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>eq_abinding</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eqn</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prep</span></span><span> </span><span class="entity"><span>fixes_raw</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>eqn_raw</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>plain_eqn</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args_ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.focus</span><span> </span><span>NONE</span><span> </span><span class="entity"><span>eqn</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>f_binding</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fT</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mixfix</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the_single</span><span> </span><span class="entity"><span>fixes</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>f_bname</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Binding.name_of</span><span> </span><span class="entity"><span>f_binding</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>note_qualified</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Local_Theory.note</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>derived_name</span></span><span> </span><span class="entity"><span>f_binding</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>)</span></span><span> </span><span>#&gt;</span><span> </span><span>snd</span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.dest_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span class="entity"><span>plain_eqn</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>head</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>strip_comb</span><span> </span><span class="entity"><span>lhs</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>argnames</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span>dest_Free</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>F</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span>lambda</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>head</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>arity</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>aTs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bTs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>chop</span><span> </span><span class="entity"><span>arity</span></span><span> </span><span class="main"><span>(</span></span><span>binder_types</span><span> </span><span class="entity"><span>fT</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tupleT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>foldl1</span><span> </span><span class="entity"><span>HOLogic.mk_prodT</span></span><span> </span><span class="entity"><span>aTs</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fT_uc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tupleT</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>bTs</span></span><span> </span><span>---&gt;</span><span> </span><span>body_type</span><span> </span><span class="entity"><span>fT</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>f_uc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>f_bname</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fT_uc</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>x_uc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"x"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tupleT</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>uncurry</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>lambda</span><span> </span><span class="entity"><span>head</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>uncurry_n</span></span><span> </span><span class="entity"><span>arity</span></span><span> </span><span class="entity"><span>head</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>curry</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>lambda</span><span> </span><span class="entity"><span>f_uc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>curry_n</span></span><span> </span><span class="entity"><span>arity</span></span><span> </span><span class="entity"><span>f_uc</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>F_uc</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>lambda</span><span> </span><span class="entity"><span>f_uc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>uncurry_n</span></span><span> </span><span class="entity"><span>arity</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>F</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>curry_n</span></span><span> </span><span class="entity"><span>arity</span></span><span> </span><span class="entity"><span>f_uc</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mono_goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>apply_inst</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>mono</span></span><span> </span><span class="main"><span>(</span></span><span>lambda</span><span> </span><span class="entity"><span>f_uc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>F_uc</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>f_uc</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>x_uc</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Logic.all</span><span> </span><span class="entity"><span>x_uc</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mono_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Goal.prove_internal</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>mono_goal</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mono_tac</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inst_mono_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.forall_elim</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>x_uc</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>mono_thm</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>f_def_rhs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>curry_n</span></span><span> </span><span class="entity"><span>arity</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>apply_inst</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>fixp</span></span><span> </span><span class="entity"><span>F_uc</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>f_def_binding</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Thm.make_def_binding</span><span> </span><span class="main"><span>(</span></span><span>Config.get</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>Function_Lib.function_internals</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>f_binding</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f_def</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Local_Theory.define</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>f_binding</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mixfix</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>f_def_binding</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f_def_rhs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eqn</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.mk_eq</span></span><span> </span><span class="main"><span>(</span></span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        </span><span>Term.betapplys</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>F</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>unfold</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span>infer_instantiate'</span><span> </span><span class="entity"><span>lthy'</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span>o</span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>uncurry</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>F</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>curry</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fixp_eq</span></span><span>
        </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>inst_mono_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f_def</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Tactic.rule_by_tactic</span><span> </span><span class="entity"><span>lthy'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Simplifier.simp_tac</span></span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>curry_uncurry_ss</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>specialized_fixp_induct</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>specialize_fixp_induct</span></span><span> </span><span class="entity"><span>lthy'</span></span><span> </span><span class="entity"><span>fT</span></span><span> </span><span class="entity"><span>fT_uc</span></span><span> </span><span class="entity"><span>curry</span></span><span> </span><span class="entity"><span>uncurry</span></span><span> </span><span class="entity"><span>inst_mono_thm</span></span><span> </span><span class="entity"><span>f_def</span></span><span> </span><span class="entity"><span>fixp_induct</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Drule.rename_bvars'</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f_bname</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>f_bname</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>argnames</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mk_raw_induct</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>infer_instantiate'</span><span> </span><span class="entity"><span>args_ctxt</span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>map</span><span> </span><span>o</span><span> </span><span>Option.map</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>args_ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span>SOME</span><span> </span><span class="entity"><span>uncurry</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>curry</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span>#&gt;</span><span> </span><span class="entity"><span>mk_curried_induct</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="entity"><span>args_ctxt</span></span><span>
      </span><span>#&gt;</span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Variable.export</span><span> </span><span class="entity"><span>args_ctxt</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span>
      </span><span>#&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>infer_instantiate'</span><span> </span><span class="entity"><span>lthy'</span></span><span>
          </span><span class="main"><span>[</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>lthy'</span></span><span> </span><span class="entity"><span>F</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>OF</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>inst_mono_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f_def</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span>#&gt;</span><span> </span><span>Drule.rename_bvars'</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f_bname</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>argnames</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>argnames</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>raw_induct</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Option.map</span><span> </span><span class="entity"><span>mk_raw_induct</span></span><span> </span><span class="entity"><span>fixp_induct_user</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rec_rule</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Conv</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>Goal.prove</span><span> </span><span class="entity"><span>lthy'</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span>dest_Free</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>eqn</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span>CONVERSION</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>arg_conv</span><span> </span><span>o</span><span> </span><span>arg1_conv</span><span> </span><span>o</span><span> </span><span class="entity"><span>head_conv</span></span><span> </span><span>o</span><span> </span><span>rewr_conv</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_meta_eq</span></span><span> </span><span class="entity"><span>unfold</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
          </span><span>THEN</span><span> </span><span>resolve_tac</span><span> </span><span class="entity"><span>lthy'</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.refl|fact"><span>refl</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rec_rule'</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy''</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lthy'</span></span><span> </span><span>|&gt;</span><span> </span><span>Local_Theory.note</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eq_abinding</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rec_rule</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>lthy''</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>Spec_Rules.add</span></span><span> </span><span>Binding.empty</span><span> </span><span class="entity"><span>Spec_Rules.equational_recdef</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>f</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rec_rule'</span></span><span class="main"><span>]</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>note_qualified</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"simps"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rec_rule'</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>note_qualified</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"mono"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>mono_thm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>raw_induct</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span> </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>note_qualified</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"raw_induct"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>thm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>note_qualified</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"fixp_induct"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>specialized_fixp_induct</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>pair</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rec_rule'</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>add_partial_function</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>gen_add_partial_function</span></span><span> </span><span class="entity"><span>Specification.check_multi_specs</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>add_partial_function_cmd</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>gen_add_partial_function</span></span><span> </span><span class="entity"><span>Specification.read_multi_specs</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>(</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Parse.name</span><span> </span><span>--|</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>)</span></span><span>›</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Outer_Syntax.local_theory</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword1"><span>partial_function</span></span><span>›</span></span></span><span> </span><span class="inner_quoted"><span>"define partial function"</span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>mode</span></span><span> </span><span>--</span><span> </span><span class="main"><span>(</span></span><span>Parse.vars</span><span> </span><span>--</span><span> </span><span class="main"><span>(</span></span><span>Parse.where_</span><span> </span><span>|--</span><span> </span><span class="entity"><span>Parse_Spec.simple_spec</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>spec</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>add_partial_function_cmd</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>spec</span></span><span> </span><span>#&gt;</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
</span></pre>
</body>

</html>