<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Tools/Old_Datatype/old_primrec.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Tools/Old_Datatype/old_primrec.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      HOL/Tools/Old_Datatype/old_primrec.ML
    Author:     Norbert Voelker, FernUni Hagen
    Author:     Stefan Berghofer, TU Muenchen
    Author:     Florian Haftmann, TU Muenchen

Primitive recursive functions on datatypes.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>OLD_PRIMREC</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> primrec</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>binding</span><span> * </span><span>typ</span><span> </span><span>option</span><span> * </span><span>mixfix</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="entity"><span>Specification.multi_specs</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>{</span></span><span>types</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span>list</span><span class="main"><span>,</span></span><span> </span><span>result</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span>list</span><span> * </span><span>thm</span><span> </span><span>list</span><span class="main"><span>}</span></span><span> * </span><span>local_theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> primrec_cmd</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>binding</span><span> * </span><span>string</span><span> </span><span>option</span><span> * </span><span>mixfix</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="entity"><span>Specification.multi_specs_cmd</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>{</span></span><span>types</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span>list</span><span class="main"><span>,</span></span><span> </span><span>result</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span>list</span><span> * </span><span>thm</span><span> </span><span>list</span><span class="main"><span>}</span></span><span> * </span><span>local_theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> primrec_global</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>binding</span><span> * </span><span>typ</span><span> </span><span>option</span><span> * </span><span>mixfix</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="entity"><span>Specification.multi_specs</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> </span><span>list</span><span> * </span><span>thm</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> * </span><span>theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> primrec_overloaded</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span> * </span><span>bool</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span>binding</span><span> * </span><span>typ</span><span> </span><span>option</span><span> * </span><span>mixfix</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="entity"><span>Specification.multi_specs</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> </span><span>list</span><span> * </span><span>thm</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> * </span><span>theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> primrec_simple</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>binding</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span> * </span><span>mixfix</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>{</span></span><span>prefix</span><span class="main"><span>:</span></span><span> </span><span>string</span><span class="main"><span>,</span></span><span> </span><span>types</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span>list</span><span class="main"><span>,</span></span><span> </span><span>result</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span>list</span><span> * </span><span>thm</span><span> </span><span>list</span><span class="main"><span>}</span></span><span> * </span><span>local_theory</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Old_Primrec</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>OLD_PRIMREC</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>PrimrecError</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>string</span><span> * </span><span>term</span><span> </span><span>option</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>primrec_error</span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>PrimrecError</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>msg</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>primrec_error_eqn</span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="entity"><span>eqn</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>PrimrecError</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>msg</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>eqn</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* preprocessing of equations *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>process_eqn</span></span><span> </span><span class="entity"><span>is_fixed</span></span><span> </span><span class="entity"><span>spec</span></span><span> </span><span class="entity"><span>rec_fns</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>split_list</span><span> </span><span class="main"><span>(</span></span><span>strip_qnt_vars</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.all</span><span>›</span></span><span> </span><span class="entity"><span>spec</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>body</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>strip_qnt_body</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.all</span><span>›</span></span><span> </span><span class="entity"><span>spec</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vs'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_map</span><span> </span><span>Name.variant</span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="main"><span>(</span></span><span>Name.make_context</span><span> </span><span class="main"><span>(</span></span><span>fold_aterms</span><span>
      </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>insert</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>body</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eqn</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>curry</span><span> </span><span>subst_bounds</span><span> </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span>Free</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vs'</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span>|&gt;</span><span> </span><span>rev</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.dest_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span class="entity"><span>eqn</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>primrec_error</span></span><span> </span><span class="inner_quoted"><span>"not a proper equation"</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>recfun</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>strip_comb</span><span> </span><span class="entity"><span>lhs</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fname</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>recfun</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_fixed</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>v</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>primrec_error</span></span><span> </span><span class="inner_quoted"><span>"illegal head of function equation"</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>primrec_error</span></span><span> </span><span class="inner_quoted"><span>"illegal head of function equation"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ls'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rest</span></span><span class="main"><span>)</span></span><span>  </span><span class="main"><span>=</span></span><span> </span><span>chop_prefix</span><span> </span><span>is_Free</span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>middle</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rs'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>chop_suffix</span><span> </span><span>is_Free</span><span> </span><span class="entity"><span>rest</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rpos</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>ls'</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>constr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cargs'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>middle</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>primrec_error</span></span><span> </span><span class="inner_quoted"><span>"constructor missing"</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>strip_comb</span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>middle</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cname</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>dest_Const</span><span> </span><span class="entity"><span>constr</span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>primrec_error</span></span><span> </span><span class="inner_quoted"><span>"ill-formed constructor"</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tname</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>dest_Type</span><span> </span><span class="main"><span>(</span></span><span>body_type</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>TYPE</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="entity"><span>primrec_error</span></span><span> </span><span class="inner_quoted"><span>"cannot determine datatype associated with function"</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cargs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>dest_Free</span><span> </span><span class="entity"><span>ls'</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span>dest_Free</span><span> </span><span class="entity"><span>cargs'</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span>dest_Free</span><span> </span><span class="entity"><span>rs'</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>primrec_error</span></span><span> </span><span class="inner_quoted"><span>"illegal argument in pattern"</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lfrees</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ls</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>rs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>cargs</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_vars</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>check_vars</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>primrec_error</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span> </span><span>^</span><span> </span><span>commas_quote</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eqn</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>length</span><span> </span><span class="entity"><span>middle</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="entity"><span>primrec_error</span></span><span> </span><span class="inner_quoted"><span>"more than one non-variable in pattern"</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
     </span><span class="main"><span>(</span></span><span class="entity"><span>check_vars</span></span><span> </span><span class="inner_quoted"><span>"repeated variable names in pattern: "</span></span><span> </span><span class="main"><span>(</span></span><span>duplicates</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lfrees</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="entity"><span>check_vars</span></span><span> </span><span class="inner_quoted"><span>"extra variables on rhs: "</span></span><span>
        </span><span class="main"><span>(</span></span><span>Term.add_frees</span><span> </span><span class="entity"><span>rhs</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span>|&gt;</span><span> </span><span>subtract</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lfrees</span></span><span>
          </span><span>|&gt;</span><span> </span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_fixed</span></span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rec_fns</span></span><span> </span><span class="entity"><span>fname</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>fname</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tname</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rpos</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>cname</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cargs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eqn</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>rec_fns</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rpos'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eqns</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>AList.defined</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eqns</span></span><span> </span><span class="entity"><span>cname</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="entity"><span>primrec_error</span></span><span> </span><span class="inner_quoted"><span>"constructor already occurred as pattern"</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>rpos</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="entity"><span>rpos'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="entity"><span>primrec_error</span></span><span> </span><span class="inner_quoted"><span>"position of recursive argument inconsistent"</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span>AList.update</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>fname</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tname</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rpos</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cname</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cargs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eqn</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>eqns</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span class="entity"><span>rec_fns</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>PrimrecError</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>msg</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>primrec_error_eqn</span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="entity"><span>spec</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>process_fun</span></span><span> </span><span class="entity"><span>descr</span></span><span> </span><span class="entity"><span>eqns</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fname</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fnames</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fnss</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tname</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>constrs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>nth</span><span> </span><span class="entity"><span>descr</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(* substitute "fname ls x rs" by "y ls rs" for (x, (_, y)) in subs *)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>fs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="entity"><span>subs</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fs</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>fs</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="entity"><span>subs</span></span><span> </span><span class="entity"><span>t</span></span><span>
          </span><span>|-&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>pair</span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="entity"><span>subs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fs</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>strip_comb</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>is_Free</span><span> </span><span class="entity"><span>f</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>w</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>w</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eqns</span></span><span> </span><span class="main"><span>(</span></span><span>dest_Free</span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fname'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>dest_Free</span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>;</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rpos</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the</span><span> </span><span class="main"><span>(</span></span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eqns</span></span><span> </span><span class="entity"><span>fname'</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>chop</span><span> </span><span class="entity"><span>rpos</span></span><span> </span><span class="entity"><span>ts</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rs'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>rs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                    </span><span class="entity"><span>x'</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>rs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rs</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>primrec_error</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"not enough arguments in recursive application\n"</span></span><span> </span><span>^</span><span>
                      </span><span class="inner_quoted"><span>"of function "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>fname'</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" on rhs"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>strip_comb</span><span> </span><span class="entity"><span>x'</span></span><span class="main"><span>;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>subs</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                  </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
                    </span><span class="entity"><span>fs</span></span><span>
                    </span><span>|&gt;</span><span> </span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>subst</span></span><span> </span><span class="entity"><span>subs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ts</span></span><span>
                    </span><span>|-&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ts'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>pair</span><span> </span><span class="main"><span>(</span></span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                    </span><span class="entity"><span>fs</span></span><span>
                    </span><span>|&gt;</span><span> </span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>subst</span></span><span> </span><span class="entity"><span>subs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>xs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>ls</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>rs'</span></span><span class="main"><span>)</span></span><span>
                    </span><span>||&gt;</span><span> </span><span class="entity"><span>process_fun</span></span><span> </span><span class="entity"><span>descr</span></span><span> </span><span class="entity"><span>eqns</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fname'</span></span><span class="main"><span>)</span></span><span>
                    </span><span>|-&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ts'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>pair</span><span> </span><span class="main"><span>(</span></span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>y</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
              </span><span class="entity"><span>fs</span></span><span>
              </span><span>|&gt;</span><span> </span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>subst</span></span><span> </span><span class="entity"><span>subs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span>
              </span><span>|-&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>f'</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ts'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>pair</span><span> </span><span class="main"><span>(</span></span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>fs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(* translate rec equations into function arguments suitable for rec comb *)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>trans</span></span><span> </span><span class="entity"><span>eqns</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cname</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cargs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fnames'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fnss'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fns</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eqns</span></span><span> </span><span class="entity"><span>cname</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>warning</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"No equation for constructor "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>cname</span></span><span> </span><span>^</span><span>
          </span><span class="inner_quoted"><span>"\nin definition of function "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>fname</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>fnames'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fnss'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.undefined|const"><span>undefined</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span>dummyT</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>fns</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cargs'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eq</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>recs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Old_Datatype_Aux.is_rec_type</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cargs'</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>cargs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rargs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>recs</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>subs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>rpair</span><span> </span><span>dummyT</span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="main"><span>(</span></span><span>Term.rename_wrt_term</span><span> </span><span class="entity"><span>rhs</span></span><span> </span><span class="entity"><span>rargs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rhs'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fnames''</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fnss''</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>z</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Old_Datatype_Aux.body_index</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>,</span></span><span> </span><span>Free</span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>recs</span></span><span> </span><span class="entity"><span>subs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rhs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fnames'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fnss'</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>PrimrecError</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>primrec_error_eqn</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>eq</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>fnames''</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fnss''</span></span><span class="main"><span>,</span></span><span> </span><span>fold_rev</span><span> </span><span>absfree</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cargs'</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>subs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>ls</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>rs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rhs'</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>fns</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>

  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fnames</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>fname</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fnames</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="entity"><span>primrec_error</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"inconsistent functions for datatype "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>tname</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eqns</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the</span><span> </span><span class="main"><span>(</span></span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eqns</span></span><span> </span><span class="entity"><span>fname</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fnames'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fnss'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fns</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>trans</span></span><span> </span><span class="entity"><span>eqns</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>constrs</span></span><span>
              </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fname</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>fnames</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fnss</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>fnames'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fname</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>eqns</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fns</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>fnss'</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>fname'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>fname</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fname'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fnames</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fnss</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>primrec_error</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"inconsistent functions for datatype "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>tname</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* prepare functions needed for definitions *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_fns</span></span><span> </span><span class="entity"><span>fns</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span>int</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tname</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>constrs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rec_name</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>defs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fns</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dummy_fns</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cargs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.undefined|const"><span>undefined</span></a><span>›</span></span><span class="main"><span>,</span></span><span>
          </span><span>replicate</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>cargs</span></span><span> </span><span>+</span><span> </span><span>length</span><span> </span><span class="main"><span>(</span></span><span>filter</span><span> </span><span class="entity"><span>Old_Datatype_Aux.is_rec_type</span></span><span> </span><span class="entity"><span>cargs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span>dummyT</span><span> </span><span>---&gt;</span><span> </span><span class="entity"><span>HOLogic.unitT</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>constrs</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>warning</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"No function definition for datatype "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>tname</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>dummy_fns</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>defs</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fname</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fs'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fs'</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fname</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rec_name</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>defs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* make definition *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_def</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span class="entity"><span>fs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fname</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rec_name</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>var</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>varT</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>get_first</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mx</span></span><span class="main"><span>:</span></span><span> </span><span>mixfix</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Binding.name_of</span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fname</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mx</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fixes</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>def_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.def_name</span><span> </span><span class="main"><span>(</span></span><span>Long_Name.base_name</span><span> </span><span class="entity"><span>fname</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>raw_rhs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>snd</span><span> </span><span class="entity"><span>ls</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span>dummyT</span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rec_name</span></span><span class="main"><span>,</span></span><span> </span><span>dummyT</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fs</span></span><span> </span><span>@</span><span> </span><span>map</span><span> </span><span>Bound</span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span> </span><span>::</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>ls</span></span><span> </span><span>downto</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rhs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Syntax.check_terms</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Type.constraint</span><span> </span><span class="entity"><span>varT</span></span><span> </span><span class="entity"><span>raw_rhs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>var</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.concealed</span><span> </span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="entity"><span>def_name</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Attrib.binding</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* find datatypes which contain all datatypes in tnames' *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>find_dts</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>find_dts</span></span><span> </span><span class="entity"><span>dt_info</span></span><span> </span><span class="entity"><span>tnames'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tname</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>tnames</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Symtab.lookup</span><span> </span><span class="entity"><span>dt_info</span></span><span> </span><span class="entity"><span>tname</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>primrec_error</span></span><span> </span><span class="main"><span>(</span></span><span>quote</span><span> </span><span class="entity"><span>tname</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" is not a datatype"</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dt</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Old_Datatype_Aux.info</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>subset</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tnames'</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>descr</span><span> </span><span class="entity"><span>dt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>tname</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>dt</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>find_dts</span></span><span> </span><span class="entity"><span>dt_info</span></span><span> </span><span class="entity"><span>tnames'</span></span><span> </span><span class="entity"><span>tnames</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>find_dts</span></span><span> </span><span class="entity"><span>dt_info</span></span><span> </span><span class="entity"><span>tnames'</span></span><span> </span><span class="entity"><span>tnames</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* distill primitive definition(s) from primrec specification *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>distill</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span class="entity"><span>eqs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eqns</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>process_eqn</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Variable.is_fixed</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>v</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>w</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Binding.name_of</span><span> </span><span class="entity"><span>w</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fixes</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eqs</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tnames</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>distinct</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eqns</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>find_dts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Old_Datatype_Data.get_all</span></span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tnames</span></span><span> </span><span class="entity"><span>tnames</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>main_fns</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tname</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>index</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>index</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span>the</span><span> </span><span>o</span><span> </span><span>find_first</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tname</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eqns</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>dts</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>descr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rec_names</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rec_rewrites</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>dts</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>primrec_error</span></span><span>
        </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"datatypes "</span></span><span> </span><span>^</span><span> </span><span>commas_quote</span><span> </span><span class="entity"><span>tnames</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"\nare not mutually recursive"</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>snd</span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>dts</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fnames</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fnss</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>process_fun</span></span><span> </span><span class="entity"><span>descr</span></span><span> </span><span class="entity"><span>eqns</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>main_fns</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>raw_defs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_fns</span></span><span> </span><span class="entity"><span>fnss</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>descr</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>rec_names</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>defs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>make_def</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_defs</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>snd</span><span> </span><span class="entity"><span>fnames</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>names_eqns</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>eqns</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>eq_set</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>names</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>names_eqns</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>primrec_error</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"functions "</span></span><span> </span><span>^</span><span> </span><span>commas_quote</span><span> </span><span class="entity"><span>names_eqns</span></span><span> </span><span>^</span><span>
        </span><span class="inner_quoted"><span>"\nare not mutually recursive"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rec_rewrites'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>mk_meta_eq</span></span><span> </span><span class="entity"><span>rec_rewrites</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>space_implode</span><span> </span><span class="inner_quoted"><span>"_"</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Long_Name.base_name</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_defs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prove</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>defs</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>frees</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>Variable.add_free_names</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eqs</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rewrites</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rec_rewrites'</span></span><span> </span><span>@</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>defs</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Goal.prove</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>frees</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>eq</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span>EVERY</span><span> </span><span class="main"><span>[</span></span><span>rewrite_goals_tac</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>rewrites</span></span><span class="main"><span>,</span></span><span> </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>refl</span></span><span class="main"><span>]</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eqs</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>prefix</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tnames</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>defs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prove</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>PrimrecError</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>msg</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>some_eqn</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Primrec definition error:\n"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>msg</span></span><span> </span><span>^</span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>some_eqn</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>SOME</span><span> </span><span class="entity"><span>eqn</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"\nin\n"</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="main"><span>(</span></span><span>Syntax.string_of_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>eqn</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* primrec definition *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>primrec_simple</span></span><span> </span><span class="entity"><span>int</span></span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>prefix</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tnames</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>defs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prove</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>distill</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>lthy</span></span><span>
    </span><span>|&gt;</span><span> </span><span>fold_map</span><span> </span><span>Local_Theory.define</span><span> </span><span class="entity"><span>defs</span></span><span>
    </span><span>|&gt;</span><span> </span><span>tap</span><span> </span><span class="main"><span>(</span></span><span>uncurry</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>BNF_FP_Rec_Sugar_Util.print_def_consts</span></span><span> </span><span class="entity"><span>int</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span>|-&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>defs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span>`</span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>{</span></span><span>prefix</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prefix</span></span><span class="main"><span>,</span></span><span> </span><span>types</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tnames</span></span><span class="main"><span>,</span></span><span> </span><span>result</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>defs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prove</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>defs</span></span><span class="main"><span>)</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gen_primrec</span></span><span> </span><span class="entity"><span>prep_spec</span></span><span> </span><span class="entity"><span>int</span></span><span> </span><span class="entity"><span>raw_fixes</span></span><span> </span><span class="entity"><span>raw_spec</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fixes</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>spec</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fst</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prep_spec</span></span><span> </span><span class="entity"><span>raw_fixes</span></span><span> </span><span class="entity"><span>raw_spec</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>spec_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Binding.conglomerate</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fixes</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>attr_bindings</span></span><span> </span><span class="entity"><span>prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>attrs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="main"><span>(</span></span><span>Binding.qualify</span><span> </span><span>false</span><span> </span><span class="entity"><span>prefix</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>attrs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>spec</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>simp_attr_binding</span></span><span> </span><span class="entity"><span>prefix</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span>Binding.qualify</span><span> </span><span>true</span><span> </span><span class="entity"><span>prefix</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="inner_quoted"><span>"simps"</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><span class="operator"><span>simp</span></span><span class="main"><span>,</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.nitpick_simp|attribute"><span class="operator"><span>nitpick_simp</span></span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>lthy</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>primrec_simple</span></span><span> </span><span class="entity"><span>int</span></span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>snd</span><span> </span><span class="entity"><span>spec</span></span><span class="main"><span>)</span></span><span>
    </span><span>|-&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>prefix</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>types</span></span><span class="main"><span>,</span></span><span> </span><span>result</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>simps</span></span><span class="main"><span>)</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="entity"><span>Spec_Rules.add</span></span><span> </span><span class="entity"><span>spec_name</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Spec_Rules.equational_primrec</span></span><span> </span><span class="entity"><span>types</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="entity"><span>simps</span></span><span>
      </span><span>#&gt;</span><span> </span><span>fold_map</span><span> </span><span>Local_Theory.note</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>attr_bindings</span></span><span> </span><span class="entity"><span>prefix</span></span><span> </span><span>~~</span><span> </span><span>map</span><span> </span><span>single</span><span> </span><span class="entity"><span>simps</span></span><span class="main"><span>)</span></span><span>
      </span><span>#-&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>simps'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Local_Theory.note</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>simp_attr_binding</span></span><span> </span><span class="entity"><span>prefix</span></span><span class="main"><span>,</span></span><span> </span><span>maps</span><span> </span><span>snd</span><span> </span><span class="entity"><span>simps'</span></span><span class="main"><span>)</span></span><span>
        </span><span>#-&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>simps''</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> 
          </span><span class="entity"><span>Code.declare_default_eqns</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>rpair</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>simps''</span></span><span class="main"><span>)</span></span><span>
          </span><span>#&gt;</span><span> </span><span>pair</span><span> </span><span class="main"><span>{</span></span><span>types</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>types</span></span><span class="main"><span>,</span></span><span> </span><span>result</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>simps''</span></span><span class="main"><span>)</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>primrec</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>gen_primrec</span></span><span> </span><span class="entity"><span>Specification.check_multi_specs</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>primrec_cmd</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>gen_primrec</span></span><span> </span><span class="entity"><span>Specification.read_multi_specs</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>primrec_global</span></span><span> </span><span class="entity"><span>int</span></span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span class="entity"><span>specs</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Named_Target.theory_init</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span>result</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>simps</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>primrec</span></span><span> </span><span class="entity"><span>int</span></span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span class="entity"><span>specs</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>simps'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.export</span><span> </span><span class="entity"><span>lthy'</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>simps</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>simps'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Local_Theory.exit_global</span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>primrec_overloaded</span></span><span> </span><span class="entity"><span>int</span></span><span> </span><span class="entity"><span>ops</span></span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span class="entity"><span>specs</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Overloading.overloading</span></span><span> </span><span class="entity"><span>ops</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span>result</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>simps</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>primrec</span></span><span> </span><span class="entity"><span>int</span></span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span class="entity"><span>specs</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>simps'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.export</span><span> </span><span class="entity"><span>lthy'</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>simps</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>simps'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Local_Theory.exit_global</span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
</span></pre>
</body>

</html>