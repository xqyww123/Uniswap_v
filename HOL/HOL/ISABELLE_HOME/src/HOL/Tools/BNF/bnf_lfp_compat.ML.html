<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Tools/BNF/bnf_lfp_compat.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Tools/BNF/bnf_lfp_compat.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      HOL/Tools/BNF/bnf_lfp_compat.ML
    Author:     Jasmin Blanchette, TU Muenchen
    Copyright   2013, 2014

Compatibility layer with the old datatype package. Partly based on

    Title:      HOL/Tools/Old_Datatype/old_datatype_data.ML
    Author:     Stefan Berghofer, TU Muenchen
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>BNF_LFP_COMPAT</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>preference</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Keep_Nesting</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Include_GFPs</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Kill_Type_Args</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> get_all</span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>preference</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Old_Datatype_Aux.info</span></span><span> </span><span>Symtab.table</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> get_info</span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>preference</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Old_Datatype_Aux.info</span></span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> the_info</span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>preference</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Old_Datatype_Aux.info</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> the_spec</span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>sort</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> the_descr</span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>preference</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="entity"><span>Old_Datatype_Aux.descr</span></span><span> * </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>sort</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span>string</span><span> </span><span>list</span><span> * </span><span>string</span><span>
    * </span><span class="main"><span>(</span></span><span>string</span><span> </span><span>list</span><span> * </span><span>string</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> * </span><span class="main"><span>(</span></span><span>typ</span><span> </span><span>list</span><span> * </span><span>typ</span><span> </span><span>list</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> get_constrs</span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> interpretation</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>preference</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>Old_Datatype_Aux.config</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> datatype_compat</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> datatype_compat_global</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> datatype_compat_cmd</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_datatype</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>preference</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Old_Datatype_Aux.spec</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span> * </span><span>theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> primrec</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>binding</span><span> * </span><span>typ</span><span> </span><span>option</span><span> * </span><span>mixfix</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Specification.multi_specs</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> </span><span>list</span><span> * </span><span>thm</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> * </span><span>local_theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> primrec_global</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>binding</span><span> * </span><span>typ</span><span> </span><span>option</span><span> * </span><span>mixfix</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="entity"><span>Specification.multi_specs</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> </span><span>list</span><span> * </span><span>thm</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> * </span><span>theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> primrec_overloaded</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span> * </span><span>bool</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span>binding</span><span> * </span><span>typ</span><span> </span><span>option</span><span> * </span><span>mixfix</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Specification.multi_specs</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span>term</span><span> </span><span>list</span><span> * </span><span>thm</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> * </span><span>theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> primrec_simple</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>binding</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span> * </span><span>mixfix</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> </span><span>list</span><span> * </span><span class="main"><span>(</span></span><span>term</span><span> </span><span>list</span><span> * </span><span>thm</span><span> </span><span>list</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> * </span><span>local_theory</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>BNF_LFP_Compat</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>BNF_LFP_COMPAT</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Ctr_Sugar</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>BNF_Util</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>BNF_Tactics</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>BNF_FP_Util</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>BNF_FP_Def_Sugar</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>BNF_FP_N2M_Sugar</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>BNF_LFP</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>compat_N</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"compat_"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rec_split_N</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"rec_split_"</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>preference</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Keep_Nesting</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Include_GFPs</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Kill_Type_Args</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_split_rec_rhs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>fpTs</span></span><span> </span><span class="entity"><span>Cs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>recs</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>rec1</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>repair_rec_arg_args</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>repair_rec_arg_args</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>g_T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>g_Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>g</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>gs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x_Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body_T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>strip_type</span><span> </span><span class="entity"><span>g_T</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="entity"><span>HOLogic.dest_prodT</span></span><span> </span><span class="entity"><span>body_T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>g</span></span><span class="main"><span>]</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fst_T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fpTs</span></span><span> </span><span class="entity"><span>fst_T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>xs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_Frees</span></span><span> </span><span class="inner_quoted"><span>"x"</span></span><span> </span><span class="entity"><span>x_Ts</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>mk_proj</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>fold_rev</span><span> </span><span>Term.lambda</span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_proj</span></span><span> </span><span class="main"><span>(</span></span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>g</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="main"><span>[</span></span><span class="entity"><span>HOLogic.mk_fst</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>HOLogic.mk_snd</span></span><span class="main"><span>]</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
              </span><span class="main"><span>[</span></span><span class="entity"><span>g</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
          </span><span>::</span><span> </span><span class="entity"><span>repair_rec_arg_args</span></span><span> </span><span class="entity"><span>g_Ts</span></span><span> </span><span class="entity"><span>gs</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>repair_rec_arg_args</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>g_T</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>g_Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>g</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>gs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fpTs</span></span><span> </span><span class="entity"><span>g_T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>find_index</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Cs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>g_Ts</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>h</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>nth</span><span> </span><span class="entity"><span>gs</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>g_Ts'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>nth_drop</span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="entity"><span>g_Ts</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>gs'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>nth_drop</span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="entity"><span>gs</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="main"><span>[</span></span><span class="entity"><span>g</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>h</span></span><span class="main"><span>]</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>repair_rec_arg_args</span></span><span> </span><span class="entity"><span>g_Ts'</span></span><span> </span><span class="entity"><span>gs'</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="main"><span>[</span></span><span class="entity"><span>g</span></span><span class="main"><span>]</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>repair_rec_arg_args</span></span><span> </span><span class="entity"><span>g_Ts</span></span><span> </span><span class="entity"><span>gs</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>repair_back_rec_arg</span></span><span> </span><span class="entity"><span>f_T</span></span><span> </span><span class="entity"><span>f'</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>g_Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.binder_types</span><span> </span><span class="entity"><span>f_T</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>gs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_Frees</span></span><span> </span><span class="inner_quoted"><span>"g"</span></span><span> </span><span class="entity"><span>g_Ts</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>fold_rev</span><span> </span><span>Term.lambda</span><span> </span><span class="entity"><span>gs</span></span><span> </span><span class="main"><span>(</span></span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f'</span></span><span class="main"><span>,</span></span><span>
          </span><span class="entity"><span>flat_rec_arg_args</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>repair_rec_arg_args</span></span><span> </span><span class="entity"><span>g_Ts</span></span><span> </span><span class="entity"><span>gs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>f_Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>binder_fun_types</span></span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>rec1</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fs'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_Frees</span></span><span> </span><span class="inner_quoted"><span>"f"</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>f_Ts</span></span><span class="main"><span>)</span></span><span> </span><span>Term.dummyT</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_rec'</span></span><span> </span><span class="entity"><span>recx</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>fold_rev</span><span> </span><span>Term.lambda</span><span> </span><span class="entity"><span>fs'</span></span><span> </span><span class="main"><span>(</span></span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>recx</span></span><span class="main"><span>,</span></span><span> </span><span>map2</span><span> </span><span class="entity"><span>repair_back_rec_arg</span></span><span> </span><span class="entity"><span>f_Ts</span></span><span> </span><span class="entity"><span>fs'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Syntax.check_term</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>map</span><span> </span><span class="entity"><span>mk_rec'</span></span><span> </span><span class="entity"><span>recs</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>define_split_recs</span></span><span> </span><span class="entity"><span>fpTs</span></span><span> </span><span class="entity"><span>Cs</span></span><span> </span><span class="entity"><span>recs</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>b_names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Name.variant_list</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>base_name_of_typ</span></span><span> </span><span class="entity"><span>fpTs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_binding</span></span><span> </span><span class="entity"><span>b_name</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Binding.qualify</span><span> </span><span>true</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>compat_N</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>b_name</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span>Binding.prefix_name</span><span> </span><span class="entity"><span>rec_split_N</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="entity"><span>b_name</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>mk_binding</span></span><span> </span><span class="entity"><span>b_names</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rhss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_split_rec_rhs</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>fpTs</span></span><span> </span><span class="entity"><span>Cs</span></span><span> </span><span class="entity"><span>recs</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>fold_map</span></span><span> 3</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>define_co_rec_as</span></span><span> </span><span class="entity"><span>Least_FP</span></span><span> </span><span class="entity"><span>Cs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fpTs</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="entity"><span>rhss</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_split_rec_thmss</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>Xs</span></span><span> </span><span class="entity"><span>ctrXs_Tsss</span></span><span> </span><span class="entity"><span>ctrss</span></span><span> </span><span class="entity"><span>rec0_thmss</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>recs</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>rec1</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rec_defs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>f_Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>binder_fun_types</span></span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>rec1</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_Frees</span></span><span> </span><span class="inner_quoted"><span>"f"</span></span><span> </span><span class="entity"><span>f_Ts</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>frecs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>recx</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>recx</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>recs</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Xs_frecs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Xs</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>frecs</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>unflat</span><span> </span><span class="entity"><span>ctrss</span></span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_rec_call</span></span><span> </span><span class="entity"><span>g</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ran_T</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span>Name.uu</span><span class="main"><span>,</span></span><span> </span><span>Term.dummyT</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_rec_call</span></span><span> </span><span class="entity"><span>g</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ran_T</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk_rec_call</span></span><span> </span><span class="entity"><span>g</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>frec</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the</span><span> </span><span class="main"><span>(</span></span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Xs_frecs</span></span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>xg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>g</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span>Bound</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>downto</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>frec</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>xg</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_rec_arg_arg</span></span><span> </span><span class="entity"><span>ctrXs_T</span></span><span> </span><span class="entity"><span>g</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>g</span></span><span> </span><span>::</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Xs</span></span><span> </span><span class="main"><span>(</span></span><span>body_type</span><span> </span><span class="entity"><span>ctrXs_T</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>mk_rec_call</span></span><span> </span><span class="entity"><span>g</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="entity"><span>ctrXs_T</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_goal</span></span><span> </span><span class="entity"><span>frec</span></span><span> </span><span class="entity"><span>ctrXs_Ts</span></span><span> </span><span class="entity"><span>ctr</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctr_Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>binder_types</span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>ctr</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>gs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_Frees</span></span><span> </span><span class="inner_quoted"><span>"g"</span></span><span> </span><span class="entity"><span>ctr_Ts</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>gctr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fgs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>flat_rec_arg_args</span></span><span> </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="entity"><span>mk_rec_arg_arg</span></span><span> </span><span class="entity"><span>ctrXs_Ts</span></span><span> </span><span class="entity"><span>gs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span>fold_rev</span><span> </span><span>Logic.all</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>fs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gs</span></span><span class="main"><span>]</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>mk_Trueprop_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>frec</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>gctr</span></span><span class="main"><span>,</span></span><span> </span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fgs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>Syntax.check_term</span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goalss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 4</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 3</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span>o</span><span> </span><span class="entity"><span>mk_goal</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>frecs</span></span><span> </span><span class="entity"><span>ctrXs_Tsss</span></span><span> </span><span class="entity"><span>ctrss</span></span><span> </span><span class="entity"><span>fss</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>unfold_thms_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Fun.html#Fun.o_apply|fact"><span>o_apply</span></a><span> </span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.fst_conv|fact"><span>fst_conv</span></a><span> </span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.snd_conv|fact"><span>snd_conv</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>@</span><span> </span><span class="entity"><span>rec_defs</span></span><span> </span><span>@</span><span> </span><span>flat</span><span> </span><span class="entity"><span>rec0_thmss</span></span><span class="main"><span>)</span></span><span> </span><span>THEN</span><span>
      </span><span>HEADGOAL</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rtac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>refl</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prove</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Goal.prove_sorry</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tac</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>context</span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Thm.close_derivation</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>prove</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>goalss</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>define_split_rec_derive_induct_rec_thms</span></span><span> </span><span class="entity"><span>Xs</span></span><span> </span><span class="entity"><span>fpTs</span></span><span> </span><span class="entity"><span>ctrXs_Tsss</span></span><span> </span><span class="entity"><span>ctrss</span></span><span> </span><span class="entity"><span>inducts</span></span><span> </span><span class="entity"><span>induct</span></span><span> </span><span class="entity"><span>recs0</span></span><span> </span><span class="entity"><span>rec_thmss</span></span><span>
    </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(* imperfect: will not yield the expected theorem for functions taking a large number of
       arguments *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>repair_induct</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unfold_thms</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../BNF_Least_Fixpoint.html#BNF_Least_Fixpoint.all_mem_range|fact"><span>all_mem_range</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inducts'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>repair_induct</span></span><span> </span><span class="entity"><span>inducts</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>induct'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>repair_induct</span></span><span> </span><span class="entity"><span>induct</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Cs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>TVar</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>TFree</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>body_type</span><span> </span><span>o</span><span> </span><span>fastype_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>recs0</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>recs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_co_rec</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>Least_FP</span></span><span> </span><span class="entity"><span>Cs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fpTs</span></span><span> </span><span class="entity"><span>recs0</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>recs'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rec'_defs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>define_split_recs</span></span><span> </span><span class="entity"><span>fpTs</span></span><span> </span><span class="entity"><span>Cs</span></span><span> </span><span class="entity"><span>recs</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span>split_list</span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rec'_thmss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_split_rec_thmss</span></span><span> </span><span class="entity"><span>lthy'</span></span><span> </span><span class="entity"><span>Xs</span></span><span> </span><span class="entity"><span>ctrXs_Tsss</span></span><span> </span><span class="entity"><span>ctrss</span></span><span> </span><span class="entity"><span>rec_thmss</span></span><span> </span><span class="entity"><span>recs'</span></span><span> </span><span class="entity"><span>rec'_defs</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>inducts'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>induct'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>recs'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rec'_thmss</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>body_rec_indices</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Old_Datatype_Aux.DtRec</span></span><span> </span><span class="entity"><span>kk</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>kk</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>body_rec_indices</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Old_Datatype_Aux.DtType</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>D</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>body_rec_indices</span></span><span> </span><span class="entity"><span>D</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>body_rec_indices</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>reindex_desc</span></span><span> </span><span class="entity"><span>desc</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>kks</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>desc</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>perm_kks</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>sort</span><span> </span><span>int_ord</span><span> </span><span class="entity"><span>kks</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>perm_dtyp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Old_Datatype_Aux.DtType</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ds</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Old_Datatype_Aux.DtType</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>perm_dtyp</span></span><span> </span><span class="entity"><span>Ds</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>perm_dtyp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Old_Datatype_Aux.DtRec</span></span><span> </span><span class="entity"><span>kk</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>Old_Datatype_Aux.DtRec</span></span><span> </span><span class="main"><span>(</span></span><span>find_index</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>kk</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>kks</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>perm_dtyp</span></span><span> </span><span class="entity"><span>D</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>D</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>perm_kks</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>kks</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="entity"><span>desc</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="entity"><span>perm_kks</span></span><span> </span><span>~~</span><span>
      </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ds</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sDss</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>perm_dtyp</span></span><span> </span><span class="entity"><span>Ds</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>perm_dtyp</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sDss</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>desc</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_infos_of_mutually_recursive_new_datatypes</span></span><span> </span><span class="entity"><span>prefs</span></span><span> </span><span class="entity"><span>check_names</span></span><span> </span><span class="entity"><span>fpT_names0</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>not_datatype_name</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>error</span><span> </span><span class="main"><span>(</span></span><span>quote</span><span> </span><span class="entity"><span>s</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" is not a datatype"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>not_mutually_recursive</span></span><span> </span><span class="entity"><span>ss</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"{"</span></span><span> </span><span>^</span><span> </span><span>commas</span><span> </span><span class="entity"><span>ss</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"} is not a complete set of mutually recursive datatypes"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>checked_fp_sugar_of</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>fp_sugar_of</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fp_sugar</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>fp</span></span><span class="main"><span>,</span></span><span> </span><span>fp_co_induct_sugar</span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prefs</span></span><span> </span><span class="entity"><span>Include_GFPs</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>fp</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Least_FP</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>fp_sugar</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>not_datatype_name</span></span><span> </span><span class="entity"><span>s</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>not_datatype_name</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fpTs0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>var_As</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>T</span><span> </span><span>o</span><span> </span><span class="entity"><span>checked_fp_sugar_of</span></span><span> </span><span>o</span><span> </span><span>fst</span><span> </span><span>o</span><span> </span><span>dest_Type</span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>Ts</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>fp_res</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>checked_fp_sugar_of</span></span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>fpT_names0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fpT_names</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>fpT_name1</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span>dest_Type</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fpTs0</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>check_names</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fpT_names0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fpT_names</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>not_mutually_recursive</span></span><span> </span><span class="entity"><span>fpT_names0</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>As_names</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.variant_fixes</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>TVar</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>var_As</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>TVar</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>TFree</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>As_names</span></span><span> </span><span class="entity"><span>var_As</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fpTs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fpT_names</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nn_fp</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>fpTs</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mk_dtyp</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Old_Datatype_Aux.dtyp_of_typ</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Term.dest_TFree</span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>dest_Type</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fpTs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_ctr_descr</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_ctr</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span>#&gt;</span><span> </span><span>dest_Const</span><span> </span><span>##&gt;</span><span> </span><span class="main"><span>(</span></span><span>binder_types</span><span> </span><span>#&gt;</span><span> </span><span>map</span><span> </span><span class="entity"><span>mk_dtyp</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_typ_descr</span></span><span> </span><span class="entity"><span>index</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>ctrs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ctr_sugar</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>index</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T_name</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>mk_dtyp</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_ctr_descr</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctrs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fp_sugars</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>fp</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>checked_fp_sugar_of</span></span><span> </span><span class="entity"><span>fpT_names</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fp_ctr_sugars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>ctr_sugar</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>fp_ctr_sugar</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fp_sugars</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>orig_descr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 3</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="entity"><span>mk_typ_descr</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span> </span><span>upto</span><span> </span><span class="entity"><span>nn_fp</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fpTs</span></span><span> </span><span class="entity"><span>fp_ctr_sugars</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>all_infos</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Old_Datatype_Data.get_all</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>orig_descr'</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>nested_descrs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prefs</span></span><span> </span><span class="entity"><span>Keep_Nesting</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>orig_descr</span></span><span class="main"><span>]</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>fst</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Old_Datatype_Aux.unfold_datatypes</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>orig_descr</span></span><span> </span><span class="entity"><span>all_infos</span></span><span> </span><span class="entity"><span>orig_descr</span></span><span> </span><span class="entity"><span>nn_fp</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cliquify_descr</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cliquify_descr</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>entry</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span class="entity"><span>entry</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cliquify_descr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>full_descr</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T_name1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nn</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fpT_names</span></span><span> </span><span class="entity"><span>T_name1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
              </span><span class="entity"><span>nn_fp</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
              </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Symtab.lookup</span><span> </span><span class="entity"><span>all_infos</span></span><span> </span><span class="entity"><span>T_name1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                </span><span>SOME</span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>descr</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span>length</span><span> </span><span class="main"><span>(</span></span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span>exists</span><span> </span><span class="entity"><span>Old_Datatype_Aux.is_rec_type</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>descr</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"unknown old-style datatype"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span>chop</span><span> </span><span class="entity"><span>nn</span></span><span> </span><span class="entity"><span>full_descr</span></span><span> </span><span>||&gt;</span><span> </span><span class="entity"><span>cliquify_descr</span></span><span> </span><span>|&gt;</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>::</span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(* put nested types before the types that nest them, as needed for N2M *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>descrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>burrow</span><span> </span><span class="entity"><span>reindex_desc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>orig_descr'</span></span><span> </span><span>::</span><span> </span><span>rev</span><span> </span><span class="entity"><span>nested_descrs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mutual_cliques</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>descr</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>split_list</span><span> </span><span class="main"><span>(</span></span><span>flat</span><span> </span><span class="main"><span>(</span></span><span>map_index</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>descr</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>descr</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span>maps</span><span> </span><span class="entity"><span>cliquify_descr</span></span><span> </span><span class="entity"><span>descrs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fpTs'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Old_Datatype_Aux.get_rec_types</span></span><span> </span><span class="entity"><span>descr</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nn</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>fpTs'</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fp_sugars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>checked_fp_sugar_of</span></span><span> </span><span>o</span><span> </span><span>fst</span><span> </span><span>o</span><span> </span><span>dest_Type</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fpTs'</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctr_Tsss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Old_Datatype_Aux.typ_of_dtyp</span></span><span> </span><span class="entity"><span>descr</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>3</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>descr</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>kkssss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>body_rec_indices</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>3</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>descr</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>callers</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Name.uu</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.unit|type"><span>unit</span></a><span> </span><span class="main"><span>=&gt;</span></span><span> </span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.unit|type"><span>unit</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span> </span><span>upto</span><span> </span><span class="entity"><span>nn</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>apply_comps</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>mk_partial_compN</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>HOLogic.unitT</span></span><span> </span><span>---&gt;</span><span> </span><span class="entity"><span>HOLogic.unitT</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>callers</span></span><span> </span><span class="entity"><span>kk</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>callssss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>o</span><span> </span><span class="entity"><span>apply_comps</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>num_binder_types</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctr_Tsss</span></span><span> </span><span class="entity"><span>kkssss</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>b_names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Name.variant_list</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>base_name_of_typ</span></span><span> </span><span class="entity"><span>fpTs'</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>compat_b_names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>prefix</span><span> </span><span class="entity"><span>compat_N</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>b_names</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>compat_bs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>Binding.name</span><span> </span><span class="entity"><span>compat_b_names</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>fp_sugars'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lfp_sugar_thms'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>nn</span></span><span> </span><span>&gt;</span><span> </span><span class="entity"><span>nn_fp</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="entity"><span>mutualize_fp_sugars</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Least_FP</span></span><span> </span><span class="entity"><span>mutual_cliques</span></span><span> </span><span class="entity"><span>compat_bs</span></span><span> </span><span class="entity"><span>fpTs'</span></span><span> </span><span class="entity"><span>callers</span></span><span> </span><span class="entity"><span>callssss</span></span><span>
          </span><span class="entity"><span>fp_sugars</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>fp_sugars</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_ctr_of</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span>fp_ctr_sugar</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>ctr_sugar</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>ctrs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>fp_sugar</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_ctr</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctrs</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>substAT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.typ_subst_atomic</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>var_As</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Xs'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>#</span></span><span>X</span><span> </span><span class="entity"><span>fp_sugars'</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctrXs_Tsss'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>substAT</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>ctrXs_Tss</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>fp_ctr_sugar</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fp_sugars'</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctrss'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="entity"><span>mk_ctr_of</span></span><span> </span><span class="entity"><span>fp_sugars'</span></span><span> </span><span class="entity"><span>fpTs'</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>{</span></span><span>fp_co_induct_sugar</span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>{</span></span><span>common_co_inducts</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>induct</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fp_sugars'</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inducts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>co_inducts</span><span> </span><span>o</span><span> </span><span>the</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>fp_co_induct_sugar</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fp_sugars'</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>recs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>co_rec</span><span> </span><span>o</span><span> </span><span>the</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>fp_co_induct_sugar</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fp_sugars'</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rec_thmss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>co_rec_thms</span><span> </span><span>o</span><span> </span><span>the</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>fp_co_induct_sugar</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fp_sugars'</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_nested_rec_type</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Xs'</span></span><span> </span><span class="main"><span>(</span></span><span>body_type</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_nested_rec_type</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>lfp_sugar_thms''</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inducts'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>induct'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>recs'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rec'_thmss</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy''</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prefs</span></span><span> </span><span class="entity"><span>Keep_Nesting</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
         </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>exists</span><span> </span><span class="main"><span>(</span></span><span>exists</span><span> </span><span class="main"><span>(</span></span><span>exists</span><span> </span><span class="entity"><span>is_nested_rec_type</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctrXs_Tsss'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>lfp_sugar_thms'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inducts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>induct</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>recs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rec_thmss</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>fp</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Least_FP</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="entity"><span>define_split_rec_derive_induct_rec_thms</span></span><span> </span><span class="entity"><span>Xs'</span></span><span> </span><span class="entity"><span>fpTs'</span></span><span> </span><span class="entity"><span>ctrXs_Tsss'</span></span><span> </span><span class="entity"><span>ctrss'</span></span><span> </span><span class="entity"><span>inducts</span></span><span> </span><span class="entity"><span>induct</span></span><span> </span><span class="entity"><span>recs</span></span><span>
          </span><span class="entity"><span>rec_thmss</span></span><span> </span><span class="entity"><span>lthy'</span></span><span>
        </span><span>|&gt;&gt;</span><span> </span><span>`</span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inducts'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>induct'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rec'_thmss</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>inducts'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>induct'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_induct_attrs</span></span><span> </span><span class="entity"><span>ctrss'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rec'_thmss</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="entity"><span>not_datatype_name</span></span><span> </span><span class="entity"><span>fpT_name1</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rec'_names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span>dest_Const</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>recs'</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rec'_thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>flat</span><span> </span><span class="entity"><span>rec'_thmss</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_info</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>{</span></span><span>T</span><span> </span><span class="main"><span>=</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T_name0</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>fp_ctr_sugar</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>ctr_sugar</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>casex</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>exhaust</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nchotomy</span></span><span class="main"><span>,</span></span><span>
        </span><span class="entity"><span>injects</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>distincts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>case_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>case_cong</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>case_cong_weak</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>split</span></span><span class="main"><span>,</span></span><span>
        </span><span class="entity"><span>split_asm</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>fp_sugar</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>T_name0</span></span><span class="main"><span>,</span></span><span>
       </span><span class="main"><span>{</span></span><span>index</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>kk</span></span><span class="main"><span>,</span></span><span> </span><span>descr</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>descr</span></span><span class="main"><span>,</span></span><span> </span><span>inject</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>injects</span></span><span class="main"><span>,</span></span><span> </span><span>distinct</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>distincts</span></span><span class="main"><span>,</span></span><span> </span><span>induct</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>induct'</span></span><span class="main"><span>,</span></span><span>
        </span><span>inducts</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>inducts'</span></span><span class="main"><span>,</span></span><span> </span><span>exhaust</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>exhaust</span></span><span class="main"><span>,</span></span><span> </span><span>nchotomy</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nchotomy</span></span><span class="main"><span>,</span></span><span> </span><span>rec_names</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rec'_names</span></span><span class="main"><span>,</span></span><span>
        </span><span>rec_rewrites</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rec'_thms</span></span><span class="main"><span>,</span></span><span> </span><span>case_name</span><span> </span><span class="main"><span>=</span></span><span> </span><span>fst</span><span> </span><span class="main"><span>(</span></span><span>dest_Const</span><span> </span><span class="entity"><span>casex</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>case_rewrites</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>case_thms</span></span><span class="main"><span>,</span></span><span>
        </span><span>case_cong</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>case_cong</span></span><span class="main"><span>,</span></span><span> </span><span>case_cong_weak</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>case_cong_weak</span></span><span class="main"><span>,</span></span><span> </span><span>split</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>split</span></span><span class="main"><span>,</span></span><span>
        </span><span>split_asm</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>split_asm</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>infos</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_index</span><span> </span><span class="entity"><span>mk_info</span></span><span> </span><span class="main"><span>(</span></span><span>take</span><span> </span><span class="entity"><span>nn_fp</span></span><span> </span><span class="entity"><span>fp_sugars'</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>nn</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>b_names</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>compat_b_names</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lfp_sugar_thms''</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>infos</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy''</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>infos_of_new_datatype_mutual_cluster</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>prefs</span></span><span> </span><span class="entity"><span>fpT_name</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get</span></span><span> </span><span class="entity"><span>prefs</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>5</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_infos_of_mutually_recursive_new_datatypes</span></span><span> </span><span class="entity"><span>prefs</span></span><span> </span><span>subset</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>fpT_name</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>ERROR</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>get</span></span><span> </span><span class="entity"><span>prefs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prefs</span></span><span> </span><span class="entity"><span>Keep_Nesting</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>get</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Keep_Nesting</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>prefs</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>infos</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>infos</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_all</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>prefs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.init_global</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>old_info_tab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Old_Datatype_Data.get_all</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>new_T_names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>BNF_FP_Def_Sugar.fp_sugars_of_global</span></span><span> </span><span class="entity"><span>thy</span></span><span>
      </span><span>|&gt;</span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>T</span><span> </span><span class="main"><span>=</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>fp_res_index</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>new_infos</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>infos_of_new_datatype_mutual_cluster</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>insert</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Keep_Nesting</span></span><span> </span><span class="entity"><span>prefs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="entity"><span>new_T_names</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prefs</span></span><span> </span><span class="entity"><span>Keep_Nesting</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Symtab.update</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Symtab.default</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>new_infos</span></span><span>
      </span><span class="entity"><span>old_info_tab</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_one</span></span><span> </span><span class="entity"><span>get_old</span></span><span> </span><span class="entity"><span>get_new</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>prefs</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_fst</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>get_snd</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_old</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>get_new</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prefs</span></span><span> </span><span class="entity"><span>Keep_Nesting</span></span><span> </span><span>?</span><span> </span><span>swap</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>get_fst</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>get_snd</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>res</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>res</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_info_of_new_datatype</span></span><span> </span><span class="entity"><span>prefs</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>T_name</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.init_global</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>infos_of_new_datatype_mutual_cluster</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>prefs</span></span><span> </span><span class="entity"><span>T_name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T_name</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_info</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>prefs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>get_one</span></span><span> </span><span class="entity"><span>Old_Datatype_Data.get_info</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_info_of_new_datatype</span></span><span> </span><span class="entity"><span>prefs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>prefs</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>the_info</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>prefs</span></span><span> </span><span class="entity"><span>T_name</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>get_info</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>prefs</span></span><span> </span><span class="entity"><span>T_name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="entity"><span>info</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>info</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Unknown datatype "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>T_name</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>the_spec</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>T_name</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>descr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>index</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>the_info</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Keep_Nesting</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Include_GFPs</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>T_name</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ds</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctrs0</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the</span><span> </span><span class="main"><span>(</span></span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>descr</span></span><span> </span><span class="entity"><span>index</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tfrees</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>Old_Datatype_Aux.dest_DtTFree</span></span><span> </span><span class="entity"><span>Ds</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Old_Datatype_Aux.typ_of_dtyp</span></span><span> </span><span class="entity"><span>descr</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctrs0</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tfrees</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctrs</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>the_descr</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>prefs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T_names0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>T_name01</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>not_mutually_recursive</span></span><span> </span><span class="entity"><span>ss</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"{"</span></span><span> </span><span>^</span><span> </span><span>commas</span><span> </span><span class="entity"><span>ss</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"} is not a complete set of mutually recursive datatypes"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>info</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>the_info</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>prefs</span></span><span> </span><span class="entity"><span>T_name01</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>descr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>descr</span><span> </span><span class="entity"><span>info</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ds</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the</span><span> </span><span class="main"><span>(</span></span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>descr</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>index</span><span> </span><span class="entity"><span>info</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>Old_Datatype_Aux.dest_DtTFree</span></span><span> </span><span class="entity"><span>Ds</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_DtTFree</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Old_Datatype_Aux.DtTFree</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_DtTFree</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>find_index</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>dTs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>forall</span><span> </span><span class="entity"><span>is_DtTFree</span></span><span> </span><span class="entity"><span>dTs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>descr</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>protoTs</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dataTs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>chop</span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>descr</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span>apply2</span><span> </span><span>o</span><span> </span><span>map</span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ds</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T_name</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Old_Datatype_Aux.typ_of_dtyp</span></span><span> </span><span class="entity"><span>descr</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ds</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T_names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>dataTs</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>eq_set</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T_names</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T_names0</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>not_mutually_recursive</span></span><span> </span><span class="entity"><span>T_names0</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Us</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apply2</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Type</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>protoTs</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>Long_Name.base_name</span><span> </span><span class="entity"><span>T_names</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>auxnames</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Name.make_context</span><span> </span><span class="entity"><span>names</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span>Name.variant</span><span> </span><span>o</span><span> </span><span class="entity"><span>Old_Datatype_Aux.name_of_typ</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Us</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>space_implode</span><span> </span><span class="inner_quoted"><span>"_"</span></span><span> </span><span class="entity"><span>names</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>descr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T_names</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prefix</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>names</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>auxnames</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Us</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_constrs</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>T_name</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>the_spec</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T_name</span></span><span>
  </span><span>|&gt;</span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tfrees</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctrs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>varify_tfree</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>TVar</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>varify_typ</span></span><span> </span><span class="main"><span>(</span></span><span>TFree</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>varify_tfree</span></span><span> </span><span class="entity"><span>x</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>varify_typ</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>;</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dataT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T_name</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>varify_tfree</span></span><span> </span><span class="entity"><span>tfrees</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_ctr_typ</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Term.map_atyps</span><span> </span><span class="entity"><span>varify_typ</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span>---&gt;</span><span> </span><span class="entity"><span>dataT</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="entity"><span>mk_ctr_typ</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctrs</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>old_interpretation_of</span></span><span> </span><span class="entity"><span>prefs</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>config</span></span><span> </span><span class="entity"><span>T_names</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prefs</span></span><span> </span><span class="entity"><span>Keep_Nesting</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
     </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span>is_none</span><span> </span><span>o</span><span> </span><span class="entity"><span>fp_sugar_of_global</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T_names</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>config</span></span><span> </span><span class="entity"><span>T_names</span></span><span> </span><span class="entity"><span>thy</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="entity"><span>thy</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>new_interpretation_of</span></span><span> </span><span class="entity"><span>prefs</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fp_sugars</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>fp_sugar</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T_names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span>dest_Type</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>T</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fp_sugars</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prefs</span></span><span> </span><span class="entity"><span>Include_GFPs</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Least_FP</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>fp</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fp_sugars</span></span><span class="main"><span>)</span></span><span>
       </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prefs</span></span><span> </span><span class="entity"><span>Keep_Nesting</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
         </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span>is_none</span><span> </span><span>o</span><span> </span><span class="entity"><span>Old_Datatype_Data.get_info</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T_names</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>Old_Datatype_Aux.default_config</span></span><span> </span><span class="entity"><span>T_names</span></span><span> </span><span class="entity"><span>thy</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="entity"><span>thy</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>interpretation</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>prefs</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Old_Datatype_Data.interpretation</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>old_interpretation_of</span></span><span> </span><span class="entity"><span>prefs</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span>
  </span><span>#&gt;</span><span> </span><span class="entity"><span>fp_sugars_interpretation</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>(</span></span><span>Local_Theory.background_theory</span><span> </span><span>o</span><span> </span><span class="entity"><span>new_interpretation_of</span></span><span> </span><span class="entity"><span>prefs</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nitpicksimp_simp_attrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="../../../../../HOL.html#HOL.nitpick_simp|attribute"><span class="operator"><span>nitpick_simp</span></span></a><span class="main"><span>,</span></span><span> </span><span class="operator"><span>simp</span></span><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>datatype_compat</span></span><span> </span><span class="entity"><span>fpT_names</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nn</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>b_names</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>compat_b_names</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lfp_sugar_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>infos</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>mk_infos_of_mutually_recursive_new_datatypes</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span>eq_set</span><span> </span><span class="entity"><span>fpT_names</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>all_notes</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rec_thmss</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>lfp_sugar_thms</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>inducts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>induct</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>induct_attrs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rec_thmss</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>common_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>compat_N</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>mk_common_name</span></span><span> </span><span class="entity"><span>b_names</span></span><span class="main"><span>;</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>common_notes</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>nn</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>inductN</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>induct</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>induct_attrs</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
            </span><span>|&gt;</span><span> </span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span class="main"><span>)</span></span><span>
            </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thmN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>attrs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.qualify</span><span> </span><span>true</span><span> </span><span class="entity"><span>common_name</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="entity"><span>thmN</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>attrs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>thms</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>notes</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>inductN</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span>single</span><span> </span><span class="entity"><span>inducts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>induct_attrs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
             </span><span class="main"><span>(</span></span><span class="entity"><span>recN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rec_thmss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nitpicksimp_simp_attrs</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
            </span><span>|&gt;</span><span> </span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span class="main"><span>)</span></span><span>
            </span><span>|&gt;</span><span> </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thmN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thmss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>attrs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>forall</span><span> </span><span>null</span><span> </span><span class="entity"><span>thmss</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>b_name</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.qualify</span><span> </span><span>true</span><span> </span><span class="entity"><span>b_name</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="entity"><span>thmN</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>attrs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>thms</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="entity"><span>compat_b_names</span></span><span> </span><span class="entity"><span>thmss</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>common_notes</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>notes</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rec_thmss</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>register_interpret</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>Old_Datatype_Data.register</span></span><span> </span><span class="entity"><span>infos</span></span><span>
      </span><span>#&gt;</span><span> </span><span class="entity"><span>Old_Datatype_Data.interpretation_data</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Old_Datatype_Aux.default_config</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>infos</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>lthy'</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Local_Theory.raw_theory</span><span> </span><span class="entity"><span>register_interpret</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Local_Theory.notes</span><span> </span><span class="entity"><span>all_notes</span></span><span>
    </span><span>|&gt;</span><span> </span><span>snd</span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>Code.declare_default_eqns</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>rpair</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>flat</span><span> </span><span class="entity"><span>rec_thmss</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>datatype_compat_global</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Named_Target.theory_map</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>datatype_compat</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>datatype_compat_cmd</span></span><span> </span><span class="entity"><span>raw_fpT_names</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fpT_names</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span>dest_Type</span><span> </span><span>o</span><span> </span><span>Proof_Context.read_type_name</span><span> </span><span class="main"><span>{</span></span><span>proper</span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span class="main"><span>,</span></span><span> </span><span>strict</span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>}</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
        </span><span class="entity"><span>raw_fpT_names</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>datatype_compat</span></span><span> </span><span class="entity"><span>fpT_names</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_datatype</span></span><span> </span><span class="entity"><span>prefs</span></span><span> </span><span class="entity"><span>old_specs</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fpT_names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Sign.full_name</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>old_specs</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>new_type_args_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prefs</span></span><span> </span><span class="entity"><span>Kill_Type_Args</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>NONE</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>SOME</span><span> </span><span>Binding.empty</span><span class="main"><span>,</span></span><span>
       </span><span class="main"><span>(</span></span><span>TFree</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">sort</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.type|class"><span>type</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>new_ctr_spec_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.empty</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span>Binding.empty</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mx</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>new_spec_of</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>old_tyargs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mx</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>old_ctr_specs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>new_type_args_of</span></span><span> </span><span class="entity"><span>old_tyargs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mx</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>new_ctr_spec_of</span></span><span> </span><span class="entity"><span>old_ctr_specs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        </span><span class="main"><span>(</span></span><span>Binding.empty</span><span class="main"><span>,</span></span><span> </span><span>Binding.empty</span><span class="main"><span>,</span></span><span> </span><span>Binding.empty</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>new_specs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>new_spec_of</span></span><span> </span><span class="entity"><span>old_specs</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>fpT_names</span></span><span class="main"><span>,</span></span><span>
     </span><span class="entity"><span>thy</span></span><span>
     </span><span>|&gt;</span><span> </span><span class="entity"><span>Named_Target.theory_map</span></span><span>
       </span><span class="main"><span>(</span></span><span class="entity"><span>co_datatypes</span></span><span> </span><span class="entity"><span>Least_FP</span></span><span> </span><span class="entity"><span>construct_lfp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>default_ctr_options</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>new_specs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
     </span><span>|&gt;</span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prefs</span></span><span> </span><span class="entity"><span>Keep_Nesting</span></span><span class="main"><span>)</span></span><span> </span><span>?</span><span> </span><span>perhaps</span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>datatype_compat_global</span></span><span> </span><span class="entity"><span>fpT_names</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>old_of_new</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>simpss</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>simpss</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>primrec</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>old_of_new</span></span><span> </span><span>flat</span><span class="main"><span>)</span></span><span> </span><span>ooo</span><span> </span><span class="entity"><span>BNF_LFP_Rec_Sugar.primrec</span></span><span> </span><span>false</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>primrec_global</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>old_of_new</span></span><span> </span><span>flat</span><span class="main"><span>)</span></span><span> </span><span>ooo</span><span> </span><span class="entity"><span>BNF_LFP_Rec_Sugar.primrec_global</span></span><span> </span><span>false</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>primrec_overloaded</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>old_of_new</span></span><span> </span><span>flat</span><span class="main"><span>)</span></span><span> </span><span>oooo</span><span> </span><span class="entity"><span>BNF_LFP_Rec_Sugar.primrec_overloaded</span></span><span> </span><span>false</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>primrec_simple</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span>fst</span><span> </span><span>o</span><span> </span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>old_of_new</span></span><span> </span><span class="main"><span>(</span></span><span>flat</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>ooo</span><span>
  </span><span class="entity"><span>BNF_LFP_Rec_Sugar.primrec_simple</span></span><span> </span><span>false</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Outer_Syntax.local_theory</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword1"><span>datatype_compat</span></span><span>›</span></span></span><span>
    </span><span class="inner_quoted"><span>"register datatypes as old-style datatypes and derive old-style properties"</span></span><span>
    </span><span class="main"><span>(</span></span><span>Scan.repeat1</span><span> </span><span>Parse.type_const</span><span> </span><span>&gt;&gt;</span><span> </span><span class="entity"><span>datatype_compat_cmd</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
</span></pre>
</body>

</html>