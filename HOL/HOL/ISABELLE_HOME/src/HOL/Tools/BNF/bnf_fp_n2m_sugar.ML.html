<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Tools/BNF/bnf_fp_n2m_sugar.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Tools/BNF/bnf_fp_n2m_sugar.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      HOL/Tools/BNF/bnf_fp_n2m_sugar.ML
    Author:     Jasmin Blanchette, TU Muenchen
    Copyright   2013

Suggared flattening of nested to mutual (co)recursion.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>BNF_FP_N2M_SUGAR</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> unfold_lets_splits</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> unfold_splits_lets</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> dest_map</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> * </span><span>term</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> dest_pred</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> * </span><span>term</span><span> </span><span>list</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mutualize_fp_sugars</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>BNF_Util.fp_kind</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>binding</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span>typ</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span>list</span><span> </span><span>list</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>BNF_FP_Def_Sugar.fp_sugar</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>BNF_FP_Def_Sugar.fp_sugar</span></span><span> </span><span>list</span><span>
     * </span><span class="main"><span>(</span></span><span class="entity"><span>BNF_FP_Def_Sugar.lfp_sugar_thms</span></span><span> </span><span>option</span><span> * </span><span class="entity"><span>BNF_FP_Def_Sugar.gfp_sugar_thms</span></span><span> </span><span>option</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    * </span><span>local_theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> nested_to_mutual_fps</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>BNF_Util.fp_kind</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>binding</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> * </span><span>term</span><span> </span><span>list</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span>typ</span><span> </span><span>list</span><span> * </span><span>int</span><span> </span><span>list</span><span> * </span><span class="entity"><span>BNF_FP_Def_Sugar.fp_sugar</span></span><span> </span><span>list</span><span>
     * </span><span class="main"><span>(</span></span><span class="entity"><span>BNF_FP_Def_Sugar.lfp_sugar_thms</span></span><span> </span><span>option</span><span> * </span><span class="entity"><span>BNF_FP_Def_Sugar.gfp_sugar_thms</span></span><span> </span><span>option</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    * </span><span>local_theory</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>BNF_FP_N2M_Sugar</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>BNF_FP_N2M_SUGAR</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Ctr_Sugar</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>BNF_Util</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>BNF_Def</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>BNF_Comp</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>BNF_FP_Util</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>BNF_FP_Def_Sugar</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>BNF_FP_N2M</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>n2mN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"n2m_"</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>n2m_sugar</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fp_sugar</span></span><span> </span><span>list</span><span> * </span><span class="main"><span>(</span></span><span class="entity"><span>lfp_sugar_thms</span></span><span> </span><span>option</span><span> * </span><span class="entity"><span>gfp_sugar_thms</span></span><span> </span><span>option</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Generic_Data</span><span>
</span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>n2m_sugar</span></span><span> </span><span>Typtab.table</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Typtab.empty</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>merge</span></span><span> </span><span class="entity"><span>data</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Typtab.merge</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>data</span></span><span class="main"><span>;</span></span><span>
</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>morph_n2m_sugar</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fp_sugars</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lfp_sugar_thms_opt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gfp_sugar_thms_opt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>morph_fp_sugar</span></span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fp_sugars</span></span><span class="main"><span>,</span></span><span>
   </span><span class="main"><span>(</span></span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>morph_lfp_sugar_thms</span></span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lfp_sugar_thms_opt</span></span><span class="main"><span>,</span></span><span>
    </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>morph_gfp_sugar_thms</span></span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>gfp_sugar_thms_opt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>transfer_n2m_sugar</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>morph_n2m_sugar</span></span><span> </span><span>o</span><span> </span><span>Morphism.transfer_morphism</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>n2m_sugar_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Typtab.lookup</span><span> </span><span class="main"><span>(</span></span><span>Data.get</span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span>#&gt;</span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>transfer_n2m_sugar</span></span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>register_n2m_sugar</span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="entity"><span>n2m_sugar</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Local_Theory.declaration</span><span> </span><span class="main"><span>{</span></span><span>syntax</span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span> </span><span>pervasive</span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>}</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Data.map</span><span> </span><span class="main"><span>(</span></span><span>Typtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>key</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>morph_n2m_sugar</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>n2m_sugar</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unfold_lets_splits</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Let|const"><span>Let</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>unfold_lets_splits</span></span><span> </span><span class="main"><span>(</span></span><span>betapply</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unfold_splits_lets</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>unfold_lets_splits</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>betapply</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unfold_lets_splits</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unfold_lets_splits</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>unfold_lets_splits</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unfold_lets_splits</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>unfold_lets_splits</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>unfold_splits_lets</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.prod.case_prod|const"><span>case_prod</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>unfold_splits_lets</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="entity"><span>u'</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s1</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>s2</span></span><span class="main"><span>,</span></span><span> </span><span>Term.maxidx_of_term</span><span> </span><span class="entity"><span>u'</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>HOLogic.mk_prodT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>lambda</span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>(</span></span><span>incr_boundvars</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>(</span></span><span>betapplys</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>HOLogic.mk_fst</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>HOLogic.mk_snd</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>unfold_lets_splits</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>unfold_splits_lets</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Let|const"><span>Let</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unfold_lets_splits</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>unfold_splits_lets</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>betapply</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unfold_splits_lets</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unfold_lets_splits</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>unfold_splits_lets</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unfold_splits_lets</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>unfold_splits_lets</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unfold_lets_splits</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_either_map_or_pred</span></span><span> </span><span class="entity"><span>map_or_pred_of_bnf</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>T_name</span></span><span> </span><span class="entity"><span>call</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bnf_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>T_name</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>const0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_or_pred_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>live</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>live_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f_Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>strip_typeN</span></span><span> </span><span class="entity"><span>live</span></span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>const0</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_index</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"f"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>f_Ts</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pat</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>betapplys</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>const0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tenv</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fo_match</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>call</span></span><span> </span><span class="entity"><span>pat</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>const0</span></span><span class="main"><span>,</span></span><span> </span><span>Vartab.fold_rev</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>cons</span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tenv</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dest_map</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_either_map_or_pred</span></span><span> </span><span class="entity"><span>map_of_bnf</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dest_pred</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_either_map_or_pred</span></span><span> </span><span class="entity"><span>pred_of_bnf</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_map_or_pred</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>T_name</span></span><span> </span><span class="entity"><span>call</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest_map</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>T_name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>call</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="entity"><span>res</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>res</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>dest_pred</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>T_name</span></span><span> </span><span class="entity"><span>call</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_abs_or_applied_map_or_pred</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Term.dummy</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dest_abs_or_applied_map_or_pred</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_map_or_pred</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>t1</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_partition</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ys</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>good</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bad</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>y</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>y</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ys</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>good</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bad</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ys</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>good</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>bad</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>key_of_fp_eqs</span></span><span> </span><span class="entity"><span>fp</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>fpTs</span></span><span> </span><span class="entity"><span>Xs</span></span><span> </span><span class="entity"><span>ctrXs_repTs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>case_fp</span></span><span> </span><span class="entity"><span>fp</span></span><span> </span><span class="inner_quoted"><span>"l"</span></span><span> </span><span class="inner_quoted"><span>"g"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fpTs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>Xs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>ctrXs_repTs</span></span><span class="main"><span>)</span></span><span>
  </span><span>|&gt;</span><span> </span><span>Term.map_atyps</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>TFree</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>find_index</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>TFree</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"'"</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_indices</span></span><span> </span><span class="entity"><span>callers</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>callers</span></span><span>
  </span><span>|&gt;</span><span> </span><span>map_index</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>exists_subterm</span><span> </span><span class="main"><span>(</span></span><span>equal</span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
  </span><span>|&gt;</span><span> </span><span>map_filter</span><span> </span><span>I</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mutualize_fp_sugars</span></span><span> </span><span class="entity"><span>plugins</span></span><span> </span><span class="entity"><span>fp</span></span><span> </span><span class="entity"><span>mutual_cliques</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="entity"><span>fpTs</span></span><span> </span><span class="entity"><span>callers</span></span><span> </span><span class="entity"><span>callssss</span></span><span> </span><span class="entity"><span>fp_sugars0</span></span><span> </span><span class="entity"><span>no_defs_lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>no_defs_lthy</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>qsotm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>quote</span><span> </span><span>o</span><span> </span><span>Syntax.string_of_term</span><span> </span><span class="entity"><span>no_defs_lthy</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>incompatible_calls</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Incompatible "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>co_prefix</span></span><span> </span><span class="entity"><span>fp</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"recursive calls: "</span></span><span> </span><span>^</span><span> </span><span>commas</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>qsotm</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mutual_self_call</span></span><span> </span><span class="entity"><span>caller</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Unsupported mutual self-call "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>qsotm</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" from "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>qsotm</span></span><span> </span><span class="entity"><span>caller</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>nested_self_call</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Unsupported nested self-call "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>qsotm</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>b_names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>Binding.name_of</span><span> </span><span class="entity"><span>bs</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fp_b_names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>base_name_of_typ</span></span><span> </span><span class="entity"><span>fpTs</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nn</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>fpTs</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>kks</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span>upto</span><span> </span><span class="entity"><span>nn</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>target_ctr_sugar_of_fp_sugar</span></span><span> </span><span class="entity"><span>fpT</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span>fp_ctr_sugar</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>ctr_sugar</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>fp_sugar</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rho</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Vartab.fold</span><span> </span><span class="main"><span>(</span></span><span>cons</span><span> </span><span>o</span><span> </span><span>apsnd</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Sign.typ_match</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fpT</span></span><span class="main"><span>)</span></span><span> </span><span>Vartab.empty</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Morphism.term_morphism</span><span> </span><span class="inner_quoted"><span>"BNF"</span></span><span> </span><span class="main"><span>(</span></span><span>Term.subst_TVars</span><span> </span><span class="entity"><span>rho</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>morph_ctr_sugar</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>ctr_sugar</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctor_iff_dtors</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>ctor_iff_dtor</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>fp_ctr_sugar</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fp_sugars0</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctr_defss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>ctr_defs</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>fp_ctr_sugar</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fp_sugars0</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mapss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>map_thms</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>fp_bnf_sugar</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fp_sugars0</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctr_sugars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="entity"><span>target_ctr_sugar_of_fp_sugar</span></span><span> </span><span class="entity"><span>fpTs</span></span><span> </span><span class="entity"><span>fp_sugars0</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctrss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>#</span></span><span>ctrs</span><span> </span><span class="entity"><span>ctr_sugars</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctr_Tss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fastype_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctrss</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>As'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span>Term.add_tfreesT</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctr_Tss</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>TFree</span><span> </span><span class="entity"><span>As'</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>Cs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Xs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>no_defs_lthy</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span>Variable.declare_typ</span><span> </span><span class="entity"><span>As</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>mk_TFrees</span></span><span> </span><span class="entity"><span>nn</span></span><span>
      </span><span>||&gt;&gt;</span><span> </span><span class="entity"><span>variant_tfrees</span></span><span> </span><span class="entity"><span>fp_b_names</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_call_dead</span></span><span> </span><span class="entity"><span>live_call</span></span><span> </span><span class="entity"><span>call</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_indices</span></span><span> </span><span class="entity"><span>callers</span></span><span> </span><span class="entity"><span>call</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>incompatible_calls</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>live_call</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>call</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>freeze_fpTs_type_based_default</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map_index</span><span> </span><span>I</span><span> </span><span class="entity"><span>fpTs</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>kk</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>nth</span><span> </span><span class="entity"><span>Xs</span></span><span> </span><span class="entity"><span>kk</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>freeze_fpTs_type_based_default</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>freeze_fpTs_type_based_default</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>freeze_fpTs_mutual_call</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>fpT</span></span><span> </span><span class="entity"><span>calls</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>union</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_indices</span></span><span> </span><span class="entity"><span>callers</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>calls</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fpT</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>nth</span><span> </span><span class="entity"><span>Xs</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>freeze_fpTs_type_based_default</span></span><span> </span><span class="entity"><span>T</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>kk'</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fpT</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>kk'</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="entity"><span>mutual_self_call</span></span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>callers</span></span><span> </span><span class="entity"><span>kk</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="main"><span>(</span></span><span>find_first</span><span> </span><span class="main"><span>(</span></span><span>not</span><span> </span><span>o</span><span> </span><span>null</span><span> </span><span>o</span><span> </span><span class="entity"><span>get_indices</span></span><span> </span><span class="entity"><span>callers</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>calls</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>nth</span><span> </span><span class="entity"><span>fpTs</span></span><span> </span><span class="entity"><span>kk'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span>nth</span><span> </span><span class="entity"><span>Xs</span></span><span> </span><span class="entity"><span>kk'</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="entity"><span>freeze_fpTs_type_based_default</span></span><span> </span><span class="entity"><span>T</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>incompatible_calls</span></span><span> </span><span class="entity"><span>calls</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>freeze_fpTs_map</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fpT</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>callss</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>live_call</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>dead_calls</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>Ts'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="entity"><span>nested_self_call</span></span><span> </span><span class="entity"><span>live_call</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="main"><span>(</span></span><span>List.app</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>check_call_dead</span></span><span> </span><span class="entity"><span>live_call</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>dead_calls</span></span><span class="main"><span>;</span></span><span>
         </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>freeze_fpTs_call</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>fpT</span></span><span class="main"><span>)</span></span><span>
           </span><span class="main"><span>(</span></span><span class="entity"><span>flatten_type_args_of_bnf</span></span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bnf_of</span></span><span> </span><span class="entity"><span>no_defs_lthy</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>transpose</span></span><span> </span><span class="entity"><span>callss</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>freeze_fpTs_call</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>fpT</span></span><span> </span><span class="entity"><span>calls</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>map_partition</span></span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>o</span><span> </span><span class="entity"><span>dest_map</span></span><span> </span><span class="entity"><span>no_defs_lthy</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>calls</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>map_partition</span></span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>o</span><span> </span><span class="entity"><span>dest_abs_or_applied_map_or_pred</span></span><span> </span><span class="entity"><span>no_defs_lthy</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>calls</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>freeze_fpTs_mutual_call</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>fpT</span></span><span> </span><span class="entity"><span>calls</span></span><span> </span><span class="entity"><span>T</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>callsp</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>freeze_fpTs_map</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>fpT</span></span><span> </span><span class="entity"><span>callsp</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>callsp</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>freeze_fpTs_map</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>fpT</span></span><span> </span><span class="entity"><span>callsp</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>freeze_fpTs_call</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctr_Tsss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>binder_types</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctr_Tss</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctrXs_Tsss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 4</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span>o</span><span> </span><span>map2</span><span> </span><span>oo</span><span> </span><span class="entity"><span>freeze_fpTs_call</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>kks</span></span><span> </span><span class="entity"><span>fpTs</span></span><span> </span><span class="entity"><span>callssss</span></span><span> </span><span class="entity"><span>ctr_Tsss</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctrXs_repTs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>mk_sumprodT_balanced</span></span><span> </span><span class="entity"><span>ctrXs_Tsss</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ns</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>length</span><span> </span><span class="entity"><span>ctr_Tsss</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>kss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>upto</span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ns</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>length</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctr_Tsss</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>key_of_fp_eqs</span></span><span> </span><span class="entity"><span>fp</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>fpTs</span></span><span> </span><span class="entity"><span>Xs</span></span><span> </span><span class="entity"><span>ctrXs_repTs</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>n2m_sugar_of</span></span><span> </span><span class="entity"><span>no_defs_lthy</span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>SOME</span><span> </span><span class="entity"><span>n2m_sugar</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n2m_sugar</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>no_defs_lthy</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>base_fp_names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Name.variant_list</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>fp_b_names</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fp_bs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>b_name</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>base_fp_name</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span>Binding.qualify</span><span> </span><span>true</span><span> </span><span class="entity"><span>b_name</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n2mN</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>base_fp_name</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="entity"><span>b_names</span></span><span> </span><span class="entity"><span>base_fp_names</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Us</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fpTs</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>killed_As'</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>bnf_of</span></span><span> </span><span class="entity"><span>no_defs_lthy</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>As'</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>T_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>;</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>deads</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>deads_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>;</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dead_Us</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>U</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>deads</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>U</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ts</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>Us</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>fold</span><span> </span><span>Term.add_tfreesT</span><span> </span><span class="entity"><span>dead_Us</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fp_absT_infos</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>#</span></span><span>absT_info</span><span> </span><span class="entity"><span>fp_sugars0</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>indexed_fp_ress</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>#</span></span><span>fp_res</span><span> </span><span>o</span><span> </span><span>`</span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>fp_res_index</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fp_sugars0</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>pre_bnfs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>absT_infos</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fp_res</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span>xtor_co_recs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>xtor_co_recs0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xtor_co_induct</span></span><span class="main"><span>,</span></span><span>
               </span><span class="entity"><span>dtor_injects</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>dtor_ctors</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xtor_co_rec_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>fixpoint_bnf</span></span><span> </span><span>false</span><span> </span><span>I</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>construct_mutualized_fp</span></span><span> </span><span class="entity"><span>fp</span></span><span> </span><span class="entity"><span>mutual_cliques</span></span><span> </span><span class="entity"><span>fpTs</span></span><span> </span><span class="entity"><span>indexed_fp_ress</span></span><span class="main"><span>)</span></span><span>
            </span><span class="entity"><span>fp_bs</span></span><span> </span><span class="entity"><span>As'</span></span><span> </span><span class="entity"><span>killed_As'</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>dest_TFree</span><span> </span><span class="entity"><span>Xs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctrXs_repTs</span></span><span> </span><span class="entity"><span>empty_comp_cache</span></span><span> </span><span class="entity"><span>no_defs_lthy</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>time</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>time</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>timer</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>time</span></span><span> </span><span class="main"><span>(</span></span><span>Timer.startRealTimer</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fp_abs_inverses</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>#</span></span><span>abs_inverse</span><span> </span><span class="entity"><span>fp_absT_infos</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fp_type_definitions</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>#</span></span><span>type_definition</span><span> </span><span class="entity"><span>fp_absT_infos</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>abss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>#</span></span><span>abs</span><span> </span><span class="entity"><span>absT_infos</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>reps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>#</span></span><span>rep</span><span> </span><span class="entity"><span>absT_infos</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>absTs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>#</span></span><span>absT</span><span> </span><span class="entity"><span>absT_infos</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>repTs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>#</span></span><span>repT</span><span> </span><span class="entity"><span>absT_infos</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>abs_inverses</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>#</span></span><span>abs_inverse</span><span> </span><span class="entity"><span>absT_infos</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fp_nesting_bnfs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nesting_bnfs</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>ctrXs_Tsss</span></span><span> </span><span class="entity"><span>Xs</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>live_nesting_bnfs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nesting_bnfs</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>ctrXs_Tsss</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>xtor_co_recs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>recs_args_types</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>corecs_args_types</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>mk_co_recs_prelims</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>fp</span></span><span> </span><span class="entity"><span>ctr_Tsss</span></span><span> </span><span class="entity"><span>fpTs</span></span><span> </span><span class="entity"><span>Cs</span></span><span> </span><span class="entity"><span>absTs</span></span><span> </span><span class="entity"><span>repTs</span></span><span> </span><span class="entity"><span>ns</span></span><span> </span><span class="entity"><span>mss</span></span><span> </span><span class="entity"><span>xtor_co_recs0</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_binding</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>pre</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Binding.prefix_name</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pre</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"_"</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>co_recs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>co_rec_defs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>fold_map</span></span><span> 2</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>fp</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Least_FP</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>define_rec</span></span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="entity"><span>recs_args_types</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_binding</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fpTs</span></span><span> </span><span class="entity"><span>Cs</span></span><span> </span><span class="entity"><span>reps</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>define_corec</span></span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="entity"><span>corecs_args_types</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_binding</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fpTs</span></span><span> </span><span class="entity"><span>Cs</span></span><span> </span><span class="entity"><span>abss</span></span><span class="main"><span>)</span></span><span>
            </span><span class="entity"><span>fp_bs</span></span><span> </span><span class="entity"><span>xtor_co_recs</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
          </span><span>|&gt;&gt;</span><span> </span><span>split_list</span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>timer</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>time</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>timer</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"High-level "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>co_prefix</span></span><span> </span><span class="entity"><span>fp</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"recursors"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>common_co_inducts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>co_inductss'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>co_rec_thmss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>co_rec_disc_thmss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>co_rec_sel_thmsss</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
             </span><span class="entity"><span>fp_sugar_thms</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>fp</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Least_FP</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="entity"><span>derive_induct_recs_thms_for_types</span></span><span> </span><span class="entity"><span>plugins</span></span><span> </span><span class="entity"><span>pre_bnfs</span></span><span> </span><span class="entity"><span>recs_args_types</span></span><span> </span><span class="entity"><span>xtor_co_induct</span></span><span>
              </span><span class="entity"><span>xtor_co_rec_thms</span></span><span> </span><span class="entity"><span>live_nesting_bnfs</span></span><span> </span><span class="entity"><span>fp_nesting_bnfs</span></span><span> </span><span class="entity"><span>fpTs</span></span><span> </span><span class="entity"><span>Cs</span></span><span> </span><span class="entity"><span>Xs</span></span><span> </span><span class="entity"><span>ctrXs_Tsss</span></span><span>
              </span><span class="entity"><span>fp_abs_inverses</span></span><span> </span><span class="entity"><span>fp_type_definitions</span></span><span> </span><span class="entity"><span>abs_inverses</span></span><span> </span><span class="entity"><span>ctrss</span></span><span> </span><span class="entity"><span>ctr_defss</span></span><span> </span><span class="entity"><span>co_recs</span></span><span> </span><span class="entity"><span>co_rec_defs</span></span><span>
              </span><span class="entity"><span>lthy</span></span><span>
            </span><span>|&gt;</span><span> </span><span>`</span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>inducts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>induct</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rec_thmss</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>induct</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>inducts</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rec_thmss</span></span><span class="main"><span>,</span></span><span> </span><span>replicate</span><span> </span><span class="entity"><span>nn</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span>replicate</span><span> </span><span class="entity"><span>nn</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span>||&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>info</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>info</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span class="entity"><span>derive_coinduct_corecs_thms_for_types</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>pre_bnfs</span></span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="entity"><span>corecs_args_types</span></span><span class="main"><span>)</span></span><span>
              </span><span class="entity"><span>xtor_co_induct</span></span><span> </span><span class="entity"><span>dtor_injects</span></span><span> </span><span class="entity"><span>dtor_ctors</span></span><span> </span><span class="entity"><span>xtor_co_rec_thms</span></span><span> </span><span class="entity"><span>live_nesting_bnfs</span></span><span> </span><span class="entity"><span>fpTs</span></span><span> </span><span class="entity"><span>Cs</span></span><span> </span><span class="entity"><span>Xs</span></span><span>
              </span><span class="entity"><span>ctrXs_Tsss</span></span><span> </span><span class="entity"><span>kss</span></span><span> </span><span class="entity"><span>mss</span></span><span> </span><span class="entity"><span>ns</span></span><span> </span><span class="entity"><span>fp_abs_inverses</span></span><span> </span><span class="entity"><span>abs_inverses</span></span><span>
              </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../BNF_Fixpoint_Base.html#BNF_Fixpoint_Base.vimage2p_refl|fact"><span>vimage2p_refl</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctr_defss</span></span><span> </span><span class="entity"><span>ctr_sugars</span></span><span> </span><span class="entity"><span>co_recs</span></span><span> </span><span class="entity"><span>co_rec_defs</span></span><span>
            </span><span>|&gt;</span><span> </span><span>`</span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>coinduct_thms_pairs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>corec_thmss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>corec_disc_thmss</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span>
                     </span><span class="main"><span>(</span></span><span class="entity"><span>corec_sel_thmsss</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>snd</span><span> </span><span class="entity"><span>coinduct_thms_pairs</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>coinduct_thms_pairs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>corec_thmss</span></span><span class="main"><span>,</span></span><span>
               </span><span class="entity"><span>corec_disc_thmss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>corec_sel_thmsss</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span>||&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>info</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>info</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>timer</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>time</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>timer</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"High-level "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>co_prefix</span></span><span> </span><span class="entity"><span>fp</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"induction principles"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>names_lthy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span>Variable.declare_typ</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>As</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>Cs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>Xs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.export_morphism</span><span> </span><span class="entity"><span>names_lthy</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_target_fp_sugar</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>pre_bnf</span></span><span> </span><span class="entity"><span>absT_info</span></span><span> </span><span class="entity"><span>ctrXs_Tss</span></span><span> </span><span class="entity"><span>ctor_iff_dtor</span></span><span> </span><span class="entity"><span>ctr_defs</span></span><span> </span><span class="entity"><span>ctr_sugar</span></span><span>
            </span><span class="entity"><span>co_rec</span></span><span> </span><span class="entity"><span>co_rec_def</span></span><span> </span><span class="entity"><span>map_thms</span></span><span> </span><span class="entity"><span>co_inducts</span></span><span> </span><span class="entity"><span>co_rec_thms</span></span><span> </span><span class="entity"><span>co_rec_disc_thms</span></span><span> </span><span class="entity"><span>co_rec_sel_thmss</span></span><span>
            </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span>fp_ctr_sugar</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>ctr_transfers</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>case_transfers</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>disc_transfers</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sel_transfers</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span>
              </span><span>fp_bnf_sugar</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>map_disc_iffs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>map_selss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rel_injects</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rel_distincts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rel_sels</span></span><span class="main"><span>,</span></span><span>
                </span><span class="entity"><span>rel_intros</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rel_cases</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pred_injects</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>set_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>set_selssss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>set_introssss</span></span><span class="main"><span>,</span></span><span>
                </span><span class="entity"><span>set_cases</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span>
              </span><span>fp_co_induct_sugar</span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>co_rec_disc_iffs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>co_rec_codes</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>co_rec_transfers</span></span><span class="main"><span>,</span></span><span>
                </span><span class="entity"><span>co_rec_o_maps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>common_rel_co_inducts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rel_co_inducts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>common_set_inducts</span></span><span class="main"><span>,</span></span><span>
                </span><span class="entity"><span>set_inducts</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span>
              </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>fp_sugar</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>{</span></span><span>T</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span>BT</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="comment1"><span>(*wrong but harmless*)</span></span><span class="main"><span>,</span></span><span> </span><span>X</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>,</span></span><span> </span><span>fp</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fp</span></span><span class="main"><span>,</span></span><span> </span><span>fp_res</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fp_res</span></span><span class="main"><span>,</span></span><span> </span><span>fp_res_index</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>kk</span></span><span class="main"><span>,</span></span><span>
           </span><span>pre_bnf</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pre_bnf</span></span><span class="main"><span>,</span></span><span> </span><span>fp_bnf</span><span> </span><span class="main"><span>=</span></span><span> </span><span>nth</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>bnfs</span><span> </span><span class="entity"><span>fp_res</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>kk</span></span><span class="main"><span>,</span></span><span> </span><span>absT_info</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>absT_info</span></span><span class="main"><span>,</span></span><span>
           </span><span>fp_nesting_bnfs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fp_nesting_bnfs</span></span><span class="main"><span>,</span></span><span> </span><span>live_nesting_bnfs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>live_nesting_bnfs</span></span><span class="main"><span>,</span></span><span>
           </span><span>fp_ctr_sugar</span><span> </span><span class="main"><span>=</span></span><span>
             </span><span class="main"><span>{</span></span><span>ctrXs_Tss</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctrXs_Tss</span></span><span class="main"><span>,</span></span><span>
              </span><span>ctor_iff_dtor</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctor_iff_dtor</span></span><span class="main"><span>,</span></span><span>
              </span><span>ctr_defs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctr_defs</span></span><span class="main"><span>,</span></span><span>
              </span><span>ctr_sugar</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctr_sugar</span></span><span class="main"><span>,</span></span><span>
              </span><span>ctr_transfers</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctr_transfers</span></span><span class="main"><span>,</span></span><span>
              </span><span>case_transfers</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>case_transfers</span></span><span class="main"><span>,</span></span><span>
              </span><span>disc_transfers</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>disc_transfers</span></span><span class="main"><span>,</span></span><span>
              </span><span>sel_transfers</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>sel_transfers</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span>
           </span><span>fp_bnf_sugar</span><span> </span><span class="main"><span>=</span></span><span>
             </span><span class="main"><span>{</span></span><span>map_thms</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_thms</span></span><span class="main"><span>,</span></span><span>
              </span><span>map_disc_iffs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_disc_iffs</span></span><span class="main"><span>,</span></span><span>
              </span><span>map_selss</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_selss</span></span><span class="main"><span>,</span></span><span>
              </span><span>rel_injects</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rel_injects</span></span><span class="main"><span>,</span></span><span>
              </span><span>rel_distincts</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rel_distincts</span></span><span class="main"><span>,</span></span><span>
              </span><span>rel_sels</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rel_sels</span></span><span class="main"><span>,</span></span><span>
              </span><span>rel_intros</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rel_intros</span></span><span class="main"><span>,</span></span><span>
              </span><span>rel_cases</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rel_cases</span></span><span class="main"><span>,</span></span><span>
              </span><span>pred_injects</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pred_injects</span></span><span class="main"><span>,</span></span><span>
              </span><span>set_thms</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>set_thms</span></span><span class="main"><span>,</span></span><span>
              </span><span>set_selssss</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>set_selssss</span></span><span class="main"><span>,</span></span><span>
              </span><span>set_introssss</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>set_introssss</span></span><span class="main"><span>,</span></span><span>
              </span><span>set_cases</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>set_cases</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span>
           </span><span>fp_co_induct_sugar</span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span>
             </span><span class="main"><span>{</span></span><span>co_rec</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>co_rec</span></span><span class="main"><span>,</span></span><span>
              </span><span>common_co_inducts</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>common_co_inducts</span></span><span class="main"><span>,</span></span><span>
              </span><span>co_inducts</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>co_inducts</span></span><span class="main"><span>,</span></span><span>
              </span><span>co_rec_def</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>co_rec_def</span></span><span class="main"><span>,</span></span><span>
              </span><span>co_rec_thms</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>co_rec_thms</span></span><span class="main"><span>,</span></span><span>
              </span><span>co_rec_discs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>co_rec_disc_thms</span></span><span class="main"><span>,</span></span><span>
              </span><span>co_rec_disc_iffs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>co_rec_disc_iffs</span></span><span class="main"><span>,</span></span><span>
              </span><span>co_rec_selss</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>co_rec_sel_thmss</span></span><span class="main"><span>,</span></span><span>
              </span><span>co_rec_codes</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>co_rec_codes</span></span><span class="main"><span>,</span></span><span>
              </span><span>co_rec_transfers</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>co_rec_transfers</span></span><span class="main"><span>,</span></span><span>
              </span><span>co_rec_o_maps</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>co_rec_o_maps</span></span><span class="main"><span>,</span></span><span>
              </span><span>common_rel_co_inducts</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>common_rel_co_inducts</span></span><span class="main"><span>,</span></span><span>
              </span><span>rel_co_inducts</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rel_co_inducts</span></span><span class="main"><span>,</span></span><span>
              </span><span>common_set_inducts</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>common_set_inducts</span></span><span class="main"><span>,</span></span><span>
              </span><span>set_inducts</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>set_inducts</span></span><span class="main"><span>}</span></span><span class="main"><span>}</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>morph_fp_sugar</span></span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>target_fp_sugars</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 17</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="entity"><span>mk_target_fp_sugar</span></span><span> </span><span class="entity"><span>fpTs</span></span><span> </span><span class="entity"><span>Xs</span></span><span> </span><span class="entity"><span>kks</span></span><span> </span><span class="entity"><span>pre_bnfs</span></span><span> </span><span class="entity"><span>absT_infos</span></span><span> </span><span class="entity"><span>ctrXs_Tsss</span></span><span> </span><span class="entity"><span>ctor_iff_dtors</span></span><span>
            </span><span class="entity"><span>ctr_defss</span></span><span> </span><span class="entity"><span>ctr_sugars</span></span><span> </span><span class="entity"><span>co_recs</span></span><span> </span><span class="entity"><span>co_rec_defs</span></span><span> </span><span class="entity"><span>mapss</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>transpose</span></span><span> </span><span class="entity"><span>co_inductss'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>co_rec_thmss</span></span><span>
            </span><span class="entity"><span>co_rec_disc_thmss</span></span><span> </span><span class="entity"><span>co_rec_sel_thmsss</span></span><span> </span><span class="entity"><span>fp_sugars0</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>n2m_sugar</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>target_fp_sugars</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fp_sugar_thms</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>n2m_sugar</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>register_n2m_sugar</span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="entity"><span>n2m_sugar</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>indexify_callsss</span></span><span> </span><span class="entity"><span>ctrs</span></span><span> </span><span class="entity"><span>callsss</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>indexify_ctr</span></span><span> </span><span class="entity"><span>ctr</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>AList.lookup</span><span> </span><span>Term.aconv_untyped</span><span> </span><span class="entity"><span>callsss</span></span><span> </span><span class="entity"><span>ctr</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>replicate</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>num_binder_types</span></span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>ctr</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>callss</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Envir.beta_eta_contract</span><span> </span><span>o</span><span> </span><span class="entity"><span>unfold_lets_splits</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>callss</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>map</span><span> </span><span class="entity"><span>indexify_ctr</span></span><span> </span><span class="entity"><span>ctrs</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>retypargs</span></span><span> </span><span class="entity"><span>tyargs</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tyargs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fold_subtype_pairs</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>U</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Us</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>U</span></span><span class="main"><span>)</span></span><span> </span><span>#&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fold_subtype_pairs</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ts</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>Us</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>fold_subtype_pairs</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>TU</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>TU</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>impossible_caller</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>nested_to_mutual_fps</span></span><span> </span><span class="entity"><span>plugins</span></span><span> </span><span class="entity"><span>fp</span></span><span> </span><span class="entity"><span>actual_bs</span></span><span> </span><span class="entity"><span>actual_Ts</span></span><span> </span><span class="entity"><span>actual_callers</span></span><span> </span><span class="entity"><span>actual_callssss0</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>qsoty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>quote</span><span> </span><span>o</span><span> </span><span>Syntax.string_of_typ</span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>qsotys</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>space_implode</span><span> </span><span class="inner_quoted"><span>" or "</span></span><span> </span><span>o</span><span> </span><span>map</span><span> </span><span class="entity"><span>qsoty</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>not_co_datatype0</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>qsoty</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" is not a "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>co_prefix</span></span><span> </span><span class="entity"><span>fp</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"datatype"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>not_co_datatype</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>fp</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Least_FP</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
           </span><span>is_some</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Old_Datatype_Data.get_info</span></span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>qsoty</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" is an old-style datatype"</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="entity"><span>not_co_datatype0</span></span><span> </span><span class="entity"><span>T</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>not_co_datatype</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>not_co_datatype0</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>not_mutually_nested_rec</span></span><span> </span><span class="entity"><span>Ts1</span></span><span> </span><span class="entity"><span>Ts2</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>qsotys</span></span><span> </span><span class="entity"><span>Ts1</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" is neither mutually "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>co_prefix</span></span><span> </span><span class="entity"><span>fp</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"recursive with "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>qsotys</span></span><span> </span><span class="entity"><span>Ts2</span></span><span> </span><span>^</span><span>
        </span><span class="inner_quoted"><span>" nor nested "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>co_prefix</span></span><span> </span><span class="entity"><span>fp</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"recursive through "</span></span><span> </span><span>^</span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>Ts1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Ts2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>length</span><span> </span><span class="entity"><span>Ts1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_quoted"><span>"itself"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>qsotys</span></span><span> </span><span class="entity"><span>Ts2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sorted_actual_Ts</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>sort</span><span> </span><span class="main"><span>(</span></span><span>prod_ord</span><span> </span><span>int_ord</span><span> </span><span>Term_Ord.typ_ord</span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span class="main"><span>(</span></span><span>`</span><span>Term.size_of_typ</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>actual_Ts</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>the_ctrs_of</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_ctr</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>ctrs</span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctr_sugar_of</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gen_rhss_in</span></span><span> </span><span class="entity"><span>gen_Ts</span></span><span> </span><span class="entity"><span>rho</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>subTs</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sub_tyargs</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>maybe_insert</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gen_tyargs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>subTs</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>?</span><span> </span><span>insert</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>gen_tyargs</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>maybe_insert</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>gen_ctrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>maps</span><span> </span><span class="entity"><span>the_ctrs_of</span></span><span> </span><span class="entity"><span>gen_Ts</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>gen_ctr_Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span>binder_types</span><span> </span><span>o</span><span> </span><span>fastype_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>gen_ctrs</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctr_Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Term.typ_subst_atomic</span><span> </span><span class="entity"><span>rho</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>gen_ctr_Ts</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fold_subtype_pairs</span></span><span> </span><span class="entity"><span>maybe_insert</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctr_Ts</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>gen_ctr_Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>typ_subst_nonatomic</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>swap</span><span> </span><span class="entity"><span>rho</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sub_tyargs</span></span><span class="main"><span>]</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>gen_tyargss</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>gen_tyargss</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>the_fp_sugar_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T_name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>fp_sugar_of</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>T_name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fp_sugar</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span>fp</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fp'</span></span><span class="main"><span>,</span></span><span> </span><span>fp_co_induct_sugar</span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>fp</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fp'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>fp_sugar</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>not_co_datatype</span></span><span> </span><span class="entity"><span>T</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>not_co_datatype</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gather_types</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>rev_seens</span></span><span> </span><span class="entity"><span>gen_seen</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="entity"><span>rev_seens</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gen_seen</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>gather_types</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>rho</span></span><span> </span><span class="entity"><span>rev_seens</span></span><span> </span><span class="entity"><span>gen_seen</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tyargs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>{</span></span><span>T</span><span> </span><span class="main"><span>=</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tyargs0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>fp_res</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>Ts</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mutual_Ts0</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>the_fp_sugar_of</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mutual_Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>retypargs</span></span><span> </span><span class="entity"><span>tyargs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>mutual_Ts0</span></span><span class="main"><span>;</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rev_seen</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>flat</span><span> </span><span class="entity"><span>rev_seens</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>null</span><span> </span><span class="entity"><span>rev_seens</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>exists_strict_subtype_in</span></span><span> </span><span class="entity"><span>rev_seen</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>mutual_Ts</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
            </span><span class="entity"><span>not_mutually_nested_rec</span></span><span> </span><span class="entity"><span>mutual_Ts</span></span><span> </span><span class="entity"><span>rev_seen</span></span><span class="main"><span>;</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fresh_tyargs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unsorted_gen_tyargs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="entity"><span>variant_tfrees</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>tyargs</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"z"</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
                </span><span>|&gt;&gt;</span><span> </span><span>map</span><span> </span><span>Logic.varifyT_global</span><span class="main"><span>;</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>gen_tyargs</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>resort_tfree_or_tvar</span></span><span> </span><span>o</span><span> </span><span>snd</span><span> </span><span>o</span><span> </span><span class="entity"><span>dest_TFree_or_TVar</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tyargs0</span></span><span> </span><span class="entity"><span>unsorted_gen_tyargs</span></span><span class="main"><span>;</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rho'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>gen_tyargs</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>tyargs</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>rho</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>rho'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gen_tyargs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gen_seen</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rho'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gen_tyargs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gen_seen'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>exists_subtype_in</span></span><span> </span><span class="main"><span>(</span></span><span>flat</span><span> </span><span class="entity"><span>rev_seens</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>mutual_Ts</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
              </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>gen_rhss_in</span></span><span> </span><span class="entity"><span>gen_seen</span></span><span> </span><span class="entity"><span>rho</span></span><span> </span><span class="entity"><span>mutual_Ts</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>fresh_tyargs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>gen_tyargs</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>gen_tyargss_tl</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>unify_pairs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>split_list</span><span> </span><span class="main"><span>(</span></span><span>maps</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>~~</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>gen_tyargs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>gen_tyargss_tl</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mgu</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Type.raw_unifys</span><span> </span><span class="entity"><span>unify_pairs</span></span><span> </span><span>Vartab.empty</span><span class="main"><span>;</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>gen_tyargs'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Envir.norm_type</span><span> </span><span class="entity"><span>mgu</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>gen_tyargs</span></span><span class="main"><span>;</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>gen_seen'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Envir.norm_type</span><span> </span><span class="entity"><span>mgu</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>gen_seen</span></span><span class="main"><span>;</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                  </span><span class="main"><span>(</span></span><span class="entity"><span>rho</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gen_tyargs'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gen_seen'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
              </span><span class="entity"><span>fresh_tyargs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>gen_mutual_Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>retypargs</span></span><span> </span><span class="entity"><span>gen_tyargs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>mutual_Ts0</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>other_mutual_Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>remove1</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>mutual_Ts</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Ts'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>remove1</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>other_mutual_Ts</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="entity"><span>gather_types</span></span><span> </span><span class="entity"><span>lthy'</span></span><span> </span><span class="entity"><span>rho'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mutual_Ts</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>rev_seens</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>gen_seen'</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>gen_mutual_Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ts'</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>gather_types</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>not_co_datatype</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>perm_Tss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>perm_gen_Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>gather_types</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>sorted_actual_Ts</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>perm_mutual_cliques</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>perm_Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>split_list</span><span> </span><span class="main"><span>(</span></span><span>flat</span><span> </span><span class="main"><span>(</span></span><span>map_index</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>perm_Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>perm_Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>perm_Tss</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>perm_frozen_gen_Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>Logic.unvarifyT_global</span><span> </span><span class="entity"><span>perm_gen_Ts</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>missing_Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>remove1</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>actual_Ts</span></span><span> </span><span class="entity"><span>perm_Ts</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>actual_Ts</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>missing_Ts</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nn</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>kks</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span>upto</span><span> </span><span class="entity"><span>nn</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>callssss0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pad_list</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>nn</span></span><span> </span><span class="entity"><span>actual_callssss0</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>common_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_common_name</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Binding.name_of</span><span> </span><span class="entity"><span>actual_bs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pad_list</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="entity"><span>common_name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>nn</span></span><span> </span><span class="entity"><span>actual_bs</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>callers</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pad_list</span></span><span> </span><span class="entity"><span>impossible_caller</span></span><span> </span><span class="entity"><span>nn</span></span><span> </span><span class="entity"><span>actual_callers</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>permute</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>permute_like</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>perm_Ts</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unpermute</span></span><span> </span><span class="entity"><span>perm_xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>permute_like</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>perm_Ts</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>perm_xs</span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(* The assignment of callers to mutual cliques is incorrect in general. This code would need to
       inspect the actual calls to discover the correct cliques in the presence of type duplicates.
       However, the naive scheme implemented here supports "prim(co)rec" specifications following
       reasonable ordering of the duplicates (e.g., keeping the cliques together). *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>perm_bs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>permute</span></span><span> </span><span class="entity"><span>bs</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>perm_callers</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>permute</span></span><span> </span><span class="entity"><span>callers</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>perm_kks</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>permute</span></span><span> </span><span class="entity"><span>kks</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>perm_callssss0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>permute</span></span><span> </span><span class="entity"><span>callssss0</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>perm_fp_sugars0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span>o</span><span> </span><span class="entity"><span>fp_sugar_of</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span>o</span><span> </span><span>fst</span><span> </span><span>o</span><span> </span><span>dest_Type</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>perm_Ts</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>perm_callssss</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>indexify_callsss</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>ctrs</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>ctr_sugar</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>fp_ctr_sugar</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>perm_fp_sugars0</span></span><span> </span><span class="entity"><span>perm_callssss0</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>perm_fp_sugars</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fp_sugar_thms</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>length</span><span> </span><span class="entity"><span>perm_Tss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>perm_fp_sugars0</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="entity"><span>mutualize_fp_sugars</span></span><span> </span><span class="entity"><span>plugins</span></span><span> </span><span class="entity"><span>fp</span></span><span> </span><span class="entity"><span>perm_mutual_cliques</span></span><span> </span><span class="entity"><span>perm_bs</span></span><span> </span><span class="entity"><span>perm_frozen_gen_Ts</span></span><span> </span><span class="entity"><span>perm_callers</span></span><span>
          </span><span class="entity"><span>perm_callssss</span></span><span> </span><span class="entity"><span>perm_fp_sugars0</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fp_sugars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unpermute</span></span><span> </span><span class="entity"><span>perm_fp_sugars</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>missing_Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>perm_kks</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fp_sugars</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fp_sugar_thms</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
</span></pre>
</body>

</html>