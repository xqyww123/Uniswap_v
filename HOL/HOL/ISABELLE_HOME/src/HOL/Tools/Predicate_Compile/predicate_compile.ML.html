<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Tools/Predicate_Compile/predicate_compile.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Tools/Predicate_Compile/predicate_compile.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      HOL/Tools/Predicate_Compile/predicate_compile.ML
    Author:     Lukas Bulwahn, TU Muenchen

Entry point for the predicate compiler; definition of Toplevel
commands code_pred and values.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>PREDICATE_COMPILE</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> preprocess </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Predicate_Compile_Aux.options</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> intro_hook </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span class="main"><span>)</span></span><span> </span><span>option</span><span> </span><span>Unsynchronized.ref</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Predicate_Compile</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>PREDICATE_COMPILE</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>intro_hook</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span>NONE</span><span> </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span class="main"><span>)</span></span><span> </span><span>option</span><span> </span><span>Unsynchronized.ref</span><span>

</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Predicate_Compile_Aux</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>print_intross</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="entity"><span>intross</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>show_intermediate_results</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span>tracing</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>msg</span></span><span> </span><span>^</span><span>
      </span><span class="main"><span>(</span></span><span>cat_lines</span><span> </span><span class="main"><span>(</span></span><span>map</span><span>
        </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>intros</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"Introduction rule(s) of "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>c</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>":\n"</span></span><span> </span><span>^</span><span>
           </span><span>commas</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Thm.string_of_thm_global</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>intros</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>intross</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>print_specs</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>specs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>show_intermediate_results</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="inner_quoted"><span>"Constant "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>c</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" has specification:\n"</span></span><span> </span><span>^</span><span>
        </span><span class="main"><span>(</span></span><span>cat_lines</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Thm.string_of_thm_global</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"\n"</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>specs</span></span><span>
    </span><span>|&gt;</span><span> </span><span>cat_lines</span><span> </span><span>|&gt;</span><span> </span><span>tracing</span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>overload_const</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the_default</span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>(</span></span><span>Option.map</span><span> </span><span>fst</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Axclass.inst_of_param</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_specs</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>specs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ths</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>ths</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>specs</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>process_specification</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>specs</span></span><span> </span><span class="entity"><span>thy'</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>print_step</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="inner_quoted"><span>"Compiling predicates to flat introrules..."</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>specs</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map</span><span>
        </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>map</span><span>
          </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_equationlike</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>Predicate_Compile_Data.normalize_equation</span></span><span> </span><span class="entity"><span>thy'</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="entity"><span>specs</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>intross1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy''</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>apfst</span><span> </span><span>flat</span><span> </span><span class="main"><span>(</span></span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Predicate_Compile_Pred.preprocess</span></span><span> </span><span class="entity"><span>options</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>specs</span></span><span> </span><span class="entity"><span>thy'</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>print_intross</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>thy''</span></span><span> </span><span class="inner_quoted"><span>"Flattened introduction rules: "</span></span><span> </span><span class="entity"><span>intross1</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>print_step</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="inner_quoted"><span>"Replacing functions in introrules..."</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>intross2</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>function_flattening</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>fail_safe_function_flattening</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_specs</span></span><span> </span><span class="main"><span>(</span></span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Predicate_Compile_Fun.rewrite_intro</span></span><span> </span><span class="entity"><span>thy''</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>intross1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>SOME</span><span> </span><span class="entity"><span>intross</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>intross</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>show_caught_failures</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>tracing</span><span> </span><span class="inner_quoted"><span>"Function replacement failed!"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
             </span><span class="entity"><span>intross1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>map_specs</span></span><span> </span><span class="main"><span>(</span></span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Predicate_Compile_Fun.rewrite_intro</span></span><span> </span><span class="entity"><span>thy''</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>intross1</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="entity"><span>intross1</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>print_intross</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>thy''</span></span><span> </span><span class="inner_quoted"><span>"Introduction rules with replaced functions: "</span></span><span> </span><span class="entity"><span>intross2</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>print_step</span></span><span> </span><span class="entity"><span>options</span></span><span>
      </span><span class="inner_quoted"><span>"Introducing new constants for abstractions at higher-order argument positions..."</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>intross3</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>new_defs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy'''</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>Predicate_Compile_Pred.flat_higher_order_arguments</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>intross2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy''</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>new_intross</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy''''</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span class="entity"><span>new_defs</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="entity"><span>print_step</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="inner_quoted"><span>"Recursively obtaining introduction rules for new definitions..."</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>process_specification</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>new_defs</span></span><span> </span><span class="entity"><span>thy'''</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy'''</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>intross3</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>new_intross</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy''''</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>preprocess_strong_conn_constnames</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>gr</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Core_Data.is_registered</span></span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.init_global</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ts</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>thy</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_specs</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span>Term_Graph.get_node</span><span> </span><span class="entity"><span>gr</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>|&gt;</span><span>
        </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ths</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>ths</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>NONE</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="main"><span>(</span></span><span>dest_Const</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ths</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="entity"><span>ts</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>print_step</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Preprocessing scc of "</span></span><span> </span><span>^</span><span>
        </span><span>commas</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Syntax.string_of_term_global</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prednames</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>funnames</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.partition</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>body_type</span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ts</span></span><span>
      </span><span class="comment1"><span>(* untangle recursion by defining predicates for all functions *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>print_step</span></span><span> </span><span class="entity"><span>options</span></span><span>
        </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Compiling functions ("</span></span><span> </span><span>^</span><span> </span><span>commas</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Syntax.string_of_term_global</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>funnames</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span>
          </span><span class="inner_quoted"><span>") to predicates..."</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fun_pred_specs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>function_flattening</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="main"><span>(</span></span><span>not</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span class="entity"><span>funnames</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>fail_safe_function_flattening</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Predicate_Compile_Fun.define_predicates</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_specs</span></span><span> </span><span class="entity"><span>funnames</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>intross</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>intross</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Predicate_Compile_Fun.define_predicates</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_specs</span></span><span> </span><span class="entity"><span>funnames</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thy</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>print_specs</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>thy1</span></span><span> </span><span class="entity"><span>fun_pred_specs</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>specs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_specs</span></span><span> </span><span class="entity"><span>prednames</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>fun_pred_specs</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>intross3</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>process_specification</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>specs</span></span><span> </span><span class="entity"><span>thy1</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>print_intross</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>thy2</span></span><span> </span><span class="inner_quoted"><span>"Introduction rules with new constants: "</span></span><span> </span><span class="entity"><span>intross3</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>intross4</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_specs</span></span><span> </span><span class="main"><span>(</span></span><span>maps</span><span> </span><span class="entity"><span>remove_pointless_clauses</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>intross3</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>print_intross</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>thy2</span></span><span> </span><span class="inner_quoted"><span>"After removing pointless clauses: "</span></span><span> </span><span class="entity"><span>intross4</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>intross5</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_specs</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>remove_equalities</span></span><span> </span><span class="entity"><span>thy2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>intross4</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>print_intross</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>thy2</span></span><span> </span><span class="inner_quoted"><span>"After removing equality premises:"</span></span><span> </span><span class="entity"><span>intross5</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>intross6</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ths</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>overload_const</span></span><span> </span><span class="entity"><span>thy2</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Axclass.overload</span></span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.init_global</span><span> </span><span class="entity"><span>thy2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ths</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="entity"><span>intross5</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>intross7</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_specs</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>expand_tuples</span></span><span> </span><span class="entity"><span>thy2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>intross6</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>intross8</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_specs</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eta_contract_ho_arguments</span></span><span> </span><span class="entity"><span>thy2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>intross7</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>!</span><span class="entity"><span>intro_hook</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_specs</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>thy2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>intross8</span></span><span class="main"><span>;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>print_step</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Looking for specialisations in "</span></span><span> </span><span>^</span><span> </span><span>commas</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>intross8</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"..."</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>intross9</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy3</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>specialise</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="entity"><span>Predicate_Compile_Specialisation.find_specialisations</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>intross8</span></span><span> </span><span class="entity"><span>thy2</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>intross8</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy2</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>print_intross</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>thy3</span></span><span> </span><span class="inner_quoted"><span>"introduction rules after specialisations: "</span></span><span> </span><span class="entity"><span>intross9</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>intross10</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_specs</span></span><span> </span><span class="main"><span>(</span></span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>peephole_optimisation</span></span><span> </span><span class="entity"><span>thy3</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>intross9</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>print_intross</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>thy3</span></span><span> </span><span class="inner_quoted"><span>"introduction rules before registering: "</span></span><span> </span><span class="entity"><span>intross10</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>print_step</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="inner_quoted"><span>"Registering introduction rules..."</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy4</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>Core_Data.register_intros</span></span><span> </span><span class="entity"><span>intross10</span></span><span> </span><span class="entity"><span>thy3</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>thy4</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>preprocess</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>print_step</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="inner_quoted"><span>"Fetching definitions from theory..."</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>gr</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>cond_timeit</span><span> </span><span class="main"><span>(</span></span><span>Config.get_global</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>Quickcheck.timing</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"preprocess-obtain graph"</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="entity"><span>Predicate_Compile_Data.obtain_specification_graph</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>t</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>gr</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Term_Graph.restrict</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Term_Graph.all_succs</span><span> </span><span class="entity"><span>gr</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>gr</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>cond_timeit</span><span> </span><span class="main"><span>(</span></span><span>Config.get_global</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>Quickcheck.timing</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"preprocess-process"</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>preprocess_strong_conn_constnames</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>gr</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>(</span></span><span>Term_Graph.strong_conn</span><span> </span><span class="entity"><span>gr</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>proposed_modes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Multiple_Preds</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span>string * </span><span class="main"><span>(</span></span><span>mode * string option</span><span class="main"><span>)</span></span><span> list</span><span class="main"><span>)</span></span><span> list
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Single_Pred</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span>mode * string option</span><span class="main"><span>)</span></span><span> list

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>extract_options</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>expected_modes</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>proposed_modes</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>compilation</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>raw_options</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>const</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>chk</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_options</span></span><span> </span><span class="entity"><span>s</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>proposed_modes</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>proposed_modes</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="entity"><span>Single_Pred</span></span><span> </span><span class="entity"><span>proposed_modes</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>const</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>proposed_modes</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Multiple_Preds</span></span><span> </span><span class="entity"><span>proposed_modes</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Code.read_const</span></span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>proposed_modes</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>Options</span></span><span> </span><span class="main"><span>{</span></span><span>
      </span><span>expected_modes</span><span> </span><span class="main"><span>=</span></span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span class="entity"><span>const</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>expected_modes</span></span><span class="main"><span>,</span></span><span>
      </span><span>proposed_modes</span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>proposed_modes</span></span><span class="main"><span>,</span></span><span>
      </span><span>proposed_names</span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>predname</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ms</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>map_filter</span><span>
          </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>predname</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ms</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>proposed_modes</span></span><span class="main"><span>,</span></span><span>
      </span><span>show_steps</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>chk</span></span><span> </span><span class="inner_quoted"><span>"show_steps"</span></span><span class="main"><span>,</span></span><span>
      </span><span>show_intermediate_results</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>chk</span></span><span> </span><span class="inner_quoted"><span>"show_intermediate_results"</span></span><span class="main"><span>,</span></span><span>
      </span><span>show_proof_trace</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>chk</span></span><span> </span><span class="inner_quoted"><span>"show_proof_trace"</span></span><span class="main"><span>,</span></span><span>
      </span><span>show_modes</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>chk</span></span><span> </span><span class="inner_quoted"><span>"show_modes"</span></span><span class="main"><span>,</span></span><span>
      </span><span>show_mode_inference</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>chk</span></span><span> </span><span class="inner_quoted"><span>"show_mode_inference"</span></span><span class="main"><span>,</span></span><span>
      </span><span>show_compilation</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>chk</span></span><span> </span><span class="inner_quoted"><span>"show_compilation"</span></span><span class="main"><span>,</span></span><span>
      </span><span>show_caught_failures</span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span>
      </span><span>show_invalid_clauses</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>chk</span></span><span> </span><span class="inner_quoted"><span>"show_invalid_clauses"</span></span><span class="main"><span>,</span></span><span>
      </span><span>skip_proof</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>chk</span></span><span> </span><span class="inner_quoted"><span>"skip_proof"</span></span><span class="main"><span>,</span></span><span>
      </span><span>function_flattening</span><span> </span><span class="main"><span>=</span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>chk</span></span><span> </span><span class="inner_quoted"><span>"no_function_flattening"</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
      </span><span>specialise</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>chk</span></span><span> </span><span class="inner_quoted"><span>"specialise"</span></span><span class="main"><span>,</span></span><span>
      </span><span>fail_safe_function_flattening</span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span>
      </span><span>no_topmost_reordering</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>chk</span></span><span> </span><span class="inner_quoted"><span>"no_topmost_reordering"</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
      </span><span>no_higher_order_predicate</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
      </span><span>inductify</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>chk</span></span><span> </span><span class="inner_quoted"><span>"inductify"</span></span><span class="main"><span>,</span></span><span>
      </span><span>detect_switches</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>chk</span></span><span> </span><span class="inner_quoted"><span>"detect_switches"</span></span><span class="main"><span>,</span></span><span>
      </span><span>smart_depth_limiting</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>chk</span></span><span> </span><span class="inner_quoted"><span>"smart_depth_limiting"</span></span><span class="main"><span>,</span></span><span>
      </span><span>compilation</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>compilation</span></span><span>
    </span><span class="main"><span>}</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>code_pred_cmd</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>expected_modes</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>proposed_modes</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>raw_options</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>raw_const</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
     </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>lthy</span></span><span>
     </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>const</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Code.read_const</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>raw_const</span></span><span>
     </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Sign.the_const_type</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>const</span></span><span>
     </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>const</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
     </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>extract_options</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>expected_modes</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>proposed_modes</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>raw_options</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>const</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_inductify</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lthy'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Local_Theory.background_theory</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>preprocess</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>const</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Predicate_Compile_Fun.pred_of_function</span></span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>const</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>SOME</span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>c</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>const</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>print_step</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="inner_quoted"><span>"Starting Predicate Compile Core..."</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>Predicate_Compile_Core.code_pred</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>const</span></span><span> </span><span class="entity"><span>lthy'</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Predicate_Compile_Core.code_pred_cmd</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>raw_const</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(* Parser for mode annotations *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parse_mode_basic_expr</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"i"</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="entity"><span>Input</span></span><span> </span><span>||</span><span> </span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"o"</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="entity"><span>Output</span></span><span> </span><span>||</span><span>
    </span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"bool"</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="entity"><span>Bool</span></span><span> </span><span>||</span><span> </span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"("</span></span><span> </span><span>|--</span><span> </span><span class="entity"><span>parse_mode_expr</span></span><span> </span><span>--|</span><span> </span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>")"</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xs</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>parse_mode_tuple_expr</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>parse_mode_basic_expr</span></span><span> </span><span>--|</span><span> </span><span class="main"><span>(</span></span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"*"</span></span><span> </span><span>||</span><span> </span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"×"</span></span><span class="main"><span>)</span></span><span> </span><span>--</span><span> </span><span class="entity"><span>parse_mode_tuple_expr</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="entity"><span>Pair</span></span><span> </span><span>||</span><span>
    </span><span class="entity"><span>parse_mode_basic_expr</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xs</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>parse_mode_expr</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>parse_mode_tuple_expr</span></span><span> </span><span>--|</span><span> </span><span class="main"><span>(</span></span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"=&gt;"</span></span><span> </span><span>||</span><span> </span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"⇒"</span></span><span class="main"><span>)</span></span><span> </span><span>--</span><span> </span><span class="entity"><span>parse_mode_expr</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="entity"><span>Fun</span></span><span> </span><span>||</span><span>
    </span><span class="entity"><span>parse_mode_tuple_expr</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xs</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mode_and_opt_proposal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parse_mode_expr</span></span><span> </span><span>--</span><span>
  </span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"as"</span></span><span> </span><span>|--</span><span> </span><span>Parse.name</span><span> </span><span>&gt;&gt;</span><span> </span><span>SOME</span><span class="main"><span>)</span></span><span> </span><span>NONE</span><span>


</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>opt_modes</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>(</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"modes"</span></span><span> </span><span>|--</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>:</span></span><span>›</span></span></span><span> </span><span>|--</span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Parse.enum1</span><span> </span><span class="inner_quoted"><span>"and"</span></span><span> </span><span class="main"><span>(</span></span><span>Parse.name</span><span> </span><span>--|</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>:</span></span><span>›</span></span></span><span> </span><span>--</span><span>
        </span><span class="main"><span>(</span></span><span>Parse.enum</span><span> </span><span class="inner_quoted"><span>","</span></span><span> </span><span class="entity"><span>mode_and_opt_proposal</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="entity"><span>Multiple_Preds</span></span><span class="main"><span>)</span></span><span>
      </span><span>||</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Parse.enum</span><span> </span><span class="inner_quoted"><span>","</span></span><span> </span><span class="entity"><span>mode_and_opt_proposal</span></span><span class="main"><span>)</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="entity"><span>Single_Pred</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span>--|</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>)</span></span><span>›</span></span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Multiple_Preds</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>opt_expected_modes</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>(</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"expected_modes"</span></span><span> </span><span>|--</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>:</span></span><span>›</span></span></span><span> </span><span>|--</span><span>
    </span><span>Parse.enum</span><span> </span><span class="inner_quoted"><span>","</span></span><span> </span><span class="entity"><span>parse_mode_expr</span></span><span> </span><span>--|</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>)</span></span><span>›</span></span></span><span> </span><span>&gt;&gt;</span><span> </span><span>SOME</span><span class="main"><span>)</span></span><span> </span><span>NONE</span><span>


</span><span class="comment1"><span>(* Parser for options *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>scan_options</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>scan_bool_option</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>foldl1</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>||</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Args.$$$</span><span> </span><span class="entity"><span>bool_options</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>scan_compilation</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>foldl1</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>||</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Args.$$$</span><span> </span><span class="entity"><span>s</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>compilation_names</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>[</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Scan.optional</span><span> </span><span class="entity"><span>scan_compilation</span></span><span> </span><span class="entity"><span>Pred</span></span><span>
      </span><span>--</span><span> </span><span>Parse.enum</span><span> </span><span class="inner_quoted"><span>","</span></span><span> </span><span class="entity"><span>scan_bool_option</span></span><span> </span><span>--|</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>]</span></span><span>›</span></span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>Pred</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>opt_print_modes</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>(</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Parse.!!!</span><span> </span><span class="main"><span>(</span></span><span>Scan.repeat1</span><span> </span><span>Parse.name</span><span> </span><span>--|</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>)</span></span><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>opt_mode</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"_"</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span>||</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>parse_mode_expr</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>SOME</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>opt_param_modes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>[</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"mode"</span></span><span> </span><span>|--</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>:</span></span><span>›</span></span></span><span> </span><span>|--</span><span>
  </span><span>Parse.enum</span><span> </span><span class="inner_quoted"><span>", "</span></span><span> </span><span class="entity"><span>opt_mode</span></span><span> </span><span>--|</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>]</span></span><span>›</span></span></span><span> </span><span>&gt;&gt;</span><span> </span><span>SOME</span><span class="main"><span>)</span></span><span> </span><span>NONE</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>stats</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"stats"</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span>false</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>value_options</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>expected_values</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"expected"</span></span><span> </span><span>|--</span><span> </span><span>Parse.term</span><span> </span><span>&gt;&gt;</span><span> </span><span>SOME</span><span class="main"><span>)</span></span><span> </span><span>NONE</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>scan_compilation</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Scan.optional</span><span>
        </span><span class="main"><span>(</span></span><span>foldl1</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>||</span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Args.$$$</span><span> </span><span class="entity"><span>s</span></span><span> </span><span>--</span><span> </span><span>Parse.enum</span><span> </span><span class="inner_quoted"><span>","</span></span><span> </span><span>Parse.int</span><span> </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ps</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ps</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="entity"><span>compilation_names</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>Pred</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>Scan.optional</span><span>
      </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>[</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>expected_values</span></span><span> </span><span>--</span><span> </span><span class="entity"><span>stats</span></span><span class="main"><span>)</span></span><span> </span><span>--</span><span> </span><span class="entity"><span>scan_compilation</span></span><span> </span><span>--|</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>]</span></span><span>›</span></span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Pred</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(* code_pred command and values command *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Outer_Syntax.local_theory_to_proof</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword1"><span>code_pred</span></span><span>›</span></span></span><span>
    </span><span class="inner_quoted"><span>"prove equations for predicate specified by intro/elim rules"</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>opt_expected_modes</span></span><span> </span><span>--</span><span> </span><span class="entity"><span>opt_modes</span></span><span> </span><span>--</span><span> </span><span class="entity"><span>scan_options</span></span><span> </span><span>--</span><span> </span><span>Parse.term</span><span> </span><span>&gt;&gt;</span><span> </span><span class="entity"><span>code_pred_cmd</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Outer_Syntax.command</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword1"><span>values</span></span><span>›</span></span></span><span>
    </span><span class="inner_quoted"><span>"enumerate and print comprehensions"</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>opt_print_modes</span></span><span> </span><span>--</span><span> </span><span class="entity"><span>opt_param_modes</span></span><span> </span><span>--</span><span> </span><span class="entity"><span>value_options</span></span><span> </span><span>--</span><span> </span><span>Scan.optional</span><span> </span><span>Parse.nat</span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span>--</span><span> </span><span>Parse.term</span><span>
      </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>print_modes</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>param_modes</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>options</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Toplevel.keep</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>Predicate_Compile_Core.values_cmd</span></span><span> </span><span class="entity"><span>print_modes</span></span><span> </span><span class="entity"><span>param_modes</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span></pre>
</body>

</html>