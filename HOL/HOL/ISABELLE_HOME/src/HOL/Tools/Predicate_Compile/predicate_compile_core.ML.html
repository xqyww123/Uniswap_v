<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Tools/Predicate_Compile/predicate_compile_core.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Tools/Predicate_Compile/predicate_compile_core.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      HOL/Tools/Predicate_Compile/predicate_compile_core.ML
    Author:     Lukas Bulwahn, TU Muenchen

A compiler from predicates specified by intro/elim rules to equations.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>PREDICATE_COMPILE_CORE</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>seed</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Random_Engine.seed</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Predicate_Compile_Aux.mode</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Predicate_Compile_Aux.options</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>compilation</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Predicate_Compile_Aux.compilation</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>compilation_funs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Predicate_Compile_Aux.compilation_funs</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> code_pred </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.state</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> code_pred_cmd </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.state</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> values_cmd </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span>option</span><span> </span><span>list</span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string</span><span> </span><span>option</span><span> * </span><span>bool</span><span class="main"><span>)</span></span><span> * </span><span class="main"><span>(</span></span><span class="entity"><span>compilation</span></span><span> * </span><span>int</span><span> </span><span>list</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Toplevel.state</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> values_timeout </span><span class="main"><span>:</span></span><span> </span><span>real</span><span> </span><span>Config.T</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> print_stored_rules </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> print_all_modes </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>compilation</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> put_pred_result </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>unit</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="entity"><span>Predicate.pred</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> put_pred_random_result </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>unit</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>seed</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="entity"><span>Predicate.pred</span></span><span> * </span><span class="entity"><span>seed</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> put_dseq_result </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>unit</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="entity"><span>Limited_Sequence.dseq</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> put_dseq_random_result </span><span class="main"><span>:</span></span><span>
    </span><span class="main"><span>(</span></span><span>unit</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Code_Numeral.natural</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Code_Numeral.natural</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>seed</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
      </span><span>term</span><span> </span><span class="entity"><span>Limited_Sequence.dseq</span></span><span> * </span><span class="entity"><span>seed</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> put_new_dseq_result </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>unit</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Code_Numeral.natural</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="entity"><span>Lazy_Sequence.lazy_sequence</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> put_lseq_random_result </span><span class="main"><span>:</span></span><span>
    </span><span class="main"><span>(</span></span><span>unit</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Code_Numeral.natural</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Code_Numeral.natural</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>seed</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Code_Numeral.natural</span><span> </span><span class="main"><span>-&gt;</span></span><span>
      </span><span>term</span><span> </span><span class="entity"><span>Lazy_Sequence.lazy_sequence</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> put_lseq_random_stats_result </span><span class="main"><span>:</span></span><span>
    </span><span class="main"><span>(</span></span><span>unit</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Code_Numeral.natural</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Code_Numeral.natural</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>seed</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Code_Numeral.natural</span><span> </span><span class="main"><span>-&gt;</span></span><span>
      </span><span class="main"><span>(</span></span><span>term</span><span> * </span><span>Code_Numeral.natural</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Lazy_Sequence.lazy_sequence</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> code_pred_intro_attrib </span><span class="main"><span>:</span></span><span> </span><span>attribute</span><span>
  </span><span class="comment1"><span>(* used by Quickcheck_Generator *)</span></span><span>
  </span><span class="comment1"><span>(* temporary for testing of the compilation *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_equations </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_depth_limited_random_equations </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_random_dseq_equations </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_new_random_dseq_equations </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_generator_dseq_equations </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_generator_cps_equations </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_tracing </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> prepare_intrs </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span>string</span><span> </span><span>list</span><span> * </span><span>string</span><span> </span><span>list</span><span> * </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span class="entity"><span>mode</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> *
      </span><span class="main"><span>(</span></span><span>string</span><span> *  </span><span class="main"><span>(</span></span><span>Term.term</span><span> </span><span>list</span><span> * </span><span class="entity"><span>Predicate_Compile_Aux.indprem</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>mode_analysis_options</span></span><span> </span><span class="main"><span>=</span></span><span>
   </span><span class="main"><span>{</span></span><span>use_generators</span><span> </span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>,</span></span><span>
    </span><span>reorder_premises</span><span> </span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>,</span></span><span>
    </span><span>infer_pos_and_neg_modes</span><span> </span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>}</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>mode_derivation</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Mode_App</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> mode_derivation * mode_derivation </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Context</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> mode
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Mode_Pair</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> mode_derivation * mode_derivation </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Term</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> mode
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> head_mode_of </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>mode_derivation</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>mode</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>moded_clause</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>term</span><span> </span><span>list</span><span> * </span><span class="main"><span>(</span></span><span class="entity"><span>Predicate_Compile_Aux.indprem</span></span><span> * </span><span class="entity"><span>mode_derivation</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span>'a</span><span> </span><span class="entity"><span>pred_mode_table</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>bool</span><span> * </span><span class="entity"><span>mode</span></span><span class="main"><span>)</span></span><span> * </span><span>'a</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Predicate_Compile_Core</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>PREDICATE_COMPILE_CORE</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>random_seed</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Random_Engine.seed</span></span><span>

</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Predicate_Compile_Aux</span><span class="main"><span>;</span></span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Mode_Inference</span><span class="main"><span>;</span></span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Predicate_Compile_Proof</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>seed</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Random_Engine.seed</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(** fundamentals **)</span></span><span>

</span><span class="comment1"><span>(* syntactic operations *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_eqs</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk_eqs</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span>::</span><span class="entity"><span>cs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="entity"><span>HOLogic.mk_eq</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>mk_eqs</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="entity"><span>cs</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>mk_eqs</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_tracing</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Code_Evaluation.html#Code_Evaluation.tracing|const"><span>Code_Evaluation.tracing</span></a><span>›</span></span><span class="main"><span>,</span></span><span>
    </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../String.html#String.literal|type"><span>String.literal</span></a><span>›</span></span></span><span> </span><span>--&gt;</span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span>--&gt;</span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_literal</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span>


</span><span class="comment1"><span>(* representation of inferred clauses with modes *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>moded_clause</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>term</span><span> </span><span>list</span><span> * </span><span class="main"><span>(</span></span><span class="entity"><span>indprem</span></span><span> * </span><span class="entity"><span>mode_derivation</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span>'a</span><span> </span><span class="entity"><span>pred_mode_table</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>bool</span><span> * </span><span class="entity"><span>mode</span></span><span class="main"><span>)</span></span><span> * </span><span>'a</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span>


</span><span class="comment1"><span>(* diagnostic display functions *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>print_modes</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>modes</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>show_modes</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span>tracing</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Inferred modes:\n"</span></span><span> </span><span>^</span><span>
      </span><span>cat_lines</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ms</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>": "</span></span><span> </span><span>^</span><span> </span><span>commas</span><span> </span><span class="main"><span>(</span></span><span>map</span><span>
        </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>string_of_mode</span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span>^</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_quoted"><span>"pos"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_quoted"><span>"neg"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>modes</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>print_pred_mode_table</span></span><span> </span><span class="entity"><span>string_of_entry</span></span><span> </span><span class="entity"><span>pred_mode_table</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>print_mode</span></span><span> </span><span class="entity"><span>pred</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mode</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>entry</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>  </span><span class="inner_quoted"><span>"mode : "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>string_of_mode</span></span><span> </span><span class="entity"><span>mode</span></span><span>
      </span><span>^</span><span> </span><span class="entity"><span>string_of_entry</span></span><span> </span><span class="entity"><span>pred</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="entity"><span>entry</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>print_pred</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pred</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>modes</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="inner_quoted"><span>"predicate "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>pred</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>": "</span></span><span> </span><span>^</span><span> </span><span>cat_lines</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>print_mode</span></span><span> </span><span class="entity"><span>pred</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>modes</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>tracing</span><span> </span><span class="main"><span>(</span></span><span>cat_lines</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>print_pred</span></span><span> </span><span class="entity"><span>pred_mode_table</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>print_compiled_terms</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>show_compilation</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="entity"><span>print_pred_mode_table</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Syntax.string_of_term</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>print_stored_rules</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>preds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Graph.keys</span><span> </span><span class="main"><span>(</span></span><span>Core_Data.PredData.get</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>print</span></span><span> </span><span class="entity"><span>pred</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>writeln</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"predicate: "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>pred</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>writeln</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"introrules: "</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>writeln</span><span> </span><span class="main"><span>(</span></span><span>Thm.string_of_thm</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Core_Data.intros_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>pred</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>Core_Data.has_elim</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>pred</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span>writeln</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"elimrule: "</span></span><span> </span><span>^</span><span> </span><span>Thm.string_of_thm</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Core_Data.the_elim_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>pred</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span>writeln</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"no elimrule defined"</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>fold</span><span> </span><span class="entity"><span>print</span></span><span> </span><span class="entity"><span>preds</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>print_all_modes</span></span><span> </span><span class="entity"><span>compilation</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>writeln</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Inferred modes:"</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>print</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pred</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>modes</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>writeln</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"predicate: "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>pred</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>writeln</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"modes: "</span></span><span> </span><span>^</span><span> </span><span class="main"><span>(</span></span><span>commas</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>string_of_mode</span></span><span> </span><span class="entity"><span>modes</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>fold</span><span> </span><span class="entity"><span>print</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Core_Data.all_modes_of</span></span><span> </span><span class="entity"><span>compilation</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(* validity checks *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_expected_modes</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>modes</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>expected_modes</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ms</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>modes</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>SOME</span><span> </span><span class="entity"><span>modes</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>modes'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>snd</span><span> </span><span class="entity"><span>modes</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>eq_set</span><span> </span><span class="entity"><span>eq_mode</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>modes'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
              </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"expected modes were not inferred:\n"</span></span><span>
              </span><span>^</span><span> </span><span class="inner_quoted"><span>"  inferred modes for "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>s</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>": "</span></span><span> </span><span>^</span><span> </span><span>commas</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>string_of_mode</span></span><span> </span><span class="entity"><span>modes'</span></span><span class="main"><span>)</span></span><span>  </span><span>^</span><span> </span><span class="inner_quoted"><span>"\n"</span></span><span>
              </span><span>^</span><span> </span><span class="inner_quoted"><span>"  expected modes for "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>s</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>": "</span></span><span> </span><span>^</span><span> </span><span>commas</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>string_of_mode</span></span><span> </span><span class="entity"><span>ms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_proposed_modes</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>preds</span></span><span> </span><span class="entity"><span>modes</span></span><span> </span><span class="entity"><span>errors</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>proposed_modes</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>SOME</span><span> </span><span class="entity"><span>ms</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>modes</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span>SOME</span><span> </span><span class="entity"><span>inferred_ms</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>preds_without_modes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>fst</span><span> </span><span class="main"><span>(</span></span><span>filter</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>modes</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>modes'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>snd</span><span> </span><span class="entity"><span>inferred_ms</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>eq_set</span><span> </span><span class="entity"><span>eq_mode</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>modes'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"expected modes were not inferred:\n"</span></span><span>
                </span><span>^</span><span> </span><span class="inner_quoted"><span>"  inferred modes for "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>s</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>": "</span></span><span> </span><span>^</span><span> </span><span>commas</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>string_of_mode</span></span><span> </span><span class="entity"><span>modes'</span></span><span class="main"><span>)</span></span><span>  </span><span>^</span><span> </span><span class="inner_quoted"><span>"\n"</span></span><span>
                </span><span>^</span><span> </span><span class="inner_quoted"><span>"  expected modes for "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>s</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>": "</span></span><span> </span><span>^</span><span> </span><span>commas</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>string_of_mode</span></span><span> </span><span class="entity"><span>ms</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"\n"</span></span><span>
                </span><span>^</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>show_invalid_clauses</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"For the following clauses, the following modes could not be inferred: "</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"\n"</span></span><span>
                </span><span>^</span><span> </span><span>cat_lines</span><span> </span><span class="entity"><span>errors</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span>
                </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span class="entity"><span>preds_without_modes</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                  </span><span class="inner_quoted"><span>"\n"</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"No mode inferred for the predicates "</span></span><span> </span><span>^</span><span> </span><span>commas</span><span> </span><span class="entity"><span>preds_without_modes</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>preds</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_matches_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>predname</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>ms</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Fun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"fun"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span class="entity"><span>T2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>check</span></span><span> </span><span class="entity"><span>m1</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>check</span></span><span> </span><span class="entity"><span>m2</span></span><span> </span><span class="entity"><span>T2</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>check</span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"fun"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Input</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Output</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>check</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Pair</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.prod|type"><span>Product_Type.prod</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>check</span></span><span> </span><span class="entity"><span>m1</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>check</span></span><span> </span><span class="entity"><span>m2</span></span><span> </span><span class="entity"><span>T2</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>check</span></span><span> </span><span class="entity"><span>Input</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>check</span></span><span> </span><span class="entity"><span>Output</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>check</span></span><span> </span><span class="entity"><span>Bool</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>check</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_consistent_modes</span></span><span> </span><span class="entity"><span>ms</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>Fun</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ms</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span>apply2</span><span> </span><span class="entity"><span>check_consistent_modes</span></span><span> </span><span class="main"><span>(</span></span><span>split_list</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>Fun</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>res1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>res2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>res1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>res2</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>Input</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Output</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Pair</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ms</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span>true</span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>Bool</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ms</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span>true</span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span>false</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>length</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>strip_fun_mode</span></span><span> </span><span class="entity"><span>mode</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="main"><span>(</span></span><span>binder_types</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="main"><span>(</span></span><span>forall</span><span> </span><span class="main"><span>(</span></span><span>uncurry</span><span> </span><span class="entity"><span>check</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>strip_fun_mode</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span>~~</span><span> </span><span>binder_types</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>string_of_mode</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" is not a valid mode for "</span></span><span> </span><span>^</span><span>
            </span><span>Syntax.string_of_typ</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" at predicate "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>predname</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ms</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>check_consistent_modes</span></span><span> </span><span class="entity"><span>ms</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span>error</span><span> </span><span class="main"><span>(</span></span><span>commas</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>string_of_mode</span></span><span> </span><span class="entity"><span>ms</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" are inconsistent modes for predicate "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>predname</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>ms</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(* compilation modifiers *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Comp_Mod</span></span><span> </span><span class="main"><span>=</span></span><span>  </span><span class="comment1"><span>(* FIXME proper signature *)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>comp_modifiers</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Comp_Modifiers</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
</span><span class="main"><span>{</span></span><span>
  compilation </span><span class="main"><span>:</span></span><span> compilation</span><span class="main"><span>,</span></span><span>
  function_name_prefix </span><span class="main"><span>:</span></span><span> string</span><span class="main"><span>,</span></span><span>
  compfuns </span><span class="main"><span>:</span></span><span> compilation_funs</span><span class="main"><span>,</span></span><span>
  mk_random </span><span class="main"><span>:</span></span><span> typ </span><span class="main"><span>-&gt;</span></span><span> term list </span><span class="main"><span>-&gt;</span></span><span> term</span><span class="main"><span>,</span></span><span>
  modify_funT </span><span class="main"><span>:</span></span><span> typ </span><span class="main"><span>-&gt;</span></span><span> typ</span><span class="main"><span>,</span></span><span>
  additional_arguments </span><span class="main"><span>:</span></span><span> string list </span><span class="main"><span>-&gt;</span></span><span> term list</span><span class="main"><span>,</span></span><span>
  wrap_compilation </span><span class="main"><span>:</span></span><span> compilation_funs </span><span class="main"><span>-&gt;</span></span><span> string </span><span class="main"><span>-&gt;</span></span><span> typ </span><span class="main"><span>-&gt;</span></span><span> mode </span><span class="main"><span>-&gt;</span></span><span> term list </span><span class="main"><span>-&gt;</span></span><span> term </span><span class="main"><span>-&gt;</span></span><span> term</span><span class="main"><span>,</span></span><span>
  transform_additional_arguments </span><span class="main"><span>:</span></span><span> indprem </span><span class="main"><span>-&gt;</span></span><span> term list </span><span class="main"><span>-&gt;</span></span><span> term list
</span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_comp_modifiers</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Comp_Modifiers</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>c</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>compilation</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>compilation</span><span> </span><span>o</span><span> </span><span class="entity"><span>dest_comp_modifiers</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>function_name_prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>function_name_prefix</span><span> </span><span>o</span><span> </span><span class="entity"><span>dest_comp_modifiers</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>compfuns</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>compfuns</span><span> </span><span>o</span><span> </span><span class="entity"><span>dest_comp_modifiers</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mk_random</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>mk_random</span><span> </span><span>o</span><span> </span><span class="entity"><span>dest_comp_modifiers</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>funT_of'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>funT_of</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>compfuns</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>modify_funT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>modify_funT</span><span> </span><span>o</span><span> </span><span class="entity"><span>dest_comp_modifiers</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>funT_of</span></span><span> </span><span class="entity"><span>comp</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>modify_funT</span></span><span> </span><span class="entity"><span>comp</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>funT_of'</span></span><span> </span><span class="entity"><span>comp</span></span><span> </span><span class="entity"><span>mode</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>additional_arguments</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>additional_arguments</span><span> </span><span>o</span><span> </span><span class="entity"><span>dest_comp_modifiers</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>wrap_compilation</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>wrap_compilation</span><span> </span><span>o</span><span> </span><span class="entity"><span>dest_comp_modifiers</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>transform_additional_arguments</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>transform_additional_arguments</span><span> </span><span>o</span><span> </span><span class="entity"><span>dest_comp_modifiers</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>set_compfuns</span></span><span> </span><span class="entity"><span>compfuns'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Comp_Modifiers</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>compilation</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>function_name_prefix</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>compfuns</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_random</span></span><span class="main"><span>,</span></span><span>
    </span><span class="entity"><span>modify_funT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>additional_arguments</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>wrap_compilation</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>transform_additional_arguments</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>Comp_Modifiers</span></span><span> </span><span class="main"><span>{</span></span><span>compilation</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>compilation</span></span><span class="main"><span>,</span></span><span> </span><span>function_name_prefix</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>function_name_prefix</span></span><span class="main"><span>,</span></span><span>
    </span><span>compfuns</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>compfuns'</span></span><span class="main"><span>,</span></span><span> </span><span>mk_random</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_random</span></span><span class="main"><span>,</span></span><span> </span><span>modify_funT</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>modify_funT</span></span><span class="main"><span>,</span></span><span>
    </span><span>additional_arguments</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>additional_arguments</span></span><span class="main"><span>,</span></span><span> </span><span>wrap_compilation</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>wrap_compilation</span></span><span class="main"><span>,</span></span><span>
    </span><span>transform_additional_arguments</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>transform_additional_arguments</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unlimited_compfuns_of</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>New_Pos_Random_DSeq</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>New_Pos_Random_Sequence_CompFuns.depth_unlimited_compfuns</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>unlimited_compfuns_of</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>New_Pos_Random_DSeq</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>New_Neg_Random_Sequence_CompFuns.depth_unlimited_compfuns</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>unlimited_compfuns_of</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>Pos_Generator_DSeq</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>New_Pos_DSequence_CompFuns.depth_unlimited_compfuns</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>unlimited_compfuns_of</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>Pos_Generator_DSeq</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>New_Neg_DSequence_CompFuns.depth_unlimited_compfuns</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>unlimited_compfuns_of</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"No unlimited compfuns for compilation "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>string_of_compilation</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>limited_compfuns_of</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>Predicate_Compile_Aux.New_Pos_Random_DSeq</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>New_Pos_Random_Sequence_CompFuns.depth_limited_compfuns</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>limited_compfuns_of</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>Predicate_Compile_Aux.New_Pos_Random_DSeq</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>New_Neg_Random_Sequence_CompFuns.depth_limited_compfuns</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>limited_compfuns_of</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>Pos_Generator_DSeq</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>New_Pos_DSequence_CompFuns.depth_limited_compfuns</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>limited_compfuns_of</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>Pos_Generator_DSeq</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>New_Neg_DSequence_CompFuns.depth_limited_compfuns</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>limited_compfuns_of</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"No limited compfuns for compilation "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>string_of_compilation</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>depth_limited_comp_modifiers</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Comp_Mod.Comp_Modifiers</span></span><span>
  </span><span class="main"><span>{</span></span><span>
  </span><span>compilation</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Depth_Limited</span></span><span class="main"><span>,</span></span><span>
  </span><span>function_name_prefix</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"depth_limited_"</span></span><span class="main"><span>,</span></span><span>
  </span><span>compfuns</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Predicate_Comp_Funs.compfuns</span></span><span class="main"><span>,</span></span><span>
  </span><span>mk_random</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"no random generation"</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span>additional_arguments</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>depth_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Name.variant_list</span><span> </span><span class="entity"><span>names</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"depth"</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>[</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>depth_name</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Code_Numeral.html#Code_Numeral.natural|type"><span>natural</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>,</span></span><span>
  </span><span>modify_funT</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>U</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>strip_type</span><span> </span><span class="entity"><span>T</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Ts'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Code_Numeral.html#Code_Numeral.natural|type"><span>natural</span></a><span>›</span></span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ts</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>Ts'</span></span><span class="main"><span>)</span></span><span> </span><span>---&gt;</span><span> </span><span class="entity"><span>U</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span>wrap_compilation</span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>compfuns</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>additional_arguments</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>compilation</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>depth</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>additional_arguments</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>split_modeT</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>(</span></span><span>binder_types</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_monadT</span></span><span> </span><span class="entity"><span>compfuns</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_tupleT</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>if_const</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.If|const"><span>If</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T'</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T'</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>if_const</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>HOLogic.mk_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>depth</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><span class="main"><a class="entity_ref" href="../../../../../Groups.html#Groups.zero_class.zero|const"><span>0</span></a></span><span> </span><span class="main"><span>::</span></span><span> </span><a class="entity_ref" href="../../../../../Code_Numeral.html#Code_Numeral.natural|type"><span>natural</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span>
        </span><span>$</span><span> </span><span class="entity"><span>mk_empty</span></span><span> </span><span class="entity"><span>compfuns</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest_monadT</span></span><span> </span><span class="entity"><span>compfuns</span></span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>)</span></span><span>
        </span><span>$</span><span> </span><span class="entity"><span>compilation</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>,</span></span><span>
  </span><span>transform_additional_arguments</span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>additional_arguments</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>depth</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>additional_arguments</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>depth'</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Groups.html#Groups.minus_class.minus|const"><span>Groups.minus</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Code_Numeral.html#Code_Numeral.natural|type"><span>natural</span></a><span> </span><span class="main"><span>=&gt;</span></span><span> </span><a class="entity_ref" href="../../../../../Code_Numeral.html#Code_Numeral.natural|type"><span>natural</span></a><span> </span><span class="main"><span>=&gt;</span></span><span> </span><a class="entity_ref" href="../../../../../Code_Numeral.html#Code_Numeral.natural|type"><span>natural</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span>
          </span><span>$</span><span> </span><span class="entity"><span>depth</span></span><span> </span><span>$</span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Groups.html#Groups.one_class.one|const"><span>Groups.one</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Code_Numeral.html#Code_Numeral.natural|type"><span>natural</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>depth'</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>random_comp_modifiers</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Comp_Mod.Comp_Modifiers</span></span><span>
  </span><span class="main"><span>{</span></span><span>
  </span><span>compilation</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Random</span></span><span class="main"><span>,</span></span><span>
  </span><span>function_name_prefix</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"random_"</span></span><span class="main"><span>,</span></span><span>
  </span><span>compfuns</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Predicate_Comp_Funs.compfuns</span></span><span class="main"><span>,</span></span><span>
  </span><span>mk_random</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>additional_arguments</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
  </span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Random_Pred.html#Random_Pred.iter|const"><span>Random_Pred.iter</span></a><span>›</span></span><span class="main"><span>,</span></span><span>
  </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Code_Numeral.html#Code_Numeral.natural|type"><span>natural</span></a><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Code_Numeral.html#Code_Numeral.natural|type"><span>natural</span></a><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Random.html#Random.seed|type"><span>Random.seed</span></a><span>›</span></span></span><span class="main"><span>]</span></span><span> </span><span>---&gt;</span><span>
    </span><span class="entity"><span>Predicate_Comp_Funs.mk_monadT</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>additional_arguments</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span>modify_funT</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>U</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>strip_type</span><span> </span><span class="entity"><span>T</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Ts'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Code_Numeral.html#Code_Numeral.natural|type"><span>natural</span></a><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Code_Numeral.html#Code_Numeral.natural|type"><span>natural</span></a><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Random.html#Random.seed|type"><span>Random.seed</span></a><span>›</span></span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ts</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>Ts'</span></span><span class="main"><span>)</span></span><span> </span><span>---&gt;</span><span> </span><span class="entity"><span>U</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span>additional_arguments</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>nrandom</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>size</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>seed</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Name.variant_list</span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"nrandom"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"size"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"seed"</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="main"><span>[</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nrandom</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Code_Numeral.html#Code_Numeral.natural|type"><span>natural</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>size</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Code_Numeral.html#Code_Numeral.natural|type"><span>natural</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>seed</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Random.html#Random.seed|type"><span>Random.seed</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span>wrap_compilation</span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>I</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>compilation_funs</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span>transform_additional_arguments</span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span>I</span><span> </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>indprem</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>depth_limited_random_comp_modifiers</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Comp_Mod.Comp_Modifiers</span></span><span>
  </span><span class="main"><span>{</span></span><span>
  </span><span>compilation</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Depth_Limited_Random</span></span><span class="main"><span>,</span></span><span>
  </span><span>function_name_prefix</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"depth_limited_random_"</span></span><span class="main"><span>,</span></span><span>
  </span><span>compfuns</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Predicate_Comp_Funs.compfuns</span></span><span class="main"><span>,</span></span><span>
  </span><span>mk_random</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>additional_arguments</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
  </span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Random_Pred.html#Random_Pred.iter|const"><span>Random_Pred.iter</span></a><span>›</span></span><span class="main"><span>,</span></span><span>
  </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Code_Numeral.html#Code_Numeral.natural|type"><span>natural</span></a><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Code_Numeral.html#Code_Numeral.natural|type"><span>natural</span></a><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Random.html#Random.seed|type"><span>Random.seed</span></a><span>›</span></span></span><span class="main"><span>]</span></span><span> </span><span>---&gt;</span><span>
    </span><span class="entity"><span>Predicate_Comp_Funs.mk_monadT</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>tl</span><span> </span><span class="entity"><span>additional_arguments</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span>modify_funT</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>U</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>strip_type</span><span> </span><span class="entity"><span>T</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Ts'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Code_Numeral.html#Code_Numeral.natural|type"><span>natural</span></a><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Code_Numeral.html#Code_Numeral.natural|type"><span>natural</span></a><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Code_Numeral.html#Code_Numeral.natural|type"><span>natural</span></a><span>›</span></span></span><span class="main"><span>,</span></span><span>
        </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Random.html#Random.seed|type"><span>Random.seed</span></a><span>›</span></span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ts</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>Ts'</span></span><span class="main"><span>)</span></span><span> </span><span>---&gt;</span><span> </span><span class="entity"><span>U</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span>additional_arguments</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>depth</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nrandom</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>size</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>seed</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Name.variant_list</span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"depth"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"nrandom"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"size"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"seed"</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="main"><span>[</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>depth</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Code_Numeral.html#Code_Numeral.natural|type"><span>natural</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nrandom</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Code_Numeral.html#Code_Numeral.natural|type"><span>natural</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>size</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Code_Numeral.html#Code_Numeral.natural|type"><span>natural</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>seed</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Random.html#Random.seed|type"><span>Random.seed</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span>wrap_compilation</span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>compfuns</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>additional_arguments</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>compilation</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>depth</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>hd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>additional_arguments</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>split_map_modeT</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>funT_of</span></span><span> </span><span class="entity"><span>compfuns</span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>(</span></span><span>binder_types</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_monadT</span></span><span> </span><span class="entity"><span>compfuns</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_tupleT</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>if_const</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.If|const"><span>If</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T'</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T'</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>if_const</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>HOLogic.mk_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>depth</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><span class="main"><a class="entity_ref" href="../../../../../Groups.html#Groups.zero_class.zero|const"><span>0</span></a></span><span> </span><span class="main"><span>::</span></span><span> </span><a class="entity_ref" href="../../../../../Code_Numeral.html#Code_Numeral.natural|type"><span>natural</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span>
        </span><span>$</span><span> </span><span class="entity"><span>mk_empty</span></span><span> </span><span class="entity"><span>compfuns</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest_monadT</span></span><span> </span><span class="entity"><span>compfuns</span></span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>)</span></span><span>
        </span><span>$</span><span> </span><span class="entity"><span>compilation</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>,</span></span><span>
  </span><span>transform_additional_arguments</span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>additional_arguments</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>depth</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nrandom</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>size</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>seed</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>additional_arguments</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>depth'</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Groups.html#Groups.minus_class.minus|const"><span>Groups.minus</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Code_Numeral.html#Code_Numeral.natural|type"><span>natural</span></a><span> </span><span class="main"><span>=&gt;</span></span><span> </span><a class="entity_ref" href="../../../../../Code_Numeral.html#Code_Numeral.natural|type"><span>natural</span></a><span> </span><span class="main"><span>=&gt;</span></span><span> </span><a class="entity_ref" href="../../../../../Code_Numeral.html#Code_Numeral.natural|type"><span>natural</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span>
          </span><span>$</span><span> </span><span class="entity"><span>depth</span></span><span> </span><span>$</span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Groups.html#Groups.one_class.one|const"><span>Groups.one</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Code_Numeral.html#Code_Numeral.natural|type"><span>natural</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>depth'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nrandom</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>size</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>seed</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>predicate_comp_modifiers</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Comp_Mod.Comp_Modifiers</span></span><span>
  </span><span class="main"><span>{</span></span><span>
  </span><span>compilation</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Pred</span></span><span class="main"><span>,</span></span><span>
  </span><span>function_name_prefix</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span>
  </span><span>compfuns</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Predicate_Comp_Funs.compfuns</span></span><span class="main"><span>,</span></span><span>
  </span><span>mk_random</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"no random generation"</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span>modify_funT</span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span class="main"><span>,</span></span><span>
  </span><span>additional_arguments</span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
  </span><span>wrap_compilation</span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>I</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>compilation_funs</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span>transform_additional_arguments</span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span>I</span><span> </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>indprem</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dseq_comp_modifiers</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Comp_Mod.Comp_Modifiers</span></span><span>
  </span><span class="main"><span>{</span></span><span>
  </span><span>compilation</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>DSeq</span></span><span class="main"><span>,</span></span><span>
  </span><span>function_name_prefix</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"dseq_"</span></span><span class="main"><span>,</span></span><span>
  </span><span>compfuns</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>DSequence_CompFuns.compfuns</span></span><span class="main"><span>,</span></span><span>
  </span><span>mk_random</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"no random generation in dseq"</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span>modify_funT</span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span class="main"><span>,</span></span><span>
  </span><span>additional_arguments</span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
  </span><span>wrap_compilation</span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>I</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>compilation_funs</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span>transform_additional_arguments</span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span>I</span><span> </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>indprem</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pos_random_dseq_comp_modifiers</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Comp_Mod.Comp_Modifiers</span></span><span>
  </span><span class="main"><span>{</span></span><span>
  </span><span>compilation</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Pos_Random_DSeq</span></span><span class="main"><span>,</span></span><span>
  </span><span>function_name_prefix</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"random_dseq_"</span></span><span class="main"><span>,</span></span><span>
  </span><span>compfuns</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Random_Sequence_CompFuns.compfuns</span></span><span class="main"><span>,</span></span><span>
  </span><span>mk_random</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>random</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Quickcheck_Random.html#Quickcheck_Random.random_class.random|const"><span>Quickcheck_Random.random</span></a><span>›</span></span><span class="main"><span>,</span></span><span>
      </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Code_Numeral.html#Code_Numeral.natural|type"><span>natural</span></a><span>›</span></span></span><span> </span><span>--&gt;</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Random.html#Random.seed|type"><span>Random.seed</span></a><span>›</span></span></span><span> </span><span>--&gt;</span><span>
        </span><span class="entity"><span>HOLogic.mk_prodT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_prodT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.unit|type"><span>unit</span></a><span> </span><span class="main"><span>=&gt;</span></span><span> </span><a class="entity_ref" href="../../../../../Code_Evaluation.html#Code_Evaluation.term|type"><span>term</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Random.html#Random.seed|type"><span>Random.seed</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Random_Sequence.html#Random_Sequence.Random|const"><span>Random_Sequence.Random</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Code_Numeral.html#Code_Numeral.natural|type"><span>natural</span></a><span>›</span></span></span><span> </span><span>--&gt;</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Random.html#Random.seed|type"><span>Random.seed</span></a><span>›</span></span></span><span> </span><span>--&gt;</span><span>
      </span><span class="entity"><span>HOLogic.mk_prodT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_prodT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.unit|type"><span>unit</span></a><span> </span><span class="main"><span>=&gt;</span></span><span> </span><a class="entity_ref" href="../../../../../Code_Evaluation.html#Code_Evaluation.term|type"><span>term</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Random.html#Random.seed|type"><span>Random.seed</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>--&gt;</span><span>
      </span><span class="entity"><span>Random_Sequence_CompFuns.mk_random_dseqT</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>random</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>

  </span><span>modify_funT</span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span class="main"><span>,</span></span><span>
  </span><span>additional_arguments</span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
  </span><span>wrap_compilation</span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>I</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>compilation_funs</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span>transform_additional_arguments</span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span>I</span><span> </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>indprem</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>neg_random_dseq_comp_modifiers</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Comp_Mod.Comp_Modifiers</span></span><span>
  </span><span class="main"><span>{</span></span><span>
  </span><span>compilation</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Neg_Random_DSeq</span></span><span class="main"><span>,</span></span><span>
  </span><span>function_name_prefix</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"random_dseq_neg_"</span></span><span class="main"><span>,</span></span><span>
  </span><span>compfuns</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Random_Sequence_CompFuns.compfuns</span></span><span class="main"><span>,</span></span><span>
  </span><span>mk_random</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"no random generation"</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span>modify_funT</span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span class="main"><span>,</span></span><span>
  </span><span>additional_arguments</span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
  </span><span>wrap_compilation</span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>I</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>compilation_funs</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span>transform_additional_arguments</span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span>I</span><span> </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>indprem</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>}</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>new_pos_random_dseq_comp_modifiers</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Comp_Mod.Comp_Modifiers</span></span><span>
  </span><span class="main"><span>{</span></span><span>
  </span><span>compilation</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>New_Pos_Random_DSeq</span></span><span class="main"><span>,</span></span><span>
  </span><span>function_name_prefix</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"new_random_dseq_"</span></span><span class="main"><span>,</span></span><span>
  </span><span>compfuns</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>New_Pos_Random_Sequence_CompFuns.depth_limited_compfuns</span></span><span class="main"><span>,</span></span><span>
  </span><span>mk_random</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>random</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Quickcheck_Random.html#Quickcheck_Random.random_class.random|const"><span>Quickcheck_Random.random</span></a><span>›</span></span><span class="main"><span>,</span></span><span>
      </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Code_Numeral.html#Code_Numeral.natural|type"><span>natural</span></a><span>›</span></span></span><span> </span><span>--&gt;</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Random.html#Random.seed|type"><span>Random.seed</span></a><span>›</span></span></span><span> </span><span>--&gt;</span><span>
        </span><span class="entity"><span>HOLogic.mk_prodT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_prodT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.unit|type"><span>unit</span></a><span> </span><span class="main"><span>=&gt;</span></span><span> </span><a class="entity_ref" href="../../../../../Code_Evaluation.html#Code_Evaluation.term|type"><span>term</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Random.html#Random.seed|type"><span>Random.seed</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Random_Sequence.html#Random_Sequence.pos_Random|const"><span>Random_Sequence.pos_Random</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Code_Numeral.html#Code_Numeral.natural|type"><span>natural</span></a><span>›</span></span></span><span> </span><span>--&gt;</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Random.html#Random.seed|type"><span>Random.seed</span></a><span>›</span></span></span><span> </span><span>--&gt;</span><span>
      </span><span class="entity"><span>HOLogic.mk_prodT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_prodT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.unit|type"><span>unit</span></a><span> </span><span class="main"><span>=&gt;</span></span><span> </span><a class="entity_ref" href="../../../../../Code_Evaluation.html#Code_Evaluation.term|type"><span>term</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Random.html#Random.seed|type"><span>Random.seed</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>--&gt;</span><span>
      </span><span class="entity"><span>New_Pos_Random_Sequence_CompFuns.mk_pos_random_dseqT</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>random</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span>modify_funT</span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span class="main"><span>,</span></span><span>
  </span><span>additional_arguments</span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
  </span><span>wrap_compilation</span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>I</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>compilation_funs</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span>transform_additional_arguments</span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span>I</span><span> </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>indprem</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>new_neg_random_dseq_comp_modifiers</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Comp_Mod.Comp_Modifiers</span></span><span>
  </span><span class="main"><span>{</span></span><span>
  </span><span>compilation</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>New_Neg_Random_DSeq</span></span><span class="main"><span>,</span></span><span>
  </span><span>function_name_prefix</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"new_random_dseq_neg_"</span></span><span class="main"><span>,</span></span><span>
  </span><span>compfuns</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>New_Neg_Random_Sequence_CompFuns.depth_limited_compfuns</span></span><span class="main"><span>,</span></span><span>
  </span><span>mk_random</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"no random generation"</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span>modify_funT</span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span class="main"><span>,</span></span><span>
  </span><span>additional_arguments</span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
  </span><span>wrap_compilation</span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>I</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>compilation_funs</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span>transform_additional_arguments</span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span>I</span><span> </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>indprem</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pos_generator_dseq_comp_modifiers</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Comp_Mod.Comp_Modifiers</span></span><span>
  </span><span class="main"><span>{</span></span><span>
  </span><span>compilation</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Pos_Generator_DSeq</span></span><span class="main"><span>,</span></span><span>
  </span><span>function_name_prefix</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"generator_dseq_"</span></span><span class="main"><span>,</span></span><span>
  </span><span>compfuns</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>New_Pos_DSequence_CompFuns.depth_limited_compfuns</span></span><span class="main"><span>,</span></span><span>
  </span><span>mk_random</span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Lazy_Sequence.html#Lazy_Sequence.small_lazy_class.small_lazy|const"><span>Lazy_Sequence.small_lazy_class.small_lazy</span></a><span>›</span></span><span class="main"><span>,</span></span><span>
        </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Code_Numeral.html#Code_Numeral.natural|type"><span>natural</span></a><span>›</span></span></span><span> </span><span>--&gt;</span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Lazy_Sequence.html#Lazy_Sequence.lazy_sequence|type"><span>Lazy_Sequence.lazy_sequence</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span>modify_funT</span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span class="main"><span>,</span></span><span>
  </span><span>additional_arguments</span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
  </span><span>wrap_compilation</span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>I</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>compilation_funs</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span>transform_additional_arguments</span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span>I</span><span> </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>indprem</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>neg_generator_dseq_comp_modifiers</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Comp_Mod.Comp_Modifiers</span></span><span>
  </span><span class="main"><span>{</span></span><span>
  </span><span>compilation</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Neg_Generator_DSeq</span></span><span class="main"><span>,</span></span><span>
  </span><span>function_name_prefix</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"generator_dseq_neg_"</span></span><span class="main"><span>,</span></span><span>
  </span><span>compfuns</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>New_Neg_DSequence_CompFuns.depth_limited_compfuns</span></span><span class="main"><span>,</span></span><span>
  </span><span>mk_random</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"no random generation"</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span>modify_funT</span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span class="main"><span>,</span></span><span>
  </span><span>additional_arguments</span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
  </span><span>wrap_compilation</span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>I</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>compilation_funs</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span>transform_additional_arguments</span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span>I</span><span> </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>indprem</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pos_generator_cps_comp_modifiers</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Comp_Mod.Comp_Modifiers</span></span><span>
  </span><span class="main"><span>{</span></span><span>
  </span><span>compilation</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Pos_Generator_CPS</span></span><span class="main"><span>,</span></span><span>
  </span><span>function_name_prefix</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"generator_cps_pos_"</span></span><span class="main"><span>,</span></span><span>
  </span><span>compfuns</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Pos_Bounded_CPS_Comp_Funs.compfuns</span></span><span class="main"><span>,</span></span><span>
  </span><span>mk_random</span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
       </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Quickcheck_Exhaustive.html#Quickcheck_Exhaustive.exhaustive_class.exhaustive|const"><span>Quickcheck_Exhaustive.exhaustive</span></a><span>›</span></span><span class="main"><span>,</span></span><span>
       </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span>--&gt;</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><span class="main"><span>(</span></span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span> </span><span class="main"><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.prod|type"><span>*</span></a></span><span> </span><a class="entity_ref" href="../../../../../Code_Evaluation.html#Code_Evaluation.term|type"><span>term</span></a><span> </span><a class="entity_ref" href="../../../../../List.html#List.list|type"><span>list</span></a><span class="main"><span>)</span></span><span> </span><a class="entity_ref" href="../../../../../Option.html#Option.option|type"><span>option</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span> </span><span>--&gt;</span><span>
         </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Code_Numeral.html#Code_Numeral.natural|type"><span>natural</span></a><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span> </span><span class="main"><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.prod|type"><span>*</span></a></span><span> </span><a class="entity_ref" href="../../../../../Code_Evaluation.html#Code_Evaluation.term|type"><span>term</span></a><span> </span><a class="entity_ref" href="../../../../../List.html#List.list|type"><span>list</span></a><span class="main"><span>)</span></span><span> </span><a class="entity_ref" href="../../../../../Option.html#Option.option|type"><span>option</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span>modify_funT</span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span class="main"><span>,</span></span><span>
  </span><span>additional_arguments</span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
  </span><span>wrap_compilation</span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>I</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>compilation_funs</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span>transform_additional_arguments</span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span>I</span><span> </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>indprem</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>neg_generator_cps_comp_modifiers</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Comp_Mod.Comp_Modifiers</span></span><span>
  </span><span class="main"><span>{</span></span><span>
  </span><span>compilation</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Neg_Generator_CPS</span></span><span class="main"><span>,</span></span><span>
  </span><span>function_name_prefix</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"generator_cps_neg_"</span></span><span class="main"><span>,</span></span><span>
  </span><span>compfuns</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Neg_Bounded_CPS_Comp_Funs.compfuns</span></span><span class="main"><span>,</span></span><span>
  </span><span>mk_random</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"No enumerators"</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span>modify_funT</span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span class="main"><span>,</span></span><span>
  </span><span>additional_arguments</span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
  </span><span>wrap_compilation</span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>I</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>compilation_funs</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span>transform_additional_arguments</span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span>I</span><span> </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>indprem</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>negative_comp_modifiers_of</span></span><span> </span><span class="entity"><span>comp_modifiers</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Comp_Mod.compilation</span></span><span> </span><span class="entity"><span>comp_modifiers</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="entity"><span>Pos_Random_DSeq</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>neg_random_dseq_comp_modifiers</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Neg_Random_DSeq</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>pos_random_dseq_comp_modifiers</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>New_Pos_Random_DSeq</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>new_neg_random_dseq_comp_modifiers</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>New_Neg_Random_DSeq</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>new_pos_random_dseq_comp_modifiers</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Pos_Generator_DSeq</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>neg_generator_dseq_comp_modifiers</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Neg_Generator_DSeq</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>pos_generator_dseq_comp_modifiers</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Pos_Generator_CPS</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>neg_generator_cps_comp_modifiers</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Neg_Generator_CPS</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>pos_generator_cps_comp_modifiers</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>comp_modifiers</span></span><span class="main"><span>)</span></span><span>


</span><span class="comment1"><span>(* term construction *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_v</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>names</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>names</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>vs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>s'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Name.variant_list</span><span> </span><span class="entity"><span>names</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s'</span></span><span>::</span><span class="entity"><span>names</span></span><span class="main"><span>,</span></span><span> </span><span>AList.update</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>v</span></span><span>::</span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>distinct_v</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>nvs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_v</span></span><span> </span><span class="entity"><span>nvs</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>T</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>distinct_v</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>nvs</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nvs'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>distinct_v</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>nvs</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nvs''</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>distinct_v</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="entity"><span>nvs'</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t'</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nvs''</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>distinct_v</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="entity"><span>nvs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nvs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(** specific rpred functions -- move them to the correct place in this file *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_Eval_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>P</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_bounds</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.prod|type"><span>Product_Type.prod</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bs2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_bounds</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="entity"><span>i</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bs1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i''</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_bounds</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>i'</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.pair_const</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>bs1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>bs2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i''</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk_bounds</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Bound</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_prod</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.pair_const</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>HOLogic.mk_prodT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_tuple</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.unit</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>HOLogic.unitT</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk_tuple</span></span><span> </span><span class="entity"><span>tTs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>foldr1</span><span> </span><span class="entity"><span>mk_prod</span></span><span> </span><span class="entity"><span>tTs</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_split_abs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.prod|type"><span>Product_Type.prod</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>absdummy</span><span> </span><span class="entity"><span>T</span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.case_prod_const</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_split_abs</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_split_abs</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk_split_abs</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>absdummy</span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>t</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>rev</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="main"><span>(</span></span><span>fold_map</span><span> </span><span class="entity"><span>mk_bounds</span></span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="main"><span>(</span></span><span>binder_types</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inargs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>outargs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>split_mode</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="entity"><span>args</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>outTs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>split_map_modeT</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>(</span></span><span>binder_types</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inner_term</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Predicate_Comp_Funs.mk_Eval</span></span><span> </span><span class="main"><span>(</span></span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>P</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>inargs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>fst</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_tuple</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>outargs</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>outTs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>fold_rev</span><span> </span><span class="entity"><span>mk_split_abs</span></span><span> </span><span class="main"><span>(</span></span><span>binder_types</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>inner_term</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>compile_arg</span></span><span> </span><span class="entity"><span>compilation_modifiers</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>param_modes</span></span><span> </span><span class="entity"><span>arg</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_params</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>param_modes</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span>SOME</span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Comp_Mod.funT_of</span></span><span> </span><span class="entity"><span>compilation_modifiers</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="entity"><span>T</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                  </span><span class="entity"><span>mk_Eval_of</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>mode</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>map_params</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>map_aterms</span><span> </span><span class="entity"><span>map_params</span></span><span> </span><span class="entity"><span>arg</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>compile_match</span></span><span> </span><span class="entity"><span>compilation_modifiers</span></span><span> </span><span class="entity"><span>additional_arguments</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>param_modes</span></span><span>
      </span><span class="entity"><span>eqs</span></span><span> </span><span class="entity"><span>eqs'</span></span><span> </span><span class="entity"><span>out_ts</span></span><span> </span><span class="entity"><span>success_t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>compfuns</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Comp_Mod.compfuns</span></span><span> </span><span class="entity"><span>compilation_modifiers</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eqs''</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>maps</span><span> </span><span class="entity"><span>mk_eq</span></span><span> </span><span class="entity"><span>eqs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>eqs'</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eqs''</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>compile_arg</span></span><span> </span><span class="entity"><span>compilation_modifiers</span></span><span> </span><span class="entity"><span>additional_arguments</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>param_modes</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eqs''</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span>Term.add_free_names</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>success_t</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>eqs''</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>out_ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Name.variant_list</span><span> </span><span class="entity"><span>names</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"x"</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Name.variant_list</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>names</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"y"</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.mk_tupleT</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>out_ts</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>U</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>success_t</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>U'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_monadT</span></span><span> </span><span class="entity"><span>compfuns</span></span><span> </span><span class="entity"><span>U</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>v'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>lambda</span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Case_Translation.make_case</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>Case_Translation.Quiet</span></span><span> </span><span>Name.context</span><span> </span><span class="entity"><span>v</span></span><span>
      </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_tuple</span></span><span> </span><span class="entity"><span>out_ts</span></span><span class="main"><span>,</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>eqs''</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>success_t</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.If|const"><span>HOL.If</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>HOLogic.boolT</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>U</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>U</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>U</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span>
          </span><span>foldr1</span><span> </span><span class="entity"><span>HOLogic.mk_conj</span></span><span> </span><span class="entity"><span>eqs''</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>success_t</span></span><span> </span><span>$</span><span>
            </span><span class="entity"><span>mk_empty</span></span><span> </span><span class="entity"><span>compfuns</span></span><span> </span><span class="entity"><span>U'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
       </span><span class="main"><span>(</span></span><span class="entity"><span>v'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_empty</span></span><span> </span><span class="entity"><span>compfuns</span></span><span> </span><span class="entity"><span>U'</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>compile_expr</span></span><span> </span><span class="entity"><span>compilation_modifiers</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>deriv</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>param_modes</span></span><span> </span><span class="entity"><span>additional_arguments</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>compfuns</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Comp_Mod.compfuns</span></span><span> </span><span class="entity"><span>compilation_modifiers</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>expr_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>deriv</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>deriv</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Term</span></span><span> </span><span class="entity"><span>Input</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>compile_arg</span></span><span> </span><span class="entity"><span>compilation_modifiers</span></span><span> </span><span class="entity"><span>additional_arguments</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>param_modes</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Term</span></span><span> </span><span class="entity"><span>Output</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Context</span></span><span> </span><span class="entity"><span>mode</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Core_Data.alternative_compilation_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>SOME</span><span> </span><span class="entity"><span>alt_comp</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>alt_comp</span></span><span> </span><span class="entity"><span>compfuns</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Core_Data.function_name_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Comp_Mod.compilation</span></span><span> </span><span class="entity"><span>compilation_modifiers</span></span><span class="main"><span>)</span></span><span>
              </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span>
              </span><span class="entity"><span>Comp_Mod.funT_of</span></span><span> </span><span class="entity"><span>compilation_modifiers</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Context</span></span><span> </span><span class="entity"><span>m</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>param_modes</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>SOME</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Comp_Mod.funT_of</span></span><span> </span><span class="entity"><span>compilation_modifiers</span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span class="inner_quoted"><span>"x"</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>binder_types</span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>Bound</span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span> </span><span>upto</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>bs</span></span><span class="main"><span>)</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>fold_rev</span><span> </span><span>Term.abs</span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_if</span></span><span> </span><span class="entity"><span>compfuns</span></span><span> </span><span class="main"><span>(</span></span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bounds</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Context</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span class="inner_quoted"><span>"x"</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>binder_types</span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>Bound</span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span> </span><span>upto</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>bs</span></span><span class="main"><span>)</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>fold_rev</span><span> </span><span>Term.abs</span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_if</span></span><span> </span><span class="entity"><span>compfuns</span></span><span> </span><span class="main"><span>(</span></span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bounds</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.Pair|const"><span>Pair</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Mode_Pair</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>d1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>d2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>expr_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>d1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>expr_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>d2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>t</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>t</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_prod</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Mode_App</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>deriv1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>deriv2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>expr_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>deriv1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>expr_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>deriv2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>t</span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"something went wrong here!"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>expr_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>deriv</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>additional_arguments</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>compile_clause</span></span><span> </span><span class="entity"><span>compilation_modifiers</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>all_vs</span></span><span> </span><span class="entity"><span>param_modes</span></span><span> </span><span class="entity"><span>additional_arguments</span></span><span>
  </span><span class="entity"><span>inp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>in_ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>out_ts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>moded_ps</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>compfuns</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Comp_Mod.compfuns</span></span><span> </span><span class="entity"><span>compilation_modifiers</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>compile_match</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>compile_match</span></span><span> </span><span class="entity"><span>compilation_modifiers</span></span><span>
      </span><span class="entity"><span>additional_arguments</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>param_modes</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>in_ts'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>all_vs'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eqs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>collect_non_invertible_subterms</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>in_ts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>all_vs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>compile_prems</span></span><span> </span><span class="entity"><span>out_ts'</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>out_ts''</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>names'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eqs'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>collect_non_invertible_subterms</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>out_ts'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>names</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>out_ts'''</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>constr_vs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_map</span><span> </span><span class="entity"><span>distinct_v</span></span><span>
              </span><span class="entity"><span>out_ts''</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>names'</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>rpair</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>processed_out_ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>compile_arg</span></span><span> </span><span class="entity"><span>compilation_modifiers</span></span><span> </span><span class="entity"><span>additional_arguments</span></span><span>
              </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>param_modes</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>out_ts</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="entity"><span>compile_match</span></span><span> </span><span class="entity"><span>constr_vs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eqs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>eqs'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>out_ts'''</span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>mk_single</span></span><span> </span><span class="entity"><span>compfuns</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_tuple</span></span><span> </span><span class="entity"><span>processed_out_ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>compile_prems</span></span><span> </span><span class="entity"><span>out_ts</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>deriv</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ps</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vs'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>distinct</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>flat</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vs</span></span><span> </span><span>::</span><span> </span><span>map</span><span> </span><span class="entity"><span>term_vs</span></span><span> </span><span class="entity"><span>out_ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>out_ts'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>names'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eqs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>collect_non_invertible_subterms</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>out_ts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>names</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>out_ts''</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>names''</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>constr_vs'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_map</span><span> </span><span class="entity"><span>distinct_v</span></span><span>
              </span><span class="entity"><span>out_ts'</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>names'</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>rpair</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>head_mode_of</span></span><span> </span><span class="entity"><span>deriv</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>additional_arguments'</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="entity"><span>Comp_Mod.transform_additional_arguments</span></span><span> </span><span class="entity"><span>compilation_modifiers</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>additional_arguments</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>compiled_clause</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rest</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                </span><span class="entity"><span>Prem</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=</span></span><span>
                      </span><span class="entity"><span>compile_expr</span></span><span> </span><span class="entity"><span>compilation_modifiers</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>deriv</span></span><span class="main"><span>)</span></span><span>
                       </span><span class="entity"><span>param_modes</span></span><span> </span><span class="entity"><span>additional_arguments'</span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>out_ts'''</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>split_mode</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span class="main"><span>(</span></span><span>strip_comb</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rest</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>compile_prems</span></span><span> </span><span class="entity"><span>out_ts'''</span></span><span> </span><span class="entity"><span>vs'</span></span><span> </span><span class="entity"><span>names''</span></span><span> </span><span class="entity"><span>ps</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                    </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rest</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Negprem</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>neg_compilation_modifiers</span></span><span> </span><span class="main"><span>=</span></span><span>
                      </span><span class="entity"><span>negative_comp_modifiers_of</span></span><span> </span><span class="entity"><span>compilation_modifiers</span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=</span></span><span>
                     </span><span class="entity"><span>mk_not</span></span><span> </span><span class="entity"><span>compfuns</span></span><span>
                       </span><span class="main"><span>(</span></span><span class="entity"><span>compile_expr</span></span><span> </span><span class="entity"><span>neg_compilation_modifiers</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>deriv</span></span><span class="main"><span>)</span></span><span>
                         </span><span class="entity"><span>param_modes</span></span><span> </span><span class="entity"><span>additional_arguments'</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>out_ts'''</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>split_mode</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span class="main"><span>(</span></span><span>strip_comb</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rest</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>compile_prems</span></span><span> </span><span class="entity"><span>out_ts'''</span></span><span> </span><span class="entity"><span>vs'</span></span><span> </span><span class="entity"><span>names''</span></span><span> </span><span class="entity"><span>ps</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                    </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rest</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Sidecond</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>compile_arg</span></span><span> </span><span class="entity"><span>compilation_modifiers</span></span><span> </span><span class="entity"><span>additional_arguments</span></span><span>
                      </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>param_modes</span></span><span> </span><span class="entity"><span>t</span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rest</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>compile_prems</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>vs'</span></span><span> </span><span class="entity"><span>names''</span></span><span> </span><span class="entity"><span>ps</span></span><span class="main"><span>;</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                    </span><span class="main"><span>(</span></span><span class="entity"><span>mk_if</span></span><span> </span><span class="entity"><span>compfuns</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rest</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Generator</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Comp_Mod.mk_random</span></span><span> </span><span class="entity"><span>compilation_modifiers</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>additional_arguments</span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rest</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>compile_prems</span></span><span> </span><span class="main"><span>[</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>  </span><span class="entity"><span>vs'</span></span><span> </span><span class="entity"><span>names''</span></span><span> </span><span class="entity"><span>ps</span></span><span class="main"><span>;</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                    </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rest</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="entity"><span>compile_match</span></span><span> </span><span class="entity"><span>constr_vs'</span></span><span> </span><span class="entity"><span>eqs</span></span><span> </span><span class="entity"><span>out_ts''</span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>mk_bind</span></span><span> </span><span class="entity"><span>compfuns</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>compiled_clause</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rest</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prem_t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>compile_prems</span></span><span> </span><span class="entity"><span>in_ts'</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>param_modes</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>all_vs'</span></span><span> </span><span class="entity"><span>moded_ps</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>mk_bind</span></span><span> </span><span class="entity"><span>compfuns</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_single</span></span><span> </span><span class="entity"><span>compfuns</span></span><span> </span><span class="entity"><span>inp</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prem_t</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(* switch detection *)</span></span><span>

</span><span class="comment1"><span>(** argument position of an inductive predicates and the executable functions **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>position</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>int</span><span> * </span><span>int</span><span> </span><span>list</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>input_positions_pair</span></span><span> </span><span class="entity"><span>Input</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>input_positions_pair</span></span><span> </span><span class="entity"><span>Output</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>input_positions_pair</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Fun</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>input_positions_pair</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Pair</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>cons</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>input_positions_pair</span></span><span> </span><span class="entity"><span>m1</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>cons</span><span> </span><span class="inner_numeral"><span>2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>input_positions_pair</span></span><span> </span><span class="entity"><span>m2</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>input_positions_of_mode</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>flat</span><span>
    </span><span class="main"><span>(</span></span><span>map_index</span><span>
      </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Input</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Output</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Fun</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Pair</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>input_positions_pair</span></span><span> </span><span class="entity"><span>m</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>Predicate_Compile_Aux.strip_fun_mode</span></span><span> </span><span class="entity"><span>mode</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>argument_position_pair</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>argument_position_pair</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Pair</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Fun</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>is</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>argument_position_pair</span></span><span> </span><span class="entity"><span>m2</span></span><span> </span><span class="entity"><span>is</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>argument_position_pair</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Pair</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>is</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>eq_mode</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Output</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="entity"><span>argument_position_pair</span></span><span> </span><span class="entity"><span>m2</span></span><span> </span><span class="entity"><span>is</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>eq_mode</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Output</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="entity"><span>argument_position_pair</span></span><span> </span><span class="entity"><span>m1</span></span><span> </span><span class="entity"><span>is</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>argument_position_pair</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>m1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>m2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>is</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>argument_position_of</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>is</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span> </span><span>-</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="main"><span>(</span></span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>Output</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Fun</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>(</span></span><span>List.take</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>strip_fun_mode</span></span><span> </span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span class="entity"><span>argument_position_pair</span></span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>strip_fun_mode</span></span><span> </span><span class="entity"><span>mode</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>is</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>nth_pair</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>nth_pair</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>is</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.Pair|const"><span>Pair</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nth_pair</span></span><span> </span><span class="entity"><span>is</span></span><span> </span><span class="entity"><span>t1</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>nth_pair</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>is</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.Pair|const"><span>Pair</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nth_pair</span></span><span> </span><span class="entity"><span>is</span></span><span> </span><span class="entity"><span>t2</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>nth_pair</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"unexpected input for nth_tuple"</span></span><span>


</span><span class="comment1"><span>(** switch detection analysis **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>find_switch_test</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>is</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nth_pair</span></span><span> </span><span class="entity"><span>is</span></span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>TFree</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Tcon</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Ctr_Sugar.ctr_sugar_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>Tcon</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>ctrs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>strip_comb</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>AList.defined</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span>dest_Const</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctrs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>c</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>partition_clause</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="entity"><span>moded_clauses</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>insert_list</span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>key</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>value</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>AList.map_default</span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>key</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>cons</span><span> </span><span class="entity"><span>value</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>find_switch_test'</span></span><span> </span><span class="entity"><span>moded_clause</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cases</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>left</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>find_switch_test</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="entity"><span>moded_clause</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>insert_list</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>moded_clause</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cases</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>left</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cases</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>moded_clause</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>left</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>fold</span><span> </span><span class="entity"><span>find_switch_test'</span></span><span> </span><span class="entity"><span>moded_clauses</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>switch_tree</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Atom</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> moded_clause list </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Node</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span>position * </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string * typ</span><span class="main"><span>)</span></span><span> * switch_tree</span><span class="main"><span>)</span></span><span> list</span><span class="main"><span>)</span></span><span> * switch_tree

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_switch_tree</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="entity"><span>moded_clauses</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>select_best_switch</span></span><span> </span><span class="entity"><span>moded_clauses</span></span><span> </span><span class="entity"><span>input_position</span></span><span> </span><span class="entity"><span>best_switch</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ord</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>option_ord</span><span> </span><span class="main"><span>(</span></span><span>rev_order</span><span> </span><span>o</span><span> </span><span>int_ord</span><span> </span><span>o</span><span> </span><span class="main"><span>(</span></span><span>apply2</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span>o</span><span> </span><span>snd</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>partition</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>partition_clause</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>input_position</span></span><span> </span><span class="entity"><span>moded_clauses</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>switch</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>partition</span></span><span class="main"><span>)</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>input_position</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>partition</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>ord</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>switch</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>best_switch</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span>LESS</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>best_switch</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>EQUAL</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>best_switch</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>GREATER</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>switch</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>detect_switches</span></span><span> </span><span class="entity"><span>moded_clauses</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>select_best_switch</span></span><span> </span><span class="entity"><span>moded_clauses</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>input_positions_of_mode</span></span><span> </span><span class="entity"><span>mode</span></span><span class="main"><span>)</span></span><span> </span><span>NONE</span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>best_pos</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>switched_on</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>left_clauses</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="entity"><span>Node</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>best_pos</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="entity"><span>detect_switches</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>switched_on</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
            </span><span class="entity"><span>detect_switches</span></span><span> </span><span class="entity"><span>left_clauses</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Atom</span></span><span> </span><span class="entity"><span>moded_clauses</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>detect_switches</span></span><span> </span><span class="entity"><span>moded_clauses</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(** compilation of detected switches **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>destruct_constructor_pattern</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pat</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>obj</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>strip_comb</span><span> </span><span class="entity"><span>pat</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>cons</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pat</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>obj</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pat_args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>strip_comb</span><span> </span><span class="entity"><span>obj</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>obj_args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>c'</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span>fold</span><span> </span><span class="entity"><span>destruct_constructor_pattern</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pat_args</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>obj_args</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"pattern and object mismatch"</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"unexpected object"</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"unexpected pattern"</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>compile_switch</span></span><span> </span><span class="entity"><span>compilation_modifiers</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>all_vs</span></span><span> </span><span class="entity"><span>param_modes</span></span><span> </span><span class="entity"><span>additional_arguments</span></span><span> </span><span class="entity"><span>mode</span></span><span>
  </span><span class="entity"><span>in_ts'</span></span><span> </span><span class="entity"><span>outTs</span></span><span> </span><span class="entity"><span>switch_tree</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>compfuns</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Comp_Mod.compfuns</span></span><span> </span><span class="entity"><span>compilation_modifiers</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>compile_switch_tree</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>compile_switch_tree</span></span><span> </span><span class="entity"><span>all_vs</span></span><span> </span><span class="entity"><span>ctxt_eqs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="entity"><span>moded_clauses</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>in_ts'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Pattern.rewrite_term</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>ctxt_eqs</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>in_ts'</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>compile_clause'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>moded_ps</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>out_ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>split_mode</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="entity"><span>ts</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>destruct_constructor_pattern</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>in_ts'</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fsubst</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pat'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.partition</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>subst</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>moded_ps'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>o</span><span> </span><span>apfst</span><span> </span><span>o</span><span> </span><span class="entity"><span>map_indprem</span></span><span class="main"><span>)</span></span><span>
                </span><span class="main"><span>(</span></span><span>Pattern.rewrite_term</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>swap</span><span> </span><span class="entity"><span>fsubst</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>moded_ps</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inp</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.mk_tuple</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>pat'</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>in_ts'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Pattern.rewrite_term</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>swap</span><span> </span><span class="entity"><span>fsubst</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>snd</span><span> </span><span class="entity"><span>pat'</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>out_ts'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Pattern.rewrite_term</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>swap</span><span> </span><span class="entity"><span>fsubst</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>out_ts</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span class="entity"><span>compile_clause</span></span><span> </span><span class="entity"><span>compilation_modifiers</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>all_vs</span></span><span> </span><span class="entity"><span>param_modes</span></span><span> </span><span class="entity"><span>additional_arguments</span></span><span>
                </span><span class="entity"><span>inp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>in_ts'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>out_ts'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>moded_ps'</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>foldr1</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_plus</span></span><span> </span><span class="entity"><span>compfuns</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>compile_clause'</span></span><span> </span><span class="entity"><span>moded_clauses</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>compile_switch_tree</span></span><span> </span><span class="entity"><span>all_vs</span></span><span> </span><span class="entity"><span>ctxt_eqs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Node</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>position</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>switched_clauses</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>left_clauses</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>is</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>argument_position_of</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="entity"><span>position</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inp_var</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nth_pair</span></span><span> </span><span class="entity"><span>is</span></span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>in_ts'</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Name.variant_list</span><span> </span><span class="entity"><span>all_vs</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"x"</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>xt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>inp_var</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>compile_single_case</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>switched</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>binder_types</span><span> </span><span class="entity"><span>T</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>argnames</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Name.variant_list</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>all_vs</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"c"</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span>upto</span><span> </span><span>length</span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span>Free</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>argnames</span></span><span> </span><span class="entity"><span>Ts</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pattern</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt_eqs'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inp_var</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pattern</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ctxt_eqs</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>compilation</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the_default</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_empty</span></span><span> </span><span class="entity"><span>compfuns</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_tupleT</span></span><span> </span><span class="entity"><span>outTs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>compile_switch_tree</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>argnames</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>x</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>all_vs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt_eqs'</span></span><span> </span><span class="entity"><span>switched</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>pattern</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>compilation</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>switch</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Case_Translation.make_case</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>Case_Translation.Quiet</span></span><span> </span><span>Name.context</span><span> </span><span class="entity"><span>inp_var</span></span><span>
          </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>compile_single_case</span></span><span> </span><span class="entity"><span>switched_clauses</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span>
            </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>xt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_empty</span></span><span> </span><span class="entity"><span>compfuns</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_tupleT</span></span><span> </span><span class="entity"><span>outTs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>compile_switch_tree</span></span><span> </span><span class="entity"><span>all_vs</span></span><span> </span><span class="entity"><span>ctxt_eqs</span></span><span> </span><span class="entity"><span>left_clauses</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>switch</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>left_comp</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_plus</span></span><span> </span><span class="entity"><span>compfuns</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>switch</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>left_comp</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>compile_switch_tree</span></span><span> </span><span class="entity"><span>all_vs</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>switch_tree</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(* compilation of predicates *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>compile_pred</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>compilation_modifiers</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>all_vs</span></span><span> </span><span class="entity"><span>param_vs</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pol</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mode</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>moded_cls</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>is_terminating</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span> </span><span class="comment1"><span>(* FIXME: requires an termination analysis *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>compilation_modifiers</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>pol</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>compilation_modifiers</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="entity"><span>negative_comp_modifiers_of</span></span><span> </span><span class="entity"><span>compilation_modifiers</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_depth_limited_compilation</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Comp_Mod.compilation</span></span><span> </span><span class="entity"><span>compilation_modifiers</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
           </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_terminating</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>Comp_Mod.set_compfuns</span></span><span>
                </span><span class="main"><span>(</span></span><span class="entity"><span>unlimited_compfuns_of</span></span><span> </span><span class="entity"><span>pol</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Comp_Mod.compilation</span></span><span> </span><span class="entity"><span>compilation_modifiers</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>Comp_Mod.set_compfuns</span></span><span>
                </span><span class="main"><span>(</span></span><span class="entity"><span>limited_compfuns_of</span></span><span> </span><span class="entity"><span>pol</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Comp_Mod.compilation</span></span><span> </span><span class="entity"><span>compilation_modifiers</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>additional_arguments</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>Comp_Mod.additional_arguments</span></span><span> </span><span class="entity"><span>compilation_modifiers</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>all_vs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>param_vs</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>compfuns</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Comp_Mod.compfuns</span></span><span> </span><span class="entity"><span>compilation_modifiers</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_param_type</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"fun"</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>_</span></span><span> </span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>is_some</span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest_monadT</span></span><span> </span><span class="entity"><span>compfuns</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>is_param_type</span></span><span> </span><span class="entity"><span>T'</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_param_type</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>is_some</span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest_monadT</span></span><span> </span><span class="entity"><span>compfuns</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inpTs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>outTs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>split_map_modeT</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>funT_of</span></span><span> </span><span class="entity"><span>compfuns</span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>mode</span></span><span>
        </span><span class="main"><span>(</span></span><span>binder_types</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>funT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Comp_Mod.funT_of</span></span><span> </span><span class="entity"><span>compilation_modifiers</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="entity"><span>T</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>in_ts</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fold_map_aterms_prodT</span></span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="entity"><span>HOLogic.mk_prod</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>param_vs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>names</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_param_type</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>param_vs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>tl</span><span> </span><span class="entity"><span>param_vs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>names</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>new</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Name.variant_list</span><span> </span><span class="entity"><span>names</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"x"</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>new</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>param_vs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>new</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>names</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>inpTs</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>param_vs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>all_vs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>param_vs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>in_ts'</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_filter_prod</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>param_vs</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>NONE</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>in_ts</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>param_modes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>param_vs</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>ho_arg_modes_of</span></span><span> </span><span class="entity"><span>mode</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>compilation</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>detect_switches</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span>the_default</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_empty</span></span><span> </span><span class="entity"><span>compfuns</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_tupleT</span></span><span> </span><span class="entity"><span>outTs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>compile_switch</span></span><span> </span><span class="entity"><span>compilation_modifiers</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>all_vs</span></span><span> </span><span class="entity"><span>param_modes</span></span><span> </span><span class="entity"><span>additional_arguments</span></span><span> </span><span class="entity"><span>mode</span></span><span>
            </span><span class="entity"><span>in_ts'</span></span><span> </span><span class="entity"><span>outTs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_switch_tree</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="entity"><span>moded_cls</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cl_ts</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>moded_prems</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="entity"><span>compile_clause</span></span><span> </span><span class="entity"><span>compilation_modifiers</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>all_vs</span></span><span> </span><span class="entity"><span>param_modes</span></span><span> </span><span class="entity"><span>additional_arguments</span></span><span>
                </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_tuple</span></span><span> </span><span class="entity"><span>in_ts'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>split_mode</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>moded_prems</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>moded_cls</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="entity"><span>Comp_Mod.wrap_compilation</span></span><span> </span><span class="entity"><span>compilation_modifiers</span></span><span> </span><span class="entity"><span>compfuns</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="entity"><span>additional_arguments</span></span><span>
            </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>cl_ts</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
              </span><span class="entity"><span>mk_empty</span></span><span> </span><span class="entity"><span>compfuns</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_tupleT</span></span><span> </span><span class="entity"><span>outTs</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
              </span><span>foldr1</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_plus</span></span><span> </span><span class="entity"><span>compfuns</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cl_ts</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fun_const</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Core_Data.function_name_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Comp_Mod.compilation</span></span><span> </span><span class="entity"><span>compilation_modifiers</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>funT</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_eq</span></span><span> </span><span class="main"><span>(</span></span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fun_const</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>in_ts</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>additional_arguments</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>compilation</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(* Definition of executable functions and their intro and elim rules *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>strip_split_abs</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.prod.case_prod|const"><span>case_prod</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>strip_split_abs</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>strip_split_abs</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>strip_split_abs</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>strip_split_abs</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_args</span></span><span> </span><span class="entity"><span>is_eval</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Pair</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.prod|type"><span>Product_Type.prod</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>eq_mode</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Input</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>eq_mode</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Output</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Name.variant_list</span><span> </span><span class="entity"><span>names</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"x"</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>names</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>names'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_args</span></span><span> </span><span class="entity"><span>is_eval</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>names</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>names''</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_args</span></span><span> </span><span class="entity"><span>is_eval</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>names'</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_prod</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>names''</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk_args</span></span><span> </span><span class="entity"><span>is_eval</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>m</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Fun</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>funT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>funT_of</span></span><span> </span><span class="entity"><span>Predicate_Comp_Funs.compfuns</span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="entity"><span>T</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Name.variant_list</span><span> </span><span class="entity"><span>names</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"x"</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>args</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_args</span></span><span> </span><span class="entity"><span>is_eval</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>strip_fun_mode</span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span>~~</span><span> </span><span>binder_types</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>names</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inargs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>outargs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>split_map_mode</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="entity"><span>args</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span class="entity"><span>HOLogic.tupled_lambda</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Predicate_Comp_Funs.mk_Eval</span></span><span>
          </span><span class="main"><span>(</span></span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>funT</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>inargs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>HOLogic.mk_tuple</span></span><span> </span><span class="entity"><span>outargs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_eval</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>funT</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>names</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk_args</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Name.variant_list</span><span> </span><span class="entity"><span>names</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"x"</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>names</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>create_intro_elim_rule</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="entity"><span>defthm</span></span><span> </span><span class="entity"><span>mode_id</span></span><span> </span><span class="entity"><span>funT</span></span><span> </span><span class="entity"><span>pred</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>funtrm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mode_id</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>funT</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>binder_types</span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>pred</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>args</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>argnames</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_args</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>strip_fun_mode</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>strip_eval</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>strip_split_abs</span></span><span> </span><span class="entity"><span>t</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Predicate_Comp_Funs.dest_Eval</span></span><span> </span><span class="entity"><span>t'</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="main"><span>(</span></span><span>strip_comb</span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inargs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>outargs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>split_map_mode</span></span><span> </span><span class="entity"><span>strip_eval</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="entity"><span>args</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eval_hoargs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ho_args_of</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="entity"><span>args</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>hoargTs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ho_argsT_of</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="entity"><span>Ts</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>hoarg_names'</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Name.variant_list</span><span> </span><span class="entity"><span>argnames</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"x"</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span>upto</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>hoargTs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>hoargs'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span>Free</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>hoarg_names'</span></span><span> </span><span class="entity"><span>hoargTs</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>args'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>replace_ho_args</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="entity"><span>hoargs'</span></span><span> </span><span class="entity"><span>args</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>predpropI</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pred</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>predpropE</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pred</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>param_eqs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span>oo</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="entity"><span>HOLogic.mk_eq</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eval_hoargs</span></span><span> </span><span class="entity"><span>hoargs'</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>funpropE</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Predicate_Comp_Funs.mk_Eval</span></span><span> </span><span class="main"><span>(</span></span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>funtrm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>inargs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>outargs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Free</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"y"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>HOLogic.unitT</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>HOLogic.mk_tuple</span></span><span> </span><span class="entity"><span>outargs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>funpropI</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Predicate_Comp_Funs.mk_Eval</span></span><span> </span><span class="main"><span>(</span></span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>funtrm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>inargs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                     </span><span class="entity"><span>HOLogic.mk_tuple</span></span><span> </span><span class="entity"><span>outargs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>introtrm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.list_implies</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>predpropI</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>param_eqs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>funpropI</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>simprules</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>[</span></span><span class="entity"><span>defthm</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Predicate.html#Predicate.pred.sel|fact"><span>pred.sel</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span>
        </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> "</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.split_beta|fact"><span>split_beta</span></a><span>"</span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> "</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.fst_conv|fact"><span>fst_conv</span></a><span>"</span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> "</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.snd_conv|fact"><span>snd_conv</span></a><span>"</span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.prod.collapse|fact"><span>prod.collapse</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>unfolddef_tac</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>Simplifier.asm_full_simp_tac</span></span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>HOL_basic_ss</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>addsimps</span><span> </span><span class="entity"><span>simprules</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>introthm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Goal.prove</span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>argnames</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>hoarg_names'</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"y"</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>introtrm</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>unfolddef_tac</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>P</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"P"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>HOLogic.boolT</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>elimtrm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.list_implies</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>funpropE</span></span><span class="main"><span>,</span></span><span> </span><span>Logic.mk_implies</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>predpropE</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>P</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>P</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>elimthm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Goal.prove</span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>argnames</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"y"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"P"</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>elimtrm</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>unfolddef_tac</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>opt_neg_introthm</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_all_input</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>neg_predpropI</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_not</span></span><span> </span><span class="main"><span>(</span></span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pred</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>neg_funpropI</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Predicate_Comp_Funs.mk_Eval</span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>Predicate_Comp_Funs.mk_not</span></span><span> </span><span class="main"><span>(</span></span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>funtrm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>inargs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>HOLogic.unit</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>neg_introtrm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.list_implies</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>neg_predpropI</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>param_eqs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>neg_funpropI</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="entity"><span>Simplifier.asm_full_simp_tac</span></span><span> </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>HOL_basic_ss</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>addsimps</span><span>
              </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.if_False|fact"><span>if_False</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>::</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Predicate.html#Predicate.not_pred_eq|fact"><span>Predicate.not_pred_eq</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>::</span><span> </span><span class="entity"><span>simprules</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
            </span><span>THEN</span><span> </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../Predicate.html#Predicate.singleI|fact"><span>Predicate.singleI</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Goal.prove</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>argnames</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>hoarg_names'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
            </span><span class="entity"><span>neg_introtrm</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>tac</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>introthm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>elimthm</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>opt_neg_introthm</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>create_constname_of_mode</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>prefix</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>system_proposal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prefix</span></span><span> </span><span>^</span><span> </span><span class="main"><span>(</span></span><span>Long_Name.base_name</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"_"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>ascii_string_of_mode</span></span><span> </span><span class="entity"><span>mode</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the_default</span><span> </span><span class="entity"><span>system_proposal</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>proposed_names</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>mode</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>Sign.full_bname</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>name</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>create_definitions</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>preds</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>modes</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>compfuns</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Predicate_Comp_Funs.compfuns</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>preds</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span>|&gt;</span><span> </span><span>the</span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>create_definition</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mode_cname</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>create_constname_of_mode</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>mode</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mode_cbasename</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Long_Name.base_name</span><span> </span><span class="entity"><span>mode_cname</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>funT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>funT_of</span></span><span> </span><span class="entity"><span>compfuns</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="entity"><span>T</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>args</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_args</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>strip_fun_mode</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span>~~</span><span> </span><span>binder_types</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>strip_eval</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>strip_split_abs</span></span><span> </span><span class="entity"><span>t</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Predicate_Comp_Funs.dest_Eval</span></span><span> </span><span class="entity"><span>t'</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="main"><span>(</span></span><span>strip_comb</span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inargs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>outargs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>split_map_mode</span></span><span> </span><span class="entity"><span>strip_eval</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="entity"><span>args</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>predterm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span class="entity"><span>HOLogic.tupled_lambda</span></span><span> </span><span class="entity"><span>inargs</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>Predicate_Comp_Funs.mk_Enum</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.tupled_lambda</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_tuple</span></span><span> </span><span class="entity"><span>outargs</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>(</span></span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lhs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mode_cname</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>funT</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>def</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.mk_equals</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>predterm</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>definition</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span>|&gt;</span><span>
          </span><span>Sign.add_consts</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="entity"><span>mode_cbasename</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>funT</span></span><span class="main"><span>,</span></span><span> </span><span>NoSyn</span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span>|&gt;</span><span>
          </span><span>Global_Theory.add_defs</span><span> </span><span>false</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="main"><span>(</span></span><span>Thm.def_name</span><span> </span><span class="entity"><span>mode_cbasename</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>def</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.init_global</span><span> </span><span class="entity"><span>thy'</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>intro</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>elim</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>create_intro_elim_rule</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="entity"><span>definition</span></span><span> </span><span class="entity"><span>mode_cname</span></span><span> </span><span class="entity"><span>funT</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="entity"><span>thy'</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>Core_Data.set_function_name</span></span><span> </span><span class="entity"><span>Pred</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="entity"><span>mode_cname</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>Core_Data.add_predfun_data</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>definition</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rules</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>Global_Theory.store_thm</span><span> </span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mode_cbasename</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"I"</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>intro</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>snd</span><span>
          </span><span>|&gt;</span><span> </span><span>Global_Theory.store_thm</span><span> </span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mode_cbasename</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"E"</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>elim</span></span><span class="main"><span>)</span></span><span>  </span><span>|&gt;</span><span> </span><span>snd</span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>thy</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>Core_Data.defined_function_of</span></span><span> </span><span class="entity"><span>Pred</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="entity"><span>create_definition</span></span><span> </span><span class="entity"><span>modes</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>define_functions</span></span><span> </span><span class="entity"><span>comp_modifiers</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>preds</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>modes</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>preds</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span>|&gt;</span><span> </span><span>the</span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>create_definition</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>function_name_prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Comp_Mod.function_name_prefix</span></span><span> </span><span class="entity"><span>comp_modifiers</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mode_cname</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>create_constname_of_mode</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>function_name_prefix</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>mode</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>funT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Comp_Mod.funT_of</span></span><span> </span><span class="entity"><span>comp_modifiers</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="entity"><span>T</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>thy</span></span><span> </span><span>|&gt;</span><span> </span><span>Sign.add_consts</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="main"><span>(</span></span><span>Long_Name.base_name</span><span> </span><span class="entity"><span>mode_cname</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>funT</span></span><span class="main"><span>,</span></span><span> </span><span>NoSyn</span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="entity"><span>Core_Data.set_function_name</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Comp_Mod.compilation</span></span><span> </span><span class="entity"><span>comp_modifiers</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="entity"><span>mode_cname</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>thy</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>Core_Data.defined_function_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Comp_Mod.compilation</span></span><span> </span><span class="entity"><span>comp_modifiers</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>name</span></span><span>
    </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="entity"><span>create_definition</span></span><span> </span><span class="entity"><span>modes</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* composition of mode inference, definition, compilation and proof *)</span></span><span>

</span><span class="comment1"><span>(** auxillary combinators for table of preds and modes **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_preds_modes</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>preds_modes_table</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pred</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>modes</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>pred</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>value</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>pred</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="entity"><span>value</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>modes</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>preds_modes_table</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>join_preds_modes</span></span><span> </span><span class="entity"><span>table1</span></span><span> </span><span class="entity"><span>table2</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>map_preds_modes</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>pred</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>value</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>value</span></span><span class="main"><span>,</span></span><span> </span><span>the</span><span> </span><span class="main"><span>(</span></span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="main"><span>(</span></span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>table2</span></span><span> </span><span class="entity"><span>pred</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>mode</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>table1</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>maps_modes</span></span><span> </span><span class="entity"><span>preds_modes_table</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pred</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>modes</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>pred</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>value</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>value</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>modes</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>preds_modes_table</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>compile_preds</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>comp_modifiers</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>all_vs</span></span><span> </span><span class="entity"><span>param_vs</span></span><span> </span><span class="entity"><span>preds</span></span><span> </span><span class="entity"><span>moded_clauses</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>map_preds_modes</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>pred</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>compile_pred</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>comp_modifiers</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>all_vs</span></span><span> </span><span class="entity"><span>param_vs</span></span><span> </span><span class="entity"><span>pred</span></span><span>
      </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="main"><span>(</span></span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>preds</span></span><span> </span><span class="entity"><span>pred</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>moded_clauses</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prove</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>clauses</span></span><span> </span><span class="entity"><span>preds</span></span><span> </span><span class="entity"><span>moded_clauses</span></span><span> </span><span class="entity"><span>compiled_terms</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>map_preds_modes</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prove_pred</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>clauses</span></span><span> </span><span class="entity"><span>preds</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>join_preds_modes</span></span><span> </span><span class="entity"><span>moded_clauses</span></span><span> </span><span class="entity"><span>compiled_terms</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prove_by_skip</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>compiled_terms</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>map_preds_modes</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Drule.export_without_context</span><span> </span><span class="main"><span>(</span></span><span>Skip_Proof.make_thm</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="entity"><span>compiled_terms</span></span><span>

</span><span class="comment1"><span>(* preparation of introduction rules into special datastructures *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_prem</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>strip_comb</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Free</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>Prem</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Sidecond</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>Not</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>dest_prem</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="entity"><span>Prem</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Negprem</span></span><span> </span><span class="entity"><span>t</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Negprem</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Double negation not allowed in premise: "</span></span><span> </span><span>^</span><span>
          </span><span>Syntax.string_of_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Sidecond</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Sidecond</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>Core_Data.is_registered</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>Prem</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Sidecond</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Sidecond</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prepare_intrs</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>prednames</span></span><span> </span><span class="entity"><span>intros</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>intrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>Thm.prop_of</span><span> </span><span class="entity"><span>intros</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>preds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span>Sign.the_const_type</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prednames</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>preds</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>intrs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unify_consts</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>preds</span></span><span> </span><span class="entity"><span>intrs</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>preds</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>intrs</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_burrow</span><span> </span><span class="main"><span>(</span></span><span>Variable.import_terms</span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>preds</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>intrs</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>preds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>dest_Const</span><span> </span><span class="entity"><span>preds</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>all_vs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>terms_vs</span></span><span> </span><span class="entity"><span>intrs</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>generate_modes</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>no_higher_order_predicate</span></span><span> </span><span class="entity"><span>options</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="entity"><span>all_smodes_of_typ</span></span><span> </span><span class="entity"><span>T</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="entity"><span>all_modes_of_typ</span></span><span> </span><span class="entity"><span>T</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>all_modes</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>proposed_modes</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>SOME</span><span> </span><span class="entity"><span>ms</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>check_matches_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>ms</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>generate_modes</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>preds</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>intrs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>snd</span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>preds</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>one_mode</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>hd</span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="main"><span>(</span></span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>all_modes</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>preds</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>paramTs</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="entity"><span>ho_argsT_of</span></span><span> </span><span class="entity"><span>one_mode</span></span><span> </span><span class="main"><span>(</span></span><span>binder_types</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>param_names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Name.variant_list</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"p"</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span>upto</span><span> </span><span>length</span><span> </span><span class="entity"><span>paramTs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span>Free</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>param_names</span></span><span> </span><span class="entity"><span>paramTs</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>intr</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>strip_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span>Logic.strip_imp_concl</span><span> </span><span class="entity"><span>intr</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>one_mode</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>hd</span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="main"><span>(</span></span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>all_modes</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="main"><span>(</span></span><span>dest_Const</span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="entity"><span>ho_args_of</span></span><span> </span><span class="entity"><span>one_mode</span></span><span> </span><span class="entity"><span>args</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>param_vs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span>dest_Free</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>params</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_clause</span></span><span> </span><span class="entity"><span>intr</span></span><span> </span><span class="entity"><span>clauses</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>strip_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span>Logic.strip_imp_concl</span><span> </span><span class="entity"><span>intr</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest_prem</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Logic.strip_imp_prems</span><span> </span><span class="entity"><span>intr</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>AList.update</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span>these</span><span> </span><span class="main"><span>(</span></span><span>AList.lookup</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>clauses</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
          </span><span class="entity"><span>clauses</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>clauses</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>add_clause</span></span><span> </span><span class="entity"><span>intrs</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>preds</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>all_vs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>param_vs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>all_modes</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>clauses</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(* sanity check of introduction rules *)</span></span><span>
</span><span class="comment1"><span>(* TODO: rethink check with new modes *)</span></span><span>
</span><span class="comment1"><span>(*
fun check_format_of_intro_rule thy intro =
  let
    val concl = Logic.strip_imp_concl (prop_of intro)
    val (p, args) = strip_comb (HOLogic.dest_Trueprop concl)
    val params = fst (chop (nparams_of thy (fst (dest_Const p))) args)
    fun check_arg arg = case HOLogic.strip_tupleT (fastype_of arg) of
      (Ts as _ :: _ :: _) =&gt;
        if length (HOLogic.strip_tuple arg) = length Ts then
          true
        else
          error ("Format of introduction rule is invalid: tuples must be expanded:"
          ^ (Syntax.string_of_term_global thy arg) ^ " in " ^
          (Thm.string_of_thm_global thy intro))
      | _ =&gt; true
    val prems = Logic.strip_imp_prems (prop_of intro)
    fun check_prem (Prem t) = forall check_arg args
      | check_prem (Negprem t) = forall check_arg args
      | check_prem _ = true
  in
    forall check_arg args andalso
    forall (check_prem o dest_prem thy params o HOLogic.dest_Trueprop) prems
  end
*)</span></span><span>
</span><span class="comment1"><span>(*
fun check_intros_elim_match thy prednames =
  let
    fun check predname =
      let
        val intros = intros_of thy predname
        val elim = the_elim_of thy predname
        val nparams = nparams_of thy predname
        val elim' =
          (Drule.export_without_context o Skip_Proof.make_thm thy)
          (mk_casesrule (Proof_Context.init_global thy) nparams intros)
      in
        if not (Thm.equiv_thm (elim, elim')) then
          error "Introduction and elimination rules do not match!"
        else true
      end
  in forall check prednames end
*)</span></span><span>


</span><span class="comment1"><span>(* create code equation *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_code_equations</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>preds</span></span><span> </span><span class="entity"><span>result_thmss</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_code_equation</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>predname</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pred</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>result_thms</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>full_mode</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="entity"><span>Fun</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="entity"><span>Input</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>binder_types</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Bool</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="entity"><span>eq_mode</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Core_Data.modes_of</span></span><span> </span><span class="entity"><span>Pred</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>predname</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>full_mode</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>binder_types</span><span> </span><span class="entity"><span>T</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>arg_names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Name.variant_list</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
              </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"x"</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span>upto</span><span> </span><span>length</span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span>Free</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>arg_names</span></span><span> </span><span class="entity"><span>Ts</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>predfun</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Core_Data.function_name_of</span></span><span> </span><span class="entity"><span>Pred</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>predname</span></span><span> </span><span class="entity"><span>full_mode</span></span><span class="main"><span>,</span></span><span>
              </span><span class="entity"><span>Ts</span></span><span> </span><span>---&gt;</span><span> </span><span class="entity"><span>Predicate_Comp_Funs.mk_monadT</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.unit|type"><span>unit</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rhs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Predicate.html#Predicate.holds|const"><span>Predicate.holds</span></a><span>›</span></span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>predfun</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eq_term</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_eq</span></span><span> </span><span class="main"><span>(</span></span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>predname</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>def</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Core_Data.predfun_definition_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>predname</span></span><span> </span><span class="entity"><span>full_mode</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Simplifier.simp_tac</span></span><span>
              </span><span class="main"><span>(</span></span><span>put_simpset</span><span> </span><span class="entity"><span>HOL_basic_ss</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>addsimps</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>def</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Predicate.html#Predicate.holds_eq|fact"><span>holds_eq</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../Predicate.html#Predicate.pred.sel|fact"><span>pred.sel</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Goal.prove</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>arg_names</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>eq_term</span></span><span> </span><span class="entity"><span>tac</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>pred</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>result_thms</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>eq</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>pred</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>result_thms</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>map2</span><span> </span><span class="entity"><span>add_code_equation</span></span><span> </span><span class="entity"><span>preds</span></span><span> </span><span class="entity"><span>result_thmss</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(** main function of predicate compiler **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>steps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Steps</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
  </span><span class="main"><span>{</span></span><span>
  define_functions </span><span class="main"><span>:</span></span><span> options </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string * typ</span><span class="main"><span>)</span></span><span> list </span><span class="main"><span>-&gt;</span></span><span> string * </span><span class="main"><span>(</span></span><span>bool * mode</span><span class="main"><span>)</span></span><span> list </span><span class="main"><span>-&gt;</span></span><span> theory </span><span class="main"><span>-&gt;</span></span><span> theory</span><span class="main"><span>,</span></span><span>
  prove </span><span class="main"><span>:</span></span><span> options </span><span class="main"><span>-&gt;</span></span><span> theory </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string * </span><span class="main"><span>(</span></span><span>term list * indprem list</span><span class="main"><span>)</span></span><span> list</span><span class="main"><span>)</span></span><span> list </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string * typ</span><span class="main"><span>)</span></span><span> list
    </span><span class="main"><span>-&gt;</span></span><span> moded_clause list pred_mode_table </span><span class="main"><span>-&gt;</span></span><span> term pred_mode_table </span><span class="main"><span>-&gt;</span></span><span> thm pred_mode_table</span><span class="main"><span>,</span></span><span>
  add_code_equations </span><span class="main"><span>:</span></span><span> Proof.context </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string * typ</span><span class="main"><span>)</span></span><span> list
    </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string * thm list</span><span class="main"><span>)</span></span><span> list </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string * thm list</span><span class="main"><span>)</span></span><span> list</span><span class="main"><span>,</span></span><span>
  comp_modifiers </span><span class="main"><span>:</span></span><span> Comp_Mod.comp_modifiers</span><span class="main"><span>,</span></span><span>
  use_generators </span><span class="main"><span>:</span></span><span> bool</span><span class="main"><span>,</span></span><span>
  qname </span><span class="main"><span>:</span></span><span> bstring
  </span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_equations_of</span></span><span> </span><span class="entity"><span>steps</span></span><span> </span><span class="entity"><span>mode_analysis_options</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>prednames</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_steps</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Steps</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>compilation</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Comp_Mod.compilation</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>comp_modifiers</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest_steps</span></span><span> </span><span class="entity"><span>steps</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.init_global</span><span> </span><span class="entity"><span>thy</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>print_step</span></span><span> </span><span class="entity"><span>options</span></span><span>
        </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Starting predicate compiler (compilation: "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>string_of_compilation</span></span><span> </span><span class="entity"><span>compilation</span></span><span> </span><span>^</span><span>
          </span><span class="inner_quoted"><span>") for predicates "</span></span><span> </span><span>^</span><span> </span><span>commas</span><span> </span><span class="entity"><span>prednames</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"..."</span></span><span class="main"><span>)</span></span><span>
    </span><span class="comment1"><span>(*val _ = check_intros_elim_match thy prednames*)</span></span><span>
    </span><span class="comment1"><span>(*val _ = map (check_format_of_intro_rule thy) (maps (intros_of thy) prednames)*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>show_intermediate_results</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span>tracing</span><span> </span><span class="main"><span>(</span></span><span>commas</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Thm.string_of_thm</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Core_Data.intros_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prednames</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>preds</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>all_vs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>param_vs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>all_modes</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>clauses</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>prepare_intrs</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>prednames</span></span><span> </span><span class="main"><span>(</span></span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Core_Data.intros_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prednames</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>print_step</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="inner_quoted"><span>"Infering modes..."</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lookup_mode</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lookup_neg_mode</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>needs_random</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Core_Data.modes_of</span></span><span> </span><span class="entity"><span>compilation</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span>
      </span><span class="entity"><span>Core_Data.modes_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>negative_compilation_of</span></span><span> </span><span class="entity"><span>compilation</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Core_Data.needs_random</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>moded_clauses</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>needs_random</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>errors</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>cond_timeit</span><span> </span><span class="main"><span>(</span></span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>Quickcheck.timing</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"Infering modes"</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>infer_modes</span></span><span> </span><span class="entity"><span>mode_analysis_options</span></span><span>
        </span><span class="entity"><span>options</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lookup_mode</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lookup_neg_mode</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>needs_random</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>preds</span></span><span> </span><span class="entity"><span>all_modes</span></span><span> </span><span class="entity"><span>param_vs</span></span><span> </span><span class="entity"><span>clauses</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ms</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Core_Data.set_needs_random</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>ms</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>needs_random</span></span><span> </span><span class="entity"><span>thy</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>modes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mps</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>mps</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>moded_clauses</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>check_expected_modes</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>preds</span></span><span> </span><span class="entity"><span>modes</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>check_proposed_modes</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>preds</span></span><span> </span><span class="entity"><span>modes</span></span><span> </span><span class="entity"><span>errors</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>print_modes</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>modes</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>print_step</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="inner_quoted"><span>"Defining executable functions..."</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy''</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>cond_timeit</span><span> </span><span class="main"><span>(</span></span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>Quickcheck.timing</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"Defining executable functions..."</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>define_functions</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest_steps</span></span><span> </span><span class="entity"><span>steps</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>preds</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>modes</span></span><span> </span><span class="entity"><span>thy'</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt''</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.init_global</span><span> </span><span class="entity"><span>thy''</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>print_step</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="inner_quoted"><span>"Compiling equations..."</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>compiled_terms</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>cond_timeit</span><span> </span><span class="main"><span>(</span></span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>Quickcheck.timing</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"Compiling equations...."</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>compile_preds</span></span><span> </span><span class="entity"><span>options</span></span><span>
          </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>comp_modifiers</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest_steps</span></span><span> </span><span class="entity"><span>steps</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt''</span></span><span> </span><span class="entity"><span>all_vs</span></span><span> </span><span class="entity"><span>param_vs</span></span><span> </span><span class="entity"><span>preds</span></span><span> </span><span class="entity"><span>moded_clauses</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>print_compiled_terms</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>ctxt''</span></span><span> </span><span class="entity"><span>compiled_terms</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>print_step</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="inner_quoted"><span>"Proving equations..."</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>result_thms</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>cond_timeit</span><span> </span><span class="main"><span>(</span></span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>Quickcheck.timing</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"Proving equations...."</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="main"><span>#</span></span><span>prove</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest_steps</span></span><span> </span><span class="entity"><span>steps</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>thy''</span></span><span> </span><span class="entity"><span>clauses</span></span><span> </span><span class="entity"><span>preds</span></span><span> </span><span class="entity"><span>moded_clauses</span></span><span> </span><span class="entity"><span>compiled_terms</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>result_thms'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>add_code_equations</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest_steps</span></span><span> </span><span class="entity"><span>steps</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt''</span></span><span> </span><span class="entity"><span>preds</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>maps_modes</span></span><span> </span><span class="entity"><span>result_thms</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>qname</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>qname</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest_steps</span></span><span> </span><span class="entity"><span>steps</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy'''</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>cond_timeit</span><span> </span><span class="main"><span>(</span></span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>Quickcheck.timing</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"Setting code equations...."</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>thy''</span></span><span>
        </span><span>|&gt;</span><span> </span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>result_thms</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>Global_Theory.add_thmss</span><span>
            </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.qualify</span><span> </span><span>true</span><span> </span><span class="main"><span>(</span></span><span>Long_Name.base_name</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="entity"><span>qname</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>result_thms</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="entity"><span>result_thms'</span></span><span>
        </span><span>|-&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>notes</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Code.declare_default_eqns_global</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>rpair</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>flat</span><span> </span><span class="main"><span>(</span></span><span>flat</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>notes</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>thy'''</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gen_add_equations</span></span><span> </span><span class="entity"><span>steps</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_steps</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Steps</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>defined</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Core_Data.defined_functions</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Comp_Mod.compilation</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>comp_modifiers</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest_steps</span></span><span> </span><span class="entity"><span>steps</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Core_Data.extend_intro_graph</span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>strong_conn_of</span></span><span> </span><span class="entity"><span>gr</span></span><span> </span><span class="entity"><span>keys</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Graph.strong_conn</span><span> </span><span class="main"><span>(</span></span><span>Graph.restrict</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Graph.all_succs</span><span> </span><span class="entity"><span>gr</span></span><span> </span><span class="entity"><span>keys</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>gr</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>scc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>strong_conn_of</span></span><span> </span><span class="main"><span>(</span></span><span>Core_Data.PredData.get</span><span> </span><span class="entity"><span>thy'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>names</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy''</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>Core_Data.preprocess_intros</span></span><span> </span><span class="main"><span>(</span></span><span>flat</span><span> </span><span class="entity"><span>scc</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thy'</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy'''</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span>
      </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>preds</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>forall</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>defined</span></span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.init_global</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>preds</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mode_analysis_options</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>use_generators</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>use_generators</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest_steps</span></span><span> </span><span class="entity"><span>steps</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
              </span><span>reorder_premises</span><span> </span><span class="main"><span>=</span></span><span>
                </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>no_topmost_reordering</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span class="main"><span>(</span></span><span>inter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>preds</span></span><span> </span><span class="entity"><span>names</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
              </span><span>infer_pos_and_neg_modes</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>use_generators</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest_steps</span></span><span> </span><span class="entity"><span>steps</span></span><span class="main"><span>)</span></span><span class="main"><span>}</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="entity"><span>add_equations_of</span></span><span> </span><span class="entity"><span>steps</span></span><span> </span><span class="entity"><span>mode_analysis_options</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>preds</span></span><span> </span><span class="entity"><span>thy</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span>
      </span><span class="entity"><span>scc</span></span><span> </span><span class="entity"><span>thy''</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>thy'''</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>add_equations</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>gen_add_equations</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>Steps</span></span><span> </span><span class="main"><span>{</span></span><span>
  </span><span>define_functions</span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>preds</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>modes</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="entity"><span>create_definitions</span></span><span>
      </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>preds</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span>true</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>modes</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span>prove</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prove</span></span><span class="main"><span>,</span></span><span>
  </span><span>add_code_equations</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_code_equations</span></span><span class="main"><span>,</span></span><span>
  </span><span>comp_modifiers</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>predicate_comp_modifiers</span></span><span class="main"><span>,</span></span><span>
  </span><span>use_generators</span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span>
  </span><span>qname</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"equation"</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>add_depth_limited_equations</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>gen_add_equations</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>Steps</span></span><span> </span><span class="main"><span>{</span></span><span>
  </span><span>define_functions</span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>preds</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>modes</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="entity"><span>define_functions</span></span><span> </span><span class="entity"><span>depth_limited_comp_modifiers</span></span><span> </span><span class="entity"><span>Predicate_Comp_Funs.compfuns</span></span><span>
    </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>preds</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span>true</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>modes</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span>prove</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prove_by_skip</span></span><span class="main"><span>,</span></span><span>
  </span><span>add_code_equations</span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>I</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span>comp_modifiers</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>depth_limited_comp_modifiers</span></span><span class="main"><span>,</span></span><span>
  </span><span>use_generators</span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span>
  </span><span>qname</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"depth_limited_equation"</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>add_random_equations</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>gen_add_equations</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>Steps</span></span><span> </span><span class="main"><span>{</span></span><span>
  </span><span>define_functions</span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>preds</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>modes</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="entity"><span>define_functions</span></span><span> </span><span class="entity"><span>random_comp_modifiers</span></span><span> </span><span class="entity"><span>Predicate_Comp_Funs.compfuns</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>preds</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span>true</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>modes</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span>comp_modifiers</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>random_comp_modifiers</span></span><span class="main"><span>,</span></span><span>
  </span><span>prove</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prove_by_skip</span></span><span class="main"><span>,</span></span><span>
  </span><span>add_code_equations</span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>I</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span>use_generators</span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span class="main"><span>,</span></span><span>
  </span><span>qname</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"random_equation"</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>add_depth_limited_random_equations</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>gen_add_equations</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>Steps</span></span><span> </span><span class="main"><span>{</span></span><span>
  </span><span>define_functions</span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>preds</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>modes</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="entity"><span>define_functions</span></span><span> </span><span class="entity"><span>depth_limited_random_comp_modifiers</span></span><span> </span><span class="entity"><span>Predicate_Comp_Funs.compfuns</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>preds</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span>true</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>modes</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span>comp_modifiers</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>depth_limited_random_comp_modifiers</span></span><span class="main"><span>,</span></span><span>
  </span><span>prove</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prove_by_skip</span></span><span class="main"><span>,</span></span><span>
  </span><span>add_code_equations</span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>I</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span>use_generators</span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span class="main"><span>,</span></span><span>
  </span><span>qname</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"depth_limited_random_equation"</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>add_dseq_equations</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>gen_add_equations</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>Steps</span></span><span> </span><span class="main"><span>{</span></span><span>
  </span><span>define_functions</span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>preds</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>modes</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="entity"><span>define_functions</span></span><span> </span><span class="entity"><span>dseq_comp_modifiers</span></span><span> </span><span class="entity"><span>DSequence_CompFuns.compfuns</span></span><span>
    </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>preds</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span>true</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>modes</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span>prove</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prove_by_skip</span></span><span class="main"><span>,</span></span><span>
  </span><span>add_code_equations</span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>I</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span>comp_modifiers</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dseq_comp_modifiers</span></span><span class="main"><span>,</span></span><span>
  </span><span>use_generators</span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span>
  </span><span>qname</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"dseq_equation"</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>add_random_dseq_equations</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>gen_add_equations</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>Steps</span></span><span> </span><span class="main"><span>{</span></span><span>
  </span><span>define_functions</span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>preds</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>modes</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pos_modes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span>true</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>modes</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>neg_modes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>modes</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>define_functions</span></span><span> </span><span class="entity"><span>pos_random_dseq_comp_modifiers</span></span><span> </span><span class="entity"><span>Random_Sequence_CompFuns.compfuns</span></span><span>
      </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>preds</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos_modes</span></span><span class="main"><span>)</span></span><span>
      </span><span>#&gt;</span><span> </span><span class="entity"><span>define_functions</span></span><span> </span><span class="entity"><span>neg_random_dseq_comp_modifiers</span></span><span> </span><span class="entity"><span>Random_Sequence_CompFuns.compfuns</span></span><span>
      </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>preds</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>neg_modes</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>,</span></span><span>
  </span><span>prove</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prove_by_skip</span></span><span class="main"><span>,</span></span><span>
  </span><span>add_code_equations</span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>I</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span>comp_modifiers</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pos_random_dseq_comp_modifiers</span></span><span class="main"><span>,</span></span><span>
  </span><span>use_generators</span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span class="main"><span>,</span></span><span>
  </span><span>qname</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"random_dseq_equation"</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>add_new_random_dseq_equations</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>gen_add_equations</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>Steps</span></span><span> </span><span class="main"><span>{</span></span><span>
  </span><span>define_functions</span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>preds</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>modes</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pos_modes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span>true</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>modes</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>neg_modes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>modes</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>define_functions</span></span><span> </span><span class="entity"><span>new_pos_random_dseq_comp_modifiers</span></span><span>
          </span><span class="entity"><span>New_Pos_Random_Sequence_CompFuns.depth_limited_compfuns</span></span><span>
          </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>preds</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos_modes</span></span><span class="main"><span>)</span></span><span> </span><span>#&gt;</span><span>
        </span><span class="entity"><span>define_functions</span></span><span> </span><span class="entity"><span>new_neg_random_dseq_comp_modifiers</span></span><span>
          </span><span class="entity"><span>New_Neg_Random_Sequence_CompFuns.depth_limited_compfuns</span></span><span>
          </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>preds</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>neg_modes</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>,</span></span><span>
  </span><span>prove</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prove_by_skip</span></span><span class="main"><span>,</span></span><span>
  </span><span>add_code_equations</span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>I</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span>comp_modifiers</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>new_pos_random_dseq_comp_modifiers</span></span><span class="main"><span>,</span></span><span>
  </span><span>use_generators</span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span class="main"><span>,</span></span><span>
  </span><span>qname</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"new_random_dseq_equation"</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>add_generator_dseq_equations</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>gen_add_equations</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>Steps</span></span><span> </span><span class="main"><span>{</span></span><span>
  </span><span>define_functions</span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>preds</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>modes</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pos_modes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span>true</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>modes</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>neg_modes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>modes</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>define_functions</span></span><span> </span><span class="entity"><span>pos_generator_dseq_comp_modifiers</span></span><span>
          </span><span class="entity"><span>New_Pos_DSequence_CompFuns.depth_limited_compfuns</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>preds</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos_modes</span></span><span class="main"><span>)</span></span><span> </span><span>#&gt;</span><span>
        </span><span class="entity"><span>define_functions</span></span><span> </span><span class="entity"><span>neg_generator_dseq_comp_modifiers</span></span><span>
          </span><span class="entity"><span>New_Neg_DSequence_CompFuns.depth_limited_compfuns</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>preds</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>neg_modes</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>,</span></span><span>
  </span><span>prove</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prove_by_skip</span></span><span class="main"><span>,</span></span><span>
  </span><span>add_code_equations</span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>I</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span>comp_modifiers</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pos_generator_dseq_comp_modifiers</span></span><span class="main"><span>,</span></span><span>
  </span><span>use_generators</span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span class="main"><span>,</span></span><span>
  </span><span>qname</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"generator_dseq_equation"</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>add_generator_cps_equations</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>gen_add_equations</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>Steps</span></span><span> </span><span class="main"><span>{</span></span><span>
  </span><span>define_functions</span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>preds</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>modes</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pos_modes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span>true</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>modes</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>neg_modes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>modes</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>define_functions</span></span><span> </span><span class="entity"><span>pos_generator_cps_comp_modifiers</span></span><span> </span><span class="entity"><span>Pos_Bounded_CPS_Comp_Funs.compfuns</span></span><span>
          </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>preds</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos_modes</span></span><span class="main"><span>)</span></span><span>
        </span><span>#&gt;</span><span> </span><span class="entity"><span>define_functions</span></span><span> </span><span class="entity"><span>neg_generator_cps_comp_modifiers</span></span><span> </span><span class="entity"><span>Neg_Bounded_CPS_Comp_Funs.compfuns</span></span><span>
          </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>preds</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>neg_modes</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>,</span></span><span>
  </span><span>prove</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prove_by_skip</span></span><span class="main"><span>,</span></span><span>
  </span><span>add_code_equations</span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>I</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span>comp_modifiers</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pos_generator_cps_comp_modifiers</span></span><span class="main"><span>,</span></span><span>
  </span><span>use_generators</span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span class="main"><span>,</span></span><span>
  </span><span>qname</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"generator_cps_equation"</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span>


</span><span class="comment1"><span>(** user interface **)</span></span><span>

</span><span class="comment1"><span>(* code_pred_intro attribute *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>attrib'</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>opt_case_name</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Thm.declaration_attribute</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Context.mapping</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>opt_case_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>code_pred_intro_attrib</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>attrib'</span></span><span> </span><span class="entity"><span>Core_Data.add_intro</span></span><span> </span><span>NONE</span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*FIXME
- Naming of auxiliary rules necessary?
*)</span></span><span>

</span><span class="comment1"><span>(* values_timeout configuration *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>values_timeout</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Attrib.setup_config_real</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Predicate_Compile.values_timeout|attribute"><span>values_timeout</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="inner_numeral"><span>40.0</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Theory.setup</span><span>
   </span><span class="main"><span>(</span></span><span>Core_Data.PredData.put</span><span> </span><span class="main"><span>(</span></span><span>Graph.empty</span><span class="main"><span>)</span></span><span> </span><span>#&gt;</span><span>
    </span><span class="entity"><span>Attrib.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Predicate_Compile.code_pred_intro|attribute"><span>code_pred_intro</span></span><span>›</span></span></span><span>
      </span><span class="main"><span>(</span></span><span>Scan.lift</span><span> </span><span class="main"><span>(</span></span><span>Scan.option</span><span> </span><span>Args.name</span><span class="main"><span>)</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="entity"><span>attrib'</span></span><span> </span><span class="entity"><span>Core_Data.add_intro</span></span><span class="main"><span>)</span></span><span>
      </span><span class="inner_quoted"><span>"adding alternative introduction rules for code generation of inductive predicates"</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(* TODO: make Theory_Data to Generic_Data &amp; remove duplication of local theory and theory *)</span></span><span>
</span><span class="comment1"><span>(* FIXME ... this is important to avoid changing the background theory below *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>generic_code_pred</span></span><span> </span><span class="entity"><span>prep_const</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>raw_const</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>lthy</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>const</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prep_const</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>raw_const</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lthy'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Local_Theory.background_theory</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Core_Data.extend_intro_graph</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>const</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>lthy'</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.init_global</span><span> </span><span class="entity"><span>thy'</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>preds</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Graph.all_succs</span><span> </span><span class="main"><span>(</span></span><span>Core_Data.PredData.get</span><span> </span><span class="entity"><span>thy'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>const</span></span><span class="main"><span>]</span></span><span> </span><span>|&gt;</span><span> </span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Core_Data.has_elim</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_cases</span></span><span> </span><span class="entity"><span>const</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Sign.the_const_type</span><span> </span><span class="entity"><span>thy'</span></span><span> </span><span class="entity"><span>const</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pred</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>const</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>intros</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Core_Data.intros_of</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>const</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>mk_casesrule</span></span><span> </span><span class="entity"><span>lthy'</span></span><span> </span><span class="entity"><span>pred</span></span><span> </span><span class="entity"><span>intros</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cases_rules</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>mk_cases</span></span><span> </span><span class="entity"><span>preds</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cases</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>pred_name</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>case_rule</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span>Rule_Cases.Case</span><span> </span><span class="main"><span>{</span></span><span>
          </span><span>fixes</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
          </span><span>assumes</span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"that"</span></span><span class="main"><span>,</span></span><span> </span><span>tl</span><span> </span><span class="main"><span>(</span></span><span>Logic.strip_imp_prems</span><span> </span><span class="entity"><span>case_rule</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span>
            </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fact_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fact</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>fact</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fact_name</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="inner_quoted"><span>"prems"</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>Core_Data.names_of</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>pred_name</span></span><span class="main"><span>)</span></span><span> </span><span>~~</span><span> </span><span>Logic.strip_imp_prems</span><span> </span><span class="entity"><span>case_rule</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
          </span><span>binds</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span>cases</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>preds</span></span><span> </span><span class="entity"><span>cases_rules</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>case_env</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>Long_Name.base_name</span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>preds</span></span><span> </span><span class="entity"><span>cases</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lthy''</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lthy'</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span>Proof_Context.augment</span><span> </span><span class="entity"><span>cases_rules</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Proof_Context.update_cases</span><span> </span><span class="entity"><span>case_env</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>after_qed</span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="entity"><span>goal_ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>global_thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.export</span><span> </span><span class="entity"><span>goal_ctxt</span></span><span>
          </span><span class="main"><span>(</span></span><span>Proof_Context.init_global</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>goal_ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>the_single</span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>goal_ctxt</span></span><span> </span><span>|&gt;</span><span> </span><span>Local_Theory.background_theory</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="entity"><span>Core_Data.set_elim</span></span><span> </span><span class="entity"><span>global_thms</span></span><span> </span><span>#&gt;</span><span>
          </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>compilation</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
             </span><span class="entity"><span>Pred</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>add_equations</span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>DSeq</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>add_dseq_equations</span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Pos_Random_DSeq</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>add_random_dseq_equations</span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Depth_Limited</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>add_depth_limited_equations</span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Random</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>add_random_equations</span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Depth_Limited_Random</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>add_depth_limited_random_equations</span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>New_Pos_Random_DSeq</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>add_new_random_dseq_equations</span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Pos_Generator_DSeq</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>add_generator_dseq_equations</span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Pos_Generator_CPS</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>add_generator_cps_equations</span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Compilation not supported"</span></span><span class="main"><span>)</span></span><span>
           </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>const</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>Proof.theorem</span></span><span> </span><span>NONE</span><span> </span><span class="entity"><span>after_qed</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>single</span><span> </span><span>o</span><span> </span><span class="main"><span>(</span></span><span>rpair</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cases_rules</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy''</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>code_pred</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>generic_code_pred</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>I</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>code_pred_cmd</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>generic_code_pred</span></span><span> </span><span class="entity"><span>Code.read_const</span></span><span>


</span><span class="comment1"><span>(* transformation for code generation *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Data</span><span>
</span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span>unit</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="entity"><span>Predicate.pred</span></span><span class="main"><span>)</span></span><span> *
    </span><span class="main"><span>(</span></span><span>unit</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>seed</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="entity"><span>Predicate.pred</span></span><span> * </span><span class="entity"><span>seed</span></span><span class="main"><span>)</span></span><span> *
    </span><span class="main"><span>(</span></span><span>unit</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="entity"><span>Limited_Sequence.dseq</span></span><span class="main"><span>)</span></span><span> *
    </span><span class="main"><span>(</span></span><span>unit</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Code_Numeral.natural</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Code_Numeral.natural</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>seed</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
      </span><span>term</span><span> </span><span class="entity"><span>Limited_Sequence.dseq</span></span><span> * </span><span class="entity"><span>seed</span></span><span class="main"><span>)</span></span><span> *
    </span><span class="main"><span>(</span></span><span>unit</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Code_Numeral.natural</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="entity"><span>Lazy_Sequence.lazy_sequence</span></span><span class="main"><span>)</span></span><span> *
    </span><span class="main"><span>(</span></span><span>unit</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Code_Numeral.natural</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Code_Numeral.natural</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>seed</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
      </span><span>Code_Numeral.natural</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="entity"><span>Lazy_Sequence.lazy_sequence</span></span><span class="main"><span>)</span></span><span> *
    </span><span class="main"><span>(</span></span><span>unit</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Code_Numeral.natural</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Code_Numeral.natural</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>seed</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
      </span><span>Code_Numeral.natural</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> * </span><span>Code_Numeral.natural</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Lazy_Sequence.lazy_sequence</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
   </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"pred_result"</span></span><span class="main"><span>,</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"pred_random_result"</span></span><span class="main"><span>,</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"dseq_result"</span></span><span class="main"><span>,</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"dseq_random_result"</span></span><span class="main"><span>,</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"new_dseq_result"</span></span><span class="main"><span>,</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"lseq_random_result"</span></span><span class="main"><span>,</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"lseq_random_stats_result"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>init</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>empty</span></span><span class="main"><span>;</span></span><span>
</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get_pred_result</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span>o</span><span> </span><span>Data.get</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get_pred_random_result</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span>o</span><span> </span><span>Data.get</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get_dseq_result</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>3</span></span><span> </span><span>o</span><span> </span><span>Data.get</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get_dseq_random_result</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>4</span></span><span> </span><span>o</span><span> </span><span>Data.get</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get_new_dseq_result</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>5</span></span><span> </span><span>o</span><span> </span><span>Data.get</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get_lseq_random_result</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>6</span></span><span> </span><span>o</span><span> </span><span>Data.get</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get_lseq_random_stats_result</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>7</span></span><span> </span><span>o</span><span> </span><span>Data.get</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>put_pred_result</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Data.map</span><span> </span><span>o</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>apply</span></span><span> 7</span><span class="main"><span>(</span></span><span>1</span><span class="main"><span>)</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span>o</span><span> </span><span>K</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>put_pred_random_result</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Data.map</span><span> </span><span>o</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>apply</span></span><span> 7</span><span class="main"><span>(</span></span><span>2</span><span class="main"><span>)</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span>o</span><span> </span><span>K</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>put_dseq_result</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Data.map</span><span> </span><span>o</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>apply</span></span><span> 7</span><span class="main"><span>(</span></span><span>3</span><span class="main"><span>)</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span>o</span><span> </span><span>K</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>put_dseq_random_result</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Data.map</span><span> </span><span>o</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>apply</span></span><span> 7</span><span class="main"><span>(</span></span><span>4</span><span class="main"><span>)</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span>o</span><span> </span><span>K</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>put_new_dseq_result</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Data.map</span><span> </span><span>o</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>apply</span></span><span> 7</span><span class="main"><span>(</span></span><span>5</span><span class="main"><span>)</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span>o</span><span> </span><span>K</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>put_lseq_random_result</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Data.map</span><span> </span><span>o</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>apply</span></span><span> 7</span><span class="main"><span>(</span></span><span>6</span><span class="main"><span>)</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span>o</span><span> </span><span>K</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>put_lseq_random_stats_result</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Data.map</span><span> </span><span>o</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>apply</span></span><span> 7</span><span class="main"><span>(</span></span><span>7</span><span class="main"><span>)</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span>o</span><span> </span><span>K</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_special_compr</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inner_t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T_compr</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Set.html#Set.Collect|const"><span>Collect</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"dest_special_compr"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>conj</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Predicate_Compile_Aux.strip_ex</span></span><span> </span><span class="entity"><span>inner_t</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.dest_conj</span></span><span> </span><span class="entity"><span>conj</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rhs</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>HOLogic.dest_eq</span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="main"><span>(</span></span><span>Bound</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>rhs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"dest_special_compr"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"dest_special_compr"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>output_names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Name.variant_list</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span>Term.add_free_names</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"x"</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span>upto</span><span> </span><span>length</span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>output_frees</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span>Free</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>output_names</span></span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>body</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>subst_bounds</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>output_frees</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>output</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>subst_bounds</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>output_frees</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>body</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>output</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T_compr</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>output_names</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_general_compr</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t_compr</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inner_t</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>t_compr</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Set.html#Set.Collect|const"><span>Collect</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>t</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Not a set comprehension: "</span></span><span> </span><span>^</span><span> </span><span>Syntax.string_of_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t_compr</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>body</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fp</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.strip_ptupleabs</span></span><span> </span><span class="entity"><span>inner_t</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>output_names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Name.variant_list</span><span> </span><span class="main"><span>(</span></span><span>Term.add_free_names</span><span> </span><span class="entity"><span>body</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"x"</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span>upto</span><span> </span><span>length</span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>output_frees</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span>Free</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>output_names</span></span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>body</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>subst_bounds</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>output_frees</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T_compr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.mk_ptupleT</span></span><span> </span><span class="entity"><span>fp</span></span><span> </span><span class="entity"><span>Ts</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>output</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.mk_ptuple</span></span><span> </span><span class="entity"><span>fp</span></span><span> </span><span class="entity"><span>T_compr</span></span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="entity"><span>output_frees</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>body</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>output</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T_compr</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>output_names</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(*FIXME turn this into an LCF-guarded preprocessor for comprehensions*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>analyze_compr</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>comp_modifiers</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>additional_arguments</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>param_user_modes</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>compilation</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t_compr</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>compfuns</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Comp_Mod.compfuns</span></span><span> </span><span class="entity"><span>comp_modifiers</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>all_modes_of</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Core_Data.all_modes_of</span></span><span> </span><span class="entity"><span>compilation</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>body</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>output</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T_compr</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>output_names</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="entity"><span>dest_special_compr</span></span><span> </span><span class="entity"><span>t_compr</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>SOME</span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>r</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>dest_general_compr</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t_compr</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>all_args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>strip_comb</span><span> </span><span class="entity"><span>body</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>all_args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>all_args</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>head</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Not a constant: "</span></span><span> </span><span>^</span><span> </span><span>Syntax.string_of_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>head</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>Core_Data.defined_functions</span></span><span> </span><span class="entity"><span>compilation</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>extract_mode</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.Pair|const"><span>Pair</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="entity"><span>Pair</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>extract_mode</span></span><span> </span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extract_mode</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>extract_mode</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>output_names</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>Output</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Input</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>extract_mode</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Input</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>user_mode</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="entity"><span>Fun</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>extract_mode</span></span><span> </span><span class="entity"><span>all_args</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Bool</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>valid</span></span><span> </span><span class="entity"><span>modes1</span></span><span> </span><span class="entity"><span>modes2</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>int_ord</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>modes1</span></span><span class="main"><span>,</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>modes2</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>GREATER</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Not enough mode annotations"</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>LESS</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Too many mode annotations"</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>EQUAL</span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>m2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>eq_mode</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>modes1</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>modes2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mode_instance_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>instance_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Fun</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Input</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>instance_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Input</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Input</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>instance_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Output</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Output</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>instance_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Pair</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Pair</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m1'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m2'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                  </span><span class="entity"><span>instance_of</span></span><span>  </span><span class="main"><span>(</span></span><span class="entity"><span>m1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m1'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>instance_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m2'</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>instance_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Pair</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Input</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                  </span><span class="entity"><span>instance_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Input</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>instance_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Input</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>instance_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Pair</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Output</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                  </span><span class="entity"><span>instance_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Output</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>instance_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Output</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>instance_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Input</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Pair</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                  </span><span class="entity"><span>instance_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Input</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m1</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>instance_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Input</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m2</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>instance_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Output</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Pair</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                  </span><span class="entity"><span>instance_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Output</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m1</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>instance_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Output</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m2</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>instance_of</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>forall</span><span> </span><span class="entity"><span>instance_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>strip_fun_mode</span></span><span> </span><span class="entity"><span>m1</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>strip_fun_mode</span></span><span> </span><span class="entity"><span>m2</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>derivs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>all_derivations_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>all_modes_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>body</span></span><span>
          </span><span>|&gt;</span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>d</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>missing_vars</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p_mode</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>modes</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>collect_context_modes</span></span><span> </span><span class="entity"><span>d</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span>null</span><span> </span><span class="entity"><span>missing_vars</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
              </span><span class="entity"><span>mode_instance_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p_mode</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>user_mode</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
              </span><span>the_default</span><span> </span><span>true</span><span> </span><span class="main"><span>(</span></span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>valid</span></span><span> </span><span class="entity"><span>modes</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>param_user_modes</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span>fst</span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>deriv</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>derivs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"No mode possible for comprehension "</span></span><span> </span><span>^</span><span> </span><span>Syntax.string_of_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t_compr</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>d</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>d</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>d</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="main"><span>(</span></span><span>warning</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Multiple modes possible for comprehension "</span></span><span> </span><span>^</span><span>
                </span><span>Syntax.string_of_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t_compr</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><span class="entity"><span>d</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>outargs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>split_mode</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>head_mode_of</span></span><span> </span><span class="entity"><span>deriv</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>all_args</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t_pred</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>compile_expr</span></span><span> </span><span class="entity"><span>comp_modifiers</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>body</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>deriv</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>additional_arguments</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T_pred</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_monadT</span></span><span> </span><span class="entity"><span>compfuns</span></span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>t_pred</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>arrange</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.tupled_lambda</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_tuple</span></span><span> </span><span class="entity"><span>outargs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>output</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>outargs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>t_pred</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>mk_map</span></span><span> </span><span class="entity"><span>compfuns</span></span><span> </span><span class="entity"><span>T_pred</span></span><span> </span><span class="entity"><span>T_compr</span></span><span> </span><span class="entity"><span>arrange</span></span><span> </span><span class="entity"><span>t_pred</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span>error</span><span> </span><span class="inner_quoted"><span>"Evaluation with values is not possible because compilation with code_pred was not invoked"</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>eval</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>stats</span></span><span> </span><span class="entity"><span>param_user_modes</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>options</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>compilation</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arguments</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>t_compr</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>count</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>count'</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>i</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>count'</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x'</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>x'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>count'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>count'</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>xs</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>count'</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>accumulate</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>count</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>sort</span><span> </span><span>int_ord</span><span> </span><span>o</span><span> </span><span>distinct</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>comp_modifiers</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>compilation</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="entity"><span>Pred</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>predicate_comp_modifiers</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Random</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>random_comp_modifiers</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Depth_Limited</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>depth_limited_comp_modifiers</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Depth_Limited_Random</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>depth_limited_random_comp_modifiers</span></span><span>
      </span><span class="comment1"><span>(*| Annotated =&gt; annotated_comp_modifiers*)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>DSeq</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>dseq_comp_modifiers</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Pos_Random_DSeq</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>pos_random_dseq_comp_modifiers</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>New_Pos_Random_DSeq</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>new_pos_random_dseq_comp_modifiers</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Pos_Generator_DSeq</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>pos_generator_dseq_comp_modifiers</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>compfuns</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Comp_Mod.compfuns</span></span><span> </span><span class="entity"><span>comp_modifiers</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>additional_arguments</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>compilation</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="entity"><span>Pred</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Random</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_number</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Code_Numeral.html#Code_Numeral.natural|type"><span>natural</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>arguments</span></span><span> </span><span>@</span><span>
            </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><span class="main"><span>(</span></span><span class="main"><a class="entity_ref" href="../../../../../Groups.html#Groups.one_class.one|const"><span>1</span></a></span><span class="main"><span>,</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../Groups.html#Groups.one_class.one|const"><span>1</span></a></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>::</span></span><span> </span><a class="entity_ref" href="../../../../../Code_Numeral.html#Code_Numeral.natural|type"><span>natural</span></a><span> </span><span class="main"><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.prod|type"><span>*</span></a></span><span> </span><a class="entity_ref" href="../../../../../Code_Numeral.html#Code_Numeral.natural|type"><span>natural</span></a><span>›</span></span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Annotated</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Depth_Limited</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>HOLogic.mk_number</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Code_Numeral.html#Code_Numeral.natural|type"><span>natural</span></a><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>arguments</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Depth_Limited_Random</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_number</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Code_Numeral.html#Code_Numeral.natural|type"><span>natural</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>arguments</span></span><span> </span><span>@</span><span>
            </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><span class="main"><span>(</span></span><span class="main"><a class="entity_ref" href="../../../../../Groups.html#Groups.one_class.one|const"><span>1</span></a></span><span class="main"><span>,</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../Groups.html#Groups.one_class.one|const"><span>1</span></a></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>::</span></span><span> </span><a class="entity_ref" href="../../../../../Code_Numeral.html#Code_Numeral.natural|type"><span>natural</span></a><span> </span><span class="main"><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.prod|type"><span>*</span></a></span><span> </span><a class="entity_ref" href="../../../../../Code_Numeral.html#Code_Numeral.natural|type"><span>natural</span></a><span>›</span></span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>DSeq</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Pos_Random_DSeq</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>New_Pos_Random_DSeq</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Pos_Generator_DSeq</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>analyze_compr</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>comp_modifiers</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>additional_arguments</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>param_user_modes</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>t_compr</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_monadT</span></span><span> </span><span class="entity"><span>compfuns</span></span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>stats</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>compilation</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>New_Pos_Random_DSeq</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="entity"><span>mk_map</span></span><span> </span><span class="entity"><span>compfuns</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_prodT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.termT</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Code_Numeral.html#Code_Numeral.natural|type"><span>natural</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>(</span></span><span>absdummy</span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_prod</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.term_of_const</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>$</span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span>
            </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Code_Numeral.html#Code_Numeral.natural.natural_of_nat|const"><span>natural_of_nat</span></a><span>›</span></span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.size_const</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>$</span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="entity"><span>mk_map</span></span><span> </span><span class="entity"><span>compfuns</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>HOLogic.termT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.term_of_const</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>time_limit</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>seconds</span><span> </span><span class="main"><span>(</span></span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>values_timeout</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>statistics</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>compilation</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
       </span><span class="comment1"><span>(* Random =&gt;
          fst (Predicate.yieldn k
          (Code_Eval.eval NONE ("Predicate_Compile_Core.random_eval_ref", random_eval_ref)
            (fn proc =&gt; fn g =&gt; fn s =&gt; g s |&gt;&gt; Predicate.map proc) thy t' []
            |&gt; Random_Engine.run))*)</span></span><span>
        </span><span class="entity"><span>Pos_Random_DSeq</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>nrandom</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>size</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>depth</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>Code_Numeral.natural_of_integer</span><span> </span><span class="entity"><span>arguments</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span>rpair</span><span> </span><span>NONE</span><span> </span><span class="main"><span>(</span></span><span>Timeout.apply</span><span> </span><span class="entity"><span>time_limit</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>fst</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Limited_Sequence.yieldn</span></span><span> </span><span class="entity"><span>k</span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>Code_Runtime.dynamic_value_strict</span></span><span>
                </span><span class="main"><span>(</span></span><span class="entity"><span>get_dseq_random_result</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>put_dseq_random_result</span></span><span class="main"><span>,</span></span><span>
                  </span><span class="inner_quoted"><span>"Predicate_Compile_Core.put_dseq_random_result"</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="entity"><span>ctxt</span></span><span> </span><span>NONE</span><span>
                  </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>proc</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>g</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>nrandom</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>size</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                    </span><span class="entity"><span>g</span></span><span> </span><span class="entity"><span>nrandom</span></span><span> </span><span class="entity"><span>size</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span class="entity"><span>Limited_Sequence.map</span></span><span> </span><span class="entity"><span>proc</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="entity"><span>t'</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>nrandom</span></span><span> </span><span class="entity"><span>size</span></span><span>
                </span><span>|&gt;</span><span> </span><span class="entity"><span>Random_Engine.run</span></span><span class="main"><span>)</span></span><span>
              </span><span class="entity"><span>depth</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>DSeq</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span>rpair</span><span> </span><span>NONE</span><span> </span><span class="main"><span>(</span></span><span>Timeout.apply</span><span> </span><span class="entity"><span>time_limit</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>fst</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Limited_Sequence.yieldn</span></span><span> </span><span class="entity"><span>k</span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>Code_Runtime.dynamic_value_strict</span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>get_dseq_result</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>put_dseq_result</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"Predicate_Compile_Core.put_dseq_result"</span></span><span class="main"><span>)</span></span><span>
              </span><span class="entity"><span>ctxt</span></span><span> </span><span>NONE</span><span> </span><span class="entity"><span>Limited_Sequence.map</span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>(</span></span><span>Code_Numeral.natural_of_integer</span><span> </span><span class="main"><span>(</span></span><span>the_single</span><span> </span><span class="entity"><span>arguments</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Pos_Generator_DSeq</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>depth</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Code_Numeral.natural_of_integer</span><span> </span><span class="main"><span>(</span></span><span>the_single</span><span> </span><span class="entity"><span>arguments</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span>rpair</span><span> </span><span>NONE</span><span> </span><span class="main"><span>(</span></span><span>Timeout.apply</span><span> </span><span class="entity"><span>time_limit</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>fst</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Lazy_Sequence.yieldn</span></span><span> </span><span class="entity"><span>k</span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>Code_Runtime.dynamic_value_strict</span></span><span>
                </span><span class="main"><span>(</span></span><span class="entity"><span>get_new_dseq_result</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>put_new_dseq_result</span></span><span class="main"><span>,</span></span><span>
                  </span><span class="inner_quoted"><span>"Predicate_Compile_Core.put_new_dseq_result"</span></span><span class="main"><span>)</span></span><span>
                </span><span class="entity"><span>ctxt</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>proc</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>g</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>depth</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>g</span></span><span> </span><span class="entity"><span>depth</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>Lazy_Sequence.map</span></span><span> </span><span class="entity"><span>proc</span></span><span class="main"><span>)</span></span><span>
                </span><span class="entity"><span>t'</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>depth</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>New_Pos_Random_DSeq</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>nrandom</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>size</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>depth</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>Code_Numeral.natural_of_integer</span><span> </span><span class="entity"><span>arguments</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>seed</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Random_Engine.next_seed</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>stats</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
              </span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span>o</span><span> </span><span class="entity"><span>accumulate</span></span><span> </span><span>o</span><span> </span><span>map</span><span> </span><span>Code_Numeral.integer_of_natural</span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>(</span></span><span>split_list</span><span> </span><span class="main"><span>(</span></span><span>Timeout.apply</span><span> </span><span class="entity"><span>time_limit</span></span><span>
              </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>fst</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Lazy_Sequence.yieldn</span></span><span> </span><span class="entity"><span>k</span></span><span>
                </span><span class="main"><span>(</span></span><span class="entity"><span>Code_Runtime.dynamic_value_strict</span></span><span>
                  </span><span class="main"><span>(</span></span><span class="entity"><span>get_lseq_random_stats_result</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>put_lseq_random_stats_result</span></span><span class="main"><span>,</span></span><span>
                    </span><span class="inner_quoted"><span>"Predicate_Compile_Core.put_lseq_random_stats_result"</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="entity"><span>ctxt</span></span><span> </span><span>NONE</span><span>
                  </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>proc</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>g</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>nrandom</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>size</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>depth</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                    </span><span class="entity"><span>g</span></span><span> </span><span class="entity"><span>nrandom</span></span><span> </span><span class="entity"><span>size</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>depth</span></span><span>
                    </span><span>|&gt;</span><span> </span><span class="entity"><span>Lazy_Sequence.map</span></span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span class="entity"><span>proc</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="entity"><span>t'</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>nrandom</span></span><span> </span><span class="entity"><span>size</span></span><span> </span><span class="entity"><span>seed</span></span><span> </span><span class="entity"><span>depth</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>rpair</span><span> </span><span>NONE</span><span>
              </span><span class="main"><span>(</span></span><span>Timeout.apply</span><span> </span><span class="entity"><span>time_limit</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>fst</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Lazy_Sequence.yieldn</span></span><span> </span><span class="entity"><span>k</span></span><span>
                </span><span class="main"><span>(</span></span><span class="entity"><span>Code_Runtime.dynamic_value_strict</span></span><span>
                  </span><span class="main"><span>(</span></span><span class="entity"><span>get_lseq_random_result</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>put_lseq_random_result</span></span><span class="main"><span>,</span></span><span>
                    </span><span class="inner_quoted"><span>"Predicate_Compile_Core.put_lseq_random_result"</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="entity"><span>ctxt</span></span><span> </span><span>NONE</span><span>
                    </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>proc</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>g</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>nrandom</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>size</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>depth</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                      </span><span class="entity"><span>g</span></span><span> </span><span class="entity"><span>nrandom</span></span><span> </span><span class="entity"><span>size</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>depth</span></span><span>
                      </span><span>|&gt;</span><span> </span><span class="entity"><span>Lazy_Sequence.map</span></span><span> </span><span class="entity"><span>proc</span></span><span class="main"><span>)</span></span><span>
                      </span><span class="entity"><span>t'</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>nrandom</span></span><span> </span><span class="entity"><span>size</span></span><span> </span><span class="entity"><span>seed</span></span><span> </span><span class="entity"><span>depth</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span>rpair</span><span> </span><span>NONE</span><span> </span><span class="main"><span>(</span></span><span>Timeout.apply</span><span> </span><span class="entity"><span>time_limit</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>fst</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Predicate.yieldn</span></span><span> </span><span class="entity"><span>k</span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>Code_Runtime.dynamic_value_strict</span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>get_pred_result</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>put_pred_result</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"Predicate_Compile_Core.put_pred_result"</span></span><span class="main"><span>)</span></span><span>
              </span><span class="entity"><span>ctxt</span></span><span> </span><span>NONE</span><span> </span><span class="entity"><span>Predicate.map</span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
     </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Timeout.TIMEOUT</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Reached timeout during execution of values"</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>statistics</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>values</span></span><span> </span><span class="entity"><span>param_user_modes</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>raw_expected</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>stats</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>comp_options</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>t_compr</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>statistics</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eval</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>stats</span></span><span> </span><span class="entity"><span>param_user_modes</span></span><span> </span><span class="entity"><span>comp_options</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>t_compr</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>setT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.mk_setT</span></span><span> </span><span class="entity"><span>T</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>elems</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.mk_set</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>ts</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>dots</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Proof_Context.add_fixes</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="inner_quoted"><span>"dots"</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>setT</span></span><span class="main"><span>,</span></span><span> </span><span>Mixfix.mixfix</span><span> </span><span class="inner_quoted"><span>"..."</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
    </span><span class="comment1"><span>(* check expected values *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>union</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_abbrev</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Set.html#Set.union|const"><span>Set.union</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>setT</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>setT</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>setT</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>raw_expected</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>eq_set</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.dest_set</span></span><span> </span><span class="main"><span>(</span></span><span>Syntax.read_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"expected and computed values do not match:\n"</span></span><span> </span><span>^</span><span>
            </span><span class="inner_quoted"><span>"expected values: "</span></span><span> </span><span>^</span><span> </span><span>Syntax.string_of_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>Syntax.read_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"\n"</span></span><span> </span><span>^</span><span>
            </span><span class="inner_quoted"><span>"computed values: "</span></span><span> </span><span>^</span><span> </span><span>Syntax.string_of_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>elems</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"\n"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>length</span><span> </span><span class="entity"><span>ts</span></span><span> </span><span>&lt;</span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>elems</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>union</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>elems</span></span><span> </span><span>$</span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dots</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>setT</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>statistics</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
      </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>values_cmd</span></span><span> </span><span class="entity"><span>print_modes</span></span><span> </span><span class="entity"><span>param_user_modes</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>raw_t</span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Toplevel.context_of</span></span><span> </span><span class="entity"><span>state</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax.read_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>raw_t</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>t'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>stats</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>values</span></span><span> </span><span class="entity"><span>param_user_modes</span></span><span> </span><span class="entity"><span>options</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ty'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.type_of</span><span> </span><span class="entity"><span>t'</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt''</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.augment</span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pretty_stat</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>stats</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>total</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>+</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>snd</span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pretty_entry</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"size"</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>
               </span><span>Pretty.str</span><span> </span><span class="main"><span>(</span></span><span>string_of_int</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>":"</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>
               </span><span>Pretty.str</span><span> </span><span class="main"><span>(</span></span><span>string_of_int</span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.fbrk</span><span class="main"><span>]</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="main"><span>[</span></span><span>Pretty.fbrk</span><span class="main"><span>,</span></span><span> </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"Statistics:"</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.fbrk</span><span class="main"><span>,</span></span><span>
             </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"total:"</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.str</span><span> </span><span class="main"><span>(</span></span><span>string_of_int</span><span> </span><span class="entity"><span>total</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.fbrk</span><span class="main"><span>]</span></span><span> </span><span>@</span><span>
              </span><span>maps</span><span> </span><span class="entity"><span>pretty_entry</span></span><span> </span><span class="entity"><span>xs</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>Print_Mode.with_modes</span><span> </span><span class="entity"><span>print_modes</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span>Pretty.block</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span>Pretty.quote</span><span> </span><span class="main"><span>(</span></span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt''</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.fbrk</span><span class="main"><span>,</span></span><span>
        </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"::"</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.quote</span><span> </span><span class="main"><span>(</span></span><span>Syntax.pretty_typ</span><span> </span><span class="entity"><span>ctxt''</span></span><span> </span><span class="entity"><span>ty'</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
        </span><span>@</span><span> </span><span class="entity"><span>pretty_stat</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span> </span><span>|&gt;</span><span> </span><span>Pretty.writeln</span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span></pre>
</body>

</html>