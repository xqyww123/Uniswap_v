<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Tools/Ctr_Sugar/ctr_sugar.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Tools/Ctr_Sugar/ctr_sugar.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      HOL/Tools/Ctr_Sugar/ctr_sugar.ML
    Author:     Jasmin Blanchette, TU Muenchen
    Author:     Martin Desharnais, TU Muenchen
    Copyright   2012, 2013

Wrapping existing freely generated type's constructors.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>CTR_SUGAR</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>ctr_sugar_kind</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Datatype</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Codatatype</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Record</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Unknown</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>ctr_sugar</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>{</span></span><span>kind</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ctr_sugar_kind</span></span><span class="main"><span>,</span></span><span>
     </span><span>T</span><span class="main"><span>:</span></span><span> </span><span>typ</span><span class="main"><span>,</span></span><span>
     </span><span>ctrs</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     </span><span>casex</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>,</span></span><span>
     </span><span>discs</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     </span><span>selss</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     </span><span>exhaust</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span>
     </span><span>nchotomy</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span>
     </span><span>injects</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     </span><span>distincts</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     </span><span>case_thms</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     </span><span>case_cong</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span>
     </span><span>case_cong_weak</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span>
     </span><span>case_distribs</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     </span><span>split</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span>
     </span><span>split_asm</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span>
     </span><span>disc_defs</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     </span><span>disc_thmss</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     </span><span>discIs</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     </span><span>disc_eq_cases</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     </span><span>sel_defs</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     </span><span>sel_thmss</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     </span><span>distinct_discsss</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span>list</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     </span><span>exhaust_discs</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     </span><span>exhaust_sels</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     </span><span>collapses</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     </span><span>expands</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     </span><span>split_sels</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     </span><span>split_sel_asms</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     </span><span>case_eq_ifs</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> morph_ctr_sugar</span><span class="main"><span>:</span></span><span> </span><span>morphism</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ctr_sugar</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ctr_sugar</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> transfer_ctr_sugar</span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ctr_sugar</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ctr_sugar</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> ctr_sugar_of</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ctr_sugar</span></span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> ctr_sugar_of_global</span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ctr_sugar</span></span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> ctr_sugars_of</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ctr_sugar</span></span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> ctr_sugars_of_global</span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ctr_sugar</span></span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> ctr_sugar_of_case</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ctr_sugar</span></span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> ctr_sugar_of_case_global</span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ctr_sugar</span></span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> ctr_sugar_interpretation</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctr_sugar</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span>theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> interpret_ctr_sugar</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ctr_sugar</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> register_ctr_sugar_raw</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ctr_sugar</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> register_ctr_sugar</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ctr_sugar</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> default_register_ctr_sugar_global</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ctr_sugar</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_half_pairss</span><span class="main"><span>:</span></span><span> </span><span>'a</span><span> </span><span>list</span><span> * </span><span>'a</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>'a</span><span> * </span><span>'a</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> join_halves</span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>'a</span><span> </span><span>list</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>'a</span><span> </span><span>list</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>'a</span><span> </span><span>list</span><span> * </span><span>'a</span><span> </span><span>list</span><span> </span><span>list</span><span> </span><span>list</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_ctr</span><span class="main"><span>:</span></span><span> </span><span>typ</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_case</span><span class="main"><span>:</span></span><span> </span><span>typ</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_disc_or_sel</span><span class="main"><span>:</span></span><span> </span><span>typ</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> name_of_ctr</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> name_of_disc</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> dest_ctr</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> * </span><span>term</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> dest_case</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>ctr_sugar</span></span><span> * </span><span>term</span><span> </span><span>list</span><span> * </span><span>term</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>option</span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="main"><span>(</span></span><span>'c</span><span class="main"><span>,</span></span><span> </span><span>'a</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctr_spec</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>binding</span><span> * </span><span>'c</span><span class="main"><span>)</span></span><span> * </span><span>'a</span><span> </span><span>list</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> disc_of_ctr_spec</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>'c</span><span class="main"><span>,</span></span><span> </span><span>'a</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctr_spec</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>binding</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> ctr_of_ctr_spec</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>'c</span><span class="main"><span>,</span></span><span> </span><span>'a</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctr_spec</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>'c</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> args_of_ctr_spec</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>'c</span><span class="main"><span>,</span></span><span> </span><span>'a</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctr_spec</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>'a</span><span> </span><span>list</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> code_plugin</span><span class="main"><span>:</span></span><span> </span><span>string</span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>ctr_options</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span class="main"><span>)</span></span><span> * </span><span>bool</span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>ctr_options_cmd</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span class="main"><span>)</span></span><span> * </span><span>bool</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> fake_local_theory_for_sel_defaults</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>binding</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> free_constructors</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ctr_sugar_kind</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span>prems</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span> </span><span>context</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>ctr_options</span></span><span> * </span><span>binding</span><span class="main"><span>)</span></span><span> * </span><span class="main"><span>(</span></span><span>term</span><span class="main"><span>,</span></span><span> </span><span>binding</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctr_spec</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> * </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="entity"><span>ctr_sugar</span></span><span> * </span><span>local_theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> free_constructors_cmd</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ctr_sugar_kind</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Plugin_Name.filter</span></span><span class="main"><span>)</span></span><span> * </span><span>bool</span><span class="main"><span>)</span></span><span> * </span><span>binding</span><span class="main"><span>)</span></span><span>
     * </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>binding</span><span> * </span><span>string</span><span class="main"><span>)</span></span><span> * </span><span>binding</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> * </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.state</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> default_ctr_options</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ctr_options</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> default_ctr_options_cmd</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ctr_options_cmd</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> parse_bound_term</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>binding</span><span> * </span><span>string</span><span class="main"><span>)</span></span><span> </span><span>parser</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> parse_ctr_options</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ctr_options_cmd</span></span><span> </span><span>parser</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> parse_ctr_spec</span><span class="main"><span>:</span></span><span> </span><span>'c</span><span> </span><span>parser</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>'a</span><span> </span><span>parser</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>'c</span><span class="main"><span>,</span></span><span> </span><span>'a</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctr_spec</span></span><span> </span><span>parser</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> parse_sel_default_eqs</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span>parser</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Ctr_Sugar</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>CTR_SUGAR</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Ctr_Sugar_Util</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Ctr_Sugar_Tactics</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Ctr_Sugar_Code</span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>ctr_sugar_kind</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Datatype</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Codatatype</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Record</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Unknown</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>ctr_sugar</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>kind</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ctr_sugar_kind</span></span><span class="main"><span>,</span></span><span>
   </span><span>T</span><span class="main"><span>:</span></span><span> </span><span>typ</span><span class="main"><span>,</span></span><span>
   </span><span>ctrs</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   </span><span>casex</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>,</span></span><span>
   </span><span>discs</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   </span><span>selss</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   </span><span>exhaust</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span>
   </span><span>nchotomy</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span>
   </span><span>injects</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   </span><span>distincts</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   </span><span>case_thms</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   </span><span>case_cong</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span>
   </span><span>case_cong_weak</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span>
   </span><span>case_distribs</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   </span><span>split</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span>
   </span><span>split_asm</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span>
   </span><span>disc_defs</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   </span><span>disc_thmss</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   </span><span>discIs</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   </span><span>disc_eq_cases</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   </span><span>sel_defs</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   </span><span>sel_thmss</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   </span><span>distinct_discsss</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span>list</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   </span><span>exhaust_discs</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   </span><span>exhaust_sels</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   </span><span>collapses</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   </span><span>expands</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   </span><span>split_sels</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   </span><span>split_sel_asms</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   </span><span>case_eq_ifs</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>morph_ctr_sugar</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>kind</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctrs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>casex</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>discs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>selss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>exhaust</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nchotomy</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>injects</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>distincts</span></span><span class="main"><span>,</span></span><span>
    </span><span class="entity"><span>case_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>case_cong</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>case_cong_weak</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>case_distribs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>split</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>split_asm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>disc_defs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>disc_thmss</span></span><span class="main"><span>,</span></span><span>
    </span><span class="entity"><span>discIs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>disc_eq_cases</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sel_defs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sel_thmss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>distinct_discsss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>exhaust_discs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>exhaust_sels</span></span><span class="main"><span>,</span></span><span>
    </span><span class="entity"><span>collapses</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>expands</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>split_sels</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>split_sel_asms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>case_eq_ifs</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ctr_sugar</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>kind</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>kind</span></span><span class="main"><span>,</span></span><span>
   </span><span>T</span><span> </span><span class="main"><span>=</span></span><span> </span><span>Morphism.typ</span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span>
   </span><span>ctrs</span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Morphism.term</span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctrs</span></span><span class="main"><span>,</span></span><span>
   </span><span>casex</span><span> </span><span class="main"><span>=</span></span><span> </span><span>Morphism.term</span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>casex</span></span><span class="main"><span>,</span></span><span>
   </span><span>discs</span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Morphism.term</span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>discs</span></span><span class="main"><span>,</span></span><span>
   </span><span>selss</span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Morphism.term</span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>selss</span></span><span class="main"><span>,</span></span><span>
   </span><span>exhaust</span><span> </span><span class="main"><span>=</span></span><span> </span><span>Morphism.thm</span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>exhaust</span></span><span class="main"><span>,</span></span><span>
   </span><span>nchotomy</span><span> </span><span class="main"><span>=</span></span><span> </span><span>Morphism.thm</span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>nchotomy</span></span><span class="main"><span>,</span></span><span>
   </span><span>injects</span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Morphism.thm</span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>injects</span></span><span class="main"><span>,</span></span><span>
   </span><span>distincts</span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Morphism.thm</span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>distincts</span></span><span class="main"><span>,</span></span><span>
   </span><span>case_thms</span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Morphism.thm</span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>case_thms</span></span><span class="main"><span>,</span></span><span>
   </span><span>case_cong</span><span> </span><span class="main"><span>=</span></span><span> </span><span>Morphism.thm</span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>case_cong</span></span><span class="main"><span>,</span></span><span>
   </span><span>case_cong_weak</span><span> </span><span class="main"><span>=</span></span><span> </span><span>Morphism.thm</span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>case_cong_weak</span></span><span class="main"><span>,</span></span><span>
   </span><span>case_distribs</span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Morphism.thm</span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>case_distribs</span></span><span class="main"><span>,</span></span><span>
   </span><span>split</span><span> </span><span class="main"><span>=</span></span><span> </span><span>Morphism.thm</span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>split</span></span><span class="main"><span>,</span></span><span>
   </span><span>split_asm</span><span> </span><span class="main"><span>=</span></span><span> </span><span>Morphism.thm</span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>split_asm</span></span><span class="main"><span>,</span></span><span>
   </span><span>disc_defs</span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Morphism.thm</span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>disc_defs</span></span><span class="main"><span>,</span></span><span>
   </span><span>disc_thmss</span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Morphism.thm</span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>disc_thmss</span></span><span class="main"><span>,</span></span><span>
   </span><span>discIs</span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Morphism.thm</span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>discIs</span></span><span class="main"><span>,</span></span><span>
   </span><span>disc_eq_cases</span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Morphism.thm</span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>disc_eq_cases</span></span><span class="main"><span>,</span></span><span>
   </span><span>sel_defs</span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Morphism.thm</span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sel_defs</span></span><span class="main"><span>,</span></span><span>
   </span><span>sel_thmss</span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Morphism.thm</span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sel_thmss</span></span><span class="main"><span>,</span></span><span>
   </span><span>distinct_discsss</span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Morphism.thm</span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>distinct_discsss</span></span><span class="main"><span>,</span></span><span>
   </span><span>exhaust_discs</span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Morphism.thm</span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>exhaust_discs</span></span><span class="main"><span>,</span></span><span>
   </span><span>exhaust_sels</span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Morphism.thm</span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>exhaust_sels</span></span><span class="main"><span>,</span></span><span>
   </span><span>collapses</span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Morphism.thm</span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>collapses</span></span><span class="main"><span>,</span></span><span>
   </span><span>expands</span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Morphism.thm</span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>expands</span></span><span class="main"><span>,</span></span><span>
   </span><span>split_sels</span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Morphism.thm</span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>split_sels</span></span><span class="main"><span>,</span></span><span>
   </span><span>split_sel_asms</span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Morphism.thm</span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>split_sel_asms</span></span><span class="main"><span>,</span></span><span>
   </span><span>case_eq_ifs</span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Morphism.thm</span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>case_eq_ifs</span></span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>transfer_ctr_sugar</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>morph_ctr_sugar</span></span><span> </span><span>o</span><span> </span><span>Morphism.transfer_morphism</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Generic_Data</span><span>
</span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Position.T</span><span> * </span><span class="entity"><span>ctr_sugar</span></span><span class="main"><span>)</span></span><span> </span><span>Symtab.table</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.empty</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>merge</span></span><span> </span><span class="entity"><span>data</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.merge</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>data</span></span><span class="main"><span>;</span></span><span>
</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ctr_sugar_of_generic</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>transfer_ctr_sugar</span></span><span> </span><span class="main"><span>(</span></span><span>Context.theory_of</span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>Symtab.lookup</span><span> </span><span class="main"><span>(</span></span><span>Data.get</span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ctr_sugars_of_generic</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Symtab.fold</span><span> </span><span class="main"><span>(</span></span><span>cons</span><span> </span><span>o</span><span> </span><span class="entity"><span>transfer_ctr_sugar</span></span><span> </span><span class="main"><span>(</span></span><span>Context.theory_of</span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Data.get</span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ctr_sugar_of_case_generic</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>find_first</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>casex</span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>s'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>ctr_sugars_of_generic</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctr_sugar_of</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctr_sugar_of_generic</span></span><span> </span><span>o</span><span> </span><span>Context.Proof</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctr_sugar_of_global</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctr_sugar_of_generic</span></span><span> </span><span>o</span><span> </span><span>Context.Theory</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctr_sugars_of</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctr_sugars_of_generic</span></span><span> </span><span>o</span><span> </span><span>Context.Proof</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctr_sugars_of_global</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctr_sugars_of_generic</span></span><span> </span><span>o</span><span> </span><span>Context.Theory</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctr_sugar_of_case</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctr_sugar_of_case_generic</span></span><span> </span><span>o</span><span> </span><span>Context.Proof</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctr_sugar_of_case_global</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctr_sugar_of_case_generic</span></span><span> </span><span>o</span><span> </span><span>Context.Theory</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Ctr_Sugar_Plugin</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Plugin</span></span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctr_sugar</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ctr_sugar_interpretation</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Ctr_Sugar_Plugin.interpretation</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctr_sugar</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>transfer_ctr_sugar</span></span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctr_sugar</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>interpret_ctr_sugar</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Ctr_Sugar_Plugin.data</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>register_ctr_sugar_raw</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctr_sugar</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span>T</span><span> </span><span class="main"><span>=</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Local_Theory.declaration</span><span> </span><span class="main"><span>{</span></span><span>syntax</span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span> </span><span>pervasive</span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span class="main"><span>}</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Position.thread_data</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Data.map</span><span> </span><span class="main"><span>(</span></span><span>Symtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>morph_ctr_sugar</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>ctr_sugar</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>register_ctr_sugar</span></span><span> </span><span class="entity"><span>plugins</span></span><span> </span><span class="entity"><span>ctr_sugar</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>register_ctr_sugar_raw</span></span><span> </span><span class="entity"><span>ctr_sugar</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>interpret_ctr_sugar</span></span><span> </span><span class="entity"><span>plugins</span></span><span> </span><span class="entity"><span>ctr_sugar</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>default_register_ctr_sugar_global</span></span><span> </span><span class="entity"><span>plugins</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctr_sugar</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span>T</span><span> </span><span class="main"><span>=</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Data.get</span><span> </span><span class="main"><span>(</span></span><span>Context.Theory</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Position.thread_data</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Symtab.defined</span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>thy</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="entity"><span>thy</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Context.theory_map</span><span> </span><span class="main"><span>(</span></span><span>Data.put</span><span> </span><span class="main"><span>(</span></span><span>Symtab.update_new</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctr_sugar</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tab</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>Named_Target.theory_map</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ctr_Sugar_Plugin.data</span></span><span> </span><span class="entity"><span>plugins</span></span><span> </span><span class="entity"><span>ctr_sugar</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>is_prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"is_"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>un_prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"un_"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>not_prefix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"not_"</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_unN</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>suf</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>un_prefix</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>suf</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk_unN</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="entity"><span>suf</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>un_prefix</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>suf</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>caseN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"case"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>case_congN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"case_cong"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>case_eq_ifN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"case_eq_if"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>collapseN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"collapse"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>discN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"disc"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>disc_eq_caseN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"disc_eq_case"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>discIN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"discI"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>distinctN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"distinct"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>distinct_discN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"distinct_disc"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>exhaustN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"exhaust"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>exhaust_discN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"exhaust_disc"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>expandN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"expand"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>injectN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"inject"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nchotomyN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"nchotomy"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>selN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"sel"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>exhaust_selN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"exhaust_sel"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>splitN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"split"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>split_asmN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"split_asm"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>split_selN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"split_sel"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>split_sel_asmN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"split_sel_asm"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>splitsN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"splits"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>split_selsN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"split_sels"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>case_cong_weak_thmsN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"case_cong_weak"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>case_distribN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"case_distrib"</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cong_attrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><span class="operator"><span>cong</span></span><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dest_attrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="../../../Provers/classical.ML.html#HOL.dest|attribute"><span class="operator"><span>dest</span></span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>safe_elim_attrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="../../../Provers/classical.ML.html#HOL.elim|attribute"><span class="operator"><span>elim</span></span></a><span>!</span><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>iff_attrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="../../../Provers/clasimp.ML.html#HOL.iff|attribute"><span class="operator"><span>iff</span></span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inductsimp_attrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="../../../Tools/induct.ML.html#HOL.induct_simp|attribute"><span class="operator"><span>induct_simp</span></span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nitpicksimp_attrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="../../../../../HOL.html#HOL.nitpick_simp|attribute"><span class="operator"><span>nitpick_simp</span></span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>simp_attrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><span class="operator"><span>simp</span></span><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unflat_lookup</span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="entity"><span>ys</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>xs'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>permute_like_unique</span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="entity"><span>xs'</span></span><span> </span><span class="entity"><span>ys</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_half_pairss'</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk_half_pairss'</span></span><span> </span><span class="entity"><span>indent</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ys</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>indent</span></span><span> </span><span>@</span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span>cons</span><span> </span><span>o</span><span> </span><span>single</span><span> </span><span>o</span><span> </span><span>pair</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ys</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_half_pairss'</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>indent</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>xs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ys</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_half_pairss</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_half_pairss'</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>join_halves</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>half_xss</span></span><span> </span><span class="entity"><span>other_half_xss</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>splice</span></span><span> </span><span class="main"><span>(</span></span><span>flat</span><span> </span><span class="entity"><span>half_xss</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>flat</span><span> </span><span class="entity"><span>other_half_xss</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span>append</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Library.chop_groups</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>half_xss</span></span><span class="main"><span>)</span></span><span>
     </span><span class="main"><span>(</span></span><span class="entity"><span>transpose</span></span><span> </span><span class="main"><span>(</span></span><span>Library.chop_groups</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>other_half_xss</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_undefined</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.undefined|const"><span>undefined</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_ctr</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts0</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>body_type</span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>subst_nonatomic_types</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ts0</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_case</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>strip_type</span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span>List.last</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>subst_nonatomic_types</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>body</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ts0</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_disc_or_sel</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>subst_nonatomic_types</span></span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span class="main"><span>(</span></span><span>Term.dest_Type</span><span> </span><span class="main"><span>(</span></span><span>domain_type</span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name_of_ctr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>name_of_const</span></span><span> </span><span class="inner_quoted"><span>"constructor"</span></span><span> </span><span>body_type</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>name_of_disc</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>head_of</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>Not</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>t'</span></span><span> </span><span>$</span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span>›</span></span><span>›</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span>Long_Name.map_base_name</span><span> </span><span class="main"><span>(</span></span><span>prefix</span><span> </span><span class="entity"><span>not_prefix</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name_of_disc</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span> </span><span class="main"><span>_</span></span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="quoted"><span>‹</span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span>›</span></span><span> </span><span class="entity"><span>t'</span></span><span>›</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span>Long_Name.map_base_name</span><span> </span><span class="main"><span>(</span></span><span>prefix</span><span> </span><span class="entity"><span>is_prefix</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name_of_disc</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>Not</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span> </span><span class="main"><span>_</span></span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="quoted"><span>‹</span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span>›</span></span><span> </span><span class="entity"><span>t'</span></span><span>›</span></span></span><span>›</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span>Long_Name.map_base_name</span><span> </span><span class="main"><span>(</span></span><span>prefix</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>not_prefix</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>is_prefix</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name_of_disc</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>name_of_const</span></span><span> </span><span class="inner_quoted"><span>"discriminator"</span></span><span> </span><span class="main"><span>(</span></span><span>perhaps</span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span>domain_type</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>base_name_of_ctr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Long_Name.base_name</span><span> </span><span>o</span><span> </span><span class="entity"><span>name_of_ctr</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_ctr</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.strip_comb</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>ctr_sugar_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>SOME</span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>ctrs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>find_first</span><span> </span><span class="main"><span>(</span></span><span>can</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fo_match</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctrs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>SOME</span><span> </span><span class="entity"><span>f'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"dest_ctr"</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"dest_ctr"</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_case</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Term.strip_comb</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>ctr_sugar_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctr_sugar</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span>casex</span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>case_name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>discs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>discs0</span></span><span class="main"><span>,</span></span><span> </span><span>selss</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>selss0</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>case_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>discs0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>&lt;</span><span> </span><span>length</span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>branches</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>obj</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>leftovers</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>chop</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>;</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>discs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_disc_or_sel</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>discs0</span></span><span class="main"><span>;</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>selss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_disc_or_sel</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>selss0</span></span><span class="main"><span>;</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>conds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rapp</span></span><span> </span><span class="entity"><span>obj</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>discs</span></span><span class="main"><span>;</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>branch_argss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>sels</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rapp</span></span><span> </span><span class="entity"><span>obj</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sels</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>leftovers</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>selss</span></span><span class="main"><span>;</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>branches'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span>Term.betapplys</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>branches</span></span><span> </span><span class="entity"><span>branch_argss</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctr_sugar</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>conds</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>branches'</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span>NONE</span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span>NONE</span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>const_or_free_name</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Long_Name.base_name</span><span> </span><span class="entity"><span>s</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>const_or_free_name</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>const_or_free_name</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"const_or_free_name"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>extract_sel_default</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>malformed</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Malformed selector default value equation: "</span></span><span> </span><span>^</span><span> </span><span>Syntax.string_of_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>sel</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>fst</span><span> </span><span class="main"><span>(</span></span><span>Term.replace_dummy_patterns</span><span> </span><span class="main"><span>(</span></span><span>Syntax.check_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>HOLogic.dest_eq</span></span><span>
      </span><span>|&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span>Term.dest_comb</span><span>
        </span><span>#&gt;&gt;</span><span> </span><span class="entity"><span>const_or_free_name</span></span><span>
        </span><span>##&gt;</span><span> </span><span class="main"><span>(</span></span><span>Term.strip_comb</span><span> </span><span>#&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span>Term.dest_Const</span><span> </span><span>#&gt;</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>malformed</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span>is_Free</span><span> </span><span>orf</span><span> </span><span>is_Var</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>has_duplicates</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconv</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>ctr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sel</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>fold_rev</span><span> </span><span>Term.lambda</span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="entity"><span>malformed</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* Ideally, we would enrich the context with constants rather than free variables. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fake_local_theory_for_sel_defaults</span></span><span> </span><span class="entity"><span>sel_bTs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Proof_Context.allow_dummies</span><span>
  </span><span>#&gt;</span><span> </span><span>Proof_Context.add_fixes</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span>NoSyn</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sel_bTs</span></span><span class="main"><span>)</span></span><span>
  </span><span>#&gt;</span><span> </span><span>snd</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="main"><span>(</span></span><span>'c</span><span class="main"><span>,</span></span><span> </span><span>'a</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctr_spec</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>binding</span><span> * </span><span>'c</span><span class="main"><span>)</span></span><span> * </span><span>'a</span><span> </span><span>list</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>disc_of_ctr_spec</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>disc</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>disc</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ctr_of_ctr_spec</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctr</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctr</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>args_of_ctr_spec</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>code_plugin</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Plugin_Name.declare_setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>code</span><span>›</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prepare_free_constructors</span></span><span> </span><span class="entity"><span>kind</span></span><span> </span><span class="entity"><span>prep_plugins</span></span><span> </span><span class="entity"><span>prep_term</span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>raw_plugins</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>discs_sels</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>raw_case_binding</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctr_specs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sel_default_eqs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>no_defs_lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>plugins</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prep_plugins</span></span><span> </span><span class="entity"><span>no_defs_lthy</span></span><span> </span><span class="entity"><span>raw_plugins</span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(* TODO: sanity checks on arguments *)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>raw_ctrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>ctr_of_ctr_spec</span></span><span> </span><span class="entity"><span>ctr_specs</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>raw_disc_bindings</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>disc_of_ctr_spec</span></span><span> </span><span class="entity"><span>ctr_specs</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>raw_sel_bindingss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>args_of_ctr_spec</span></span><span> </span><span class="entity"><span>ctr_specs</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>raw_ctrs</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ks</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>upto</span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"No constructors specified"</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctrs0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prep_term</span></span><span> </span><span class="entity"><span>no_defs_lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_ctrs</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fcT_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>As0</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>body_type</span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>ctrs0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>Type</span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>T'</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Expected type constructor in body type of constructor"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T_name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>T_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fcT_name</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>body_type</span><span>
      </span><span>o</span><span> </span><span>fastype_of</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>tl</span><span> </span><span class="entity"><span>ctrs0</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Constructors not constructing same type"</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fc_b_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Long_Name.base_name</span><span> </span><span class="entity"><span>fcT_name</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fc_b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Binding.name</span><span> </span><span class="entity"><span>fc_b_name</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>mandatory</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Binding.qualify</span><span> </span><span class="entity"><span>mandatory</span></span><span> </span><span class="entity"><span>fc_b_name</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unsorted_As</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>B</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>C</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>no_defs_lthy</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>variant_tfrees</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span class="entity"><span>dest_TFree_or_TVar</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>As0</span></span><span class="main"><span>)</span></span><span>
      </span><span>||&gt;</span><span> </span><span>fst</span><span> </span><span>o</span><span> </span><span class="entity"><span>mk_TFrees</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>resort_tfree_or_tvar</span></span><span> </span><span>o</span><span> </span><span>snd</span><span> </span><span>o</span><span> </span><span class="entity"><span>dest_TFree_or_TVar</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>As0</span></span><span> </span><span class="entity"><span>unsorted_As</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fcT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fcT_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_ctr</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctrs0</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctr_Tss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>binder_types</span><span> </span><span>o</span><span> </span><span>fastype_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctrs</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>length</span><span> </span><span class="entity"><span>ctr_Tss</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>can_definitely_rely_on_disc</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>Binding.is_empty</span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>raw_disc_bindings</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>nth</span><span> </span><span class="entity"><span>ms</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>can_rely_on_disc</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>can_definitely_rely_on_disc</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>can_definitely_rely_on_disc</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>should_omit_disc_binding</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>can_rely_on_disc</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>3</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>equal_binding</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹=›</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_disc_binding_valid</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>Binding.is_empty</span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>Binding.eq_name</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>equal_binding</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>standard_disc_binding</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Binding.name</span><span> </span><span>o</span><span> </span><span>prefix</span><span> </span><span class="entity"><span>is_prefix</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>base_name_of_ctr</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>disc_bindings</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>raw_disc_bindings</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 4</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctr</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>disc</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>qualify</span></span><span> </span><span>false</span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Binding.is_empty</span><span> </span><span class="entity"><span>disc</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>equal_binding</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>should_omit_disc_binding</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>disc</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>standard_disc_binding</span></span><span> </span><span class="entity"><span>ctr</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Binding.eq_name</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>disc</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>standard_binding</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
             </span><span class="entity"><span>standard_disc_binding</span></span><span> </span><span class="entity"><span>ctr</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
             </span><span class="entity"><span>disc</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ks</span></span><span> </span><span class="entity"><span>ms</span></span><span> </span><span class="entity"><span>ctrs0</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>standard_sel_binding</span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Binding.name</span><span> </span><span>o</span><span> </span><span class="entity"><span>mk_unN</span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>base_name_of_ctr</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sel_bindingss</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 3</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctr</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>sel</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>qualify</span></span><span> </span><span>false</span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Binding.is_empty</span><span> </span><span class="entity"><span>sel</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>Binding.eq_name</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sel</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>standard_binding</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="entity"><span>standard_sel_binding</span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="entity"><span>ctr</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span class="entity"><span>sel</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span>upto</span><span> </span><span class="entity"><span>m</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>pad_list</span></span><span> </span><span>Binding.empty</span><span> </span><span class="entity"><span>m</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctrs0</span></span><span> </span><span class="entity"><span>ms</span></span><span> </span><span class="entity"><span>raw_sel_bindingss</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>add_bindings</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Variable.add_fixes</span><span> </span><span class="main"><span>(</span></span><span>distinct</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>filter</span><span> </span><span>Symbol_Pos.is_identifier</span><span>
        </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Binding.name_of</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>disc_bindings</span></span><span> </span><span>@</span><span> </span><span>flat</span><span> </span><span class="entity"><span>sel_bindingss</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>#&gt;</span><span> </span><span>snd</span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>case_Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span>---&gt;</span><span> </span><span class="entity"><span>B</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctr_Tss</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>exh_y</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xss</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>yss</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>w</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>no_defs_lthy</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>add_bindings</span></span><span>
      </span><span>|&gt;</span><span> </span><span>yield_singleton</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_Frees</span></span><span> </span><span class="entity"><span>fc_b_name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fcT</span></span><span>
      </span><span>||&gt;&gt;</span><span> </span><span>yield_singleton</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_Frees</span></span><span> </span><span class="inner_quoted"><span>"y"</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fcT</span></span><span> </span><span class="comment1"><span>(* for compatibility with "datatype_realizer.ML" *)</span></span><span>
      </span><span>||&gt;&gt;</span><span> </span><span class="entity"><span>mk_Freess</span></span><span> </span><span class="inner_quoted"><span>"x"</span></span><span> </span><span class="entity"><span>ctr_Tss</span></span><span>
      </span><span>||&gt;&gt;</span><span> </span><span class="entity"><span>mk_Freess</span></span><span> </span><span class="inner_quoted"><span>"y"</span></span><span> </span><span class="entity"><span>ctr_Tss</span></span><span>
      </span><span>||&gt;&gt;</span><span> </span><span class="entity"><span>mk_Frees</span></span><span> </span><span class="inner_quoted"><span>"f"</span></span><span> </span><span class="entity"><span>case_Ts</span></span><span>
      </span><span>||&gt;&gt;</span><span> </span><span class="entity"><span>mk_Frees</span></span><span> </span><span class="inner_quoted"><span>"g"</span></span><span> </span><span class="entity"><span>case_Ts</span></span><span>
      </span><span>||&gt;&gt;</span><span> </span><span>yield_singleton</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_Frees</span></span><span> </span><span class="inner_quoted"><span>"z"</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>B</span></span><span>
      </span><span>||&gt;&gt;</span><span> </span><span>yield_singleton</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>~~</span><span class="main"><span>)</span></span><span> </span><span>oo</span><span> </span><span class="entity"><span>mk_Frees'</span></span><span> </span><span class="inner_quoted"><span>"P"</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>HOLogic.boolT</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>q</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>p'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_pred1T</span></span><span> </span><span class="entity"><span>B</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>xctrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span>Term.list_comb</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctrs</span></span><span> </span><span class="entity"><span>xss</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>yctrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span>Term.list_comb</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctrs</span></span><span> </span><span class="entity"><span>yss</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>xfs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span>Term.list_comb</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fs</span></span><span> </span><span class="entity"><span>xss</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>xgs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span>Term.list_comb</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>gs</span></span><span> </span><span class="entity"><span>xss</span></span><span class="main"><span>;</span></span><span>

    </span><span class="comment1"><span>(* TODO: Eta-expension is for compatibility with the old datatype package (but it also provides
       nicer names). Consider removing. *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eta_fs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>fold_rev</span><span> </span><span>Term.lambda</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xss</span></span><span> </span><span class="entity"><span>xfs</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eta_gs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>fold_rev</span><span> </span><span>Term.lambda</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xss</span></span><span> </span><span class="entity"><span>xgs</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>case_binding</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>qualify</span></span><span> </span><span>false</span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Binding.is_empty</span><span> </span><span class="entity"><span>raw_case_binding</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
            </span><span>Binding.eq_name</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>raw_case_binding</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>standard_binding</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
           </span><span>Binding.prefix_name</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>caseN</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"_"</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fc_b</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
           </span><span class="entity"><span>raw_case_binding</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_case_disj</span></span><span> </span><span class="entity"><span>xctr</span></span><span> </span><span class="entity"><span>xf</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>list_exists_free</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_conj</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xctr</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>HOLogic.mk_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>w</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xf</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>case_rhs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span>fold_rev</span><span> </span><span>Term.lambda</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>fs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>u</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.The|const"><span>The</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>B</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>HOLogic.boolT</span></span><span class="main"><span>)</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>B</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span>
         </span><span>Term.lambda</span><span> </span><span class="entity"><span>w</span></span><span> </span><span class="main"><span>(</span></span><span>Library.foldr1</span><span> </span><span class="entity"><span>HOLogic.mk_disj</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 3</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="entity"><span>mk_case_disj</span></span><span> </span><span class="entity"><span>xctrs</span></span><span> </span><span class="entity"><span>xfs</span></span><span> </span><span class="entity"><span>xss</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>raw_case</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>raw_case_def</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy_old</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>no_defs_lthy</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>o</span><span> </span><span>Local_Theory.begin_nested</span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Local_Theory.define</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>case_binding</span></span><span class="main"><span>,</span></span><span> </span><span>NoSyn</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.concealed</span><span> </span><span class="main"><span>(</span></span><span>Thm.def_binding</span><span> </span><span class="entity"><span>case_binding</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>case_rhs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>||&gt;</span><span> </span><span>`</span><span>Local_Theory.end_nested</span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.export_morphism</span><span> </span><span class="entity"><span>lthy_old</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>case_def</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Morphism.thm</span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>raw_case_def</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>case0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Morphism.term</span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>raw_case</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>casex</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_case</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>B</span></span><span> </span><span class="entity"><span>case0</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>casexC</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_case</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>C</span></span><span> </span><span class="entity"><span>case0</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>casexBool</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_case</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>HOLogic.boolT</span></span><span> </span><span class="entity"><span>case0</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_uu_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.mk_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>exist_xs_u_eq_ctrs</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>xctr</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>list_exists_free</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xctr</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xctrs</span></span><span> </span><span class="entity"><span>xss</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>unique_disc_no_def</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>TrueI</span></span><span class="main"><span>;</span></span><span> </span><span class="comment1"><span>(*arbitrary marker*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>alternate_disc_no_def</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>FalseE</span></span><span class="main"><span>;</span></span><span> </span><span class="comment1"><span>(*arbitrary marker*)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>alternate_disc_lhs</span></span><span> </span><span class="entity"><span>get_udisc</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>HOLogic.mk_not</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>nth</span><span> </span><span class="entity"><span>disc_bindings</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_disc_binding_valid</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>get_udisc</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>nth</span><span> </span><span class="entity"><span>exist_xs_u_eq_ctrs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>no_discs_sels</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>not</span><span> </span><span class="entity"><span>discs_sels</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
      </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span>forall</span><span> </span><span>Binding.is_empty</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>raw_disc_bindings</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>raw_sel_bindingss</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
      </span><span>null</span><span> </span><span class="entity"><span>sel_default_eqs</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>all_sels_distinct</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>discs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>selss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>disc_defs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sel_defs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sel_defss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>no_discs_sels</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="main"><span>(</span></span><span>true</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>all_sel_bindings</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>flat</span><span> </span><span class="entity"><span>sel_bindingss</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>num_all_sel_bindings</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>all_sel_bindings</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>uniq_sel_bindings</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>distinct</span><span> </span><span>Binding.eq_name</span><span> </span><span class="entity"><span>all_sel_bindings</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>all_sels_distinct</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>uniq_sel_bindings</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>num_all_sel_bindings</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sel_binding_index</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>all_sels_distinct</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
              </span><span class="inner_numeral"><span>1</span></span><span> </span><span>upto</span><span> </span><span class="entity"><span>num_all_sel_bindings</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
              </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>find_index</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span>Binding.eq_name</span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>uniq_sel_bindings</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>all_sel_bindings</span></span><span class="main"><span>;</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>all_proto_sels</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>flat</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 3</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span class="entity"><span>k</span></span><span> </span><span>o</span><span> </span><span>pair</span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ks</span></span><span> </span><span class="entity"><span>xss</span></span><span> </span><span class="entity"><span>xss</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sel_infos</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span>AList.group</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sel_binding_index</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>all_proto_sels</span></span><span class="main"><span>)</span></span><span>
            </span><span>|&gt;</span><span> </span><span>sort</span><span> </span><span class="main"><span>(</span></span><span>int_ord</span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span>
            </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span>snd</span><span> </span><span>|&gt;</span><span> </span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>~~</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>uniq_sel_bindings</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sel_bindings</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>sel_infos</span></span><span class="main"><span>;</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sel_defaults</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>sel_default_eqs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
              </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sel_Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>--&gt;</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fcT</span></span><span> </span><span>o</span><span> </span><span>fastype_of</span><span> </span><span>o</span><span> </span><span>snd</span><span> </span><span>o</span><span> </span><span>snd</span><span> </span><span>o</span><span> </span><span>hd</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sel_infos</span></span><span class="main"><span>;</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fake_lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
                  </span><span class="entity"><span>fake_local_theory_for_sel_defaults</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sel_bindings</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>sel_Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>no_defs_lthy</span></span><span class="main"><span>;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>extract_sel_default</span></span><span> </span><span class="entity"><span>fake_lthy</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>prep_term</span></span><span> </span><span class="entity"><span>fake_lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sel_default_eqs</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>disc_free</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span>Binding.name_of</span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_pred1T</span></span><span> </span><span class="entity"><span>fcT</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>disc_spec</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>exist_xs_u_eq_ctr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_Trueprop_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>disc_free</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>exist_xs_u_eq_ctr</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>alternate_disc</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span>Term.lambda</span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>alternate_disc_lhs</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>o</span><span> </span><span class="entity"><span>rapp</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>disc_free</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>3</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_sel_case_args</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>proto_sels</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 3</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>proto_sels</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span>Binding.name_of</span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sel_defaults</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                  </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span>Term.lambda</span><span> </span><span>o</span><span> </span><span>curry</span><span> </span><span>Free</span><span> </span><span>Name.uu</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_undefined</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
                </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>t</span></span><span>
                </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Multiple default values for selector/constructor pair"</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>xs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>fold_rev</span><span> </span><span>Term.lambda</span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctrs</span></span><span> </span><span class="entity"><span>ctr_Tss</span></span><span> </span><span class="entity"><span>ks</span></span><span class="main"><span>;</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>sel_spec</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>proto_sels</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>duplicates</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>proto_sels</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                   </span><span class="entity"><span>k</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Duplicate selector name "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="main"><span>(</span></span><span>Binding.name_of</span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span>
                     </span><span class="inner_quoted"><span>" for constructor "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="main"><span>(</span></span><span>Syntax.string_of_term</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>ctrs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                 </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>distinct</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span>o</span><span> </span><span>snd</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>proto_sels</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                  </span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span>
                </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>T'</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Inconsistent range type for selector "</span></span><span> </span><span>^</span><span>
                    </span><span>quote</span><span> </span><span class="main"><span>(</span></span><span>Binding.name_of</span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>": "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="main"><span>(</span></span><span>Syntax.string_of_typ</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span>
                    </span><span class="inner_quoted"><span>" vs. "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="main"><span>(</span></span><span>Syntax.string_of_typ</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span class="entity"><span>mk_Trueprop_eq</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span>Binding.name_of</span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fcT</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span>
                </span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_case</span></span><span> </span><span class="entity"><span>As</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>case0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_sel_case_args</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>proto_sels</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unflat_selss</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unflat_lookup</span></span><span> </span><span>Binding.eq_name</span><span> </span><span class="entity"><span>sel_bindings</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="entity"><span>sel_bindingss</span></span><span class="main"><span>;</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>raw_discs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>raw_disc_defs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>raw_sels</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>raw_sel_defs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lthy'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="entity"><span>lthy</span></span><span>
            </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>o</span><span> </span><span>Local_Theory.begin_nested</span><span class="main"><span>)</span></span><span>
            </span><span>|&gt;</span><span> </span><span>apfst</span><span> </span><span>split_list</span><span> </span><span>o</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>fold_map</span></span><span> 3</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>exist_xs_u_eq_ctr</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Binding.is_empty</span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>pair</span><span> </span><span class="main"><span>(</span></span><span>Term.lambda</span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_uu_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unique_disc_no_def</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>pair</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>alternate_disc</span></span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>alternate_disc_no_def</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Binding.eq_name</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>equal_binding</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                  </span><span>pair</span><span> </span><span class="main"><span>(</span></span><span>Term.lambda</span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="entity"><span>exist_xs_u_eq_ctr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>refl</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                  </span><span class="entity"><span>Specification.definition</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span>NoSyn</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
                    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Thm.def_binding</span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>disc_spec</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>exist_xs_u_eq_ctr</span></span><span class="main"><span>)</span></span><span> </span><span>#&gt;&gt;</span><span> </span><span>apsnd</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span>
              </span><span class="entity"><span>ks</span></span><span> </span><span class="entity"><span>exist_xs_u_eq_ctrs</span></span><span> </span><span class="entity"><span>disc_bindings</span></span><span>
            </span><span>||&gt;&gt;</span><span> </span><span>apfst</span><span> </span><span>split_list</span><span> </span><span>o</span><span> </span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>proto_sels</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="entity"><span>Specification.definition</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span>NoSyn</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
                </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Thm.def_binding</span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sel_spec</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>proto_sels</span></span><span class="main"><span>)</span></span><span> </span><span>#&gt;&gt;</span><span> </span><span>apsnd</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sel_infos</span></span><span>
            </span><span>||&gt;</span><span> </span><span>`</span><span>Local_Theory.end_nested</span><span class="main"><span>;</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.export_morphism</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>;</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>disc_defs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Morphism.thm</span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_disc_defs</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sel_defs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Morphism.thm</span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_sel_defs</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sel_defss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unflat_selss</span></span><span> </span><span class="entity"><span>sel_defs</span></span><span class="main"><span>;</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>discs0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Morphism.term</span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_discs</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>selss0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unflat_selss</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Morphism.term</span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_sels</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>discs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_disc_or_sel</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>discs0</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>selss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_disc_or_sel</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>selss0</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>all_sels_distinct</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>discs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>selss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>disc_defs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sel_defs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sel_defss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_imp_p</span></span><span> </span><span class="entity"><span>Qs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.list_implies</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Qs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>exhaust_goal</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_prem</span></span><span> </span><span class="entity"><span>xctr</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span>Logic.all</span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_imp_p</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>mk_Trueprop_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>exh_y</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xctr</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>fold_rev</span><span> </span><span>Logic.all</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>exh_y</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_imp_p</span></span><span> </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="entity"><span>mk_prem</span></span><span> </span><span class="entity"><span>xctrs</span></span><span> </span><span class="entity"><span>xss</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inject_goalss</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_goal</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk_goal</span></span><span> </span><span class="entity"><span>xctr</span></span><span> </span><span class="entity"><span>yctr</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="entity"><span>ys</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="main"><span>[</span></span><span>fold_rev</span><span> </span><span>Logic.all</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>xs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>ys</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_Trueprop_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>xctr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>yctr</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
              </span><span>Library.foldr1</span><span> </span><span class="entity"><span>HOLogic.mk_conj</span></span><span> </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="entity"><span>HOLogic.mk_eq</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="entity"><span>ys</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 4</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="entity"><span>mk_goal</span></span><span> </span><span class="entity"><span>xctrs</span></span><span> </span><span class="entity"><span>yctrs</span></span><span> </span><span class="entity"><span>xss</span></span><span> </span><span class="entity"><span>yss</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>half_distinct_goalss</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_goal</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>xs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xc</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>xs'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xc'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>fold_rev</span><span> </span><span>Logic.all</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>xs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>xs'</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_not</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>xc</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xc'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>mk_goal</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_half_pairss</span></span><span> </span><span class="main"><span>(</span></span><span>`</span><span>I</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>xss</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>xctrs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goalss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>exhaust_goal</span></span><span class="main"><span>]</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>inject_goalss</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>half_distinct_goalss</span></span><span class="main"><span>;</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>after_qed</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>exhaust_thm</span></span><span class="main"><span>]</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>thmss</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>xss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xss'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>h</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>add_bindings</span></span><span>
          </span><span>|&gt;</span><span> </span><span>yield_singleton</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>~~</span><span class="main"><span>)</span></span><span> </span><span>oo</span><span> </span><span class="entity"><span>mk_Frees'</span></span><span> </span><span class="entity"><span>fc_b_name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fcT</span></span><span>
          </span><span>||&gt;&gt;</span><span> </span><span class="entity"><span>mk_Freess'</span></span><span> </span><span class="inner_quoted"><span>"x"</span></span><span> </span><span class="entity"><span>ctr_Tss</span></span><span>
          </span><span>||&gt;&gt;</span><span> </span><span class="entity"><span>mk_Frees</span></span><span> </span><span class="inner_quoted"><span>"f"</span></span><span> </span><span class="entity"><span>case_Ts</span></span><span>
          </span><span>||&gt;&gt;</span><span> </span><span class="entity"><span>mk_Frees</span></span><span> </span><span class="inner_quoted"><span>"g"</span></span><span> </span><span class="entity"><span>case_Ts</span></span><span>
          </span><span>||&gt;&gt;</span><span> </span><span>yield_singleton</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_Frees</span></span><span> </span><span class="inner_quoted"><span>"h"</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>B</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>C</span></span><span class="main"><span>)</span></span><span>
          </span><span>||&gt;&gt;</span><span> </span><span>yield_singleton</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_Frees</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fc_b_name</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"'"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fcT</span></span><span>
          </span><span>||&gt;&gt;</span><span> </span><span>yield_singleton</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_Frees</span></span><span> </span><span class="inner_quoted"><span>"P"</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>HOLogic.boolT</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>xfs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span>Term.list_comb</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fs</span></span><span> </span><span class="entity"><span>xss</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>xgs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span>Term.list_comb</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>gs</span></span><span> </span><span class="entity"><span>xss</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fcase</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>casex</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ufcase</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fcase</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vfcase</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fcase</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eta_fcase</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>casex</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eta_fs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eta_gcase</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>casex</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eta_gs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eta_ufcase</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eta_fcase</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eta_vgcase</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eta_gcase</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_uu_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.mk_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>uv_eq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_Trueprop_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>inject_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>inject_thmss</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>half_distinct_thmss</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>chop</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>thmss</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span>`</span><span>flat</span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rho_As</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>U</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>dest_TVar</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.ctyp_of</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>U</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Logic.varifyT_global</span><span> </span><span class="entity"><span>As</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>inst_thm</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>Thm.instantiate'</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
            </span><span class="main"><span>(</span></span><span>Thm.instantiate</span><span> </span><span class="main"><span>(</span></span><span>TVars.make</span><span> </span><span class="entity"><span>rho_As</span></span><span class="main"><span>,</span></span><span> </span><span>Vars.empty</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Drule.zero_var_indexes</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>uexhaust_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>inst_thm</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="entity"><span>exhaust_thm</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>exhaust_cases</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>base_name_of_ctr</span></span><span> </span><span class="entity"><span>ctrs</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>other_half_distinct_thmss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>not_sym</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>half_distinct_thmss</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>distinct_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>distinct_thmsss'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>distinct_thmsss</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>join_halves</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>half_distinct_thmss</span></span><span> </span><span class="entity"><span>other_half_distinct_thmss</span></span><span> </span><span>||&gt;</span><span> </span><span>`</span><span class="entity"><span>transpose</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nchotomy_thm</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_all</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>u'</span></span><span class="main"><span>,</span></span><span> </span><span>snd</span><span> </span><span class="entity"><span>u'</span></span><span class="main"><span>,</span></span><span>
                </span><span>Library.foldr1</span><span> </span><span class="entity"><span>HOLogic.mk_disj</span></span><span> </span><span class="entity"><span>exist_xs_u_eq_ctrs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span>Goal.prove_sorry</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span>prems</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="entity"><span>mk_nchotomy_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>exhaust_thm</span></span><span class="main"><span>)</span></span><span>
            </span><span>|&gt;</span><span> </span><span>Thm.close_derivation</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>case_thms</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goals</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 3</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>xctr</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>xf</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span>fold_rev</span><span> </span><span>Logic.all</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_Trueprop_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fcase</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>xctr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xf</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xctrs</span></span><span> </span><span class="entity"><span>xfs</span></span><span> </span><span class="entity"><span>xss</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 4</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>injects</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>distinctss</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span>Goal.prove_sorry</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span class="entity"><span>mk_case_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>case_def</span></span><span> </span><span class="entity"><span>injects</span></span><span> </span><span class="entity"><span>distinctss</span></span><span class="main"><span>)</span></span><span>
                </span><span>|&gt;</span><span> </span><span>Thm.close_derivation</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span class="main"><span>)</span></span><span>
              </span><span class="entity"><span>ks</span></span><span> </span><span class="entity"><span>goals</span></span><span> </span><span class="entity"><span>inject_thmss</span></span><span> </span><span class="entity"><span>distinct_thmsss</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>case_cong_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>case_cong_weak_thm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_prem</span></span><span> </span><span class="entity"><span>xctr</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="entity"><span>xf</span></span><span> </span><span class="entity"><span>xg</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span>fold_rev</span><span> </span><span>Logic.all</span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>(</span></span><span>Logic.mk_implies</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_Trueprop_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xctr</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                </span><span class="entity"><span>mk_Trueprop_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>xf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xg</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span>Logic.list_implies</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>uv_eq</span></span><span> </span><span>::</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 4</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="entity"><span>mk_prem</span></span><span> </span><span class="entity"><span>xctrs</span></span><span> </span><span class="entity"><span>xss</span></span><span> </span><span class="entity"><span>xfs</span></span><span> </span><span class="entity"><span>xgs</span></span><span class="main"><span>,</span></span><span>
                 </span><span class="entity"><span>mk_Trueprop_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eta_ufcase</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eta_vgcase</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>weak_goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.mk_implies</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>uv_eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_Trueprop_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ufcase</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vfcase</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.add_free_names</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>weak_vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.add_free_names</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>weak_goal</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="main"><span>(</span></span><span>Goal.prove_sorry</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span>prems</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
               </span><span class="entity"><span>mk_case_cong_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>uexhaust_thm</span></span><span> </span><span class="entity"><span>case_thms</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
             </span><span>Goal.prove_sorry</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>weak_vars</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>weak_goal</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span>prems</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
               </span><span class="entity"><span>etac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>arg_cong</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span>|&gt;</span><span> </span><span>apply2</span><span> </span><span class="main"><span>(</span></span><span>Thm.close_derivation</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>split_lhs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>q</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>ufcase</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_split_conjunct</span></span><span> </span><span class="entity"><span>xctr</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="entity"><span>f_xs</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>list_all_free</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_imp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xctr</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>q</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>f_xs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_split_disjunct</span></span><span> </span><span class="entity"><span>xctr</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="entity"><span>f_xs</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>list_exists_free</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_conj</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xctr</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
            </span><span class="entity"><span>HOLogic.mk_not</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>q</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>f_xs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_split_goal</span></span><span> </span><span class="entity"><span>xctrs</span></span><span> </span><span class="entity"><span>xss</span></span><span> </span><span class="entity"><span>xfs</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>mk_Trueprop_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>split_lhs</span></span><span class="main"><span>,</span></span><span> </span><span>Library.foldr1</span><span> </span><span class="entity"><span>HOLogic.mk_conj</span></span><span>
            </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 3</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="entity"><span>mk_split_conjunct</span></span><span> </span><span class="entity"><span>xctrs</span></span><span> </span><span class="entity"><span>xss</span></span><span> </span><span class="entity"><span>xfs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_split_asm_goal</span></span><span> </span><span class="entity"><span>xctrs</span></span><span> </span><span class="entity"><span>xss</span></span><span> </span><span class="entity"><span>xfs</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>mk_Trueprop_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>split_lhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>HOLogic.mk_not</span></span><span> </span><span class="main"><span>(</span></span><span>Library.foldr1</span><span> </span><span class="entity"><span>HOLogic.mk_disj</span></span><span>
            </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 3</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="entity"><span>mk_split_disjunct</span></span><span> </span><span class="entity"><span>xctrs</span></span><span> </span><span class="entity"><span>xss</span></span><span> </span><span class="entity"><span>xfs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prove_split</span></span><span> </span><span class="entity"><span>selss</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>Variable.add_free_names</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Goal.prove_sorry</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span>prems</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="entity"><span>mk_split_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>uexhaust_thm</span></span><span> </span><span class="entity"><span>case_thms</span></span><span> </span><span class="entity"><span>selss</span></span><span> </span><span class="entity"><span>inject_thmss</span></span><span> </span><span class="entity"><span>distinct_thmsss</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>Thm.close_derivation</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prove_split_asm</span></span><span> </span><span class="entity"><span>asm_goal</span></span><span> </span><span class="entity"><span>split_thm</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>Variable.add_free_names</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>asm_goal</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Goal.prove_sorry</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>asm_goal</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="entity"><span>mk_split_asm_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>split_thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>Thm.close_derivation</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>split_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>split_asm_thm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_split_goal</span></span><span> </span><span class="entity"><span>xctrs</span></span><span> </span><span class="entity"><span>xss</span></span><span> </span><span class="entity"><span>xfs</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>asm_goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_split_asm_goal</span></span><span> </span><span class="entity"><span>xctrs</span></span><span> </span><span class="entity"><span>xss</span></span><span> </span><span class="entity"><span>xfs</span></span><span class="main"><span>;</span></span><span>

            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prove_split</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>asm_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prove_split_asm</span></span><span> </span><span class="entity"><span>asm_goal</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>asm_thm</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sel_defs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>all_sel_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sel_thmss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nontriv_disc_defs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>disc_thmss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nontriv_disc_thmss</span></span><span class="main"><span>,</span></span><span>
             </span><span class="entity"><span>discI_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nontriv_discI_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>distinct_disc_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>distinct_disc_thmsss</span></span><span class="main"><span>,</span></span><span>
             </span><span class="entity"><span>exhaust_disc_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>exhaust_sel_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>all_collapse_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>safe_collapse_thms</span></span><span class="main"><span>,</span></span><span>
             </span><span class="entity"><span>expand_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>split_sel_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>split_sel_asm_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>case_eq_if_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>disc_eq_case_thms</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>no_discs_sels</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>udiscs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rapp</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>discs</span></span><span class="main"><span>;</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>uselss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rapp</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>selss</span></span><span class="main"><span>;</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>usel_ctrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span>Term.list_comb</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctrs</span></span><span> </span><span class="entity"><span>uselss</span></span><span class="main"><span>;</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>usel_fs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span>Term.list_comb</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fs</span></span><span> </span><span class="entity"><span>uselss</span></span><span class="main"><span>;</span></span><span>

              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vdiscs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rapp</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>discs</span></span><span class="main"><span>;</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vselss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rapp</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>selss</span></span><span class="main"><span>;</span></span><span>

              </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_sel_thm</span></span><span> </span><span class="entity"><span>xs'</span></span><span> </span><span class="entity"><span>case_thm</span></span><span> </span><span class="entity"><span>sel_def</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span>zero_var_indexes</span><span>
                  </span><span class="main"><span>(</span></span><span>Variable.gen_all</span><span> </span><span class="entity"><span>lthy</span></span><span>
                    </span><span class="main"><span>(</span></span><span>Drule.rename_bvars'</span><span>
                      </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xs'</span></span><span class="main"><span>)</span></span><span>
                      </span><span class="main"><span>(</span></span><span>Thm.forall_intr_vars</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>case_thm</span></span><span> </span><span>RS</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sel_def</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>trans</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sel_thmss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 3</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>oo</span><span> </span><span class="entity"><span>make_sel_thm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xss'</span></span><span> </span><span class="entity"><span>case_thms</span></span><span> </span><span class="entity"><span>sel_defss</span></span><span class="main"><span>;</span></span><span>

              </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>has_undefined_rhs</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>snd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.dest_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                  </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.undefined|const"><span>undefined</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span>
                </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>all_sel_thms</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>all_sels_distinct</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>sel_default_eqs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                   </span><span>flat</span><span> </span><span class="entity"><span>sel_thmss</span></span><span>
                 </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                   </span><span>map_product</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>xs'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>make_sel_thm</span></span><span> </span><span class="entity"><span>xs'</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sel_defs</span></span><span>
                     </span><span class="main"><span>(</span></span><span class="entity"><span>xss'</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>case_thms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                </span><span>|&gt;</span><span> </span><span>filter_out</span><span> </span><span class="entity"><span>has_undefined_rhs</span></span><span class="main"><span>;</span></span><span>

              </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_unique_disc_def</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the_single</span><span> </span><span class="entity"><span>ms</span></span><span class="main"><span>;</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_Trueprop_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_uu_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>the_single</span><span> </span><span class="entity"><span>exist_xs_u_eq_ctrs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.add_free_names</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                  </span><span>Goal.prove_sorry</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span>prems</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                    </span><span class="entity"><span>mk_unique_disc_def_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="entity"><span>uexhaust_thm</span></span><span class="main"><span>)</span></span><span>
                  </span><span>|&gt;</span><span> </span><span>Thm.close_derivation</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

              </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_alternate_disc_def</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span>
                    </span><span class="entity"><span>mk_Trueprop_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>alternate_disc_lhs</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>udiscs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>3</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                      </span><span>nth</span><span> </span><span class="entity"><span>exist_xs_u_eq_ctrs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.add_free_names</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                  </span><span>Goal.prove_sorry</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                    </span><span class="entity"><span>mk_alternate_disc_def_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>disc_defs</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                      </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>distinct_thms</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>uexhaust_thm</span></span><span class="main"><span>)</span></span><span>
                  </span><span>|&gt;</span><span> </span><span>Thm.close_derivation</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>has_alternate_disc_def</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>def</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Thm.eq_thm_prop</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>def</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>alternate_disc_no_def</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>disc_defs</span></span><span class="main"><span>;</span></span><span>

              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nontriv_disc_defs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>disc_defs</span></span><span>
                </span><span>|&gt;</span><span> </span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span>Thm.eq_thm_prop</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>unique_disc_no_def</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>alternate_disc_no_def</span></span><span class="main"><span>,</span></span><span>
                  </span><span class="entity"><span>refl</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>disc_defs'</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>def</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Thm.eq_thm_prop</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>def</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unique_disc_no_def</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>mk_unique_disc_def</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Thm.eq_thm_prop</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>def</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>alternate_disc_no_def</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>mk_alternate_disc_def</span></span><span> </span><span class="entity"><span>k</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>def</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ks</span></span><span> </span><span class="entity"><span>disc_defs</span></span><span class="main"><span>;</span></span><span>

              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>discD_thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>def</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>def</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>iffD1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>disc_defs'</span></span><span class="main"><span>;</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>discI_thms</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>def</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>funpow</span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>exI</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>def</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>iffD2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ms</span></span><span>
                  </span><span class="entity"><span>disc_defs'</span></span><span class="main"><span>;</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>not_discI_thms</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>def</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>funpow</span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>allI</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="main"><span>(</span></span><span class="entity"><span>unfold_thms</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.not_ex|fact"><span>not_ex</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>def</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.ssubst|fact"><span>ssubst</span></a><span class="main"><span>[</span></span><span class="operator"><span>of</span></span><span> </span><span class="main"><span class="main"><span>_</span></span></span><span> </span><span class="main"><span class="main"><span>_</span></span></span><span> </span><span class="quoted"><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>Not</span></a></span><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="entity"><span>ms</span></span><span> </span><span class="entity"><span>disc_defs'</span></span><span class="main"><span>;</span></span><span>

              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>disc_thmss'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>disc_thmss</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_thm</span></span><span> </span><span class="entity"><span>discI</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>refl</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>discI</span></span><span>
                    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk_thm</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>not_discI</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>distinct</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>distinct</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>not_discI</span></span><span class="main"><span>;</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_thms</span></span><span> </span><span class="entity"><span>discI</span></span><span> </span><span class="entity"><span>not_discI</span></span><span> </span><span class="entity"><span>distinctss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_thm</span></span><span> </span><span class="entity"><span>discI</span></span><span> </span><span class="entity"><span>not_discI</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>distinctss</span></span><span class="main"><span>;</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                  </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 3</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="entity"><span>mk_thms</span></span><span> </span><span class="entity"><span>discI_thms</span></span><span> </span><span class="entity"><span>not_discI_thms</span></span><span> </span><span class="entity"><span>distinct_thmsss'</span></span><span> </span><span>|&gt;</span><span> </span><span>`</span><span class="entity"><span>transpose</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nontriv_disc_thmss</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_disc_binding_valid</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>I</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>K</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>disc_bindings</span></span><span> </span><span class="entity"><span>disc_thmss</span></span><span class="main"><span>;</span></span><span>

              </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_discI_triv</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>Binding.is_empty</span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>Binding.eq_name</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>equal_binding</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nontriv_discI_thms</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span>flat</span><span> </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_discI_triv</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>K</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>single</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>disc_bindings</span></span><span>
                  </span><span class="entity"><span>discI_thms</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>distinct_disc_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>distinct_disc_thmsss'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>distinct_disc_thmsss</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_goal</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
                    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk_goal</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>udisc</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>udisc'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span>
                      </span><span class="main"><span>[</span></span><span>Logic.all</span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>(</span></span><span>Logic.mk_implies</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="entity"><span>udisc</span></span><span class="main"><span>,</span></span><span>
                         </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_not</span></span><span> </span><span class="entity"><span>udisc'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

                  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prove</span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span>
                    </span><span>Goal.prove_sorry</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span>prems</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
                    </span><span>|&gt;</span><span> </span><span>Thm.close_derivation</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span class="main"><span>;</span></span><span>

                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>half_pairss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_half_pairss</span></span><span> </span><span class="main"><span>(</span></span><span>`</span><span>I</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ms</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>discD_thms</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>udiscs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>half_goalss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>mk_goal</span></span><span> </span><span class="entity"><span>half_pairss</span></span><span class="main"><span>;</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>half_thmss</span></span><span> </span><span class="main"><span>=</span></span><span>
                    </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 3</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>goal</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>m</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>discD</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                        </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>disc_thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>prove</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                          </span><span class="entity"><span>mk_half_distinct_disc_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="entity"><span>discD</span></span><span> </span><span class="entity"><span>disc_thm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                      </span><span class="entity"><span>half_goalss</span></span><span> </span><span class="entity"><span>half_pairss</span></span><span> </span><span class="main"><span>(</span></span><span>flat</span><span> </span><span class="entity"><span>disc_thmss'</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>other_half_goalss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_goal</span></span><span> </span><span>o</span><span> </span><span>map</span><span> </span><span>swap</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>half_pairss</span></span><span class="main"><span>;</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>other_half_thmss</span></span><span> </span><span class="main"><span>=</span></span><span>
                    </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>prove</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                        </span><span class="entity"><span>mk_other_half_distinct_disc_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>half_thmss</span></span><span>
                      </span><span class="entity"><span>other_half_goalss</span></span><span class="main"><span>;</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                  </span><span class="entity"><span>join_halves</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>half_thmss</span></span><span> </span><span class="entity"><span>other_half_thmss</span></span><span> </span><span>||&gt;</span><span> </span><span>`</span><span class="entity"><span>transpose</span></span><span>
                  </span><span>|&gt;&gt;</span><span> </span><span class="entity"><span>has_alternate_disc_def</span></span><span> </span><span>?</span><span> </span><span>K</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>exhaust_disc_thm</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_prem</span></span><span> </span><span class="entity"><span>udisc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_imp_p</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="entity"><span>udisc</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span>Logic.all</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_imp_p</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>mk_prem</span></span><span> </span><span class="entity"><span>udiscs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                  </span><span>Goal.prove_sorry</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span>prems</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                    </span><span class="entity"><span>mk_exhaust_disc_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>exhaust_thm</span></span><span> </span><span class="entity"><span>discI_thms</span></span><span class="main"><span>)</span></span><span>
                  </span><span>|&gt;</span><span> </span><span>Thm.close_derivation</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>safe_collapse_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>all_collapse_thms</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_goal</span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="entity"><span>udisc</span></span><span> </span><span class="entity"><span>usel_ctr</span></span><span> </span><span class="main"><span>=</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prem</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="entity"><span>udisc</span></span><span class="main"><span>;</span></span><span>
                      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_Trueprop_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>usel_ctr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span>?</span><span> </span><span>swap</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                      </span><span class="main"><span>(</span></span><span class="entity"><span>prem</span></span><span> </span><span>aconv</span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>,</span></span><span> </span><span>Logic.all</span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>(</span></span><span>Logic.mk_implies</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prem</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>trivs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>goals</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 3</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="entity"><span>mk_goal</span></span><span> </span><span class="entity"><span>ms</span></span><span> </span><span class="entity"><span>udiscs</span></span><span> </span><span class="entity"><span>usel_ctrs</span></span><span> </span><span>|&gt;</span><span> </span><span>split_list</span><span class="main"><span>;</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="main"><span>=</span></span><span>
                    </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 5</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>discD</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>sel_thms</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>triv</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                        </span><span>Goal.prove_sorry</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                          </span><span class="entity"><span>mk_collapse_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="entity"><span>discD</span></span><span> </span><span class="entity"><span>sel_thms</span></span><span> </span><span>ORELSE</span><span> </span><span>HEADGOAL</span><span> </span><span class="main"><span>(</span></span><span>assume_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                        </span><span>|&gt;</span><span> </span><span>Thm.close_derivation</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span>
                        </span><span>|&gt;</span><span> </span><span>not</span><span> </span><span class="entity"><span>triv</span></span><span> </span><span>?</span><span> </span><span>perhaps</span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>refl</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                      </span><span class="entity"><span>ms</span></span><span> </span><span class="entity"><span>discD_thms</span></span><span> </span><span class="entity"><span>sel_thmss</span></span><span> </span><span class="entity"><span>trivs</span></span><span> </span><span class="entity"><span>goals</span></span><span class="main"><span>;</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                  </span><span class="main"><span>(</span></span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span>true</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>trivs</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                   </span><span class="entity"><span>thms</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>swapped_all_collapse_thms</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ms</span></span><span> </span><span class="entity"><span>all_collapse_thms</span></span><span class="main"><span>;</span></span><span>

              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>exhaust_sel_thm</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_prem</span></span><span> </span><span class="entity"><span>usel_ctr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_imp_p</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>mk_Trueprop_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>usel_ctr</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span>Logic.all</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_imp_p</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>mk_prem</span></span><span> </span><span class="entity"><span>usel_ctrs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                  </span><span>Goal.prove_sorry</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span>prems</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                    </span><span class="entity"><span>mk_exhaust_sel_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>exhaust_disc_thm</span></span><span> </span><span class="entity"><span>swapped_all_collapse_thms</span></span><span class="main"><span>)</span></span><span>
                  </span><span>|&gt;</span><span> </span><span>Thm.close_derivation</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>expand_thm</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_prems</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>udisc</span></span><span> </span><span class="entity"><span>usels</span></span><span> </span><span class="entity"><span>vdisc</span></span><span> </span><span class="entity"><span>vsels</span></span><span> </span><span class="main"><span>=</span></span><span>
                    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>mk_Trueprop_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>udisc</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vdisc</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span>
                    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>usels</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                       </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
                     </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                       </span><span class="main"><span>[</span></span><span>Logic.list_implies</span><span>
                          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>map</span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>udisc</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vdisc</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
                             </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span>Library.foldr1</span><span> </span><span class="entity"><span>HOLogic.mk_conj</span></span><span>
                               </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="entity"><span>HOLogic.mk_eq</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>usels</span></span><span> </span><span class="entity"><span>vsels</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span>
                    </span><span>Library.foldr</span><span> </span><span>Logic.list_implies</span><span>
                      </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 5</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="entity"><span>mk_prems</span></span><span> </span><span class="entity"><span>ks</span></span><span> </span><span class="entity"><span>udiscs</span></span><span> </span><span class="entity"><span>uselss</span></span><span> </span><span class="entity"><span>vdiscs</span></span><span> </span><span class="entity"><span>vselss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>uv_eq</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>uncollapse_thms</span></span><span> </span><span class="main"><span>=</span></span><span>
                    </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>all_collapse_thms</span></span><span> </span><span class="entity"><span>uselss</span></span><span class="main"><span>;</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.add_free_names</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                  </span><span>Goal.prove_sorry</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span>prems</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                    </span><span class="entity"><span>mk_expand_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>ms</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inst_thm</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="entity"><span>exhaust_disc_thm</span></span><span class="main"><span>)</span></span><span>
                      </span><span class="main"><span>(</span></span><span class="entity"><span>inst_thm</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="entity"><span>exhaust_disc_thm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>uncollapse_thms</span></span><span> </span><span class="entity"><span>distinct_disc_thmsss</span></span><span>
                      </span><span class="entity"><span>distinct_disc_thmsss'</span></span><span class="main"><span>)</span></span><span>
                  </span><span>|&gt;</span><span> </span><span>Thm.close_derivation</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>split_sel_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>split_sel_asm_thm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>zss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xss</span></span><span class="main"><span>;</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_split_goal</span></span><span> </span><span class="entity"><span>usel_ctrs</span></span><span> </span><span class="entity"><span>zss</span></span><span> </span><span class="entity"><span>usel_fs</span></span><span class="main"><span>;</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>asm_goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_split_asm_goal</span></span><span> </span><span class="entity"><span>usel_ctrs</span></span><span> </span><span class="entity"><span>zss</span></span><span> </span><span class="entity"><span>usel_fs</span></span><span class="main"><span>;</span></span><span>

                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prove_split</span></span><span> </span><span class="entity"><span>sel_thmss</span></span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>;</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>asm_thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prove_split_asm</span></span><span> </span><span class="entity"><span>asm_goal</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>;</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                  </span><span class="main"><span>(</span></span><span class="entity"><span>thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>asm_thm</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>case_eq_if_thm</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_Trueprop_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ufcase</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_IfN</span></span><span> </span><span class="entity"><span>B</span></span><span> </span><span class="entity"><span>udiscs</span></span><span> </span><span class="entity"><span>usel_fs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.add_free_names</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                  </span><span>Goal.prove_sorry</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                    </span><span class="entity"><span>mk_case_eq_if_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>uexhaust_thm</span></span><span> </span><span class="entity"><span>case_thms</span></span><span> </span><span class="entity"><span>disc_thmss'</span></span><span> </span><span class="entity"><span>sel_thmss</span></span><span class="main"><span>)</span></span><span>
                  </span><span>|&gt;</span><span> </span><span>Thm.close_derivation</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>disc_eq_case_thms</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>const_of_bool</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.False|const"><span>False</span></a><span>›</span></span><span class="main"><span>;</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_case_args</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_index</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>argTs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                    </span><span>fold_rev</span><span> </span><span>Term.absdummy</span><span> </span><span class="entity"><span>argTs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>const_of_bool</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctr_Tss</span></span><span class="main"><span>;</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goals</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_index</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>udisc</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                    </span><span class="entity"><span>mk_Trueprop_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>udisc</span></span><span class="main"><span>,</span></span><span> </span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>casexBool</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_case_args</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>udiscs</span></span><span class="main"><span>;</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.mk_conjunction_balanced</span><span> </span><span class="entity"><span>goals</span></span><span class="main"><span>;</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.add_free_names</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                  </span><span>Goal.prove_sorry</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>goal</span></span><span>
                    </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>mk_disc_eq_case_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>
                       </span><span class="entity"><span>exhaust_thm</span></span><span> </span><span class="main"><span>(</span></span><span>flat</span><span> </span><span class="entity"><span>nontriv_disc_thmss</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>distinct_thms</span></span><span> </span><span class="entity"><span>case_thms</span></span><span class="main"><span>)</span></span><span>
                  </span><span>|&gt;</span><span> </span><span>Thm.close_derivation</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span>
                  </span><span>|&gt;</span><span> </span><span>Conjunction.elim_balanced</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>goals</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>sel_defs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>all_sel_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sel_thmss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nontriv_disc_defs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>disc_thmss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nontriv_disc_thmss</span></span><span class="main"><span>,</span></span><span>
               </span><span class="entity"><span>discI_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nontriv_discI_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>distinct_disc_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>distinct_disc_thmsss</span></span><span class="main"><span>,</span></span><span>
               </span><span class="main"><span>[</span></span><span class="entity"><span>exhaust_disc_thm</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>exhaust_sel_thm</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>all_collapse_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>safe_collapse_thms</span></span><span class="main"><span>,</span></span><span>
               </span><span class="main"><span>[</span></span><span class="entity"><span>expand_thm</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>split_sel_thm</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>split_sel_asm_thm</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>case_eq_if_thm</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
               </span><span class="entity"><span>disc_eq_case_thms</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>case_distrib_thm</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 2</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>argTs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>args</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_Frees</span></span><span> </span><span class="inner_quoted"><span>"x"</span></span><span> </span><span class="entity"><span>argTs</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                </span><span>fold_rev</span><span> </span><span>Term.lambda</span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>h</span></span><span> </span><span>$</span><span> </span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fs</span></span><span> </span><span class="entity"><span>ctr_Tss</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_Trueprop_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>h</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>ufcase</span></span><span class="main"><span>,</span></span><span> </span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>casexC</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.add_free_names</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span>Goal.prove_sorry</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="entity"><span>mk_case_distrib_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>exhaust_thm</span></span><span> </span><span class="entity"><span>case_thms</span></span><span class="main"><span>)</span></span><span>
            </span><span>|&gt;</span><span> </span><span>Thm.close_derivation</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>exhaust_case_names_attr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.internal</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>Rule_Cases.case_names</span><span> </span><span class="entity"><span>exhaust_cases</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cases_type_attr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.internal</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Induct.cases_type</span></span><span> </span><span class="entity"><span>fcT_name</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nontriv_disc_eq_thmss</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq_False|fact"><span>eq_False</span></a><span class="main"><span>[</span></span><span class="operator"><span>THEN</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.iffD2|fact"><span>iffD2</span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span>
            </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq_True|fact"><span>eq_True</span></a><span class="main"><span>[</span></span><span class="operator"><span>THEN</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.iffD2|fact"><span>iffD2</span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>nontriv_disc_thmss</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>anonymous_notes</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>notE</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>distinct_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>safe_elim_attrs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span class="main"><span>(</span></span><span>flat</span><span> </span><span class="entity"><span>nontriv_disc_eq_thmss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nitpicksimp_attrs</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
          </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>attrs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Binding.empty</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>attrs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>thms</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>notes</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>caseN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>case_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nitpicksimp_attrs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>simp_attrs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span class="main"><span>(</span></span><span class="entity"><span>case_congN</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>case_cong_thm</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span class="main"><span>(</span></span><span class="entity"><span>case_cong_weak_thmsN</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>case_cong_weak_thm</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cong_attrs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span class="main"><span>(</span></span><span class="entity"><span>case_distribN</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>case_distrib_thm</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span class="main"><span>(</span></span><span class="entity"><span>case_eq_ifN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>case_eq_if_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span class="main"><span>(</span></span><span class="entity"><span>collapseN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>safe_collapse_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>ms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>simp_attrs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span class="main"><span>(</span></span><span class="entity"><span>discN</span></span><span class="main"><span>,</span></span><span> </span><span>flat</span><span> </span><span class="entity"><span>nontriv_disc_thmss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>simp_attrs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span class="main"><span>(</span></span><span class="entity"><span>disc_eq_caseN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>disc_eq_case_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span class="main"><span>(</span></span><span class="entity"><span>discIN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nontriv_discI_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span class="main"><span>(</span></span><span class="entity"><span>distinctN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>distinct_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>simp_attrs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>inductsimp_attrs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span class="main"><span>(</span></span><span class="entity"><span>distinct_discN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>distinct_disc_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>dest_attrs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span class="main"><span>(</span></span><span class="entity"><span>exhaustN</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>exhaust_thm</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>exhaust_case_names_attr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cases_type_attr</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span class="main"><span>(</span></span><span class="entity"><span>exhaust_discN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>exhaust_disc_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>exhaust_case_names_attr</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span class="main"><span>(</span></span><span class="entity"><span>exhaust_selN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>exhaust_sel_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>exhaust_case_names_attr</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span class="main"><span>(</span></span><span class="entity"><span>expandN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>expand_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span class="main"><span>(</span></span><span class="entity"><span>injectN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>inject_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>iff_attrs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>inductsimp_attrs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span class="main"><span>(</span></span><span class="entity"><span>nchotomyN</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>nchotomy_thm</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span class="main"><span>(</span></span><span class="entity"><span>selN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>all_sel_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nitpicksimp_attrs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>simp_attrs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span class="main"><span>(</span></span><span class="entity"><span>splitN</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>split_thm</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span class="main"><span>(</span></span><span class="entity"><span>split_asmN</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>split_asm_thm</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span class="main"><span>(</span></span><span class="entity"><span>split_selN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>split_sel_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span class="main"><span>(</span></span><span class="entity"><span>split_sel_asmN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>split_sel_asm_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span class="main"><span>(</span></span><span class="entity"><span>split_selsN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>split_sel_thms</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>split_sel_asm_thms</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span class="main"><span>(</span></span><span class="entity"><span>splitsN</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>split_thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>split_asm_thm</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
          </span><span>|&gt;</span><span> </span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thmN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>attrs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>qualify</span></span><span> </span><span>true</span><span> </span><span class="main"><span>(</span></span><span>Binding.name</span><span> </span><span class="entity"><span>thmN</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>attrs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>thms</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>noted</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>Spec_Rules.add</span></span><span> </span><span>Binding.empty</span><span> </span><span class="entity"><span>Spec_Rules.equational</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>casex</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>case_thms</span></span><span>
          </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>uncurry</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Spec_Rules.add</span></span><span> </span><span>Binding.empty</span><span> </span><span class="entity"><span>Spec_Rules.equational</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>(</span></span><span>AList.group</span><span> </span><span class="main"><span>(</span></span><span>eq_list</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconv</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>`</span><span class="main"><span>(</span></span><span>single</span><span> </span><span>o</span><span> </span><span class="entity"><span>lhs_head_of</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>all_sel_thms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>uncurry</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Spec_Rules.add</span></span><span> </span><span>Binding.empty</span><span> </span><span class="entity"><span>Spec_Rules.equational</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>(</span></span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>single</span><span> </span><span class="entity"><span>discs</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>nontriv_disc_eq_thmss</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>Local_Theory.declaration</span><span> </span><span class="main"><span>{</span></span><span>syntax</span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span> </span><span>pervasive</span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span class="main"><span>}</span></span><span>
            </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Case_Translation.register</span></span><span>
               </span><span class="main"><span>(</span></span><span>Morphism.term</span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>casex</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Morphism.term</span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctrs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>plugins</span></span><span> </span><span class="entity"><span>code_plugin</span></span><span> </span><span>?</span><span>
             </span><span class="main"><span>(</span></span><span class="entity"><span>Code.declare_default_eqns</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>rpair</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>flat</span><span> </span><span class="entity"><span>nontriv_disc_eq_thmss</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>case_thms</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>all_sel_thms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
             </span><span>#&gt;</span><span> </span><span>Local_Theory.declaration</span><span> </span><span class="main"><span>{</span></span><span>syntax</span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span> </span><span>pervasive</span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>}</span></span><span>
               </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Context.mapping</span><span>
                  </span><span class="main"><span>(</span></span><span class="entity"><span>add_ctr_code</span></span><span> </span><span class="entity"><span>fcT_name</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Morphism.typ</span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>As</span></span><span class="main"><span>)</span></span><span>
                     </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>dest_Const</span><span> </span><span>o</span><span> </span><span>Morphism.term</span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctrs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Morphism.fact</span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>inject_thms</span></span><span class="main"><span>)</span></span><span>
                     </span><span class="main"><span>(</span></span><span>Morphism.fact</span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>distinct_thms</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Morphism.fact</span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>case_thms</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                  </span><span>I</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>Local_Theory.notes</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>anonymous_notes</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>notes</span></span><span class="main"><span>)</span></span><span>
          </span><span class="comment1"><span>(* for "datatype_realizer.ML": *)</span></span><span>
          </span><span>|&gt;&gt;</span><span> </span><span class="entity"><span>name_noted_thms</span></span><span> </span><span class="entity"><span>fcT_name</span></span><span> </span><span class="entity"><span>exhaustN</span></span><span class="main"><span>;</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctr_sugar</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>{</span></span><span>kind</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>kind</span></span><span class="main"><span>,</span></span><span> </span><span>T</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fcT</span></span><span class="main"><span>,</span></span><span> </span><span>ctrs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctrs</span></span><span class="main"><span>,</span></span><span> </span><span>casex</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>casex</span></span><span class="main"><span>,</span></span><span> </span><span>discs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>discs</span></span><span class="main"><span>,</span></span><span> </span><span>selss</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>selss</span></span><span class="main"><span>,</span></span><span>
           </span><span>exhaust</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>exhaust_thm</span></span><span class="main"><span>,</span></span><span> </span><span>nchotomy</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nchotomy_thm</span></span><span class="main"><span>,</span></span><span> </span><span>injects</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>inject_thms</span></span><span class="main"><span>,</span></span><span>
           </span><span>distincts</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>distinct_thms</span></span><span class="main"><span>,</span></span><span> </span><span>case_thms</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>case_thms</span></span><span class="main"><span>,</span></span><span> </span><span>case_cong</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>case_cong_thm</span></span><span class="main"><span>,</span></span><span>
           </span><span>case_cong_weak</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>case_cong_weak_thm</span></span><span class="main"><span>,</span></span><span> </span><span>case_distribs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>case_distrib_thm</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
           </span><span>split</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>split_thm</span></span><span class="main"><span>,</span></span><span> </span><span>split_asm</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>split_asm_thm</span></span><span class="main"><span>,</span></span><span> </span><span>disc_defs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nontriv_disc_defs</span></span><span class="main"><span>,</span></span><span>
           </span><span>disc_thmss</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>disc_thmss</span></span><span class="main"><span>,</span></span><span> </span><span>discIs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>discI_thms</span></span><span class="main"><span>,</span></span><span> </span><span>disc_eq_cases</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>disc_eq_case_thms</span></span><span class="main"><span>,</span></span><span>
           </span><span>sel_defs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>sel_defs</span></span><span class="main"><span>,</span></span><span> </span><span>sel_thmss</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>sel_thmss</span></span><span class="main"><span>,</span></span><span> </span><span>distinct_discsss</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>distinct_disc_thmsss</span></span><span class="main"><span>,</span></span><span>
           </span><span>exhaust_discs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>exhaust_disc_thms</span></span><span class="main"><span>,</span></span><span> </span><span>exhaust_sels</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>exhaust_sel_thms</span></span><span class="main"><span>,</span></span><span>
           </span><span>collapses</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>all_collapse_thms</span></span><span class="main"><span>,</span></span><span> </span><span>expands</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>expand_thms</span></span><span class="main"><span>,</span></span><span> </span><span>split_sels</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>split_sel_thms</span></span><span class="main"><span>,</span></span><span>
           </span><span>split_sel_asms</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>split_sel_asm_thms</span></span><span class="main"><span>,</span></span><span> </span><span>case_eq_ifs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>case_eq_if_thms</span></span><span class="main"><span>}</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>morph_ctr_sugar</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>substitute_noted_thm</span></span><span> </span><span class="entity"><span>noted</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>ctr_sugar</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy'</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>register_ctr_sugar</span></span><span> </span><span class="entity"><span>plugins</span></span><span> </span><span class="entity"><span>ctr_sugar</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>goalss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>after_qed</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>free_constructors</span></span><span> </span><span class="entity"><span>kind</span></span><span> </span><span class="entity"><span>tacss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>goalss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>after_qed</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
  </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>Thm.close_derivation</span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span> </span><span>oo</span><span> </span><span>Goal.prove_sorry</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>goalss</span></span><span> </span><span class="entity"><span>tacss</span></span><span>
  </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>after_qed</span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>oo</span><span> </span><span class="entity"><span>prepare_free_constructors</span></span><span> </span><span class="entity"><span>kind</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>I</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>I</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>free_constructors_cmd</span></span><span> </span><span class="entity"><span>kind</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>goalss</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>after_qed</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
  </span><span class="entity"><span>Proof.theorem</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>oo</span><span> </span><span class="entity"><span>after_qed</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>rpair</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>goalss</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span>oo</span><span>
  </span><span class="entity"><span>prepare_free_constructors</span></span><span> </span><span class="entity"><span>kind</span></span><span> </span><span class="entity"><span>Plugin_Name.make_filter</span></span><span> </span><span>Syntax.read_term</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_bound_term</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Parse.binding</span><span> </span><span>--|</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>:</span></span><span>›</span></span></span><span> </span><span>--</span><span> </span><span>Parse.term</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>ctr_options</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Plugin_Name.filter</span></span><span> * </span><span>bool</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>ctr_options_cmd</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Plugin_Name.filter</span></span><span class="main"><span>)</span></span><span> * </span><span>bool</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>default_ctr_options</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ctr_options</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Plugin_Name.default_filter</span></span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>default_ctr_options_cmd</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ctr_options_cmd</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="entity"><span>Plugin_Name.default_filter</span></span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_ctr_options</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>(</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Parse.list1</span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>Plugin_Name.parse_filter</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span>o</span><span> </span><span>K</span><span class="main"><span>)</span></span><span>
         </span><span>||</span><span> </span><span>Parse.reserved</span><span> </span><span class="inner_quoted"><span>"discs_sels"</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span>o</span><span> </span><span>K</span><span> </span><span>o</span><span> </span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>--|</span><span>
      </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>)</span></span><span>›</span></span></span><span>
      </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>fs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>fold</span><span> </span><span>I</span><span> </span><span class="entity"><span>fs</span></span><span> </span><span class="entity"><span>default_ctr_options_cmd</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="entity"><span>default_ctr_options_cmd</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parse_ctr_spec</span></span><span> </span><span class="entity"><span>parse_ctr</span></span><span> </span><span class="entity"><span>parse_arg</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>parse_opt_binding_colon</span></span><span> </span><span>--</span><span> </span><span class="entity"><span>parse_ctr</span></span><span> </span><span>--</span><span> </span><span>Scan.repeat</span><span> </span><span class="entity"><span>parse_arg</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_ctr_specs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Parse.enum1</span><span> </span><span class="inner_quoted"><span>"|"</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>parse_ctr_spec</span></span><span> </span><span>Parse.term</span><span> </span><span>Parse.binding</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_sel_default_eqs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>where</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Parse.enum1</span><span> </span><span class="inner_quoted"><span>"|"</span></span><span> </span><span>Parse.prop</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Outer_Syntax.local_theory_to_proof</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword1"><span>free_constructors</span></span><span>›</span></span></span><span>
    </span><span class="inner_quoted"><span>"register an existing freely generated type's constructors"</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>parse_ctr_options</span></span><span> </span><span>--</span><span> </span><span>Parse.binding</span><span> </span><span>--|</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>for</span></span><span>›</span></span></span><span> </span><span>--</span><span> </span><span class="entity"><span>parse_ctr_specs</span></span><span>
       </span><span>--</span><span> </span><span class="entity"><span>parse_sel_default_eqs</span></span><span>
     </span><span>&gt;&gt;</span><span> </span><span class="entity"><span>free_constructors_cmd</span></span><span> </span><span class="entity"><span>Unknown</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>



</span><span class="comment1"><span>(** external views **)</span></span><span>

</span><span class="comment1"><span>(* document antiquotations *)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>antiquote_setup</span></span><span> </span><span class="entity"><span>binding</span></span><span> </span><span class="entity"><span>co</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Document_Output.antiquotation_pretty_source_embedded</span></span><span> </span><span class="entity"><span>binding</span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Scan.ahead</span><span> </span><span class="main"><span>(</span></span><span>Scan.lift</span><span> </span><span>Parse.not_eof</span><span class="main"><span>)</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>Token.pos_of</span><span class="main"><span>)</span></span><span> </span><span>--</span><span>
      </span><span>Args.type_name</span><span> </span><span class="main"><span>{</span></span><span>proper</span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span class="main"><span>,</span></span><span> </span><span>strict</span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>type_name</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Bad "</span></span><span> </span><span>^</span><span> </span><span>Binding.name_of</span><span> </span><span class="entity"><span>binding</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>": "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>type_name</span></span><span> </span><span>^</span><span> </span><span>Position.here</span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>ctr_sugar_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>type_name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>kind</span></span><span class="main"><span>,</span></span><span> </span><span>T</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>T0</span></span><span class="main"><span>,</span></span><span> </span><span>ctrs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctrs0</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>co</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kind</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Codatatype</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.unvarifyT_global</span><span> </span><span class="entity"><span>T0</span></span><span class="main"><span>;</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>Logic.unvarify_global</span><span> </span><span class="entity"><span>ctrs0</span></span><span class="main"><span>;</span></span><span>

              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pretty_typ_bracket</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax.pretty_typ</span><span> </span><span class="main"><span>(</span></span><span>Config.put</span><span> </span><span>pretty_priority</span><span> </span><span class="inner_numeral"><span>1001</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pretty_ctr</span></span><span> </span><span class="entity"><span>ctr</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span>Pretty.block</span><span> </span><span class="main"><span>(</span></span><span>Pretty.breaks</span><span> </span><span class="main"><span>(</span></span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ctr</span></span><span> </span><span>::</span><span>
                  </span><span>map</span><span> </span><span class="entity"><span>pretty_typ_bracket</span></span><span> </span><span class="main"><span>(</span></span><span>binder_types</span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>ctr</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span>Pretty.block</span><span> </span><span class="main"><span>(</span></span><span>Pretty.keyword1</span><span> </span><span class="main"><span>(</span></span><span>Binding.name_of</span><span> </span><span class="entity"><span>binding</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>::</span><span>
                </span><span>Syntax.pretty_typ</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>::</span><span> </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>" ="</span></span><span> </span><span>::</span><span> </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>::</span><span>
                </span><span>flat</span><span> </span><span class="main"><span>(</span></span><span>separate</span><span> </span><span class="main"><span>[</span></span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"| "</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>single</span><span> </span><span>o</span><span> </span><span class="entity"><span>pretty_ctr</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctrs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Theory.setup</span><span>
   </span><span class="main"><span>(</span></span><span class="entity"><span>antiquote_setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>datatype</span><span>›</span></span></span><span> </span><span>false</span><span> </span><span>#&gt;</span><span>
    </span><span class="entity"><span>antiquote_setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>codatatype</span><span>›</span></span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* theory export *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span>Theory.setup</span><span> </span><span>o</span><span> </span><span class="entity"><span>Thy_Info.add_presentation</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>Export_Theory.export_enabled</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parents</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Data.get</span><span> </span><span>o</span><span> </span><span>Context.Theory</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Theory.parents_of</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>datatypes</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>(</span></span><span>Data.get</span><span> </span><span class="main"><span>(</span></span><span>Context.Theory</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span>|-&gt;</span><span> </span><span>Symtab.fold</span><span>
            </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>kind</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctrs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>kind</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Record</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Symtab.defined</span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>parents</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>I</span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pos_properties</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Thy_Info.adjust_pos_properties</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>;</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>typ</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.unvarifyT_global</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>;</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>constrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>Logic.unvarify_global</span><span> </span><span class="entity"><span>ctrs</span></span><span class="main"><span>;</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>typargs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>rev</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span>Term.add_tfrees</span><span> </span><span class="main"><span>(</span></span><span>Logic.mk_type</span><span> </span><span class="entity"><span>typ</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>constrs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>constructors</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span>Term.type_of</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>constrs</span></span><span class="main"><span>;</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                  </span><span>cons</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pos_properties</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kind</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Codatatype</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>typargs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>typ</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>constructors</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>datatypes</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="entity"><span>Export_Theory.export_body</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="inner_quoted"><span>"datatypes"</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>XML.Encode</span><span> </span><span>Term_XML.Encode</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span>list</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span>properties</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span>string</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span>bool</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span class="main"><span>(</span></span><span>list</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span>string</span><span> </span><span>sort</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span>typ</span><span> </span><span class="main"><span>(</span></span><span>list</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span class="main"><span>(</span></span><span>term</span><span> </span><span class="main"><span>(</span></span><span>Sign.consts_of</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>typ</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>datatypes</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
</span></pre>
</body>

</html>