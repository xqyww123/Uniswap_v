<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Tools/Sledgehammer/sledgehammer_fact.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Tools/Sledgehammer/sledgehammer_fact.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      HOL/Tools/Sledgehammer/sledgehammer_fact.ML
    Author:     Jia Meng, Cambridge University Computer Laboratory and NICTA
    Author:     Jasmin Blanchette, TU Muenchen

Sledgehammer fact handling.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>SLEDGEHAMMER_FACT</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>status</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ATP_Problem_Generate.status</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>stature</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ATP_Problem_Generate.stature</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>lazy_fact</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>unit</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span class="main"><span>)</span></span><span> * </span><span class="entity"><span>stature</span></span><span class="main"><span>)</span></span><span> * </span><span>thm</span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>fact</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span class="entity"><span>stature</span></span><span class="main"><span>)</span></span><span> * </span><span>thm</span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>fact_override</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>{</span></span><span>add</span><span> </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>Facts.ref</span><span> * </span><span>Token.src</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     </span><span>del</span><span> </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>Facts.ref</span><span> * </span><span>Token.src</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     </span><span>only</span><span> </span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>}</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> no_fact_override </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>fact_override</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> fact_of_ref </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Keyword.keywords</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>status</span></span><span> </span><span>Termtab.table</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span>Facts.ref</span><span> * </span><span>Token.src</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string</span><span> * </span><span class="entity"><span>stature</span></span><span class="main"><span>)</span></span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> cartouche_thm </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> is_blacklisted_or_something </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> clasimpset_rule_table_of </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>status</span></span><span> </span><span>Termtab.table</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> build_name_tables </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>'a</span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span>string</span><span> </span><span>Symtab.table</span><span> * </span><span>string</span><span> </span><span>Symtab.table</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> fact_distinct </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> * </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>'a</span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>'a</span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> instantiate_inducts </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>unit</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span class="main"><span>)</span></span><span> * </span><span>'a</span><span class="main"><span>)</span></span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>unit</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span class="main"><span>)</span></span><span> * </span><span>'a</span><span class="main"><span>)</span></span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> fact_of_lazy_fact </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>lazy_fact</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>fact</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> is_useful_unnamed_local_fact </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> all_facts </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Keyword.keywords</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="entity"><span>status</span></span><span> </span><span>Termtab.table</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>lazy_fact</span></span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> nearly_all_facts </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>fact_override</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Keyword.keywords</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="entity"><span>status</span></span><span> </span><span>Termtab.table</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>lazy_fact</span></span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> nearly_all_facts_of_context </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>fact_override</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>lazy_fact</span></span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> drop_duplicate_facts </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>lazy_fact</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>lazy_fact</span></span><span> </span><span>list</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Sledgehammer_Fact</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>SLEDGEHAMMER_FACT</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>ATP_Util</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>ATP_Problem_Generate</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Sledgehammer_Util</span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>lazy_fact</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>unit</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span class="main"><span>)</span></span><span> * </span><span class="entity"><span>stature</span></span><span class="main"><span>)</span></span><span> * </span><span>thm</span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>fact</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span class="entity"><span>stature</span></span><span class="main"><span>)</span></span><span> * </span><span>thm</span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>fact_override</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>add</span><span> </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>Facts.ref</span><span> * </span><span>Token.src</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   </span><span>del</span><span> </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>Facts.ref</span><span> * </span><span>Token.src</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   </span><span>only</span><span> </span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>local_thisN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Long_Name.localN</span><span> </span><span>^</span><span> </span><span>Long_Name.separator</span><span> </span><span>^</span><span> </span><span>Auto_Bind.thisN</span><span>

</span><span class="comment1"><span>(* gracefully handle huge background theories *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>max_facts_for_duplicates</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>50000</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>max_facts_for_complex_check</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>25000</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>max_simps_for_clasimpset</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>10000</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>no_fact_override</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>add</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span>del</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span>only</span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>needs_quoting</span></span><span> </span><span class="entity"><span>keywords</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Keyword.is_literal</span><span> </span><span class="entity"><span>keywords</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
  </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span>not</span><span> </span><span>o</span><span> </span><span>Symbol_Pos.is_identifier</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Long_Name.explode</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_name</span></span><span> </span><span class="entity"><span>keywords</span></span><span> </span><span class="entity"><span>multi</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>needs_quoting</span></span><span> </span><span class="entity"><span>keywords</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span>?</span><span> </span><span>quote</span><span class="main"><span>)</span></span><span> </span><span>^</span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>multi</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_quoted"><span>"("</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>j</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>")"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>explode_interval</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span>Facts.FromTo</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>upto</span><span> </span><span class="entity"><span>j</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>explode_interval</span></span><span> </span><span class="entity"><span>max</span></span><span> </span><span class="main"><span>(</span></span><span>Facts.From</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>upto</span><span> </span><span class="entity"><span>i</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>max</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>explode_interval</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span>Facts.Single</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>i</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_rec_eq</span></span><span> </span><span class="entity"><span>lhs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.exists_subterm</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>head_of</span><span> </span><span class="entity"><span>lhs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_rec_def</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t</span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>is_rec_def</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_rec_def</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.imp</span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>t2</span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>is_rec_def</span></span><span> </span><span class="entity"><span>t2</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_rec_def</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.eq</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>is_rec_eq</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_rec_def</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span> </span><span class="main"><span>_</span></span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>is_rec_eq</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_rec_def</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_assum</span></span><span> </span><span class="entity"><span>assms</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Thm.prop_of</span><span> </span><span class="entity"><span>th</span></span><span> </span><span>aconv</span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>ct</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>assms</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_chained</span></span><span> </span><span class="entity"><span>chained</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>member</span><span> </span><span>Thm.eq_thm_prop</span><span> </span><span class="entity"><span>chained</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>scope_of_thm</span></span><span> </span><span class="entity"><span>global</span></span><span> </span><span class="entity"><span>assms</span></span><span> </span><span class="entity"><span>chained</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_chained</span></span><span> </span><span class="entity"><span>chained</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>Chained</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>global</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>Global</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_assum</span></span><span> </span><span class="entity"><span>assms</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>Assum</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Local</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>may_be_induction</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>exists_subterm</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>body_type</span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(* TODO: get rid of *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>normalize_vars</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>normT</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_map</span><span> </span><span class="entity"><span>normT</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span>#&gt;&gt;</span><span> </span><span>curry</span><span> </span><span>Type</span><span> </span><span class="entity"><span>s</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>normT</span></span><span> </span><span class="main"><span>(</span></span><span>TVar</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>z</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>knownT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nT</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>find_index</span><span> </span><span class="main"><span>(</span></span><span>equal</span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>knownT</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>TVar</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Name.uu</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nT</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>z</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>knownT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nT</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>TVar</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Name.uu</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nT</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>j</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>knownT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nT</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>normT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>TFree</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>pair</span><span> </span><span class="entity"><span>T</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>norm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>norm</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>##&gt;&gt;</span><span> </span><span class="entity"><span>norm</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span>#&gt;&gt;</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>$</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>norm</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>normT</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>#&gt;&gt;</span><span> </span><span>curry</span><span> </span><span>Const</span><span> </span><span class="entity"><span>s</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>norm</span></span><span> </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>z</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>normT</span></span><span> </span><span class="entity"><span>T</span></span><span>
        </span><span>#&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>accumT</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>known</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>find_index</span><span> </span><span class="main"><span>(</span></span><span>equal</span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>known</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Name.uu</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>accumT</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>z</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>known</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Name.uu</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>j</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>accumT</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>known</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>norm</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>norm</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>##&gt;&gt;</span><span> </span><span class="entity"><span>normT</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>#&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span>Name.uu</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>norm</span></span><span> </span><span class="main"><span>(</span></span><span>Bound</span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>pair</span><span> </span><span class="main"><span>(</span></span><span>Bound</span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>norm</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>normT</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>#&gt;&gt;</span><span> </span><span>curry</span><span> </span><span>Free</span><span> </span><span class="entity"><span>s</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>fst</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>norm</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>status_of_thm</span></span><span> </span><span class="entity"><span>css</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Termtab.is_empty</span><span> </span><span class="entity"><span>css</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="entity"><span>General</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.prop_of</span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="comment1"><span>(* FIXME: use structured name *)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>String.isSubstring</span><span> </span><span class="inner_quoted"><span>".induct"</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>may_be_induction</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="entity"><span>Induction</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>normalize_vars</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Termtab.lookup</span><span> </span><span class="entity"><span>css</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>SOME</span><span> </span><span class="entity"><span>status</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>status</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.strip_imp_concl</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.dest_eq</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                </span><span>SOME</span><span> </span><span class="entity"><span>lrhss</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.strip_imp_prems</span><span> </span><span class="entity"><span>t</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.list_implies</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span> </span><span>Logic.mk_equals</span><span> </span><span class="entity"><span>lrhss</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                  </span><span>Termtab.lookup</span><span> </span><span class="entity"><span>css</span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span>|&gt;</span><span> </span><span>the_default</span><span> </span><span class="entity"><span>General</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>General</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>stature_of_thm</span></span><span> </span><span class="entity"><span>global</span></span><span> </span><span class="entity"><span>assms</span></span><span> </span><span class="entity"><span>chained</span></span><span> </span><span class="entity"><span>css</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>scope_of_thm</span></span><span> </span><span class="entity"><span>global</span></span><span> </span><span class="entity"><span>assms</span></span><span> </span><span class="entity"><span>chained</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>status_of_thm</span></span><span> </span><span class="entity"><span>css</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fact_of_ref</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>keywords</span></span><span> </span><span class="entity"><span>chained</span></span><span> </span><span class="entity"><span>css</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>xthm</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>xref</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ths</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.eval_thms</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>xthm</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bracket</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>implode</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>enclose</span><span> </span><span class="inner_quoted"><span>"["</span></span><span> </span><span class="inner_quoted"><span>"]"</span></span><span> </span><span>o</span><span> </span><span>Pretty.unformatted_string_of</span><span> </span><span>o</span><span> </span><span>Token.pretty_src</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>nth_name</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>xref</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>Facts.Fact</span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>cartouche</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>simplify_spaces</span></span><span> </span><span class="main"><span>(</span></span><span>YXML.content_of</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>bracket</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>Facts.Named</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"["</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>bracket</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"]"</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>Facts.Named</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>make_name</span></span><span> </span><span class="entity"><span>keywords</span></span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>ths</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>bracket</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>Facts.Named</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>intervals</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>make_name</span></span><span> </span><span class="entity"><span>keywords</span></span><span> </span><span>true</span><span>
          </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="main"><span>(</span></span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>explode_interval</span></span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>ths</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>intervals</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>bracket</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_nth</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rest</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nth_name</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>stature_of_thm</span></span><span> </span><span>false</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>chained</span></span><span> </span><span class="entity"><span>css</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>rest</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="entity"><span>add_nth</span></span><span> </span><span class="entity"><span>ths</span></span><span> </span><span>|&gt;</span><span> </span><span>snd</span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(* Reject theorems with names like "List.filter.filter_list_def" or "Accessible_Part.acc.defs", as
   these are definitions arising from packages. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_package_def</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>suf</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>String.isSuffix</span><span> </span><span class="entity"><span>suf</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"_case_def"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"_rec_def"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"_size_def"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"_size_overloaded_def"</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Long_Name.explode</span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>length</span><span> </span><span class="entity"><span>ss</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>ss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"local"</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(* FIXME: put other record thms here, or declare as "no_atp" *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>multi_base_blacklist</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"defs"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"select_defs"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"update_defs"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"split"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"splits"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"split_asm"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"ext_cases"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"eq.simps"</span></span><span class="main"><span>,</span></span><span>
   </span><span class="inner_quoted"><span>"eq.refl"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"nchotomy"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"case_cong"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"case_cong_weak"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"nat_of_char_simps"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"nibble.simps"</span></span><span class="main"><span>,</span></span><span>
   </span><span class="inner_quoted"><span>"nibble.distinct"</span></span><span class="main"><span>]</span></span><span>
  </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>prefix</span><span> </span><span>Long_Name.separator</span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(* The maximum apply depth of any "metis" call in "Metis_Examples" (back in 2007) was 11. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>max_apply_depth</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>18</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>apply_depth</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Int.max</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>apply_depth</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>apply_depth</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>apply_depth</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>apply_depth</span></span><span> </span><span class="entity"><span>t</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>apply_depth</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_too_complex</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>apply_depth</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>&gt;</span><span> </span><span class="entity"><span>max_apply_depth</span></span><span>

</span><span class="comment1"><span>(* FIXME: Ad hoc list *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>technical_prefixes</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"ATP"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"Code_Evaluation"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"Datatype"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"Enum"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"Lazy_Sequence"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"Limited_Sequence"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"Meson"</span></span><span class="main"><span>,</span></span><span>
   </span><span class="inner_quoted"><span>"Metis"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"Nitpick"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"Quickcheck_Random"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"Quickcheck_Exhaustive"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"Quickcheck_Narrowing"</span></span><span class="main"><span>,</span></span><span>
   </span><span class="inner_quoted"><span>"Random_Sequence"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"Sledgehammer"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"SMT"</span></span><span class="main"><span>]</span></span><span>
  </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>suffix</span><span> </span><span>Long_Name.separator</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_technical_const</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>pref</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>String.isPrefix</span><span> </span><span class="entity"><span>pref</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>technical_prefixes</span></span><span>

</span><span class="comment1"><span>(* FIXME: make more reliable *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sep_class_sep</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Long_Name.separator</span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"class"</span></span><span> </span><span>^</span><span> </span><span>Long_Name.separator</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_low_level_class_const</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.equal_class.equal|const"><span>equal_class.equal</span></a><span>›</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>String.isSubstring</span><span> </span><span class="entity"><span>sep_class_sep</span></span><span> </span><span class="entity"><span>s</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sep_that</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Long_Name.separator</span><span> </span><span>^</span><span> </span><span>Auto_Bind.thatN</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>skolem_thesis</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Name.skolem</span><span> </span><span>Auto_Bind.thesisN</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_that_fact</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>exists_subterm</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>skolem_thesis</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>String.isSuffix</span><span> </span><span class="entity"><span>sep_that</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.get_name_hint</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>interest</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Deal_Breaker</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Interesting</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Boring</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>combine_interests</span></span><span> </span><span class="entity"><span>Deal_Breaker</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Deal_Breaker</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>combine_interests</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>Deal_Breaker</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Deal_Breaker</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>combine_interests</span></span><span> </span><span class="entity"><span>Interesting</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Interesting</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>combine_interests</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>Interesting</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Interesting</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>combine_interests</span></span><span> </span><span class="entity"><span>Boring</span></span><span> </span><span class="entity"><span>Boring</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Boring</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>type_has_top_sort</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>exists_subtype</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>TFree</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span> </span><span class="main"><span>|</span></span><span> </span><span>TVar</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_likely_tautology_too_meta_or_too_technical</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_interesting_subterm</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>atp_widely_irrelevant_consts</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_interesting_subterm</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_interesting_subterm</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>interest_of_bool</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>exists_Const</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>is_technical_const</span></span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span>orf</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_low_level_class_const</span></span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span>orf</span><span>
          </span><span class="entity"><span>type_has_top_sort</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="entity"><span>Deal_Breaker</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>exists_type</span><span> </span><span class="main"><span>(</span></span><span>exists_subtype</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><span>prop</span><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
          </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>exists_subterm</span><span> </span><span class="entity"><span>is_interesting_subterm</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="entity"><span>Boring</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="entity"><span>Interesting</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>interest_of_prop</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t</span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>interest_of_bool</span></span><span> </span><span class="entity"><span>t</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>interest_of_prop</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.imp</span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>u</span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>combine_interests</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>interest_of_prop</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>interest_of_prop</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>interest_of_prop</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.all</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>type_has_top_sort</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>Deal_Breaker</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>interest_of_prop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>interest_of_prop</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.all</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>interest_of_prop</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>eta_expand</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>interest_of_prop</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.eq</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>combine_interests</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>interest_of_bool</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>interest_of_bool</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>interest_of_prop</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Deal_Breaker</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.prop_of</span><span> </span><span class="entity"><span>th</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>interest_of_prop</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="entity"><span>Interesting</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>Thm.eq_thm_prop</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../HOL.html#HOL.ext|fact"><span>ext</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
    </span><span class="entity"><span>is_that_fact</span></span><span> </span><span class="entity"><span>th</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>is_blacklisted_or_something</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>blist</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>multi_base_blacklist</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>is_package_def</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>String.isSuffix</span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>blist</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(* This is a terrible hack. Free variables are sometimes coded as "M__" when
   they are displayed as "M" and we want to avoid clashes with these. But
   sometimes it's even worse: "Ma__" encodes "M". So we simply reserve all
   prefixes of all free variables. In the worse case scenario, where the fact
   won't be resolved correctly, the user can fix it manually, e.g., by giving a
   name to the offending fact. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>all_prefixes_of</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>String.extract</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span>upto</span><span> </span><span>size</span><span> </span><span class="entity"><span>s</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>close_form</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span>|&gt;</span><span> </span><span>Term.add_free_names</span><span> </span><span class="entity"><span>t</span></span><span> </span><span>|&gt;</span><span> </span><span>maps</span><span> </span><span class="entity"><span>all_prefixes_of</span></span><span class="main"><span>)</span></span><span>
  </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>taken</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>s'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Name.variant_list</span><span> </span><span class="entity"><span>taken</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.boolT</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>HOLogic.all_const</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Logic.all_const</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T</span></span><span>
         </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span>abstract_over</span><span> </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
         </span><span class="entity"><span>s'</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>taken</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>(</span></span><span>Term.add_vars</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span>|&gt;</span><span> </span><span>sort_by</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span>|&gt;</span><span> </span><span>fst</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cartouche_term</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>close_form</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>hackish_string_of_term</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>#&gt;</span><span> </span><span>cartouche</span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cartouche_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cartouche_term</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>o</span><span> </span><span>Thm.prop_of</span><span>

</span><span class="comment1"><span>(* TODO: rewrite to use nets and/or to reuse existing data structures *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>clasimpset_rule_table_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>simps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>|&gt;</span><span> </span><span>simpset_of</span><span> </span><span>|&gt;</span><span> </span><span>dest_ss</span><span> </span><span>|&gt;</span><span> </span><span class="main"><span>#</span></span><span>simps</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>length</span><span> </span><span class="entity"><span>simps</span></span><span> </span><span>&gt;=</span><span> </span><span class="entity"><span>max_simps_for_clasimpset</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span>Termtab.empty</span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="entity"><span>stature</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Termtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>normalize_vars</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>stature</span></span><span class="main"><span>)</span></span><span>

        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>safeIs</span></span><span class="main"><span>,</span></span><span> </span><span class="comment1"><span>(* safeEs, *)</span></span><span> </span><span class="entity"><span>unsafeIs</span></span><span class="main"><span>,</span></span><span> </span><span class="comment1"><span>(* unsafeEs, *)</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>ctxt</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>claset_of</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>Classical.rep_cs</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>intros</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>(</span></span><span>Item_Net.content</span><span> </span><span class="entity"><span>safeIs</span></span><span> </span><span>@</span><span> </span><span>Item_Net.content</span><span> </span><span class="entity"><span>unsafeIs</span></span><span class="main"><span>)</span></span><span>
</span><span class="comment1"><span>(* Add once it is used:
        val elims = Item_Net.content safeEs @ Item_Net.content unsafeEs
          |&gt; map Classical.classical_rule
*)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>specs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Spec_Rules.get</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rec_defs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nonrec_defs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>specs</span></span><span>
          </span><span>|&gt;</span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Spec_Rules.is_equational</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>rough_classification</span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>maps</span><span> </span><span class="main"><span>#</span></span><span>rules</span><span>
          </span><span>|&gt;</span><span> </span><span>List.partition</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_rec_def</span></span><span> </span><span>o</span><span> </span><span>Thm.prop_of</span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>spec_intros</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>specs</span></span><span>
          </span><span>|&gt;</span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Spec_Rules.is_relational</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>rough_classification</span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>maps</span><span> </span><span class="main"><span>#</span></span><span>rules</span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>Termtab.empty</span><span>
        </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add</span></span><span> </span><span class="entity"><span>Simp</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>simps</span></span><span>
        </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add</span></span><span> </span><span class="entity"><span>Rec_Def</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rec_defs</span></span><span>
        </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add</span></span><span> </span><span class="entity"><span>Non_Rec_Def</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>nonrec_defs</span></span><span>
</span><span class="comment1"><span>(* Add once it is used:
        |&gt; fold (add Elim) elims
*)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add</span></span><span> </span><span class="entity"><span>Intro</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>intros</span></span><span>
        </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add</span></span><span> </span><span class="entity"><span>Inductive</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>spec_intros</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>normalize_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>is_less_equal</span><span> </span><span class="main"><span>(</span></span><span>Term_Ord.fast_term_ord</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>t0</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t1</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>normalize_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Not|const"><span>Not</span></a><span>›</span></span><span>
      </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>t0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>is_less_equal</span><span> </span><span class="main"><span>(</span></span><span>Term_Ord.fast_term_ord</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>HOLogic.mk_not</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t0</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t1</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>normalize_eq</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.eq</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>is_less_equal</span><span> </span><span class="main"><span>(</span></span><span>Term_Ord.fast_term_ord</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>HOLogic.eq_const</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>normalize_eq</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>if_thm_before</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="entity"><span>th'</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Context.subthy_id</span><span> </span><span class="main"><span>(</span></span><span>apply2</span><span> </span><span>Thm.theory_id</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>th'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>th'</span></span><span>

</span><span class="comment1"><span>(* Hack: Conflate the facts about a class as seen from the outside with the corresponding low-level
   facts, so that MaSh can learn from the low-level proofs. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>un_class_ify</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>first_field</span><span> </span><span class="inner_quoted"><span>"_class"</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pref</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>suf</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pref</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>suf</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>s</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>build_name_tables</span></span><span> </span><span class="entity"><span>name_of</span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cons_thm</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Termtab.cons_list</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>normalize_vars</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>normalize_eq</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_plain</span></span><span> </span><span class="entity"><span>canon</span></span><span> </span><span class="entity"><span>alias</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Symtab.update</span><span> </span><span class="main"><span>(</span></span><span>Thm.get_name_hint</span><span> </span><span class="entity"><span>alias</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>name_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>if_thm_before</span></span><span> </span><span class="entity"><span>canon</span></span><span> </span><span class="entity"><span>alias</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_plains</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>aliases</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>canon</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_plain</span></span><span> </span><span class="entity"><span>canon</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>aliases</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_inclass</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>target</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Symtab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>target</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>un_class_ify</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prop_tab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>cons_thm</span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span>Termtab.empty</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>plain_name_tab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Termtab.fold</span><span> </span><span class="entity"><span>add_plains</span></span><span> </span><span class="entity"><span>prop_tab</span></span><span> </span><span>Symtab.empty</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inclass_name_tab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.fold</span><span> </span><span class="entity"><span>add_inclass</span></span><span> </span><span class="entity"><span>plain_name_tab</span></span><span> </span><span>Symtab.empty</span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>plain_name_tab</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>inclass_name_tab</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fact_distinct</span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fact</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span>Net.insert_term_safe</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eq</span></span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>normalize_eq</span></span><span> </span><span>o</span><span> </span><span>Thm.prop_of</span><span> </span><span>o</span><span> </span><span>snd</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>normalize_eq</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fact</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>(</span></span><span>tag_list</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="entity"><span>facts</span></span><span class="main"><span>)</span></span><span> </span><span>Net.empty</span><span>
  </span><span>|&gt;</span><span> </span><span>Net.entries</span><span>
  </span><span>|&gt;</span><span> </span><span>sort</span><span> </span><span class="main"><span>(</span></span><span>int_ord</span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span>
  </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span>snd</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>struct_induct_rule_on</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Logic.strip_horn</span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>p_name</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ind_T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>is_TVar</span><span> </span><span class="entity"><span>ind_T</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>length</span><span> </span><span class="entity"><span>prems</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
       </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span>exists_subterm</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconv</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
       </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>exists</span><span> </span><span class="main"><span>(</span></span><span>exists_subterm</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconv</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ind_T</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span>NONE</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>instantiate_induct_timeout</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>seconds</span><span> </span><span class="inner_numeral"><span>0.01</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>instantiate_induct_rule</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>concl_prop</span></span><span> </span><span class="entity"><span>p_name</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>stature</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ind_x</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>varify_noninducts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ind_x</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>varify_noninducts</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>p_inst</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>concl_prop</span></span><span>
      </span><span>|&gt;</span><span> </span><span>map_aterms</span><span> </span><span class="entity"><span>varify_noninducts</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>close_form</span></span><span>
      </span><span>|&gt;</span><span> </span><span>lambda</span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="entity"><span>ind_x</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>hackish_string_of_term</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"[where "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>p_name</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" = "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>p_inst</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"]"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>stature</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
     </span><span class="entity"><span>th</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>Rule_Insts.read_instantiate</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>p_name</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Position.none</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p_inst</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>type_match</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span>Sign.typ_match</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T1</span></span><span class="main"><span>)</span></span><span> </span><span>Vartab.empty</span><span class="main"><span>;</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Type.TYPE_MATCH</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>instantiate_if_induct_rule</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>stmt</span></span><span> </span><span class="entity"><span>stmt_xs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ax</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>struct_induct_rule_on</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ind_T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>stmt_xs</span></span><span>
      </span><span>|&gt;</span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>type_match</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ind_T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span class="main"><span>(</span></span><span>Timeout.apply</span><span> </span><span class="entity"><span>instantiate_induct_timeout</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>instantiate_induct_rule</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>stmt</span></span><span> </span><span class="entity"><span>p_name</span></span><span> </span><span class="entity"><span>ax</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>ax</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>external_frees</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span>|&gt;</span><span> </span><span>Term.add_frees</span><span> </span><span class="entity"><span>t</span></span><span> </span><span>|&gt;</span><span> </span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span>Name.is_internal</span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>instantiate_inducts</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>hyp_ts</span></span><span> </span><span class="entity"><span>concl_t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ind_stmt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>hyp_ts</span></span><span> </span><span>|&gt;</span><span> </span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span>o</span><span> </span><span class="entity"><span>external_frees</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>concl_t</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Logic.list_implies</span><span> </span><span>|&gt;</span><span> </span><span>Object_Logic.atomize_term</span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ind_stmt_xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>external_frees</span></span><span> </span><span class="entity"><span>ind_stmt</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>instantiate_if_induct_rule</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ind_stmt</span></span><span> </span><span class="entity"><span>ind_stmt_xs</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fact_of_lazy_fact</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>stature</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>stature</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fact_count</span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Facts.fold_static</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>Integer.add</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_useful_unnamed_local_fact</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>global_facts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Global_Theory.facts_of</span><span> </span><span class="entity"><span>thy</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>local_facts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.facts_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>named_locals</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Facts.dest_static</span><span> </span><span>true</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>global_facts</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>local_facts</span></span><span>
      </span><span>|&gt;</span><span> </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>normalize_eq</span></span><span> </span><span>o</span><span> </span><span>Thm.prop_of</span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>Thm.has_name_hint</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
      </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconv</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>named_locals</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>normalize_eq</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>all_facts</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>generous</span></span><span> </span><span class="entity"><span>keywords</span></span><span> </span><span class="entity"><span>add_ths</span></span><span> </span><span class="entity"><span>chained</span></span><span> </span><span class="entity"><span>css</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>transfer</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Global_Theory.transfer_theories</span><span> </span><span class="entity"><span>thy</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>global_facts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Global_Theory.facts_of</span><span> </span><span class="entity"><span>thy</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>is_too_complex</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>generous</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>fact_count</span></span><span> </span><span class="entity"><span>global_facts</span></span><span> </span><span>&gt;=</span><span> </span><span class="entity"><span>max_facts_for_complex_check</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>K</span><span> </span><span>false</span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>is_too_complex</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>local_facts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.facts_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>assms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Assumption.all_assms_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>named_locals</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Facts.dest_static</span><span> </span><span>true</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>global_facts</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>local_facts</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>unnamed_locals</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Facts.props</span><span> </span><span class="entity"><span>local_facts</span></span><span>
      </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span>
      </span><span>|&gt;</span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_useful_unnamed_local_fact</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span>o</span><span> </span><span>single</span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>full_space</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Name_Space.merge</span><span> </span><span class="main"><span>(</span></span><span>Facts.space_of</span><span> </span><span class="entity"><span>global_facts</span></span><span class="main"><span>,</span></span><span> </span><span>Facts.space_of</span><span> </span><span class="entity"><span>local_facts</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_facts</span></span><span> </span><span class="entity"><span>global</span></span><span> </span><span class="entity"><span>foldx</span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>foldx</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ths</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>accum</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>name0</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
           </span><span class="main"><span>(</span></span><span>Long_Name.is_hidden</span><span> </span><span class="main"><span>(</span></span><span>Facts.intern</span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="entity"><span>name0</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
            </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Facts.is_concealed</span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="entity"><span>name0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
              </span><span class="main"><span>(</span></span><span>not</span><span> </span><span class="entity"><span>generous</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>is_blacklisted_or_something</span></span><span> </span><span class="entity"><span>name0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
             </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span>not</span><span> </span><span>o</span><span> </span><span>member</span><span> </span><span>Thm.eq_thm_prop</span><span> </span><span class="entity"><span>add_ths</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ths</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="entity"><span>accum</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>ths</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>collection</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>1</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dotted_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="main"><span>(</span></span><span>Long_Name.explode</span><span> </span><span class="entity"><span>name0</span></span><span class="main"><span>)</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="comment1"><span>(* ignore theory name *)</span></span><span>

            </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_thms</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.get_thms</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span>
              </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>ths'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>eq_list</span><span> </span><span>Thm.eq_thm_prop</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ths</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ths'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span>snd</span><span> </span><span class="main"><span>(</span></span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>th0</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>transfer</span></span><span> </span><span class="entity"><span>th0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>
                 </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span>Thm.eq_thm_prop</span><span> </span><span class="entity"><span>add_ths</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
                    </span><span class="main"><span>(</span></span><span class="entity"><span>is_likely_tautology_too_meta_or_too_technical</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
                     </span><span class="entity"><span>is_too_complex</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                   </span><span class="entity"><span>accum</span></span><span>
                 </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                   </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                     </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_name</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                       </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>name0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>name0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>local_thisN</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                         </span><span class="entity"><span>cartouche_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>th</span></span><span>
                       </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                         </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>short_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Facts.extern</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="entity"><span>name0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                           </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>check_thms</span></span><span> </span><span class="entity"><span>short_name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                             </span><span class="entity"><span>short_name</span></span><span>
                           </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                             </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>long_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Name_Space.extern</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>full_space</span></span><span> </span><span class="entity"><span>name0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                               </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>check_thms</span></span><span> </span><span class="entity"><span>long_name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                                 </span><span class="entity"><span>long_name</span></span><span>
                               </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                                 </span><span class="entity"><span>name0</span></span><span>
                             </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
                         </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
                         </span><span>|&gt;</span><span> </span><span class="entity"><span>make_name</span></span><span> </span><span class="entity"><span>keywords</span></span><span> </span><span class="entity"><span>collection</span></span><span> </span><span class="entity"><span>j</span></span><span>
                     </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>stature</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>stature_of_thm</span></span><span> </span><span class="entity"><span>global</span></span><span> </span><span class="entity"><span>assms</span></span><span> </span><span class="entity"><span>chained</span></span><span> </span><span class="entity"><span>css</span></span><span> </span><span class="entity"><span>name0</span></span><span> </span><span class="entity"><span>th</span></span><span>
                     </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>new</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>get_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>stature</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span>
                   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                     </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>collection</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>apsnd</span><span> </span><span>o</span><span> </span><span>apsnd</span><span>
                      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>dotted_name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>apsnd</span><span> </span><span>o</span><span> </span><span>apfst</span><span>
                      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>apfst</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>cons</span><span> </span><span class="entity"><span>new</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>accum</span></span><span>
                   </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ths</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="comment1"><span>(* Names like "xxx" are preferred to "xxx.yyy", which are preferred to "xxx(666)" and the like.
       "Preferred" means "put to the front of the list". *)</span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>add_facts</span></span><span> </span><span>false</span><span> </span><span>fold</span><span> </span><span class="entity"><span>local_facts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unnamed_locals</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>named_locals</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>add_facts</span></span><span> </span><span>true</span><span> </span><span>Facts.fold_static</span><span> </span><span class="entity"><span>global_facts</span></span><span> </span><span class="entity"><span>global_facts</span></span><span>
    </span><span>||&gt;</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>@</span><span> </span><span>|&gt;</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>@</span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>nearly_all_facts</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>inst_inducts</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>add</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>del</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>only</span></span><span class="main"><span>}</span></span><span> </span><span class="entity"><span>keywords</span></span><span> </span><span class="entity"><span>css</span></span><span> </span><span class="entity"><span>chained</span></span><span> </span><span class="entity"><span>hyp_ts</span></span><span> </span><span class="entity"><span>concl_t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>only</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>chained</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>chained</span></span><span> </span><span>|&gt;</span><span> </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>insert</span><span> </span><span>Thm.eq_thm_prop</span><span> </span><span class="main"><span>(</span></span><span>zero_var_indexes</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>th</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>only</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
         </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>stature</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>stature</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
           </span><span>o</span><span> </span><span class="entity"><span>fact_of_ref</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>keywords</span></span><span> </span><span class="entity"><span>chained</span></span><span> </span><span class="entity"><span>css</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>add</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
           </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>del</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apply2</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Attrib.eval_thms</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>del</span></span><span class="main"><span>)</span></span><span>
           </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="main"><span>=</span></span><span>
             </span><span class="entity"><span>all_facts</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>keywords</span></span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="entity"><span>chained</span></span><span> </span><span class="entity"><span>css</span></span><span>
             </span><span>|&gt;</span><span> </span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>member</span><span> </span><span>Thm.eq_thm_prop</span><span> </span><span class="entity"><span>del</span></span><span> </span><span>orf</span><span>
               </span><span class="main"><span>(</span></span><span class="entity"><span>Named_Theorems.member</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">named_theorems</span><span class="hidden">&gt;</span></span></span><span>‹no_atp›</span></span><span> </span><span>andf</span><span>
                 </span><span>not</span><span> </span><span>o</span><span> </span><span>member</span><span> </span><span>Thm.eq_thm_prop</span><span> </span><span class="entity"><span>add</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
           </span><span class="entity"><span>facts</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>inst_inducts</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>instantiate_inducts</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>hyp_ts</span></span><span> </span><span class="entity"><span>concl_t</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>nearly_all_facts_of_context</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>inst_inducts</span></span><span> </span><span class="entity"><span>fact_override</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>keywords</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thy_Header.get_keywords'</span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>css</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>clasimpset_rule_table_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>nearly_all_facts</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>inst_inducts</span></span><span> </span><span class="entity"><span>fact_override</span></span><span> </span><span class="entity"><span>keywords</span></span><span> </span><span class="entity"><span>css</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>drop_duplicate_facts</span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>num_facts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>facts</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>num_facts</span></span><span> </span><span>&lt;=</span><span> </span><span class="entity"><span>max_facts_for_duplicates</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>fact_distinct</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconv</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
</span></pre>
</body>

</html>