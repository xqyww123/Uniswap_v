<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Tools/Sledgehammer/sledgehammer_isar_annotate.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Tools/Sledgehammer/sledgehammer_isar_annotate.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      HOL/Tools/Sledgehammer/sledgehammer_isar_annotate.ML
    Author:     Steffen Juilf Smolka, TU Muenchen
    Author:     Jasmin Blanchette, TU Muenchen

Supplements term with a locally minimal, complete set of type constraints.
Complete: The constraints suffice to infer the term's types. Minimal: Reducing
the set of constraints further will make it incomplete.

When configuring the pretty printer appropriately, the constraints will show up
as type annotations when printing the term. This allows the term to be printed
and reparsed without a change of types.

Terms should be unchecked before calling "annotate_types_in_term" to avoid
awkward syntax.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>SLEDGEHAMMER_ISAR_ANNOTATE</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> annotate_types_in_term </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Sledgehammer_Isar_Annotate</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>SLEDGEHAMMER_ISAR_ANNOTATE</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>post_traverse_term_type'</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>s</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>post_traverse_term_type'</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>s</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>post_traverse_term_type'</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>s</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>post_traverse_term_type'</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Bound</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>post_traverse_term_type'</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>b'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>post_traverse_term_type'</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T1</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>env</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>b'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T1</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s'</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>post_traverse_term_type'</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>u'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>post_traverse_term_type'</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="entity"><span>s</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>v'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s''</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>post_traverse_term_type'</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="entity"><span>s'</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u'</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>v'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>s''</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Bind</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"Sledgehammer_Isar_Annotate: post_traverse_term_type'"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>post_traverse_term_type</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>post_traverse_term_type'</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span>|&gt;</span><span> </span><span>fst</span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>post_fold_term_type</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>post_traverse_term_type</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>|&gt;</span><span> </span><span>snd</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fold_map_atypes</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fold_map_atypes</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>indexname_ord</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term_Ord.fast_indexname_ord</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cost_ord</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>prod_ord</span><span> </span><span>int_ord</span><span> </span><span class="main"><span>(</span></span><span>prod_ord</span><span> </span><span>int_ord</span><span> </span><span>int_ord</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Var_Set_Tab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Table</span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>indexname</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ord</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>list_ord</span><span> </span><span class="entity"><span>indexname_ord</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>generalize_types</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>erase_types</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_types</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>dummyT</span><span class="main"><span>)</span></span><span>
    </span><span class="comment1"><span>(* use schematic type variables *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>|&gt;</span><span> </span><span>Proof_Context.set_mode</span><span> </span><span>Proof_Context.mode_pattern</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>infer_types</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Type_Infer_Context.infer_types</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
     </span><span class="entity"><span>t</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>erase_types</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>infer_types</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>match_types</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get_types</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>post_fold_term_type</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>cons</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>perhaps</span><span> </span><span>o</span><span> </span><span>try</span><span> </span><span>o</span><span> </span><span>Sign.typ_match</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_types</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>get_types</span></span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span>Vartab.empty</span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>handle_trivial_tfrees</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>add_tfree_names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>snd</span><span> </span><span>#&gt;</span><span> </span><span>snd</span><span> </span><span>#&gt;</span><span> </span><span>fold_atyps</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>TFree</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>cons</span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>trivial_tfree_names</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Vartab.fold</span><span> </span><span class="entity"><span>add_tfree_names</span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span>|&gt;</span><span> </span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span>Variable.is_declared</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>distinct</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tfree_name_trivial</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Ord_List.member</span><span> </span><span>fast_string_ord</span><span> </span><span class="entity"><span>trivial_tfree_names</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>trivial_tvar_names</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Vartab.fold</span><span>
        </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tvar_name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>TFree</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tfree_name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
               </span><span class="entity"><span>tfree_name_trivial</span></span><span> </span><span class="entity"><span>tfree_name</span></span><span> </span><span>?</span><span> </span><span>cons</span><span> </span><span class="entity"><span>tvar_name</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span>
        </span><span class="entity"><span>subst</span></span><span>
        </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span>|&gt;</span><span> </span><span>sort</span><span> </span><span class="entity"><span>indexname_ord</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tvar_name_trivial</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Ord_List.member</span><span> </span><span class="entity"><span>indexname_ord</span></span><span> </span><span class="entity"><span>trivial_tvar_names</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>t'</span></span><span> </span><span>|&gt;</span><span> </span><span>map_types</span><span>
              </span><span class="main"><span>(</span></span><span>map_type_tvar</span><span>
                </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>idxn</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sort</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>tvar_name_trivial</span></span><span> </span><span class="entity"><span>idxn</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>dummyT</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>TVar</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>idxn</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sort</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>subst</span></span><span> </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span>Vartab.delete</span><span> </span><span class="entity"><span>trivial_tvar_names</span></span><span>
            </span><span>|&gt;</span><span> </span><span>Vartab.map</span><span>
               </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>map_type_tfree</span><span>
                           </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sort</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>tfree_name_trivial</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>dummyT</span><span>
                              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>TFree</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sort</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>t'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subst</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>key_of_atype</span></span><span> </span><span class="main"><span>(</span></span><span>TVar</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>z</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Ord_List.insert</span><span> </span><span class="entity"><span>indexname_ord</span></span><span> </span><span class="entity"><span>z</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>key_of_atype</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>key_of_type</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_atyps</span><span> </span><span class="entity"><span>key_of_atype</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>update_tab</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tab</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>key_of_type</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
     </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>tab</span></span><span>
   </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cost</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>size_of_typ</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>size_of_term</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
       </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Var_Set_Tab.lookup</span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
         </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Var_Set_Tab.update_new</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>key</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cost</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tab</span></span><span>
       </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>old_cost</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
         </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>cost_ord</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cost</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>old_cost</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
           </span><span>LESS</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Var_Set_Tab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>key</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cost</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tab</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>tab</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
   </span><span class="entity"><span>pos</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>typing_spot_table</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>post_fold_term_type</span></span><span> </span><span class="entity"><span>update_tab</span></span><span> </span><span class="main"><span>(</span></span><span>Var_Set_Tab.empty</span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span>#&gt;</span><span> </span><span>fst</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>reverse_greedy</span></span><span> </span><span class="entity"><span>typing_spot_tab</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>update_count</span></span><span> </span><span class="entity"><span>z</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>tvar</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Vartab.lookup</span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="entity"><span>tvar</span></span><span> </span><span>|&gt;</span><span> </span><span>the_default</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span>Vartab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tvar</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tab</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>superfluous</span></span><span> </span><span class="entity"><span>tcount</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>tvar</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>the</span><span> </span><span class="main"><span>(</span></span><span>Vartab.lookup</span><span> </span><span class="entity"><span>tcount</span></span><span> </span><span class="entity"><span>tvar</span></span><span class="main"><span>)</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>drop_superfluous</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tvars</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>spot</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>spots</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tcount</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>superfluous</span></span><span> </span><span class="entity"><span>tcount</span></span><span> </span><span class="entity"><span>tvars</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>spots</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>update_count</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="entity"><span>tvars</span></span><span> </span><span class="entity"><span>tcount</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>spot</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>spots</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tcount</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>typing_spots</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tvar_count_tab</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Var_Set_Tab.fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>kv</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>cons</span><span> </span><span class="entity"><span>kv</span></span><span class="main"><span>)</span></span><span> </span><span>#&gt;</span><span> </span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>update_count</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="entity"><span>typing_spot_tab</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span>Vartab.empty</span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;&gt;</span><span> </span><span>sort_distinct</span><span> </span><span class="main"><span>(</span></span><span>rev_order</span><span> </span><span>o</span><span> </span><span class="entity"><span>cost_ord</span></span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>fold</span><span> </span><span class="entity"><span>drop_superfluous</span></span><span> </span><span class="entity"><span>typing_spots</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tvar_count_tab</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>fst</span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>introduce_annotations</span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="entity"><span>spots</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>subst_atype</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>TVar</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>idxn</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>(</span></span><span>Envir.subst_type</span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span>Vartab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>idxn</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>S</span></span><span class="main"><span>,</span></span><span> </span><span>dummyT</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>subst</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>subst_atype</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subst</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>subst_type</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fold_map_atypes</span></span><span> </span><span class="entity"><span>subst_atype</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>collect_annot</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>subst</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cp</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ps</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ps'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>annots</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="entity"><span>cp</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>subst</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cp</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>annots</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subst</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>subst_type</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>subst</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cp</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ps'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>annots</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>collect_annot</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>x</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>annots</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>post_fold_term_type</span></span><span> </span><span class="entity"><span>collect_annot</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>subst</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>spots</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t'</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>insert_annot</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cp</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>annots</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>annots'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="entity"><span>cp</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cp</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>annots</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span>Type.constraint</span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cp</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>annots'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>insert_annot</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>t</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>post_traverse_term_type</span></span><span> </span><span class="entity"><span>insert_annot</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span>rev</span><span> </span><span class="entity"><span>annots</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>fst</span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>annotate_types_in_term</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>generalize_types</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>match_types</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="entity"><span>t</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t''</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subst'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>handle_trivial_tfrees</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="entity"><span>subst</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>typing_spots</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t''</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>typing_spot_table</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>reverse_greedy</span></span><span> </span><span>|&gt;</span><span> </span><span>sort</span><span> </span><span>int_ord</span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>introduce_annotations</span></span><span> </span><span class="entity"><span>subst'</span></span><span> </span><span class="entity"><span>typing_spots</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>t''</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
</span></pre>
</body>

</html>