<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Tools/Sledgehammer/sledgehammer_isar_preplay.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Tools/Sledgehammer/sledgehammer_isar_preplay.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      HOL/Tools/Sledgehammer/sledgehammer_isar_preplay.ML
    Author:     Steffen Juilf Smolka, TU Muenchen
    Author:     Jasmin Blanchette, TU Muenchen

Preplaying of Isar proofs.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>SLEDGEHAMMER_ISAR_PREPLAY</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>play_outcome</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Sledgehammer_Proof_Methods.play_outcome</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>proof_method</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Sledgehammer_Proof_Methods.proof_method</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>isar_step</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Sledgehammer_Isar_Proof.isar_step</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>isar_proof</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Sledgehammer_Isar_Proof.isar_proof</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>label</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Sledgehammer_Isar_Proof.label</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> trace </span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span>Config.T</span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>isar_preplay_data</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> peek_at_outcome </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>play_outcome</span></span><span> </span><span>Lazy.lazy</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>play_outcome</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> enrich_context_with_local_facts </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>isar_proof</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> preplay_isar_step_for_method </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Time.time</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>proof_method</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="entity"><span>isar_step</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>play_outcome</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> preplay_isar_step </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Time.time</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>proof_method</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="entity"><span>isar_step</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>proof_method</span></span><span> * </span><span class="entity"><span>play_outcome</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> set_preplay_outcomes_of_isar_step </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Time.time</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="entity"><span>isar_preplay_data</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>isar_step</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>proof_method</span></span><span> * </span><span class="entity"><span>play_outcome</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> forced_intermediate_preplay_outcome_of_isar_step </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>isar_preplay_data</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>label</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>play_outcome</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> preplay_outcome_of_isar_step_for_method </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>isar_preplay_data</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>label</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>proof_method</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="entity"><span>play_outcome</span></span><span> </span><span>Lazy.lazy</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> fastest_method_of_isar_step </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>isar_preplay_data</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>label</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>proof_method</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> preplay_outcome_of_isar_proof </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>isar_preplay_data</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>isar_proof</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>play_outcome</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Sledgehammer_Isar_Preplay</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>SLEDGEHAMMER_ISAR_PREPLAY</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>ATP_Proof_Reconstruct</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Sledgehammer_Util</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Sledgehammer_Proof_Methods</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Sledgehammer_Isar_Proof</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.setup_config_bool</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Sledgehammer.sledgehammer_preplay_trace|attribute"><span>sledgehammer_preplay_trace</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>false</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>peek_at_outcome</span></span><span> </span><span class="entity"><span>outcome</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Lazy.is_finished</span><span> </span><span class="entity"><span>outcome</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Lazy.force</span><span> </span><span class="entity"><span>outcome</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Play_Timed_Out</span></span><span> </span><span>Time.zeroTime</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>par_list_map_filter_with_timeout</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>par_list_map_filter_with_timeout</span></span><span> </span><span class="entity"><span>get_time</span></span><span> </span><span class="entity"><span>min_timeout</span></span><span> </span><span class="entity"><span>timeout0</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>next_timeout</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span class="entity"><span>timeout0</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>apply_f</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>timeout</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>!</span><span class="entity"><span>next_timeout</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>timeout</span></span><span> </span><span>&lt;=</span><span> </span><span class="entity"><span>min_timeout</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span>NONE</span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>y</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>timeout</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>get_time</span></span><span> </span><span class="entity"><span>y</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                </span><span>SOME</span><span> </span><span class="entity"><span>time</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>next_timeout</span></span><span> </span><span>:=</span><span> </span><span>Time.min</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>time</span></span><span class="main"><span>,</span></span><span> </span><span>!</span><span class="entity"><span>next_timeout</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
              </span><span>SOME</span><span> </span><span class="entity"><span>y</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span>chop_groups</span><span> </span><span class="main"><span>(</span></span><span>Multithreading.max_threads</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xs</span></span><span>
      </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map_filter</span><span> </span><span>I</span><span> </span><span>o</span><span> </span><span>Par_List.map</span><span> </span><span class="entity"><span>apply_f</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>flat</span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>enrich_context_with_local_facts</span></span><span> </span><span class="entity"><span>proof</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>enrich_with_fact</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Proof_Context.put_thms</span><span> </span><span>false</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>string_of_label</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>[</span></span><span>Skip_Proof.make_thm</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>enrich_with_assms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>uncurry</span><span> </span><span class="entity"><span>enrich_with_fact</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>enrich_with_proof</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>assumptions</span></span><span class="main"><span>,</span></span><span> </span><span>steps</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>isar_steps</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>enrich_with_assms</span></span><span> </span><span class="entity"><span>assumptions</span></span><span> </span><span>#&gt;</span><span> </span><span>fold</span><span> </span><span class="entity"><span>enrich_with_step</span></span><span> </span><span class="entity"><span>isar_steps</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>enrich_with_step</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Prove</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>label</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subproofs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>enrich_with_fact</span></span><span> </span><span class="entity"><span>label</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span>#&gt;</span><span> </span><span>fold</span><span> </span><span class="entity"><span>enrich_with_proof</span></span><span> </span><span class="entity"><span>subproofs</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>enrich_with_step</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>enrich_with_proof</span></span><span> </span><span class="entity"><span>proof</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>preplay_trace</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>assmsp</span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="entity"><span>outcome</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>|&gt;</span><span> </span><span>Config.put</span><span> </span><span>show_markup</span><span> </span><span>true</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>assms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>@</span><span> </span><span class="entity"><span>assmsp</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>time</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pretty.str</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"["</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>string_of_play_outcome</span></span><span> </span><span class="entity"><span>outcome</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"]"</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>assms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pretty.enum</span><span> </span><span class="inner_quoted"><span>" and "</span></span><span> </span><span class="inner_quoted"><span>"using "</span></span><span> </span><span class="inner_quoted"><span>" shows "</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Thm.pretty_thm</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>assms</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>concl</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>tracing</span><span> </span><span class="main"><span>(</span></span><span>Pretty.string_of</span><span> </span><span class="main"><span>(</span></span><span>Pretty.blk</span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>2</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.breaks</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>time</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>assms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>take_time</span></span><span> </span><span class="entity"><span>timeout</span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="entity"><span>arg</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>timing</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Timing.start</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span>Timeout.apply</span><span> </span><span class="entity"><span>timeout</span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="entity"><span>arg</span></span><span class="main"><span>;</span></span><span> </span><span class="entity"><span>Played</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>cpu</span><span> </span><span class="main"><span>(</span></span><span>Timing.result</span><span> </span><span class="entity"><span>timing</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Timeout.TIMEOUT</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Play_Timed_Out</span></span><span> </span><span class="entity"><span>timeout</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>resolve_fact_names</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>names</span></span><span>
   </span><span>|&gt;&gt;</span><span> </span><span>map</span><span> </span><span class="entity"><span>string_of_label</span></span><span>
   </span><span>|&gt;</span><span> </span><span>apply2</span><span> </span><span class="main"><span>(</span></span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thms_of_name</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>ERROR</span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"preplay error: "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>msg</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>thm_of_proof</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>fixes</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>assumptions</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>steps</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="main"><span>=</span></span><span> 
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span>List.last</span><span> </span><span class="entity"><span>steps</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Prove</span></span><span> </span><span class="main"><span>{</span></span><span>obtains</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>goal</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"preplay error: malformed subproof"</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>var_idx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>maxidx_of_term</span><span> </span><span class="entity"><span>concl</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>var_of_free</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>var_idx</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>`</span><span class="entity"><span>var_of_free</span></span><span> </span><span>#&gt;</span><span> </span><span>swap</span><span> </span><span>#&gt;</span><span> </span><span>apfst</span><span> </span><span>Free</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fixes</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>Logic.list_implies</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>assumptions</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span>snd</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>subst_free</span><span> </span><span class="entity"><span>subst</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Skip_Proof.make_thm</span><span> </span><span class="entity"><span>thy</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(* may throw exceptions *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>raw_preplay_step_for_method</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>chained</span></span><span> </span><span class="entity"><span>timeout</span></span><span> </span><span class="entity"><span>meth</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>Prove</span></span><span> </span><span class="main"><span>{</span></span><span>obtains</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subproofs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>facts</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>goal</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="comment1"><span>(* proof obligation: !!thesis. (!!x1...xn. t ==&gt; thesis) ==&gt; thesis
           (cf. "~~/src/Pure/Isar/obtain.ML") *)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>frees</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>Free</span><span> </span><span class="entity"><span>xs</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thesis</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Variable.variant_frees</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>frees</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"thesis"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>HOLogic.boolT</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thesis_prop</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.mk_Trueprop</span></span><span> </span><span class="entity"><span>thesis</span></span><span>

          </span><span class="comment1"><span>(* !!x1...xn. t ==&gt; thesis *)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inner_prop</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span>Logic.all</span><span> </span><span class="entity"><span>frees</span></span><span> </span><span class="main"><span>(</span></span><span>Logic.mk_implies</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>goal</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thesis_prop</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="comment1"><span>(* !!thesis. (!!x1...xn. t ==&gt; thesis) ==&gt; thesis *)</span></span><span>
          </span><span>Logic.all</span><span> </span><span class="entity"><span>thesis</span></span><span> </span><span class="main"><span>(</span></span><span>Logic.mk_implies</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inner_prop</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thesis_prop</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>assmsp</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>resolve_fact_names</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>facts</span></span><span>
      </span><span>|&gt;&gt;</span><span> </span><span>append</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm_of_proof</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>subproofs</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;&gt;</span><span> </span><span>append</span><span> </span><span class="entity"><span>chained</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prove</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Goal.prove</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>context</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span>HEADGOAL</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tac_of_proof_method</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>assmsp</span></span><span> </span><span class="entity"><span>meth</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>ERROR</span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Preplay error: "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>msg</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>play_outcome</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>take_time</span></span><span> </span><span class="entity"><span>timeout</span></span><span> </span><span class="entity"><span>prove</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>preplay_trace</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>assmsp</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="entity"><span>play_outcome</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="entity"><span>play_outcome</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>preplay_isar_step_for_method</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>chained</span></span><span> </span><span class="entity"><span>timeout</span></span><span> </span><span class="entity"><span>meth</span></span><span> </span><span class="entity"><span>step</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>timeout</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Time.zeroTime</span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="entity"><span>Play_Timed_Out</span></span><span> </span><span>Time.zeroTime</span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>raw_preplay_step_for_method</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>chained</span></span><span> </span><span class="entity"><span>timeout</span></span><span> </span><span class="entity"><span>meth</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>step</span></span><span>
    </span><span>|&gt;</span><span> </span><span>the_default</span><span> </span><span class="entity"><span>Play_Failed</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>min_preplay_timeout</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>seconds</span><span> </span><span class="inner_numeral"><span>0.002</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>preplay_isar_step</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>chained</span></span><span> </span><span class="entity"><span>timeout0</span></span><span> </span><span class="entity"><span>hopeless</span></span><span> </span><span class="entity"><span>step</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>preplay</span></span><span> </span><span class="entity"><span>timeout</span></span><span> </span><span class="entity"><span>meth</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>meth</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>preplay_isar_step_for_method</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>chained</span></span><span> </span><span class="entity"><span>timeout</span></span><span> </span><span class="entity"><span>meth</span></span><span> </span><span class="entity"><span>step</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_time</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Played</span></span><span> </span><span class="entity"><span>time</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>time</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>get_time</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>meths</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>proof_methods_of_isar_step</span></span><span> </span><span class="entity"><span>step</span></span><span> </span><span>|&gt;</span><span> </span><span>subtract</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>hopeless</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>par_list_map_filter_with_timeout</span></span><span> </span><span class="entity"><span>get_time</span></span><span> </span><span class="entity"><span>min_preplay_timeout</span></span><span> </span><span class="entity"><span>timeout0</span></span><span> </span><span class="entity"><span>preplay</span></span><span> </span><span class="entity"><span>meths</span></span><span>
    </span><span>|&gt;</span><span> </span><span>sort</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>play_outcome_ord</span></span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>isar_preplay_data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>proof_method</span></span><span> * </span><span class="entity"><span>play_outcome</span></span><span> </span><span>Lazy.lazy</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span>Canonical_Label_Tab.table</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>time_of_play</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Played</span></span><span> </span><span class="entity"><span>time</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>time</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>time_of_play</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Play_Timed_Out</span></span><span> </span><span class="entity"><span>time</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>time</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_preplay_outcomes</span></span><span> </span><span class="entity"><span>Play_Failed</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Play_Failed</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_preplay_outcomes</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>Play_Failed</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Play_Failed</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_preplay_outcomes</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Played</span></span><span> </span><span class="entity"><span>time1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Played</span></span><span> </span><span class="entity"><span>time2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Played</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>time1</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>time2</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_preplay_outcomes</span></span><span> </span><span class="entity"><span>play1</span></span><span> </span><span class="entity"><span>play2</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>Play_Timed_Out</span></span><span> </span><span class="main"><span>(</span></span><span>Time.+</span><span> </span><span class="main"><span>(</span></span><span>apply2</span><span> </span><span class="entity"><span>time_of_play</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>play1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>play2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>set_preplay_outcomes_of_isar_step</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>timeout</span></span><span> </span><span class="entity"><span>preplay_data</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>step</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Prove</span></span><span> </span><span class="main"><span>{</span></span><span>label</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>proof_methods</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>meths_outcomes0</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lazy_preplay</span></span><span> </span><span class="entity"><span>meth</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>Lazy.lazy</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>preplay_isar_step_for_method</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>timeout</span></span><span> </span><span class="entity"><span>meth</span></span><span> </span><span class="entity"><span>step</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>meths_outcomes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>meths_outcomes0</span></span><span>
        </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span>Lazy.value</span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>meth</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>AList.default</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>meth</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lazy_preplay</span></span><span> </span><span class="entity"><span>meth</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>proof_methods</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>preplay_data</span></span><span> </span><span>:=</span><span> </span><span>Canonical_Label_Tab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>AList.update</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>meths_outcomes</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>preplay_data</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>set_preplay_outcomes_of_isar_step</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_best_method_outcome</span></span><span> </span><span class="entity"><span>force</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>tap</span><span> </span><span class="main"><span>(</span></span><span>List.app</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>Lazy.future</span><span> </span><span>Future.default_params</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="comment1"><span>(* could be parallelized *)</span></span><span>
  </span><span>#&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="entity"><span>force</span></span><span class="main"><span>)</span></span><span>
  </span><span>#&gt;</span><span> </span><span>sort</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>play_outcome_ord</span></span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span>
  </span><span>#&gt;</span><span> </span><span>hd</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>forced_intermediate_preplay_outcome_of_isar_step</span></span><span> </span><span class="entity"><span>preplay_data</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>meths_outcomes</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>outcome1</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the</span><span> </span><span class="main"><span>(</span></span><span>Canonical_Label_Tab.lookup</span><span> </span><span class="entity"><span>preplay_data</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span>not</span><span> </span><span>o</span><span> </span><span>Lazy.is_finished</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>meths_outcomes</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Lazy.force</span><span> </span><span class="entity"><span>outcome1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="entity"><span>outcome</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Played</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>outcome</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>snd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_best_method_outcome</span></span><span> </span><span>Lazy.force</span><span> </span><span class="entity"><span>meths_outcomes</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>outcome</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>snd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_best_method_outcome</span></span><span> </span><span class="entity"><span>peek_at_outcome</span></span><span> </span><span class="entity"><span>meths_outcomes</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>outcome</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Play_Timed_Out</span></span><span> </span><span>Time.zeroTime</span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span>snd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_best_method_outcome</span></span><span> </span><span>Lazy.force</span><span> </span><span class="entity"><span>meths_outcomes</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="entity"><span>outcome</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>preplay_outcome_of_isar_step_for_method</span></span><span> </span><span class="entity"><span>preplay_data</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="main"><span>(</span></span><span>Canonical_Label_Tab.lookup</span><span> </span><span class="entity"><span>preplay_data</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span>#&gt;</span><span> </span><span>the_default</span><span> </span><span class="main"><span>(</span></span><span>Lazy.value</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Play_Timed_Out</span></span><span> </span><span>Time.zeroTime</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fastest_method_of_isar_step</span></span><span> </span><span class="entity"><span>preplay_data</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>the</span><span> </span><span>o</span><span> </span><span>Canonical_Label_Tab.lookup</span><span> </span><span class="entity"><span>preplay_data</span></span><span>
  </span><span>#&gt;</span><span> </span><span class="entity"><span>get_best_method_outcome</span></span><span> </span><span>Lazy.force</span><span>
  </span><span>#&gt;</span><span> </span><span>fst</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>forced_outcome_of_step</span></span><span> </span><span class="entity"><span>preplay_data</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Prove</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>label</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>proof_methods</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>Lazy.force</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>preplay_outcome_of_isar_step_for_method</span></span><span> </span><span class="entity"><span>preplay_data</span></span><span> </span><span class="entity"><span>label</span></span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>proof_methods</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>forced_outcome_of_step</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Played</span></span><span> </span><span>Time.zeroTime</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>preplay_outcome_of_isar_proof</span></span><span> </span><span class="entity"><span>preplay_data</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>steps</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>fold_isar_steps</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_preplay_outcomes</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>forced_outcome_of_step</span></span><span> </span><span class="entity"><span>preplay_data</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>steps</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>Played</span></span><span> </span><span>Time.zeroTime</span><span class="main"><span>)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
</span></pre>
</body>

</html>