<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Tools/Sledgehammer/sledgehammer_isar_compress.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Tools/Sledgehammer/sledgehammer_isar_compress.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      HOL/Tools/Sledgehammer/sledgehammer_isar_compress.ML
    Author:     Steffen Juilf Smolka, TU Muenchen
    Author:     Jasmin Blanchette, TU Muenchen

Compression of Isar proofs by merging steps.
Only proof steps using the same proof method are merged.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>SLEDGEHAMMER_ISAR_COMPRESS</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>isar_proof</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Sledgehammer_Isar_Proof.isar_proof</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>isar_preplay_data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Sledgehammer_Isar_Preplay.isar_preplay_data</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> compress_isar_proof </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>real</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Time.time</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="entity"><span>isar_preplay_data</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>isar_proof</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>isar_proof</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Sledgehammer_Isar_Compress</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>SLEDGEHAMMER_ISAR_COMPRESS</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Sledgehammer_Util</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Sledgehammer_Proof_Methods</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Sledgehammer_Isar_Proof</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Sledgehammer_Isar_Preplay</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>collect_successors</span></span><span> </span><span class="entity"><span>steps</span></span><span> </span><span class="entity"><span>lbls</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>collect_steps</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>accum</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>accum</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>collect_steps</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>accum</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>accum</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>collect_steps</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>step</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>steps</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>accum</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>collect_steps</span></span><span> </span><span class="entity"><span>steps</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>collect_step</span></span><span> </span><span class="entity"><span>step</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>collect_step</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>step</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Prove</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>label</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subproofs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>collect_subproofs</span></span><span> </span><span class="entity"><span>subproofs</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span class="entity"><span>accum</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>accum</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>accum</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l'</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>lbls'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>accu</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>label</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>l'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lbls'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>step</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>accu</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>collect_step</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>accum</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>accum</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>collect_subproofs</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>accum</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>accum</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>collect_subproofs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>proof</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>subproofs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>accum</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>collect_steps</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>steps_of_isar_proof</span></span><span> </span><span class="entity"><span>proof</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>accum</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span class="entity"><span>accum</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>accum</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>accum</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>collect_subproofs</span></span><span> </span><span class="entity"><span>subproofs</span></span><span> </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>rev</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>collect_steps</span></span><span> </span><span class="entity"><span>steps</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lbls</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>update_steps</span></span><span> </span><span class="entity"><span>updates</span></span><span> </span><span class="entity"><span>steps</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>update_steps</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>updates</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>updates</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>update_steps</span></span><span> </span><span class="entity"><span>steps</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>steps</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>update_steps</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>step</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>steps</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>updates</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>update_step</span></span><span> </span><span class="entity"><span>step</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>update_steps</span></span><span> </span><span class="entity"><span>steps</span></span><span> </span><span class="entity"><span>updates</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>update_step</span></span><span> </span><span class="entity"><span>step</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>steps</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>step</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>steps</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>update_step</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Prove</span></span><span> </span><span class="main"><span>{</span></span><span>qualifiers</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>qs</span></span><span class="main"><span>,</span></span><span> </span><span>obtains</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>,</span></span><span> </span><span>label</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span>goal</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subproofs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>facts</span></span><span class="main"><span>,</span></span><span>
          </span><span>proof_methods</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>meths</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>comment</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>steps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>updates</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Prove</span></span><span> </span><span class="main"><span>{</span></span><span>qualifiers</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>qs'</span></span><span class="main"><span>,</span></span><span>
          </span><span>obtains</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>xs'</span></span><span class="main"><span>,</span></span><span> </span><span>label</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>l'</span></span><span class="main"><span>,</span></span><span> </span><span>goal</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>,</span></span><span> </span><span>subproofs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>subproofs'</span></span><span class="main"><span>,</span></span><span> </span><span>facts</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>facts'</span></span><span class="main"><span>,</span></span><span>
          </span><span>proof_methods</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>meths'</span></span><span class="main"><span>,</span></span><span> </span><span>comment</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>comment'</span></span><span class="main"><span>}</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>updates'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>l'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
           </span><span class="entity"><span>update_subproofs</span></span><span> </span><span class="entity"><span>subproofs'</span></span><span> </span><span class="entity"><span>updates'</span></span><span>
           </span><span>|&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>subproofs''</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Prove</span></span><span> </span><span class="main"><span>{</span></span><span>
                  </span><span>qualifiers</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>qs'</span></span><span class="main"><span>,</span></span><span>
                  </span><span>obtains</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>xs'</span></span><span class="main"><span>,</span></span><span>
                  </span><span>label</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>l'</span></span><span class="main"><span>,</span></span><span>
                  </span><span>goal</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>,</span></span><span>
                  </span><span>subproofs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>subproofs''</span></span><span class="main"><span>,</span></span><span>
                  </span><span>facts</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>facts'</span></span><span class="main"><span>,</span></span><span>
                  </span><span>proof_methods</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>meths'</span></span><span class="main"><span>,</span></span><span>
                  </span><span>comment</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>comment'</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
           </span><span class="entity"><span>update_subproofs</span></span><span> </span><span class="entity"><span>subproofs</span></span><span> </span><span class="entity"><span>updates</span></span><span>
           </span><span>|&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>subproofs'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Prove</span></span><span> </span><span class="main"><span>{</span></span><span>
                  </span><span>qualifiers</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>qs</span></span><span class="main"><span>,</span></span><span>
                  </span><span>obtains</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>,</span></span><span>
                  </span><span>label</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span>
                  </span><span>goal</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span>
                  </span><span>subproofs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>subproofs'</span></span><span class="main"><span>,</span></span><span>
                  </span><span>facts</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>facts</span></span><span class="main"><span>,</span></span><span>
                  </span><span>proof_methods</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>meths</span></span><span class="main"><span>,</span></span><span>
                  </span><span>comment</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>comment</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>step</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>step</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>steps</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>update_step</span></span><span> </span><span class="entity"><span>step</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>steps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>updates</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>step</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>steps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>updates</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>update_subproofs</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>updates</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>updates</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>update_subproofs</span></span><span> </span><span class="entity"><span>steps</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>steps</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>update_subproofs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>proof</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>subproofs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>updates</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>update_proof</span></span><span> </span><span class="entity"><span>proof</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>update_subproofs</span></span><span> </span><span class="entity"><span>subproofs</span></span><span> </span><span class="entity"><span>updates</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>update_proof</span></span><span> </span><span class="entity"><span>proof</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>proofs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>proof</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>proofs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>update_proof</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>proof</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Proof</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>steps</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>proofs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>updates</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>steps'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>updates'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>update_steps</span></span><span> </span><span class="entity"><span>steps</span></span><span> </span><span class="entity"><span>updates</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>isar_proof_with_steps</span></span><span> </span><span class="entity"><span>proof</span></span><span> </span><span class="entity"><span>steps'</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>proofs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>updates'</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>fst</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>update_steps</span></span><span> </span><span class="entity"><span>steps</span></span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="entity"><span>updates</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>merge_methods</span></span><span> </span><span class="entity"><span>preplay_data</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>meths1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>meths2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_hopeful</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="entity"><span>meth</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>outcome</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>preplay_outcome_of_isar_step_for_method</span></span><span> </span><span class="entity"><span>preplay_data</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="entity"><span>meth</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>Lazy.is_finished</span><span> </span><span class="entity"><span>outcome</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Lazy.force</span><span> </span><span class="entity"><span>outcome</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>Played</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Play_Timed_Out</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>hopeful</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>hopeless</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>meths2</span></span><span> </span><span>@</span><span> </span><span>subtract</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>meths2</span></span><span> </span><span class="entity"><span>meths1</span></span><span>
      </span><span>|&gt;</span><span> </span><span>List.partition</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_hopeful</span></span><span> </span><span class="entity"><span>l1</span></span><span> </span><span>andf</span><span> </span><span class="entity"><span>is_hopeful</span></span><span> </span><span class="entity"><span>l2</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>hopeful</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>hopeless</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>hopeless</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>merge_steps</span></span><span> </span><span class="entity"><span>preplay_data</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>Prove</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span>qualifiers</span><span> </span><span class="main"><span>=</span></span><span>  </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span>label</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>l1</span></span><span class="main"><span>,</span></span><span> </span><span>goal</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>facts</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lfs1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gfs1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>Prove</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span>qualifiers</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>qs2</span></span><span class="main"><span>,</span></span><span> </span><span>label</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>l2</span></span><span class="main"><span>,</span></span><span> </span><span>goal</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span>facts</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lfs2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gfs2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>meths</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>hopeless</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>merge_methods</span></span><span> </span><span class="entity"><span>preplay_data</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span>proof_methods</span><span> </span><span class="entity"><span>p1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l2</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span>proof_methods</span><span> </span><span class="entity"><span>p2</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lfs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>union</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lfs1</span></span><span> </span><span class="main"><span>(</span></span><span>remove</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>l1</span></span><span> </span><span class="entity"><span>lfs2</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>gfs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>union</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>gfs1</span></span><span> </span><span class="entity"><span>gfs2</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prove</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Prove</span></span><span> </span><span class="main"><span>{</span></span><span>
      </span><span>qualifiers</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>qs2</span></span><span class="main"><span>,</span></span><span>
      </span><span>obtains</span><span> </span><span class="main"><span>=</span></span><span> </span><span>inter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Term.add_frees</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>obtains</span><span> </span><span class="entity"><span>p1</span></span><span> </span><span>@</span><span> </span><span class="main"><span>#</span></span><span>obtains</span><span> </span><span class="entity"><span>p2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
      </span><span>label</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>l2</span></span><span class="main"><span>,</span></span><span>
      </span><span>goal</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span>
      </span><span>subproofs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>subproofs</span><span> </span><span class="entity"><span>p1</span></span><span> </span><span>@</span><span> </span><span class="main"><span>#</span></span><span>subproofs</span><span> </span><span class="entity"><span>p2</span></span><span class="main"><span>,</span></span><span>
      </span><span>facts</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>sort_facts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lfs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gfs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
      </span><span>proof_methods</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>meths</span></span><span class="main"><span>,</span></span><span>
      </span><span>comment</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>comment</span><span> </span><span class="entity"><span>p1</span></span><span> </span><span>^</span><span> </span><span class="main"><span>#</span></span><span>comment</span><span> </span><span class="entity"><span>p2</span></span><span class="main"><span>}</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>prove</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>hopeless</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>merge_slack_time</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>seconds</span><span> </span><span class="inner_numeral"><span>0.01</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>merge_slack_factor</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1.5</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>adjust_merge_timeout</span></span><span> </span><span class="entity"><span>max</span></span><span> </span><span class="entity"><span>time</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>timeout</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Time.scale</span><span> </span><span class="entity"><span>merge_slack_factor</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>merge_slack_time</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>time</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>max</span></span><span> </span><span>&lt;</span><span> </span><span class="entity"><span>timeout</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>max</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>timeout</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>compress_degree</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span>

</span><span class="comment1"><span>(* Precondition: The proof must be labeled canonically. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>compress_isar_proof</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>compress</span></span><span> </span><span class="entity"><span>preplay_timeout</span></span><span> </span><span class="entity"><span>preplay_data</span></span><span> </span><span class="entity"><span>proof</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>compress</span></span><span> </span><span>&lt;=</span><span> </span><span class="inner_numeral"><span>1.0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="entity"><span>proof</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>compress_further</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>decrement_step_count</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>number_of_steps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_isar_steps</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>steps_of_isar_proof</span></span><span> </span><span class="entity"><span>proof</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>target_number_of_steps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Real.ceil</span><span> </span><span class="main"><span>(</span></span><span>Real.fromInt</span><span> </span><span class="entity"><span>number_of_steps</span></span><span> </span><span>/</span><span> </span><span class="entity"><span>compress</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>delta</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>number_of_steps</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>target_number_of_steps</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>!</span><span class="entity"><span>delta</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>delta</span></span><span> </span><span>:=</span><span> </span><span>!</span><span class="entity"><span>delta</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_successors</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>replace_successor</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_refs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Prove</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>label</span></span><span class="main"><span>,</span></span><span> </span><span>facts</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lfs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Canonical_Label_Tab.cons_list</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>key</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>label</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lfs</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_refs</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>

          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span>Canonical_Label_Tab.empty</span><span>
            </span><span>|&gt;</span><span> </span><span class="entity"><span>fold_isar_steps</span></span><span> </span><span class="entity"><span>add_refs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>steps_of_isar_proof</span></span><span> </span><span class="entity"><span>proof</span></span><span class="main"><span>)</span></span><span>
            </span><span class="comment1"><span>(* "rev" should have the same effect as "sort canonical_label_ord" *)</span></span><span>
            </span><span>|&gt;</span><span> </span><span>Canonical_Label_Tab.map</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>rev</span><span class="main"><span>)</span></span><span>
            </span><span>|&gt;</span><span> </span><span>Unsynchronized.ref</span><span>

          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_successors</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Canonical_Label_Tab.lookup_list</span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>tab</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>l</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>set_successors</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="entity"><span>refs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span>:=</span><span> </span><span>Canonical_Label_Tab.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>refs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>tab</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>replace_successor</span></span><span> </span><span class="entity"><span>old</span></span><span> </span><span class="entity"><span>new</span></span><span> </span><span class="entity"><span>dest</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="entity"><span>get_successors</span></span><span> </span><span class="entity"><span>dest</span></span><span>
            </span><span>|&gt;</span><span> </span><span>Ord_List.remove</span><span> </span><span class="entity"><span>canonical_label_ord</span></span><span> </span><span class="entity"><span>old</span></span><span>
            </span><span>|&gt;</span><span> </span><span>Ord_List.union</span><span> </span><span class="entity"><span>canonical_label_ord</span></span><span> </span><span class="entity"><span>new</span></span><span>
            </span><span>|&gt;</span><span> </span><span class="entity"><span>set_successors</span></span><span> </span><span class="entity"><span>dest</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>get_successors</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>replace_successor</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>reference_time</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>forced_intermediate_preplay_outcome_of_isar_step</span></span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>preplay_data</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span class="entity"><span>Played</span></span><span> </span><span class="entity"><span>time</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>time</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>preplay_timeout</span></span><span class="main"><span>)</span></span><span>

      </span><span class="comment1"><span>(* elimination of trivial, one-step subproofs *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>elim_one_subproof</span></span><span> </span><span class="entity"><span>time</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>step</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Prove</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>qualifiers</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>obtains</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>label</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>,</span></span><span>
          </span><span>facts</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lfs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gfs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>proof_methods</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>comment</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>subs</span></span><span>
          </span><span class="entity"><span>nontriv_subs</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>subs</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>compress_further</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="entity"><span>Prove</span></span><span> </span><span class="main"><span>{</span></span><span>
            </span><span>qualifiers</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>qualifiers</span></span><span class="main"><span>,</span></span><span>
            </span><span>obtains</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>obtains</span></span><span class="main"><span>,</span></span><span>
            </span><span>label</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>label</span></span><span class="main"><span>,</span></span><span>
            </span><span>goal</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>,</span></span><span>
            </span><span>subproofs</span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.revAppend</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nontriv_subs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
            </span><span>facts</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lfs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gfs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
            </span><span>proof_methods</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>proof_methods</span></span><span class="main"><span>,</span></span><span>
            </span><span>comment</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>comment</span></span><span class="main"><span>}</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>subs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>sub</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Proof</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>assumptions</span></span><span class="main"><span>,</span></span><span>
              </span><span>steps</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Prove</span></span><span> </span><span class="main"><span>{</span></span><span>label</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>label'</span></span><span class="main"><span>,</span></span><span> </span><span>subproofs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span>facts</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lfs'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gfs'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
              </span><span>proof_methods</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>proof_methods'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>subs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="comment1"><span>(* merge steps *)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>subs''</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>subs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>nontriv_subs</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lfs''</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>union</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lfs</span></span><span> </span><span class="main"><span>(</span></span><span>subtract</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>assumptions</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lfs'</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>gfs''</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>union</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>gfs'</span></span><span> </span><span class="entity"><span>gfs</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>proof_methods''</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>hopeless</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="entity"><span>merge_methods</span></span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>preplay_data</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>label'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>proof_methods'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>label</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>proof_methods</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>step''</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Prove</span></span><span> </span><span class="main"><span>{</span></span><span>
                </span><span>qualifiers</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>qualifiers</span></span><span class="main"><span>,</span></span><span>
                </span><span>obtains</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>obtains</span></span><span class="main"><span>,</span></span><span>
                </span><span>label</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>label</span></span><span class="main"><span>,</span></span><span>
                </span><span>goal</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>,</span></span><span>
                </span><span>subproofs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>subs''</span></span><span class="main"><span>,</span></span><span>
                </span><span>facts</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lfs''</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gfs''</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                </span><span>proof_methods</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>proof_methods''</span></span><span class="main"><span>,</span></span><span>
                </span><span>comment</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>comment</span></span><span class="main"><span>}</span></span><span>

              </span><span class="comment1"><span>(* check if the modified step can be preplayed fast enough *)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>timeout</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>adjust_merge_timeout</span></span><span> </span><span class="entity"><span>preplay_timeout</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>time</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>reference_time</span></span><span> </span><span class="entity"><span>label'</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>preplay_isar_step</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>timeout</span></span><span> </span><span class="entity"><span>hopeless</span></span><span> </span><span class="entity"><span>step''</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                </span><span class="entity"><span>meths_outcomes</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Played</span></span><span> </span><span class="entity"><span>time''</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span class="comment1"><span>(* "l'" successfully eliminated *)</span></span><span>
                </span><span class="main"><span>(</span></span><span class="entity"><span>decrement_step_count</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
                 </span><span class="entity"><span>set_preplay_outcomes_of_isar_step</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>time''</span></span><span> </span><span class="entity"><span>preplay_data</span></span><span> </span><span class="entity"><span>step''</span></span><span> </span><span class="entity"><span>meths_outcomes</span></span><span class="main"><span>;</span></span><span>
                 </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>replace_successor</span></span><span> </span><span class="entity"><span>label'</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>label</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lfs'</span></span><span class="main"><span>;</span></span><span>
                 </span><span class="entity"><span>elim_one_subproof</span></span><span> </span><span class="entity"><span>time''</span></span><span> </span><span class="entity"><span>step''</span></span><span> </span><span class="entity"><span>subs</span></span><span> </span><span class="entity"><span>nontriv_subs</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>elim_one_subproof</span></span><span> </span><span class="entity"><span>time</span></span><span> </span><span class="entity"><span>step</span></span><span> </span><span class="entity"><span>subs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sub</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>nontriv_subs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>sub</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>subs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>elim_one_subproof</span></span><span> </span><span class="entity"><span>time</span></span><span> </span><span class="entity"><span>step</span></span><span> </span><span class="entity"><span>subs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sub</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>nontriv_subs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>elim_subproofs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>step</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Prove</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>label</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subproofs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span>o</span><span> </span><span>tl</span><span> </span><span>o</span><span> </span><span class="entity"><span>steps_of_isar_proof</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>subproofs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="entity"><span>elim_one_subproof</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>reference_time</span></span><span> </span><span class="entity"><span>label</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>step</span></span><span> </span><span class="entity"><span>subproofs</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span class="entity"><span>step</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>elim_subproofs</span></span><span> </span><span class="entity"><span>step</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>step</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>compress_top_level</span></span><span> </span><span class="entity"><span>steps</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cand_key</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span>o</span><span> </span><span class="entity"><span>get_successors</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cand_ord</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span>prod_ord</span><span> </span><span>int_ord</span><span> </span><span class="main"><span>(</span></span><span>prod_ord</span><span> </span><span class="main"><span>(</span></span><span>int_ord</span><span> </span><span>o</span><span> </span><span>swap</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>int_ord</span><span> </span><span>o</span><span> </span><span>swap</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span class="entity"><span>cand_key</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pop_next_candidate</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>pop_next_candidate</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cands</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cand</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>cands'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>y</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>is_less</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cand_ord</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cands'</span></span><span> </span><span class="entity"><span>cand</span></span><span>
              </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>best</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>best</span></span><span class="main"><span>,</span></span><span> </span><span>remove</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>best</span></span><span> </span><span class="entity"><span>cands</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>try_eliminate</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="entity"><span>labels</span></span><span> </span><span class="entity"><span>steps</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>steps_before</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cand</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Prove</span></span><span> </span><span class="main"><span>{</span></span><span>facts</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lfs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>steps_after</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span>chop</span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>steps</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>succs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>collect_successors</span></span><span> </span><span class="entity"><span>steps_after</span></span><span> </span><span class="entity"><span>labels</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>succs'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>hopelesses</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>split_list</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>merge_steps</span></span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>preplay_data</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cand</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>succs</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>Played</span></span><span> </span><span class="entity"><span>time</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>time</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span>
                  </span><span class="entity"><span>forced_intermediate_preplay_outcome_of_isar_step</span></span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>preplay_data</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>labels</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>steps</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>times0</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>labels</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>total_time</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Library.foldl</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>+</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>reference_time</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>times0</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>timeout</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>adjust_merge_timeout</span></span><span> </span><span class="entity"><span>preplay_timeout</span></span><span>
                    </span><span class="main"><span>(</span></span><span>Time.fromReal</span><span> </span><span class="main"><span>(</span></span><span>Time.toReal</span><span> </span><span class="entity"><span>total_time</span></span><span> </span><span>/</span><span> </span><span>Real.fromInt</span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>meths_outcomess</span></span><span> </span><span class="main"><span>=</span></span><span>
                    </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 2</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>preplay_isar_step</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>timeout</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>hopelesses</span></span><span> </span><span class="entity"><span>succs'</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Played</span></span><span> </span><span class="entity"><span>time</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>time</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>meths_outcomess</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                    </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>steps</span></span><span>
                  </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>times</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                    </span><span class="comment1"><span>(* "l" successfully eliminated *)</span></span><span>
                    </span><span class="main"><span>(</span></span><span class="entity"><span>decrement_step_count</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
                     </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 3</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>time</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>set_preplay_outcomes_of_isar_step</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>time</span></span><span> </span><span class="entity"><span>preplay_data</span></span><span class="main"><span>)</span></span><span>
                       </span><span class="entity"><span>times</span></span><span> </span><span class="entity"><span>succs'</span></span><span> </span><span class="entity"><span>meths_outcomess</span></span><span class="main"><span>;</span></span><span>
                     </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>replace_successor</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="entity"><span>labels</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lfs</span></span><span class="main"><span>;</span></span><span>
                     </span><span class="entity"><span>steps_before</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>update_steps</span></span><span> </span><span class="entity"><span>succs'</span></span><span> </span><span class="entity"><span>steps_after</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>compression_loop</span></span><span> </span><span class="entity"><span>candidates</span></span><span> </span><span class="entity"><span>steps</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>compress_further</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
              </span><span class="entity"><span>steps</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
              </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>pop_next_candidate</span></span><span> </span><span class="entity"><span>candidates</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>steps</span></span><span> </span><span class="comment1"><span>(* no more candidates for elimination *)</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>num_xs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>candidates'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>find_index</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>label_of_isar_step</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>steps</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                  </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>steps</span></span><span>
                </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>successors</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_successors</span></span><span> </span><span class="entity"><span>l</span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>num_successors</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>successors</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                    </span><span class="comment1"><span>(* Careful with "obtain", so we don't "obtain" twice the same variable after a
                       merge. *)</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>num_successors</span></span><span> </span><span>&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>num_xs</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>compress_degree</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                      </span><span class="entity"><span>steps</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                      </span><span class="entity"><span>steps</span></span><span>
                      </span><span>|&gt;</span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span class="entity"><span>successors</span></span><span class="main"><span>)</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>try_eliminate</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="entity"><span>successors</span></span><span>
                      </span><span>|&gt;</span><span> </span><span class="entity"><span>compression_loop</span></span><span> </span><span class="entity"><span>candidates'</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_cand</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Prove</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>obtains</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>label</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span>cons</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>label</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>obtains</span></span><span class="main"><span>,</span></span><span> </span><span>size_of_term</span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_cand</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>

          </span><span class="comment1"><span>(* the very last step is not a candidate *)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>candidates</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>add_cand</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="main"><span>(</span></span><span>split_last</span><span> </span><span class="entity"><span>steps</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="entity"><span>compression_loop</span></span><span> </span><span class="entity"><span>candidates</span></span><span> </span><span class="entity"><span>steps</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

      </span><span class="comment1"><span>(* Proofs are compressed bottom-up, beginning with the innermost subproofs. On the innermost
         proof level, the proof steps have no subproofs. In the best case, these steps can be merged
         into just one step, resulting in a trivial subproof. Going one level up, trivial subproofs
         can be eliminated. In the best case, this once again leads to a proof whose proof steps do
         not have subproofs. Applying this approach recursively will result in a flat proof in the
         best cast. *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>compress_proof</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>proof</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>steps</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>compress_further</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="entity"><span>isar_proof_with_steps</span></span><span> </span><span class="entity"><span>proof</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>compress_steps</span></span><span> </span><span class="entity"><span>steps</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="entity"><span>proof</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>compress_steps</span></span><span> </span><span class="entity"><span>steps</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="comment1"><span>(* bottom-up: compress innermost proofs first *)</span></span><span>
        </span><span class="entity"><span>steps</span></span><span>
        </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>step</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>step</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>compress_further</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>compress_sub_levels</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="entity"><span>compress_further</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>compress_top_level</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>compress_sub_levels</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Prove</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>qualifiers</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>obtains</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>label</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subproofs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>facts</span></span><span class="main"><span>,</span></span><span>
            </span><span class="entity"><span>proof_methods</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>comment</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="comment1"><span>(* compress subproofs *)</span></span><span>
          </span><span class="entity"><span>Prove</span></span><span> </span><span class="main"><span>{</span></span><span>
            </span><span>qualifiers</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>qualifiers</span></span><span class="main"><span>,</span></span><span>
            </span><span>obtains</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>obtains</span></span><span class="main"><span>,</span></span><span>
            </span><span>label</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>label</span></span><span class="main"><span>,</span></span><span>
            </span><span>goal</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>,</span></span><span>
            </span><span>subproofs</span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>compress_proof</span></span><span> </span><span class="entity"><span>subproofs</span></span><span class="main"><span>,</span></span><span>
            </span><span>facts</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>facts</span></span><span class="main"><span>,</span></span><span>
            </span><span>proof_methods</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>proof_methods</span></span><span class="main"><span>,</span></span><span>
            </span><span>comment</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>comment</span></span><span class="main"><span>}</span></span><span>
          </span><span class="comment1"><span>(* eliminate trivial subproofs *)</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>compress_further</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>elim_subproofs</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>compress_sub_levels</span></span><span> </span><span class="entity"><span>step</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>step</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>compress_proof</span></span><span> </span><span class="entity"><span>proof</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
</span></pre>
</body>

</html>