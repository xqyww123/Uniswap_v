<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Tools/Nitpick/nitpick_kodkod.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Tools/Nitpick/nitpick_kodkod.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      HOL/Tools/Nitpick/nitpick_kodkod.ML
    Author:     Jasmin Blanchette, TU Muenchen
    Copyright   2008, 2009, 2010

Kodkod problem generator part of Kodkod.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>NITPICK_KODKOD</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>hol_context</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Nitpick_HOL.hol_context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>data_type_spec</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Nitpick_Scope.data_type_spec</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>kodkod_constrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Nitpick_Peephole.kodkod_constrs</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>nut</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Nitpick_Nut.nut</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> NameTable </span><span class="main"><span>:</span></span><span> </span><span>TABLE</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> univ_card </span><span class="main"><span>:</span></span><span>
    </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Kodkod.bound</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Kodkod.formula</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> check_bits </span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Kodkod.formula</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> check_arity </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> kk_tuple </span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Kodkod.tuple</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> tuple_set_from_atom_schema </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>int</span><span> * </span><span>int</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Kodkod.tuple_set</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> sequential_int_bounds </span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Kodkod.int_bound</span></span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> pow_of_two_int_bounds </span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Kodkod.int_bound</span></span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> bounds_and_axioms_for_built_in_rels_in_formulas </span><span class="main"><span>:</span></span><span>
    </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Kodkod.formula</span></span><span> </span><span>list</span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Kodkod.bound</span></span><span> </span><span>list</span><span> * </span><span class="entity"><span>Kodkod.formula</span></span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> bound_for_plain_rel </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>nut</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Kodkod.bound</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> bound_for_sel_rel </span><span class="main"><span>:</span></span><span>
    </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>typ</span><span> * </span><span class="main"><span>(</span></span><span class="entity"><span>nut</span></span><span> * </span><span>int</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span>option</span><span class="main"><span>)</span></span><span> </span><span>list</span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>data_type_spec</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>nut</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Kodkod.bound</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> merge_bounds </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Kodkod.bound</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Kodkod.bound</span></span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> kodkod_formula_from_nut </span><span class="main"><span>:</span></span><span>
    </span><span>int</span><span> </span><span>Typtab.table</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>kodkod_constrs</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>nut</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Kodkod.formula</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> needed_values_for_data_type </span><span class="main"><span>:</span></span><span>
    </span><span class="entity"><span>nut</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span>Typtab.table</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>data_type_spec</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nut</span></span><span> * </span><span>int</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> declarative_axiom_for_plain_rel </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>kodkod_constrs</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>nut</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Kodkod.formula</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> declarative_axioms_for_data_types </span><span class="main"><span>:</span></span><span>
    </span><span class="entity"><span>hol_context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>nut</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>typ</span><span> * </span><span class="main"><span>(</span></span><span class="entity"><span>nut</span></span><span> * </span><span>int</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span>option</span><span class="main"><span>)</span></span><span> </span><span>list</span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span>Typtab.table</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>kodkod_constrs</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>nut</span></span><span> </span><span>NameTable.table</span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>data_type_spec</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Kodkod.formula</span></span><span> </span><span>list</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Nitpick_Kodkod</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>NITPICK_KODKOD</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Nitpick_Util</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Nitpick_HOL</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Nitpick_Scope</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Nitpick_Peephole</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Nitpick_Rep</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Nitpick_Nut</span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>KK</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Kodkod</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pull</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span>::</span><span> </span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xs</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_data_type_acyclic</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span>co</span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span> </span><span>deep</span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>data_type_spec</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_data_type_acyclic</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>flip_nums</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>index_seq</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>]</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="entity"><span>KK.Num</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>univ_card</span></span><span> </span><span class="entity"><span>nat_card</span></span><span> </span><span class="entity"><span>int_card</span></span><span> </span><span class="entity"><span>main_j0</span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="entity"><span>formula</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rel_expr_func</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Int.max</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                    </span><span class="entity"><span>KK.Atom</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span>
                  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>KK.AtomSeq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>j0</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>k'</span></span><span>
                  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tuple_func</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="entity"><span>KK.Tuple</span></span><span> </span><span class="entity"><span>js</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>fold</span><span> </span><span>Integer.max</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Integer.add</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>js</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>k</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>k</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tuple_set_func</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Int.max</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>KK.TupleAtomSeq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>j0</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>k'</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>expr_F</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>formula_func</span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span>I</span><span class="main"><span>,</span></span><span> </span><span>rel_expr_func</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rel_expr_func</span></span><span class="main"><span>,</span></span><span>
                  </span><span>int_expr_func</span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span>I</span><span class="main"><span>}</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tuple_F</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>tuple_func</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tuple_func</span></span><span class="main"><span>,</span></span><span> </span><span>tuple_set_func</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tuple_set_func</span></span><span class="main"><span>}</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>card</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.fold_bound</span></span><span> </span><span class="entity"><span>expr_F</span></span><span> </span><span class="entity"><span>tuple_F</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bounds</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
               </span><span>|&gt;</span><span> </span><span class="entity"><span>KK.fold_formula</span></span><span> </span><span class="entity"><span>expr_F</span></span><span> </span><span class="entity"><span>formula</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Int.max</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>main_j0</span></span><span> </span><span>+</span><span> </span><span>fold</span><span> </span><span>Integer.max</span><span> </span><span class="main"><span>[</span></span><span class="inner_numeral"><span>2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nat_card</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>int_card</span></span><span class="main"><span>]</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>card</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_bits</span></span><span> </span><span class="entity"><span>bits</span></span><span> </span><span class="entity"><span>formula</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>int_expr_func</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Num</span></span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_twos_complement_representable</span></span><span> </span><span class="entity"><span>bits</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>TOO_SMALL</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Kodkod.check_bits"</span></span><span class="main"><span>,</span></span><span>
                           </span><span class="inner_quoted"><span>"\"bits\" value "</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>bits</span></span><span> </span><span>^</span><span>
                           </span><span class="inner_quoted"><span>" too small for problem"</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>int_expr_func</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>expr_F</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>formula_func</span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span>I</span><span class="main"><span>,</span></span><span> </span><span>rel_expr_func</span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span>I</span><span class="main"><span>,</span></span><span>
                  </span><span>int_expr_func</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>int_expr_func</span></span><span class="main"><span>}</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>KK.fold_formula</span></span><span> </span><span class="entity"><span>expr_F</span></span><span> </span><span class="entity"><span>formula</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_arity</span></span><span> </span><span class="entity"><span>guilty_party</span></span><span> </span><span class="entity"><span>univ_card</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>&gt;</span><span> </span><span class="entity"><span>KK.max_arity</span></span><span> </span><span class="entity"><span>univ_card</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>TOO_LARGE</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Kodkod.check_arity"</span></span><span class="main"><span>,</span></span><span>
                     </span><span class="inner_quoted"><span>"arity "</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>n</span></span><span> </span><span>^</span><span>
                     </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>guilty_party</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                        </span><span class="inner_quoted"><span>""</span></span><span>
                      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                        </span><span class="inner_quoted"><span>" of Kodkod relation associated with "</span></span><span> </span><span>^</span><span>
                        </span><span>quote</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>original_name</span></span><span> </span><span class="entity"><span>guilty_party</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span>
                     </span><span class="inner_quoted"><span>" too large for a universe of size "</span></span><span> </span><span>^</span><span>
                     </span><span>string_of_int</span><span> </span><span class="entity"><span>univ_card</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>kk_tuple</span></span><span> </span><span class="entity"><span>debug</span></span><span> </span><span class="entity"><span>univ_card</span></span><span> </span><span class="entity"><span>js</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>debug</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="entity"><span>KK.Tuple</span></span><span> </span><span class="entity"><span>js</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="entity"><span>KK.TupleIndex</span></span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>js</span></span><span class="main"><span>,</span></span><span>
                   </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>accum</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>accum</span></span><span> </span><span>*</span><span> </span><span class="entity"><span>univ_card</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>js</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(* This code is not just a silly optimization: It works around a limitation in
   Kodkodi, whereby {} (i.e., KK.TupleProduct) is always given the cardinality
   of the bound in which it appears, resulting in Kodkod arity errors. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tuple_product</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ts</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>KK.TupleSet</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ts</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>tuple_product</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ts</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>KK.TupleSet</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ts</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>tuple_product</span></span><span> </span><span class="entity"><span>ts1</span></span><span> </span><span class="entity"><span>ts2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>KK.TupleProduct</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ts1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts2</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tuple_set_from_atom_schema</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fold1</span></span><span> </span><span class="entity"><span>tuple_product</span></span><span> </span><span>o</span><span> </span><span>map</span><span> </span><span class="entity"><span>KK.TupleAtomSeq</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>upper_bound_for_rep</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tuple_set_from_atom_schema</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>atom_schema_of_rep</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>single_atom</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>KK.TupleSet</span></span><span> </span><span>o</span><span> </span><span>single</span><span> </span><span>o</span><span> </span><span class="entity"><span>KK.Tuple</span></span><span> </span><span>o</span><span> </span><span>single</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>sequential_int_bounds</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>single_atom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>index_seq</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pow_of_two_int_bounds</span></span><span> </span><span class="entity"><span>bits</span></span><span> </span><span class="entity"><span>j0</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>  </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>pow_of_two</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>~</span><span> </span><span class="entity"><span>pow_of_two</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>single_atom</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="entity"><span>iter</span></span><span> </span><span class="entity"><span>pow_of_two</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>pow_of_two</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>single_atom</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span>
        </span><span class="entity"><span>aux</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>iter</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span>*</span><span> </span><span class="entity"><span>pow_of_two</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bits</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>j0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>built_in_rels_in_formulas</span></span><span> </span><span class="entity"><span>formulas</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rel_expr_func</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Rel</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span> </span><span>&lt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="entity"><span>unsigned_bit_word_sel_rel</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
         </span><span class="entity"><span>x</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="entity"><span>signed_bit_word_sel_rel</span></span><span class="main"><span>)</span></span><span>
        </span><span>?</span><span> </span><span>insert</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>x</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rel_expr_func</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>expr_F</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>formula_func</span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span>I</span><span class="main"><span>,</span></span><span> </span><span>rel_expr_func</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rel_expr_func</span></span><span class="main"><span>,</span></span><span>
                  </span><span>int_expr_func</span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span>I</span><span class="main"><span>}</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.fold_formula</span></span><span> </span><span class="entity"><span>expr_F</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>formulas</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>max_table_size</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>65536</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_table_size</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span>&gt;</span><span> </span><span class="entity"><span>max_table_size</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>TOO_LARGE</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Kodkod.check_table_size"</span></span><span class="main"><span>,</span></span><span>
                     </span><span class="inner_quoted"><span>"precomputed table too large ("</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>k</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>")"</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tabulate_func1</span></span><span> </span><span class="entity"><span>debug</span></span><span> </span><span class="entity"><span>univ_card</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>check_table_size</span></span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>;</span></span><span>
   </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>j1</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>j2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>j1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>j2</span></span><span> </span><span>&gt;=</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                            </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_tuple</span></span><span> </span><span class="entity"><span>debug</span></span><span> </span><span class="entity"><span>univ_card</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>j1</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j2</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                            </span><span>NONE</span><span>
                        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>index_seq</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tabulate_op2</span></span><span> </span><span class="entity"><span>debug</span></span><span> </span><span class="entity"><span>univ_card</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>res_j0</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>check_table_size</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span> </span><span>*</span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
   </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                         </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>j1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span>div</span><span> </span><span class="entity"><span>k</span></span><span>
                         </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>j2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>j1</span></span><span> </span><span>*</span><span> </span><span class="entity"><span>k</span></span><span>
                         </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>j3</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j2</span></span><span class="main"><span>)</span></span><span>
                       </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                         </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>j3</span></span><span> </span><span>&gt;=</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                           </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_tuple</span></span><span> </span><span class="entity"><span>debug</span></span><span> </span><span class="entity"><span>univ_card</span></span><span>
                                          </span><span class="main"><span>[</span></span><span class="entity"><span>j1</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j2</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j3</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>res_j0</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                         </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                           </span><span>NONE</span><span>
                       </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>index_seq</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span> </span><span>*</span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tabulate_op2_2</span></span><span> </span><span class="entity"><span>debug</span></span><span> </span><span class="entity"><span>univ_card</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>res_j0</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>check_table_size</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span> </span><span>*</span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
   </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                         </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>j1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span>div</span><span> </span><span class="entity"><span>k</span></span><span>
                         </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>j2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>j1</span></span><span> </span><span>*</span><span> </span><span class="entity"><span>k</span></span><span>
                         </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j3</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j4</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j2</span></span><span class="main"><span>)</span></span><span>
                       </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                         </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>j3</span></span><span> </span><span>&gt;=</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>j4</span></span><span> </span><span>&gt;=</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                           </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_tuple</span></span><span> </span><span class="entity"><span>debug</span></span><span> </span><span class="entity"><span>univ_card</span></span><span>
                                          </span><span class="main"><span>[</span></span><span class="entity"><span>j1</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j2</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j3</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>res_j0</span></span><span class="main"><span>,</span></span><span>
                                           </span><span class="entity"><span>j4</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>res_j0</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                         </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                           </span><span>NONE</span><span>
                       </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>index_seq</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span> </span><span>*</span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tabulate_nat_op2</span></span><span> </span><span class="entity"><span>debug</span></span><span> </span><span class="entity"><span>univ_card</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>tabulate_op2</span></span><span> </span><span class="entity"><span>debug</span></span><span> </span><span class="entity"><span>univ_card</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>j0</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>atom_for_nat</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tabulate_int_op2</span></span><span> </span><span class="entity"><span>debug</span></span><span> </span><span class="entity"><span>univ_card</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>tabulate_op2</span></span><span> </span><span class="entity"><span>debug</span></span><span> </span><span class="entity"><span>univ_card</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>j0</span></span><span>
               </span><span class="main"><span>(</span></span><span class="entity"><span>atom_for_int</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>f</span></span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>int_for_atom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tabulate_int_op2_2</span></span><span> </span><span class="entity"><span>debug</span></span><span> </span><span class="entity"><span>univ_card</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>tabulate_op2_2</span></span><span> </span><span class="entity"><span>debug</span></span><span> </span><span class="entity"><span>univ_card</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>j0</span></span><span>
                 </span><span class="main"><span>(</span></span><span>apply2</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>atom_for_int</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>f</span></span><span>
                  </span><span>o</span><span> </span><span>apply2</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>int_for_atom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>isa_div</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span>div</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>General.Div</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>isa_mod</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span>mod</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>General.Div</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>m</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>isa_gcd</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>m</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>isa_gcd</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>isa_gcd</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>isa_mod</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>isa_lcm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>isa_div</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m</span></span><span> </span><span>*</span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>isa_gcd</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>isa_zgcd</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>isa_gcd</span></span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span>abs</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>isa_norm_frac</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>&lt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>isa_norm_frac</span></span><span> </span><span class="main"><span>(</span></span><span>~</span><span class="entity"><span>m</span></span><span class="main"><span>,</span></span><span> </span><span>~</span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>isa_zgcd</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>isa_div</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>isa_div</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tabulate_built_in_rel</span></span><span> </span><span class="entity"><span>debug</span></span><span> </span><span class="entity"><span>univ_card</span></span><span> </span><span class="entity"><span>nat_card</span></span><span> </span><span class="entity"><span>int_card</span></span><span> </span><span class="entity"><span>j0</span></span><span>
                          </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>check_arity</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="entity"><span>univ_card</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>;</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>not3_rel</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
     </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"not3"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tabulate_func1</span></span><span> </span><span class="entity"><span>debug</span></span><span> </span><span class="entity"><span>univ_card</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>-</span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>suc_rel</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
     </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"suc"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tabulate_func1</span></span><span> </span><span class="entity"><span>debug</span></span><span> </span><span class="entity"><span>univ_card</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>univ_card</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>j0</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span>
                            </span><span class="main"><span>(</span></span><span>Integer.add</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nat_add_rel</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
     </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"nat_add"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tabulate_nat_op2</span></span><span> </span><span class="entity"><span>debug</span></span><span> </span><span class="entity"><span>univ_card</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nat_card</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>+</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>int_add_rel</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
     </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"int_add"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tabulate_int_op2</span></span><span> </span><span class="entity"><span>debug</span></span><span> </span><span class="entity"><span>univ_card</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>int_card</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>+</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nat_subtract_rel</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
     </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"nat_subtract"</span></span><span class="main"><span>,</span></span><span>
      </span><span class="entity"><span>tabulate_op2</span></span><span> </span><span class="entity"><span>debug</span></span><span> </span><span class="entity"><span>univ_card</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nat_card</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>j0</span></span><span> </span><span class="main"><span>(</span></span><span>uncurry</span><span> </span><span class="entity"><span>nat_minus</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>int_subtract_rel</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
     </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"int_subtract"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tabulate_int_op2</span></span><span> </span><span class="entity"><span>debug</span></span><span> </span><span class="entity"><span>univ_card</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>int_card</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>-</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nat_multiply_rel</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
     </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"nat_multiply"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tabulate_nat_op2</span></span><span> </span><span class="entity"><span>debug</span></span><span> </span><span class="entity"><span>univ_card</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nat_card</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>*</span><span> </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>int_multiply_rel</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
     </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"int_multiply"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tabulate_int_op2</span></span><span> </span><span class="entity"><span>debug</span></span><span> </span><span class="entity"><span>univ_card</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>int_card</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>*</span><span> </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nat_divide_rel</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
     </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"nat_divide"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tabulate_nat_op2</span></span><span> </span><span class="entity"><span>debug</span></span><span> </span><span class="entity"><span>univ_card</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nat_card</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>isa_div</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>int_divide_rel</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
     </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"int_divide"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tabulate_int_op2</span></span><span> </span><span class="entity"><span>debug</span></span><span> </span><span class="entity"><span>univ_card</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>int_card</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>isa_div</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nat_less_rel</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
     </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"nat_less"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tabulate_nat_op2</span></span><span> </span><span class="entity"><span>debug</span></span><span> </span><span class="entity"><span>univ_card</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nat_card</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span>
                                   </span><span class="main"><span>(</span></span><span class="entity"><span>int_from_bool</span></span><span> </span><span>o</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>&lt;</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>int_less_rel</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
     </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"int_less"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tabulate_int_op2</span></span><span> </span><span class="entity"><span>debug</span></span><span> </span><span class="entity"><span>univ_card</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>int_card</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span>
                                   </span><span class="main"><span>(</span></span><span class="entity"><span>int_from_bool</span></span><span> </span><span>o</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>&lt;</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>gcd_rel</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
     </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"gcd"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tabulate_nat_op2</span></span><span> </span><span class="entity"><span>debug</span></span><span> </span><span class="entity"><span>univ_card</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nat_card</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>isa_gcd</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lcm_rel</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
     </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"lcm"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tabulate_nat_op2</span></span><span> </span><span class="entity"><span>debug</span></span><span> </span><span class="entity"><span>univ_card</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nat_card</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>isa_lcm</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>norm_frac_rel</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
     </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"norm_frac"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tabulate_int_op2_2</span></span><span> </span><span class="entity"><span>debug</span></span><span> </span><span class="entity"><span>univ_card</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>int_card</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span>
                                      </span><span class="entity"><span>isa_norm_frac</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
     </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>ARG</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Kodkod.tabulate_built_in_rel"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"unknown relation"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>bound_for_built_in_rel</span></span><span> </span><span class="entity"><span>debug</span></span><span> </span><span class="entity"><span>univ_card</span></span><span> </span><span class="entity"><span>nat_card</span></span><span> </span><span class="entity"><span>int_card</span></span><span> </span><span class="entity"><span>main_j0</span></span><span>
                           </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span>&lt;=</span><span> </span><span class="entity"><span>suc_rels_base</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>y</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tabulate</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>atom_seq_for_suc_rel</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"suc"</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>tabulate</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
         </span><span class="main"><span>[</span></span><span class="entity"><span>KK.TupleSet</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tabulate_func1</span></span><span> </span><span class="entity"><span>debug</span></span><span> </span><span class="entity"><span>univ_card</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span>
                       </span><span class="main"><span>(</span></span><span>Integer.add</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
         </span><span class="main"><span>[</span></span><span class="entity"><span>KK.TupleSet</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tuple_set_from_atom_schema</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>y</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nick</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tabulate_built_in_rel</span></span><span> </span><span class="entity"><span>debug</span></span><span> </span><span class="entity"><span>univ_card</span></span><span> </span><span class="entity"><span>nat_card</span></span><span> </span><span class="entity"><span>int_card</span></span><span>
                                             </span><span class="entity"><span>main_j0</span></span><span> </span><span class="entity"><span>x</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nick</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>KK.TupleSet</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>axiom_for_built_in_rel</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span>&lt;=</span><span> </span><span class="entity"><span>suc_rels_base</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>y</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tabulate</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>atom_seq_for_suc_rel</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>tabulate</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span>NONE</span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span>&lt;</span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.No</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Rel</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.TotalOrdering</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>KK.AtomSeq</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>KK.Atom</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>KK.Atom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j0</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span>NONE</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>bounds_and_axioms_for_built_in_rels_in_formulas</span></span><span> </span><span class="entity"><span>debug</span></span><span> </span><span class="entity"><span>univ_card</span></span><span> </span><span class="entity"><span>nat_card</span></span><span>
                                                    </span><span class="entity"><span>int_card</span></span><span> </span><span class="entity"><span>main_j0</span></span><span> </span><span class="entity"><span>formulas</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rels</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>built_in_rels_in_formulas</span></span><span> </span><span class="entity"><span>formulas</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bound_for_built_in_rel</span></span><span> </span><span class="entity"><span>debug</span></span><span> </span><span class="entity"><span>univ_card</span></span><span> </span><span class="entity"><span>nat_card</span></span><span> </span><span class="entity"><span>int_card</span></span><span> </span><span class="entity"><span>main_j0</span></span><span class="main"><span>)</span></span><span>
         </span><span class="entity"><span>rels</span></span><span class="main"><span>,</span></span><span>
     </span><span>map_filter</span><span> </span><span class="entity"><span>axiom_for_built_in_rel</span></span><span> </span><span class="entity"><span>rels</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>bound_comment</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>debug</span></span><span> </span><span class="entity"><span>nick</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>short_name</span></span><span> </span><span class="entity"><span>nick</span></span><span> </span><span>^</span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>debug</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_quoted"><span>" :: "</span></span><span> </span><span>^</span><span> </span><span>YXML.content_of</span><span> </span><span class="main"><span>(</span></span><span>Syntax.string_of_typ</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span>
  </span><span class="inner_quoted"><span>" : "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>string_for_rep</span></span><span> </span><span class="entity"><span>R</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>bound_for_plain_rel</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>debug</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>FreeRel</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nick</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bound_comment</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>debug</span></span><span> </span><span class="entity"><span>nick</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>nick</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.bisim_iterator_max|const"><span>bisim_iterator_max</span></a><span>›</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
         </span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>single_atom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
       </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>NUT</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Kodkod.bound_for_plain_rel"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>u</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
       </span><span class="main"><span>[</span></span><span class="entity"><span>KK.TupleSet</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>upper_bound_for_rep</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>bound_for_plain_rel</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>NUT</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Kodkod.bound_for_plain_rel"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>u</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_data_type_nat_like</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>typ</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>constrs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>data_type_spec</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>constrs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="main"><span>[</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>constrs</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>const</span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>List.partition</span><span> </span><span class="entity"><span>is_fun_type</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
       </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts1</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T2</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>Ts1</span></span><span class="main"><span>)</span></span><span>
     </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>needed_values</span></span><span> </span><span class="entity"><span>need_vals</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>need_vals</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>|&gt;</span><span> </span><span>the_default</span><span> </span><span>NONE</span><span> </span><span>|&gt;</span><span> </span><span>these</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>all_values_are_needed</span></span><span> </span><span class="entity"><span>need_vals</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>typ</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>card</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>data_type_spec</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>length</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>needed_values</span></span><span> </span><span class="entity"><span>need_vals</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>card</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_sel_of_constr</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Construct</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sel_us</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>FreeRel</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>x'</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sel_us</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_sel_of_constr</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>bound_for_sel_rel</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>debug</span></span><span> </span><span class="entity"><span>need_vals</span></span><span> </span><span class="entity"><span>dtypes</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>FreeRel</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                  </span><span class="entity"><span>R</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Func</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nick</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>constr_s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>original_name</span></span><span> </span><span class="entity"><span>nick</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>delta</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>epsilon</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>exclusive</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>explicit_max</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>constr_spec</span></span><span> </span><span class="entity"><span>dtypes</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>constr_s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T1</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dtype</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>card</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>data_type_spec</span></span><span> </span><span class="entity"><span>dtypes</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span>|&gt;</span><span> </span><span>the</span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T1_need_vals</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>needed_values</span></span><span> </span><span class="entity"><span>need_vals</span></span><span> </span><span class="entity"><span>T1</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bound_comment</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>debug</span></span><span> </span><span class="entity"><span>nick</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
         </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>discr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Formula</span></span><span> </span><span class="entity"><span>Neut</span></span><span class="main"><span>)</span></span><span>
         </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>complete_need_vals</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>T1_need_vals</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>card</span></span><span class="main"><span>)</span></span><span>
         </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>my_need_vals</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>other_need_vals</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
           </span><span class="entity"><span>T1_need_vals</span></span><span> </span><span>|&gt;</span><span> </span><span>List.partition</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_sel_of_constr</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span>
         </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>atom_seq_for_self_rec</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_data_type_nat_like</span></span><span> </span><span class="entity"><span>dtype</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>j0</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span>
         </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>exact_bound_for_perhaps_needy_atom</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>AList.find</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>my_need_vals</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
             </span><span class="main"><span>[</span></span><span class="entity"><span>constr_u</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
               </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>sel_no_from_name</span></span><span> </span><span class="entity"><span>nick</span></span><span>
               </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>arg_u</span></span><span> </span><span class="main"><span>=</span></span><span>
                 </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>constr_u</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                   </span><span class="entity"><span>Construct</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arg_us</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>nth</span><span> </span><span class="entity"><span>arg_us</span></span><span> </span><span class="entity"><span>n</span></span><span>
                 </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"expected \"Construct\""</span></span><span>
               </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T2_need_vals</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>needed_values</span></span><span> </span><span class="entity"><span>need_vals</span></span><span> </span><span class="entity"><span>T2</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
               </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T2_need_vals</span></span><span> </span><span class="entity"><span>arg_u</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                 </span><span>SOME</span><span> </span><span class="entity"><span>arg_j</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.TupleAtomSeq</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arg_j</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
               </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
             </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
         </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>n_fold_tuple_union</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>KK.TupleSet</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>n_fold_tuple_union</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ts</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>tss</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
             </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.TupleUnion</span></span><span> </span><span>o</span><span> </span><span>swap</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tss</span></span><span> </span><span class="entity"><span>ts</span></span><span>
         </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tuple_perhaps_needy_atom</span></span><span> </span><span class="entity"><span>upper</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=</span></span><span>
           </span><span class="entity"><span>single_atom</span></span><span> </span><span class="entity"><span>j</span></span><span>
           </span><span>|&gt;</span><span> </span><span>not</span><span> </span><span class="entity"><span>discr</span></span><span>
              </span><span>?</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>tuple_product</span></span><span> </span><span class="entity"><span>ts</span></span><span>
                              </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>exact_bound_for_perhaps_needy_atom</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                                 </span><span>SOME</span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ts</span></span><span>
                               </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>upper</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>upper_bound_for_rep</span></span><span> </span><span class="entity"><span>R2</span></span><span>
                                         </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>KK.TupleSet</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
         </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>bound_tuples</span></span><span> </span><span class="entity"><span>upper</span></span><span> </span><span class="main"><span>=</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>T1_need_vals</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>upper</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
               </span><span class="entity"><span>KK.TupleAtomSeq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>epsilon</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>delta</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>delta</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span>
               </span><span>|&gt;</span><span> </span><span>not</span><span> </span><span class="entity"><span>discr</span></span><span>
                  </span><span>?</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>tuple_product</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>upper_bound_for_rep</span></span><span> </span><span class="entity"><span>R2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
               </span><span class="entity"><span>KK.TupleSet</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
             </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>complete_need_vals</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                </span><span class="entity"><span>my_need_vals</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span>snd</span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                </span><span class="entity"><span>index_seq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>delta</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>epsilon</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>delta</span></span><span class="main"><span>)</span></span><span>
                </span><span>|&gt;</span><span> </span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>o</span><span> </span><span>apsnd</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>other_need_vals</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
             </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tuple_perhaps_needy_atom</span></span><span> </span><span class="entity"><span>upper</span></span><span class="main"><span>)</span></span><span>
             </span><span>|&gt;</span><span> </span><span class="entity"><span>n_fold_tuple_union</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>explicit_max</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>complete_need_vals</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>my_need_vals</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
           </span><span class="main"><span>[</span></span><span class="entity"><span>KK.TupleSet</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>discr</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
             </span><span class="main"><span>[</span></span><span class="entity"><span>bound_tuples</span></span><span> </span><span>true</span><span class="main"><span>]</span></span><span>
             </span><span>|&gt;</span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>exclusive</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>all_values_are_needed</span></span><span> </span><span class="entity"><span>need_vals</span></span><span> </span><span class="entity"><span>dtype</span></span><span class="main"><span>)</span></span><span>
                </span><span>?</span><span> </span><span>cons</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.TupleSet</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
             </span><span class="main"><span>[</span></span><span class="entity"><span>bound_tuples</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>T2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>epsilon</span></span><span> </span><span>&gt;</span><span> </span><span class="entity"><span>delta</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
                 </span><span class="entity"><span>is_data_type_acyclic</span></span><span> </span><span class="entity"><span>dtype</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                </span><span class="entity"><span>index_seq</span></span><span> </span><span class="entity"><span>delta</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>epsilon</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>delta</span></span><span class="main"><span>)</span></span><span>
                </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>tuple_product</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.TupleSet</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>KK.Tuple</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>j</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                                    </span><span class="main"><span>(</span></span><span class="entity"><span>KK.TupleAtomSeq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>atom_seq_for_self_rec</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                </span><span>|&gt;</span><span> </span><span class="entity"><span>n_fold_tuple_union</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                </span><span class="entity"><span>bound_tuples</span></span><span> </span><span>true</span><span class="main"><span>]</span></span><span>
             </span><span>|&gt;</span><span> </span><span>distinct</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>bound_for_sel_rel</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>NUT</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Kodkod.bound_for_sel_rel"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>u</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>merge_bounds</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>arity</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>zs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fst</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>zs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_bound</span></span><span> </span><span class="entity"><span>ds</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.revAppend</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ds</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>b</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_bound</span></span><span> </span><span class="entity"><span>ds</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>cs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>arity</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>arity</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>snd</span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>snd</span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span>List.revAppend</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ds</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>c</span></span><span> </span><span>@</span><span> </span><span>fst</span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span>snd</span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>cs</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="entity"><span>add_bound</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ds</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>cs</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_bound</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unary_var_seq</span></span><span> </span><span class="entity"><span>j0</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="entity"><span>KK.Var</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>index_seq</span></span><span> </span><span class="entity"><span>j0</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>singleton_from_combination</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>foldl1</span><span> </span><span class="entity"><span>KK.Product</span></span><span> </span><span>o</span><span> </span><span>map</span><span> </span><span class="entity"><span>KK.Atom</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>all_singletons_for_rep</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_lone_rep</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="entity"><span>all_combinations_for_rep</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="entity"><span>singleton_from_combination</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>REP</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Kodkod.all_singletons_for_rep"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>R</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unpack_products</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Product</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>unpack_products</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>unpack_products</span></span><span> </span><span class="entity"><span>r2</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>unpack_products</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>r</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unpack_joins</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Join</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unpack_joins</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>unpack_joins</span></span><span> </span><span class="entity"><span>r2</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>unpack_joins</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>r</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty_rel_for_rep</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>empty_n_ary_rel</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>arity_of_rep</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>full_rel_for_rep</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>atom_schema_of_rep</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>REP</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Kodkod.full_rel_for_rep"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>R</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>schema</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>foldl1</span><span> </span><span class="entity"><span>KK.Product</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>KK.AtomSeq</span></span><span> </span><span class="entity"><span>schema</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>decls_for_atom_schema</span></span><span> </span><span class="entity"><span>j0</span></span><span> </span><span class="entity"><span>schema</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>KK.DeclOne</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>KK.AtomSeq</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
       </span><span class="main"><span>(</span></span><span class="entity"><span>index_seq</span></span><span> </span><span class="entity"><span>j0</span></span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>schema</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>schema</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>d_n_ary_function</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>kk_all</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_join</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_lone</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_one</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>kodkod_constrs</span></span><span class="main"><span>)</span></span><span>
                     </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>body_R</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>body_rep</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_lone_rep</span></span><span> </span><span class="entity"><span>body_R</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>binder_schema</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>atom_schema_of_reps</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>binder_reps</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>body_schema</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>atom_schema_of_rep</span></span><span> </span><span class="entity"><span>body_R</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>one</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>is_one_rep</span></span><span> </span><span class="entity"><span>body_R</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>opt_x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>KK.Rel</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>opt_x</span></span><span> </span><span>&lt;&gt;</span><span> </span><span>NONE</span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>length</span><span> </span><span class="entity"><span>binder_schema</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
           </span><span>length</span><span> </span><span class="entity"><span>body_schema</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>one</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>KK.Function</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>KK.Functional</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="entity"><span>opt_x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>KK.AtomSeq</span></span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>binder_schema</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
               </span><span class="entity"><span>KK.AtomSeq</span></span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>body_schema</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>decls</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>decls_for_atom_schema</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="entity"><span>binder_schema</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unary_var_seq</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>binder_schema</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>kk_xone</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>one</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>kk_one</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>kk_lone</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>kk_all</span></span><span> </span><span class="entity"><span>decls</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_xone</span></span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="entity"><span>kk_join</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="entity"><span>KK.True</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>kk_n_ary_function</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>KK.Rel</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_opt_rep</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>suc_rel</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="entity"><span>KK.False</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nat_add_rel</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="entity"><span>formula_for_bool</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>card_of_rep</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>body_rep</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nat_multiply_rel</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="entity"><span>formula_for_bool</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>card_of_rep</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>body_rep</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span> </span><span>&lt;=</span><span> </span><span class="inner_numeral"><span>2</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="entity"><span>d_n_ary_function</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>r</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nat_subtract_rel</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="entity"><span>KK.True</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="entity"><span>d_n_ary_function</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>r</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>kk_n_ary_function</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>d_n_ary_function</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>r</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>kk_disjoint_sets</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>KK.True</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>kk_disjoint_sets</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>kk_and</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_no</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_intersect</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>kodkod_constrs</span></span><span class="main"><span>)</span></span><span>
                     </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>rs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_and</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>kk_no</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>kk_intersect</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_disjoint_sets</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>rs</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>basic_rel_rel_let</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>kk_rel_let</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>kodkod_constrs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>inline_rel_expr</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>r</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.arity_of_rel_expr</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>kk_rel_let</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>KK.AssignRelReg</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.RelReg</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>single_rel_rel_let</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>basic_rel_rel_let</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>double_rel_rel_let</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>single_rel_rel_let</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>basic_rel_rel_let</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>r1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>r1</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>triple_rel_rel_let</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="entity"><span>r3</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>double_rel_rel_let</span></span><span> </span><span class="entity"><span>kk</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>basic_rel_rel_let</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>r3</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>r2</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>atom_from_formula</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>kk_rel_if</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>kodkod_constrs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>j0</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>kk_rel_if</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Atom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j0</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Atom</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rel_expr_from_formula</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>unopt_rep</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>atom_from_formula</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>j0</span></span><span> </span><span class="entity"><span>f</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>REP</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Kodkod.rel_expr_from_formula"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>R</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unpack_vect_in_chunks</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>kk_project_seq</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>kodkod_constrs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>chunk_arity</span></span><span>
                          </span><span class="entity"><span>num_chunks</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>List.tabulate</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>num_chunks</span></span><span class="main"><span>,</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>kk_project_seq</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span> </span><span>*</span><span> </span><span class="entity"><span>chunk_arity</span></span><span class="main"><span>)</span></span><span>
                                                    </span><span class="entity"><span>chunk_arity</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>kk_n_fold_join</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>kk</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>kk_intersect</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_product</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_join</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_project_seq</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>one</span></span><span> </span><span class="entity"><span>R1</span></span><span>
        </span><span class="entity"><span>res_R</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>arity_of_rep</span></span><span> </span><span class="entity"><span>R1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>kk_join</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>r2</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>arity1</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>unpacked_rs1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unpack_products</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>one</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>length</span><span> </span><span class="entity"><span>unpacked_rs1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>arity1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span>fold</span><span> </span><span class="entity"><span>kk_join</span></span><span> </span><span class="entity"><span>unpacked_rs1</span></span><span> </span><span class="entity"><span>r2</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>one</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>inline_rel_expr</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span>fold</span><span> </span><span class="entity"><span>kk_join</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unpack_vect_in_chunks</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>arity1</span></span><span> </span><span class="entity"><span>r1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>r2</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="entity"><span>kk_project_seq</span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>kk_intersect</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_product</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>full_rel_for_rep</span></span><span> </span><span class="entity"><span>res_R</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span>
            </span><span class="entity"><span>arity1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arity_of_rep</span></span><span> </span><span class="entity"><span>res_R</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>kk_case_switch</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>kk_union</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_product</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>R1</span></span><span> </span><span class="entity"><span>R2</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>rs1</span></span><span> </span><span class="entity"><span>rs2</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>rs1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rs2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>r</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>kk_n_fold_join</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>R1</span></span><span> </span><span class="entity"><span>R2</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fold1</span></span><span> </span><span class="entity"><span>kk_union</span></span><span> </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="entity"><span>kk_product</span></span><span> </span><span class="entity"><span>rs1</span></span><span> </span><span class="entity"><span>rs2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lone_rep_fallback_max_card</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>4096</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>some_j0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lone_rep_fallback</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>new_R</span></span><span> </span><span class="entity"><span>old_R</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>old_R</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>new_R</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="entity"><span>r</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>card</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>card_of_rep</span></span><span> </span><span class="entity"><span>old_R</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_lone_rep</span></span><span> </span><span class="entity"><span>old_R</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>is_lone_rep</span></span><span> </span><span class="entity"><span>new_R</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
         </span><span class="entity"><span>card</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>card_of_rep</span></span><span> </span><span class="entity"><span>new_R</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>card</span></span><span> </span><span>&gt;=</span><span> </span><span class="entity"><span>lone_rep_fallback_max_card</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>TOO_LARGE</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Kodkod.lone_rep_fallback"</span></span><span class="main"><span>,</span></span><span>
                           </span><span class="inner_quoted"><span>"too high cardinality ("</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>card</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>")"</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="entity"><span>kk_case_switch</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>old_R</span></span><span> </span><span class="entity"><span>new_R</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>all_singletons_for_rep</span></span><span> </span><span class="entity"><span>old_R</span></span><span class="main"><span>)</span></span><span>
                         </span><span class="main"><span>(</span></span><span class="entity"><span>all_singletons_for_rep</span></span><span> </span><span class="entity"><span>new_R</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>REP</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Kodkod.lone_rep_fallback"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>old_R</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>new_R</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>atom_from_rel_expr</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="entity"><span>old_R</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>old_R</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="entity"><span>Func</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dom_card</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>card_of_rep</span></span><span> </span><span class="entity"><span>R1</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>R2'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>R2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>R2</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>card_of_rep</span></span><span> </span><span class="entity"><span>R2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>some_j0</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>atom_from_rel_expr</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Vect</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dom_card</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R2'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                         </span><span class="main"><span>(</span></span><span class="entity"><span>vect_from_rel_expr</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>dom_card</span></span><span> </span><span class="entity"><span>R2'</span></span><span> </span><span class="entity"><span>old_R</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Opt</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>REP</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Kodkod.atom_from_rel_expr"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>old_R</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>lone_rep_fallback</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>old_R</span></span><span> </span><span class="entity"><span>r</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>struct_from_rel_expr</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>Rs</span></span><span> </span><span class="entity"><span>old_R</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>old_R</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>lone_rep_fallback</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Struct</span></span><span> </span><span class="entity"><span>Rs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>old_R</span></span><span> </span><span class="entity"><span>r</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Struct</span></span><span> </span><span class="entity"><span>Rs'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>Rs'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Rs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="entity"><span>r</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>map</span><span> </span><span class="entity"><span>card_of_rep</span></span><span> </span><span class="entity"><span>Rs'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>card_of_rep</span></span><span> </span><span class="entity"><span>Rs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>old_arities</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>arity_of_rep</span></span><span> </span><span class="entity"><span>Rs'</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>old_offsets</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>offset_list</span></span><span> </span><span class="entity"><span>old_arities</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>old_rs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>kk_project_seq</span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>old_offsets</span></span><span> </span><span class="entity"><span>old_arities</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>fold1</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>kk_product</span><span> </span><span class="entity"><span>kk</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>map</span></span><span> 3</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rel_expr_from_rel_expr</span></span><span> </span><span class="entity"><span>kk</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Rs</span></span><span> </span><span class="entity"><span>Rs'</span></span><span> </span><span class="entity"><span>old_rs</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="entity"><span>lone_rep_fallback</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Struct</span></span><span> </span><span class="entity"><span>Rs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>old_R</span></span><span> </span><span class="entity"><span>r</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>REP</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Kodkod.struct_from_rel_expr"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>old_R</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>vect_from_rel_expr</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>old_R</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>old_R</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>lone_rep_fallback</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Vect</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>old_R</span></span><span> </span><span class="entity"><span>r</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Vect</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>k'</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>R'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>r</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>lone_rep_fallback</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Vect</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>old_R</span></span><span> </span><span class="entity"><span>r</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Func</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Formula</span></span><span> </span><span class="entity"><span>Neut</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>card_of_rep</span></span><span> </span><span class="entity"><span>R1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="entity"><span>fold1</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>kk_product</span><span> </span><span class="entity"><span>kk</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>arg_r</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                     </span><span class="entity"><span>rel_expr_from_formula</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>kk_subset</span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>arg_r</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                 </span><span class="main"><span>(</span></span><span class="entity"><span>all_singletons_for_rep</span></span><span> </span><span class="entity"><span>R1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>REP</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Kodkod.vect_from_rel_expr"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>old_R</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Func</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="entity"><span>fold1</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>kk_product</span><span> </span><span class="entity"><span>kk</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>arg_r</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                   </span><span class="entity"><span>rel_expr_from_rel_expr</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>R2</span></span><span>
                                         </span><span class="main"><span>(</span></span><span class="entity"><span>kk_n_fold_join</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>R1</span></span><span> </span><span class="entity"><span>R2</span></span><span> </span><span class="entity"><span>arg_r</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
               </span><span class="main"><span>(</span></span><span class="entity"><span>all_singletons_for_rep</span></span><span> </span><span class="entity"><span>R1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>REP</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Kodkod.vect_from_rel_expr"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>old_R</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>func_from_no_opt_rel_expr</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>R1</span></span><span> </span><span class="entity"><span>R2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dom_card</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>card_of_rep</span></span><span> </span><span class="entity"><span>R1</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>R2'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>R2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>R2</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>card_of_rep</span></span><span> </span><span class="entity"><span>R2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>some_j0</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>func_from_no_opt_rel_expr</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>R1</span></span><span> </span><span class="entity"><span>R2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Vect</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dom_card</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R2'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                                </span><span class="main"><span>(</span></span><span class="entity"><span>vect_from_rel_expr</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>dom_card</span></span><span> </span><span class="entity"><span>R2'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>func_from_no_opt_rel_expr</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>R1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Formula</span></span><span> </span><span class="entity"><span>Neut</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>old_R</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>old_R</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
       </span><span class="entity"><span>Vect</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
         </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>args_rs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>all_singletons_for_rep</span></span><span> </span><span class="entity"><span>R1</span></span><span>
         </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vals_rs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unpack_vect_in_chunks</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>r</span></span><span>
         </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>empty_or_singleton_set_for</span></span><span> </span><span class="entity"><span>arg_r</span></span><span> </span><span class="entity"><span>val_r</span></span><span> </span><span class="main"><span>=</span></span><span>
           </span><span class="main"><span>#</span></span><span>kk_join</span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>val_r</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>kk_product</span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Atom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j0</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>arg_r</span></span><span class="main"><span>)</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
         </span><span class="entity"><span>fold1</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>kk_union</span><span> </span><span class="entity"><span>kk</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="entity"><span>empty_or_singleton_set_for</span></span><span> </span><span class="entity"><span>args_rs</span></span><span> </span><span class="entity"><span>vals_rs</span></span><span class="main"><span>)</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
     </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Func</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R1'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Formula</span></span><span> </span><span class="entity"><span>Neut</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>R1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>R1'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
         </span><span class="entity"><span>r</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
           </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>schema</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>atom_schema_of_rep</span></span><span> </span><span class="entity"><span>R1</span></span><span>
           </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fold1</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>kk_product</span><span> </span><span class="entity"><span>kk</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unary_var_seq</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>schema</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                    </span><span>|&gt;</span><span> </span><span class="entity"><span>rel_expr_from_rel_expr</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>R1'</span></span><span> </span><span class="entity"><span>R1</span></span><span>
           </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>kk_xeq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_one_rep</span></span><span> </span><span class="entity"><span>R1'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>#</span></span><span>kk_subset</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>#</span></span><span>kk_rel_eq</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>kk</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
           </span><span class="main"><span>#</span></span><span>kk_comprehension</span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>decls_for_atom_schema</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="entity"><span>schema</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_xeq</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
     </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Func</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R1'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
       </span><span class="entity"><span>func_from_no_opt_rel_expr</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>R1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Formula</span></span><span> </span><span class="entity"><span>Neut</span></span><span class="main"><span>)</span></span><span>
           </span><span class="main"><span>(</span></span><span class="entity"><span>Func</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R1'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Formula</span></span><span> </span><span class="entity"><span>Neut</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>kk_join</span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Atom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j0</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
     </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>REP</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Kodkod.func_from_no_opt_rel_expr"</span></span><span class="main"><span>,</span></span><span>
                       </span><span class="main"><span>[</span></span><span class="entity"><span>old_R</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Func</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Formula</span></span><span> </span><span class="entity"><span>Neut</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>func_from_no_opt_rel_expr</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>R1</span></span><span> </span><span class="entity"><span>R2</span></span><span> </span><span class="entity"><span>old_R</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>old_R</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="entity"><span>Vect</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>args_rs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>all_singletons_for_rep</span></span><span> </span><span class="entity"><span>R1</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vals_rs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unpack_vect_in_chunks</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arity_of_rep</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>r</span></span><span>
                      </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rel_expr_from_rel_expr</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>R2</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>fold1</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>kk_union</span><span> </span><span class="entity"><span>kk</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>kk_product</span><span> </span><span class="entity"><span>kk</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args_rs</span></span><span> </span><span class="entity"><span>vals_rs</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Func</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R1'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Formula</span></span><span> </span><span class="entity"><span>Neut</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>R2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
         </span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>schema</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>atom_schema_of_rep</span></span><span> </span><span class="entity"><span>R1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>length</span><span> </span><span class="entity"><span>schema</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
             </span><span class="main"><span>#</span></span><span>kk_override</span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>kk_product</span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.AtomSeq</span></span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>schema</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                                             </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Atom</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                             </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>kk_product</span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Atom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j0</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
               </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fold1</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>kk_product</span><span> </span><span class="entity"><span>kk</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unary_var_seq</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>schema</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                        </span><span>|&gt;</span><span> </span><span class="entity"><span>rel_expr_from_rel_expr</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>R1'</span></span><span> </span><span class="entity"><span>R1</span></span><span>
               </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>KK.Var</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span>~</span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>schema</span></span><span class="main"><span>)</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
               </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>r3</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>atom_from_formula</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>j0</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>kk_subset</span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
               </span><span class="main"><span>#</span></span><span>kk_comprehension</span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>decls_for_atom_schema</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>schema</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>x</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                                 </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>kk_subset</span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="entity"><span>r3</span></span><span class="main"><span>)</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>REP</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Kodkod.func_from_no_opt_rel_expr"</span></span><span class="main"><span>,</span></span><span>
                           </span><span class="main"><span>[</span></span><span class="entity"><span>old_R</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Func</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R2</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Func</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R1'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R2'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>R1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>R1'</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>R2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>R2'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="entity"><span>r</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dom_schema</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>atom_schema_of_rep</span></span><span> </span><span class="entity"><span>R1</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ran_schema</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>atom_schema_of_rep</span></span><span> </span><span class="entity"><span>R2</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dom_prod</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fold1</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>kk_product</span><span> </span><span class="entity"><span>kk</span></span><span class="main"><span>)</span></span><span>
                               </span><span class="main"><span>(</span></span><span class="entity"><span>unary_var_seq</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>dom_schema</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                         </span><span>|&gt;</span><span> </span><span class="entity"><span>rel_expr_from_rel_expr</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>R1'</span></span><span> </span><span class="entity"><span>R1</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ran_prod</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fold1</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>kk_product</span><span> </span><span class="entity"><span>kk</span></span><span class="main"><span>)</span></span><span>
                               </span><span class="main"><span>(</span></span><span class="entity"><span>unary_var_seq</span></span><span> </span><span class="main"><span>(</span></span><span>~</span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>dom_schema</span></span><span class="main"><span>)</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
                                              </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>ran_schema</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                         </span><span>|&gt;</span><span> </span><span class="entity"><span>rel_expr_from_rel_expr</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>R2'</span></span><span> </span><span class="entity"><span>R2</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>app</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>kk_n_fold_join</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>R1'</span></span><span> </span><span class="entity"><span>R2'</span></span><span> </span><span class="entity"><span>dom_prod</span></span><span> </span><span class="entity"><span>r</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>kk_xeq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_one_rep</span></span><span> </span><span class="entity"><span>R2'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>#</span></span><span>kk_subset</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>#</span></span><span>kk_rel_eq</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>kk</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="main"><span>#</span></span><span>kk_comprehension</span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>decls_for_atom_schema</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span>
                                                      </span><span class="main"><span>(</span></span><span class="entity"><span>dom_schema</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>ran_schema</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                               </span><span class="main"><span>(</span></span><span class="entity"><span>kk_xeq</span></span><span> </span><span class="entity"><span>ran_prod</span></span><span> </span><span class="entity"><span>app</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>REP</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Kodkod.func_from_no_opt_rel_expr"</span></span><span class="main"><span>,</span></span><span>
                      </span><span class="main"><span>[</span></span><span class="entity"><span>old_R</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Func</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R2</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>rel_expr_from_rel_expr</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>new_R</span></span><span> </span><span class="entity"><span>old_R</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>unopt_old_R</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unopt_rep</span></span><span> </span><span class="entity"><span>old_R</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>unopt_new_R</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unopt_rep</span></span><span> </span><span class="entity"><span>new_R</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>unopt_old_R</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="entity"><span>old_R</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>unopt_new_R</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>new_R</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>REP</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Kodkod.rel_expr_from_rel_expr"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>old_R</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>new_R</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>unopt_new_R</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unopt_old_R</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="entity"><span>r</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>unopt_new_R</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
         </span><span class="entity"><span>Atom</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>atom_from_rel_expr</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>x</span></span><span>
       </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Struct</span></span><span> </span><span class="entity"><span>Rs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>struct_from_rel_expr</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>Rs</span></span><span>
       </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Vect</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>vect_from_rel_expr</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>R'</span></span><span>
       </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Func</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>func_from_no_opt_rel_expr</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>R1</span></span><span> </span><span class="entity"><span>R2</span></span><span>
       </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>REP</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Kodkod.rel_expr_from_rel_expr"</span></span><span class="main"><span>,</span></span><span>
                         </span><span class="main"><span>[</span></span><span class="entity"><span>old_R</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>new_R</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="entity"><span>unopt_old_R</span></span><span> </span><span class="entity"><span>r</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>rel_expr_to_func</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>R1</span></span><span> </span><span class="entity"><span>R2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rel_expr_from_rel_expr</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Func</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>bit_set_from_atom</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>kk_join</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>kodkod_constrs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>kk_join</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Rel</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.unsigned_bit|type"><span>unsigned_bit</span></a><span> </span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.word|type"><span>word</span></a><span>›</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                       </span><span class="entity"><span>unsigned_bit_word_sel_rel</span></span><span>
                     </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                       </span><span class="entity"><span>signed_bit_word_sel_rel</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>int_expr_from_atom</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>KK.SetSum</span></span><span> </span><span>ooo</span><span> </span><span class="entity"><span>bit_set_from_atom</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>atom_from_int_expr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>kk_rel_eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_comprehension</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span>
                        </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>kodkod_constrs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>kk_comprehension</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>decls_for_atom_schema</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>atom_schema_of_rep</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                   </span><span class="main"><span>(</span></span><span class="entity"><span>kk_rel_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bit_set_from_atom</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Var</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                              </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Bits</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>kodkod_formula_from_nut</span></span><span> </span><span class="entity"><span>ofs</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>kk</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>kk_all</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_exist</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_formula_let</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_formula_if</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_or</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_not</span></span><span class="main"><span>,</span></span><span>
                </span><span class="entity"><span>kk_iff</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_implies</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_and</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_subset</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_rel_eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_no</span></span><span class="main"><span>,</span></span><span>
                </span><span class="entity"><span>kk_lone</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_some</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_rel_let</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_rel_if</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_union</span></span><span class="main"><span>,</span></span><span>
                </span><span class="entity"><span>kk_difference</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_intersect</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_product</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_join</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_closure</span></span><span class="main"><span>,</span></span><span>
                </span><span class="entity"><span>kk_comprehension</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_project</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_project_seq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_not3</span></span><span class="main"><span>,</span></span><span>
                </span><span class="entity"><span>kk_nat_less</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_int_less</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>main_j0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>offset_of_type</span></span><span> </span><span class="entity"><span>ofs</span></span><span> </span><span class="entity"><span>bool_T</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bool_j0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>main_j0</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bool_atom_R</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>main_j0</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>false_atom</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>KK.Atom</span></span><span> </span><span class="entity"><span>bool_j0</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>true_atom</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>KK.Atom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bool_j0</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>formula_from_opt_atom</span></span><span> </span><span class="entity"><span>polar</span></span><span> </span><span class="entity"><span>j0</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>polar</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="entity"><span>Neg</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>kk_not</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_rel_eq</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Atom</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>kk_rel_eq</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Atom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j0</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>formula_from_atom</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>formula_from_opt_atom</span></span><span> </span><span class="entity"><span>Pos</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>unpack_formulas</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>formula_from_atom</span></span><span> </span><span class="entity"><span>bool_j0</span></span><span class="main"><span>)</span></span><span> </span><span>oo</span><span> </span><span class="entity"><span>unpack_vect_in_chunks</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>kk_vect_set_bool_op</span></span><span> </span><span class="entity"><span>connective</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>fold1</span></span><span> </span><span class="entity"><span>kk_and</span></span><span> </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="entity"><span>connective</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unpack_formulas</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>r1</span></span><span class="main"><span>)</span></span><span>
                         </span><span class="main"><span>(</span></span><span class="entity"><span>unpack_formulas</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>to_f</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>rep_of</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="entity"><span>Formula</span></span><span> </span><span class="entity"><span>polar</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
           </span><span class="entity"><span>Cst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>False</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>KK.False</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Cst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>True</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>KK.True</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Op1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Not</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
           </span><span class="entity"><span>kk_not</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_f_with_polarity</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>flip_polarity</span></span><span> </span><span class="entity"><span>polar</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Op1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Finite</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>opt1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>is_opt_rep</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rep_of</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>polar</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
               </span><span class="entity"><span>Neut</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
               </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>opt1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>NUT</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Kodkod.to_f (Finite)"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>u</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
               </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>KK.True</span></span><span> </span><span class="comment1"><span>(* sound? *)</span></span><span>
             </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Pos</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>KK.False</span></span><span>
             </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Neg</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>KK.True</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Op1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IsUnknown</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>kk_no</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_r</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Op1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Cast</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>to_f_with_polarity</span></span><span> </span><span class="entity"><span>polar</span></span><span> </span><span class="entity"><span>u1</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Op2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>All</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
           </span><span class="entity"><span>kk_all</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>untuple</span></span><span> </span><span class="entity"><span>to_decl</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_f_with_polarity</span></span><span> </span><span class="entity"><span>polar</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Op2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Exist</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
           </span><span class="entity"><span>kk_exist</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>untuple</span></span><span> </span><span class="entity"><span>to_decl</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_f_with_polarity</span></span><span> </span><span class="entity"><span>polar</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Op2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Or</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
           </span><span class="entity"><span>kk_or</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_f_with_polarity</span></span><span> </span><span class="entity"><span>polar</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_f_with_polarity</span></span><span> </span><span class="entity"><span>polar</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Op2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>And</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
           </span><span class="entity"><span>kk_and</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_f_with_polarity</span></span><span> </span><span class="entity"><span>polar</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_f_with_polarity</span></span><span> </span><span class="entity"><span>polar</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Op2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Less</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Formula</span></span><span> </span><span class="entity"><span>polar</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
           </span><span class="entity"><span>formula_from_opt_atom</span></span><span> </span><span class="entity"><span>polar</span></span><span> </span><span class="entity"><span>bool_j0</span></span><span>
               </span><span class="main"><span>(</span></span><span class="entity"><span>to_r</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Op2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Less</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Opt</span></span><span> </span><span class="entity"><span>bool_atom_R</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Op2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>DefEq</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
           </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>min_rep</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rep_of</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rep_of</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span class="entity"><span>Formula</span></span><span> </span><span class="entity"><span>polar</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="entity"><span>kk_iff</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_f_with_polarity</span></span><span> </span><span class="entity"><span>polar</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_f_with_polarity</span></span><span> </span><span class="entity"><span>polar</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>min_R</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Op2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Apply</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>u2</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="entity"><span>u1</span></span><span>
                  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Tuple</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>us</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>us</span></span><span>
                  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>opt_arg_us</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_opt_rep</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>rep_of</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>args</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>opt_arg_us</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_Opt</span></span><span> </span><span class="entity"><span>min_R</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
                   </span><span class="entity"><span>is_eval_name</span></span><span> </span><span class="entity"><span>u1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                  </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_or</span></span><span> </span><span>o</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_no</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>to_r</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>opt_arg_us</span></span><span>
                       </span><span class="main"><span>(</span></span><span class="entity"><span>kk_rel_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_rep</span></span><span> </span><span class="entity"><span>min_R</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_rep</span></span><span> </span><span class="entity"><span>min_R</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                  </span><span class="entity"><span>kk_subset</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_rep</span></span><span> </span><span class="entity"><span>min_R</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_rep</span></span><span> </span><span class="entity"><span>min_R</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Op2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Eq</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
           </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>min_rep</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rep_of</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rep_of</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span class="entity"><span>Formula</span></span><span> </span><span class="entity"><span>polar</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="entity"><span>kk_iff</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_f_with_polarity</span></span><span> </span><span class="entity"><span>polar</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_f_with_polarity</span></span><span> </span><span class="entity"><span>polar</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>min_R</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_opt_rep</span></span><span> </span><span class="entity"><span>min_R</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>polar</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Neut</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                  </span><span class="comment1"><span>(* continuation of hackish optimization *)</span></span><span>
                  </span><span class="entity"><span>kk_rel_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_rep</span></span><span> </span><span class="entity"><span>min_R</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_rep</span></span><span> </span><span class="entity"><span>min_R</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_Cst</span></span><span> </span><span class="entity"><span>Unrep</span></span><span> </span><span class="entity"><span>u1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                  </span><span class="entity"><span>to_could_be_unrep</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>polar</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Neg</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>u2</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_Cst</span></span><span> </span><span class="entity"><span>Unrep</span></span><span> </span><span class="entity"><span>u2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                  </span><span class="entity"><span>to_could_be_unrep</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>polar</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Neg</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>u1</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>to_rep</span></span><span> </span><span class="entity"><span>min_R</span></span><span> </span><span class="entity"><span>u1</span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>to_rep</span></span><span> </span><span class="entity"><span>min_R</span></span><span> </span><span class="entity"><span>u2</span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>both_opt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_opt_rep</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>rep_of</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>u1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>]</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>polar</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Pos</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                       </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="entity"><span>both_opt</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                         </span><span class="entity"><span>kk_rel_eq</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>r2</span></span><span>
                       </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_lone_rep</span></span><span> </span><span class="entity"><span>min_R</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
                               </span><span class="entity"><span>arity_of_rep</span></span><span> </span><span class="entity"><span>min_R</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                         </span><span class="entity"><span>kk_some</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_intersect</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span>
                       </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                         </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SAME</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
                     </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                       </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_lone_rep</span></span><span> </span><span class="entity"><span>min_R</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                         </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>arity_of_rep</span></span><span> </span><span class="entity"><span>min_R</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                           </span><span class="entity"><span>kk_lone</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_union</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span>
                         </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="entity"><span>both_opt</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                           </span><span class="main"><span>(</span></span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>is_opt_rep</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rep_of</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span> </span><span>?</span><span> </span><span>swap</span><span>
                                    </span><span>|-&gt;</span><span> </span><span class="entity"><span>kk_subset</span></span><span>
                         </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                           </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SAME</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
                       </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                         </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SAME</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>SAME</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                           </span><span class="entity"><span>formula_from_opt_atom</span></span><span> </span><span class="entity"><span>polar</span></span><span> </span><span class="entity"><span>bool_j0</span></span><span>
                               </span><span class="main"><span>(</span></span><span class="entity"><span>to_guard</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>u1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>bool_atom_R</span></span><span>
                                         </span><span class="main"><span>(</span></span><span class="entity"><span>rel_expr_from_formula</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>bool_atom_R</span></span><span>
                                                            </span><span class="main"><span>(</span></span><span class="entity"><span>kk_rel_eq</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>to_rep</span></span><span> </span><span class="entity"><span>min_R</span></span><span> </span><span class="entity"><span>u1</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>to_rep</span></span><span> </span><span class="entity"><span>min_R</span></span><span> </span><span class="entity"><span>u2</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_one_rep</span></span><span> </span><span class="entity"><span>min_R</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rs1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unpack_products</span></span><span> </span><span class="entity"><span>r1</span></span><span>
                      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rs2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unpack_products</span></span><span> </span><span class="entity"><span>r2</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>length</span><span> </span><span class="entity"><span>rs1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>rs2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
                         </span><span>map</span><span> </span><span class="entity"><span>KK.arity_of_rel_expr</span></span><span> </span><span class="entity"><span>rs1</span></span><span>
                         </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>KK.arity_of_rel_expr</span></span><span> </span><span class="entity"><span>rs2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                        </span><span class="entity"><span>fold1</span></span><span> </span><span class="entity"><span>kk_and</span></span><span> </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="entity"><span>kk_subset</span></span><span> </span><span class="entity"><span>rs1</span></span><span> </span><span class="entity"><span>rs2</span></span><span class="main"><span>)</span></span><span>
                      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                        </span><span class="entity"><span>kk_subset</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>r2</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                    </span><span class="entity"><span>kk_rel_eq</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>r2</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Op2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Apply</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
           </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>polar</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rep_of</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>Neg</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Func</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Formula</span></span><span> </span><span class="entity"><span>Neut</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>kk_subset</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_opt</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_r</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="entity"><span>to_f_with_polarity</span></span><span> </span><span class="entity"><span>polar</span></span><span>
                 </span><span class="main"><span>(</span></span><span class="entity"><span>Op2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Apply</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Opt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>offset_of_type</span></span><span> </span><span class="entity"><span>ofs</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Op3</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Let</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u3</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
           </span><span class="entity"><span>kk_formula_let</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>to_expr_assign</span></span><span> </span><span class="entity"><span>u1</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_f_with_polarity</span></span><span> </span><span class="entity"><span>polar</span></span><span> </span><span class="entity"><span>u3</span></span><span class="main"><span>)</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Op3</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>If</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u3</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
           </span><span class="entity"><span>kk_formula_if</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_f</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_f_with_polarity</span></span><span> </span><span class="entity"><span>polar</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span>
                         </span><span class="main"><span>(</span></span><span class="entity"><span>to_f_with_polarity</span></span><span> </span><span class="entity"><span>polar</span></span><span> </span><span class="entity"><span>u3</span></span><span class="main"><span>)</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>FormulaReg</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>KK.FormulaReg</span></span><span> </span><span class="entity"><span>j</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>NUT</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Kodkod.to_f"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>u</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>formula_from_atom</span></span><span> </span><span class="entity"><span>j0</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_r</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>NUT</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Kodkod.to_f"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>u</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>to_f_with_polarity</span></span><span> </span><span class="entity"><span>polar</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>rep_of</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="entity"><span>Formula</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>to_f</span></span><span> </span><span class="entity"><span>u</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>formula_from_atom</span></span><span> </span><span class="entity"><span>j0</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_r</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Opt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>formula_from_opt_atom</span></span><span> </span><span class="entity"><span>polar</span></span><span> </span><span class="entity"><span>j0</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_r</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>NUT</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Kodkod.to_f_with_polarity"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>u</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>to_r</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="entity"><span>Cst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>False</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>false_atom</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Cst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>True</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>true_atom</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Cst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Iden</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Func</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Struct</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>R1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R2</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Formula</span></span><span> </span><span class="entity"><span>Neut</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>R1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>R2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>arity_of_rep</span></span><span> </span><span class="entity"><span>R1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="entity"><span>kk_intersect</span></span><span> </span><span class="entity"><span>KK.Iden</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_product</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>full_rel_for_rep</span></span><span> </span><span class="entity"><span>R1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>KK.Univ</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>schema1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>atom_schema_of_rep</span></span><span> </span><span class="entity"><span>R1</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>schema2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>atom_schema_of_rep</span></span><span> </span><span class="entity"><span>R2</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>arity1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>schema1</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>arity2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>schema2</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fold1</span></span><span> </span><span class="entity"><span>kk_product</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unary_var_seq</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="entity"><span>arity1</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fold1</span></span><span> </span><span class="entity"><span>kk_product</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unary_var_seq</span></span><span> </span><span class="entity"><span>arity1</span></span><span> </span><span class="entity"><span>arity2</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>min_R</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>min_rep</span></span><span> </span><span class="entity"><span>R1</span></span><span> </span><span class="entity"><span>R2</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="entity"><span>kk_comprehension</span></span><span>
                </span><span class="main"><span>(</span></span><span class="entity"><span>decls_for_atom_schema</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>schema1</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>schema2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                </span><span class="main"><span>(</span></span><span class="entity"><span>kk_rel_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rel_expr_from_rel_expr</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>min_R</span></span><span> </span><span class="entity"><span>R1</span></span><span> </span><span class="entity"><span>r1</span></span><span class="main"><span>)</span></span><span>
                           </span><span class="main"><span>(</span></span><span class="entity"><span>rel_expr_from_rel_expr</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>min_R</span></span><span> </span><span class="entity"><span>R2</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Cst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Iden</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Func</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Formula</span></span><span> </span><span class="entity"><span>Neut</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>KK.Atom</span></span><span> </span><span class="entity"><span>j0</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Cst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Iden</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Set.html#Set.set|type"><span>set</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T1</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Func</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>to_rep</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Cst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Iden</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Func</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>one_rep</span></span><span> </span><span class="entity"><span>ofs</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>R1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Formula</span></span><span> </span><span class="entity"><span>Neut</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Cst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Num</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_word_type</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="entity"><span>atom_from_int_expr</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Num</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>int_T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>atom_for_int</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>card_of_rep</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>offset_of_type</span></span><span> </span><span class="entity"><span>ofs</span></span><span> </span><span class="entity"><span>int_T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_opt_rep</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>KK.None</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>NUT</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Kodkod.to_r (Num)"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>u</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>j'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>KK.Atom</span></span><span> </span><span class="entity"><span>j'</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span>&lt;</span><span> </span><span class="entity"><span>card_of_rep</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>KK.Atom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>offset_of_type</span></span><span> </span><span class="entity"><span>ofs</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_opt_rep</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>KK.None</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>NUT</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Kodkod.to_r (Num)"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>u</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Cst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Unknown</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>empty_rel_for_rep</span></span><span> </span><span class="entity"><span>R</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Cst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Unrep</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>empty_rel_for_rep</span></span><span> </span><span class="entity"><span>R</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Cst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Suc</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.unsigned_bit|type"><span>unsigned_bit</span></a><span> </span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.word|type"><span>word</span></a><span> </span><span class="main"><span>=&gt;</span></span><span> </span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.unsigned_bit|type"><span>unsigned_bit</span></a><span> </span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.word|type"><span>word</span></a><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>to_bit_word_unary_op</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="entity"><span>KK.Add</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Num</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Cst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Suc</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Nat.html#Nat.nat|type"><span>nat</span></a><span> </span><span class="main"><span>=&gt;</span></span><span> </span><a class="entity_ref" href="../../../../../Nat.html#Nat.nat|type"><span>nat</span></a><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Func</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>kk_intersect</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Rel</span></span><span> </span><span class="entity"><span>suc_rel</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_product</span></span><span> </span><span class="entity"><span>KK.Univ</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.AtomSeq</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Cst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Suc</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Func</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>KK.Rel</span></span><span> </span><span class="entity"><span>suc_rel</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Cst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Add</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Nat.html#Nat.nat|type"><span>nat</span></a><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>KK.Rel</span></span><span> </span><span class="entity"><span>nat_add_rel</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Cst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Add</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Int.html#Int.int|type"><span>int</span></a><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>KK.Rel</span></span><span> </span><span class="entity"><span>int_add_rel</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Cst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Add</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.unsigned_bit|type"><span>unsigned_bit</span></a><span> </span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.word|type"><span>word</span></a><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>to_bit_word_binary_op</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="entity"><span>KK.Add</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Cst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Add</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.signed_bit|type"><span>signed_bit</span></a><span> </span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.word|type"><span>word</span></a><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>to_bit_word_binary_op</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>R</span></span><span>
            </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i1</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i2</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i3</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                 </span><span class="entity"><span>kk_implies</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.LE</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Num</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>KK.BitXor</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                            </span><span class="main"><span>(</span></span><span class="entity"><span>KK.LE</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Num</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>KK.BitXor</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i3</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="entity"><span>KK.Add</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Cst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Subtract</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Nat.html#Nat.nat|type"><span>nat</span></a><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>KK.Rel</span></span><span> </span><span class="entity"><span>nat_subtract_rel</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Cst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Subtract</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Int.html#Int.int|type"><span>int</span></a><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>KK.Rel</span></span><span> </span><span class="entity"><span>int_subtract_rel</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Cst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Subtract</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.unsigned_bit|type"><span>unsigned_bit</span></a><span> </span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.word|type"><span>word</span></a><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>to_bit_word_binary_op</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span>NONE</span><span>
            </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i1</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i2</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                      </span><span class="entity"><span>KK.IntIf</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.LE</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>KK.Num</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>KK.Sub</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Cst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Subtract</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.signed_bit|type"><span>signed_bit</span></a><span> </span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.word|type"><span>word</span></a><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>to_bit_word_binary_op</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>R</span></span><span>
            </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i1</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i2</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i3</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                 </span><span class="entity"><span>kk_implies</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.LT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.BitXor</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>KK.Num</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                            </span><span class="main"><span>(</span></span><span class="entity"><span>KK.LT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.BitXor</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i3</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>KK.Num</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="entity"><span>KK.Sub</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Cst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Multiply</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Nat.html#Nat.nat|type"><span>nat</span></a><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>KK.Rel</span></span><span> </span><span class="entity"><span>nat_multiply_rel</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Cst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Multiply</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Int.html#Int.int|type"><span>int</span></a><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>KK.Rel</span></span><span> </span><span class="entity"><span>int_multiply_rel</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Cst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Multiply</span></span><span class="main"><span>,</span></span><span>
             </span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.word|type"><span>word</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>bit_T</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>to_bit_word_binary_op</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>R</span></span><span>
            </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i1</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i2</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i3</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span class="entity"><span>kk_or</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.IntEq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>KK.Num</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                      </span><span class="main"><span>(</span></span><span class="entity"><span>KK.IntEq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Div</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i3</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i1</span></span><span class="main"><span>)</span></span><span>
                       </span><span>|&gt;</span><span> </span><span class="entity"><span>bit_T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.signed_bit|type"><span>signed_bit</span></a><span>›</span></span></span><span>
                          </span><span>?</span><span> </span><span class="entity"><span>kk_and</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.LE</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Num</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span>
                                           </span><span>foldl1</span><span> </span><span class="entity"><span>KK.BitAnd</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>i1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i3</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="entity"><span>KK.Mult</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Cst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Divide</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Nat.html#Nat.nat|type"><span>nat</span></a><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>KK.Rel</span></span><span> </span><span class="entity"><span>nat_divide_rel</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Cst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Divide</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Int.html#Int.int|type"><span>int</span></a><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>KK.Rel</span></span><span> </span><span class="entity"><span>int_divide_rel</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Cst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Divide</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.unsigned_bit|type"><span>unsigned_bit</span></a><span> </span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.word|type"><span>word</span></a><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>to_bit_word_binary_op</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span>NONE</span><span>
            </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i1</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i2</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                      </span><span class="entity"><span>KK.IntIf</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.IntEq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>KK.Num</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                                </span><span class="entity"><span>KK.Num</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>KK.Div</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Cst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Divide</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.signed_bit|type"><span>signed_bit</span></a><span> </span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.word|type"><span>word</span></a><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>to_bit_word_binary_op</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>R</span></span><span>
            </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i1</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i2</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i3</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                      </span><span class="entity"><span>KK.LE</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Num</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span>foldl1</span><span> </span><span class="entity"><span>KK.BitAnd</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>i1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i3</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i1</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i2</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                 </span><span class="entity"><span>KK.IntIf</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_and</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.LT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>KK.Num</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                                  </span><span class="main"><span>(</span></span><span class="entity"><span>KK.LT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Num</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                     </span><span class="entity"><span>KK.Sub</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Div</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Add</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>KK.Num</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>KK.Num</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                     </span><span class="entity"><span>KK.IntIf</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_and</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.LT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Num</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                                      </span><span class="main"><span>(</span></span><span class="entity"><span>KK.LT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>KK.Num</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                         </span><span class="entity"><span>KK.Sub</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Div</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Sub</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>KK.Num</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>KK.Num</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                         </span><span class="entity"><span>KK.IntIf</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.IntEq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>KK.Num</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                                   </span><span class="entity"><span>KK.Num</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>KK.Div</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Cst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Gcd</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>KK.Rel</span></span><span> </span><span class="entity"><span>gcd_rel</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Cst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Lcm</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>KK.Rel</span></span><span> </span><span class="entity"><span>lcm_rel</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Cst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Fracs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Func</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>KK.None</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Cst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Fracs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Func</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Struct</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>kk_project_seq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Rel</span></span><span> </span><span class="entity"><span>norm_frac_rel</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Cst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>NormFrac</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>KK.Rel</span></span><span> </span><span class="entity"><span>norm_frac_rel</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Cst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>NatToInt</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Nat.html#Nat.nat|type"><span>nat</span></a><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Func</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>KK.Iden</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Cst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>NatToInt</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Nat.html#Nat.nat|type"><span>nat</span></a><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
             </span><span class="entity"><span>Func</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nat_j0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Opt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>int_k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>int_j0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>nat_j0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>int_j0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="entity"><span>kk_intersect</span></span><span> </span><span class="entity"><span>KK.Iden</span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>kk_product</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.AtomSeq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>max_int_for_card</span></span><span> </span><span class="entity"><span>int_k</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nat_j0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                          </span><span class="entity"><span>KK.Univ</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>BAD</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Kodkod.to_r (NatToInt)"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"\"nat_j0 &lt;&gt; int_j0\""</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Cst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>NatToInt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.unsigned_bit|type"><span>unsigned_bit</span></a><span> </span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.word|type"><span>word</span></a><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>to_bit_word_unary_op</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span>I</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Cst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IntToNat</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Int.html#Int.int|type"><span>int</span></a><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
             </span><span class="entity"><span>Func</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>int_k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>int_j0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nat_R</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>abs_card</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>max_int_for_card</span></span><span> </span><span class="entity"><span>int_k</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nat_k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nat_j0</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the_single</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>atom_schema_of_rep</span></span><span> </span><span class="entity"><span>nat_R</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>overlap</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Int.min</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nat_k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>abs_card</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>nat_j0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>int_j0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="entity"><span>kk_union</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_product</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.AtomSeq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>int_k</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>abs_card</span></span><span class="main"><span>,</span></span><span>
                                              </span><span class="entity"><span>int_j0</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>abs_card</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                                 </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Atom</span></span><span> </span><span class="entity"><span>nat_j0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                     </span><span class="main"><span>(</span></span><span class="entity"><span>kk_intersect</span></span><span> </span><span class="entity"><span>KK.Iden</span></span><span>
                          </span><span class="main"><span>(</span></span><span class="entity"><span>kk_product</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.AtomSeq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>overlap</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>int_j0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>KK.Univ</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>BAD</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Kodkod.to_r (IntToNat)"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"\"nat_j0 &lt;&gt; int_j0\""</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Cst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IntToNat</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.signed_bit|type"><span>signed_bit</span></a><span> </span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.word|type"><span>word</span></a><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>to_bit_word_unary_op</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>R</span></span><span>
            </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>KK.IntIf</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.LE</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>KK.Num</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>KK.Num</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Op1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Not</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>kk_not3</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_rep</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Op1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Finite</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Opt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>KK.None</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Op1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Converse</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b_T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>a_T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.dest_prodT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pseudo_domain_type</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b_R</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>a_R</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span class="entity"><span>Func</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Struct</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>R1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R2</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R2</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Func</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>card_of_rep</span></span><span> </span><span class="entity"><span>R1</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>REP</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Kodkod.to_r (Converse)"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>R</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                </span><span>apply2</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span>o</span><span> </span><span>pair</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>offset_of_type</span></span><span> </span><span class="entity"><span>ofs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b_T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>a_T</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>REP</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Kodkod.to_r (Converse)"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>R</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>body_R</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>body_rep</span></span><span> </span><span class="entity"><span>R</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>a_arity</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>arity_of_rep</span></span><span> </span><span class="entity"><span>a_R</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>b_arity</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>arity_of_rep</span></span><span> </span><span class="entity"><span>b_R</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ab_arity</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>a_arity</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>b_arity</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>body_arity</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>arity_of_rep</span></span><span> </span><span class="entity"><span>body_R</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="entity"><span>kk_project</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_rep</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Func</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Struct</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>a_R</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>b_R</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body_R</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span>
                     </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>KK.Num</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>index_seq</span></span><span> </span><span class="entity"><span>a_arity</span></span><span> </span><span class="entity"><span>b_arity</span></span><span> </span><span>@</span><span>
                                  </span><span class="entity"><span>index_seq</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="entity"><span>a_arity</span></span><span> </span><span>@</span><span>
                                  </span><span class="entity"><span>index_seq</span></span><span> </span><span class="entity"><span>ab_arity</span></span><span> </span><span class="entity"><span>body_arity</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>rel_expr_from_rel_expr</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Func</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Struct</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>b_R</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>a_R</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body_R</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Op1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Closure</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_opt_rep</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>type_of</span></span><span> </span><span class="entity"><span>u1</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>R'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rep_to_binary_rel_rep</span></span><span> </span><span class="entity"><span>ofs</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unopt_rep</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rep_of</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>R''</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>opt_rep</span></span><span> </span><span class="entity"><span>ofs</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="entity"><span>R'</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="entity"><span>single_rel_rel_let</span></span><span> </span><span class="entity"><span>kk</span></span><span>
                </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>true_r</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>kk_closure</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_join</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>true_atom</span></span><span class="main"><span>)</span></span><span>
                      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>full_r</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>full_rel_for_rep</span></span><span> </span><span class="entity"><span>R'</span></span><span>
                      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>false_r</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>kk_difference</span></span><span> </span><span class="entity"><span>full_r</span></span><span>
                                        </span><span class="main"><span>(</span></span><span class="entity"><span>kk_closure</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_difference</span></span><span> </span><span class="entity"><span>full_r</span></span><span>
                                                        </span><span class="main"><span>(</span></span><span class="entity"><span>kk_join</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>false_atom</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                      </span><span class="entity"><span>rel_expr_from_rel_expr</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>R''</span></span><span>
                          </span><span class="main"><span>(</span></span><span class="entity"><span>kk_union</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_product</span></span><span> </span><span class="entity"><span>true_r</span></span><span> </span><span class="entity"><span>true_atom</span></span><span class="main"><span>)</span></span><span>
                                    </span><span class="main"><span>(</span></span><span class="entity"><span>kk_product</span></span><span> </span><span class="entity"><span>false_r</span></span><span> </span><span class="entity"><span>false_atom</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_rep</span></span><span> </span><span class="entity"><span>R''</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>R'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rep_to_binary_rel_rep</span></span><span> </span><span class="entity"><span>ofs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>type_of</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rep_of</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="entity"><span>rel_expr_from_rel_expr</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>R'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_closure</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_rep</span></span><span> </span><span class="entity"><span>R'</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Op1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SingletonSet</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Func</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Opt</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Cst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Unrep</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>kk_product</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>full_rel_for_rep</span></span><span> </span><span class="entity"><span>R1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>false_atom</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Op1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SingletonSet</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
           </span><span class="entity"><span>Func</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Formula</span></span><span> </span><span class="entity"><span>Neut</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>to_rep</span></span><span> </span><span class="entity"><span>R1</span></span><span> </span><span class="entity"><span>u1</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Func</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Opt</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
           </span><span class="entity"><span>single_rel_rel_let</span></span><span> </span><span class="entity"><span>kk</span></span><span>
               </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>kk_rel_if</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_no</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>empty_rel_for_rep</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span>
                            </span><span class="main"><span>(</span></span><span class="entity"><span>rel_expr_to_func</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>R1</span></span><span> </span><span class="entity"><span>bool_atom_R</span></span><span>
                                              </span><span class="main"><span>(</span></span><span class="entity"><span>Func</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Formula</span></span><span> </span><span class="entity"><span>Neut</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
               </span><span class="main"><span>(</span></span><span class="entity"><span>to_opt</span></span><span> </span><span class="entity"><span>R1</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>NUT</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Kodkod.to_r (SingletonSet)"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>u</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Op1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SafeThe</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_opt_rep</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="entity"><span>kk_join</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_rep</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Func</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unopt_rep</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Opt</span></span><span> </span><span class="entity"><span>bool_atom_R</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>true_atom</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="entity"><span>to_rep</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Func</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Formula</span></span><span> </span><span class="entity"><span>Neut</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>u1</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Op1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>First</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>to_nth_pair_sel</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>u1</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Op1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Second</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>to_nth_pair_sel</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>u1</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Op1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Cast</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>rep_of</span></span><span> </span><span class="entity"><span>u1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span class="entity"><span>Formula</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>unopt_rep</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
               </span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>atom_from_formula</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>j0</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_f</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span>
             </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SAME</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SAME</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
         </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>SAME</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>rel_expr_from_rel_expr</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rep_of</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_r</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Op2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>All</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Opt</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>to_r</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Op1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Not</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span>
                   </span><span class="entity"><span>Op2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Exist</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Op1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Not</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rep_of</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Op2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Exist</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Opt</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rs1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>untuple</span></span><span> </span><span class="entity"><span>to_decl</span></span><span> </span><span class="entity"><span>u1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_opt_rep</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rep_of</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="entity"><span>kk_rel_if</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_exist</span></span><span> </span><span class="entity"><span>rs1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_f</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>true_atom</span></span><span> </span><span class="entity"><span>KK.None</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>to_r</span></span><span> </span><span class="entity"><span>u2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span class="entity"><span>kk_union</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_rel_if</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_exist</span></span><span> </span><span class="entity"><span>rs1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_rel_eq</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="entity"><span>true_atom</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                                  </span><span class="entity"><span>true_atom</span></span><span> </span><span class="entity"><span>KK.None</span></span><span class="main"><span>)</span></span><span>
                       </span><span class="main"><span>(</span></span><span class="entity"><span>kk_rel_if</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_all</span></span><span> </span><span class="entity"><span>rs1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_rel_eq</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="entity"><span>false_atom</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                                  </span><span class="entity"><span>false_atom</span></span><span> </span><span class="entity"><span>KK.None</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Op2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Or</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_opt_rep</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rep_of</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>kk_rel_if</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_f</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>true_atom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_r</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>kk_rel_if</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_f</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>true_atom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_r</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Op2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>And</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_opt_rep</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rep_of</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>kk_rel_if</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_f</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_r</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>false_atom</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>kk_rel_if</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_f</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_r</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>false_atom</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Op2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Less</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>type_of</span></span><span> </span><span class="entity"><span>u1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
           </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Nat.html#Nat.nat|type"><span>nat</span></a><span>›</span></span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_Cst</span></span><span> </span><span class="entity"><span>Unrep</span></span><span> </span><span class="entity"><span>u1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>to_compare_with_unrep</span></span><span> </span><span class="entity"><span>u2</span></span><span> </span><span class="entity"><span>false_atom</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_Cst</span></span><span> </span><span class="entity"><span>Unrep</span></span><span> </span><span class="entity"><span>u2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>to_compare_with_unrep</span></span><span> </span><span class="entity"><span>u1</span></span><span> </span><span class="entity"><span>true_atom</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>kk_nat_less</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_integer</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_integer</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Int.html#Int.int|type"><span>int</span></a><span>›</span></span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>kk_int_less</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_integer</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_integer</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
             </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>R1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Opt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>card_of_rep</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rep_of</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                                 </span><span class="entity"><span>offset_of_type</span></span><span> </span><span class="entity"><span>ofs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>type_of</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
             </span><span class="entity"><span>double_rel_rel_let</span></span><span> </span><span class="entity"><span>kk</span></span><span>
                 </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                     </span><span class="entity"><span>kk_rel_if</span></span><span>
                         </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="entity"><span>kk_and</span></span><span> </span><span class="main"><span>(</span></span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_opt_rep</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rep_of</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_some</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span>
                              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>u1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>KK.True</span></span><span class="main"><span>)</span></span><span>
                         </span><span class="main"><span>(</span></span><span class="entity"><span>atom_from_formula</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>bool_j0</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.LT</span></span><span> </span><span class="main"><span>(</span></span><span>apply2</span><span>
                             </span><span class="main"><span>(</span></span><span class="entity"><span>int_expr_from_atom</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>type_of</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                         </span><span class="entity"><span>KK.None</span></span><span class="main"><span>)</span></span><span>
                 </span><span class="main"><span>(</span></span><span class="entity"><span>to_rep</span></span><span> </span><span class="entity"><span>R1</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_rep</span></span><span> </span><span class="entity"><span>R1</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Op2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Triad</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Opt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>f1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>to_f</span></span><span> </span><span class="entity"><span>u1</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>f2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>to_f</span></span><span> </span><span class="entity"><span>u2</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>f1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="entity"><span>atom_from_formula</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>j0</span></span><span> </span><span class="entity"><span>f1</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span class="entity"><span>kk_union</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_rel_if</span></span><span> </span><span class="entity"><span>f1</span></span><span> </span><span class="entity"><span>true_atom</span></span><span> </span><span class="entity"><span>KK.None</span></span><span class="main"><span>)</span></span><span>
                     </span><span class="main"><span>(</span></span><span class="entity"><span>kk_rel_if</span></span><span> </span><span class="entity"><span>f2</span></span><span> </span><span class="entity"><span>KK.None</span></span><span> </span><span class="entity"><span>false_atom</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Op2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Composition</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a_T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>b_T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.dest_prodT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pseudo_domain_type</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>type_of</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c_T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.dest_prodT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pseudo_domain_type</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>type_of</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ab_k</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>card_of_domain_from_rep</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rep_of</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bc_k</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>card_of_domain_from_rep</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rep_of</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ac_k</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>card_of_domain_from_rep</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="entity"><span>R</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>a_k</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>exact_root</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ac_k</span></span><span> </span><span>*</span><span> </span><span class="entity"><span>ab_k</span></span><span> </span><span>div</span><span> </span><span class="entity"><span>bc_k</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>b_k</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>exact_root</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ab_k</span></span><span> </span><span>*</span><span> </span><span class="entity"><span>bc_k</span></span><span> </span><span>div</span><span> </span><span class="entity"><span>ac_k</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>c_k</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>exact_root</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bc_k</span></span><span> </span><span>*</span><span> </span><span class="entity"><span>ac_k</span></span><span> </span><span>div</span><span> </span><span class="entity"><span>ab_k</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>a_R</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a_k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>offset_of_type</span></span><span> </span><span class="entity"><span>ofs</span></span><span> </span><span class="entity"><span>a_T</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>b_R</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b_k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>offset_of_type</span></span><span> </span><span class="entity"><span>ofs</span></span><span> </span><span class="entity"><span>b_T</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>c_R</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c_k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>offset_of_type</span></span><span> </span><span class="entity"><span>ofs</span></span><span> </span><span class="entity"><span>c_T</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>body_R</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>body_rep</span></span><span> </span><span class="entity"><span>R</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>body_R</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
             </span><span class="entity"><span>Formula</span></span><span> </span><span class="entity"><span>Neut</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
             </span><span class="entity"><span>kk_join</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_rep</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Func</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Struct</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>a_R</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>b_R</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Formula</span></span><span> </span><span class="entity"><span>Neut</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span>
                     </span><span class="main"><span>(</span></span><span class="entity"><span>to_rep</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Func</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Struct</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>b_R</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c_R</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Formula</span></span><span> </span><span class="entity"><span>Neut</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Opt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>2</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
               </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>must</span></span><span> </span><span class="entity"><span>R1</span></span><span> </span><span class="entity"><span>R2</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=</span></span><span>
                 </span><span class="entity"><span>kk_join</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_rep</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Func</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Struct</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>R1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R2</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body_R</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>true_atom</span></span><span>
               </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>may</span></span><span> </span><span class="entity"><span>R1</span></span><span> </span><span class="entity"><span>R2</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=</span></span><span>
                 </span><span class="entity"><span>kk_difference</span></span><span>
                     </span><span class="main"><span>(</span></span><span class="entity"><span>full_rel_for_rep</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Struct</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>R1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                     </span><span class="main"><span>(</span></span><span class="entity"><span>kk_join</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_rep</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Func</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Struct</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>R1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R2</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body_R</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>
                              </span><span class="entity"><span>false_atom</span></span><span class="main"><span>)</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
               </span><span class="entity"><span>kk_union</span></span><span>
                   </span><span class="main"><span>(</span></span><span class="entity"><span>kk_product</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_join</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>must</span></span><span> </span><span class="entity"><span>a_R</span></span><span> </span><span class="entity"><span>b_R</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>must</span></span><span> </span><span class="entity"><span>b_R</span></span><span> </span><span class="entity"><span>c_R</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                               </span><span class="entity"><span>true_atom</span></span><span class="main"><span>)</span></span><span>
                   </span><span class="main"><span>(</span></span><span class="entity"><span>kk_product</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_difference</span></span><span>
                                   </span><span class="main"><span>(</span></span><span class="entity"><span>full_rel_for_rep</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Struct</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>a_R</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c_R</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                                   </span><span class="main"><span>(</span></span><span class="entity"><span>kk_join</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>may</span></span><span> </span><span class="entity"><span>a_R</span></span><span> </span><span class="entity"><span>b_R</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>may</span></span><span> </span><span class="entity"><span>b_R</span></span><span> </span><span class="entity"><span>c_R</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                               </span><span class="entity"><span>false_atom</span></span><span class="main"><span>)</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>NUT</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Kodkod.to_r (Composition)"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>u</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>rel_expr_from_rel_expr</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Func</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Struct</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>a_R</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c_R</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>body_R</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Op2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Apply</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Nat.html#Nat.nat|type"><span>nat</span></a><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span>
             </span><span class="entity"><span>Op2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Apply</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Cst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Subtract</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_Cst</span></span><span> </span><span class="entity"><span>Unrep</span></span><span> </span><span class="entity"><span>u2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_opt_rep</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rep_of</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="entity"><span>KK.Atom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>offset_of_type</span></span><span> </span><span class="entity"><span>ofs</span></span><span> </span><span class="entity"><span>nat_T</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span>fold</span><span> </span><span class="entity"><span>kk_join</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>to_integer</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>u1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Rel</span></span><span> </span><span class="entity"><span>nat_subtract_rel</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Op2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Apply</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>to_apply</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>u1</span></span><span> </span><span class="entity"><span>u2</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Op2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Lambda</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Opt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>to_guard</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>u1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Atom</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Op2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Lambda</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Func</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Formula</span></span><span> </span><span class="entity"><span>Neut</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>kk_comprehension</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>untuple</span></span><span> </span><span class="entity"><span>to_decl</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_f</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Op2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Lambda</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Func</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dom_decls</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>untuple</span></span><span> </span><span class="entity"><span>to_decl</span></span><span> </span><span class="entity"><span>u1</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ran_schema</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>atom_schema_of_rep</span></span><span> </span><span class="entity"><span>R2</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ran_decls</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>decls_for_atom_schema</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="entity"><span>ran_schema</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ran_vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unary_var_seq</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>ran_decls</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="entity"><span>kk_comprehension</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dom_decls</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>ran_decls</span></span><span class="main"><span>)</span></span><span>
                           </span><span class="main"><span>(</span></span><span class="entity"><span>kk_subset</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fold1</span></span><span> </span><span class="entity"><span>kk_product</span></span><span> </span><span class="entity"><span>ran_vars</span></span><span class="main"><span>)</span></span><span>
                                      </span><span class="main"><span>(</span></span><span class="entity"><span>to_rep</span></span><span> </span><span class="entity"><span>R2</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Op3</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Let</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u3</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>kk_rel_let</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>to_expr_assign</span></span><span> </span><span class="entity"><span>u1</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_rep</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>u3</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Op3</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>If</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u3</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_opt_rep</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rep_of</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="entity"><span>triple_rel_rel_let</span></span><span> </span><span class="entity"><span>kk</span></span><span>
              </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>r3</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty_r</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>empty_rel_for_rep</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                    </span><span class="entity"><span>fold1</span></span><span> </span><span class="entity"><span>kk_union</span></span><span>
                          </span><span class="main"><span>[</span></span><span class="entity"><span>kk_rel_if</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_rel_eq</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>true_atom</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="entity"><span>empty_r</span></span><span class="main"><span>,</span></span><span>
                           </span><span class="entity"><span>kk_rel_if</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_rel_eq</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>false_atom</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>r3</span></span><span> </span><span class="entity"><span>empty_r</span></span><span class="main"><span>,</span></span><span>
                           </span><span class="entity"><span>kk_rel_if</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_rel_eq</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="entity"><span>r3</span></span><span class="main"><span>)</span></span><span>
                                </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>inline_rel_expr</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>r3</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>empty_r</span></span><span class="main"><span>]</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>to_r</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_rep</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_rep</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>u3</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="entity"><span>kk_rel_if</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_f</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_rep</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_rep</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>u3</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Tuple</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>us</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>unopt_rep</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
           </span><span class="entity"><span>Struct</span></span><span> </span><span class="entity"><span>Rs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>to_product</span></span><span> </span><span class="entity"><span>Rs</span></span><span> </span><span class="entity"><span>us</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Vect</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>to_product</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>us</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
           </span><span class="entity"><span>kk_rel_if</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_some</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fold1</span></span><span> </span><span class="entity"><span>kk_product</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>to_r</span></span><span> </span><span class="entity"><span>us</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                     </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Atom</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>KK.None</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>NUT</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Kodkod.to_r (Tuple)"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>u</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Construct</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>u'</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>to_r</span></span><span> </span><span class="entity"><span>u'</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Construct</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>discr_u</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>sel_us</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arg_us</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>set_rs</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>sel_u</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>arg_u</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                     </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                       </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_Func</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rep_of</span></span><span> </span><span class="entity"><span>sel_u</span></span><span class="main"><span>)</span></span><span>
                       </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sel_r</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>to_r</span></span><span> </span><span class="entity"><span>sel_u</span></span><span>
                       </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>arg_r</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>to_opt</span></span><span> </span><span class="entity"><span>R2</span></span><span> </span><span class="entity"><span>arg_u</span></span><span>
                     </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                       </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_one_rep</span></span><span> </span><span class="entity"><span>R2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                         </span><span class="entity"><span>kk_n_fold_join</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>R2</span></span><span> </span><span class="entity"><span>R1</span></span><span> </span><span class="entity"><span>arg_r</span></span><span>
                              </span><span class="main"><span>(</span></span><span class="entity"><span>kk_project</span></span><span> </span><span class="entity"><span>sel_r</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>flip_nums</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arity_of_rep</span></span><span> </span><span class="entity"><span>R2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                       </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                         </span><span class="entity"><span>kk_comprehension</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>KK.DeclOne</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>to_r</span></span><span> </span><span class="entity"><span>discr_u</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
                             </span><span class="main"><span>(</span></span><span class="entity"><span>kk_rel_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_join</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Var</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sel_r</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>arg_r</span></span><span class="main"><span>)</span></span><span>
                         </span><span>|&gt;</span><span> </span><span class="entity"><span>is_opt_rep</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rep_of</span></span><span> </span><span class="entity"><span>arg_u</span></span><span class="main"><span>)</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>to_guard</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>arg_u</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>R1</span></span><span>
                     </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sel_us</span></span><span> </span><span class="entity"><span>arg_us</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>fold1</span></span><span> </span><span class="entity"><span>kk_intersect</span></span><span> </span><span class="entity"><span>set_rs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>BoundRel</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>KK.Var</span></span><span> </span><span class="entity"><span>x</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>FreeRel</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>KK.Rel</span></span><span> </span><span class="entity"><span>x</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>RelReg</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>KK.RelReg</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arity_of_rep</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>NUT</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Kodkod.to_r"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>u</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>to_decl</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>BoundRel</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>KK.DeclOne</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>KK.AtomSeq</span></span><span> </span><span class="main"><span>(</span></span><span>the_single</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>atom_schema_of_rep</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>to_decl</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>NUT</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Kodkod.to_decl"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>u</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>to_expr_assign</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>FormulaReg</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>KK.AssignFormulaReg</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>to_f</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>to_expr_assign</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>RelReg</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>KK.AssignRelReg</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>arity_of_rep</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>to_r</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>to_expr_assign</span></span><span> </span><span class="entity"><span>u1</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>NUT</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Kodkod.to_expr_assign"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>u1</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>to_atom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>rep_of</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="entity"><span>Formula</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>atom_from_formula</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>j0</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_f</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>atom_from_rel_expr</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_r</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>to_struct</span></span><span> </span><span class="entity"><span>Rs</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>struct_from_rel_expr</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>Rs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rep_of</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_r</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>to_vect</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>vect_from_rel_expr</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rep_of</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_r</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>to_func</span></span><span> </span><span class="entity"><span>R1</span></span><span> </span><span class="entity"><span>R2</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rel_expr_to_func</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>R1</span></span><span> </span><span class="entity"><span>R2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rep_of</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_r</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>to_opt</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>old_R</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rep_of</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_opt_rep</span></span><span> </span><span class="entity"><span>old_R</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="entity"><span>rel_expr_from_rel_expr</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Opt</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>old_R</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_r</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="entity"><span>to_rep</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>u</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>to_rep</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>to_atom</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="entity"><span>u</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>to_rep</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Struct</span></span><span> </span><span class="entity"><span>Rs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>to_struct</span></span><span> </span><span class="entity"><span>Rs</span></span><span> </span><span class="entity"><span>u</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>to_rep</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Vect</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>to_vect</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>u</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>to_rep</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Func</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>to_func</span></span><span> </span><span class="entity"><span>R1</span></span><span> </span><span class="entity"><span>R2</span></span><span> </span><span class="entity"><span>u</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>to_rep</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Opt</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>to_opt</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>u</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>to_rep</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>REP</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Kodkod.to_rep"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>R</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>to_integer</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>to_opt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>one_rep</span></span><span> </span><span class="entity"><span>ofs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>type_of</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rep_of</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>u</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>to_guard</span></span><span> </span><span class="entity"><span>guard_us</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>unpacked_rs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unpack_joins</span></span><span> </span><span class="entity"><span>r</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>plain_guard_rs</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>map</span><span> </span><span class="entity"><span>to_r</span></span><span> </span><span class="main"><span>(</span></span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_Opt</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>rep_of</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>guard_us</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>unpacked_rs</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>func_guard_us</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>is_Func</span></span><span> </span><span>andf</span><span> </span><span class="entity"><span>is_opt_rep</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>rep_of</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>guard_us</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>func_guard_rs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>to_r</span></span><span> </span><span class="entity"><span>func_guard_us</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>guard_fs</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>map</span><span> </span><span class="entity"><span>kk_no</span></span><span> </span><span class="entity"><span>plain_guard_rs</span></span><span> </span><span>@</span><span>
          </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_not</span></span><span> </span><span>oo</span><span> </span><span class="entity"><span>kk_n_ary_function</span></span><span> </span><span class="entity"><span>kk</span></span><span class="main"><span>)</span></span><span>
               </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unopt_rep</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>rep_of</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>func_guard_us</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>func_guard_rs</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>guard_fs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>r</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>kk_rel_if</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fold1</span></span><span> </span><span class="entity"><span>kk_or</span></span><span> </span><span class="entity"><span>guard_fs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>empty_rel_for_rep</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>r</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>to_project</span></span><span> </span><span class="entity"><span>new_R</span></span><span> </span><span class="entity"><span>old_R</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>j0</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>rel_expr_from_rel_expr</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>new_R</span></span><span> </span><span class="entity"><span>old_R</span></span><span>
                             </span><span class="main"><span>(</span></span><span class="entity"><span>kk_project_seq</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>j0</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arity_of_rep</span></span><span> </span><span class="entity"><span>old_R</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>to_product</span></span><span> </span><span class="entity"><span>Rs</span></span><span> </span><span class="entity"><span>us</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fold1</span></span><span> </span><span class="entity"><span>kk_product</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>uncurry</span><span> </span><span class="entity"><span>to_opt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Rs</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>us</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>to_nth_pair_sel</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>res_R</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="entity"><span>Tuple</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>us</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>to_rep</span></span><span> </span><span class="entity"><span>res_R</span></span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>us</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
               </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rep_of</span></span><span> </span><span class="entity"><span>u</span></span><span>
               </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a_T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>b_T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.dest_prodT</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>type_of</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>
               </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Rs</span></span><span> </span><span class="main"><span>=</span></span><span>
                 </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>unopt_rep</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                   </span><span class="entity"><span>Struct</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Rs</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Rs</span></span><span>
                 </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                   </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                     </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>res_card</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>card_of_rep</span></span><span> </span><span class="entity"><span>res_R</span></span><span>
                     </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>other_card</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>card_of_rep</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span>div</span><span> </span><span class="entity"><span>res_card</span></span><span>
                     </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a_card</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>b_card</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>res_card</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>other_card</span></span><span class="main"><span>)</span></span><span>
                                            </span><span>|&gt;</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>?</span><span> </span><span>swap</span><span>
                   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                     </span><span class="main"><span>[</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a_card</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>offset_of_type</span></span><span> </span><span class="entity"><span>ofs</span></span><span> </span><span class="entity"><span>a_T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                      </span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b_card</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>offset_of_type</span></span><span> </span><span class="entity"><span>ofs</span></span><span> </span><span class="entity"><span>b_T</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
                   </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
               </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nth_R</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>nth</span><span> </span><span class="entity"><span>Rs</span></span><span> </span><span class="entity"><span>n</span></span><span>
               </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>j0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>arity_of_rep</span></span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>Rs</span></span><span class="main"><span>)</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>to_project</span></span><span> </span><span class="entity"><span>res_R</span></span><span> </span><span class="entity"><span>nth_R</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_rep</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Opt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Struct</span></span><span> </span><span class="entity"><span>Rs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>j0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>to_set_bool_op</span></span><span> </span><span class="entity"><span>connective</span></span><span> </span><span class="entity"><span>set_oper</span></span><span> </span><span class="entity"><span>u1</span></span><span> </span><span class="entity"><span>u2</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>min_R</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>min_rep</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rep_of</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rep_of</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>to_rep</span></span><span> </span><span class="entity"><span>min_R</span></span><span> </span><span class="entity"><span>u1</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>to_rep</span></span><span> </span><span class="entity"><span>min_R</span></span><span> </span><span class="entity"><span>u2</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>min_R</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span class="entity"><span>Vect</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>kk_vect_set_bool_op</span></span><span> </span><span class="entity"><span>connective</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>r2</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Func</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>body_rep</span></span><span> </span><span class="entity"><span>R'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
             </span><span class="entity"><span>Formula</span></span><span> </span><span class="entity"><span>Neut</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>set_oper</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>r2</span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>set_oper</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_join</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>true_atom</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_join</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="entity"><span>true_atom</span></span><span class="main"><span>)</span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>REP</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Kodkod.to_set_bool_op"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>min_R</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>REP</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Kodkod.to_set_bool_op"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>min_R</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>to_bit_word_unary_op</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>oper</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>strip_type</span><span> </span><span class="entity"><span>T</span></span><span> </span><span>||&gt;</span><span> </span><span>single</span><span> </span><span>|&gt;</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>@</span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>int_arg</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>int_expr_from_atom</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Var</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>kk_comprehension</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>decls_for_atom_schema</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>atom_schema_of_rep</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>KK.FormulaLet</span></span><span>
                 </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>KK.AssignIntReg</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>int_arg</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span> </span><span>upto</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                  </span><span class="entity"><span>KK.IntEq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.IntReg</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>oper</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.IntReg</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>to_bit_word_binary_op</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>opt_guard</span></span><span> </span><span class="entity"><span>opt_oper</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>strip_type</span><span> </span><span class="entity"><span>T</span></span><span> </span><span>||&gt;</span><span> </span><span>single</span><span> </span><span>|&gt;</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>@</span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>int_arg</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>int_expr_from_atom</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Var</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>kk_comprehension</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>decls_for_atom_schema</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>atom_schema_of_rep</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>KK.FormulaLet</span></span><span>
                 </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>KK.AssignIntReg</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>int_arg</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span> </span><span>upto</span><span> </span><span class="inner_numeral"><span>2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                  </span><span class="entity"><span>fold1</span></span><span> </span><span class="entity"><span>kk_and</span></span><span>
                        </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>opt_guard</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                            </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
                          </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>guard</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                            </span><span class="main"><span>[</span></span><span class="entity"><span>guard</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.IntReg</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.IntReg</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.IntReg</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span>
                         </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>opt_oper</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                            </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
                          </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>oper</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                            </span><span class="main"><span>[</span></span><span class="entity"><span>KK.IntEq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.IntReg</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span class="main"><span>,</span></span><span>
                                       </span><span class="entity"><span>oper</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.IntReg</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.IntReg</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>to_apply</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Formula</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>REP</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Kodkod.to_apply"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>R</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>to_apply</span></span><span> </span><span class="entity"><span>res_R</span></span><span> </span><span class="entity"><span>func_u</span></span><span> </span><span class="entity"><span>arg_u</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>unopt_rep</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rep_of</span></span><span> </span><span class="entity"><span>func_u</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="entity"><span>to_guard</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>arg_u</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>res_R</span></span><span>
                   </span><span class="main"><span>(</span></span><span class="entity"><span>rel_expr_from_rel_expr</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>res_R</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_r</span></span><span> </span><span class="entity"><span>func_u</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dom_card</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>card_of_rep</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rep_of</span></span><span> </span><span class="entity"><span>arg_u</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ran_R</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>exact_root</span></span><span> </span><span class="entity"><span>dom_card</span></span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span>
                    </span><span class="entity"><span>offset_of_type</span></span><span> </span><span class="entity"><span>ofs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pseudo_range_type</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>type_of</span></span><span> </span><span class="entity"><span>func_u</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="entity"><span>to_apply_vect</span></span><span> </span><span class="entity"><span>dom_card</span></span><span> </span><span class="entity"><span>ran_R</span></span><span> </span><span class="entity"><span>res_R</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_vect</span></span><span> </span><span class="entity"><span>dom_card</span></span><span> </span><span class="entity"><span>ran_R</span></span><span> </span><span class="entity"><span>func_u</span></span><span class="main"><span>)</span></span><span>
                          </span><span class="entity"><span>arg_u</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Vect</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="entity"><span>to_guard</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>arg_u</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>res_R</span></span><span>
                   </span><span class="main"><span>(</span></span><span class="entity"><span>rel_expr_from_rel_expr</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>res_R</span></span><span> </span><span class="entity"><span>R'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_r</span></span><span> </span><span class="entity"><span>func_u</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Vect</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>to_apply_vect</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>R'</span></span><span> </span><span class="entity"><span>res_R</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_r</span></span><span> </span><span class="entity"><span>func_u</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>arg_u</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Func</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Formula</span></span><span> </span><span class="entity"><span>Neut</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="entity"><span>to_guard</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>arg_u</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>res_R</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rel_expr_from_formula</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>res_R</span></span><span>
                                      </span><span class="main"><span>(</span></span><span class="entity"><span>kk_subset</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_opt</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>arg_u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_r</span></span><span> </span><span class="entity"><span>func_u</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Func</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="entity"><span>rel_expr_from_rel_expr</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>res_R</span></span><span> </span><span class="entity"><span>R2</span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>kk_n_fold_join</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>R1</span></span><span> </span><span class="entity"><span>R2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_opt</span></span><span> </span><span class="entity"><span>R1</span></span><span> </span><span class="entity"><span>arg_u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_r</span></span><span> </span><span class="entity"><span>func_u</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>body_rep</span></span><span> </span><span class="entity"><span>R2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Formula</span></span><span> </span><span class="entity"><span>Neut</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>to_guard</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>arg_u</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>res_R</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>NUT</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Kodkod.to_apply"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>func_u</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>to_apply_vect</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>R'</span></span><span> </span><span class="entity"><span>res_R</span></span><span> </span><span class="entity"><span>func_r</span></span><span> </span><span class="entity"><span>arg_u</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>arg_R</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>one_rep</span></span><span> </span><span class="entity"><span>ofs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>type_of</span></span><span> </span><span class="entity"><span>arg_u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unopt_rep</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rep_of</span></span><span> </span><span class="entity"><span>arg_u</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vect_r</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>vect_from_rel_expr</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>res_R</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Vect</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>func_r</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vect_rs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unpack_vect_in_chunks</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arity_of_rep</span></span><span> </span><span class="entity"><span>res_R</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>vect_r</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>kk_case_switch</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>arg_R</span></span><span> </span><span class="entity"><span>res_R</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_opt</span></span><span> </span><span class="entity"><span>arg_R</span></span><span> </span><span class="entity"><span>arg_u</span></span><span class="main"><span>)</span></span><span>
                       </span><span class="main"><span>(</span></span><span class="entity"><span>all_singletons_for_rep</span></span><span> </span><span class="entity"><span>arg_R</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vect_rs</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>to_could_be_unrep</span></span><span> </span><span class="entity"><span>neg</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>neg</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>is_opt_rep</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rep_of</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>kk_no</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_r</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>KK.False</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>to_compare_with_unrep</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_opt_rep</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rep_of</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="entity"><span>kk_rel_if</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_some</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_r</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>empty_rel_for_rep</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rep_of</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="entity"><span>r</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>to_f_with_polarity</span></span><span> </span><span class="entity"><span>Pos</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>declarative_axiom_for_plain_rel</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>FreeRel</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Func</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nick</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>kk_n_ary_function</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>nick</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../List.html#List.list.set|const"><span>List.set</span></a><span>›</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>unopt_rep</span></span><span class="main"><span>)</span></span><span>
                      </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Rel</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>declarative_axiom_for_plain_rel</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>kk_lone</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_one</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>kodkod_constrs</span></span><span class="main"><span>)</span></span><span>
                                    </span><span class="main"><span>(</span></span><span class="entity"><span>FreeRel</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_one_rep</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>kk_one</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Rel</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_lone_rep</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>card_of_rep</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>kk_lone</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Rel</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>KK.True</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>declarative_axiom_for_plain_rel</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>NUT</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Kodkod.declarative_axiom_for_plain_rel"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>u</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>const_triple</span></span><span> </span><span class="entity"><span>rel_table</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>the_name</span></span><span> </span><span class="entity"><span>rel_table</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ConstName</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Any</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="entity"><span>FreeRel</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Rel</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Kodkod.const_triple"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span>Const</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>discr_rel_expr</span></span><span> </span><span class="entity"><span>rel_table</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>const_triple</span></span><span> </span><span class="entity"><span>rel_table</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>discr_for_constr</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>nfa_transitions_for_sel</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="entity"><span>binarize</span></span><span>
                            </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>kk_project</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>kodkod_constrs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rel_table</span></span><span>
                            </span><span class="main"><span>(</span></span><span class="entity"><span>dtypes</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>data_type_spec</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>constr_x</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>binarized_and_boxed_nth_sel_for_constr</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="entity"><span>binarize</span></span><span> </span><span class="entity"><span>constr_x</span></span><span> </span><span class="entity"><span>n</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arity</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>const_triple</span></span><span> </span><span class="entity"><span>rel_table</span></span><span> </span><span class="entity"><span>x</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>type_schema</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>type_schema_of_rep</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>R</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                   </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span>not_equal</span><span> </span><span class="entity"><span>T</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>typ</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>dtypes</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>NONE</span><span>
                   </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_project</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>KK.Num</span></span><span> </span><span class="main"><span>[</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
               </span><span class="main"><span>(</span></span><span class="entity"><span>index_seq</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arity</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span>~~</span><span> </span><span>tl</span><span> </span><span class="entity"><span>type_schema</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>nfa_transitions_for_constr</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="entity"><span>binarize</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>rel_table</span></span><span> </span><span class="entity"><span>dtypes</span></span><span>
                               </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nfa_transitions_for_sel</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="entity"><span>binarize</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>rel_table</span></span><span> </span><span class="entity"><span>dtypes</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span>
       </span><span class="main"><span>(</span></span><span class="entity"><span>index_seq</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>num_sels_for_constr_type</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>nfa_entry_for_data_type</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span>co</span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>data_type_spec</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>nfa_entry_for_data_type</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>{</span></span><span>deep</span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>nfa_entry_for_data_type</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="entity"><span>binarize</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>rel_table</span></span><span> </span><span class="entity"><span>dtypes</span></span><span>
                            </span><span class="main"><span>{</span></span><span class="entity"><span>typ</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>constrs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>typ</span></span><span class="main"><span>,</span></span><span> </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nfa_transitions_for_constr</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="entity"><span>binarize</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>rel_table</span></span><span>
                                                </span><span class="entity"><span>dtypes</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>const</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>constrs</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty_rel</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>KK.Product</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.None</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>KK.None</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>direct_path_rel_exprs</span></span><span> </span><span class="entity"><span>nfa</span></span><span> </span><span class="entity"><span>start_T</span></span><span> </span><span class="entity"><span>final_T</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>nfa</span></span><span> </span><span class="entity"><span>final_T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="entity"><span>trans</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>filter</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>start_T</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>trans</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>any_path_rel_expr</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>kk_union</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>kodkod_constrs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>nfa</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>start_T</span></span><span>
                      </span><span class="entity"><span>final_T</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>fold</span><span> </span><span class="entity"><span>kk_union</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>direct_path_rel_exprs</span></span><span> </span><span class="entity"><span>nfa</span></span><span> </span><span class="entity"><span>start_T</span></span><span> </span><span class="entity"><span>final_T</span></span><span class="main"><span>)</span></span><span>
         </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>start_T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>final_T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>KK.Iden</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>empty_rel</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>any_path_rel_expr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>kk_union</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>nfa</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>start_T</span></span><span> </span><span class="entity"><span>final_T</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>kk_union</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>any_path_rel_expr</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>nfa</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>start_T</span></span><span> </span><span class="entity"><span>final_T</span></span><span class="main"><span>)</span></span><span>
             </span><span class="main"><span>(</span></span><span class="entity"><span>knot_path_rel_expr</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>nfa</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>start_T</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>final_T</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>knot_path_rel_expr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>kk_join</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_reflexive_closure</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>nfa</span></span><span> </span><span class="entity"><span>Ts</span></span><span>
                       </span><span class="entity"><span>start_T</span></span><span> </span><span class="entity"><span>knot_T</span></span><span> </span><span class="entity"><span>final_T</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>kk_join</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_join</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>any_path_rel_expr</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>nfa</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>knot_T</span></span><span> </span><span class="entity"><span>final_T</span></span><span class="main"><span>)</span></span><span>
                   </span><span class="main"><span>(</span></span><span class="entity"><span>kk_reflexive_closure</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>loop_path_rel_expr</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>nfa</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>knot_T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>any_path_rel_expr</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>nfa</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>start_T</span></span><span> </span><span class="entity"><span>knot_T</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>loop_path_rel_expr</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>kk_union</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>kodkod_constrs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>nfa</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>start_T</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>fold</span><span> </span><span class="entity"><span>kk_union</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>direct_path_rel_exprs</span></span><span> </span><span class="entity"><span>nfa</span></span><span> </span><span class="entity"><span>start_T</span></span><span> </span><span class="entity"><span>start_T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>empty_rel</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>loop_path_rel_expr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>kk_union</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_closure</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>nfa</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span>
                       </span><span class="entity"><span>start_T</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>start_T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="entity"><span>kk_closure</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>loop_path_rel_expr</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>nfa</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>start_T</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="entity"><span>kk_union</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>loop_path_rel_expr</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>nfa</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>start_T</span></span><span class="main"><span>)</span></span><span>
               </span><span class="main"><span>(</span></span><span class="entity"><span>knot_path_rel_expr</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>nfa</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>start_T</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>start_T</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_nfa_to_graph</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_nfa_to_graph</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>nfa</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_nfa_to_graph</span></span><span> </span><span class="entity"><span>nfa</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_nfa_to_graph</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>transitions</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>nfa</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>add_nfa_to_graph</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>transitions</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>nfa</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>Typ_Graph.add_edge</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span>
    </span><span>Typ_Graph.default_node</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>Typ_Graph.default_node</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>strongly_connected_sub_nfas</span></span><span> </span><span class="entity"><span>nfa</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>add_nfa_to_graph</span></span><span> </span><span class="entity"><span>nfa</span></span><span> </span><span>Typ_Graph.empty</span><span>
  </span><span>|&gt;</span><span> </span><span>Typ_Graph.strong_conn</span><span>
  </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>keys</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>keys</span></span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>nfa</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(* Cycle breaking in the bounds takes care of singly recursive data types, hence
   the first equation. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>acyclicity_axioms_for_data_type</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>acyclicity_axioms_for_data_type</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>kk_no</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_intersect</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>nfa</span></span><span>
                                    </span><span class="entity"><span>start_T</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>[</span></span><span class="entity"><span>kk_no</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_intersect</span></span><span>
                </span><span class="main"><span>(</span></span><span class="entity"><span>loop_path_rel_expr</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>nfa</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pull</span></span><span> </span><span class="entity"><span>start_T</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>nfa</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>start_T</span></span><span class="main"><span>)</span></span><span>
                </span><span class="entity"><span>KK.Iden</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>acyclicity_axioms_for_data_types</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>nfa</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>acyclicity_axioms_for_data_type</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>nfa</span></span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>nfa</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>atom_equation_for_nut</span></span><span> </span><span class="entity"><span>ofs</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dummy_u</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>RelReg</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>type_of</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rep_of</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Op2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>DefEq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bool_T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Formula</span></span><span> </span><span class="entity"><span>Pos</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>dummy_u</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>
         </span><span>|&gt;</span><span> </span><span class="entity"><span>kodkod_formula_from_nut</span></span><span> </span><span class="entity"><span>ofs</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="entity"><span>KK.RelEq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.RelReg</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.RelEq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Atom</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>BAD</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Kodkod.atom_equation_for_nut"</span></span><span class="main"><span>,</span></span><span>
                      </span><span class="inner_quoted"><span>"malformed Kodkod formula"</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>needed_values_for_data_type</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>needed_values_for_data_type</span></span><span> </span><span class="entity"><span>need_us</span></span><span> </span><span class="entity"><span>ofs</span></span><span>
                                </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>typ</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>card</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>constrs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>data_type_spec</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Construct</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>FreeRel</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>us</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>fold</span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="entity"><span>us</span></span><span>
          </span><span>#&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
               </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>accum</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>loose</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fixed</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                 </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>typ</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                   </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fixed</span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                     </span><span>SOME</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>accum</span></span><span>
                   </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
                     </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                       </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>constr_s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>constr_name_for_sel_like</span></span><span> </span><span class="entity"><span>s</span></span><span>
                       </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>delta</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>epsilon</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span>
                         </span><span class="entity"><span>constrs</span></span><span>
                         </span><span>|&gt;</span><span> </span><span>List.find</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>const</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>fst</span><span> </span><span class="entity"><span>const</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>constr_s</span></span><span class="main"><span>)</span></span><span>
                         </span><span>|&gt;</span><span> </span><span>the</span><span>
                       </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>j0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>offset_of_type</span></span><span> </span><span class="entity"><span>ofs</span></span><span> </span><span class="entity"><span>T</span></span><span>
                     </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                       </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>find_first</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span>&gt;=</span><span> </span><span class="entity"><span>delta</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
                                        </span><span class="entity"><span>j</span></span><span> </span><span>&lt;</span><span> </span><span class="entity"><span>delta</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>epsilon</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>loose</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                         </span><span>SOME</span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                         </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>remove</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="entity"><span>loose</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>fixed</span></span><span class="main"><span>)</span></span><span>
                       </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
                     </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
                 </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                   </span><span class="entity"><span>accum</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>index_seq</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="entity"><span>card</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="entity"><span>need_us</span></span><span> </span><span>|&gt;</span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>needed_value_axioms_for_data_type</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>KK.False</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>needed_value_axioms_for_data_type</span></span><span> </span><span class="entity"><span>ofs</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>dtypes</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>fixed</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_data_type_nat_like</span></span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>data_type_spec</span></span><span> </span><span class="entity"><span>dtypes</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>fixed</span></span><span> </span><span>|&gt;</span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>atom_equation_for_nut</span></span><span> </span><span class="entity"><span>ofs</span></span><span> </span><span class="entity"><span>kk</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>all_ge</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>kk_join</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_reflexive_closure</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>kodkod_constrs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>z</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>kk_join</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_reflexive_closure</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Rel</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>suc_rel_for_atom_seq</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gt</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>kk_subset</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_join</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_closure</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>kodkod_constrs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>z</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>kk_subset</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_join</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_closure</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Rel</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>suc_rel_for_atom_seq</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>constr_quadruple</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span>const</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>delta</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>epsilon</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>constr_spec</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>delta</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>epsilon</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>num_binder_types</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>constr_ord</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>prod_ord</span><span> </span><span>int_ord</span><span> </span><span class="main"><span>(</span></span><span>prod_ord</span><span> </span><span>int_ord</span><span> </span><span class="main"><span>(</span></span><span>prod_ord</span><span> </span><span>int_ord</span><span> </span><span>string_ord</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span>o</span><span> </span><span>apply2</span><span> </span><span class="entity"><span>constr_quadruple</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>data_type_ord</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span>card</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>card1</span></span><span class="main"><span>,</span></span><span> </span><span>self_rec</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>self_rec1</span></span><span class="main"><span>,</span></span><span> </span><span>constrs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>constr1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span>
                    </span><span class="main"><span>{</span></span><span>card</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>card2</span></span><span class="main"><span>,</span></span><span> </span><span>self_rec</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>self_rec2</span></span><span class="main"><span>,</span></span><span> </span><span>constrs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>constr2</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span>
                   </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>data_type_spec</span></span><span> * </span><span class="entity"><span>data_type_spec</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>prod_ord</span><span> </span><span>int_ord</span><span> </span><span class="main"><span>(</span></span><span>prod_ord</span><span> </span><span>bool_ord</span><span> </span><span>int_ord</span><span class="main"><span>)</span></span><span>
           </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>card1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>self_rec1</span></span><span class="main"><span>,</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>constr1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>card2</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>self_rec2</span></span><span class="main"><span>,</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>constr2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(* We must absolutely tabulate "suc" for all data types whose selector bounds
   break cycles; otherwise, we may end up with two incompatible symmetry
   breaking orders, leading to spurious models. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>should_tabulate_suc_for_type</span></span><span> </span><span class="entity"><span>dtypes</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>is_asymmetric_non_data_type</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>data_type_spec</span></span><span> </span><span class="entity"><span>dtypes</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>self_rec</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>self_rec</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lex_order_rel_expr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>kk_implies</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_and</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_subset</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_join</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span>
                       </span><span class="entity"><span>dtypes</span></span><span> </span><span class="entity"><span>sel_quadruples</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>sel_quadruples</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>KK.True</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Func</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Atom</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>sel_quadruples'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>z</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>should_tabulate_suc_for_type</span></span><span> </span><span class="entity"><span>dtypes</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>sel_quadruples'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="entity"><span>gt</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>z</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_join</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Var</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_join</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Var</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="entity"><span>kk_and</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_subset</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_join</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Var</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span>
                          </span><span class="main"><span>(</span></span><span class="entity"><span>all_ge</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>z</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_join</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Var</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
               </span><span class="main"><span>(</span></span><span class="entity"><span>kk_implies</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_subset</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_join</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Var</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span>
                                      </span><span class="main"><span>(</span></span><span class="entity"><span>kk_join</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Var</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                           </span><span class="main"><span>(</span></span><span class="entity"><span>lex_order_rel_expr</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>dtypes</span></span><span> </span><span class="entity"><span>sel_quadruples'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="comment1"><span>(* Skip constructors components that aren't atoms, since we cannot compare
       these easily. *)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>sel_quadruples'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>lex_order_rel_expr</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>dtypes</span></span><span> </span><span class="entity"><span>sel_quadruples'</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_nil_like_constr_type</span></span><span> </span><span class="entity"><span>dtypes</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>data_type_spec</span></span><span> </span><span class="entity"><span>dtypes</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>constrs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_self_recursive_constr_type</span></span><span> </span><span>o</span><span> </span><span>snd</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>const</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>constrs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
       </span><span class="main"><span>[</span></span><span class="main"><span>{</span></span><span>const</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>T'</span></span><span>
     </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>sym_break_axioms_for_constr_pair</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="entity"><span>binarize</span></span><span>
       </span><span class="main"><span>(</span></span><span class="entity"><span>kk</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>kk_all</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_or</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_implies</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_and</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_some</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_intersect</span></span><span class="main"><span>,</span></span><span>
               </span><span class="entity"><span>kk_join</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rel_table</span></span><span> </span><span class="entity"><span>nfas</span></span><span> </span><span class="entity"><span>dtypes</span></span><span>
       </span><span class="main"><span>(</span></span><span class="entity"><span>constr_ord</span></span><span class="main"><span>,</span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span>const</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>const1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>delta</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>delta1</span></span><span class="main"><span>,</span></span><span> </span><span>epsilon</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>epsilon1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span>
         </span><span class="main"><span>{</span></span><span>const</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>const2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>delta</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>delta2</span></span><span class="main"><span>,</span></span><span> </span><span>epsilon</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>epsilon2</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>constr_spec</span></span><span> * </span><span class="entity"><span>constr_spec</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dataT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>body_type</span><span> </span><span class="entity"><span>T1</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nfa</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nfas</span></span><span> </span><span>|&gt;</span><span> </span><span>find_first</span><span> </span><span class="main"><span>(</span></span><span>exists</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>dataT</span></span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>these</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rec_Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nfa</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span>fst</span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rec_and_nonrec_sels</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>index_seq</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>num_sels_for_constr_type</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>binarized_and_boxed_nth_sel_for_constr</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="entity"><span>binarize</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>List.partition</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rec_Ts</span></span><span> </span><span>o</span><span> </span><span>range_type</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sel_xs1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rec_and_nonrec_sels</span></span><span> </span><span class="entity"><span>const1</span></span><span> </span><span>|&gt;</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>@</span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>constr_ord</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>EQUAL</span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>sel_xs1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>z</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>const_triple</span></span><span> </span><span class="entity"><span>rel_table</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>discr_for_constr</span></span><span> </span><span class="entity"><span>const1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
             </span><span class="entity"><span>Func</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Formula</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>REP</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Kodkod.sym_break_axioms_for_constr_pair"</span></span><span class="main"><span>,</span></span><span>
                             </span><span class="main"><span>[</span></span><span class="entity"><span>R</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>should_tabulate_suc_for_type</span></span><span> </span><span class="entity"><span>dtypes</span></span><span> </span><span class="entity"><span>dataT</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rec_sel_xs2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nonrec_sel_xs2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rec_and_nonrec_sels</span></span><span> </span><span class="entity"><span>const2</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sel_xs2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rec_sel_xs2</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>nonrec_sel_xs2</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>sel_quadruples2</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>sel_xs2</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>`</span><span class="main"><span>(</span></span><span class="entity"><span>const_triple</span></span><span> </span><span class="entity"><span>rel_table</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="comment1"><span>(* If the two constructors are the same, we drop the first selector
           because that one is always checked by the lexicographic order.
           We sometimes also filter out direct subterms, because those are
           already handled by the acyclicity breaking in the bound
           declarations. *)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>filter_out_sels</span></span><span> </span><span class="entity"><span>no_direct</span></span><span> </span><span class="entity"><span>sel_xs</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>filter_out</span><span>
                     </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                         </span><span class="main"><span>(</span></span><span class="entity"><span>constr_ord</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>EQUAL</span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>hd</span><span> </span><span class="entity"><span>sel_xs</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
                         </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dataT</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
                          </span><span class="main"><span>(</span></span><span class="entity"><span>no_direct</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sel_xs</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>subterms_r</span></span><span> </span><span class="entity"><span>no_direct</span></span><span> </span><span class="entity"><span>sel_xs</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>loop_path_rel_expr</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>filter_out_sels</span></span><span> </span><span class="entity"><span>no_direct</span></span><span> </span><span class="entity"><span>sel_xs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>nfa</span></span><span class="main"><span>)</span></span><span>
                           </span><span class="main"><span>(</span></span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>dataT</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>nfa</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>dataT</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>kk_join</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Var</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>[</span></span><span class="entity"><span>kk_all</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>KK.DeclOne</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>discr_rel_expr</span></span><span> </span><span class="entity"><span>rel_table</span></span><span> </span><span class="entity"><span>const1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                 </span><span class="entity"><span>KK.DeclOne</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>discr_rel_expr</span></span><span> </span><span class="entity"><span>rel_table</span></span><span> </span><span class="entity"><span>const2</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
             </span><span class="main"><span>(</span></span><span class="entity"><span>kk_implies</span></span><span>
                 </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>delta2</span></span><span> </span><span>&gt;=</span><span> </span><span class="entity"><span>epsilon1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>KK.True</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>delta1</span></span><span> </span><span>&gt;=</span><span> </span><span class="entity"><span>epsilon2</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>KK.False</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>gt</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>z</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Var</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Var</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                 </span><span class="main"><span>(</span></span><span class="entity"><span>kk_or</span></span><span>
                      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_nil_like_constr_type</span></span><span> </span><span class="entity"><span>dtypes</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                         </span><span class="entity"><span>KK.True</span></span><span>
                       </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                         </span><span class="entity"><span>kk_some</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_intersect</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>subterms_r</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>sel_xs2</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
                                               </span><span class="main"><span>(</span></span><span class="entity"><span>all_ge</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>z</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Var</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>constr_ord</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                         </span><span>EQUAL</span><span> </span><span class="main"><span>=&gt;</span></span><span>
                         </span><span class="entity"><span>kk_and</span></span><span>
                             </span><span class="main"><span>(</span></span><span class="entity"><span>lex_order_rel_expr</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>dtypes</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sel_quadruples2</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                             </span><span class="main"><span>(</span></span><span class="entity"><span>kk_all</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>KK.DeclOne</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                                                  </span><span class="entity"><span>subterms_r</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>sel_xs1</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
                                     </span><span class="main"><span>(</span></span><span class="entity"><span>gt</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>z</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Var</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Var</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                       </span><span class="main"><span>|</span></span><span> </span><span>LESS</span><span> </span><span class="main"><span>=&gt;</span></span><span>
                         </span><span class="entity"><span>kk_all</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>KK.DeclOne</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                                 </span><span class="entity"><span>subterms_r</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>sel_xs1</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
                                </span><span class="main"><span>(</span></span><span class="entity"><span>gt</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>z</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Var</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Var</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                       </span><span class="main"><span>|</span></span><span> </span><span>GREATER</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>KK.False</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>sym_break_axioms_for_data_type</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="entity"><span>binarize</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>rel_table</span></span><span> </span><span class="entity"><span>nfas</span></span><span> </span><span class="entity"><span>dtypes</span></span><span>
                                   </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>constrs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>data_type_spec</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>constrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>sort</span><span> </span><span class="entity"><span>constr_ord</span></span><span> </span><span class="entity"><span>constrs</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>constr_pairs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>all_distinct_unordered_pairs_of</span></span><span> </span><span class="entity"><span>constrs</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span>EQUAL</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>constrs</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>constrs</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span>
    </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span>LESS</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>constr_pairs</span></span><span> </span><span>@</span><span>
    </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span>GREATER</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>swap</span><span> </span><span class="entity"><span>constr_pairs</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sym_break_axioms_for_constr_pair</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="entity"><span>binarize</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>rel_table</span></span><span>
                                              </span><span class="entity"><span>nfas</span></span><span> </span><span class="entity"><span>dtypes</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_data_type_in_needed_value</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Construct</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>us</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_data_type_in_needed_value</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>us</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_data_type_in_needed_value</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>min_sym_break_card</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>7</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>sym_break_axioms_for_data_types</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="entity"><span>binarize</span></span><span> </span><span class="entity"><span>need_us</span></span><span>
      </span><span class="entity"><span>datatype_sym_break</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>rel_table</span></span><span> </span><span class="entity"><span>nfas</span></span><span> </span><span class="entity"><span>dtypes</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>datatype_sym_break</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="entity"><span>dtypes</span></span><span> </span><span>|&gt;</span><span> </span><span>filter</span><span> </span><span class="entity"><span>is_data_type_acyclic</span></span><span>
           </span><span>|&gt;</span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>constrs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span>
                       </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>card</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>constrs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                         </span><span class="entity"><span>card</span></span><span> </span><span>&gt;=</span><span> </span><span class="entity"><span>min_sym_break_card</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
                         </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span>forall</span><span> </span><span class="main"><span>(</span></span><span>not</span><span> </span><span>o</span><span> </span><span class="entity"><span>is_higher_order_type</span></span><span class="main"><span>)</span></span><span>
                                 </span><span>o</span><span> </span><span>binder_types</span><span> </span><span>o</span><span> </span><span>snd</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>const</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>constrs</span></span><span class="main"><span>)</span></span><span>
           </span><span>|&gt;</span><span> </span><span>filter_out</span><span>
                  </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>typ</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                      </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_data_type_in_needed_value</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>need_us</span></span><span class="main"><span>)</span></span><span>
           </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>dtypes'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span class="entity"><span>dtypes'</span></span><span> </span><span>|&gt;</span><span> </span><span>length</span><span> </span><span class="entity"><span>dtypes'</span></span><span> </span><span>&gt;</span><span> </span><span class="entity"><span>datatype_sym_break</span></span><span>
                             </span><span>?</span><span> </span><span class="main"><span>(</span></span><span>sort</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>data_type_ord</span></span><span> </span><span>o</span><span> </span><span>swap</span><span class="main"><span>)</span></span><span>
                                </span><span>#&gt;</span><span> </span><span>take</span><span> </span><span class="entity"><span>datatype_sym_break</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
           </span><span>|&gt;</span><span> </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sym_break_axioms_for_data_type</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="entity"><span>binarize</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>rel_table</span></span><span>
                                                   </span><span class="entity"><span>nfas</span></span><span> </span><span class="entity"><span>dtypes</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>sel_axioms_for_sel</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="entity"><span>binarize</span></span><span> </span><span class="entity"><span>j0</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>kk</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>kk_all</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_formula_if</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_subset</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_no</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_join</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span>
        </span><span class="entity"><span>need_vals</span></span><span> </span><span class="entity"><span>rel_table</span></span><span> </span><span class="entity"><span>dom_r</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dtype</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>typ</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>const</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>delta</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>epsilon</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>exclusive</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>constr_spec</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>binarized_and_boxed_nth_sel_for_constr</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="entity"><span>binarize</span></span><span> </span><span class="entity"><span>const</span></span><span> </span><span class="entity"><span>n</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>const_triple</span></span><span> </span><span class="entity"><span>rel_table</span></span><span> </span><span class="entity"><span>x</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rel_x</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="entity"><span>KK.Rel</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>BAD</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Kodkod.sel_axioms_for_sel"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"non-Rel"</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>R2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_Func</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span>|&gt;</span><span> </span><span>snd</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>z</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>epsilon</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>delta</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>delta</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>exclusive</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="main"><span>[</span></span><span class="entity"><span>kk_n_ary_function</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Func</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>all_values_are_needed</span></span><span> </span><span class="entity"><span>need_vals</span></span><span> </span><span class="entity"><span>dtype</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="entity"><span>typ</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>needed_values</span></span><span> </span><span class="entity"><span>need_vals</span></span><span>
          </span><span>|&gt;</span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_sel_of_constr</span></span><span> </span><span class="entity"><span>rel_x</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>kk_n_ary_function</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>R2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_join</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Atom</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>r'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>kk_join</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Var</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="main"><span>[</span></span><span class="entity"><span>kk_all</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>KK.DeclOne</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>KK.AtomSeq</span></span><span> </span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
                </span><span class="main"><span>(</span></span><span class="entity"><span>kk_formula_if</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_subset</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Var</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>dom_r</span></span><span class="main"><span>)</span></span><span>
                               </span><span class="main"><span>(</span></span><span class="entity"><span>kk_n_ary_function</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>R2</span></span><span> </span><span class="entity"><span>r'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_no</span></span><span> </span><span class="entity"><span>r'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>sel_axioms_for_constr</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="entity"><span>binarize</span></span><span> </span><span class="entity"><span>bits</span></span><span> </span><span class="entity"><span>j0</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>need_vals</span></span><span> </span><span class="entity"><span>rel_table</span></span><span>
        </span><span class="entity"><span>dtype</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>constr</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>const</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>delta</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>epsilon</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>explicit_max</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>honors_explicit_max</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>explicit_max</span></span><span> </span><span>&lt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>epsilon</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>delta</span></span><span> </span><span>&lt;=</span><span> </span><span class="entity"><span>explicit_max</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>explicit_max</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="main"><span>[</span></span><span class="entity"><span>formula_for_bool</span></span><span> </span><span class="entity"><span>honors_explicit_max</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dom_r</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>discr_rel_expr</span></span><span> </span><span class="entity"><span>rel_table</span></span><span> </span><span class="entity"><span>const</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>max_axiom</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>honors_explicit_max</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="entity"><span>KK.True</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>bits</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
               </span><span class="entity"><span>is_twos_complement_representable</span></span><span> </span><span class="entity"><span>bits</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>epsilon</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>delta</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="entity"><span>KK.LE</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Cardinality</span></span><span> </span><span class="entity"><span>dom_r</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>KK.Num</span></span><span> </span><span class="entity"><span>explicit_max</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>TOO_SMALL</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Kodkod.sel_axioms_for_constr"</span></span><span class="main"><span>,</span></span><span>
                             </span><span class="inner_quoted"><span>"\"bits\" value "</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>bits</span></span><span> </span><span>^</span><span>
                             </span><span class="inner_quoted"><span>" too small for \"max\""</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="entity"><span>max_axiom</span></span><span> </span><span>::</span><span>
        </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sel_axioms_for_sel</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="entity"><span>binarize</span></span><span> </span><span class="entity"><span>j0</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>need_vals</span></span><span> </span><span class="entity"><span>rel_table</span></span><span>
                                 </span><span class="entity"><span>dom_r</span></span><span> </span><span class="entity"><span>dtype</span></span><span> </span><span class="entity"><span>constr</span></span><span class="main"><span>)</span></span><span>
             </span><span class="main"><span>(</span></span><span class="entity"><span>index_seq</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>num_sels_for_constr_type</span></span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span class="entity"><span>const</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>sel_axioms_for_data_type</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="entity"><span>binarize</span></span><span> </span><span class="entity"><span>bits</span></span><span> </span><span class="entity"><span>j0</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>rel_table</span></span><span> </span><span class="entity"><span>need_vals</span></span><span>
                             </span><span class="main"><span>(</span></span><span class="entity"><span>dtype</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>constrs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sel_axioms_for_constr</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="entity"><span>binarize</span></span><span> </span><span class="entity"><span>bits</span></span><span> </span><span class="entity"><span>j0</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>rel_table</span></span><span> </span><span class="entity"><span>need_vals</span></span><span>
                              </span><span class="entity"><span>dtype</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>constrs</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>uniqueness_axioms_for_constr</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="entity"><span>binarize</span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>kk_all</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_implies</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_and</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_rel_eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_lone</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_join</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span>
         </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>kodkod_constrs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>need_vals</span></span><span> </span><span class="entity"><span>rel_table</span></span><span> </span><span class="entity"><span>dtype</span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>const</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>constr_spec</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>conjunct_for_sel</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>kk_rel_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_join</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Var</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk_join</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Var</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>num_sels</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>num_sels_for_constr_type</span></span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span class="entity"><span>const</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>triples</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>const_triple</span></span><span> </span><span class="entity"><span>rel_table</span></span><span>
           </span><span>o</span><span> </span><span class="entity"><span>binarized_and_boxed_nth_sel_for_constr</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="entity"><span>binarize</span></span><span> </span><span class="entity"><span>const</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>~1</span></span><span> </span><span>upto</span><span> </span><span class="entity"><span>num_sels</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>set_r</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>triples</span></span><span> </span><span>|&gt;</span><span> </span><span>hd</span><span> </span><span>|&gt;</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>num_sels</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="main"><span>[</span></span><span class="entity"><span>kk_lone</span></span><span> </span><span class="entity"><span>set_r</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>all_values_are_needed</span></span><span> </span><span class="entity"><span>need_vals</span></span><span> </span><span class="entity"><span>dtype</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="main"><span>[</span></span><span class="entity"><span>kk_all</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.DeclOne</span></span><span> </span><span>o</span><span> </span><span>rpair</span><span> </span><span class="entity"><span>set_r</span></span><span> </span><span>o</span><span> </span><span>pair</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>kk_implies</span></span><span>
                   </span><span class="main"><span>(</span></span><span class="entity"><span>fold1</span></span><span> </span><span class="entity"><span>kk_and</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>conjunct_for_sel</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>tl</span><span> </span><span class="entity"><span>triples</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                   </span><span class="main"><span>(</span></span><span class="entity"><span>kk_rel_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Var</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.Var</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>uniqueness_axioms_for_data_type</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="entity"><span>binarize</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>need_vals</span></span><span> </span><span class="entity"><span>rel_table</span></span><span>
                                    </span><span class="main"><span>(</span></span><span class="entity"><span>dtype</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>constrs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>uniqueness_axioms_for_constr</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="entity"><span>binarize</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>need_vals</span></span><span> </span><span class="entity"><span>rel_table</span></span><span>
                                     </span><span class="entity"><span>dtype</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>constrs</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>effective_constr_max</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>delta</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>epsilon</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>constr_spec</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>epsilon</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>delta</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>partition_axioms_for_data_type</span></span><span> </span><span class="entity"><span>j0</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kk</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>kk_rel_eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>kk_union</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span>
        </span><span class="entity"><span>need_vals</span></span><span> </span><span class="entity"><span>rel_table</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dtype</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>card</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>constrs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>forall</span><span> </span><span class="main"><span>#</span></span><span>exclusive</span><span> </span><span class="entity"><span>constrs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="main"><span>[</span></span><span>Integer.sum</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>effective_constr_max</span></span><span> </span><span class="entity"><span>constrs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>card</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>formula_for_bool</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>all_values_are_needed</span></span><span> </span><span class="entity"><span>need_vals</span></span><span> </span><span class="entity"><span>dtype</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>discr_rel_expr</span></span><span> </span><span class="entity"><span>rel_table</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>const</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>constrs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="main"><span>[</span></span><span class="entity"><span>kk_rel_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fold1</span></span><span> </span><span class="entity"><span>kk_union</span></span><span> </span><span class="entity"><span>rs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>KK.AtomSeq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>card</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
       </span><span class="entity"><span>kk_disjoint_sets</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>rs</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>other_axioms_for_data_type</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>{</span></span><span>deep</span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>other_axioms_for_data_type</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="entity"><span>binarize</span></span><span> </span><span class="entity"><span>need_vals</span></span><span> </span><span class="entity"><span>bits</span></span><span> </span><span class="entity"><span>ofs</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>rel_table</span></span><span>
                               </span><span class="main"><span>(</span></span><span class="entity"><span>dtype</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>typ</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>j0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>offset_of_type</span></span><span> </span><span class="entity"><span>ofs</span></span><span> </span><span class="entity"><span>typ</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>sel_axioms_for_data_type</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="entity"><span>binarize</span></span><span> </span><span class="entity"><span>bits</span></span><span> </span><span class="entity"><span>j0</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>need_vals</span></span><span> </span><span class="entity"><span>rel_table</span></span><span>
                               </span><span class="entity"><span>dtype</span></span><span> </span><span>@</span><span>
      </span><span class="entity"><span>uniqueness_axioms_for_data_type</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="entity"><span>binarize</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>need_vals</span></span><span> </span><span class="entity"><span>rel_table</span></span><span>
                                      </span><span class="entity"><span>dtype</span></span><span> </span><span>@</span><span>
      </span><span class="entity"><span>partition_axioms_for_data_type</span></span><span> </span><span class="entity"><span>j0</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>need_vals</span></span><span> </span><span class="entity"><span>rel_table</span></span><span> </span><span class="entity"><span>dtype</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>declarative_axioms_for_data_types</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="entity"><span>binarize</span></span><span> </span><span class="entity"><span>need_us</span></span><span> </span><span class="entity"><span>need_vals</span></span><span>
        </span><span class="entity"><span>datatype_sym_break</span></span><span> </span><span class="entity"><span>bits</span></span><span> </span><span class="entity"><span>ofs</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>rel_table</span></span><span> </span><span class="entity"><span>dtypes</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nfas</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>dtypes</span></span><span> </span><span>|&gt;</span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nfa_entry_for_data_type</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="entity"><span>binarize</span></span><span> </span><span class="entity"><span>kk</span></span><span>
                                                    </span><span class="entity"><span>rel_table</span></span><span> </span><span class="entity"><span>dtypes</span></span><span class="main"><span>)</span></span><span>
             </span><span>|&gt;</span><span> </span><span class="entity"><span>strongly_connected_sub_nfas</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>acyclicity_axioms_for_data_types</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>nfas</span></span><span> </span><span>@</span><span>
    </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>needed_value_axioms_for_data_type</span></span><span> </span><span class="entity"><span>ofs</span></span><span> </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>dtypes</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>need_vals</span></span><span> </span><span>@</span><span>
    </span><span class="entity"><span>sym_break_axioms_for_data_types</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="entity"><span>binarize</span></span><span> </span><span class="entity"><span>need_us</span></span><span> </span><span class="entity"><span>datatype_sym_break</span></span><span>
                                    </span><span class="entity"><span>kk</span></span><span> </span><span class="entity"><span>rel_table</span></span><span> </span><span class="entity"><span>nfas</span></span><span> </span><span class="entity"><span>dtypes</span></span><span> </span><span>@</span><span>
    </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>other_axioms_for_data_type</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="entity"><span>binarize</span></span><span> </span><span class="entity"><span>need_vals</span></span><span> </span><span class="entity"><span>bits</span></span><span> </span><span class="entity"><span>ofs</span></span><span> </span><span class="entity"><span>kk</span></span><span>
                                     </span><span class="entity"><span>rel_table</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>dtypes</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
</span></pre>
</body>

</html>