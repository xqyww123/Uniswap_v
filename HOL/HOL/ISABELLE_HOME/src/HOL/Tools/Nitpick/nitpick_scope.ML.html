<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Tools/Nitpick/nitpick_scope.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Tools/Nitpick/nitpick_scope.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      HOL/Tools/Nitpick/nitpick_scope.ML
    Author:     Jasmin Blanchette, TU Muenchen
    Copyright   2008, 2009, 2010

Scope enumerator for Nitpick.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>NITPICK_SCOPE</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>hol_context</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Nitpick_HOL.hol_context</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>constr_spec</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>{</span></span><span>const</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> * </span><span>typ</span><span class="main"><span>,</span></span><span>
     </span><span>delta</span><span class="main"><span>:</span></span><span> </span><span>int</span><span class="main"><span>,</span></span><span>
     </span><span>epsilon</span><span class="main"><span>:</span></span><span> </span><span>int</span><span class="main"><span>,</span></span><span>
     </span><span>exclusive</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>,</span></span><span>
     </span><span>explicit_max</span><span class="main"><span>:</span></span><span> </span><span>int</span><span class="main"><span>,</span></span><span>
     </span><span>total</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>}</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>data_type_spec</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>{</span></span><span>typ</span><span class="main"><span>:</span></span><span> </span><span>typ</span><span class="main"><span>,</span></span><span>
     </span><span>card</span><span class="main"><span>:</span></span><span> </span><span>int</span><span class="main"><span>,</span></span><span>
     </span><span>co</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>,</span></span><span>
     </span><span>self_rec</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>,</span></span><span>
     </span><span>complete</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> * </span><span>bool</span><span class="main"><span>,</span></span><span>
     </span><span>concrete</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> * </span><span>bool</span><span class="main"><span>,</span></span><span>
     </span><span>deep</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>,</span></span><span>
     </span><span>constrs</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>constr_spec</span></span><span> </span><span>list</span><span class="main"><span>}</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>scope</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>{</span></span><span>hol_ctxt</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>hol_context</span></span><span class="main"><span>,</span></span><span>
     </span><span>binarize</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>,</span></span><span>
     </span><span>card_assigns</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>typ</span><span> * </span><span>int</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     </span><span>bits</span><span class="main"><span>:</span></span><span> </span><span>int</span><span class="main"><span>,</span></span><span>
     </span><span>bisim_depth</span><span class="main"><span>:</span></span><span> </span><span>int</span><span class="main"><span>,</span></span><span>
     </span><span>data_types</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>data_type_spec</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     </span><span>ofs</span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span>Typtab.table</span><span class="main"><span>}</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> is_asymmetric_non_data_type </span><span class="main"><span>:</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> data_type_spec </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>data_type_spec</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>data_type_spec</span></span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> constr_spec </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>data_type_spec</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> * </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>constr_spec</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> is_complete_type </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>data_type_spec</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> is_concrete_type </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>data_type_spec</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> is_exact_type </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>data_type_spec</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> offset_of_type </span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span>Typtab.table</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> spec_of_type </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>scope</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> * </span><span>int</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> pretties_for_scope </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>scope</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> multiline_string_for_scope </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>scope</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> scopes_equivalent </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>scope</span></span><span> * </span><span class="entity"><span>scope</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> scope_less_eq </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>scope</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>scope</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> is_self_recursive_constr_type </span><span class="main"><span>:</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> all_scopes </span><span class="main"><span>:</span></span><span>
    </span><span class="entity"><span>hol_context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>typ</span><span> </span><span>option</span><span> * </span><span>int</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span> </span><span>option</span><span> * </span><span>int</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span> </span><span>option</span><span> * </span><span>int</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span>typ</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> * </span><span class="entity"><span>scope</span></span><span> </span><span>list</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Nitpick_Scope</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>NITPICK_SCOPE</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Nitpick_Util</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Nitpick_HOL</span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>constr_spec</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>const</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> * </span><span>typ</span><span class="main"><span>,</span></span><span>
   </span><span>delta</span><span class="main"><span>:</span></span><span> </span><span>int</span><span class="main"><span>,</span></span><span>
   </span><span>epsilon</span><span class="main"><span>:</span></span><span> </span><span>int</span><span class="main"><span>,</span></span><span>
   </span><span>exclusive</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>,</span></span><span>
   </span><span>explicit_max</span><span class="main"><span>:</span></span><span> </span><span>int</span><span class="main"><span>,</span></span><span>
   </span><span>total</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>data_type_spec</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>typ</span><span class="main"><span>:</span></span><span> </span><span>typ</span><span class="main"><span>,</span></span><span>
   </span><span>card</span><span class="main"><span>:</span></span><span> </span><span>int</span><span class="main"><span>,</span></span><span>
   </span><span>co</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>,</span></span><span>
   </span><span>self_rec</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>,</span></span><span>
   </span><span>complete</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> * </span><span>bool</span><span class="main"><span>,</span></span><span>
   </span><span>concrete</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> * </span><span>bool</span><span class="main"><span>,</span></span><span>
   </span><span>deep</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>,</span></span><span>
   </span><span>constrs</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>constr_spec</span></span><span> </span><span>list</span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>scope</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>hol_ctxt</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>hol_context</span></span><span class="main"><span>,</span></span><span>
   </span><span>binarize</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>,</span></span><span>
   </span><span>card_assigns</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>typ</span><span> * </span><span>int</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   </span><span>bits</span><span class="main"><span>:</span></span><span> </span><span>int</span><span class="main"><span>,</span></span><span>
   </span><span>bisim_depth</span><span class="main"><span>:</span></span><span> </span><span>int</span><span class="main"><span>,</span></span><span>
   </span><span>data_types</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>data_type_spec</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   </span><span>ofs</span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span>Typtab.table</span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>row_kind</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Card</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> typ </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Max</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> string * typ

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>row</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>row_kind</span></span><span> * </span><span>int</span><span> </span><span>list</span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>block</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>row</span></span><span> </span><span>list</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>is_asymmetric_non_data_type</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>is_iterator_type</span></span><span> </span><span>orf</span><span> </span><span class="entity"><span>is_integer_type</span></span><span> </span><span>orf</span><span> </span><span class="entity"><span>is_bit_type</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>data_type_spec</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dtypes</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>data_type_spec</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>List.find</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>typ</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>dtypes</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>constr_spec</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Scope.constr_spec"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span>Const</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>constr_spec</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>constrs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>dtypes</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>data_type_spec</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>List.find</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span>body_type</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span>body_type</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>const</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                   </span><span class="entity"><span>constrs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>SOME</span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>c</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>constr_spec</span></span><span> </span><span class="entity"><span>dtypes</span></span><span> </span><span class="entity"><span>x</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_complete_type</span></span><span> </span><span class="entity"><span>dtypes</span></span><span> </span><span class="entity"><span>facto</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>is_concrete_type</span></span><span> </span><span class="entity"><span>dtypes</span></span><span> </span><span class="entity"><span>facto</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>is_complete_type</span></span><span> </span><span class="entity"><span>dtypes</span></span><span> </span><span class="entity"><span>facto</span></span><span> </span><span class="entity"><span>T2</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_complete_type</span></span><span> </span><span class="entity"><span>dtypes</span></span><span> </span><span class="entity"><span>facto</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.prod|type"><span>prod</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_complete_type</span></span><span> </span><span class="entity"><span>dtypes</span></span><span> </span><span class="entity"><span>facto</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ts</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_complete_type</span></span><span> </span><span class="entity"><span>dtypes</span></span><span> </span><span class="entity"><span>facto</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Set.html#Set.set|type"><span>set</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T'</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>is_concrete_type</span></span><span> </span><span class="entity"><span>dtypes</span></span><span> </span><span class="entity"><span>facto</span></span><span> </span><span class="entity"><span>T'</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_complete_type</span></span><span> </span><span class="entity"><span>dtypes</span></span><span> </span><span class="entity"><span>facto</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_integer_like_type</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_bit_type</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
    </span><span class="entity"><span>fun_from_pair</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>complete</span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>data_type_spec</span></span><span> </span><span class="entity"><span>dtypes</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>facto</span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Option.Option</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span>
</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>is_concrete_type</span></span><span> </span><span class="entity"><span>dtypes</span></span><span> </span><span class="entity"><span>facto</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>is_complete_type</span></span><span> </span><span class="entity"><span>dtypes</span></span><span> </span><span class="entity"><span>facto</span></span><span> </span><span class="entity"><span>T1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>is_concrete_type</span></span><span> </span><span class="entity"><span>dtypes</span></span><span> </span><span class="entity"><span>facto</span></span><span> </span><span class="entity"><span>T2</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_concrete_type</span></span><span> </span><span class="entity"><span>dtypes</span></span><span> </span><span class="entity"><span>facto</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Product_Type.html#Product_Type.prod|type"><span>prod</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_concrete_type</span></span><span> </span><span class="entity"><span>dtypes</span></span><span> </span><span class="entity"><span>facto</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Ts</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_concrete_type</span></span><span> </span><span class="entity"><span>dtypes</span></span><span> </span><span class="entity"><span>facto</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Set.html#Set.set|type"><span>set</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T'</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>is_complete_type</span></span><span> </span><span class="entity"><span>dtypes</span></span><span> </span><span class="entity"><span>facto</span></span><span> </span><span class="entity"><span>T'</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_concrete_type</span></span><span> </span><span class="entity"><span>dtypes</span></span><span> </span><span class="entity"><span>facto</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>fun_from_pair</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>concrete</span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>data_type_spec</span></span><span> </span><span class="entity"><span>dtypes</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>facto</span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Option.Option</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span>
</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>is_exact_type</span></span><span> </span><span class="entity"><span>dtypes</span></span><span> </span><span class="entity"><span>facto</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>is_complete_type</span></span><span> </span><span class="entity"><span>dtypes</span></span><span> </span><span class="entity"><span>facto</span></span><span> </span><span>andf</span><span> </span><span class="entity"><span>is_concrete_type</span></span><span> </span><span class="entity"><span>dtypes</span></span><span> </span><span class="entity"><span>facto</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>offset_of_type</span></span><span> </span><span class="entity"><span>ofs</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Typtab.lookup</span><span> </span><span class="entity"><span>ofs</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="entity"><span>j0</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>j0</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Typtab.lookup</span><span> </span><span class="entity"><span>ofs</span></span><span> </span><span>dummyT</span><span> </span><span>|&gt;</span><span> </span><span>the_default</span><span> </span><span class="inner_numeral"><span>0</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>spec_of_type</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>card_assigns</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ofs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>scope</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>card_of_type</span></span><span> </span><span class="entity"><span>card_assigns</span></span><span> </span><span class="entity"><span>T</span></span><span>
   </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>TYPE</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_HOL.card_of_type"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>offset_of_type</span></span><span> </span><span class="entity"><span>ofs</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>quintuple_for_scope</span></span><span> </span><span class="entity"><span>code_type</span></span><span> </span><span class="entity"><span>code_term</span></span><span> </span><span class="entity"><span>code_string</span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span>hol_ctxt</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>card_assigns</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bits</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bisim_depth</span></span><span class="main"><span>,</span></span><span>
         </span><span class="entity"><span>data_types</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>scope</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>boring_Ts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.unsigned_bit|type"><span>unsigned_bit</span></a><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.signed_bit|type"><span>signed_bit</span></a><span>›</span></span></span><span class="main"><span>,</span></span><span>
                     </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.bisim_iterator|type"><span>bisim_iterator</span></a><span>›</span></span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>iter_assigns</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>card_assigns</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>card_assigns</span></span><span> </span><span>|&gt;</span><span> </span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>boring_Ts</span></span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span>
                   </span><span>|&gt;</span><span> </span><span>List.partition</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_fp_iterator_type</span></span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>secondary_card_assigns</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>primary_card_assigns</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>card_assigns</span></span><span>
      </span><span>|&gt;</span><span> </span><span>List.partition</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>is_integer_type</span></span><span> </span><span>orf</span><span> </span><span class="entity"><span>is_data_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cards</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="main"><span>[</span></span><span class="entity"><span>code_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>code_string</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>" = "</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>maxes</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span>map_filter</span><span>
                </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>const</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>explicit_max</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>explicit_max</span></span><span> </span><span>&lt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                      </span><span>NONE</span><span>
                    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                      </span><span>SOME</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>code_term</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="entity"><span>const</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                            </span><span class="entity"><span>code_string</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>" = "</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>explicit_max</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                 </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>constrs</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>data_types</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>iters</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="main"><span>[</span></span><span class="entity"><span>code_term</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>const_for_iterator_type</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
               </span><span class="entity"><span>code_string</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>" = "</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>iter_assigns</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>miscs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>bits</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>code_string</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"bits = "</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>bits</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>bisim_depth</span></span><span> </span><span>&lt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span>not</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>co</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>data_types</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>code_string</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"bisim_depth = "</span></span><span> </span><span>^</span><span> </span><span>signed_string_of_int</span><span> </span><span class="entity"><span>bisim_depth</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>cards</span></span><span> </span><span class="entity"><span>primary_card_assigns</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cards</span></span><span> </span><span class="entity"><span>secondary_card_assigns</span></span><span class="main"><span>,</span></span><span>
     </span><span class="entity"><span>maxes</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>iters</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>miscs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pretties_for_scope</span></span><span> </span><span class="entity"><span>scope</span></span><span> </span><span class="entity"><span>verbose</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>standard_blocks</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Pretty.block</span><span> </span><span>o</span><span> </span><span>cons</span><span> </span><span class="main"><span>(</span></span><span>Pretty.str</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" "</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>primary_cards</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>secondary_cards</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>maxes</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>iters</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>miscs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>quintuple_for_scope</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>pretty_maybe_quote</span></span><span> </span><span class="main"><span>(</span></span><span>Thy_Header.get_keywords'</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>pretty_for_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>pretty_maybe_quote</span></span><span> </span><span class="main"><span>(</span></span><span>Thy_Header.get_keywords'</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
        </span><span>Pretty.str</span><span> </span><span class="entity"><span>scope</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>standard_blocks</span></span><span> </span><span class="inner_quoted"><span>"card"</span></span><span> </span><span class="entity"><span>primary_cards</span></span><span> </span><span>@</span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>verbose</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
       </span><span class="entity"><span>standard_blocks</span></span><span> </span><span class="inner_quoted"><span>"card"</span></span><span> </span><span class="entity"><span>secondary_cards</span></span><span> </span><span>@</span><span>
       </span><span class="entity"><span>standard_blocks</span></span><span> </span><span class="inner_quoted"><span>"max"</span></span><span> </span><span class="entity"><span>maxes</span></span><span> </span><span>@</span><span>
       </span><span class="entity"><span>standard_blocks</span></span><span> </span><span class="inner_quoted"><span>"iter"</span></span><span> </span><span class="entity"><span>iters</span></span><span> </span><span>@</span><span>
       </span><span class="entity"><span>miscs</span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
       </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>pretty_serial_commas</span></span><span> </span><span class="inner_quoted"><span>"and"</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>multiline_string_for_scope</span></span><span> </span><span class="entity"><span>scope</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>code_type</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Print_Mode.setmp</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span>o</span><span> </span><span>Syntax.string_of_typ</span><span> </span><span>o</span><span> </span><span>Config.put</span><span> </span><span>show_markup</span><span> </span><span>false</span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>code_term</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Print_Mode.setmp</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span>o</span><span> </span><span>Syntax.string_of_term</span><span> </span><span>o</span><span> </span><span>Config.put</span><span> </span><span>show_markup</span><span> </span><span>false</span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>primary_cards</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>secondary_cards</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>maxes</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>iters</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>miscs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>quintuple_for_scope</span></span><span> </span><span class="entity"><span>code_type</span></span><span> </span><span class="entity"><span>code_term</span></span><span> </span><span>I</span><span> </span><span class="entity"><span>scope</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cards</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>primary_cards</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>secondary_cards</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>cards</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"card: "</span></span><span> </span><span>^</span><span> </span><span>commas</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>implode</span><span> </span><span class="entity"><span>cards</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span>
         </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>maxes</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"max: "</span></span><span> </span><span>^</span><span> </span><span>commas</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>implode</span><span> </span><span class="entity"><span>maxes</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span>
         </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>iters</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"iter: "</span></span><span> </span><span>^</span><span> </span><span>commas</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>implode</span><span> </span><span class="entity"><span>iters</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span>
         </span><span class="entity"><span>miscs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"empty"</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>lines</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>cat_lines</span><span> </span><span class="entity"><span>lines</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>scopes_equivalent</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s1</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>scope</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s2</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>scope</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>#</span></span><span>data_types</span><span> </span><span class="entity"><span>s1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>data_types</span><span> </span><span class="entity"><span>s2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="main"><span>#</span></span><span>card_assigns</span><span> </span><span class="entity"><span>s1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>card_assigns</span><span> </span><span class="entity"><span>s2</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>scope_less_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s1</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>scope</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s2</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>scope</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>s1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s2</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>apply2</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>snd</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>card_assigns</span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>~~</span><span> </span><span>|&gt;</span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>&lt;=</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rank_of_row</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ks</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>ks</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rank_of_block</span></span><span> </span><span class="entity"><span>block</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span>Integer.max</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>rank_of_row</span></span><span> </span><span class="entity"><span>block</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>project_row</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>y</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>y</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="comment1"><span>(* desperate measure *)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>project_row</span></span><span> </span><span class="entity"><span>column</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>y</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ks</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>y</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span>nth</span><span> </span><span class="entity"><span>ks</span></span><span> </span><span class="main"><span>(</span></span><span>Int.min</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>column</span></span><span class="main"><span>,</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>ks</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>project_block</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>column</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>block</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>project_row</span></span><span> </span><span class="entity"><span>column</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>block</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lookup_ints_assign</span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="entity"><span>assigns</span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>triple_lookup</span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="entity"><span>assigns</span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="entity"><span>ks</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ks</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>ARG</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Scope.lookup_ints_assign"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lookup_type_ints_assign</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>assigns</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Integer.max</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lookup_ints_assign</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>type_match</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>assigns</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>ARG</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Scope.lookup_ints_assign"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
         </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TYPE</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Scope.lookup_type_ints_assign"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>T</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lookup_const_ints_assign</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>assigns</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>lookup_ints_assign</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>const_match</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>assigns</span></span><span> </span><span class="entity"><span>x</span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>ARG</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Scope.lookup_ints_assign"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
         </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Scope.lookup_const_ints_assign"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span>Const</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>row_for_constr</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>maxes_assigns</span></span><span> </span><span class="entity"><span>constr</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Max</span></span><span> </span><span class="entity"><span>constr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lookup_const_ints_assign</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>maxes_assigns</span></span><span> </span><span class="entity"><span>constr</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"lookup_const_ints_assign"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>max_bits</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>31</span></span><span> </span><span class="comment1"><span>(* Kodkod limit *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>block_for_type</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>thy</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>binarize</span></span><span> </span><span class="entity"><span>cards_assigns</span></span><span> </span><span class="entity"><span>maxes_assigns</span></span><span>
                   </span><span class="entity"><span>iters_assigns</span></span><span> </span><span class="entity"><span>bitss</span></span><span> </span><span class="entity"><span>bisim_depths</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.unsigned_bit|type"><span>unsigned_bit</span></a><span>›</span></span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>Card</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Integer.min</span><span> </span><span class="entity"><span>max_bits</span></span><span> </span><span>o</span><span> </span><span>Integer.max</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bitss</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.signed_bit|type"><span>signed_bit</span></a><span>›</span></span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>Card</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Integer.add</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>o</span><span> </span><span>Integer.min</span><span> </span><span class="entity"><span>max_bits</span></span><span> </span><span>o</span><span> </span><span>Integer.max</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bitss</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.unsigned_bit|type"><span>unsigned_bit</span></a><span> </span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.word|type"><span>word</span></a><span>›</span></span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>Card</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lookup_type_ints_assign</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>cards_assigns</span></span><span> </span><span class="entity"><span>nat_T</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.signed_bit|type"><span>signed_bit</span></a><span> </span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.word|type"><span>word</span></a><span>›</span></span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>Card</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lookup_type_ints_assign</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>cards_assigns</span></span><span> </span><span class="entity"><span>int_T</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.bisim_iterator|type"><span>bisim_iterator</span></a><span>›</span></span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>Card</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Integer.add</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>o</span><span> </span><span>Integer.max</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bisim_depths</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_fp_iterator_type</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>Card</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Integer.add</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>o</span><span> </span><span>Integer.max</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="main"><span>(</span></span><span class="entity"><span>lookup_const_ints_assign</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>iters_assigns</span></span><span>
                                              </span><span class="main"><span>(</span></span><span class="entity"><span>const_for_iterator_type</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>Card</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lookup_type_ints_assign</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>cards_assigns</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>binarized_and_boxed_data_type_constrs</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="entity"><span>binarize</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
         </span><span class="main"><span>[</span></span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
       </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>constrs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>row_for_constr</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>maxes_assigns</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>constrs</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>blocks_for_types</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="entity"><span>binarize</span></span><span> </span><span class="entity"><span>cards_assigns</span></span><span> </span><span class="entity"><span>maxes_assigns</span></span><span> </span><span class="entity"><span>iters_assigns</span></span><span>
                     </span><span class="entity"><span>bitss</span></span><span> </span><span class="entity"><span>bisim_depths</span></span><span> </span><span class="entity"><span>mono_Ts</span></span><span> </span><span class="entity"><span>nonmono_Ts</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>block_for</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>block_for_type</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="entity"><span>binarize</span></span><span> </span><span class="entity"><span>cards_assigns</span></span><span> </span><span class="entity"><span>maxes_assigns</span></span><span>
                                   </span><span class="entity"><span>iters_assigns</span></span><span> </span><span class="entity"><span>bitss</span></span><span> </span><span class="entity"><span>bisim_depths</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mono_block</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>maps</span><span> </span><span class="entity"><span>block_for</span></span><span> </span><span class="entity"><span>mono_Ts</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nonmono_blocks</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>block_for</span></span><span> </span><span class="entity"><span>nonmono_Ts</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>mono_block</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>nonmono_blocks</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sync_threshold</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>5</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>linearity</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>5</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>all_combinations_ordered_smartly</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cost</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cost</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>k</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>k</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cost</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ks</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span>&lt;</span><span> </span><span class="entity"><span>sync_threshold</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ks</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="entity"><span>k</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>sync_threshold</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="entity"><span>k</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ks</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>linearity</span></span><span class="main"><span>)</span></span><span> </span><span>*</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>linearity</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                  </span><span>|&gt;</span><span> </span><span>Integer.sum</span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>all_combinations</span></span><span> </span><span>#&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>`</span><span class="entity"><span>cost</span></span><span class="main"><span>)</span></span><span> </span><span>#&gt;</span><span> </span><span>sort</span><span> </span><span class="main"><span>(</span></span><span>int_ord</span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span>#&gt;</span><span> </span><span>map</span><span> </span><span>snd</span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_self_recursive_constr_type</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span>exists_subtype</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>body_type</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>binder_types</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>constr_max</span></span><span> </span><span class="entity"><span>maxes</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the_default</span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="main"><span>(</span></span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>maxes</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>scope_desc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>typ</span><span> * </span><span>int</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span> * </span><span>int</span><span class="main"><span>)</span></span><span> </span><span>list</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_surely_inconsistent_card_assign</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="entity"><span>binarize</span></span><span>
                                       </span><span class="main"><span>(</span></span><span class="entity"><span>card_assigns</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>max_assigns</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>binarized_and_boxed_data_type_constrs</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="entity"><span>binarize</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dom_cards</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Integer.prod</span><span> </span><span>o</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bounded_card_of_type</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="entity"><span>card_assigns</span></span><span class="main"><span>)</span></span><span>
             </span><span>o</span><span> </span><span>binder_types</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xs</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>maxes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>constr_max</span></span><span> </span><span class="entity"><span>max_assigns</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xs</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>effective_max</span></span><span> </span><span class="entity"><span>card</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>card</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>effective_max</span></span><span> </span><span class="entity"><span>card</span></span><span> </span><span class="entity"><span>max</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Int.min</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>card</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>max</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>max</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="entity"><span>effective_max</span></span><span> </span><span class="entity"><span>dom_cards</span></span><span> </span><span class="entity"><span>maxes</span></span><span> </span><span>|&gt;</span><span> </span><span>Integer.sum</span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>max</span></span><span> </span><span>&lt;</span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_surely_inconsistent_scope_description</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="entity"><span>binarize</span></span><span> </span><span class="entity"><span>seen</span></span><span> </span><span class="entity"><span>rest</span></span><span>
                                             </span><span class="entity"><span>max_assigns</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_surely_inconsistent_card_assign</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="entity"><span>binarize</span></span><span>
                                             </span><span class="main"><span>(</span></span><span class="entity"><span>seen</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>rest</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>max_assigns</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>seen</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>repair_card_assigns</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="entity"><span>binarize</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>card_assigns</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>max_assigns</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="entity"><span>seen</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>seen</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="entity"><span>seen</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>rest</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_surely_inconsistent_scope_description</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="entity"><span>binarize</span></span><span>
                </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>seen</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rest</span></span><span> </span><span class="entity"><span>max_assigns</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
           </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SAME</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>seen</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rest</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
             </span><span>SOME</span><span> </span><span class="entity"><span>assigns</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>assigns</span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SAME</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>SAME</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="entity"><span>seen</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>rest</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="entity"><span>card_assigns</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>repair_iterator_assign</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>assigns</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.bisim_iterator|type"><span>bisim_iterator</span></a><span>›</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>co_cards</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>snd</span><span> </span><span class="main"><span>(</span></span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_codatatype</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>assigns</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Int.min</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span>Integer.sum</span><span> </span><span class="entity"><span>co_cards</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_fp_iterator_type</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>bounded_card_of_type</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="entity"><span>assigns</span></span><span> </span><span class="main"><span>(</span></span><span>foldr1</span><span> </span><span class="entity"><span>HOLogic.mk_prodT</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="entity"><span>k</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>repair_iterator_assign</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>assign</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>assign</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_row_to_scope_descriptor</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kind</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ks</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>card_assigns</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>max_assigns</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>kind</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="entity"><span>Card</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span>the_single</span><span> </span><span class="entity"><span>ks</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>card_assigns</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>max_assigns</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Max</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>card_assigns</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span>the_single</span><span> </span><span class="entity"><span>ks</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>max_assigns</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>scope_descriptor_from_block</span></span><span> </span><span class="entity"><span>block</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>fold_rev</span><span> </span><span class="entity"><span>add_row_to_scope_descriptor</span></span><span> </span><span class="entity"><span>block</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>scope_descriptor_from_combination</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>binarize</span></span><span> </span><span class="entity"><span>blocks</span></span><span>
                                      </span><span class="entity"><span>columns</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>card_assigns</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>max_assigns</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>maps</span><span> </span><span class="entity"><span>project_block</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>columns</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>blocks</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>scope_descriptor_from_block</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>card_assigns</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>max_assigns</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>repair_card_assigns</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="entity"><span>binarize</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Option.map</span><span>
           </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>card_assigns</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
               </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>repair_iterator_assign</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>card_assigns</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>card_assigns</span></span><span class="main"><span>,</span></span><span>
                </span><span class="entity"><span>max_assigns</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>offset_table_for_card_assigns</span></span><span> </span><span class="entity"><span>dtypes</span></span><span> </span><span class="entity"><span>assigns</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="entity"><span>next</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Typtab.update_new</span><span> </span><span class="main"><span>(</span></span><span>dummyT</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>next</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="entity"><span>next</span></span><span> </span><span class="entity"><span>reusable</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>assigns</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>is_asymmetric_non_data_type</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="entity"><span>aux</span></span><span> </span><span class="entity"><span>next</span></span><span> </span><span class="entity"><span>reusable</span></span><span> </span><span class="entity"><span>assigns</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>length</span><span> </span><span class="main"><span>(</span></span><span>these</span><span> </span><span class="main"><span>(</span></span><span>Option.map</span><span> </span><span class="main"><span>#</span></span><span>constrs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>data_type_spec</span></span><span> </span><span class="entity"><span>dtypes</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span>Typtab.update_new</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>next</span></span><span class="main"><span>)</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>next</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>reusable</span></span><span> </span><span class="entity"><span>assigns</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>reusable</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>SOME</span><span> </span><span class="entity"><span>j0</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Typtab.update_new</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="entity"><span>next</span></span><span> </span><span class="entity"><span>reusable</span></span><span> </span><span class="entity"><span>assigns</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Typtab.update_new</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>next</span></span><span class="main"><span>)</span></span><span>
                    </span><span>#&gt;</span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>next</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>next</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>reusable</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>assigns</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Typtab.empty</span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>assigns</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>domain_card</span></span><span> </span><span class="entity"><span>max</span></span><span> </span><span class="entity"><span>card_assigns</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Integer.prod</span><span> </span><span>o</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bounded_card_of_type</span></span><span> </span><span class="entity"><span>max</span></span><span> </span><span class="entity"><span>max</span></span><span> </span><span class="entity"><span>card_assigns</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>binder_types</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_constr_spec</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>card_assigns</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>max_assigns</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>acyclic</span></span><span> </span><span class="entity"><span>card</span></span><span> </span><span class="entity"><span>sum_dom_cards</span></span><span>
                    </span><span class="entity"><span>num_self_recs</span></span><span> </span><span class="entity"><span>num_non_self_recs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>self_rec</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="entity"><span>constrs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>max</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>constr_max</span></span><span> </span><span class="entity"><span>max_assigns</span></span><span> </span><span class="entity"><span>x</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>next_delta</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>constrs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>#</span></span><span>epsilon</span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>constrs</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>delta</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>epsilon</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>exclusive</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>total</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>max</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>delta</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>next_delta</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="main"><span>{</span></span><span>delta</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>delta</span></span><span class="main"><span>,</span></span><span> </span><span>epsilon</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>delta</span></span><span class="main"><span>,</span></span><span> </span><span>exclusive</span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span class="main"><span>,</span></span><span> </span><span>total</span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>}</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>num_self_recs</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>num_non_self_recs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>self_rec</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>List.last</span><span> </span><span class="entity"><span>constrs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
               </span><span class="main"><span>{</span></span><span>delta</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span>epsilon</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span>exclusive</span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
               </span><span class="main"><span>{</span></span><span>delta</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span>epsilon</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>card</span></span><span class="main"><span>,</span></span><span> </span><span>exclusive</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>num_self_recs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                </span><span>total</span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>}</span></span><span>
             </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SAME</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>domain_card</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="entity"><span>card_assigns</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
               </span><span class="main"><span>{</span></span><span>delta</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span>epsilon</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span>exclusive</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>acyclic</span></span><span class="main"><span>,</span></span><span> </span><span>total</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>acyclic</span></span><span class="main"><span>}</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
               </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SAME</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
           </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SAME</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>SAME</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
               </span><span class="main"><span>{</span></span><span>delta</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span>epsilon</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>card</span></span><span class="main"><span>,</span></span><span> </span><span>exclusive</span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span> </span><span>total</span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>}</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>card</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>sum_dom_cards</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>card</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>delta</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>next_delta</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="main"><span>{</span></span><span>delta</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>delta</span></span><span class="main"><span>,</span></span><span> </span><span>epsilon</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>delta</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>domain_card</span></span><span> </span><span class="entity"><span>card</span></span><span> </span><span class="entity"><span>card_assigns</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span>
           </span><span>exclusive</span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span class="main"><span>,</span></span><span> </span><span>total</span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span class="main"><span>}</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="main"><span>{</span></span><span>delta</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span>epsilon</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>card</span></span><span class="main"><span>,</span></span><span>
         </span><span>exclusive</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>num_self_recs</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>num_non_self_recs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>total</span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>}</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>{</span></span><span>const</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span>delta</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>delta</span></span><span class="main"><span>,</span></span><span> </span><span>epsilon</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>epsilon</span></span><span class="main"><span>,</span></span><span> </span><span>exclusive</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>exclusive</span></span><span class="main"><span>,</span></span><span>
     </span><span>explicit_max</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>max</span></span><span class="main"><span>,</span></span><span> </span><span>total</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>total</span></span><span class="main"><span>}</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>constrs</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>has_exact_card</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="entity"><span>facto</span></span><span> </span><span class="entity"><span>finitizable_dataTs</span></span><span> </span><span class="entity"><span>card_assigns</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>card</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>card_of_type</span></span><span> </span><span class="entity"><span>card_assigns</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>card</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>bounded_exact_card_of_type</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span>
               </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>facto</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>finitizable_dataTs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>card</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>
               </span><span class="entity"><span>card_assigns</span></span><span> </span><span class="entity"><span>T</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>data_type_spec_from_scope_descriptor</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span>
        </span><span class="entity"><span>binarize</span></span><span> </span><span class="entity"><span>deep_dataTs</span></span><span> </span><span class="entity"><span>finitizable_dataTs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>desc</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>card_assigns</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>card</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>deep</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>deep_dataTs</span></span><span> </span><span class="entity"><span>T</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>co</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>is_codatatype</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>T</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>binarized_and_boxed_data_type_constrs</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="entity"><span>binarize</span></span><span> </span><span class="entity"><span>T</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>self_recs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_self_recursive_constr_type</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xs</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>num_self_recs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>num_non_self_recs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>List.partition</span><span> </span><span>I</span><span> </span><span class="entity"><span>self_recs</span></span><span> </span><span>|&gt;</span><span> </span><span>apply2</span><span> </span><span>length</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>self_rec</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>num_self_recs</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_complete</span></span><span> </span><span class="entity"><span>facto</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>has_exact_card</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="entity"><span>facto</span></span><span> </span><span class="entity"><span>finitizable_dataTs</span></span><span> </span><span class="entity"><span>card_assigns</span></span><span> </span><span class="entity"><span>T</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_concrete</span></span><span> </span><span class="entity"><span>facto</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>is_word_type</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
      </span><span class="comment1"><span>(* FIXME: looks wrong; other types than just functions might be
         abstract. "is_complete" is also suspicious. *)</span></span><span>
      </span><span class="entity"><span>xs</span></span><span> </span><span>|&gt;</span><span> </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span>binder_types</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>maps</span><span> </span><span>binder_types</span><span>
         </span><span>|&gt;</span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>has_exact_card</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="entity"><span>facto</span></span><span> </span><span class="entity"><span>finitizable_dataTs</span></span><span>
                                   </span><span class="entity"><span>card_assigns</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>complete</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pair_from_fun</span></span><span> </span><span class="entity"><span>is_complete</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>concrete</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pair_from_fun</span></span><span> </span><span class="entity"><span>is_concrete</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>sum_dom_cards</span></span><span> </span><span class="entity"><span>max</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>domain_card</span></span><span> </span><span class="entity"><span>max</span></span><span> </span><span class="entity"><span>card_assigns</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span>|&gt;</span><span> </span><span>Integer.sum</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>constrs</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_constr_spec</span></span><span> </span><span class="entity"><span>desc</span></span><span> </span><span class="main"><span>(</span></span><span>not</span><span> </span><span class="entity"><span>co</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>card</span></span><span> </span><span class="entity"><span>sum_dom_cards</span></span><span> </span><span class="entity"><span>num_self_recs</span></span><span>
                                </span><span class="entity"><span>num_non_self_recs</span></span><span class="main"><span>)</span></span><span>
               </span><span class="main"><span>(</span></span><span>sort</span><span> </span><span class="main"><span>(</span></span><span>bool_ord</span><span> </span><span>o</span><span> </span><span>swap</span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>self_recs</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>{</span></span><span>typ</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span>card</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>card</span></span><span class="main"><span>,</span></span><span> </span><span>co</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>co</span></span><span class="main"><span>,</span></span><span> </span><span>self_rec</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>self_rec</span></span><span class="main"><span>,</span></span><span> </span><span>complete</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>complete</span></span><span class="main"><span>,</span></span><span>
     </span><span>concrete</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>concrete</span></span><span class="main"><span>,</span></span><span> </span><span>deep</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>deep</span></span><span class="main"><span>,</span></span><span> </span><span>constrs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>constrs</span></span><span class="main"><span>}</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>scope_from_descriptor</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>binarize</span></span><span> </span><span class="entity"><span>deep_dataTs</span></span><span>
                          </span><span class="entity"><span>finitizable_dataTs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>desc</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>card_assigns</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>data_types</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>data_type_spec_from_scope_descriptor</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="entity"><span>binarize</span></span><span> </span><span class="entity"><span>deep_dataTs</span></span><span>
                                                </span><span class="entity"><span>finitizable_dataTs</span></span><span> </span><span class="entity"><span>desc</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>(</span></span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_data_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>card_assigns</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bits</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>card_of_type</span></span><span> </span><span class="entity"><span>card_assigns</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.signed_bit|type"><span>signed_bit</span></a><span>›</span></span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span>
               </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>TYPE</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_HOL.card_of_type"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                      </span><span class="entity"><span>card_of_type</span></span><span> </span><span class="entity"><span>card_assigns</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.unsigned_bit|type"><span>unsigned_bit</span></a><span>›</span></span></span><span>
                      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>TYPE</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_HOL.card_of_type"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bisim_depth</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>card_of_type</span></span><span> </span><span class="entity"><span>card_assigns</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../Nitpick.html#Nitpick.bisim_iterator|type"><span>bisim_iterator</span></a><span>›</span></span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>{</span></span><span>hol_ctxt</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span class="main"><span>,</span></span><span> </span><span>binarize</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>binarize</span></span><span class="main"><span>,</span></span><span> </span><span>card_assigns</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>card_assigns</span></span><span class="main"><span>,</span></span><span>
     </span><span>data_types</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>data_types</span></span><span class="main"><span>,</span></span><span> </span><span>bits</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>bits</span></span><span class="main"><span>,</span></span><span> </span><span>bisim_depth</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>bisim_depth</span></span><span class="main"><span>,</span></span><span>
     </span><span>ofs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>offset_table_for_card_assigns</span></span><span> </span><span class="entity"><span>data_types</span></span><span> </span><span class="entity"><span>card_assigns</span></span><span class="main"><span>}</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>repair_cards_assigns_wrt_boxing_etc</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>repair_cards_assigns_wrt_boxing_etc</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ks</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>cards_assigns</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_fun_type</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>is_pair_type</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
       </span><span class="entity"><span>Ts</span></span><span> </span><span>|&gt;</span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>type_match</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span>o</span><span> </span><span>swap</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>rpair</span><span> </span><span class="entity"><span>ks</span></span><span> </span><span>o</span><span> </span><span>SOME</span><span class="main"><span>)</span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
       </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ks</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span>
       </span><span class="entity"><span>repair_cards_assigns_wrt_boxing_etc</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>cards_assigns</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>repair_cards_assigns_wrt_boxing_etc</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ks</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>cards_assigns</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ks</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>repair_cards_assigns_wrt_boxing_etc</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span class="entity"><span>cards_assigns</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>max_scopes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>5000</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>distinct_threshold</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1000</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>all_scopes</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>thy</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>binarize</span></span><span> </span><span class="entity"><span>cards_assigns</span></span><span> </span><span class="entity"><span>maxes_assigns</span></span><span>
               </span><span class="entity"><span>iters_assigns</span></span><span> </span><span class="entity"><span>bitss</span></span><span> </span><span class="entity"><span>bisim_depths</span></span><span> </span><span class="entity"><span>mono_Ts</span></span><span> </span><span class="entity"><span>nonmono_Ts</span></span><span> </span><span class="entity"><span>deep_dataTs</span></span><span>
               </span><span class="entity"><span>finitizable_dataTs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cards_assigns</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>repair_cards_assigns_wrt_boxing_etc</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>mono_Ts</span></span><span> </span><span class="entity"><span>cards_assigns</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>blocks</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>blocks_for_types</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="entity"><span>binarize</span></span><span> </span><span class="entity"><span>cards_assigns</span></span><span> </span><span class="entity"><span>maxes_assigns</span></span><span>
                       </span><span class="entity"><span>iters_assigns</span></span><span> </span><span class="entity"><span>bitss</span></span><span> </span><span class="entity"><span>bisim_depths</span></span><span> </span><span class="entity"><span>mono_Ts</span></span><span> </span><span class="entity"><span>nonmono_Ts</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ranks</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>rank_of_block</span></span><span> </span><span class="entity"><span>blocks</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>all</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>all_combinations_ordered_smartly</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>rpair</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ranks</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>head</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>take</span><span> </span><span class="entity"><span>max_scopes</span></span><span> </span><span class="entity"><span>all</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>descs</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>scope_descriptor_from_combination</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="entity"><span>binarize</span></span><span> </span><span class="entity"><span>blocks</span></span><span class="main"><span>)</span></span><span>
                 </span><span class="entity"><span>head</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>all</span></span><span> </span><span>-</span><span> </span><span>length</span><span> </span><span class="entity"><span>head</span></span><span class="main"><span>,</span></span><span>
     </span><span class="entity"><span>descs</span></span><span> </span><span>|&gt;</span><span> </span><span>length</span><span> </span><span class="entity"><span>descs</span></span><span> </span><span>&lt;=</span><span> </span><span class="entity"><span>distinct_threshold</span></span><span> </span><span>?</span><span> </span><span>distinct</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span>
           </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>scope_from_descriptor</span></span><span> </span><span class="entity"><span>hol_ctxt</span></span><span> </span><span class="entity"><span>binarize</span></span><span> </span><span class="entity"><span>deep_dataTs</span></span><span>
                                         </span><span class="entity"><span>finitizable_dataTs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
</span></pre>
</body>

</html>