<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Tools/Nitpick/nitpick_peephole.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Tools/Nitpick/nitpick_peephole.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      HOL/Tools/Nitpick/nitpick_peephole.ML
    Author:     Jasmin Blanchette, TU Muenchen
    Copyright   2008, 2009, 2010

Peephole optimizer for Nitpick.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>NITPICK_PEEPHOLE</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>n_ary_index</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Kodkod.n_ary_index</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>formula</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Kodkod.formula</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>int_expr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Kodkod.int_expr</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Kodkod.rel_expr</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>decl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Kodkod.decl</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>expr_assign</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Kodkod.expr_assign</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>name_pool</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>{</span></span><span>rels</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>n_ary_index</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     </span><span>vars</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>n_ary_index</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
     </span><span>formula_reg</span><span class="main"><span>:</span></span><span> </span><span>int</span><span class="main"><span>,</span></span><span>
     </span><span>rel_reg</span><span class="main"><span>:</span></span><span> </span><span>int</span><span class="main"><span>}</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> initial_pool </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>name_pool</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> not3_rel </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>n_ary_index</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> suc_rel </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>n_ary_index</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> suc_rels_base </span><span class="main"><span>:</span></span><span> </span><span>int</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> unsigned_bit_word_sel_rel </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>n_ary_index</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> signed_bit_word_sel_rel </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>n_ary_index</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> nat_add_rel </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>n_ary_index</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> int_add_rel </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>n_ary_index</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> nat_subtract_rel </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>n_ary_index</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> int_subtract_rel </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>n_ary_index</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> nat_multiply_rel </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>n_ary_index</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> int_multiply_rel </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>n_ary_index</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> nat_divide_rel </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>n_ary_index</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> int_divide_rel </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>n_ary_index</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> nat_less_rel </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>n_ary_index</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> int_less_rel </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>n_ary_index</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> gcd_rel </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>n_ary_index</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> lcm_rel </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>n_ary_index</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> norm_frac_rel </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>n_ary_index</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> atom_for_bool </span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> formula_for_bool </span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>formula</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> atom_for_nat </span><span class="main"><span>:</span></span><span> </span><span>int</span><span> * </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> min_int_for_card </span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> max_int_for_card </span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> int_for_atom </span><span class="main"><span>:</span></span><span> </span><span>int</span><span> * </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> atom_for_int </span><span class="main"><span>:</span></span><span> </span><span>int</span><span> * </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> is_twos_complement_representable </span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> suc_rel_for_atom_seq </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>int</span><span> * </span><span>int</span><span class="main"><span>)</span></span><span> * </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>n_ary_index</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> atom_seq_for_suc_rel </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>n_ary_index</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>int</span><span> * </span><span>int</span><span class="main"><span>)</span></span><span> * </span><span>bool</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> inline_rel_expr </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> empty_n_ary_rel </span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> num_seq </span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>int_expr</span></span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> s_and </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>formula</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>formula</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>formula</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>kodkod_constrs</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>{</span></span><span>kk_all</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>decl</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>formula</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>formula</span></span><span class="main"><span>,</span></span><span>
     </span><span>kk_exist</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>decl</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>formula</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>formula</span></span><span class="main"><span>,</span></span><span>
     </span><span>kk_formula_let</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>expr_assign</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>formula</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>formula</span></span><span class="main"><span>,</span></span><span>
     </span><span>kk_formula_if</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>formula</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>formula</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>formula</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>formula</span></span><span class="main"><span>,</span></span><span>
     </span><span>kk_or</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>formula</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>formula</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>formula</span></span><span class="main"><span>,</span></span><span>
     </span><span>kk_not</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>formula</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>formula</span></span><span class="main"><span>,</span></span><span>
     </span><span>kk_iff</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>formula</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>formula</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>formula</span></span><span class="main"><span>,</span></span><span>
     </span><span>kk_implies</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>formula</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>formula</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>formula</span></span><span class="main"><span>,</span></span><span>
     </span><span>kk_and</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>formula</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>formula</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>formula</span></span><span class="main"><span>,</span></span><span>
     </span><span>kk_subset</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>formula</span></span><span class="main"><span>,</span></span><span>
     </span><span>kk_rel_eq</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>formula</span></span><span class="main"><span>,</span></span><span>
     </span><span>kk_no</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>formula</span></span><span class="main"><span>,</span></span><span>
     </span><span>kk_lone</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>formula</span></span><span class="main"><span>,</span></span><span>
     </span><span>kk_one</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>formula</span></span><span class="main"><span>,</span></span><span>
     </span><span>kk_some</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>formula</span></span><span class="main"><span>,</span></span><span>
     </span><span>kk_rel_let</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>expr_assign</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span class="main"><span>,</span></span><span>
     </span><span>kk_rel_if</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>formula</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span class="main"><span>,</span></span><span>
     </span><span>kk_union</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span class="main"><span>,</span></span><span>
     </span><span>kk_difference</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span class="main"><span>,</span></span><span>
     </span><span>kk_override</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span class="main"><span>,</span></span><span>
     </span><span>kk_intersect</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span class="main"><span>,</span></span><span>
     </span><span>kk_product</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span class="main"><span>,</span></span><span>
     </span><span>kk_join</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span class="main"><span>,</span></span><span>
     </span><span>kk_closure</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span class="main"><span>,</span></span><span>
     </span><span>kk_reflexive_closure</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span class="main"><span>,</span></span><span>
     </span><span>kk_comprehension</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>decl</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>formula</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span class="main"><span>,</span></span><span>
     </span><span>kk_project</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>int_expr</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span class="main"><span>,</span></span><span>
     </span><span>kk_project_seq</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span class="main"><span>,</span></span><span>
     </span><span>kk_not3</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span class="main"><span>,</span></span><span>
     </span><span>kk_nat_less</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span class="main"><span>,</span></span><span>
     </span><span>kk_int_less</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span class="main"><span>}</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> kodkod_constrs </span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>kodkod_constrs</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Nitpick_Peephole</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>NITPICK_PEEPHOLE</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Kodkod</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Nitpick_Util</span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>name_pool</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>rels</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>n_ary_index</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   </span><span>vars</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>n_ary_index</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
   </span><span>formula_reg</span><span class="main"><span>:</span></span><span> </span><span>int</span><span class="main"><span>,</span></span><span>
   </span><span>rel_reg</span><span class="main"><span>:</span></span><span> </span><span>int</span><span class="main"><span>}</span></span><span>

</span><span class="comment1"><span>(* FIXME: needed? *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>initial_pool</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>rels</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span>vars</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span>formula_reg</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>10</span></span><span class="main"><span>,</span></span><span> </span><span>rel_reg</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>10</span></span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>not3_rel</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>2</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>unsigned_bit_word_sel_rel</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>2</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>~2</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>signed_bit_word_sel_rel</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>2</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>~3</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>suc_rel</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>2</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>~4</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>suc_rels_base</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>~5</span></span><span> </span><span class="comment1"><span>(* must be the last of the binary series *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nat_add_rel</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>3</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>int_add_rel</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>3</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>~2</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nat_subtract_rel</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>3</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>~3</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>int_subtract_rel</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>3</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>~4</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nat_multiply_rel</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>3</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>~5</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>int_multiply_rel</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>3</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>~6</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nat_divide_rel</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>3</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>~7</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>int_divide_rel</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>3</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>~8</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nat_less_rel</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>3</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>~9</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>int_less_rel</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>3</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>~10</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>gcd_rel</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>3</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>~11</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lcm_rel</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>3</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>~12</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>norm_frac_rel</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>4</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>atom_for_bool</span></span><span> </span><span class="entity"><span>j0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Atom</span></span><span> </span><span>o</span><span> </span><span>Integer.add</span><span> </span><span class="entity"><span>j0</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>int_from_bool</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>formula_for_bool</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>True</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>False</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>atom_for_nat</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>&lt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>&gt;=</span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>j0</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>min_int_for_card</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>~</span><span class="entity"><span>k</span></span><span> </span><span>div</span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>max_int_for_card</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span>div</span><span> </span><span class="inner_numeral"><span>2</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>int_for_atom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>j0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span>&lt;=</span><span> </span><span class="entity"><span>max_int_for_card</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>atom_for_int</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>&lt;</span><span> </span><span class="entity"><span>min_int_for_card</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>&gt;</span><span> </span><span class="entity"><span>max_int_for_card</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>&lt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>k</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>j0</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>j0</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_twos_complement_representable</span></span><span> </span><span class="entity"><span>bits</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>max</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>reasonable_power</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="entity"><span>bits</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>&gt;=</span><span> </span><span>~</span><span> </span><span class="entity"><span>max</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>&lt;</span><span> </span><span class="entity"><span>max</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>max_squeeze_card</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>49</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>squeeze</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>&gt;</span><span> </span><span class="entity"><span>max_squeeze_card</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>TOO_LARGE</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Peephole.squeeze"</span></span><span class="main"><span>,</span></span><span>
                     </span><span class="inner_quoted"><span>"too large cardinality ("</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>n</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>")"</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>max_squeeze_card</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span>*</span><span> </span><span class="entity"><span>m</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>n</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unsqueeze</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span> </span><span>div</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>max_squeeze_card</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span>mod</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>max_squeeze_card</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>boolify</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span>*</span><span> </span><span class="entity"><span>j</span></span><span> </span><span>+</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unboolify</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span> </span><span>div</span><span> </span><span class="inner_numeral"><span>2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span>mod</span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>suc_rel_for_atom_seq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tabulate</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>suc_rels_base</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>boolify</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>squeeze</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tabulate</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>atom_seq_for_suc_rel</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unboolify</span></span><span> </span><span class="main"><span>(</span></span><span>~</span><span> </span><span class="entity"><span>j</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>suc_rels_base</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span class="entity"><span>unsqueeze</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_none_product</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Product</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>is_none_product</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>is_none_product</span></span><span> </span><span class="entity"><span>r2</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_none_product</span></span><span> </span><span class="entity"><span>None</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_none_product</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_one_rel_expr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_one_rel_expr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AtomSeq</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_one_rel_expr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Var</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_one_rel_expr</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>inline_rel_expr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Product</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>inline_rel_expr</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>inline_rel_expr</span></span><span> </span><span class="entity"><span>r2</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>inline_rel_expr</span></span><span> </span><span class="entity"><span>Iden</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>inline_rel_expr</span></span><span> </span><span class="entity"><span>Ints</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>inline_rel_expr</span></span><span> </span><span class="entity"><span>None</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>inline_rel_expr</span></span><span> </span><span class="entity"><span>Univ</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>inline_rel_expr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>inline_rel_expr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AtomSeq</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>inline_rel_expr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Rel</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>inline_rel_expr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Var</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>inline_rel_expr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>RelReg</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>inline_rel_expr</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rel_expr_equal</span></span><span> </span><span class="entity"><span>None</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span>false</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rel_expr_equal</span></span><span> </span><span class="entity"><span>None</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AtomSeq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rel_expr_equal</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>None</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span>false</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rel_expr_equal</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AtomSeq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>None</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rel_expr_equal</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="entity"><span>j1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="entity"><span>j2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>j2</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rel_expr_equal</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AtomSeq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>j0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rel_expr_equal</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AtomSeq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>j0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rel_expr_equal</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AtomSeq</span></span><span> </span><span class="entity"><span>x1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AtomSeq</span></span><span> </span><span class="entity"><span>x2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>x2</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rel_expr_equal</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span>true</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rel_expr_intersects</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="entity"><span>j1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="entity"><span>j2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>j2</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rel_expr_intersects</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AtomSeq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span> </span><span>&lt;</span><span> </span><span class="entity"><span>j0</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rel_expr_intersects</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AtomSeq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span> </span><span>&lt;</span><span> </span><span class="entity"><span>j0</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rel_expr_intersects</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AtomSeq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j01</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AtomSeq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j02</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k1</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>k2</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>j01</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>k1</span></span><span> </span><span>&gt;</span><span> </span><span class="entity"><span>j02</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>j02</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>k2</span></span><span> </span><span>&gt;</span><span> </span><span class="entity"><span>j01</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rel_expr_intersects</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_none_product</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>is_none_product</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span>false</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>empty_n_ary_rel</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>ARG</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Peephole.empty_n_ary_rel"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"0"</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>empty_n_ary_rel</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>funpow</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="entity"><span>Product</span></span><span> </span><span class="entity"><span>None</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>None</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>decl_one_set</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>DeclOne</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>r</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>decl_one_set</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>ARG</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Peephole.decl_one_set"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"not \"DeclOne\""</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_Num</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Num</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_Num</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_Num</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Num</span></span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>k</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dest_Num</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>ARG</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Nitpick_Peephole.dest_Num"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>"not \"Num\""</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>num_seq</span></span><span> </span><span class="entity"><span>j0</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>Num</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>index_seq</span></span><span> </span><span class="entity"><span>j0</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>occurs_in_union</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Union</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>occurs_in_union</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>occurs_in_union</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>r2</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>occurs_in_union</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>r'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>r'</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>s_and</span></span><span> </span><span class="entity"><span>True</span></span><span> </span><span class="entity"><span>f2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f2</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_and</span></span><span> </span><span class="entity"><span>False</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>False</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_and</span></span><span> </span><span class="entity"><span>f1</span></span><span> </span><span class="entity"><span>True</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f1</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_and</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>False</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>False</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_and</span></span><span> </span><span class="entity"><span>f1</span></span><span> </span><span class="entity"><span>f2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>And</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f2</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>kodkod_constrs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>kk_all</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>decl</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>formula</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>formula</span></span><span class="main"><span>,</span></span><span>
   </span><span>kk_exist</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>decl</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>formula</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>formula</span></span><span class="main"><span>,</span></span><span>
   </span><span>kk_formula_let</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>expr_assign</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>formula</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>formula</span></span><span class="main"><span>,</span></span><span>
   </span><span>kk_formula_if</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>formula</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>formula</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>formula</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>formula</span></span><span class="main"><span>,</span></span><span>
   </span><span>kk_or</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>formula</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>formula</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>formula</span></span><span class="main"><span>,</span></span><span>
   </span><span>kk_not</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>formula</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>formula</span></span><span class="main"><span>,</span></span><span>
   </span><span>kk_iff</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>formula</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>formula</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>formula</span></span><span class="main"><span>,</span></span><span>
   </span><span>kk_implies</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>formula</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>formula</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>formula</span></span><span class="main"><span>,</span></span><span>
   </span><span>kk_and</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>formula</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>formula</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>formula</span></span><span class="main"><span>,</span></span><span>
   </span><span>kk_subset</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>formula</span></span><span class="main"><span>,</span></span><span>
   </span><span>kk_rel_eq</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>formula</span></span><span class="main"><span>,</span></span><span>
   </span><span>kk_no</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>formula</span></span><span class="main"><span>,</span></span><span>
   </span><span>kk_lone</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>formula</span></span><span class="main"><span>,</span></span><span>
   </span><span>kk_one</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>formula</span></span><span class="main"><span>,</span></span><span>
   </span><span>kk_some</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>formula</span></span><span class="main"><span>,</span></span><span>
   </span><span>kk_rel_let</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>expr_assign</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span class="main"><span>,</span></span><span>
   </span><span>kk_rel_if</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>formula</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span class="main"><span>,</span></span><span>
   </span><span>kk_union</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span class="main"><span>,</span></span><span>
   </span><span>kk_difference</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span class="main"><span>,</span></span><span>
   </span><span>kk_override</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span class="main"><span>,</span></span><span>
   </span><span>kk_intersect</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span class="main"><span>,</span></span><span>
   </span><span>kk_product</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span class="main"><span>,</span></span><span>
   </span><span>kk_join</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span class="main"><span>,</span></span><span>
   </span><span>kk_closure</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span class="main"><span>,</span></span><span>
   </span><span>kk_reflexive_closure</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span class="main"><span>,</span></span><span>
   </span><span>kk_comprehension</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>decl</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>formula</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span class="main"><span>,</span></span><span>
   </span><span>kk_project</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>int_expr</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span class="main"><span>,</span></span><span>
   </span><span>kk_project_seq</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span class="main"><span>,</span></span><span>
   </span><span>kk_not3</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span class="main"><span>,</span></span><span>
   </span><span>kk_nat_less</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span class="main"><span>,</span></span><span>
   </span><span>kk_int_less</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>rel_expr</span></span><span class="main"><span>}</span></span><span>

</span><span class="comment1"><span>(* We assume throughout that Kodkod variables have a "one" constraint. This is
   always the case if Kodkod's skolemization is disabled. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>kodkod_constrs</span></span><span> </span><span class="entity"><span>optim</span></span><span> </span><span class="entity"><span>nat_card</span></span><span> </span><span class="entity"><span>int_card</span></span><span> </span><span class="entity"><span>main_j0</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>from_bool</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>atom_for_bool</span></span><span> </span><span class="entity"><span>main_j0</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>from_nat</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>main_j0</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>to_nat</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>main_j0</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>to_int</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>int_for_atom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>int_card</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>main_j0</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>exists_empty_decl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>DeclOne</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>None</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>s_all</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>True</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>True</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_all</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>False</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>False</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_all</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_all</span></span><span> </span><span class="entity"><span>ds</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>All</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ds'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s_all</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ds</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>ds'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>f</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_all</span></span><span> </span><span class="entity"><span>ds</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>exists_empty_decl</span></span><span> </span><span class="entity"><span>ds</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>True</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>All</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ds</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>s_exist</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>True</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>True</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_exist</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>False</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>False</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_exist</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_exist</span></span><span> </span><span class="entity"><span>ds</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Exist</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ds'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s_exist</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ds</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>ds'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>f</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_exist</span></span><span> </span><span class="entity"><span>ds</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>exists_empty_decl</span></span><span> </span><span class="entity"><span>ds</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>False</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Exist</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ds</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>s_formula_let</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>True</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>True</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_formula_let</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>False</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>False</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_formula_let</span></span><span> </span><span class="entity"><span>assigns</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>FormulaLet</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>assigns</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>s_not</span></span><span> </span><span class="entity"><span>True</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>False</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_not</span></span><span> </span><span class="entity"><span>False</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>True</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_not</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>All</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ds</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Exist</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ds</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s_not</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_not</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Exist</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ds</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>All</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ds</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s_not</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_not</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Or</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>And</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s_not</span></span><span> </span><span class="entity"><span>f1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s_not</span></span><span> </span><span class="entity"><span>f2</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_not</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Implies</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>And</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s_not</span></span><span> </span><span class="entity"><span>f2</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_not</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>And</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Or</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s_not</span></span><span> </span><span class="entity"><span>f1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s_not</span></span><span> </span><span class="entity"><span>f2</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_not</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Not</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_not</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>No</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Some</span></span><span> </span><span class="entity"><span>r</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_not</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Some</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>No</span></span><span> </span><span class="entity"><span>r</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_not</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Not</span></span><span> </span><span class="entity"><span>f</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>s_or</span></span><span> </span><span class="entity"><span>True</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>True</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_or</span></span><span> </span><span class="entity"><span>False</span></span><span> </span><span class="entity"><span>f2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f2</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_or</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>True</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>True</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_or</span></span><span> </span><span class="entity"><span>f1</span></span><span> </span><span class="entity"><span>False</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f1</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_or</span></span><span> </span><span class="entity"><span>f1</span></span><span> </span><span class="entity"><span>f2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>f1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>f1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Or</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f2</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>s_iff</span></span><span> </span><span class="entity"><span>True</span></span><span> </span><span class="entity"><span>f2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f2</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_iff</span></span><span> </span><span class="entity"><span>False</span></span><span> </span><span class="entity"><span>f2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s_not</span></span><span> </span><span class="entity"><span>f2</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_iff</span></span><span> </span><span class="entity"><span>f1</span></span><span> </span><span class="entity"><span>True</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f1</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_iff</span></span><span> </span><span class="entity"><span>f1</span></span><span> </span><span class="entity"><span>False</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s_not</span></span><span> </span><span class="entity"><span>f1</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_iff</span></span><span> </span><span class="entity"><span>f1</span></span><span> </span><span class="entity"><span>f2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>f1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>True</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Iff</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f2</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>s_implies</span></span><span> </span><span class="entity"><span>True</span></span><span> </span><span class="entity"><span>f2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f2</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_implies</span></span><span> </span><span class="entity"><span>False</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>True</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_implies</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>True</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>True</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_implies</span></span><span> </span><span class="entity"><span>f1</span></span><span> </span><span class="entity"><span>False</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s_not</span></span><span> </span><span class="entity"><span>f1</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_implies</span></span><span> </span><span class="entity"><span>f1</span></span><span> </span><span class="entity"><span>f2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>f1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>True</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Implies</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f2</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>s_formula_if</span></span><span> </span><span class="entity"><span>True</span></span><span> </span><span class="entity"><span>f2</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f2</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_formula_if</span></span><span> </span><span class="entity"><span>False</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>f3</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f3</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_formula_if</span></span><span> </span><span class="entity"><span>f1</span></span><span> </span><span class="entity"><span>True</span></span><span> </span><span class="entity"><span>f3</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s_or</span></span><span> </span><span class="entity"><span>f1</span></span><span> </span><span class="entity"><span>f3</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_formula_if</span></span><span> </span><span class="entity"><span>f1</span></span><span> </span><span class="entity"><span>False</span></span><span> </span><span class="entity"><span>f3</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s_and</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s_not</span></span><span> </span><span class="entity"><span>f1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>f3</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_formula_if</span></span><span> </span><span class="entity"><span>f1</span></span><span> </span><span class="entity"><span>f2</span></span><span> </span><span class="entity"><span>True</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s_implies</span></span><span> </span><span class="entity"><span>f1</span></span><span> </span><span class="entity"><span>f2</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_formula_if</span></span><span> </span><span class="entity"><span>f1</span></span><span> </span><span class="entity"><span>f2</span></span><span> </span><span class="entity"><span>False</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s_and</span></span><span> </span><span class="entity"><span>f1</span></span><span> </span><span class="entity"><span>f2</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_formula_if</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>f1</span></span><span> </span><span class="entity"><span>f2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>FormulaIf</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f2</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>s_project</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>is</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
         </span><span class="entity"><span>Project</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>is'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>forall</span><span> </span><span class="entity"><span>is_Num</span></span><span> </span><span class="entity"><span>is</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
           </span><span class="entity"><span>s_project</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>is'</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>dest_Num</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>is</span></span><span class="main"><span>)</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
           </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SAME</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
       </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SAME</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>SAME</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>is</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
               </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>arity_of_rel_expr</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>is</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>num_seq</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>r</span></span><span>
               </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Project</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>is</span></span><span class="main"><span>)</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>s_xone</span></span><span> </span><span class="entity"><span>xone</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_one_rel_expr</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="entity"><span>True</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>arity_of_rel_expr</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>xone</span></span><span> </span><span class="entity"><span>r</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>arity</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>foldl1</span><span> </span><span class="entity"><span>And</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>xone</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>s_project</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span>o</span><span> </span><span>single</span><span> </span><span>o</span><span> </span><span class="entity"><span>Num</span></span><span class="main"><span>)</span></span><span>
                                 </span><span class="main"><span>(</span></span><span class="entity"><span>index_seq</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="entity"><span>arity</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>s_no</span></span><span> </span><span class="entity"><span>None</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>True</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_no</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Product</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s_or</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s_no</span></span><span> </span><span class="entity"><span>r1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s_no</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_no</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Intersect</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Closure</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Rel</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Iden</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Acyclic</span></span><span> </span><span class="entity"><span>x</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_no</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_one_rel_expr</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>False</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>No</span></span><span> </span><span class="entity"><span>r</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>s_lone</span></span><span> </span><span class="entity"><span>None</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>True</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_lone</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s_xone</span></span><span> </span><span class="entity"><span>Lone</span></span><span> </span><span class="entity"><span>r</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>s_one</span></span><span> </span><span class="entity"><span>None</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>False</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_one</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s_xone</span></span><span> </span><span class="entity"><span>One</span></span><span> </span><span class="entity"><span>r</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>s_some</span></span><span> </span><span class="entity"><span>None</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>False</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_some</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>True</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_some</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Product</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s_and</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s_some</span></span><span> </span><span class="entity"><span>r1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s_some</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_some</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_one_rel_expr</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>True</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Some</span></span><span> </span><span class="entity"><span>r</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>s_not3</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>main_j0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_not3</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Join</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Rel</span></span><span> </span><span class="entity"><span>not3_rel</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Join</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Rel</span></span><span> </span><span class="entity"><span>not3_rel</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_not3</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Join</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Rel</span></span><span> </span><span class="entity"><span>not3_rel</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>s_rel_eq</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
         </span><span class="main"><span>(</span></span><span class="entity"><span>Join</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r11</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Rel</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>not3_rel</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>s_rel_eq</span></span><span> </span><span class="entity"><span>r11</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s_not3</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SAME</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
       </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>RelIf</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r11</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r12</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>inline_rel_expr</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
           </span><span class="entity"><span>s_formula_if</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s_rel_eq</span></span><span> </span><span class="entity"><span>r11</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s_rel_eq</span></span><span> </span><span class="entity"><span>r12</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
           </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SAME</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
       </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>RelIf</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r21</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r22</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>inline_rel_expr</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
           </span><span class="entity"><span>s_formula_if</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s_rel_eq</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>r21</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s_rel_eq</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>r22</span></span><span class="main"><span>)</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
           </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SAME</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
       </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>RelLet</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r1'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>s_formula_let</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s_rel_eq</span></span><span> </span><span class="entity"><span>r1'</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span>
       </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>RelLet</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r2'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>s_formula_let</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s_rel_eq</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>r2'</span></span><span class="main"><span>)</span></span><span>
       </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SAME</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>SAME</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>rel_expr_equal</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
               </span><span>SOME</span><span> </span><span>true</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>True</span></span><span>
             </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span>false</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>False</span></span><span>
             </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
               </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                 </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>RelIf</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r21</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r22</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>inline_rel_expr</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                    </span><span class="entity"><span>s_formula_if</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s_rel_eq</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>r21</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s_rel_eq</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>r22</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                    </span><span class="entity"><span>RelEq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span>
               </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>RelIf</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r11</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r12</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>inline_rel_expr</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
                    </span><span class="entity"><span>s_formula_if</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s_rel_eq</span></span><span> </span><span class="entity"><span>r11</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s_rel_eq</span></span><span> </span><span class="entity"><span>r12</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                    </span><span class="entity"><span>RelEq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span>
               </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>None</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>s_no</span></span><span> </span><span class="entity"><span>r1</span></span><span>
               </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>None</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>s_no</span></span><span> </span><span class="entity"><span>r2</span></span><span>
               </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>RelEq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>s_subset</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="entity"><span>j1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="entity"><span>j2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>formula_for_bool</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>j2</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_subset</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>AtomSeq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>formula_for_bool</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span> </span><span>&gt;=</span><span> </span><span class="entity"><span>j0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span>&lt;</span><span> </span><span class="entity"><span>j0</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_subset</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Union</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r11</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r12</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>s_and</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s_subset</span></span><span> </span><span class="entity"><span>r11</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s_subset</span></span><span> </span><span class="entity"><span>r12</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_subset</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Union</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r21</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r22</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_one_rel_expr</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="entity"><span>s_or</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s_subset</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>r21</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s_subset</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>r22</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>s_subset</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>r21</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>True</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>s_subset</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>r22</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>True</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
             </span><span class="entity"><span>r1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="entity"><span>True</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span class="entity"><span>Subset</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_subset</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>is_none_product</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>True</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_none_product</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>s_no</span></span><span> </span><span class="entity"><span>r1</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>forall</span><span> </span><span class="entity"><span>is_one_rel_expr</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>s_rel_eq</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>r2</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Subset</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>s_rel_let</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>b</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>AssignRelReg</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r'</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>RelReg</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>x'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>r'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>RelLet</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>b</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_rel_let</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>RelLet</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>s_rel_if</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
         </span><span class="main"><span>(</span></span><span class="entity"><span>True</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>r1</span></span><span>
       </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>False</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>r2</span></span><span>
       </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>No</span></span><span> </span><span class="entity"><span>r1'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>None</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>RelIf</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>One</span></span><span> </span><span class="entity"><span>r2'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r3'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r4'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>r1'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>r2'</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>r2'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>r3'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>s_rel_if</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Lone</span></span><span> </span><span class="entity"><span>r1'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>r1'</span></span><span> </span><span class="entity"><span>r4'</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SAME</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
       </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SAME</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>SAME</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>RelIf</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>s_union</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Union</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r21</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r22</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s_union</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s_union</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>r21</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>r22</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_union</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_none_product</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>r2</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_none_product</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>r1</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>r1</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>occurs_in_union</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>r1</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Union</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>s_difference</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_none_product</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>is_none_product</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>r1</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>empty_n_ary_rel</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arity_of_rel_expr</span></span><span> </span><span class="entity"><span>r1</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Difference</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>s_override</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_none_product</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>r1</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_none_product</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>r2</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Override</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>s_intersect</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>rel_expr_intersects</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>SOME</span><span> </span><span>true</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Intersect</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span>false</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>empty_n_ary_rel</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arity_of_rel_expr</span></span><span> </span><span class="entity"><span>r1</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_none_product</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>r1</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_none_product</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>r2</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Intersect</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>s_product</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_none_product</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="entity"><span>Product</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>empty_n_ary_rel</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arity_of_rel_expr</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_none_product</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span class="entity"><span>Product</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>empty_n_ary_rel</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arity_of_rel_expr</span></span><span> </span><span class="entity"><span>r1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="entity"><span>Product</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>s_join</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Product</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Product</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r211</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r212</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r22</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>Product</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s_join</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Product</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r211</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r212</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r22</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_join</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Product</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r11</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Product</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r121</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r122</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>Product</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r11</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s_join</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Product</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r121</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r122</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_join</span></span><span> </span><span class="entity"><span>None</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>empty_n_ary_rel</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arity_of_rel_expr</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_join</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>None</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>empty_n_ary_rel</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arity_of_rel_expr</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_join</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Product</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>None</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>None</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>empty_n_ary_rel</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arity_of_rel_expr</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_join</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Product</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>None</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>None</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>empty_n_ary_rel</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arity_of_rel_expr</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_join</span></span><span> </span><span class="entity"><span>Iden</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>r2</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_join</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>Iden</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>r1</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_join</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Product</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Univ</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>arity_of_rel_expr</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>r1</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Product</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s_join</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="entity"><span>Univ</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_join</span></span><span> </span><span class="entity"><span>Univ</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Product</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>arity_of_rel_expr</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>r2</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Product</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s_join</span></span><span> </span><span class="entity"><span>Univ</span></span><span> </span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_join</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Product</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r21</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r22</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>arity_of_rel_expr</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>rel_expr_intersects</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>r21</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>SOME</span><span> </span><span>true</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>r22</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span>false</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>empty_n_ary_rel</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arity_of_rel_expr</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Join</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="entity"><span>Join</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_join</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Product</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r11</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r12</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>arity_of_rel_expr</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>rel_expr_intersects</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="entity"><span>r12</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>SOME</span><span> </span><span>true</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>r11</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span>false</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>empty_n_ary_rel</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arity_of_rel_expr</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Join</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="entity"><span>Join</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_join</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>RelIf</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r21</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r22</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>inline_rel_expr</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>s_rel_if</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s_join</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>r21</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s_join</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>r22</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Join</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_join</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>RelIf</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r11</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r12</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>inline_rel_expr</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>s_rel_if</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s_join</span></span><span> </span><span class="entity"><span>r11</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s_join</span></span><span> </span><span class="entity"><span>r12</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Join</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_join</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Atom</span></span><span> </span><span class="entity"><span>j1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Rel</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>2</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>suc_rel</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>to_nat</span></span><span> </span><span class="entity"><span>j1</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>&lt;</span><span> </span><span class="entity"><span>nat_card</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>from_nat</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>None</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="entity"><span>Join</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_join</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Project</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r21</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Num</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>is</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>arity_of_rel_expr</span></span><span> </span><span class="entity"><span>r21</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>arity_of_rel_expr</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="entity"><span>s_project</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s_join</span></span><span> </span><span class="entity"><span>r21</span></span><span> </span><span class="entity"><span>r1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>is</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="entity"><span>Join</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_join</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Join</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r21</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r22</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Rel</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>3</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nat_add_rel</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r21</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r1</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="entity"><span>j1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Atom</span></span><span> </span><span class="entity"><span>j2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>to_nat</span></span><span> </span><span class="entity"><span>j1</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>to_nat</span></span><span> </span><span class="entity"><span>j2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>&lt;</span><span> </span><span class="entity"><span>nat_card</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>from_nat</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>None</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>to_nat</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                 </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>r</span></span><span>
               </span><span class="main"><span>|</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>s_join</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Rel</span></span><span> </span><span class="entity"><span>suc_rel</span></span><span class="main"><span>)</span></span><span>
               </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SAME</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Atom</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>to_nat</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                 </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>r</span></span><span>
               </span><span class="main"><span>|</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>s_join</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Rel</span></span><span> </span><span class="entity"><span>suc_rel</span></span><span class="main"><span>)</span></span><span>
               </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SAME</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SAME</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nat_subtract_rel</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r21</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r1</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="entity"><span>j1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Atom</span></span><span> </span><span class="entity"><span>j2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>from_nat</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nat_minus</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_nat</span></span><span> </span><span class="entity"><span>j1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_nat</span></span><span> </span><span class="entity"><span>j2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SAME</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nat_multiply_rel</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r21</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r1</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="entity"><span>j1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Atom</span></span><span> </span><span class="entity"><span>j2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>to_nat</span></span><span> </span><span class="entity"><span>j1</span></span><span> </span><span>*</span><span> </span><span class="entity"><span>to_nat</span></span><span> </span><span class="entity"><span>j2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>&lt;</span><span> </span><span class="entity"><span>nat_card</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>from_nat</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>None</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>to_nat</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Atom</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SAME</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Atom</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>to_nat</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Atom</span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SAME</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SAME</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SAME</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
         </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>SAME</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>List.foldr</span><span> </span><span class="entity"><span>Join</span></span><span> </span><span class="entity"><span>r22</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r21</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_join</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Join</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>s_closure</span></span><span> </span><span class="entity"><span>Iden</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Iden</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_closure</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_none_product</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Closure</span></span><span> </span><span class="entity"><span>r</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>s_reflexive_closure</span></span><span> </span><span class="entity"><span>Iden</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Iden</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_reflexive_closure</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_none_product</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>Iden</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>ReflexiveClosure</span></span><span> </span><span class="entity"><span>r</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>s_comprehension</span></span><span> </span><span class="entity"><span>ds</span></span><span> </span><span class="entity"><span>False</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>empty_n_ary_rel</span></span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>ds</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_comprehension</span></span><span> </span><span class="entity"><span>ds</span></span><span> </span><span class="entity"><span>True</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fold1</span></span><span> </span><span class="entity"><span>s_product</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>decl_one_set</span></span><span> </span><span class="entity"><span>ds</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_comprehension</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>d</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>DeclOne</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
                        </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>RelEq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Var</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>j2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Atom</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>j1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>j2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>rel_expr_intersects</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span>true</span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
          </span><span class="entity"><span>Atom</span></span><span> </span><span class="entity"><span>j</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
          </span><span class="entity"><span>Comprehension</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>d</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_comprehension</span></span><span> </span><span class="entity"><span>ds</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Comprehension</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ds</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>s_project_seq</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="entity"><span>arity</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>j0</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>j0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>arity</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
            </span><span class="entity"><span>r</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span class="entity"><span>RelIf</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="entity"><span>s_rel_if</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>aux</span></span><span> </span><span class="entity"><span>arity</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>j0</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>aux</span></span><span> </span><span class="entity"><span>arity</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="entity"><span>j0</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Product</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>arity2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>arity_of_rel_expr</span></span><span> </span><span class="entity"><span>r2</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>arity1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>arity</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>arity2</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>n1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Int.min</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nat_minus</span></span><span> </span><span class="entity"><span>arity1</span></span><span> </span><span class="entity"><span>j0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>n2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>n1</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>one</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="entity"><span>arity1</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>j0</span></span><span> </span><span class="entity"><span>n1</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>two</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="entity"><span>arity2</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nat_minus</span></span><span> </span><span class="entity"><span>j0</span></span><span> </span><span class="entity"><span>arity1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>n2</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n2</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
                </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>s_rel_if</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s_some</span></span><span> </span><span class="entity"><span>r1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>two</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>empty_n_ary_rel</span></span><span> </span><span class="entity"><span>n2</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>s_rel_if</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s_some</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>one</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>empty_n_ary_rel</span></span><span> </span><span class="entity"><span>n1</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>s_product</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>one</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>two</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>s_project</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>num_seq</span></span><span> </span><span class="entity"><span>j0</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>aux</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arity_of_rel_expr</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>s_nat_less</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="entity"><span>j1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="entity"><span>j2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>from_bool</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j1</span></span><span> </span><span>&lt;</span><span> </span><span class="entity"><span>j2</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_nat_less</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>s_join</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Rel</span></span><span> </span><span class="entity"><span>nat_less_rel</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>s_int_less</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="entity"><span>j1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Atom</span></span><span> </span><span class="entity"><span>j2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>from_bool</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>to_int</span></span><span> </span><span class="entity"><span>j1</span></span><span> </span><span>&lt;</span><span> </span><span class="entity"><span>to_int</span></span><span> </span><span class="entity"><span>j2</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>s_int_less</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>s_join</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Rel</span></span><span> </span><span class="entity"><span>int_less_rel</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>d_project_seq</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>j0</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Project</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>num_seq</span></span><span> </span><span class="entity"><span>j0</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>d_not3</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Join</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Rel</span></span><span> </span><span class="entity"><span>not3_rel</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>d_nat_less</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.foldl</span><span> </span><span class="entity"><span>Join</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Rel</span></span><span> </span><span class="entity"><span>nat_less_rel</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>d_int_less</span></span><span> </span><span class="entity"><span>r1</span></span><span> </span><span class="entity"><span>r2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.foldl</span><span> </span><span class="entity"><span>Join</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Rel</span></span><span> </span><span class="entity"><span>int_less_rel</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r2</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>optim</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="main"><span>{</span></span><span>kk_all</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s_all</span></span><span class="main"><span>,</span></span><span> </span><span>kk_exist</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s_exist</span></span><span class="main"><span>,</span></span><span> </span><span>kk_formula_let</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s_formula_let</span></span><span class="main"><span>,</span></span><span>
       </span><span>kk_formula_if</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s_formula_if</span></span><span class="main"><span>,</span></span><span> </span><span>kk_or</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s_or</span></span><span class="main"><span>,</span></span><span> </span><span>kk_not</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s_not</span></span><span class="main"><span>,</span></span><span>
       </span><span>kk_iff</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s_iff</span></span><span class="main"><span>,</span></span><span> </span><span>kk_implies</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s_implies</span></span><span class="main"><span>,</span></span><span> </span><span>kk_and</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s_and</span></span><span class="main"><span>,</span></span><span>
       </span><span>kk_subset</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s_subset</span></span><span class="main"><span>,</span></span><span> </span><span>kk_rel_eq</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s_rel_eq</span></span><span class="main"><span>,</span></span><span> </span><span>kk_no</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s_no</span></span><span class="main"><span>,</span></span><span>
       </span><span>kk_lone</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s_lone</span></span><span class="main"><span>,</span></span><span> </span><span>kk_one</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s_one</span></span><span class="main"><span>,</span></span><span> </span><span>kk_some</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s_some</span></span><span class="main"><span>,</span></span><span>
       </span><span>kk_rel_let</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s_rel_let</span></span><span class="main"><span>,</span></span><span> </span><span>kk_rel_if</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s_rel_if</span></span><span class="main"><span>,</span></span><span> </span><span>kk_union</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s_union</span></span><span class="main"><span>,</span></span><span>
       </span><span>kk_difference</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s_difference</span></span><span class="main"><span>,</span></span><span> </span><span>kk_override</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s_override</span></span><span class="main"><span>,</span></span><span>
       </span><span>kk_intersect</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s_intersect</span></span><span class="main"><span>,</span></span><span> </span><span>kk_product</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s_product</span></span><span class="main"><span>,</span></span><span> </span><span>kk_join</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s_join</span></span><span class="main"><span>,</span></span><span>
       </span><span>kk_closure</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s_closure</span></span><span class="main"><span>,</span></span><span> </span><span>kk_reflexive_closure</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s_reflexive_closure</span></span><span class="main"><span>,</span></span><span>
       </span><span>kk_comprehension</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s_comprehension</span></span><span class="main"><span>,</span></span><span> </span><span>kk_project</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s_project</span></span><span class="main"><span>,</span></span><span>
       </span><span>kk_project_seq</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s_project_seq</span></span><span class="main"><span>,</span></span><span> </span><span>kk_not3</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s_not3</span></span><span class="main"><span>,</span></span><span>
       </span><span>kk_nat_less</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s_nat_less</span></span><span class="main"><span>,</span></span><span> </span><span>kk_int_less</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s_int_less</span></span><span class="main"><span>}</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="main"><span>{</span></span><span>kk_all</span><span> </span><span class="main"><span>=</span></span><span> </span><span>curry</span><span> </span><span class="entity"><span>All</span></span><span class="main"><span>,</span></span><span> </span><span>kk_exist</span><span> </span><span class="main"><span>=</span></span><span> </span><span>curry</span><span> </span><span class="entity"><span>Exist</span></span><span class="main"><span>,</span></span><span>
       </span><span>kk_formula_let</span><span> </span><span class="main"><span>=</span></span><span> </span><span>curry</span><span> </span><span class="entity"><span>FormulaLet</span></span><span class="main"><span>,</span></span><span> </span><span>kk_formula_if</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>curry3</span></span><span> </span><span class="entity"><span>FormulaIf</span></span><span class="main"><span>,</span></span><span>
       </span><span>kk_or</span><span> </span><span class="main"><span>=</span></span><span> </span><span>curry</span><span> </span><span class="entity"><span>Or</span></span><span class="main"><span>,</span></span><span>kk_not</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Not</span></span><span class="main"><span>,</span></span><span> </span><span>kk_iff</span><span> </span><span class="main"><span>=</span></span><span> </span><span>curry</span><span> </span><span class="entity"><span>Iff</span></span><span class="main"><span>,</span></span><span> </span><span>kk_implies</span><span> </span><span class="main"><span>=</span></span><span> </span><span>curry</span><span>
       </span><span class="entity"><span>Implies</span></span><span class="main"><span>,</span></span><span> </span><span>kk_and</span><span> </span><span class="main"><span>=</span></span><span> </span><span>curry</span><span> </span><span class="entity"><span>And</span></span><span class="main"><span>,</span></span><span> </span><span>kk_subset</span><span> </span><span class="main"><span>=</span></span><span> </span><span>curry</span><span> </span><span class="entity"><span>Subset</span></span><span class="main"><span>,</span></span><span> </span><span>kk_rel_eq</span><span> </span><span class="main"><span>=</span></span><span> </span><span>curry</span><span>
       </span><span class="entity"><span>RelEq</span></span><span class="main"><span>,</span></span><span> </span><span>kk_no</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>No</span></span><span class="main"><span>,</span></span><span> </span><span>kk_lone</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Lone</span></span><span class="main"><span>,</span></span><span> </span><span>kk_one</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>One</span></span><span class="main"><span>,</span></span><span> </span><span>kk_some</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Some</span></span><span class="main"><span>,</span></span><span>
       </span><span>kk_rel_let</span><span> </span><span class="main"><span>=</span></span><span> </span><span>curry</span><span> </span><span class="entity"><span>RelLet</span></span><span class="main"><span>,</span></span><span> </span><span>kk_rel_if</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>curry3</span></span><span> </span><span class="entity"><span>RelIf</span></span><span class="main"><span>,</span></span><span> </span><span>kk_union</span><span> </span><span class="main"><span>=</span></span><span> </span><span>curry</span><span>
       </span><span class="entity"><span>Union</span></span><span class="main"><span>,</span></span><span> </span><span>kk_difference</span><span> </span><span class="main"><span>=</span></span><span> </span><span>curry</span><span> </span><span class="entity"><span>Difference</span></span><span class="main"><span>,</span></span><span> </span><span>kk_override</span><span> </span><span class="main"><span>=</span></span><span> </span><span>curry</span><span> </span><span class="entity"><span>Override</span></span><span class="main"><span>,</span></span><span>
       </span><span>kk_intersect</span><span> </span><span class="main"><span>=</span></span><span> </span><span>curry</span><span> </span><span class="entity"><span>Intersect</span></span><span class="main"><span>,</span></span><span> </span><span>kk_product</span><span> </span><span class="main"><span>=</span></span><span> </span><span>curry</span><span> </span><span class="entity"><span>Product</span></span><span class="main"><span>,</span></span><span>
       </span><span>kk_join</span><span> </span><span class="main"><span>=</span></span><span> </span><span>curry</span><span> </span><span class="entity"><span>Join</span></span><span class="main"><span>,</span></span><span> </span><span>kk_closure</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Closure</span></span><span class="main"><span>,</span></span><span>
       </span><span>kk_reflexive_closure</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ReflexiveClosure</span></span><span class="main"><span>,</span></span><span> </span><span>kk_comprehension</span><span> </span><span class="main"><span>=</span></span><span> </span><span>curry</span><span>
       </span><span class="entity"><span>Comprehension</span></span><span class="main"><span>,</span></span><span> </span><span>kk_project</span><span> </span><span class="main"><span>=</span></span><span> </span><span>curry</span><span> </span><span class="entity"><span>Project</span></span><span class="main"><span>,</span></span><span>
       </span><span>kk_project_seq</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>d_project_seq</span></span><span class="main"><span>,</span></span><span> </span><span>kk_not3</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>d_not3</span></span><span class="main"><span>,</span></span><span>
       </span><span>kk_nat_less</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>d_nat_less</span></span><span class="main"><span>,</span></span><span> </span><span>kk_int_less</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>d_int_less</span></span><span class="main"><span>}</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
</span></pre>
</body>

</html>