<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹~~/src/Tools/Argo/argo_rewr.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹~~/src/Tools/Argo/argo_rewr.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      Tools/Argo/argo_rewr.ML
    Author:     Sascha Boehme

Bottom-up rewriting of expressions based on rewrite rules and rewrite functions.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>ARGO_REWR</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="comment1"><span>(* conversions *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>conv</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Argo_Expr.expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Argo_Expr.expr</span></span><span> * </span><span class="entity"><span>Argo_Proof.conv</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> keep</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>conv</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> seq</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>conv</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>conv</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> args</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>conv</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>conv</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> rewr</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Argo_Proof.rewrite</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Argo_Expr.expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>conv</span></span><span>

  </span><span class="comment1"><span>(* context *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> context</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span>

  </span><span class="comment1"><span>(* rewriting *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> rewrite</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>conv</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> rewrite_top</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>conv</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> with_proof</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>conv</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Argo_Expr.expr</span></span><span> * </span><span class="entity"><span>Argo_Proof.proof</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Argo_Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.expr</span></span><span> * </span><span class="entity"><span>Argo_Proof.proof</span></span><span class="main"><span>)</span></span><span> * </span><span class="entity"><span>Argo_Proof.context</span></span><span>

  </span><span class="comment1"><span>(* normalizations *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> nnf</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> norm_prop</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> norm_ite</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> norm_eq</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> norm_add</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> norm_mul</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> norm_arith</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Argo_Rewr</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ARGO_REWR</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="comment1"><span>(* conversions *)</span></span><span>

</span><span class="comment1"><span>(*
  Conversions are atomic rewrite steps.
  For every conversion there is a corresponding inference step.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>conv</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Argo_Expr.expr</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Argo_Expr.expr</span></span><span> * </span><span class="entity"><span>Argo_Proof.conv</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>keep</span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>e</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Argo_Proof.keep_conv</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>seq</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>keep</span></span><span> </span><span class="entity"><span>e</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>seq</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>cv</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cv</span></span><span> </span><span class="entity"><span>e</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>seq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cv</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>cvs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>e</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cv</span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span>|&gt;&gt;</span><span> </span><span class="entity"><span>seq</span></span><span> </span><span class="entity"><span>cvs</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>e</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Argo_Proof.mk_then_conv</span></span><span> </span><span class="entity"><span>c1</span></span><span> </span><span class="entity"><span>c2</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>on_args</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>es</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>es</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>split_list</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>es</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>es</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Argo_Proof.mk_args_conv</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>cs</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="entity"><span>cv</span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>on_args</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>cv</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>e</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>all_args</span></span><span> </span><span class="entity"><span>cv</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>e</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>k'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>all_args</span></span><span> </span><span class="entity"><span>cv</span></span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>cv</span></span><span> </span><span class="entity"><span>e</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rewr</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>e</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Argo_Proof.mk_rewr_conv</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span>


</span><span class="comment1"><span>(* rewriting result *)</span></span><span>

</span><span class="comment1"><span>(*
  After rewriting an expression, further rewritings might be applicable. The result type is
  a simple means to control which parts of the rewriting result should be rewritten further.
  Only the top-most part of a result marked by R constructors is amenable to further rewritings.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>result</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>E</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> Argo_Expr.expr </span><span class="main"><span>|</span></span><span>
  </span><span class="entity"><span>R</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> Argo_Expr.kind * result list 

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>expr_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>e</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>expr_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ps</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>expr_of</span></span><span> </span><span class="entity"><span>ps</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>top_most</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>keep</span></span><span> </span><span class="entity"><span>e</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>top_most</span></span><span> </span><span class="entity"><span>cv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>R</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ps</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>seq</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>on_args</span></span><span> </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>top_most</span></span><span> </span><span class="entity"><span>cv</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ps</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cv</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>e</span></span><span>


</span><span class="comment1"><span>(* context *)</span></span><span>

</span><span class="comment1"><span>(*
  The context stores lists of rewritings for every expression kind. A rewriting maps the
  arguments of an expression with matching kind to an optional rewriting result. Each
  rewriting might decide whether it is applicable to the given expression arguments and
  might return no result. The first rewriting that produces a result is applied.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Kindtab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Table</span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Argo_Expr.kind</span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ord</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Argo_Expr.kind_ord</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Argo_Expr.expr</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.rewrite</span></span><span> * </span><span class="entity"><span>result</span></span><span class="main"><span>)</span></span><span> </span><span>option</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span>Kindtab.table</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Kindtab.empty</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_func</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Kindtab.map_default</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>fs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>fs</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>f</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_func'</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_func</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unary</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_func'</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>e</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"not unary"</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>binary</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_func'</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>e1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>e1</span></span><span> </span><span class="entity"><span>e2</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"not binary"</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ternary</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_func'</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>e1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>e3</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>e1</span></span><span> </span><span class="entity"><span>e2</span></span><span> </span><span class="entity"><span>e3</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"not ternary"</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>nary</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_func</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>f</span></span><span>


</span><span class="comment1"><span>(* rewriting *)</span></span><span>

</span><span class="comment1"><span>(*
  Rewriting proceeds bottom-up. The top-most result of a rewriting step is rewritten again
  bottom-up, if necessary. Only the first rewriting that produces a result for a given
  expression is applied. N-ary expressions are flattened before they are rewritten. For
  instance, flattening (and p (and q r)) produces (and p q r) where p, q and r are no
  conjunctions.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>first_rewr</span></span><span> </span><span class="entity"><span>cv</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>es</span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>get_first</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>es</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Kindtab.lookup_list</span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>keep</span></span><span> </span><span class="entity"><span>e</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>res</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>seq</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rewr</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>expr_of</span></span><span> </span><span class="entity"><span>res</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>top_most</span></span><span> </span><span class="entity"><span>cv</span></span><span> </span><span class="entity"><span>res</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>e</span></span><span class="main"><span>)</span></span><span> 

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>all_args_of</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>e</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>es</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>k'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>all_args_of</span></span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>es</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>e</span></span><span class="main"><span>]</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>kind_depth_of</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>es</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>k'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>+</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>Integer.max</span><span> </span><span>o</span><span> </span><span class="entity"><span>kind_depth_of</span></span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>es</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>norm_kind</span></span><span> </span><span class="entity"><span>cv</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>e</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>es</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>es</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>Argo_Expr.is_nary</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>kind_depth_of</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>e</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>all_args_of</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>e</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>es</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>first_rewr</span></span><span> </span><span class="entity"><span>cv</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>es</span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>norm_args</span></span><span> </span><span class="entity"><span>cv</span></span><span> </span><span class="entity"><span>d</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>e</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>d</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>keep</span></span><span> </span><span class="entity"><span>e</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>Argo_Expr.is_nary</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>all_args</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>d</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>e</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>d</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>e</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>norm</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="entity"><span>d</span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>seq</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>norm_args</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>norm</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>d</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>norm_kind</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>norm</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cx</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>e</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rewrite</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>norm</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span>   </span><span class="comment1"><span>(* bottom-up rewriting *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rewrite_top</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>norm</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>   </span><span class="comment1"><span>(* top-most rewriting *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>with_proof</span></span><span> </span><span class="entity"><span>cv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>e</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prf</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>e</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cv</span></span><span> </span><span class="entity"><span>e</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Argo_Proof.mk_rewrite</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>prf</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>e</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prf</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(* result constructors *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_nary</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>e</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk_nary</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>e</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>e</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk_nary</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>es</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>es</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>e_true</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>Argo_Expr.true_expr</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>e_false</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>Argo_Expr.false_expr</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_not</span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Not</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>e</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_and</span></span><span> </span><span class="entity"><span>es</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_nary</span></span><span> </span><span class="entity"><span>Argo_Expr.And</span></span><span> </span><span class="entity"><span>e_true</span></span><span> </span><span class="entity"><span>es</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_or</span></span><span> </span><span class="entity"><span>es</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_nary</span></span><span> </span><span class="entity"><span>Argo_Expr.Or</span></span><span> </span><span class="entity"><span>e_false</span></span><span> </span><span class="entity"><span>es</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_iff</span></span><span> </span><span class="entity"><span>e1</span></span><span> </span><span class="entity"><span>e2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Iff</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>e1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_ite</span></span><span> </span><span class="entity"><span>e1</span></span><span> </span><span class="entity"><span>e2</span></span><span> </span><span class="entity"><span>e3</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Ite</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>e1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>e3</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_num</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.mk_num</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_neg</span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Neg</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>e</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_add</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"bad addition"</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk_add</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>e</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>e</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk_add</span></span><span> </span><span class="entity"><span>es</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Add</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>es</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_sub</span></span><span> </span><span class="entity"><span>e1</span></span><span> </span><span class="entity"><span>e2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Sub</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>e1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_mul</span></span><span> </span><span class="entity"><span>e1</span></span><span> </span><span class="entity"><span>e2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Mul</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>e1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_div</span></span><span> </span><span class="entity"><span>e1</span></span><span> </span><span class="entity"><span>e2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Div</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>e1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_le</span></span><span> </span><span class="entity"><span>e1</span></span><span> </span><span class="entity"><span>e2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Le</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>e1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_le'</span></span><span> </span><span class="entity"><span>e1</span></span><span> </span><span class="entity"><span>e2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_le</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_eq</span></span><span> </span><span class="entity"><span>e1</span></span><span> </span><span class="entity"><span>e2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Eq</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>e1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>


</span><span class="comment1"><span>(* rewriting to negation normal form *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rewr_not</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="entity"><span>exp</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>exp</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.True</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Not_True</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>e_false</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.False</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Not_False</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>e_true</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Not</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>e</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Not_Not</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.And</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>es</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Not_And</span></span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>es</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_or</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_not</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>E</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>es</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Or</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>es</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Not_Or</span></span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>es</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_and</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_not</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>E</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>es</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Iff</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Not</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>e1</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Not_Iff</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_iff</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Iff</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>e1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Not</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>e2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Not_Iff</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_iff</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Iff</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>e1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> 
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Not_Iff</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_iff</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_not</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nnf</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unary</span></span><span> </span><span class="entity"><span>Argo_Expr.Not</span></span><span> </span><span class="entity"><span>rewr_not</span></span><span>


</span><span class="comment1"><span>(* propositional normalization *)</span></span><span>

</span><span class="comment1"><span>(*
  Propositional expressions are transformed into literals in the clausifier. Having
  fewer literals results in faster solver execution. Normalizing propositional expressions
  turns similar expressions into equal expressions, for which the same literal can be used.
  The clausifier expects that only negation, disjunction, conjunction and equivalence form
  propositional expressions. Expressions may be simplified to truth or falsity, but both
  truth and falsity eventually occur nowhere inside expressions.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>first_index</span></span><span> </span><span class="entity"><span>pred</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>find_index</span><span> </span><span class="entity"><span>pred</span></span><span> </span><span class="entity"><span>xs</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>&gt;=</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rewr_zero</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>zero</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>es</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>zero</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>first_index</span></span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="entity"><span>Argo_Expr.eq_expr</span></span><span> </span><span class="entity"><span>zero</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>es</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rewr_dual</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>zero</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>duals</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>duals</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>duals</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>e</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>es</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>first_index</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.dual_expr</span></span><span> </span><span class="entity"><span>e</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>es</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>duals</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>es</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>i'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>i'</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>zero</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>duals</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rewr_sort</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>one</span></span><span> </span><span class="entity"><span>mk</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>es</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>es</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>e</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>Argo_Expr.eq_expr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>e</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>one</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>I</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Argo_Exprtab.cons_list</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>e</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>e</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>es</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>is</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>e</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>es</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>is</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>es</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>iss</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Argo_Exprtab.fold_rev</span><span> </span><span class="entity"><span>dest</span></span><span> </span><span class="main"><span>(</span></span><span>fold_index</span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="entity"><span>es</span></span><span> </span><span>Argo_Exprtab.empty</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>identity</span></span><span> </span><span class="entity"><span>is</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>is</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map_index</span><span> </span><span>I</span><span> </span><span class="entity"><span>is</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>iss</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>one</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>identity</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>hd</span><span> </span><span class="entity"><span>iss</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>NONE</span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>iss</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>es</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rewr_imp</span></span><span> </span><span class="entity"><span>e1</span></span><span> </span><span class="entity"><span>e2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Imp</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_or</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>mk_not</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rewr_iff</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>e1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="entity"><span>exp1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>e2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="entity"><span>exp2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>exp1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>exp2</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.True</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Iff_True</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.False</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Iff_False</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_not</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.True</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Iff_True</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e1</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.False</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Iff_False</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_not</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Not</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>e1'</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Not</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>e2'</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Iff_Not_Not</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_iff</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e1'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e2'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>Argo_Expr.dual_expr</span></span><span> </span><span class="entity"><span>e1</span></span><span> </span><span class="entity"><span>e2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Iff_Dual</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>e_false</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Argo_Expr.expr_ord</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>e1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span>EQUAL</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Iff_Refl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>e_true</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>GREATER</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Iff_Symm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_iff</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>LESS</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>norm_prop</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>nary</span></span><span> </span><span class="entity"><span>Argo_Expr.And</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rewr_zero</span></span><span> </span><span class="entity"><span>Argo_Proof.Rewr_And_False</span></span><span> </span><span class="entity"><span>Argo_Expr.false_expr</span></span><span class="main"><span>)</span></span><span> </span><span>#&gt;</span><span>
  </span><span class="entity"><span>nary</span></span><span> </span><span class="entity"><span>Argo_Expr.And</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rewr_dual</span></span><span> </span><span class="entity"><span>Argo_Proof.Rewr_And_Dual</span></span><span> </span><span class="entity"><span>e_false</span></span><span class="main"><span>)</span></span><span> </span><span>#&gt;</span><span>
  </span><span class="entity"><span>nary</span></span><span> </span><span class="entity"><span>Argo_Expr.And</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rewr_sort</span></span><span> </span><span class="entity"><span>Argo_Proof.Rewr_And_Sort</span></span><span> </span><span class="entity"><span>Argo_Expr.true_expr</span></span><span> </span><span class="entity"><span>mk_and</span></span><span class="main"><span>)</span></span><span> </span><span>#&gt;</span><span>
  </span><span class="entity"><span>nary</span></span><span> </span><span class="entity"><span>Argo_Expr.Or</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rewr_zero</span></span><span> </span><span class="entity"><span>Argo_Proof.Rewr_Or_True</span></span><span> </span><span class="entity"><span>Argo_Expr.true_expr</span></span><span class="main"><span>)</span></span><span> </span><span>#&gt;</span><span>
  </span><span class="entity"><span>nary</span></span><span> </span><span class="entity"><span>Argo_Expr.Or</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rewr_dual</span></span><span> </span><span class="entity"><span>Argo_Proof.Rewr_Or_Dual</span></span><span> </span><span class="entity"><span>e_true</span></span><span class="main"><span>)</span></span><span> </span><span>#&gt;</span><span>
  </span><span class="entity"><span>nary</span></span><span> </span><span class="entity"><span>Argo_Expr.Or</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rewr_sort</span></span><span> </span><span class="entity"><span>Argo_Proof.Rewr_Or_Sort</span></span><span> </span><span class="entity"><span>Argo_Expr.false_expr</span></span><span> </span><span class="entity"><span>mk_or</span></span><span class="main"><span>)</span></span><span> </span><span>#&gt;</span><span>
  </span><span class="entity"><span>binary</span></span><span> </span><span class="entity"><span>Argo_Expr.Imp</span></span><span> </span><span class="entity"><span>rewr_imp</span></span><span> </span><span>#&gt;</span><span>
  </span><span class="entity"><span>binary</span></span><span> </span><span class="entity"><span>Argo_Expr.Iff</span></span><span> </span><span class="entity"><span>rewr_iff</span></span><span>


</span><span class="comment1"><span>(* normalization of if-then-else expressions *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rewr_ite</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.True</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Ite_True</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rewr_ite</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.False</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Ite_False</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rewr_ite</span></span><span> </span><span class="entity"><span>e1</span></span><span> </span><span class="entity"><span>e2</span></span><span> </span><span class="entity"><span>e3</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>Argo_Expr.type_of</span></span><span> </span><span class="entity"><span>e2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Argo_Expr.Bool</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
        </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Ite_Prop</span></span><span class="main"><span>,</span></span><span>
          </span><span class="entity"><span>mk_and</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>mk_or</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span class="entity"><span>mk_not</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e3</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e3</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>Argo_Expr.eq_expr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>e2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>e3</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Ite_Eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>norm_ite</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ternary</span></span><span> </span><span class="entity"><span>Argo_Expr.Ite</span></span><span> </span><span class="entity"><span>rewr_ite</span></span><span>


</span><span class="comment1"><span>(* normalization of equality *)</span></span><span>

</span><span class="comment1"><span>(*
  In a normalized equality, the left-hand side is less than the right-hand side with respect to
  the expression order.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rewr_eq</span></span><span> </span><span class="entity"><span>e1</span></span><span> </span><span class="entity"><span>e2</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Argo_Expr.expr_ord</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>e1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>EQUAL</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Eq_Refl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>e_true</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>GREATER</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Eq_Symm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>LESS</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>norm_eq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>binary</span></span><span> </span><span class="entity"><span>Argo_Expr.Eq</span></span><span> </span><span class="entity"><span>rewr_eq</span></span><span>


</span><span class="comment1"><span>(* arithmetic normalization *)</span></span><span>

</span><span class="comment1"><span>(* expression functions *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>scale</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@</span></span><span>0</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>mk_num</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@</span></span><span>0</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@</span></span><span>1</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>e</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>mk_mul</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_num</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>e</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_factor</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Mul</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Num</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>n</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dest_factor</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@</span></span><span>1</span></span></span><span>


</span><span class="comment1"><span>(*
  Products are normalized either to a number or to the monomial form
    a * x
  where a is a non-zero number and is a variable or a product of variables.
  If x is a product, it contains no number factors. If x is a product, it is sorted
  based on the expression order. Hence, the product z * y * x will be rewritten
  to x * y * z. The coefficient a is dropped if it is equal to one;
  instead of 1 * x the expression x is used.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_mul_comm</span></span><span> </span><span class="entity"><span>e1</span></span><span> </span><span class="entity"><span>e2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Mul_Comm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_mul</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_mul_assocr</span></span><span> </span><span class="entity"><span>e1</span></span><span> </span><span class="entity"><span>e2</span></span><span> </span><span class="entity"><span>e3</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Mul_Assoc</span></span><span> </span><span class="entity"><span>Argo_Proof.Right</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_mul</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_mul</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e3</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

  </span><span class="comment1"><span>(* commute numbers to the left *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rewr_mul</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Num</span></span><span> </span><span class="entity"><span>n1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Num</span></span><span> </span><span class="entity"><span>n2</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Mul_Nums</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_num</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n1</span></span><span> </span><span>*</span><span> </span><span class="entity"><span>n2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rewr_mul</span></span><span> </span><span class="entity"><span>e1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>e2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Num</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_mul_comm</span></span><span> </span><span class="entity"><span>e1</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rewr_mul</span></span><span> </span><span class="entity"><span>e1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Mul</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>e2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Num</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>e3</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_mul_assocr</span></span><span> </span><span class="entity"><span>e1</span></span><span> </span><span class="entity"><span>e2</span></span><span> </span><span class="entity"><span>e3</span></span><span class="main"><span>)</span></span><span>
  </span><span class="comment1"><span>(* apply distributivity *)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rewr_mul</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Add</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>es</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Mul_Sum</span></span><span> </span><span class="entity"><span>Argo_Proof.Left</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_add</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>e'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>mk_mul</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>es</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rewr_mul</span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Add</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>es</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Mul_Sum</span></span><span> </span><span class="entity"><span>Argo_Proof.Right</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_add</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_mul</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>E</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>es</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="comment1"><span>(* commute non-numerical factors to the right *)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rewr_mul</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Mul</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>e1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>e3</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Mul_Assoc</span></span><span> </span><span class="entity"><span>Argo_Proof.Left</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_mul</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_mul</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e3</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="comment1"><span>(* reduce special products *)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rewr_mul</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>e1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Num</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>e2</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@</span></span><span>0</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Mul_Zero</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e1</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@</span></span><span>1</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Mul_One</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span>
  </span><span class="comment1"><span>(* combine products with quotients *)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rewr_mul</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Div</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>e1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>e3</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Mul_Div</span></span><span> </span><span class="entity"><span>Argo_Proof.Left</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_div</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_mul</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e3</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rewr_mul</span></span><span> </span><span class="entity"><span>e1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Div</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>e2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>e3</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Mul_Div</span></span><span> </span><span class="entity"><span>Argo_Proof.Right</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_div</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_mul</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e3</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="comment1"><span>(* sort non-numerical factors *)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rewr_mul</span></span><span> </span><span class="entity"><span>e1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Mul</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>e2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>e3</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Argo_Expr.expr_ord</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>e1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>GREATER</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_mul_assocr</span></span><span> </span><span class="entity"><span>e1</span></span><span> </span><span class="entity"><span>e2</span></span><span> </span><span class="entity"><span>e3</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rewr_mul</span></span><span> </span><span class="entity"><span>e1</span></span><span> </span><span class="entity"><span>e2</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Argo_Expr.expr_ord</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>e1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span>GREATER</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_mul_comm</span></span><span> </span><span class="entity"><span>e1</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(*
  Quotients are normalized either to a number or to the monomial form
    a * x
  where a is a non-zero number and x is a variable. If x is a quotient,
  both dividend and divisor are not a number. The dividend and the divisor may both
  be products. If so, neither dividend nor divisor contains a numerical factor.
  Both dividend and divisor are not themselves quotients again. The dividend is never
  a sum; distributivity is applied to such quotients. The coefficient a is dropped
  if it is equal to one; instead of 1 * x the expression x is used.

  Several non-linear expressions can be rewritten to the described normal form.
  For example, the expressions (x * z) / y and x * (z / y) will be treated as equal
  variables by the arithmetic decision procedure. Yet, non-linear expression rewriting
  is incomplete and keeps several other expressions unchanged.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rewr_div</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Div</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>e1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>e3</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Div_Div</span></span><span> </span><span class="entity"><span>Argo_Proof.Left</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_div</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_mul</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e3</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rewr_div</span></span><span> </span><span class="entity"><span>e1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Div</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>e2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>e3</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Div_Div</span></span><span> </span><span class="entity"><span>Argo_Proof.Right</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_div</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_mul</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e3</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rewr_div</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Num</span></span><span> </span><span class="entity"><span>n1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Num</span></span><span> </span><span class="entity"><span>n2</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@</span></span><span>0</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>NONE</span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Div_Nums</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_num</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n1</span></span><span> </span><span>/</span><span> </span><span class="entity"><span>n2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rewr_div</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Num</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@</span></span><span>0</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Div_Zero</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_num</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@</span></span><span>0</span></span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@</span></span><span>1</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>NONE</span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Div_Num</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Left</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>scale</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_div</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_num</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@</span></span><span>1</span></span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rewr_div</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Mul</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Num</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>e1</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>e2</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Div_Mul</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Left</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>scale</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_div</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rewr_div</span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Num</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@</span></span><span>0</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>NONE</span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@</span></span><span>1</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Div_One</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Div_Num</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Right</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>scale</span></span><span> </span><span class="main"><span>(</span></span><span>Rat.inv</span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rewr_div</span></span><span> </span><span class="entity"><span>e1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Mul</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Num</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Div_Mul</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Right</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>scale</span></span><span> </span><span class="main"><span>(</span></span><span>Rat.inv</span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_div</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rewr_div</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Add</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>es</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Div_Sum</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_add</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>e'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>mk_div</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>es</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rewr_div</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>


</span><span class="comment1"><span>(*
  Sums are flattened and normalized to the polynomial form
    a_0 + a_1 * x_1 + ... + a_n * x_n
  where all variables x_i are disjoint and where all coefficients a_i are
  non-zero numbers. Coefficients equal to one are dropped; instead of 1 * x_i
  the reduced monom x_i is used. The variables x_i are ordered based on the
  expression order to reduce the number of problem literals by sharing equal
  expressions.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_monom_expr</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>etab</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>etab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Argo_Exprtab.map_default</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>e</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@</span></span><span>0</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>Rat.add</span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>etab</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span>Option.map</span><span> </span><span>fst</span><span> </span><span class="main"><span>(</span></span><span>Argo_Exprtab.lookup</span><span> </span><span class="entity"><span>etab</span></span><span> </span><span class="entity"><span>e</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>etab</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_monom</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Num</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>etab</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>etab</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_monom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Mul</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Num</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>e</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>add_monom_expr</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="entity"><span>x</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_monom</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>e</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>add_monom_expr</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@</span></span><span>1</span></span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="entity"><span>x</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rewr_add</span></span><span> </span><span class="entity"><span>d</span></span><span> </span><span class="entity"><span>es</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>etab</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_index</span><span> </span><span class="entity"><span>add_monom</span></span><span> </span><span class="entity"><span>es</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@</span></span><span>0</span></span></span><span class="main"><span>,</span></span><span> </span><span>Argo_Exprtab.empty</span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>es</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Argo_Exprtab.fold_rev</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>e</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@</span></span><span>0</span></span></span><span> </span><span>?</span><span> </span><span>cons</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>scale</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>etab</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>s</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@</span></span><span>0</span></span></span><span> </span><span>?</span><span> </span><span>cons</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_num</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@</span></span><span>0</span></span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_num</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@</span></span><span>0</span></span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>split_list</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="entity"><span>p1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p2</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>d</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>eq_list</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ps</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>NONE</span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Add</span></span><span> </span><span class="entity"><span>ps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_add</span></span><span> </span><span class="entity"><span>es</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(*
  Equations are normalized to the normal form
    a_0 + a_1 * x_1 + ... + a_n * x_n = b
  or
    b = a_0 + a_1 * x_1 + ... + a_n * x_n
  An equation in normal form is rewritten to a conjunction of two non-strict inequalities. 
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rewr_eq_le</span></span><span> </span><span class="entity"><span>e1</span></span><span> </span><span class="entity"><span>e2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Eq_Le</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_and</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>mk_le'</span></span><span> </span><span class="entity"><span>e1</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_le'</span></span><span> </span><span class="entity"><span>e2</span></span><span> </span><span class="entity"><span>e1</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rewr_arith_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Num</span></span><span> </span><span class="entity"><span>n1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Num</span></span><span> </span><span class="entity"><span>n2</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>n2</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Eq_Nums</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>e_true</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>e_false</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rewr_arith_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>e1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Num</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>e2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rewr_eq_le</span></span><span> </span><span class="entity"><span>e1</span></span><span> </span><span class="entity"><span>e2</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rewr_arith_eq</span></span><span> </span><span class="entity"><span>e1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>e2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Num</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rewr_eq_le</span></span><span> </span><span class="entity"><span>e1</span></span><span> </span><span class="entity"><span>e2</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rewr_arith_eq</span></span><span> </span><span class="entity"><span>e1</span></span><span> </span><span class="entity"><span>e2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Eq_Sub</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_sub</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_num</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@</span></span><span>0</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_arith</span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Argo_Expr.Real</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.type_of</span></span><span> </span><span class="entity"><span>e</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rewr_eq</span></span><span> </span><span class="entity"><span>e1</span></span><span> </span><span class="entity"><span>e2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_arith</span></span><span> </span><span class="entity"><span>e1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>rewr_arith_eq</span></span><span> </span><span class="entity"><span>e1</span></span><span> </span><span class="entity"><span>e2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span>


</span><span class="comment1"><span>(*
  Arithmetic inequalities (less and less-than) are normalized to the normal form
    a_0 + a_1 * x_1 + ... + a_n * x_n ~ b
  or
    b ~ a_0 + a_1 * x_1 + ... + a_n * x_n
  such that most of the coefficients a_i are positive.

  Arithmetic inequalities of the form
    a * x ~ b
  or
    b ~ a * x
  are normalized to the form
    x ~ c
  or
    c ~ x
  where c is a number.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>norm_cmp_mul</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>e1</span></span><span> </span><span class="entity"><span>e2</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>es</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>&gt;</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@</span></span><span>0</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>e1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>e2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>e1</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Ineq_Mul</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>scale</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>E</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>es</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>count_factors</span></span><span> </span><span class="entity"><span>pred</span></span><span> </span><span class="entity"><span>es</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>pred</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest_factor</span></span><span> </span><span class="entity"><span>e</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Integer.add</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>es</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>norm_cmp_swap</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>e1</span></span><span> </span><span class="entity"><span>e2</span></span><span> </span><span class="entity"><span>es</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>count_factors</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>&gt;</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@</span></span><span>0</span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>es</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>neg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>count_factors</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>&lt;</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@</span></span><span>0</span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>es</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>keep</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span>&gt;</span><span> </span><span class="entity"><span>neg</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pos</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>neg</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>dest_factor</span></span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>es</span></span><span class="main"><span>)</span></span><span> </span><span>&gt;</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@</span></span><span>0</span></span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>keep</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>NONE</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>norm_cmp_mul</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>e1</span></span><span> </span><span class="entity"><span>e2</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@</span></span><span class="main"><span>~</span></span><span>1</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>norm_cmp1</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>e1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>e2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Mul</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Num</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>norm_cmp_mul</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>e1</span></span><span> </span><span class="entity"><span>e2</span></span><span> </span><span class="main"><span>(</span></span><span>Rat.inv</span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>norm_cmp1</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>e1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>e2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Add</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Num</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk</span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_add</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_num</span></span><span> </span><span class="main"><span>(</span></span><span>~</span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Ineq_Add</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span class="main"><span>,</span></span><span> </span><span>~</span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>mk</span></span><span> </span><span class="entity"><span>e1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>norm_cmp1</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>e1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>e2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Add</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>es</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>norm_cmp_swap</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>e1</span></span><span> </span><span class="entity"><span>e2</span></span><span> </span><span class="entity"><span>es</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>norm_cmp1</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rewr_cmp</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>pred</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Num</span></span><span> </span><span class="entity"><span>n1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Num</span></span><span> </span><span class="entity"><span>n2</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pred</span></span><span> </span><span class="entity"><span>n1</span></span><span> </span><span class="entity"><span>n2</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Ineq_Nums</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>e_true</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>e_false</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rewr_cmp</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>e1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Num</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>e2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>norm_cmp1</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span>I</span><span> </span><span class="entity"><span>e1</span></span><span> </span><span class="entity"><span>e2</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rewr_cmp</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>e1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>e2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Num</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>norm_cmp1</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span>rev</span><span> </span><span class="entity"><span>e2</span></span><span> </span><span class="entity"><span>e1</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rewr_cmp</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>e1</span></span><span> </span><span class="entity"><span>e2</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Ineq_Sub</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>mk_sub</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_num</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@</span></span><span>0</span></span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>


</span><span class="comment1"><span>(*
  Arithmetic expressions are normalized in order to reduce the number of
  problem literals. Arithmetically equal expressions are normalized to
  syntactically equal expressions as much as possible.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rewr_neg</span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Neg</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>scale</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@</span></span><span class="main"><span>~</span></span><span>1</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rewr_sub</span></span><span> </span><span class="entity"><span>e1</span></span><span> </span><span class="entity"><span>e2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Sub</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_add</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>scale</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@</span></span><span class="main"><span>~</span></span><span>1</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rewr_abs</span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Abs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_ite</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_le</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_num</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@</span></span><span>0</span></span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_neg</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rewr_min</span></span><span> </span><span class="entity"><span>e1</span></span><span> </span><span class="entity"><span>e2</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Argo_Expr.expr_ord</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>e1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>LESS</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Min_Lt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_ite</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_le'</span></span><span> </span><span class="entity"><span>e1</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>EQUAL</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Min_Eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e1</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>GREATER</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Min_Gt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_ite</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_le'</span></span><span> </span><span class="entity"><span>e2</span></span><span> </span><span class="entity"><span>e1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rewr_max</span></span><span> </span><span class="entity"><span>e1</span></span><span> </span><span class="entity"><span>e2</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Argo_Expr.expr_ord</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>e1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>LESS</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Max_Lt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_ite</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_le'</span></span><span> </span><span class="entity"><span>e1</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>EQUAL</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Max_Eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e1</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>GREATER</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Proof.Rewr_Max_Gt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_ite</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_le'</span></span><span> </span><span class="entity"><span>e2</span></span><span> </span><span class="entity"><span>e1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>E</span></span><span> </span><span class="entity"><span>e2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>norm_add</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>nary</span></span><span> </span><span class="entity"><span>Argo_Expr.Add</span></span><span> </span><span class="entity"><span>rewr_add</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>norm_mul</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>binary</span></span><span> </span><span class="entity"><span>Argo_Expr.Mul</span></span><span> </span><span class="entity"><span>rewr_mul</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>norm_arith</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>unary</span></span><span> </span><span class="entity"><span>Argo_Expr.Neg</span></span><span> </span><span class="entity"><span>rewr_neg</span></span><span> </span><span>#&gt;</span><span>
  </span><span class="entity"><span>binary</span></span><span> </span><span class="entity"><span>Argo_Expr.Sub</span></span><span> </span><span class="entity"><span>rewr_sub</span></span><span> </span><span>#&gt;</span><span>
  </span><span class="entity"><span>norm_mul</span></span><span> </span><span>#&gt;</span><span>
  </span><span class="entity"><span>binary</span></span><span> </span><span class="entity"><span>Argo_Expr.Div</span></span><span> </span><span class="entity"><span>rewr_div</span></span><span> </span><span>#&gt;</span><span>
  </span><span class="entity"><span>norm_add</span></span><span> </span><span>#&gt;</span><span>
  </span><span class="entity"><span>binary</span></span><span> </span><span class="entity"><span>Argo_Expr.Min</span></span><span> </span><span class="entity"><span>rewr_min</span></span><span> </span><span>#&gt;</span><span>
  </span><span class="entity"><span>binary</span></span><span> </span><span class="entity"><span>Argo_Expr.Max</span></span><span> </span><span class="entity"><span>rewr_max</span></span><span> </span><span>#&gt;</span><span>
  </span><span class="entity"><span>unary</span></span><span> </span><span class="entity"><span>Argo_Expr.Abs</span></span><span> </span><span class="entity"><span>rewr_abs</span></span><span> </span><span>#&gt;</span><span>
  </span><span class="entity"><span>binary</span></span><span> </span><span class="entity"><span>Argo_Expr.Eq</span></span><span> </span><span class="entity"><span>rewr_eq</span></span><span> </span><span>#&gt;</span><span>
  </span><span class="entity"><span>binary</span></span><span> </span><span class="entity"><span>Argo_Expr.Le</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rewr_cmp</span></span><span> </span><span class="entity"><span>Argo_Expr.Le</span></span><span> </span><span class="entity"><span>Argo_Proof.Le</span></span><span> </span><span>Rat.le</span><span class="main"><span>)</span></span><span> </span><span>#&gt;</span><span>
  </span><span class="entity"><span>binary</span></span><span> </span><span class="entity"><span>Argo_Expr.Lt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rewr_cmp</span></span><span> </span><span class="entity"><span>Argo_Expr.Lt</span></span><span> </span><span class="entity"><span>Argo_Proof.Lt</span></span><span> </span><span>Rat.lt</span><span class="main"><span>)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span></pre>
</body>

</html>