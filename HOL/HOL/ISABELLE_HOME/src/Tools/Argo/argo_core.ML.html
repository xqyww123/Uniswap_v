<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹~~/src/Tools/Argo/argo_core.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹~~/src/Tools/Argo/argo_core.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      Tools/Argo/argo_core.ML
    Author:     Sascha Boehme

Core of the Argo theorem prover implementing the DPLL(T) loop.

The implementation is based on:

  Harald Ganzinger, George Hagen, Robert Nieuwenhuis, Albert Oliveras,
  Cesare Tinelli. DPLL(T): Fast decision procedures. In Lecture Notes in
  Computer Science, volume 3114, pages 175-188. Springer, 2004.

  Robert Nieuwenhuis, Albert Oliveras, Cesare Tinelli. Solving SAT and
  SAT modulo theories: From an abstract Davis-Putnam-Logemann-Loveland
  procedure to DPLL(T). In Journal of the ACM, volume 53(6), pages
  937-977.  ACM, 2006.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>ARGO_CORE</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="comment1"><span>(* context *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> context</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span>

  </span><span class="comment1"><span>(* enriching the context *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> identify</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Argo_Term.item</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Argo_Term.identified</span></span><span> * </span><span class="entity"><span>context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_atom</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Argo_Term.item</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Argo_Term.identified</span></span><span> * </span><span class="entity"><span>context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_axiom</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Argo_Cls.clause</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context</span></span><span>

  </span><span class="comment1"><span>(* DPLL(T) loop *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> run</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="comment1"><span>(* raises Argo_Proof.UNSAT *)</span></span><span>

  </span><span class="comment1"><span>(* model *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> model_of</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> * </span><span class="entity"><span>Argo_Expr.typ</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span>option</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Argo_Core</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>ARGO_CORE</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="comment1"><span>(* context *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>
  </span><span>terms</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Argo_Term.context</span></span><span class="main"><span>,</span></span><span> </span><span class="comment1"><span>(* the term context to identify equal expressions *)</span></span><span>
  </span><span>iter</span><span class="main"><span>:</span></span><span> </span><span>int</span><span class="main"><span>,</span></span><span> </span><span class="comment1"><span>(* the current iteration of the search *)</span></span><span>
  </span><span>cdcl</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Argo_Cdcl.context</span></span><span class="main"><span>,</span></span><span> </span><span class="comment1"><span>(* the context of the propositional solver *)</span></span><span>
  </span><span>thy</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Argo_Thy.context</span></span><span class="main"><span>}</span></span><span> </span><span class="comment1"><span>(* the context of the theory solver *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_context</span></span><span> </span><span class="entity"><span>terms</span></span><span> </span><span class="entity"><span>iter</span></span><span> </span><span class="entity"><span>cdcl</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>terms</span><span class="main"><span>=</span></span><span class="entity"><span>terms</span></span><span class="main"><span>,</span></span><span> </span><span>iter</span><span class="main"><span>=</span></span><span class="entity"><span>iter</span></span><span class="main"><span>,</span></span><span> </span><span>cdcl</span><span class="main"><span>=</span></span><span class="entity"><span>cdcl</span></span><span class="main"><span>,</span></span><span> </span><span>thy</span><span class="main"><span>=</span></span><span class="entity"><span>thy</span></span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_context</span></span><span> </span><span class="entity"><span>Argo_Term.context</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>Argo_Cdcl.context</span></span><span> </span><span class="entity"><span>Argo_Thy.context</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>backjump</span></span><span> </span><span class="entity"><span>levels</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>funpow</span><span> </span><span class="entity"><span>levels</span></span><span> </span><span class="entity"><span>Argo_Thy.backtrack</span></span><span>


</span><span class="comment1"><span>(* enriching the context *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>identify</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>terms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>iter</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cdcl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>identified</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>terms</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Argo_Term.identify_item</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>terms</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>identified</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_context</span></span><span> </span><span class="entity"><span>terms</span></span><span> </span><span class="entity"><span>iter</span></span><span> </span><span class="entity"><span>cdcl</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_atom</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>identify</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>cx</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="entity"><span>known</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Term.Known</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>known</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>atom</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Argo_Term.New</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>terms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>iter</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cdcl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Cdcl.add_atom</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>cdcl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Argo_Thy.add_atom</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>cdcl</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>atom</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_context</span></span><span> </span><span class="entity"><span>terms</span></span><span> </span><span class="entity"><span>iter</span></span><span> </span><span class="entity"><span>cdcl</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cdcl</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>lit</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Argo_Cdcl.assume</span></span><span> </span><span class="entity"><span>Argo_Thy.explain</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>cdcl</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cdcl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>atom</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_context</span></span><span> </span><span class="entity"><span>terms</span></span><span> </span><span class="entity"><span>iter</span></span><span> </span><span class="entity"><span>cdcl</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"bad conflict with new atom"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_axiom</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>terms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>iter</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cdcl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>levels</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cdcl</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Argo_Cdcl.add_axiom</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="entity"><span>cdcl</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>mk_context</span></span><span> </span><span class="entity"><span>terms</span></span><span> </span><span class="entity"><span>iter</span></span><span> </span><span class="entity"><span>cdcl</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>backjump</span></span><span> </span><span class="entity"><span>levels</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(* DPLL(T) loop: CDCL with theories *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>implications</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>None</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Implications</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Conflict</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> Argo_Cls.clause

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cdcl_assume</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>cdcl</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cdcl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cdcl_assume</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lit</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>lits</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cdcl</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="comment1"><span>(* assume an assignment deduced by the theory solver *)</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Argo_Cdcl.assume</span></span><span> </span><span class="entity"><span>Argo_Thy.explain</span></span><span> </span><span class="entity"><span>lit</span></span><span> </span><span class="entity"><span>cdcl</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cdcl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>cdcl_assume</span></span><span> </span><span class="entity"><span>lits</span></span><span> </span><span class="entity"><span>cdcl</span></span><span> </span><span class="entity"><span>thy</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>cls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cdcl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>cls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cdcl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>theory_deduce</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>conflict</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Conflict</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>conflict</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>theory_deduce</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>result</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cdcl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Common.Implied</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>result</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cdcl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Common.Implied</span></span><span> </span><span class="entity"><span>lits</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> 
          </span><span class="comment1"><span>(* turn all implications of the theory solver into propositional assignments *)</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>cdcl_assume</span></span><span> </span><span class="entity"><span>lits</span></span><span> </span><span class="entity"><span>cdcl</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cdcl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Implications</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cdcl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>cls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cdcl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Conflict</span></span><span> </span><span class="entity"><span>cls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cdcl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Common.Conflict</span></span><span> </span><span class="entity"><span>cls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Conflict</span></span><span> </span><span class="entity"><span>cls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cdcl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>theory_assume</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>cdcl</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>None</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cdcl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>theory_assume</span></span><span> </span><span class="entity"><span>lps</span></span><span> </span><span class="entity"><span>cdcl</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>None</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cdcl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span>
      </span><span class="comment1"><span>(* propagate all propositional implications to the theory solver *)</span></span><span>
      </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>theory_deduce</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>Argo_Thy.assume</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lps</span></span><span>
      </span><span class="comment1"><span>(* check the consistency of the theory model *)</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>theory_deduce</span></span><span> </span><span class="entity"><span>Argo_Thy.check</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>search</span></span><span> </span><span class="entity"><span>limit</span></span><span> </span><span class="entity"><span>cdcl</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="comment1"><span>(* collect all propositional implications of the last assignments *)</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Argo_Cdcl.propagate</span></span><span> </span><span class="entity"><span>cdcl</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Common.Implied</span></span><span> </span><span class="entity"><span>lps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cdcl</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="comment1"><span>(* propagate all propositional implications to the theory solver *)</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>theory_assume</span></span><span> </span><span class="entity"><span>lps</span></span><span> </span><span class="entity"><span>cdcl</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>None</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cdcl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="comment1"><span>(* stop searching if the conflict limit has been exceeded *)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>limit</span></span><span> </span><span>&lt;=</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cdcl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span class="comment1"><span>(* no further propositional assignments, choose a value for the next unassigned atom *)</span></span><span>
            </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Argo_Cdcl.decide</span></span><span> </span><span class="entity"><span>cdcl</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>true</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cdcl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="comment1"><span>(* the context is satisfiable *)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>cdcl</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>search</span></span><span> </span><span class="entity"><span>limit</span></span><span> </span><span class="entity"><span>cdcl</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Thy.add_level</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Implications</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cdcl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>search</span></span><span> </span><span class="entity"><span>limit</span></span><span> </span><span class="entity"><span>cdcl</span></span><span> </span><span class="entity"><span>thy</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Conflict</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Argo_Proof.unsat</span></span><span> </span><span class="entity"><span>p</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Conflict</span></span><span> </span><span class="entity"><span>cls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cdcl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>analyze</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="entity"><span>limit</span></span><span> </span><span class="entity"><span>cdcl</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Common.Conflict</span></span><span> </span><span class="entity"><span>cls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cdcl</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>analyze</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="entity"><span>limit</span></span><span> </span><span class="entity"><span>cdcl</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>analyze</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="entity"><span>limit</span></span><span> </span><span class="entity"><span>cdcl</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="comment1"><span>(* analyze the conflict, probably using lazy explanations from the theory solver *)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>levels</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cdcl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Argo_Cdcl.analyze</span></span><span> </span><span class="entity"><span>Argo_Thy.explain</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="entity"><span>cdcl</span></span><span> </span><span class="entity"><span>thy</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>search</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>limit</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cdcl</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>backjump</span></span><span> </span><span class="entity"><span>levels</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>luby_number</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mult</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span>&lt;</span><span> </span><span class="entity"><span>i</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>mult</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span>*</span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>p</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mult</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span>div</span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>luby_number</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span> </span><span>-</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span> </span><span>div</span><span> </span><span class="inner_numeral"><span>2</span></span><span class="main"><span>)</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>next_restart_limit</span></span><span> </span><span class="entity"><span>iter</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>100</span></span><span> </span><span>*</span><span> </span><span class="entity"><span>luby_number</span></span><span> </span><span class="entity"><span>iter</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>loop</span></span><span> </span><span class="entity"><span>iter</span></span><span> </span><span class="entity"><span>cdcl</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="comment1"><span>(* perform a limited search that is stopped after a certain number of conflicts *)</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>search</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>next_restart_limit</span></span><span> </span><span class="entity"><span>iter</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cdcl</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="main"><span>(</span></span><span>true</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cdcl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>iter</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cdcl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cdcl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="comment1"><span>(* restart the solvers to avoid that they get stuck in a fruitless search *)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>levels</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cdcl</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Argo_Cdcl.restart</span></span><span> </span><span class="entity"><span>cdcl</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>loop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>iter</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cdcl</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>backjump</span></span><span> </span><span class="entity"><span>levels</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>run</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>terms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>iter</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cdcl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>iter</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cdcl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>loop</span></span><span> </span><span class="entity"><span>iter</span></span><span> </span><span class="entity"><span>cdcl</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Thy.prepare</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>mk_context</span></span><span> </span><span class="entity"><span>terms</span></span><span> </span><span class="entity"><span>iter</span></span><span> </span><span class="entity"><span>cdcl</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(* model *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>model_of</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>terms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cdcl</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Argo_Term.identify_item</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Term.Expr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.E</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Expr.Con</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>terms</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Term.Known</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Argo_Cdcl.assignment_of</span></span><span> </span><span class="entity"><span>cdcl</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Lit.Pos</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Argo_Term.New</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span></pre>
</body>

</html>