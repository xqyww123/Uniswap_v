<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹Code/code_printer.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹Code/code_printer.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      Tools/Code/code_printer.ML
    Author:     Florian Haftmann, TU Muenchen

Generic operations for pretty printing of target language code.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>CODE_PRINTER</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>itype</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Code_Thingol.itype</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>iterm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Code_Thingol.iterm</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>const</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Code_Thingol.const</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>dict</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Code_Thingol.dict</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> eqn_error</span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>'a</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> @@ </span><span class="main"><span>:</span></span><span> </span><span>'a</span><span> * </span><span>'a</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>'a</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> @| </span><span class="main"><span>:</span></span><span> </span><span>'a</span><span> </span><span>list</span><span> * </span><span>'a</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>'a</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> str</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> concat</span><span class="main"><span>:</span></span><span> </span><span>Pretty.T</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> brackets</span><span class="main"><span>:</span></span><span> </span><span>Pretty.T</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> enclose</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> commas</span><span class="main"><span>:</span></span><span> </span><span>Pretty.T</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> enum</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> enum_default</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> semicolon</span><span class="main"><span>:</span></span><span> </span><span>Pretty.T</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> doublesemicolon</span><span class="main"><span>:</span></span><span> </span><span>Pretty.T</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> indent</span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> markup_stmt</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Code_Symbol.T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> format</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Code_Symbol.T</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Bytes.T</span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>var_ctxt</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> make_vars</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>var_ctxt</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> intro_vars</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>var_ctxt</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>var_ctxt</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> lookup_var</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>var_ctxt</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> intro_base_names</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>var_ctxt</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>var_ctxt</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> intro_base_names_for</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Code_Symbol.T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>iterm</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>var_ctxt</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>var_ctxt</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> aux_params</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>var_ctxt</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>iterm</span></span><span> </span><span>list</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>literals</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> Literals</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>{</span></span><span> </span><span>literal_string</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span class="main"><span>,</span></span><span>
        </span><span>literal_numeral</span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span class="main"><span>,</span></span><span>
        </span><span>literal_list</span><span class="main"><span>:</span></span><span> </span><span>Pretty.T</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span class="main"><span>,</span></span><span> </span><span>infix_cons</span><span class="main"><span>:</span></span><span> </span><span>int</span><span> * </span><span>string</span><span> </span><span class="main"><span>}</span></span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>literals</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> literal_string</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>literals</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> literal_numeral</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>literals</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> literal_list</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>literals</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> infix_cons</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>literals</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> * </span><span>string</span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>lrx</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> L</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>lrx</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> R</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>lrx</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> X</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>lrx</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>fixity</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> BR</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>fixity</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> NOBR</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>fixity</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> INFX</span><span class="main"><span>:</span></span><span> </span><span>int</span><span> * </span><span class="entity"><span>lrx</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>fixity</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> APP</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>fixity</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> brackify</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>fixity</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> brackify_infix</span><span class="main"><span>:</span></span><span> </span><span>int</span><span> * </span><span class="entity"><span>lrx</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>fixity</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span> * </span><span>Pretty.T</span><span> * </span><span>Pretty.T</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> brackify_block</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>fixity</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> gen_applify</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>'a</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>fixity</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>'a</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> applify</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>'a</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>fixity</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>'a</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> tuplify</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fixity</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>'a</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>fixity</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>'a</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span> </span><span>option</span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>raw_const_syntax</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> plain_const_syntax</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>raw_const_syntax</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>simple_const_syntax</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> simple_const_syntax</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>simple_const_syntax</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>raw_const_syntax</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>complex_const_syntax</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> complex_const_syntax</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>complex_const_syntax</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>raw_const_syntax</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> parse_const_syntax</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>raw_const_syntax</span></span><span> </span><span>parser</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> requires_args</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>raw_const_syntax</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span>
  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>const_printer</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Plain_printer</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> string
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Complex_printer</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span>var_ctxt </span><span class="main"><span>-&gt;</span></span><span> fixity </span><span class="main"><span>-&gt;</span></span><span> iterm </span><span class="main"><span>-&gt;</span></span><span> Pretty.T</span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>-&gt;</span></span><span> thm option </span><span class="main"><span>-&gt;</span></span><span> var_ctxt </span><span class="main"><span>-&gt;</span></span><span> fixity </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>iterm * itype</span><span class="main"><span>)</span></span><span> list </span><span class="main"><span>-&gt;</span></span><span> Pretty.T
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>const_syntax</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>int</span><span> * </span><span class="entity"><span>const_printer</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> prep_const_syntax</span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>literals</span></span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>raw_const_syntax</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>const_syntax</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>tyco_syntax</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> parse_tyco_syntax</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>tyco_syntax</span></span><span> </span><span>parser</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> gen_print_app</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>thm</span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>var_ctxt</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>const</span></span><span> * </span><span class="entity"><span>iterm</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span> </span><span>list</span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>thm</span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>var_ctxt</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>fixity</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>iterm</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>const_syntax</span></span><span> </span><span>option</span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>var_ctxt</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>fixity</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>const</span></span><span> * </span><span class="entity"><span>iterm</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> gen_print_bind</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>thm</span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>var_ctxt</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>fixity</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>iterm</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>fixity</span></span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>iterm</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>var_ctxt</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span> * </span><span class="entity"><span>var_ctxt</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>identifiers</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>printings</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>data</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> empty_data</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>data</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> map_data</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> </span><span>list</span><span> * </span><span class="entity"><span>identifiers</span></span><span> * </span><span class="entity"><span>printings</span></span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span> * </span><span class="entity"><span>identifiers</span></span><span> * </span><span class="entity"><span>printings</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>data</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>data</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> merge_data</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>data</span></span><span> * </span><span class="entity"><span>data</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>data</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> the_reserved</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>data</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>list</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> the_identifiers</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>data</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>identifiers</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> the_printings</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>data</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>printings</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Code_Printer</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>CODE_PRINTER</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Basic_Code_Symbol</span><span class="main"><span>;</span></span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Code_Thingol</span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(** generic nonsense *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>eqn_error</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>",\nin equation "</span></span><span> </span><span>^</span><span> </span><span>Thm.string_of_thm_global</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>eqn_error</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>NONE</span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>error</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>code_presentationN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"code_presentation"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>stmt_nameN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"stmt_name"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Markup.add_mode</span><span> </span><span class="entity"><span>code_presentationN</span></span><span> </span><span>YXML.output_markup</span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(** assembling and printing text pieces **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>infixr</span></span></span><span> </span><span class="inner_numeral"><span>5</span></span><span> @@</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>infixr</span></span></span><span> </span><span class="inner_numeral"><span>5</span></span><span> @|</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="entity"><span>@@</span></span><span> </span><span class="entity"><span>y</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="entity"><span>@|</span></span><span> </span><span class="entity"><span>y</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>y</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>with_no_print_mode</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Print_Mode.setmp</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>str</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>with_no_print_mode</span></span><span> </span><span>Pretty.str</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>concat</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pretty.block</span><span> </span><span>o</span><span> </span><span>Pretty.breaks</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>commas</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>with_no_print_mode</span></span><span> </span><span>Pretty.commas</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>enclose</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>with_no_print_mode</span></span><span> </span><span class="main"><span>(</span></span><span>Pretty.enclose</span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>brackets</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>enclose</span></span><span> </span><span class="inner_quoted"><span>"("</span></span><span> </span><span class="inner_quoted"><span>")"</span></span><span> </span><span>o</span><span> </span><span>Pretty.breaks</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>enum</span></span><span> </span><span class="entity"><span>sep</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>with_no_print_mode</span></span><span> </span><span class="main"><span>(</span></span><span>Pretty.enum</span><span> </span><span class="entity"><span>sep</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>enum_default</span></span><span> </span><span class="entity"><span>default</span></span><span> </span><span class="entity"><span>sep</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>str</span></span><span> </span><span class="entity"><span>default</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>enum_default</span></span><span> </span><span class="entity"><span>default</span></span><span> </span><span class="entity"><span>sep</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>enum</span></span><span> </span><span class="entity"><span>sep</span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>semicolon</span></span><span> </span><span class="entity"><span>ps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pretty.block</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>concat</span></span><span> </span><span class="entity"><span>ps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>str</span></span><span> </span><span class="inner_quoted"><span>";"</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>doublesemicolon</span></span><span> </span><span class="entity"><span>ps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pretty.block</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>concat</span></span><span> </span><span class="entity"><span>ps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>str</span></span><span> </span><span class="inner_quoted"><span>";;"</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>indent</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>with_no_print_mode</span></span><span> </span><span class="main"><span>(</span></span><span>Pretty.indent</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>with_presentation_marker</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Print_Mode.setmp</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>code_presentationN</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>markup_stmt</span></span><span> </span><span class="entity"><span>sym</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>with_presentation_marker</span></span><span>
  </span><span class="main"><span>(</span></span><span>Pretty.mark</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>code_presentationN</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>stmt_nameN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Code_Symbol.marker</span></span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>filter_presentation</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>xml</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Buffer.build</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span>XML.add_content</span><span> </span><span class="entity"><span>xml</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>filter_presentation</span></span><span> </span><span class="entity"><span>presentation_syms</span></span><span> </span><span class="entity"><span>xml</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>presentation_idents</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>Code_Symbol.marker</span></span><span> </span><span class="entity"><span>presentation_syms</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_selected</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>attrs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>code_presentationN</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>presentation_idents</span></span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="main"><span>(</span></span><span>Properties.get</span><span> </span><span class="entity"><span>attrs</span></span><span> </span><span class="entity"><span>stmt_nameN</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_content_with_space</span></span><span> </span><span class="entity"><span>tree</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_first</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>buf</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>buf</span></span><span>
          </span><span>|&gt;</span><span> </span><span>not</span><span> </span><span class="entity"><span>is_first</span></span><span> </span><span>?</span><span> </span><span>Buffer.add</span><span> </span><span class="inner_quoted"><span>"\n\n"</span></span><span>
          </span><span>|&gt;</span><span> </span><span>XML.add_content</span><span> </span><span class="entity"><span>tree</span></span><span>
          </span><span>|&gt;</span><span> </span><span>pair</span><span> </span><span>false</span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>filter</span></span><span> </span><span class="main"><span>(</span></span><span>XML.Elem</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name_attrs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_selected</span></span><span> </span><span class="entity"><span>name_attrs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>add_content_with_space</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>filter</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xs</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>filter</span></span><span> </span><span class="main"><span>(</span></span><span>XML.Text</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>I</span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>snd</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="entity"><span>filter</span></span><span> </span><span class="entity"><span>xml</span></span><span> </span><span class="main"><span>(</span></span><span>true</span><span class="main"><span>,</span></span><span> </span><span>Buffer.empty</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>format</span></span><span> </span><span class="entity"><span>presentation_names</span></span><span> </span><span class="entity"><span>width</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>with_presentation_marker</span></span><span> </span><span class="main"><span>(</span></span><span>Pretty.string_of_margin</span><span> </span><span class="entity"><span>width</span></span><span class="main"><span>)</span></span><span>
  </span><span>#&gt;</span><span> </span><span>YXML.parse_body</span><span>
  </span><span>#&gt;</span><span> </span><span class="entity"><span>filter_presentation</span></span><span> </span><span class="entity"><span>presentation_names</span></span><span>
  </span><span>#&gt;</span><span> </span><span>Buffer.add</span><span> </span><span class="inner_quoted"><span>"\n"</span></span><span>
  </span><span>#&gt;</span><span> </span><span>Bytes.buffer</span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(** names and variable name contexts **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>var_ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>string</span><span> </span><span>Symtab.table</span><span> * </span><span>Name.context</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_vars</span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Symtab.update_new</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span>Symtab.empty</span><span class="main"><span>,</span></span><span>
  </span><span>Name.make_context</span><span> </span><span class="entity"><span>names</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>intro_vars</span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>namemap</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>namectxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>names'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>namectxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_map</span><span> </span><span>Name.variant</span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="entity"><span>namectxt</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>namemap'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold2</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span>Symtab.update</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="entity"><span>names'</span></span><span> </span><span class="entity"><span>namemap</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>namemap'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>namectxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lookup_var</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>namemap</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Symtab.lookup</span><span> </span><span class="entity"><span>namemap</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="entity"><span>name'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>name'</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Invalid name in context: "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>aux_params</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>lhss</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fish_param</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>w</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>w</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>fish_param</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IVar</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>v</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>fish_param</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fillup_param</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>v</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>fillup_param</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fished1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="entity"><span>fish_param</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lhss</span></span><span> </span><span class="main"><span>(</span></span><span>replicate</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>lhss</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Name.variant_list</span><span> </span><span class="main"><span>(</span></span><span>map_filter</span><span> </span><span>I</span><span> </span><span class="entity"><span>fished1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"x"</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fished2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_index</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fillup_param</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fished1</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fished3</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_map</span><span> </span><span>Name.variant</span><span> </span><span class="entity"><span>fished2</span></span><span> </span><span>Name.context</span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vars'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>intro_vars</span></span><span> </span><span class="entity"><span>fished3</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lookup_var</span></span><span> </span><span class="entity"><span>vars'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fished3</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>intro_base_names</span></span><span> </span><span class="entity"><span>no_syntax</span></span><span> </span><span class="entity"><span>deresolve</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>no_syntax</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>deresolve</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Long_Name.is_qualified</span><span> </span><span class="entity"><span>name'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>NONE</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>name'</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
  </span><span>#&gt;</span><span> </span><span class="entity"><span>intro_vars</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>intro_base_names_for</span></span><span> </span><span class="entity"><span>no_syntax</span></span><span> </span><span class="entity"><span>deresolve</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="entity"><span>Code_Thingol.add_constsyms</span></span><span> </span><span class="entity"><span>ts</span></span><span> 
  </span><span>|&gt;</span><span> </span><span class="entity"><span>intro_base_names</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>Constant</span></span><span> </span><span class="entity"><span>const</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>no_syntax</span></span><span> </span><span class="entity"><span>const</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>deresolve</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(** pretty literals **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>literals</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Literals</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>{</span></span><span>
  literal_string</span><span class="main"><span>:</span></span><span> string </span><span class="main"><span>-&gt;</span></span><span> string</span><span class="main"><span>,</span></span><span>
  literal_numeral</span><span class="main"><span>:</span></span><span> int </span><span class="main"><span>-&gt;</span></span><span> string</span><span class="main"><span>,</span></span><span>
  literal_list</span><span class="main"><span>:</span></span><span> Pretty.T list </span><span class="main"><span>-&gt;</span></span><span> Pretty.T</span><span class="main"><span>,</span></span><span>
  infix_cons</span><span class="main"><span>:</span></span><span> int * string
</span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dest_Literals</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Literals</span></span><span> </span><span class="entity"><span>lits</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lits</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>literal_string</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>literal_string</span><span> </span><span>o</span><span> </span><span class="entity"><span>dest_Literals</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>literal_numeral</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>literal_numeral</span><span> </span><span>o</span><span> </span><span class="entity"><span>dest_Literals</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>literal_list</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>literal_list</span><span> </span><span>o</span><span> </span><span class="entity"><span>dest_Literals</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>infix_cons</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>infix_cons</span><span> </span><span>o</span><span> </span><span class="entity"><span>dest_Literals</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(** syntax printer **)</span></span><span>

</span><span class="comment1"><span>(* binding priorities *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>lrx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>fixity</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>BR</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>NOBR</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>INFX</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span>int * lrx</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>APP</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>INFX</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>L</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fixity_lrx</span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>fixity_lrx</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>fixity_lrx</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fixity</span></span><span> </span><span class="entity"><span>NOBR</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>fixity</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>NOBR</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>fixity</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>INFX</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lr</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>INFX</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pr_ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lr_ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>pr</span></span><span> </span><span>&lt;</span><span> </span><span class="entity"><span>pr_ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>pr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pr_ctxt</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>fixity_lrx</span></span><span> </span><span class="entity"><span>lr</span></span><span> </span><span class="entity"><span>lr_ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>pr_ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>fixity</span></span><span> </span><span class="entity"><span>BR</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>INFX</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>fixity</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gen_brackify</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>p</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>p</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>gen_brackify</span></span><span> </span><span>true</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ps</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>_</span></span><span>::</span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>enclose</span></span><span> </span><span class="inner_quoted"><span>"("</span></span><span> </span><span class="inner_quoted"><span>")"</span></span><span> </span><span class="entity"><span>ps</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>gen_brackify</span></span><span> </span><span>false</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ps</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>_</span></span><span>::</span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pretty.block</span><span> </span><span class="entity"><span>ps</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>brackify</span></span><span> </span><span class="entity"><span>fxy_ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>gen_brackify</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fixity</span></span><span> </span><span class="entity"><span>BR</span></span><span> </span><span class="entity"><span>fxy_ctxt</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>Pretty.breaks</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>brackify_infix</span></span><span> </span><span class="entity"><span>infx</span></span><span> </span><span class="entity"><span>fxy_ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>gen_brackify</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fixity</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>INFX</span></span><span> </span><span class="entity"><span>infx</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fxy_ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>str</span></span><span> </span><span class="inner_quoted"><span>" "</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>brackify_block</span></span><span> </span><span class="entity"><span>fxy_ctxt</span></span><span> </span><span class="entity"><span>p1</span></span><span> </span><span class="entity"><span>ps</span></span><span> </span><span class="entity"><span>p2</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pretty.block_enclose</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>p2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ps</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>fixity</span></span><span> </span><span class="entity"><span>BR</span></span><span> </span><span class="entity"><span>fxy_ctxt</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>enclose</span></span><span> </span><span class="inner_quoted"><span>"("</span></span><span> </span><span class="inner_quoted"><span>")"</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>p</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>p</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gen_applify</span></span><span> </span><span class="entity"><span>strict</span></span><span> </span><span class="entity"><span>opn</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>fxy_ctxt</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>strict</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>gen_brackify</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fixity</span></span><span> </span><span class="entity"><span>BR</span></span><span> </span><span class="entity"><span>fxy_ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>str</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>opn</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>cls</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>p</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>gen_applify</span></span><span> </span><span class="entity"><span>strict</span></span><span> </span><span class="entity"><span>opn</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>fxy_ctxt</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>ps</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>gen_brackify</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fixity</span></span><span> </span><span class="entity"><span>BR</span></span><span> </span><span class="entity"><span>fxy_ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>@@</span></span><span> </span><span class="entity"><span>enum</span></span><span> </span><span class="inner_quoted"><span>","</span></span><span> </span><span class="entity"><span>opn</span></span><span> </span><span class="entity"><span>cls</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>ps</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>applify</span></span><span> </span><span class="entity"><span>opn</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>gen_applify</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>opn</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tuplify</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>tuplify</span></span><span> </span><span class="entity"><span>print</span></span><span> </span><span class="entity"><span>fxy</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>x</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>print</span></span><span> </span><span class="entity"><span>fxy</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>tuplify</span></span><span> </span><span class="entity"><span>print</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>enum</span></span><span> </span><span class="inner_quoted"><span>","</span></span><span> </span><span class="inner_quoted"><span>"("</span></span><span> </span><span class="inner_quoted"><span>")"</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>print</span></span><span> </span><span class="entity"><span>NOBR</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* generic syntax *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>simple_const_syntax</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>int</span><span> * </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>fixity</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>iterm</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>fixity</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>iterm</span></span><span> * </span><span class="entity"><span>itype</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>complex_const_syntax</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>int</span><span> * </span><span class="main"><span>(</span></span><span class="entity"><span>literals</span></span><span>
  </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>var_ctxt</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>fixity</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>iterm</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>var_ctxt</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>fixity</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>iterm</span></span><span> * </span><span class="entity"><span>itype</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>raw_const_syntax</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>plain_const_syntax</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> string
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>complex_const_syntax</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> complex_const_syntax</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>simple_const_syntax</span></span><span> </span><span class="entity"><span>syn</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>complex_const_syntax</span></span><span>
    </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>print</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>print</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>syn</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>requires_args</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>plain_const_syntax</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>requires_args</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>complex_const_syntax</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>const_printer</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Plain_printer</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> string
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Complex_printer</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span>var_ctxt </span><span class="main"><span>-&gt;</span></span><span> fixity </span><span class="main"><span>-&gt;</span></span><span> iterm </span><span class="main"><span>-&gt;</span></span><span> Pretty.T</span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>-&gt;</span></span><span> thm option </span><span class="main"><span>-&gt;</span></span><span> var_ctxt </span><span class="main"><span>-&gt;</span></span><span> fixity </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>iterm * itype</span><span class="main"><span>)</span></span><span> list </span><span class="main"><span>-&gt;</span></span><span> Pretty.T</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>const_syntax</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>int</span><span> * </span><span class="entity"><span>const_printer</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prep_const_syntax</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>literals</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>plain_const_syntax</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>Code.args_number</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Plain_printer</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>prep_const_syntax</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>literals</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>complex_const_syntax</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Complex_printer</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>literals</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gen_print_app</span></span><span> </span><span class="entity"><span>print_app_expr</span></span><span> </span><span class="entity"><span>print_term</span></span><span> </span><span class="entity"><span>const_syntax</span></span><span> </span><span class="entity"><span>some_thm</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>fxy</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>app</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span> </span><span class="entity"><span>sym</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>dom</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>sym</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="entity"><span>Constant</span></span><span> </span><span class="entity"><span>const</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>const_syntax</span></span><span> </span><span class="entity"><span>const</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>brackify</span></span><span> </span><span class="entity"><span>fxy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>print_app_expr</span></span><span> </span><span class="entity"><span>some_thm</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>app</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Plain_printer</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>brackify</span></span><span> </span><span class="entity"><span>fxy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>str</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span>::</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>print_term</span></span><span> </span><span class="entity"><span>some_thm</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>BR</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ts</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Complex_printer</span></span><span> </span><span class="entity"><span>print</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>print'</span></span><span> </span><span class="entity"><span>fxy</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="entity"><span>print</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>print_term</span></span><span> </span><span class="entity"><span>some_thm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>some_thm</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>fxy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ts</span></span><span> </span><span>~~</span><span> </span><span>take</span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>dom</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>ts</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>print'</span></span><span> </span><span class="entity"><span>fxy</span></span><span> </span><span class="entity"><span>ts</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span>&lt;</span><span> </span><span>length</span><span> </span><span class="entity"><span>ts</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>chop</span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ts1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="entity"><span>brackify</span></span><span> </span><span class="entity"><span>fxy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>print'</span></span><span> </span><span class="entity"><span>APP</span></span><span> </span><span class="entity"><span>ts1</span></span><span> </span><span>::</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>print_term</span></span><span> </span><span class="entity"><span>some_thm</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>BR</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ts2</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>print_term</span></span><span> </span><span class="entity"><span>some_thm</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>fxy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Code_Thingol.eta_expand</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>app</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>brackify</span></span><span> </span><span class="entity"><span>fxy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>print_app_expr</span></span><span> </span><span class="entity"><span>some_thm</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>app</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gen_print_bind</span></span><span> </span><span class="entity"><span>print_term</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fxy</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>fixity</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pat</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>build</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Code_Thingol.add_varnames</span></span><span> </span><span class="entity"><span>pat</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vars'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>intro_vars</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>print_term</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>vars'</span></span><span> </span><span class="entity"><span>fxy</span></span><span> </span><span class="entity"><span>pat</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>tyco_syntax</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>int</span><span> * </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>fixity</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>itype</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>fixity</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>itype</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* mixfix syntax *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span>'a</span><span> </span><span class="entity"><span>mixfix</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>Arg</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> fixity
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>String</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> string
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Break</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>printer_of_mixfix</span></span><span> </span><span class="entity"><span>prep_arg</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fixity_this</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mfx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_arg</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Arg</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_arg</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span>o</span><span> </span><span>filter</span><span> </span><span class="entity"><span>is_arg</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>mfx</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fillin</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>fillin</span></span><span> </span><span class="entity"><span>print</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Arg</span></span><span> </span><span class="entity"><span>fxy</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>mfx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>print</span></span><span> </span><span class="entity"><span>fxy</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>prep_arg</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>fillin</span></span><span> </span><span class="entity"><span>print</span></span><span> </span><span class="entity"><span>mfx</span></span><span> </span><span class="entity"><span>args</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>fillin</span></span><span> </span><span class="entity"><span>print</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>String</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>mfx</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>str</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>fillin</span></span><span> </span><span class="entity"><span>print</span></span><span> </span><span class="entity"><span>mfx</span></span><span> </span><span class="entity"><span>args</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>fillin</span></span><span> </span><span class="entity"><span>print</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Break</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>mfx</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>Pretty.brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>fillin</span></span><span> </span><span class="entity"><span>print</span></span><span> </span><span class="entity"><span>mfx</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>print</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>fixity_ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="entity"><span>gen_brackify</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fixity</span></span><span> </span><span class="entity"><span>fixity_this</span></span><span> </span><span class="entity"><span>fixity_ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fillin</span></span><span> </span><span class="entity"><span>print</span></span><span> </span><span class="entity"><span>mfx</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>read_infix</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fixity_this</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>fixity_this</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>INFX</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>L</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>INFX</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>fixity_this</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>INFX</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>INFX</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>INFX</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fixity_this</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Arg</span></span><span> </span><span class="entity"><span>l</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>String</span></span><span> </span><span class="inner_quoted"><span>" "</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>String</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Break</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Arg</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>read_mixfix</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sym_any</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.one</span><span> </span><span>Symbol.not_eof</span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span>$$</span><span> </span><span class="inner_quoted"><span>"!"</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="entity"><span>NOBR</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>BR</span></span><span> </span><span>--</span><span> </span><span>Scan.repeat</span><span> </span><span class="main"><span>(</span></span><span>
         </span><span class="main"><span>(</span></span><span>$$</span><span> </span><span class="inner_quoted"><span>"("</span></span><span> </span><span>--</span><span> </span><span>$$</span><span> </span><span class="inner_quoted"><span>"_"</span></span><span> </span><span>--</span><span> </span><span>$$</span><span> </span><span class="inner_quoted"><span>")"</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Arg</span></span><span> </span><span class="entity"><span>NOBR</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>||</span><span> </span><span class="main"><span>(</span></span><span>$$</span><span> </span><span class="inner_quoted"><span>"_"</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Arg</span></span><span> </span><span class="entity"><span>BR</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>||</span><span> </span><span class="main"><span>(</span></span><span>$$</span><span> </span><span class="inner_quoted"><span>"/"</span></span><span> </span><span>|--</span><span> </span><span>Scan.repeat</span><span> </span><span class="main"><span>(</span></span><span>$$</span><span> </span><span class="inner_quoted"><span>" "</span></span><span class="main"><span>)</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="entity"><span>Break</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>||</span><span> </span><span class="main"><span>(</span></span><span>Scan.repeat1</span><span>
           </span><span class="main"><span>(</span></span><span>   </span><span>$$</span><span> </span><span class="inner_quoted"><span>"'"</span></span><span> </span><span>|--</span><span> </span><span class="entity"><span>sym_any</span></span><span>
            </span><span>||</span><span> </span><span>Scan.unless</span><span> </span><span class="main"><span>(</span></span><span>$$</span><span> </span><span class="inner_quoted"><span>"_"</span></span><span> </span><span>||</span><span> </span><span>$$</span><span> </span><span class="inner_quoted"><span>"/"</span></span><span> </span><span>||</span><span> </span><span>$$</span><span> </span><span class="inner_quoted"><span>"("</span></span><span> </span><span>|--</span><span> </span><span>$$</span><span> </span><span class="inner_quoted"><span>"_"</span></span><span> </span><span>|--</span><span> </span><span>$$</span><span> </span><span class="inner_quoted"><span>")"</span></span><span class="main"><span>)</span></span><span>
                 </span><span class="entity"><span>sym_any</span></span><span class="main"><span>)</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>String</span></span><span> </span><span>o</span><span> </span><span>implode</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"malformed mixfix annotation: "</span></span><span> </span><span>^</span><span> </span><span>quote</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>msg</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>msg</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Scan.finite</span><span> </span><span>Symbol.stopper</span><span> </span><span class="entity"><span>parse</span></span><span> </span><span class="main"><span>(</span></span><span>Symbol.explode</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>fixity_mixfix</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>fixity_mixfix</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Scan.!!</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>err</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span>Scan.fail</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_fixity</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>infix</span></span><span>›</span></span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span> </span><span>||</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>infixl</span></span><span>›</span></span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="entity"><span>L</span></span><span class="main"><span>)</span></span><span> </span><span>||</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>infixr</span></span><span>›</span></span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parse_mixfix</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span>Parse.string</span><span> </span><span>&gt;&gt;</span><span> </span><span class="entity"><span>read_mixfix</span></span><span>
  </span><span>||</span><span> </span><span class="entity"><span>parse_fixity</span></span><span> </span><span>--</span><span> </span><span>Parse.nat</span><span> </span><span>--</span><span> </span><span>Parse.string</span><span>
     </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>fixity</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>read_infix</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fixity</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>syntax_of_mixfix</span></span><span> </span><span class="entity"><span>of_plain</span></span><span> </span><span class="entity"><span>of_printer</span></span><span> </span><span class="entity"><span>prep_arg</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>BR</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>String</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>of_plain</span></span><span> </span><span class="entity"><span>s</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>syntax_of_mixfix</span></span><span> </span><span class="entity"><span>of_plain</span></span><span> </span><span class="entity"><span>of_printer</span></span><span> </span><span class="entity"><span>prep_arg</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fixity</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mfx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>of_printer</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>printer_of_mixfix</span></span><span> </span><span class="entity"><span>prep_arg</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fixity</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mfx</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parse_tyco_syntax</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>parse_mixfix</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="entity"><span>syntax_of_mixfix</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>o</span><span> </span><span>K</span><span> </span><span>o</span><span> </span><span>K</span><span> </span><span>o</span><span> </span><span class="entity"><span>str</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>I</span><span> </span><span>I</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_const_syntax</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>parse_mixfix</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="entity"><span>syntax_of_mixfix</span></span><span> </span><span class="entity"><span>plain_const_syntax</span></span><span> </span><span class="entity"><span>simple_const_syntax</span></span><span> </span><span>fst</span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(** custom data structure **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>identifiers</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> </span><span>list</span><span> * </span><span>string</span><span class="main"><span>,</span></span><span> </span><span>string</span><span> </span><span>list</span><span> * </span><span>string</span><span class="main"><span>,</span></span><span> </span><span>string</span><span> </span><span>list</span><span> * </span><span>string</span><span class="main"><span>,</span></span><span> </span><span>string</span><span> </span><span>list</span><span> * </span><span>string</span><span class="main"><span>,</span></span><span>
  </span><span>string</span><span> </span><span>list</span><span> * </span><span>string</span><span class="main"><span>,</span></span><span> </span><span>string</span><span> </span><span>list</span><span> * </span><span>string</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Code_Symbol.data</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>printings</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>const_syntax</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tyco_syntax</span></span><span class="main"><span>,</span></span><span> </span><span>string</span><span class="main"><span>,</span></span><span> </span><span>unit</span><span class="main"><span>,</span></span><span> </span><span>unit</span><span class="main"><span>,</span></span><span>
    </span><span class="main"><span>(</span></span><span>Pretty.T</span><span> * </span><span class="entity"><span>Code_Symbol.T</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Code_Symbol.data</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Data</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>{</span></span><span> reserved</span><span class="main"><span>:</span></span><span> string list</span><span class="main"><span>,</span></span><span> identifiers</span><span class="main"><span>:</span></span><span> identifiers</span><span class="main"><span>,</span></span><span>
  printings</span><span class="main"><span>:</span></span><span> printings </span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_data</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>reserved</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>identifiers</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>printings</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Data</span></span><span> </span><span class="main"><span>{</span></span><span> </span><span>reserved</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>reserved</span></span><span class="main"><span>,</span></span><span> </span><span>identifiers</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>identifiers</span></span><span class="main"><span>,</span></span><span> </span><span>printings</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>printings</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty_data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>make_data</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Code_Symbol.empty_data</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Code_Symbol.empty_data</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_data</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Data</span></span><span> </span><span class="main"><span>{</span></span><span> </span><span class="entity"><span>reserved</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>identifiers</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>printings</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>make_data</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>reserved</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>identifiers</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>printings</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>merge_data</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Data</span></span><span> </span><span class="main"><span>{</span></span><span> </span><span>reserved</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>reserved1</span></span><span class="main"><span>,</span></span><span> </span><span>identifiers</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>identifiers1</span></span><span class="main"><span>,</span></span><span> </span><span>printings</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>printings1</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span>
    </span><span class="entity"><span>Data</span></span><span> </span><span class="main"><span>{</span></span><span> </span><span>reserved</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>reserved2</span></span><span class="main"><span>,</span></span><span> </span><span>identifiers</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>identifiers2</span></span><span class="main"><span>,</span></span><span> </span><span>printings</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>printings2</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>make_data</span></span><span> </span><span class="main"><span>(</span></span><span>merge</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>reserved1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>reserved2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
    </span><span class="entity"><span>Code_Symbol.merge_data</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>identifiers1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>identifiers2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Code_Symbol.merge_data</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>printings1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>printings2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>the_reserved</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Data</span></span><span> </span><span class="main"><span>{</span></span><span> </span><span class="entity"><span>reserved</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>reserved</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>the_identifiers</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Data</span></span><span> </span><span class="main"><span>{</span></span><span> </span><span class="entity"><span>identifiers</span></span><span> </span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>identifiers</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>the_printings</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Data</span></span><span> </span><span class="main"><span>{</span></span><span> </span><span class="entity"><span>printings</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span> </span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>printings</span></span><span class="main"><span>;</span></span><span>


</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span> </span><span class="comment1"><span>(*struct*)</span></span><span>
</span></pre>
</body>

</html>