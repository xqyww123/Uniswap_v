<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹~~/src/Provers/hypsubst.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹~~/src/Provers/hypsubst.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      Provers/hypsubst.ML
    Authors:    Martin D Coen, Tobias Nipkow and Lawrence C Paulson
    Copyright   1995  University of Cambridge

Basic equational reasoning: hyp_subst_tac and methods "hypsubst", "simplesubst".

Tactic to substitute using (at least) the assumption x=t in the rest
of the subgoal, and to delete (at least) that assumption.  Original
version due to Martin Coen.

This version uses the simplifier, and requires it to be already present.

Test data:

Goal "!!x.[| Q(x,y,z); y=x; a=x; z=y; P(y) |] ==&gt; P(z)";
Goal "!!x.[| Q(x,y,z); z=f(x); x=z |] ==&gt; P(z)";
Goal "!!y. [| ?x=y; P(?x) |] ==&gt; y = a";
Goal "!!z. [| ?x=y; P(?x) |] ==&gt; y = a";

Goal "!!x a. [| x = f(b); g(a) = b |] ==&gt; P(x)";

by (bound_hyp_subst_tac 1);
by (hyp_subst_tac 1);

Here hyp_subst_tac goes wrong; harder still to prove P(f(f(a))) &amp; P(f(a))
Goal "P(a) --&gt; (EX y. a=y --&gt; P(f(a)))";

Goal "!!x. [| Q(x,h1); P(a,h2); R(x,y,h3); R(y,z,h4); x=f(y); \
\                 P(x,h5); P(y,h6); K(x,h7) |] ==&gt; Q(x,c)";
by (blast_hyp_subst_tac true 1);
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>HYPSUBST_DATA</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> dest_Trueprop    </span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> dest_eq          </span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> * </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> dest_imp         </span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> * </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> eq_reflection    </span><span class="main"><span>:</span></span><span> </span><span>thm</span><span>               </span><span class="comment1"><span>(* a=b ==&gt; a==b *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> rev_eq_reflection</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span>               </span><span class="comment1"><span>(* a==b ==&gt; a=b *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> imp_intr         </span><span class="main"><span>:</span></span><span> </span><span>thm</span><span>               </span><span class="comment1"><span>(* (P ==&gt; Q) ==&gt; P--&gt;Q *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> rev_mp           </span><span class="main"><span>:</span></span><span> </span><span>thm</span><span>               </span><span class="comment1"><span>(* [| P;  P--&gt;Q |] ==&gt; Q *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> subst            </span><span class="main"><span>:</span></span><span> </span><span>thm</span><span>               </span><span class="comment1"><span>(* [| a=b;  P(a) |] ==&gt; P(b) *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> sym              </span><span class="main"><span>:</span></span><span> </span><span>thm</span><span>               </span><span class="comment1"><span>(* a=b ==&gt; b=a *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> thin_refl        </span><span class="main"><span>:</span></span><span> </span><span>thm</span><span>               </span><span class="comment1"><span>(* [|x=x; PROP W|] ==&gt; PROP W *)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>HYPSUBST</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> bound_hyp_subst_tac    </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> hyp_subst_tac_thin     </span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> hyp_subst_thin         </span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span>Config.T</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> hyp_subst_tac          </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> blast_hyp_subst_tac    </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> stac                   </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>functor</span></span></span><span> </span><span class="entity"><span>Hypsubst</span></span><span class="main"><span>(</span></span><span>Data</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>HYPSUBST_DATA</span></span><span class="main"><span>)</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>HYPSUBST</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>EQ_VAR</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Simplifier turns Bound variables to special Free variables:
  change it back (any Bound variable will do)*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>inspect_contract</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Envir.eta_contract</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Name.is_bound</span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>t'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>has_vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.exists_subterm</span><span> </span><span>Term.is_Var</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>has_tvars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.exists_type</span><span> </span><span class="main"><span>(</span></span><span>Term.exists_subtype</span><span> </span><span>Term.is_TVar</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*If novars then we forbid Vars in the equality.
  If bnd then we only look for Bound variables to eliminate.
  When can we safely delete the equality?
    Not if it equates two constants; consider 0=1.
    Not if it resembles x=t[x], since substitution does not eliminate x.
    Not if it resembles ?x=0; consider ?x=0 ==&gt; ?x=1 or even ?x=0 ==&gt; P
    Not if it involves a variable free in the premises,
        but we can't check for this -- hence bnd and bound_hyp_subst_tac
  Prefer to eliminate Bound variables if possible.
  Result:  true = use as is,  false = reorient first
    also returns var to substitute, relevant if it is Free *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>inspect_pair</span></span><span> </span><span class="entity"><span>bnd</span></span><span> </span><span class="entity"><span>novars</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>novars</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>has_tvars</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>has_tvars</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Match</span><span>   </span><span class="comment1"><span>(*variables in the type!*)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>apply2</span><span> </span><span class="entity"><span>inspect_contract</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span class="main"><span>(</span></span><span>Bound</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>loose_bvar1</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>novars</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>has_vars</span></span><span> </span><span class="entity"><span>u</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Match</span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span>true</span><span class="main"><span>,</span></span><span> </span><span>Bound</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span>                </span><span class="comment1"><span>(*eliminates t*)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>Bound</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>loose_bvar1</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>novars</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>has_vars</span></span><span> </span><span class="entity"><span>t</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Match</span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span> </span><span>Bound</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span>               </span><span class="comment1"><span>(*eliminates u*)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t'</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Free</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>bnd</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>Logic.occs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>novars</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>has_vars</span></span><span> </span><span class="entity"><span>u</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Match</span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span>true</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span>                </span><span class="comment1"><span>(*eliminates t*)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u'</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Free</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>bnd</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>Logic.occs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>u'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>novars</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>has_vars</span></span><span> </span><span class="entity"><span>t</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Match</span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u'</span></span><span class="main"><span>)</span></span><span>               </span><span class="comment1"><span>(*eliminates u*)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Match</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Locates a substitutable variable on the left (resp. right) of an equality
   assumption.  Returns the number of intervening assumptions. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>eq_var</span></span><span> </span><span class="entity"><span>bnd</span></span><span> </span><span class="entity"><span>novars</span></span><span> </span><span class="entity"><span>check_frees</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_free</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>orient</span></span><span class="main"><span>,</span></span><span> </span><span>Free</span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="entity"><span>check_frees</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>not</span><span> </span><span class="entity"><span>orient</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span>Logic.occs</span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ts</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>orient</span></span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Match</span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>check_free</span></span><span> </span><span class="entity"><span>ts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>orient</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>orient</span></span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>eq_var_aux</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.all</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="quoted"><span>‹</span><span>Abs</span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>›</span></span><span>›</span></span><span> </span><span class="entity"><span>hs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eq_var_aux</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>hs</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>eq_var_aux</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.imp</span><span> </span><span class="keyword2"><span class="keyword"><span>for</span></span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>B</span></span><span>›</span></span><span> </span><span class="entity"><span>hs</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>check_free</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>B</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>hs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inspect_pair</span></span><span> </span><span class="entity"><span>bnd</span></span><span> </span><span class="entity"><span>novars</span></span><span>
                    </span><span class="main"><span>(</span></span><span class="entity"><span>Data.dest_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Data.dest_Trueprop</span></span><span> </span><span class="entity"><span>A</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
               </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>eq_var_aux</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>B</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>A</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>hs</span></span><span class="main"><span>)</span></span><span>
                 </span><span class="main"><span>|</span></span><span> </span><span>Match</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>eq_var_aux</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>B</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>A</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>hs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>eq_var_aux</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>EQ_VAR</span></span><span>

  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>  </span><span class="entity"><span>eq_var_aux</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>thin_free_eq_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SUBGOAL</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eq_var</span></span><span> </span><span>false</span><span> </span><span>false</span><span> </span><span>false</span><span> </span><span class="entity"><span>t</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ok</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eq_var</span></span><span> </span><span>false</span><span> </span><span>false</span><span> </span><span>true</span><span> </span><span class="entity"><span>t</span></span><span> </span><span>|&gt;</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span>&gt;</span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>EQ_VAR</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>ok</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>EVERY</span><span> </span><span class="main"><span>[</span></span><span>rotate_tac</span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span>eresolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span>thin_rl</span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span>rotate_tac</span><span> </span><span class="main"><span>(</span></span><span>~</span><span class="entity"><span>k</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>no_tac</span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>EQ_VAR</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>no_tac</span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(*For the simpset.  Adds ALL suitable equalities, even if not first!
  No vars are allowed here, as simpsets are built from meta-assumptions*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_eqs</span></span><span> </span><span class="entity"><span>bnd</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="main"><span>[</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>inspect_pair</span></span><span> </span><span class="entity"><span>bnd</span></span><span> </span><span>false</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Data.dest_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Data.dest_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>fst</span><span>
      </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>Data.eq_reflection</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Thm.symmetric</span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>Data.eq_reflection</span></span><span class="main"><span>)</span></span><span> </span><span class="comment1"><span>(*reorient*)</span></span><span> </span><span class="main"><span>]</span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span>Match</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Select a suitable equality assumption; substitute throughout the subgoal
  If bnd is true, then it replaces Bound variables only. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gen_hyp_subst_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>bnd</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>SUBGOAL</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Bi</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>orient</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>is_free</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eq_var</span></span><span> </span><span class="entity"><span>bnd</span></span><span> </span><span>true</span><span> </span><span>true</span><span> </span><span class="entity"><span>Bi</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>hyp_subst_ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>empty_simpset</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>Simplifier.set_mksimps</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_eqs</span></span><span> </span><span class="entity"><span>bnd</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>EVERY</span><span> </span><span class="main"><span>[</span></span><span>rotate_tac</span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>asm_lr_simp_tac</span></span><span> </span><span class="entity"><span>hyp_subst_ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="entity"><span>is_free</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>eresolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span>thin_rl</span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>i</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>orient</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>eresolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Data.rev_mp</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>i</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>eresolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Data.sym</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>Data.rev_mp</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span>
      </span><span>rotate_tac</span><span> </span><span class="main"><span>(</span></span><span>~</span><span class="entity"><span>k</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_free</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Data.imp_intr</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>all_tac</span><span class="main"><span>]</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>no_tac</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>EQ_VAR</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>no_tac</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ssubst</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Drule.zero_var_indexes</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Data.sym</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>Data.subst</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>inst_subst_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>rl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>CSUBGOAL</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cBi</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span>Logic.strip_assums_hyp</span><span> </span><span>#&gt;</span><span> </span><span>hd</span><span> </span><span>#&gt;</span><span>
      </span><span class="entity"><span>Data.dest_Trueprop</span></span><span> </span><span>#&gt;</span><span> </span><span class="entity"><span>Data.dest_eq</span></span><span> </span><span>#&gt;</span><span> </span><span>apply2</span><span> </span><span>Envir.eta_contract</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="entity"><span>cBi</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Bi</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>cBi</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.strip_params</span><span> </span><span class="entity"><span>Bi</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>U</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.fastype_of1</span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>snd</span><span> </span><span class="entity"><span>ps</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Q</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Data.dest_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span>Logic.strip_assums_concl</span><span> </span><span class="entity"><span>Bi</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rl'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.lift_rule</span><span> </span><span class="entity"><span>cBi</span></span><span> </span><span class="entity"><span>rl</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ixn</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>dest_Var</span><span> </span><span class="main"><span>(</span></span><span>Term.head_of</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Data.dest_Trueprop</span></span><span>
          </span><span class="main"><span>(</span></span><span>Logic.strip_assums_concl</span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>rl'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>v2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Data.dest_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Data.dest_Trueprop</span></span><span>
          </span><span class="main"><span>(</span></span><span>Logic.strip_assums_concl</span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="main"><span>(</span></span><span>Thm.prems_of</span><span> </span><span class="entity"><span>rl'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>V</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>split_last</span><span> </span><span class="main"><span>(</span></span><span>Term.binder_types</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>u</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>fold_rev</span><span> </span><span>Term.abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ps</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"x"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>U</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span>Bound</span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>subst_bounds</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Bound</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span>upto</span><span> </span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span>::</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span>upto</span><span> </span><span>length</span><span> </span><span class="entity"><span>ps</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Q</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Term.abstract_over</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span>Term.incr_boundvars</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>Q</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>instT</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.match</span><span> </span><span class="main"><span>(</span></span><span>apply2</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>o</span><span> </span><span>Logic.mk_type</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>V</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>U</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
        </span><span>compose_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>true</span><span class="main"><span>,</span></span><span> </span><span>Drule.instantiate_normalize</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>instT</span></span><span class="main"><span>,</span></span><span>
          </span><span>Vars.make</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>ixn</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span>---&gt;</span><span> </span><span class="entity"><span>U</span></span><span> </span><span>--&gt;</span><span> </span><span>body_type</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
             </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="main"><span>(</span></span><span>dest_Var</span><span> </span><span class="main"><span>(</span></span><span>head_of</span><span> </span><span class="entity"><span>v1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span>---&gt;</span><span> </span><span class="entity"><span>U</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>fold_rev</span><span> </span><span>Term.abs</span><span> </span><span class="entity"><span>ps</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
             </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="main"><span>(</span></span><span>dest_Var</span><span> </span><span class="main"><span>(</span></span><span>head_of</span><span> </span><span class="entity"><span>v2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span> </span><span>---&gt;</span><span> </span><span class="entity"><span>U</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>fold_rev</span><span> </span><span>Term.abs</span><span> </span><span class="entity"><span>ps</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rl'</span></span><span class="main"><span>,</span></span><span>
          </span><span>Thm.nprems_of</span><span> </span><span class="entity"><span>rl</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>no_tac</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>imp_intr_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Data.imp_intr</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rev_dup_elim</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span> </span><span>RSN</span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>2</span></span><span class="main"><span>,</span></span><span> </span><span>revcut_rl</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>Thm.assumption</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span>|&gt;</span><span> </span><span>Seq.hd</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dup_subst</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rev_dup_elim</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ssubst</span></span><span>

</span><span class="comment1"><span>(* FIXME: "etac Data.rev_mp i" will not behave as expected if goal has *)</span></span><span>
</span><span class="comment1"><span>(* premises containing meta-implications or quantifiers                *)</span></span><span>

</span><span class="comment1"><span>(*Old version of the tactic above -- slower but the only way
  to handle equalities containing Vars.*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>vars_gen_hyp_subst_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>bnd</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SUBGOAL</span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Bi</span></span><span class="main"><span>,</span></span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span class="main"><span>(</span></span><span>Logic.strip_assums_hyp</span><span> </span><span class="entity"><span>Bi</span></span><span class="main"><span>)</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>orient</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>is_free</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eq_var</span></span><span> </span><span class="entity"><span>bnd</span></span><span> </span><span>false</span><span> </span><span>true</span><span> </span><span class="entity"><span>Bi</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_free</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>dup_subst</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>ssubst</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>orient</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>rl</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Data.sym</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>rl</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
         </span><span>DETERM</span><span>
           </span><span class="main"><span>(</span></span><span>EVERY</span><span> </span><span class="main"><span>[</span></span><span>REPEAT_DETERM_N</span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>(</span></span><span>eresolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Data.rev_mp</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                   </span><span>rotate_tac</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span>
                   </span><span>REPEAT_DETERM_N</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span>-</span><span class="entity"><span>k</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>eresolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Data.rev_mp</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                   </span><span class="entity"><span>inst_subst_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>orient</span></span><span> </span><span class="entity"><span>rl</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span>
                   </span><span>REPEAT_DETERM_N</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>imp_intr_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>THEN</span><span> </span><span>rotate_tac</span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>no_tac</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>EQ_VAR</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>no_tac</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Substitutes for Free or Bound variables,
  discarding equalities on Bound variables
  and on Free variables if thin=true*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>hyp_subst_tac_thin</span></span><span> </span><span class="entity"><span>thin</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>REPEAT_DETERM1</span><span> </span><span>o</span><span> </span><span>FIRST'</span><span> </span><span class="main"><span>[</span></span><span>ematch_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Data.thin_refl</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
    </span><span class="entity"><span>gen_hyp_subst_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars_gen_hyp_subst_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>thin</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>thin_free_eq_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>K</span><span> </span><span>no_tac</span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>hyp_subst_thin</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.setup_config_bool</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="HOL.hypsubst_thin|attribute"><span>hypsubst_thin</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>hyp_subst_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>hyp_subst_tac_thin</span></span><span> </span><span class="main"><span>(</span></span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>hyp_subst_thin</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Substitutes for Bound variables only -- this is always safe*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>bound_hyp_subst_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>REPEAT_DETERM1</span><span> </span><span>o</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>gen_hyp_subst_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>true</span><span>
    </span><span>ORELSE'</span><span> </span><span class="entity"><span>vars_gen_hyp_subst_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(** Version for Blast_tac.  Hyps that are affected by the substitution are
    moved to the front.  Defect: even trivial changes are noticed, such as
    substitutions in the arguments of a function Var. **)</span></span><span>

</span><span class="comment1"><span>(*final re-reversal of the changed assumptions*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>reverse_n_tac</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>all_tac</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>reverse_n_tac</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>rotate_tac</span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="entity"><span>i</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>reverse_n_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>REPEAT_DETERM_N</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>(</span></span><span>rotate_tac</span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>THEN</span><span> </span><span>eresolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Data.rev_mp</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span>THEN</span><span>
      </span><span>REPEAT_DETERM_N</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>imp_intr_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>THEN</span><span> </span><span>rotate_tac</span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Use imp_intr, comparing the old hyps with the new ones as they come out.*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>all_imp_intr_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>hyps</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>imptac</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>reverse_n_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>st</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>imptac</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>hyp</span></span><span>::</span><span class="entity"><span>hyps</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>hyp'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span>Thm.term_of</span><span> </span><span class="main"><span>(</span></span><span>Thm.cprem_of</span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span>
              </span><span>|&gt;</span><span> </span><span>Logic.strip_assums_concl</span><span>
              </span><span>|&gt;</span><span> </span><span class="entity"><span>Data.dest_Trueprop</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>Data.dest_imp</span></span><span class="main"><span>;</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tac</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Envir.aeconv</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>hyp</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>hyp'</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>imp_intr_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>THEN</span><span> </span><span>rotate_tac</span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="comment1"><span>(*leave affected hyps at end*)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>imp_intr_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Seq.pull</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tac</span></span><span> </span><span class="entity"><span>st</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
              </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Seq.single</span><span> </span><span class="entity"><span>st</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>st'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>imptac</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>hyps</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>st'</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>imptac</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span>rev</span><span> </span><span class="entity"><span>hyps</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>blast_hyp_subst_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SUBGOAL</span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Bi</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>symopt</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eq_var</span></span><span> </span><span>false</span><span> </span><span>false</span><span> </span><span>false</span><span> </span><span class="entity"><span>Bi</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>hyps0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>Data.dest_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span>Logic.strip_assums_hyp</span><span> </span><span class="entity"><span>Bi</span></span><span class="main"><span>)</span></span><span>
    </span><span class="comment1"><span>(*omit selected equality, returning other hyps*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>hyps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.take</span><span class="main"><span>(</span></span><span class="entity"><span>hyps0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span> </span><span>List.drop</span><span class="main"><span>(</span></span><span class="entity"><span>hyps0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>k</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>hyps</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>tracing</span><span> </span><span class="inner_quoted"><span>"Substituting an equality"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span>DETERM</span><span>
      </span><span class="main"><span>(</span></span><span>EVERY</span><span> </span><span class="main"><span>[</span></span><span>REPEAT_DETERM_N</span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>(</span></span><span>eresolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Data.rev_mp</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
              </span><span>rotate_tac</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span>
              </span><span>REPEAT_DETERM_N</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span>-</span><span class="entity"><span>k</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>eresolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Data.rev_mp</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
              </span><span class="entity"><span>inst_subst_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>symopt</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>symopt</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>ssubst</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Data.subst</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span>
              </span><span class="entity"><span>all_imp_intr_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>hyps</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>no_tac</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>EQ_VAR</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>no_tac</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*apply an equality or definition ONCE;
  fails unless the substitution has an effect*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>stac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>th'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>Data.rev_eq_reflection</span></span><span> </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>th</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>CHANGED_GOAL</span><span> </span><span class="main"><span>(</span></span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>th'</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>ssubst</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* method setup *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Theory.setup</span><span>
   </span><span class="main"><span>(</span></span><span class="entity"><span>Method.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="HOL.hypsubst|method"><span>hypsubst</span></span><span>›</span></span></span><span>
      </span><span class="main"><span>(</span></span><span>Scan.succeed</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>SIMPLE_METHOD'</span></span><span> </span><span class="main"><span>(</span></span><span>CHANGED_PROP</span><span> </span><span>o</span><span> </span><span class="entity"><span>hyp_subst_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="inner_quoted"><span>"substitution using an assumption (improper)"</span></span><span> </span><span>#&gt;</span><span>
    </span><span class="entity"><span>Method.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="HOL.hypsubst_thin|method"><span>hypsubst_thin</span></span><span>›</span></span></span><span>
      </span><span class="main"><span>(</span></span><span>Scan.succeed</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>SIMPLE_METHOD'</span></span><span>
          </span><span class="main"><span>(</span></span><span>CHANGED_PROP</span><span> </span><span>o</span><span> </span><span class="entity"><span>hyp_subst_tac_thin</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="inner_quoted"><span>"substitution using an assumption, eliminating assumptions"</span></span><span> </span><span>#&gt;</span><span>
    </span><span class="entity"><span>Method.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="HOL.simplesubst|method"><span>simplesubst</span></span><span>›</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>Attrib.thm</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>SIMPLE_METHOD'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>stac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="inner_quoted"><span>"simple substitution"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
</span></pre>
</body>

</html>