<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹~~/src/Provers/classical.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹~~/src/Provers/classical.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      Provers/classical.ML
    Author:     Lawrence C Paulson, Cambridge University Computer Laboratory

Theorem prover for classical reasoning, including predicate calculus, set
theory, etc.

Rules must be classified as intro, elim, safe, unsafe.

A rule is unsafe unless it can be applied blindly without harmful results.
For a rule to be safe, its premises and conclusion should be logically
equivalent.  There should be no variables in the premises that are not in
the conclusion.
*)</span></span><span>

</span><span class="comment1"><span>(*higher precedence than := facilitates use of references*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>infix</span></span></span><span> </span><span class="inner_numeral"><span>4</span></span><span> addSIs addSEs addSDs addIs addEs addDs delrules
  addSWrapper delSWrapper addWrapper delWrapper
  addSbefore addSafter addbefore addafter
  addD2 addE2 addSD2 addSE2</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>CLASSICAL_DATA</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> imp_elim</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span>  </span><span class="comment1"><span>(* P --&gt; Q ==&gt; (~ R ==&gt; P) ==&gt; (Q ==&gt; R) ==&gt; R *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> not_elim</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span>  </span><span class="comment1"><span>(* ~P ==&gt; P ==&gt; R *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> swap</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span>  </span><span class="comment1"><span>(* ~ P ==&gt; (~ R ==&gt; P) ==&gt; R *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> classical</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span>  </span><span class="comment1"><span>(* (~ P ==&gt; P) ==&gt; P *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> sizef</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span>  </span><span class="comment1"><span>(* size function for BEST_FIRST, typically size_of_thm *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> hyp_subst_tacs</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="comment1"><span>(* optional tactics for
    substitution in the hypotheses; assumed to be safe! *)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>BASIC_CLASSICAL</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>wrapper</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>claset</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> print_claset</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> addDs</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> * </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> addEs</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> * </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> addIs</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> * </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> addSDs</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> * </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> addSEs</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> * </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> addSIs</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> * </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> delrules</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> * </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> addSWrapper</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> * </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>wrapper</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> delSWrapper</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> * </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> addWrapper</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> * </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>wrapper</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> delWrapper</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> * </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> addSbefore</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> * </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> addSafter</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> * </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> addbefore</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> * </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> addafter</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> * </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> addD2</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> * </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> addE2</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> * </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> addSD2</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> * </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> addSE2</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> * </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> appSWrappers</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>wrapper</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> appWrappers</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>wrapper</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> claset_of</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>claset</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> put_claset</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>claset</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> map_theory_claset</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> fast_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> slow_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> astar_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> slow_astar_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> best_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> first_best_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> slow_best_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> depth_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> deepen_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> contr_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> dup_elim</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> dup_intr</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> dup_step_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> eq_mp_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> unsafe_step_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mp_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> safe_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> safe_steps_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> safe_step_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> clarify_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> clarify_step_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> step_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> slow_step_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> swapify</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> swap_res_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> inst_step_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> inst0_step_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> instp_step_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>CLASSICAL</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>include</span></span></span><span> </span><span class="entity"><span>BASIC_CLASSICAL</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> classical_rule</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>thm</span><span> * </span><span class="main"><span>(</span></span><span>thm</span><span> * </span><span>thm</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> * </span><span class="main"><span>(</span></span><span>thm</span><span> * </span><span>thm</span><span> </span><span>list</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>netpair</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>int</span><span> * </span><span class="main"><span>(</span></span><span>bool</span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>Net.net</span><span> * </span><span class="main"><span>(</span></span><span>int</span><span> * </span><span class="main"><span>(</span></span><span>bool</span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>Net.net</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> rep_cs</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>claset</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
   </span><span class="main"><span>{</span></span><span>safeIs</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span>Item_Net.T</span><span class="main"><span>,</span></span><span>
    </span><span>safeEs</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span>Item_Net.T</span><span class="main"><span>,</span></span><span>
    </span><span>unsafeIs</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span>Item_Net.T</span><span class="main"><span>,</span></span><span>
    </span><span>unsafeEs</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span>Item_Net.T</span><span class="main"><span>,</span></span><span>
    </span><span>swrappers</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>wrapper</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
    </span><span>uwrappers</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>wrapper</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
    </span><span>safe0_netpair</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>netpair</span></span><span class="main"><span>,</span></span><span>
    </span><span>safep_netpair</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>netpair</span></span><span class="main"><span>,</span></span><span>
    </span><span>unsafe_netpair</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>netpair</span></span><span class="main"><span>,</span></span><span>
    </span><span>dup_netpair</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>netpair</span></span><span class="main"><span>,</span></span><span>
    </span><span>extra_netpair</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Context_Rules.netpair</span></span><span class="main"><span>}</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> get_cs</span><span class="main"><span>:</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>claset</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> map_cs</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>claset</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>claset</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> safe_dest</span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>attribute</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> safe_elim</span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>attribute</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> safe_intro</span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>attribute</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> unsafe_dest</span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>attribute</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> unsafe_elim</span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>attribute</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> unsafe_intro</span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>attribute</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> rule_del</span><span class="main"><span>:</span></span><span> </span><span>attribute</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> rule_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> standard_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> cla_modifiers</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Method.modifier</span></span><span> </span><span>parser</span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> cla_method</span><span class="main"><span>:</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.method</span></span><span class="main"><span>)</span></span><span> </span><span>context_parser</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> cla_method'</span><span class="main"><span>:</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.method</span></span><span class="main"><span>)</span></span><span> </span><span>context_parser</span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>functor</span></span></span><span> </span><span class="entity"><span>Classical</span></span><span class="main"><span>(</span></span><span>Data</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>CLASSICAL_DATA</span></span><span class="main"><span>)</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>CLASSICAL</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="comment1"><span>(** classical elimination rules **)</span></span><span>

</span><span class="comment1"><span>(*
Classical reasoning requires stronger elimination rules.  For
instance, make_elim of Pure transforms the HOL rule injD into

    [| inj f; f x = f y; x = y ==&gt; PROP W |] ==&gt; PROP W

Such rules can cause fast_tac to fail and blast_tac to report "PROOF
FAILED"; classical_rule will strengthen this to

    [| inj f; ~ W ==&gt; f x = f y; x = y ==&gt; W |] ==&gt; W
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>classical_rule</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>is_some</span><span> </span><span class="main"><span>(</span></span><span>Object_Logic.elim_concl</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rule'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>Data.classical</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>concl'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.concl_of</span><span> </span><span class="entity"><span>rule'</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>redundant_hyp</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>concl'</span></span><span> </span><span>aconv</span><span> </span><span>Logic.strip_assums_concl</span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Logic.strip_assums_hyp</span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
            </span><span class="entity"><span>hyp</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>hyps</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>aconv</span><span> </span><span class="entity"><span>hyp</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>hyps</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rule''</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>rule'</span></span><span> </span><span>|&gt;</span><span> </span><span>ALLGOALS</span><span> </span><span class="main"><span>(</span></span><span>SUBGOAL</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>goal</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>redundant_hyp</span></span><span> </span><span class="entity"><span>goal</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>eresolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span>thin_rl</span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>i</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>all_tac</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>Seq.hd</span><span>
        </span><span>|&gt;</span><span> </span><span>Drule.zero_var_indexes</span><span class="main"><span>;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Thm.equiv_thm</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rule''</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>rule''</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*flatten nested meta connectives in prems*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>flat_rule</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Conv.fconv_rule</span><span> </span><span class="main"><span>(</span></span><span>Conv.prems_conv</span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="main"><span>(</span></span><span>Object_Logic.atomize_prems</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(*** Useful tactics for classical reasoning ***)</span></span><span>

</span><span class="comment1"><span>(*Prove goal that assumes both P and ~P.
  No backtracking if it finds an equal assumption.  Perhaps should call
  ematch_tac instead of eresolve_tac, but then cannot prove ZF/cantor.*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>contr_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>eresolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Data.not_elim</span></span><span class="main"><span>]</span></span><span> </span><span>THEN'</span><span> </span><span class="main"><span>(</span></span><span>eq_assume_tac</span><span> </span><span>ORELSE'</span><span> </span><span>assume_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Finds P--&gt;Q and P in the assumptions, replaces implication by Q.
  Could do the same thing for P&lt;-&gt;Q and P... *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mp_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>eresolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Data.not_elim</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Data.imp_elim</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>THEN</span><span> </span><span>assume_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Like mp_tac but instantiates no variables*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>eq_mp_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>ematch_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Data.not_elim</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Data.imp_elim</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>THEN</span><span> </span><span>eq_assume_tac</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Creates rules to eliminate ~A, from rules to introduce A*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>swapify</span></span><span> </span><span class="entity"><span>intrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>intrs</span></span><span> </span><span>RLN</span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>2</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Data.swap</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>swapped</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.rule_attribute</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span>RSN</span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Data.swap</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Uses introduction rules in the normal way, or on negated assumptions,
  trying rules in order. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>swap_res_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rls</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>transfer</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.transfer'</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>addrl</span></span><span> </span><span class="entity"><span>rl</span></span><span> </span><span class="entity"><span>brls</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>transfer</span></span><span> </span><span class="entity"><span>rl</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="main"><span>(</span></span><span>true</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>transfer</span></span><span> </span><span class="entity"><span>rl</span></span><span> </span><span>RSN</span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Data.swap</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>brls</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>assume_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>ORELSE'</span><span>
    </span><span class="entity"><span>contr_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>ORELSE'</span><span>
    </span><span>biresolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>fold_rev</span><span> </span><span class="entity"><span>addrl</span></span><span> </span><span class="entity"><span>rls</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Duplication of unsafe rules, for complete provers*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dup_intr</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>zero_var_indexes</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>Data.classical</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dup_elim</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span> </span><span>RSN</span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>2</span></span><span class="main"><span>,</span></span><span> </span><span>revcut_rl</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>Thm.assumption</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span>|&gt;</span><span> </span><span>Seq.hd</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>rule_by_tactic</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>TRYALL</span><span> </span><span class="main"><span>(</span></span><span>eresolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span>revcut_rl</span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rl</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(**** Classical rule sets ****)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>thm</span><span> * </span><span class="main"><span>(</span></span><span>thm</span><span> * </span><span>thm</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> * </span><span class="main"><span>(</span></span><span>thm</span><span> * </span><span>thm</span><span> </span><span>list</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="comment1"><span>(*external form, internal form (possibly swapped), dup form (possibly swapped)*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>netpair</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>int</span><span> * </span><span class="main"><span>(</span></span><span>bool</span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>Net.net</span><span> * </span><span class="main"><span>(</span></span><span>int</span><span> * </span><span class="main"><span>(</span></span><span>bool</span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>Net.net</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>wrapper</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>claset</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>CS</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
   </span><span class="main"><span>{</span></span><span>safeIs</span><span class="main"><span>:</span></span><span> rule Item_Net.T</span><span class="main"><span>,</span></span><span>  </span><span class="comment1"><span>(*safe introduction rules*)</span></span><span>
    safeEs</span><span class="main"><span>:</span></span><span> rule Item_Net.T</span><span class="main"><span>,</span></span><span>  </span><span class="comment1"><span>(*safe elimination rules*)</span></span><span>
    unsafeIs</span><span class="main"><span>:</span></span><span> rule Item_Net.T</span><span class="main"><span>,</span></span><span>  </span><span class="comment1"><span>(*unsafe introduction rules*)</span></span><span>
    unsafeEs</span><span class="main"><span>:</span></span><span> rule Item_Net.T</span><span class="main"><span>,</span></span><span>  </span><span class="comment1"><span>(*unsafe elimination rules*)</span></span><span>
    swrappers</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string * </span><span class="main"><span>(</span></span><span>Proof.context </span><span class="main"><span>-&gt;</span></span><span> wrapper</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> list</span><span class="main"><span>,</span></span><span>  </span><span class="comment1"><span>(*for transforming safe_step_tac*)</span></span><span>
    uwrappers</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>string * </span><span class="main"><span>(</span></span><span>Proof.context </span><span class="main"><span>-&gt;</span></span><span> wrapper</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> list</span><span class="main"><span>,</span></span><span>  </span><span class="comment1"><span>(*for transforming step_tac*)</span></span><span>
    safe0_netpair</span><span class="main"><span>:</span></span><span> netpair</span><span class="main"><span>,</span></span><span>  </span><span class="comment1"><span>(*nets for trivial cases*)</span></span><span>
    safep_netpair</span><span class="main"><span>:</span></span><span> netpair</span><span class="main"><span>,</span></span><span>  </span><span class="comment1"><span>(*nets for &gt;0 subgoals*)</span></span><span>
    unsafe_netpair</span><span class="main"><span>:</span></span><span> netpair</span><span class="main"><span>,</span></span><span>  </span><span class="comment1"><span>(*nets for unsafe rules*)</span></span><span>
    dup_netpair</span><span class="main"><span>:</span></span><span> netpair</span><span class="main"><span>,</span></span><span>  </span><span class="comment1"><span>(*nets for duplication*)</span></span><span>
    extra_netpair</span><span class="main"><span>:</span></span><span> Context_Rules.netpair</span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>  </span><span class="comment1"><span>(*nets for extra rules*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty_rules</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span>Item_Net.T</span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Item_Net.init</span><span> </span><span class="main"><span>(</span></span><span>Thm.eq_thm_prop</span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>single</span><span> </span><span>o</span><span> </span><span>Thm.full_prop_of</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty_netpair</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Net.empty</span><span class="main"><span>,</span></span><span> </span><span>Net.empty</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty_cs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>CS</span></span><span>
   </span><span class="main"><span>{</span></span><span>safeIs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>empty_rules</span></span><span class="main"><span>,</span></span><span>
    </span><span>safeEs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>empty_rules</span></span><span class="main"><span>,</span></span><span>
    </span><span>unsafeIs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>empty_rules</span></span><span class="main"><span>,</span></span><span>
    </span><span>unsafeEs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>empty_rules</span></span><span class="main"><span>,</span></span><span>
    </span><span>swrappers</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
    </span><span>uwrappers</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
    </span><span>safe0_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>empty_netpair</span></span><span class="main"><span>,</span></span><span>
    </span><span>safep_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>empty_netpair</span></span><span class="main"><span>,</span></span><span>
    </span><span>unsafe_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>empty_netpair</span></span><span class="main"><span>,</span></span><span>
    </span><span>dup_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>empty_netpair</span></span><span class="main"><span>,</span></span><span>
    </span><span>extra_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>empty_netpair</span></span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rep_cs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CS</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(*** Adding (un)safe introduction or elimination rules.

    In case of overlap, new rules are tried BEFORE old ones!!
***)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>joinrules</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>intrs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>elims</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>elims</span></span><span> </span><span>@</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>intrs</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Priority: prefer rules with fewest subgoals,
  then rules added most recently (preferring the head of the list).*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tag_brls</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>tag_brls</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>brl</span></span><span>::</span><span class="entity"><span>brls</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1000000</span></span><span>*</span><span>subgoals_of_brl</span><span> </span><span class="entity"><span>brl</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>brl</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span>
      </span><span class="entity"><span>tag_brls</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>brls</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tag_brls'</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>tag_brls'</span></span><span> </span><span class="entity"><span>w</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>brl</span></span><span>::</span><span class="entity"><span>brls</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>w</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>brl</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>tag_brls'</span></span><span> </span><span class="entity"><span>w</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>brls</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>insert_tagged_list</span></span><span> </span><span class="entity"><span>rls</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span>Tactic.insert_tagged_brl</span><span> </span><span class="entity"><span>rls</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Insert into netpair that already has nI intr rules and nE elim rules.
  Count the intr rules double (to account for swapify).  Negate to give the
  new insertions the lowest priority.*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>insert</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nI</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nE</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>insert_tagged_list</span></span><span> </span><span>o</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tag_brls</span></span><span> </span><span class="main"><span>(</span></span><span>~</span><span class="main"><span>(</span></span><span class="inner_numeral"><span>2</span></span><span>*</span><span class="entity"><span>nI</span></span><span>+</span><span class="entity"><span>nE</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>joinrules</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>insert'</span></span><span> </span><span class="entity"><span>w</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nI</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nE</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>insert_tagged_list</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>tag_brls'</span></span><span> </span><span class="entity"><span>w</span></span><span> </span><span class="main"><span>(</span></span><span>~</span><span class="main"><span>(</span></span><span class="entity"><span>nI</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>nE</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>joinrules</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>delete_tagged_list</span></span><span> </span><span class="entity"><span>rls</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span>Tactic.delete_tagged_brl</span><span> </span><span class="entity"><span>rls</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>delete</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>delete_tagged_list</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>joinrules</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>bad_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>msg</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"\n"</span></span><span> </span><span>^</span><span> </span><span>Thm.string_of_thm</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_elim</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>has_fewer_prems</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>bad_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_quoted"><span>"Ill-formed destruction rule"</span></span><span> </span><span class="entity"><span>th</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Tactic.make_elim</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>warn_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Context_Position.is_really_visible</span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>warning</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>msg</span></span><span> </span><span>^</span><span> </span><span>Thm.string_of_thm</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>warn_rules</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Item_Net.member</span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>warn_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>warn_claset</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CS</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>safeIs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>safeEs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unsafeIs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unsafeEs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>warn_rules</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_quoted"><span>"Rule already declared as safe introduction (intro!)\n"</span></span><span> </span><span class="entity"><span>safeIs</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
  </span><span class="entity"><span>warn_rules</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_quoted"><span>"Rule already declared as safe elimination (elim!)\n"</span></span><span> </span><span class="entity"><span>safeEs</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
  </span><span class="entity"><span>warn_rules</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_quoted"><span>"Rule already declared as introduction (intro)\n"</span></span><span> </span><span class="entity"><span>unsafeIs</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
  </span><span class="entity"><span>warn_rules</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_quoted"><span>"Rule already declared as elimination (elim)\n"</span></span><span> </span><span class="entity"><span>unsafeEs</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(*** add rules ***)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_safe_intro</span></span><span> </span><span class="entity"><span>w</span></span><span> </span><span class="entity"><span>r</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>cs</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>CS</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>safeIs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>safeEs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unsafeIs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unsafeEs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>swrappers</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>uwrappers</span></span><span class="main"><span>,</span></span><span>
      </span><span class="entity"><span>safe0_netpair</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>safep_netpair</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unsafe_netpair</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>dup_netpair</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extra_netpair</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Item_Net.member</span><span> </span><span class="entity"><span>safeIs</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>cs</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rl</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>safe0_rls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>safep_rls</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="comment1"><span>(*0 subgoals vs 1 or more*)</span></span><span>
        </span><span>List.partition</span><span> </span><span class="main"><span>(</span></span><span>Thm.no_prems</span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rl</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nI</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Item_Net.length</span><span> </span><span class="entity"><span>safeIs</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nE</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Item_Net.length</span><span> </span><span class="entity"><span>safeEs</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>CS</span></span><span>
       </span><span class="main"><span>{</span></span><span>safeIs</span><span> </span><span class="main"><span>=</span></span><span> </span><span>Item_Net.update</span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>safeIs</span></span><span class="main"><span>,</span></span><span>
        </span><span>safe0_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>insert</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nI</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nE</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>safe0_rls</span></span><span class="main"><span>,</span></span><span> </span><span>maps</span><span> </span><span>snd</span><span> </span><span class="entity"><span>safe0_rls</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>safe0_netpair</span></span><span class="main"><span>,</span></span><span>
        </span><span>safep_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>insert</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nI</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nE</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>safep_rls</span></span><span class="main"><span>,</span></span><span> </span><span>maps</span><span> </span><span>snd</span><span> </span><span class="entity"><span>safep_rls</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>safep_netpair</span></span><span class="main"><span>,</span></span><span>
        </span><span>safeEs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>safeEs</span></span><span class="main"><span>,</span></span><span>
        </span><span>unsafeIs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unsafeIs</span></span><span class="main"><span>,</span></span><span>
        </span><span>unsafeEs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unsafeEs</span></span><span class="main"><span>,</span></span><span>
        </span><span>swrappers</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>swrappers</span></span><span class="main"><span>,</span></span><span>
        </span><span>uwrappers</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>uwrappers</span></span><span class="main"><span>,</span></span><span>
        </span><span>unsafe_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unsafe_netpair</span></span><span class="main"><span>,</span></span><span>
        </span><span>dup_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dup_netpair</span></span><span class="main"><span>,</span></span><span>
        </span><span>extra_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>insert'</span></span><span> </span><span class="main"><span>(</span></span><span>the_default</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="entity"><span>w</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nI</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nE</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>th</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>extra_netpair</span></span><span class="main"><span>}</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_safe_elim</span></span><span> </span><span class="entity"><span>w</span></span><span> </span><span class="entity"><span>r</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>cs</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>CS</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>safeIs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>safeEs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unsafeIs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unsafeEs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>swrappers</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>uwrappers</span></span><span class="main"><span>,</span></span><span>
      </span><span class="entity"><span>safe0_netpair</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>safep_netpair</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unsafe_netpair</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>dup_netpair</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extra_netpair</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Item_Net.member</span><span> </span><span class="entity"><span>safeEs</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>cs</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rl</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>safe0_rls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>safep_rls</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="comment1"><span>(*0 subgoals vs 1 or more*)</span></span><span>
        </span><span>List.partition</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rl</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Thm.nprems_of</span><span> </span><span class="entity"><span>rl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rl</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nI</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Item_Net.length</span><span> </span><span class="entity"><span>safeIs</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nE</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Item_Net.length</span><span> </span><span class="entity"><span>safeEs</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>CS</span></span><span>
       </span><span class="main"><span>{</span></span><span>safeEs</span><span> </span><span class="main"><span>=</span></span><span> </span><span>Item_Net.update</span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>safeEs</span></span><span class="main"><span>,</span></span><span>
        </span><span>safe0_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>insert</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nI</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nE</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>safe0_rls</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>safe0_netpair</span></span><span class="main"><span>,</span></span><span>
        </span><span>safep_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>insert</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nI</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nE</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>safep_rls</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>safep_netpair</span></span><span class="main"><span>,</span></span><span>
        </span><span>safeIs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>safeIs</span></span><span class="main"><span>,</span></span><span>
        </span><span>unsafeIs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unsafeIs</span></span><span class="main"><span>,</span></span><span>
        </span><span>unsafeEs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unsafeEs</span></span><span class="main"><span>,</span></span><span>
        </span><span>swrappers</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>swrappers</span></span><span class="main"><span>,</span></span><span>
        </span><span>uwrappers</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>uwrappers</span></span><span class="main"><span>,</span></span><span>
        </span><span>unsafe_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unsafe_netpair</span></span><span class="main"><span>,</span></span><span>
        </span><span>dup_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dup_netpair</span></span><span class="main"><span>,</span></span><span>
        </span><span>extra_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>insert'</span></span><span> </span><span class="main"><span>(</span></span><span>the_default</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="entity"><span>w</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nI</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nE</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>th</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>extra_netpair</span></span><span class="main"><span>}</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_unsafe_intro</span></span><span> </span><span class="entity"><span>w</span></span><span> </span><span class="entity"><span>r</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>cs</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>CS</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>safeIs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>safeEs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unsafeIs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unsafeEs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>swrappers</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>uwrappers</span></span><span class="main"><span>,</span></span><span>
      </span><span class="entity"><span>safe0_netpair</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>safep_netpair</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unsafe_netpair</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>dup_netpair</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extra_netpair</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Item_Net.member</span><span> </span><span class="entity"><span>unsafeIs</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>cs</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>dup_rl</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nI</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Item_Net.length</span><span> </span><span class="entity"><span>unsafeIs</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nE</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Item_Net.length</span><span> </span><span class="entity"><span>unsafeEs</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>CS</span></span><span>
       </span><span class="main"><span>{</span></span><span>unsafeIs</span><span> </span><span class="main"><span>=</span></span><span> </span><span>Item_Net.update</span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>unsafeIs</span></span><span class="main"><span>,</span></span><span>
        </span><span>unsafe_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>insert</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nI</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nE</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span>fst</span><span> </span><span class="entity"><span>rl</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span>snd</span><span> </span><span class="entity"><span>rl</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>unsafe_netpair</span></span><span class="main"><span>,</span></span><span>
        </span><span>dup_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>insert</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nI</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nE</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span>fst</span><span> </span><span class="entity"><span>dup_rl</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span>snd</span><span> </span><span class="entity"><span>dup_rl</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>dup_netpair</span></span><span class="main"><span>,</span></span><span>
        </span><span>safeIs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>safeIs</span></span><span class="main"><span>,</span></span><span>
        </span><span>safeEs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>safeEs</span></span><span class="main"><span>,</span></span><span>
        </span><span>unsafeEs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unsafeEs</span></span><span class="main"><span>,</span></span><span>
        </span><span>swrappers</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>swrappers</span></span><span class="main"><span>,</span></span><span>
        </span><span>uwrappers</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>uwrappers</span></span><span class="main"><span>,</span></span><span>
        </span><span>safe0_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>safe0_netpair</span></span><span class="main"><span>,</span></span><span>
        </span><span>safep_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>safep_netpair</span></span><span class="main"><span>,</span></span><span>
        </span><span>extra_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>insert'</span></span><span> </span><span class="main"><span>(</span></span><span>the_default</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>w</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nI</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nE</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>th</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>extra_netpair</span></span><span class="main"><span>}</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_unsafe_elim</span></span><span> </span><span class="entity"><span>w</span></span><span> </span><span class="entity"><span>r</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>cs</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>CS</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>safeIs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>safeEs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unsafeIs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unsafeEs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>swrappers</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>uwrappers</span></span><span class="main"><span>,</span></span><span>
      </span><span class="entity"><span>safe0_netpair</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>safep_netpair</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unsafe_netpair</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>dup_netpair</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extra_netpair</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Item_Net.member</span><span> </span><span class="entity"><span>unsafeEs</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>cs</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>dup_rl</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nI</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Item_Net.length</span><span> </span><span class="entity"><span>unsafeIs</span></span><span class="main"><span>;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nE</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Item_Net.length</span><span> </span><span class="entity"><span>unsafeEs</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span class="entity"><span>CS</span></span><span>
       </span><span class="main"><span>{</span></span><span>unsafeEs</span><span> </span><span class="main"><span>=</span></span><span> </span><span>Item_Net.update</span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>unsafeEs</span></span><span class="main"><span>,</span></span><span>
        </span><span>unsafe_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>insert</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nI</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nE</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span>fst</span><span> </span><span class="entity"><span>rl</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>unsafe_netpair</span></span><span class="main"><span>,</span></span><span>
        </span><span>dup_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>insert</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nI</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nE</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span>fst</span><span> </span><span class="entity"><span>dup_rl</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>dup_netpair</span></span><span class="main"><span>,</span></span><span>
        </span><span>safeIs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>safeIs</span></span><span class="main"><span>,</span></span><span>
        </span><span>safeEs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>safeEs</span></span><span class="main"><span>,</span></span><span>
        </span><span>unsafeIs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unsafeIs</span></span><span class="main"><span>,</span></span><span>
        </span><span>swrappers</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>swrappers</span></span><span class="main"><span>,</span></span><span>
        </span><span>uwrappers</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>uwrappers</span></span><span class="main"><span>,</span></span><span>
        </span><span>safe0_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>safe0_netpair</span></span><span class="main"><span>,</span></span><span>
        </span><span>safep_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>safep_netpair</span></span><span class="main"><span>,</span></span><span>
        </span><span>extra_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>insert'</span></span><span> </span><span class="main"><span>(</span></span><span>the_default</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>w</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nI</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>nE</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>th</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>extra_netpair</span></span><span class="main"><span>}</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>trim_context</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ths1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ths2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span>Thm.trim_context</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>,</span></span><span>
    </span><span class="main"><span>(</span></span><span>Thm.trim_context</span><span> </span><span class="entity"><span>th1</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span>Thm.trim_context</span><span> </span><span class="entity"><span>ths1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
    </span><span class="main"><span>(</span></span><span>Thm.trim_context</span><span> </span><span class="entity"><span>th2</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span>Thm.trim_context</span><span> </span><span class="entity"><span>ths2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>addSI</span></span><span> </span><span class="entity"><span>w</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cs</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>CS</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>safeIs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>th'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>flat_rule</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>swapify</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>th'</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>trim_context</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rl</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>warn_rules</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_quoted"><span>"Ignoring duplicate safe introduction (intro!)\n"</span></span><span> </span><span class="entity"><span>safeIs</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
      </span><span class="entity"><span>warn_claset</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>cs</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>add_safe_intro</span></span><span> </span><span class="entity"><span>w</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>cs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>addSE</span></span><span> </span><span class="entity"><span>w</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cs</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>CS</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>safeEs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>has_fewer_prems</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>bad_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_quoted"><span>"Ill-formed elimination rule"</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>th'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>classical_rule</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>flat_rule</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>trim_context</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rl</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>warn_rules</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_quoted"><span>"Ignoring duplicate safe elimination (elim!)\n"</span></span><span> </span><span class="entity"><span>safeEs</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
      </span><span class="entity"><span>warn_claset</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>cs</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>add_safe_elim</span></span><span> </span><span class="entity"><span>w</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>cs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>addSD</span></span><span> </span><span class="entity"><span>w</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>addSE</span></span><span> </span><span class="entity"><span>w</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>make_elim</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>addI</span></span><span> </span><span class="entity"><span>w</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cs</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>CS</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>unsafeIs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>th'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>flat_rule</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dup_th'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dup_intr</span></span><span> </span><span class="entity"><span>th'</span></span><span> </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>bad_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_quoted"><span>"Ill-formed introduction rule"</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>trim_context</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>swapify</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>th'</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dup_th'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>swapify</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>dup_th'</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>warn_rules</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_quoted"><span>"Ignoring duplicate introduction (intro)\n"</span></span><span> </span><span class="entity"><span>unsafeIs</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
      </span><span class="entity"><span>warn_claset</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>cs</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>add_unsafe_intro</span></span><span> </span><span class="entity"><span>w</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>cs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>addE</span></span><span> </span><span class="entity"><span>w</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cs</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>CS</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>unsafeEs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>has_fewer_prems</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>bad_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_quoted"><span>"Ill-formed elimination rule"</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>th'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>classical_rule</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>flat_rule</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dup_th'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dup_elim</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>th'</span></span><span> </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>bad_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_quoted"><span>"Ill-formed elimination rule"</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>trim_context</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dup_th'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>warn_rules</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_quoted"><span>"Ignoring duplicate elimination (elim)\n"</span></span><span> </span><span class="entity"><span>unsafeEs</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
      </span><span class="entity"><span>warn_claset</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>cs</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>add_unsafe_elim</span></span><span> </span><span class="entity"><span>w</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>cs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>addD</span></span><span> </span><span class="entity"><span>w</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>addE</span></span><span> </span><span class="entity"><span>w</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>make_elim</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(*** delete rules ***)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>del_safe_intro</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>CS</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>safeIs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>safeEs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unsafeIs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unsafeEs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>swrappers</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>uwrappers</span></span><span class="main"><span>,</span></span><span>
    </span><span class="entity"><span>safe0_netpair</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>safep_netpair</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unsafe_netpair</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>dup_netpair</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extra_netpair</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rl</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>safe0_rls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>safep_rls</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.partition</span><span> </span><span class="main"><span>(</span></span><span>Thm.no_prems</span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rl</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>CS</span></span><span>
     </span><span class="main"><span>{</span></span><span>safe0_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>delete</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>safe0_rls</span></span><span class="main"><span>,</span></span><span> </span><span>maps</span><span> </span><span>snd</span><span> </span><span class="entity"><span>safe0_rls</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>safe0_netpair</span></span><span class="main"><span>,</span></span><span>
      </span><span>safep_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>delete</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>safep_rls</span></span><span class="main"><span>,</span></span><span> </span><span>maps</span><span> </span><span>snd</span><span> </span><span class="entity"><span>safep_rls</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>safep_netpair</span></span><span class="main"><span>,</span></span><span>
      </span><span>safeIs</span><span> </span><span class="main"><span>=</span></span><span> </span><span>Item_Net.remove</span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>safeIs</span></span><span class="main"><span>,</span></span><span>
      </span><span>safeEs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>safeEs</span></span><span class="main"><span>,</span></span><span>
      </span><span>unsafeIs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unsafeIs</span></span><span class="main"><span>,</span></span><span>
      </span><span>unsafeEs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unsafeEs</span></span><span class="main"><span>,</span></span><span>
      </span><span>swrappers</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>swrappers</span></span><span class="main"><span>,</span></span><span>
      </span><span>uwrappers</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>uwrappers</span></span><span class="main"><span>,</span></span><span>
      </span><span>unsafe_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unsafe_netpair</span></span><span class="main"><span>,</span></span><span>
      </span><span>dup_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dup_netpair</span></span><span class="main"><span>,</span></span><span>
      </span><span>extra_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>delete</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>th</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>extra_netpair</span></span><span class="main"><span>}</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>del_safe_elim</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>CS</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>safeIs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>safeEs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unsafeIs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unsafeEs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>swrappers</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>uwrappers</span></span><span class="main"><span>,</span></span><span>
    </span><span class="entity"><span>safe0_netpair</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>safep_netpair</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unsafe_netpair</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>dup_netpair</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extra_netpair</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rl</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>safe0_rls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>safep_rls</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.partition</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rl</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Thm.nprems_of</span><span> </span><span class="entity"><span>rl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rl</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>CS</span></span><span>
     </span><span class="main"><span>{</span></span><span>safe0_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>delete</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>safe0_rls</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>safe0_netpair</span></span><span class="main"><span>,</span></span><span>
      </span><span>safep_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>delete</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>safep_rls</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>safep_netpair</span></span><span class="main"><span>,</span></span><span>
      </span><span>safeIs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>safeIs</span></span><span class="main"><span>,</span></span><span>
      </span><span>safeEs</span><span> </span><span class="main"><span>=</span></span><span> </span><span>Item_Net.remove</span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>safeEs</span></span><span class="main"><span>,</span></span><span>
      </span><span>unsafeIs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unsafeIs</span></span><span class="main"><span>,</span></span><span>
      </span><span>unsafeEs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unsafeEs</span></span><span class="main"><span>,</span></span><span>
      </span><span>swrappers</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>swrappers</span></span><span class="main"><span>,</span></span><span>
      </span><span>uwrappers</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>uwrappers</span></span><span class="main"><span>,</span></span><span>
      </span><span>unsafe_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unsafe_netpair</span></span><span class="main"><span>,</span></span><span>
      </span><span>dup_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dup_netpair</span></span><span class="main"><span>,</span></span><span>
      </span><span>extra_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>delete</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>th</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>extra_netpair</span></span><span class="main"><span>}</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>del_unsafe_intro</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>swapped_th'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dup_th'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>swapped_dup_th'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>CS</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>safeIs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>safeEs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unsafeIs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unsafeEs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>swrappers</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>uwrappers</span></span><span class="main"><span>,</span></span><span>
    </span><span class="entity"><span>safe0_netpair</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>safep_netpair</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unsafe_netpair</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>dup_netpair</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extra_netpair</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>CS</span></span><span>
   </span><span class="main"><span>{</span></span><span>unsafe_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>delete</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>th'</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>swapped_th'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>unsafe_netpair</span></span><span class="main"><span>,</span></span><span>
    </span><span>dup_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>delete</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>dup_th'</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>swapped_dup_th'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>dup_netpair</span></span><span class="main"><span>,</span></span><span>
    </span><span>safeIs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>safeIs</span></span><span class="main"><span>,</span></span><span>
    </span><span>safeEs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>safeEs</span></span><span class="main"><span>,</span></span><span>
    </span><span>unsafeIs</span><span> </span><span class="main"><span>=</span></span><span> </span><span>Item_Net.remove</span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>unsafeIs</span></span><span class="main"><span>,</span></span><span>
    </span><span>unsafeEs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unsafeEs</span></span><span class="main"><span>,</span></span><span>
    </span><span>swrappers</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>swrappers</span></span><span class="main"><span>,</span></span><span>
    </span><span>uwrappers</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>uwrappers</span></span><span class="main"><span>,</span></span><span>
    </span><span>safe0_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>safe0_netpair</span></span><span class="main"><span>,</span></span><span>
    </span><span>safep_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>safep_netpair</span></span><span class="main"><span>,</span></span><span>
    </span><span>extra_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>delete</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>th</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>extra_netpair</span></span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>del_unsafe_elim</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dup_th'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>CS</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>safeIs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>safeEs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unsafeIs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unsafeEs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>swrappers</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>uwrappers</span></span><span class="main"><span>,</span></span><span>
    </span><span class="entity"><span>safe0_netpair</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>safep_netpair</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unsafe_netpair</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>dup_netpair</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extra_netpair</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>CS</span></span><span>
   </span><span class="main"><span>{</span></span><span>unsafe_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>delete</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>th'</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>unsafe_netpair</span></span><span class="main"><span>,</span></span><span>
    </span><span>dup_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>delete</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>dup_th'</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>dup_netpair</span></span><span class="main"><span>,</span></span><span>
    </span><span>safeIs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>safeIs</span></span><span class="main"><span>,</span></span><span>
    </span><span>safeEs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>safeEs</span></span><span class="main"><span>,</span></span><span>
    </span><span>unsafeIs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unsafeIs</span></span><span class="main"><span>,</span></span><span>
    </span><span>unsafeEs</span><span> </span><span class="main"><span>=</span></span><span> </span><span>Item_Net.remove</span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="entity"><span>unsafeEs</span></span><span class="main"><span>,</span></span><span>
    </span><span>swrappers</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>swrappers</span></span><span class="main"><span>,</span></span><span>
    </span><span>uwrappers</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>uwrappers</span></span><span class="main"><span>,</span></span><span>
    </span><span>safe0_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>safe0_netpair</span></span><span class="main"><span>,</span></span><span>
    </span><span>safep_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>safep_netpair</span></span><span class="main"><span>,</span></span><span>
    </span><span>extra_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>delete</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>th</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>extra_netpair</span></span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>del</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="entity"><span>cs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>fold</span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span>Item_Net.lookup</span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cs</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>delrule</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cs</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>CS</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>safeIs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>safeEs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unsafeIs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unsafeEs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>th'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Tactic.make_elim</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>r'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Item_Net.member</span><span> </span><span class="entity"><span>safeIs</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>Item_Net.member</span><span> </span><span class="entity"><span>safeEs</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
      </span><span>Item_Net.member</span><span> </span><span class="entity"><span>unsafeIs</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>Item_Net.member</span><span> </span><span class="entity"><span>unsafeEs</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
      </span><span>Item_Net.member</span><span> </span><span class="entity"><span>safeEs</span></span><span> </span><span class="entity"><span>r'</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>Item_Net.member</span><span> </span><span class="entity"><span>unsafeEs</span></span><span> </span><span class="entity"><span>r'</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="entity"><span>cs</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>del</span></span><span> </span><span class="entity"><span>del_safe_intro</span></span><span> </span><span class="entity"><span>safeIs</span></span><span> </span><span class="entity"><span>th</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>del</span></span><span> </span><span class="entity"><span>del_safe_elim</span></span><span> </span><span class="entity"><span>safeEs</span></span><span> </span><span class="entity"><span>th</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>del</span></span><span> </span><span class="entity"><span>del_safe_elim</span></span><span> </span><span class="entity"><span>safeEs</span></span><span> </span><span class="entity"><span>th'</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>del</span></span><span> </span><span class="entity"><span>del_unsafe_intro</span></span><span> </span><span class="entity"><span>unsafeIs</span></span><span> </span><span class="entity"><span>th</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>del</span></span><span> </span><span class="entity"><span>del_unsafe_elim</span></span><span> </span><span class="entity"><span>unsafeEs</span></span><span> </span><span class="entity"><span>th</span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>del</span></span><span> </span><span class="entity"><span>del_unsafe_elim</span></span><span> </span><span class="entity"><span>unsafeEs</span></span><span> </span><span class="entity"><span>th'</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>warn_thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_quoted"><span>"Undeclared classical rule\n"</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>;</span></span><span> </span><span class="entity"><span>cs</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>



</span><span class="comment1"><span>(** claset data **)</span></span><span>

</span><span class="comment1"><span>(* wrappers *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_swrappers</span></span><span> </span><span class="entity"><span>f</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>CS</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>safeIs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>safeEs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unsafeIs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unsafeEs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>swrappers</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>uwrappers</span></span><span class="main"><span>,</span></span><span>
    </span><span class="entity"><span>safe0_netpair</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>safep_netpair</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unsafe_netpair</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>dup_netpair</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extra_netpair</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>CS</span></span><span> </span><span class="main"><span>{</span></span><span>safeIs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>safeIs</span></span><span class="main"><span>,</span></span><span> </span><span>safeEs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>safeEs</span></span><span class="main"><span>,</span></span><span> </span><span>unsafeIs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unsafeIs</span></span><span class="main"><span>,</span></span><span> </span><span>unsafeEs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unsafeEs</span></span><span class="main"><span>,</span></span><span>
    </span><span>swrappers</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>swrappers</span></span><span class="main"><span>,</span></span><span> </span><span>uwrappers</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>uwrappers</span></span><span class="main"><span>,</span></span><span>
    </span><span>safe0_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>safe0_netpair</span></span><span class="main"><span>,</span></span><span> </span><span>safep_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>safep_netpair</span></span><span class="main"><span>,</span></span><span>
    </span><span>unsafe_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unsafe_netpair</span></span><span class="main"><span>,</span></span><span> </span><span>dup_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dup_netpair</span></span><span class="main"><span>,</span></span><span> </span><span>extra_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>extra_netpair</span></span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_uwrappers</span></span><span> </span><span class="entity"><span>f</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>CS</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>safeIs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>safeEs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unsafeIs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unsafeEs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>swrappers</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>uwrappers</span></span><span class="main"><span>,</span></span><span>
    </span><span class="entity"><span>safe0_netpair</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>safep_netpair</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unsafe_netpair</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>dup_netpair</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>extra_netpair</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>CS</span></span><span> </span><span class="main"><span>{</span></span><span>safeIs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>safeIs</span></span><span class="main"><span>,</span></span><span> </span><span>safeEs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>safeEs</span></span><span class="main"><span>,</span></span><span> </span><span>unsafeIs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unsafeIs</span></span><span class="main"><span>,</span></span><span> </span><span>unsafeEs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unsafeEs</span></span><span class="main"><span>,</span></span><span>
    </span><span>swrappers</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>swrappers</span></span><span class="main"><span>,</span></span><span> </span><span>uwrappers</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>uwrappers</span></span><span class="main"><span>,</span></span><span>
    </span><span>safe0_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>safe0_netpair</span></span><span class="main"><span>,</span></span><span> </span><span>safep_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>safep_netpair</span></span><span class="main"><span>,</span></span><span>
    </span><span>unsafe_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unsafe_netpair</span></span><span class="main"><span>,</span></span><span> </span><span>dup_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dup_netpair</span></span><span class="main"><span>,</span></span><span> </span><span>extra_netpair</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>extra_netpair</span></span><span class="main"><span>}</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* merge_cs *)</span></span><span>

</span><span class="comment1"><span>(*Merge works by adding all new rules of the 2nd claset into the 1st claset,
  in order to preserve priorities reliably.*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>merge_thms</span></span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="entity"><span>thms1</span></span><span> </span><span class="entity"><span>thms2</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Item_Net.member</span><span> </span><span class="entity"><span>thms1</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>I</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Item_Net.content</span><span> </span><span class="entity"><span>thms2</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>merge_cs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cs</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>CS</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>safeIs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>safeEs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unsafeIs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unsafeEs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span>
    </span><span class="entity"><span>cs'</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>CS</span></span><span> </span><span class="main"><span>{</span></span><span>safeIs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>safeIs2</span></span><span class="main"><span>,</span></span><span> </span><span>safeEs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>safeEs2</span></span><span class="main"><span>,</span></span><span> </span><span>unsafeIs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unsafeIs2</span></span><span class="main"><span>,</span></span><span> </span><span>unsafeEs</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>unsafeEs2</span></span><span class="main"><span>,</span></span><span>
      </span><span class="entity"><span>swrappers</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>uwrappers</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>pointer_eq</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cs'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>cs</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="entity"><span>cs</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>merge_thms</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_safe_intro</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>safeIs</span></span><span> </span><span class="entity"><span>safeIs2</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>merge_thms</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_safe_elim</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>safeEs</span></span><span> </span><span class="entity"><span>safeEs2</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>merge_thms</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_unsafe_intro</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>unsafeIs</span></span><span> </span><span class="entity"><span>unsafeIs2</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>merge_thms</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_unsafe_elim</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>unsafeEs</span></span><span> </span><span class="entity"><span>unsafeEs2</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>map_swrappers</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ws</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>AList.merge</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ws</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>swrappers</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>map_uwrappers</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ws</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>AList.merge</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ws</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>uwrappers</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* data *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Claset</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Generic_Data</span><span>
</span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>claset</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>empty_cs</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>merge</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>merge_cs</span></span><span class="main"><span>;</span></span><span>
</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>claset_of</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Claset.get</span><span> </span><span>o</span><span> </span><span>Context.Proof</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rep_claset_of</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rep_cs</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>claset_of</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get_cs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Claset.get</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>map_cs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Claset.map</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_theory_claset</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.init_global</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Context.theory_map</span><span> </span><span class="main"><span>(</span></span><span>Claset.map</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>claset_of</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thy'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_claset</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Context.proof_map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_cs</span></span><span> </span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>put_claset</span></span><span> </span><span class="entity"><span>cs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_claset</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="entity"><span>cs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>print_claset</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>safeIs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>safeEs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unsafeIs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unsafeEs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>swrappers</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>uwrappers</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rep_claset_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pretty_thms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Thm.pretty_thm_item</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>Item_Net.content</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="main"><span>[</span></span><span>Pretty.big_list</span><span> </span><span class="inner_quoted"><span>"safe introduction rules (intro!):"</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pretty_thms</span></span><span> </span><span class="entity"><span>safeIs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
      </span><span>Pretty.big_list</span><span> </span><span class="inner_quoted"><span>"introduction rules (intro):"</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pretty_thms</span></span><span> </span><span class="entity"><span>unsafeIs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
      </span><span>Pretty.big_list</span><span> </span><span class="inner_quoted"><span>"safe elimination rules (elim!):"</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pretty_thms</span></span><span> </span><span class="entity"><span>safeEs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
      </span><span>Pretty.big_list</span><span> </span><span class="inner_quoted"><span>"elimination rules (elim):"</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pretty_thms</span></span><span> </span><span class="entity"><span>unsafeEs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
      </span><span>Pretty.strs</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"safe wrappers:"</span></span><span> </span><span>::</span><span> </span><span>map</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>swrappers</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
      </span><span>Pretty.strs</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"unsafe wrappers:"</span></span><span> </span><span>::</span><span> </span><span>map</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>uwrappers</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Pretty.writeln_chunks</span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* old-style declarations *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>decl</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ths</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_claset</span></span><span> </span><span class="main"><span>(</span></span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ths</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="entity"><span>addSIs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>decl</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>addSI</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="entity"><span>addSEs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>decl</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>addSE</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="entity"><span>addSDs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>decl</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>addSD</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="entity"><span>addIs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>decl</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>addI</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="entity"><span>addEs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>decl</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>addE</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="entity"><span>addDs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>decl</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>addD</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="entity"><span>delrules</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>decl</span></span><span> </span><span class="entity"><span>delrule</span></span><span class="main"><span>;</span></span><span>



</span><span class="comment1"><span>(*** Modifying the wrapper tacticals ***)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>appSWrappers</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>w</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>w</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>swrappers</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rep_claset_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>appWrappers</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>w</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>w</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>uwrappers</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rep_claset_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>update_warn</span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>key</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span>string</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>AList.defined</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>warning</span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><span>AList.update</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>delete_warn</span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>key</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span>string</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>AList.defined</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>AList.delete</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="entity"><span>xs</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span>warning</span><span> </span><span class="entity"><span>msg</span></span><span class="main"><span>;</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Add/replace a safe wrapper*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>addSWrapper</span></span><span> </span><span class="entity"><span>new_swrapper</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>map_claset</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>map_swrappers</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>update_warn</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Overwriting safe wrapper "</span></span><span> </span><span>^</span><span> </span><span>fst</span><span> </span><span class="entity"><span>new_swrapper</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>new_swrapper</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Add/replace an unsafe wrapper*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>addWrapper</span></span><span> </span><span class="entity"><span>new_uwrapper</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>map_claset</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>map_uwrappers</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>update_warn</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Overwriting unsafe wrapper "</span></span><span> </span><span>^</span><span> </span><span>fst</span><span> </span><span class="entity"><span>new_uwrapper</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>new_uwrapper</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Remove a safe wrapper*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>delSWrapper</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>map_claset</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>map_swrappers</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>delete_warn</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"No such safe wrapper in claset: "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Remove an unsafe wrapper*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>delWrapper</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>map_claset</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>map_uwrappers</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>delete_warn</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"No such unsafe wrapper in claset: "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(* compose a safe tactic alternatively before/after safe_step_tac *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>addSbefore</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tac1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>addSWrapper</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>tac2</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>tac1</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>ORELSE'</span><span> </span><span class="entity"><span>tac2</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>addSafter</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tac2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>addSWrapper</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>tac1</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>tac1</span></span><span> </span><span>ORELSE'</span><span> </span><span class="entity"><span>tac2</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*compose a tactic alternatively before/after the step tactic *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>addbefore</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tac1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>addWrapper</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>tac2</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>tac1</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>APPEND'</span><span> </span><span class="entity"><span>tac2</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>addafter</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tac2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>addWrapper</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>tac1</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>tac1</span></span><span> </span><span>APPEND'</span><span> </span><span class="entity"><span>tac2</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>addD2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>addafter</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>dresolve_tac</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>thm</span></span><span class="main"><span>]</span></span><span> </span><span>THEN'</span><span> </span><span>assume_tac</span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>addE2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>addafter</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>eresolve_tac</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>thm</span></span><span class="main"><span>]</span></span><span> </span><span>THEN'</span><span> </span><span>assume_tac</span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>addSD2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>addSafter</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>dmatch_tac</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>thm</span></span><span class="main"><span>]</span></span><span> </span><span>THEN'</span><span> </span><span>eq_assume_tac</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>addSE2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>addSafter</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>ematch_tac</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>thm</span></span><span class="main"><span>]</span></span><span> </span><span>THEN'</span><span> </span><span>eq_assume_tac</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>



</span><span class="comment1"><span>(**** Simple tactics for theorem proving ****)</span></span><span>

</span><span class="comment1"><span>(*Attack subgoals using safe inferences -- matching, not resolution*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>safe_step_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>safe0_netpair</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>safep_netpair</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rep_claset_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>appSWrappers</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="main"><span>(</span></span><span>FIRST'</span><span>
       </span><span class="main"><span>[</span></span><span>eq_assume_tac</span><span class="main"><span>,</span></span><span>
        </span><span class="entity"><span>eq_mp_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span>
        </span><span>bimatch_from_nets_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>safe0_netpair</span></span><span class="main"><span>,</span></span><span>
        </span><span>FIRST'</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Data.hyp_subst_tacs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        </span><span>bimatch_from_nets_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>safep_netpair</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Repeatedly attack a subgoal using safe inferences -- it's deterministic!*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>safe_steps_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>REPEAT_DETERM1</span><span> </span><span>o</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>COND</span><span> </span><span class="main"><span>(</span></span><span>has_fewer_prems</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span>no_tac</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>safe_step_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Repeatedly attack subgoals using safe inferences -- it's deterministic!*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>safe_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>REPEAT_DETERM1</span><span> </span><span class="main"><span>(</span></span><span>FIRSTGOAL</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>safe_steps_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(*** Clarify_tac: do safe steps without causing branching ***)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>nsubgoalsP</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>brl</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>subgoals_of_brl</span><span> </span><span class="entity"><span>brl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*version of bimatch_from_nets_tac that only applies rules that
  create precisely n subgoals.*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>n_bimatch_from_nets_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>biresolution_from_nets_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>order_list</span><span> </span><span>o</span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nsubgoalsP</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>true</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>eq_contr_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>ematch_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Data.not_elim</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>THEN</span><span> </span><span>eq_assume_tac</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>eq_assume_contr_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>eq_assume_tac</span><span> </span><span>ORELSE'</span><span> </span><span class="entity"><span>eq_contr_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Two-way branching is allowed only if one of the branches immediately closes*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>bimatch2_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>netpair</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>n_bimatch_from_nets_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="entity"><span>netpair</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>THEN</span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>eq_assume_contr_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>ORELSE</span><span> </span><span class="entity"><span>eq_assume_contr_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Attack subgoals using safe inferences -- matching, not resolution*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>clarify_step_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>safe0_netpair</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>safep_netpair</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rep_claset_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>appSWrappers</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
     </span><span class="main"><span>(</span></span><span>FIRST'</span><span>
       </span><span class="main"><span>[</span></span><span class="entity"><span>eq_assume_contr_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span>
        </span><span>bimatch_from_nets_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>safe0_netpair</span></span><span class="main"><span>,</span></span><span>
        </span><span>FIRST'</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Data.hyp_subst_tacs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        </span><span class="entity"><span>n_bimatch_from_nets_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>safep_netpair</span></span><span class="main"><span>,</span></span><span>
        </span><span class="entity"><span>bimatch2_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>safep_netpair</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>clarify_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SELECT_GOAL</span><span> </span><span class="main"><span>(</span></span><span>REPEAT_DETERM</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>clarify_step_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(*** Unsafe steps instantiate variables or lose information ***)</span></span><span>

</span><span class="comment1"><span>(*Backtracking is allowed among the various these unsafe ways of
  proving a subgoal.  *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>inst0_step_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>assume_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>APPEND'</span><span>
  </span><span class="entity"><span>contr_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>APPEND'</span><span>
  </span><span>biresolve_from_nets_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>safe0_netpair</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rep_claset_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*These unsafe steps could generate more subgoals.*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>instp_step_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>biresolve_from_nets_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>safep_netpair</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rep_claset_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*These steps could instantiate variables and are therefore unsafe.*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>inst_step_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>inst0_step_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>APPEND'</span><span> </span><span class="entity"><span>instp_step_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unsafe_step_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>biresolve_from_nets_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>unsafe_netpair</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rep_claset_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Single step for the prover.  FAILS unless it makes progress. *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>step_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>safe_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>ORELSE</span><span> </span><span class="entity"><span>appWrappers</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inst_step_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>ORELSE'</span><span> </span><span class="entity"><span>unsafe_step_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Using a "safe" rule to instantiate variables is unsafe.  This tactic
  allows backtracking from "safe" rules to "unsafe" rules here.*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>slow_step_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>safe_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>ORELSE</span><span> </span><span class="entity"><span>appWrappers</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inst_step_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>APPEND'</span><span> </span><span class="entity"><span>unsafe_step_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(**** The following tactics all fail unless they solve one goal ****)</span></span><span>

</span><span class="comment1"><span>(*Dumb but fast*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fast_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Object_Logic.atomize_prems_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>THEN'</span><span> </span><span>SELECT_GOAL</span><span> </span><span class="main"><span>(</span></span><span>DEPTH_SOLVE</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>step_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Slower but smarter than fast_tac*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>best_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Object_Logic.atomize_prems_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>THEN'</span><span>
  </span><span>SELECT_GOAL</span><span> </span><span class="main"><span>(</span></span><span>BEST_FIRST</span><span> </span><span class="main"><span>(</span></span><span>has_fewer_prems</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Data.sizef</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>step_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*even a bit smarter than best_tac*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>first_best_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Object_Logic.atomize_prems_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>THEN'</span><span>
  </span><span>SELECT_GOAL</span><span> </span><span class="main"><span>(</span></span><span>BEST_FIRST</span><span> </span><span class="main"><span>(</span></span><span>has_fewer_prems</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Data.sizef</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>FIRSTGOAL</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>step_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>slow_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Object_Logic.atomize_prems_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>THEN'</span><span>
  </span><span>SELECT_GOAL</span><span> </span><span class="main"><span>(</span></span><span>DEPTH_SOLVE</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>slow_step_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>slow_best_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Object_Logic.atomize_prems_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>THEN'</span><span>
  </span><span>SELECT_GOAL</span><span> </span><span class="main"><span>(</span></span><span>BEST_FIRST</span><span> </span><span class="main"><span>(</span></span><span>has_fewer_prems</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Data.sizef</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>slow_step_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(***ASTAR with weight weight_ASTAR, by Norbert Voelker*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>weight_ASTAR</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>5</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>astar_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Object_Logic.atomize_prems_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>THEN'</span><span>
  </span><span>SELECT_GOAL</span><span>
    </span><span class="main"><span>(</span></span><span>ASTAR</span><span> </span><span class="main"><span>(</span></span><span>has_fewer_prems</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>lev</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Data.sizef</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>weight_ASTAR</span></span><span> </span><span>*</span><span> </span><span class="entity"><span>lev</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>step_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>slow_astar_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Object_Logic.atomize_prems_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>THEN'</span><span>
  </span><span>SELECT_GOAL</span><span>
    </span><span class="main"><span>(</span></span><span>ASTAR</span><span> </span><span class="main"><span>(</span></span><span>has_fewer_prems</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>lev</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Data.sizef</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>weight_ASTAR</span></span><span> </span><span>*</span><span> </span><span class="entity"><span>lev</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>slow_step_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(**** Complete tactic, loosely based upon LeanTaP.  This tactic is the outcome
  of much experimentation!  Changing APPEND to ORELSE below would prove
  easy theorems faster, but loses completeness -- and many of the harder
  theorems such as 43. ****)</span></span><span>

</span><span class="comment1"><span>(*Non-deterministic!  Could always expand the first unsafe connective.
  That's hard to implement and did not perform better in experiments, due to
  greater search depth required.*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dup_step_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>biresolve_from_nets_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>dup_netpair</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rep_claset_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Searching to depth m. A variant called nodup_depth_tac appears in clasimp.ML*)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>slow_step_tac'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>appWrappers</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>instp_step_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>APPEND'</span><span> </span><span class="entity"><span>dup_step_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>depth_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SELECT_GOAL</span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>safe_steps_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>THEN_ELSE</span><span>
      </span><span class="main"><span>(</span></span><span>DEPTH_SOLVE</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>depth_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        </span><span class="entity"><span>inst0_step_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>APPEND</span><span> </span><span>COND</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>no_tac</span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>slow_step_tac'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>THEN</span><span> </span><span>DEPTH_SOLVE</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>depth_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>state</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Search, with depth bound m.
  This is the "entry point", which does safe inferences first.*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>safe_depth_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SUBGOAL</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prem</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>deti</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="comment1"><span>(*No Vars in the goal?  No need to backtrack between goals.*)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>exists_subterm</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>Var</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prem</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>DETERM</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>I</span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>SELECT_GOAL</span><span> </span><span class="main"><span>(</span></span><span>TRY</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>safe_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span>THEN</span><span> </span><span>DEPTH_SOLVE</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>deti</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>depth_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>i</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>deepen_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>DEEPEN</span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>2</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>10</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>safe_depth_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* attributes *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>attrib</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Thm.declaration_attribute</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="entity"><span>map_cs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span>Context.proof_of</span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>safe_elim</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>attrib</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>addSE</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>safe_intro</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>attrib</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>addSI</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>safe_dest</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>attrib</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>addSD</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>unsafe_elim</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>attrib</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>addE</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>unsafe_intro</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>attrib</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>addI</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>unsafe_dest</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>attrib</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>addD</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rule_del</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Thm.declaration_attribute</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="entity"><span>context</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>map_cs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>delrule</span></span><span> </span><span class="main"><span>(</span></span><span>Context.proof_of</span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Thm.attribute_declaration</span><span> </span><span class="entity"><span>Context_Rules.rule_del</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>



</span><span class="comment1"><span>(** concrete syntax of attributes **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>introN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"intro"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>elimN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"elim"</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>destN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"dest"</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Theory.setup</span><span>
   </span><span class="main"><span>(</span></span><span class="entity"><span>Attrib.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="HOL.swapped|attribute"><span>swapped</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>Scan.succeed</span><span> </span><span class="entity"><span>swapped</span></span><span class="main"><span>)</span></span><span>
      </span><span class="inner_quoted"><span>"classical swap of introduction rule"</span></span><span> </span><span>#&gt;</span><span>
    </span><span class="entity"><span>Attrib.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="HOL.dest|attribute"><span>dest</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Context_Rules.add</span></span><span> </span><span class="entity"><span>safe_dest</span></span><span> </span><span class="entity"><span>unsafe_dest</span></span><span> </span><span class="entity"><span>Context_Rules.dest_query</span></span><span class="main"><span>)</span></span><span>
      </span><span class="inner_quoted"><span>"declaration of Classical destruction rule"</span></span><span> </span><span>#&gt;</span><span>
    </span><span class="entity"><span>Attrib.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="HOL.elim|attribute"><span>elim</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Context_Rules.add</span></span><span> </span><span class="entity"><span>safe_elim</span></span><span> </span><span class="entity"><span>unsafe_elim</span></span><span> </span><span class="entity"><span>Context_Rules.elim_query</span></span><span class="main"><span>)</span></span><span>
      </span><span class="inner_quoted"><span>"declaration of Classical elimination rule"</span></span><span> </span><span>#&gt;</span><span>
    </span><span class="entity"><span>Attrib.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="HOL.intro|attribute"><span>intro</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Context_Rules.add</span></span><span> </span><span class="entity"><span>safe_intro</span></span><span> </span><span class="entity"><span>unsafe_intro</span></span><span> </span><span class="entity"><span>Context_Rules.intro_query</span></span><span class="main"><span>)</span></span><span>
      </span><span class="inner_quoted"><span>"declaration of Classical introduction rule"</span></span><span> </span><span>#&gt;</span><span>
    </span><span class="entity"><span>Attrib.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="HOL.rule|attribute"><span>rule</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>Scan.lift</span><span> </span><span>Args.del</span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="entity"><span>rule_del</span></span><span class="main"><span>)</span></span><span>
      </span><span class="inner_quoted"><span>"remove declaration of intro/elim/dest rule"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>



</span><span class="comment1"><span>(** proof methods **)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>some_rule_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SUBGOAL</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>goal</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rules1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rules2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rules4</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Context_Rules.find_rules</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>extra_netpair</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rep_claset_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rules3</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Context_Rules.find_rules_netpair</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="entity"><span>extra_netpair</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rules1</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>rules2</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>rules3</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>rules4</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ruleq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Drule.multi_resolves</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="entity"><span>rules</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Method.trace</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rules</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Seq.maps</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rule</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>st</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ruleq</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
  </span><span>THEN_ALL_NEW</span><span> </span><span>Goal.norm_hhf_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rule_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>some_rule_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>facts</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rule_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Method.rule_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="entity"><span>facts</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>standard_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>HEADGOAL</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>some_rule_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>facts</span></span><span class="main"><span>)</span></span><span> </span><span>ORELSE</span><span>
  </span><span class="entity"><span>Class.standard_intro_classes_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>facts</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* automatic methods *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cla_modifiers</span></span><span> </span><span class="main"><span>=</span></span><span>
 </span><span class="main"><span>[</span></span><span>Args.$$$</span><span> </span><span class="entity"><span>destN</span></span><span> </span><span>--</span><span> </span><span>Args.bang_colon</span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Method.modifier</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>safe_dest</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span>Args.$$$</span><span> </span><span class="entity"><span>destN</span></span><span> </span><span>--</span><span> </span><span>Args.colon</span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Method.modifier</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unsafe_dest</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span>Args.$$$</span><span> </span><span class="entity"><span>elimN</span></span><span> </span><span>--</span><span> </span><span>Args.bang_colon</span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Method.modifier</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>safe_elim</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span>Args.$$$</span><span> </span><span class="entity"><span>elimN</span></span><span> </span><span>--</span><span> </span><span>Args.colon</span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Method.modifier</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unsafe_elim</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span>Args.$$$</span><span> </span><span class="entity"><span>introN</span></span><span> </span><span>--</span><span> </span><span>Args.bang_colon</span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Method.modifier</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>safe_intro</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span>Args.$$$</span><span> </span><span class="entity"><span>introN</span></span><span> </span><span>--</span><span> </span><span>Args.colon</span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Method.modifier</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unsafe_intro</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
  </span><span>Args.del</span><span> </span><span>--</span><span> </span><span>Args.colon</span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Method.modifier</span></span><span> </span><span class="entity"><span>rule_del</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cla_method</span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Method.sections</span></span><span> </span><span class="entity"><span>cla_modifiers</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SIMPLE_METHOD</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>tac</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cla_method'</span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Method.sections</span></span><span> </span><span class="entity"><span>cla_modifiers</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SIMPLE_METHOD'</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>tac</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>



</span><span class="comment1"><span>(** method setup **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Theory.setup</span><span>
   </span><span class="main"><span>(</span></span><span class="entity"><span>Method.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="HOL.standard|method"><span>standard</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>Scan.succeed</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>METHOD</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>standard_tac</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="inner_quoted"><span>"standard proof step: classical intro/elim rule or class introduction"</span></span><span> </span><span>#&gt;</span><span>
    </span><span class="entity"><span>Method.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="HOL.rule|method"><span>rule</span></span><span>›</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>Attrib.thms</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>METHOD</span></span><span> </span><span class="main"><span>(</span></span><span>HEADGOAL</span><span> </span><span>o</span><span> </span><span class="entity"><span>rule_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rules</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="inner_quoted"><span>"apply some intro/elim rule (potentially classical)"</span></span><span> </span><span>#&gt;</span><span>
    </span><span class="entity"><span>Method.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="HOL.contradiction|method"><span>contradiction</span></span><span>›</span></span></span><span>
      </span><span class="main"><span>(</span></span><span>Scan.succeed</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Method.rule</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Data.not_elim</span></span><span class="main"><span>,</span></span><span> </span><span>Drule.rotate_prems</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>Data.not_elim</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="inner_quoted"><span>"proof by contradiction"</span></span><span> </span><span>#&gt;</span><span>
    </span><span class="entity"><span>Method.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="HOL.clarify|method"><span>clarify</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cla_method'</span></span><span> </span><span class="main"><span>(</span></span><span>CHANGED_PROP</span><span> </span><span>oo</span><span> </span><span class="entity"><span>clarify_tac</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="inner_quoted"><span>"repeatedly apply safe steps"</span></span><span> </span><span>#&gt;</span><span>
    </span><span class="entity"><span>Method.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="HOL.fast|method"><span>fast</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cla_method'</span></span><span> </span><span class="entity"><span>fast_tac</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"classical prover (depth-first)"</span></span><span> </span><span>#&gt;</span><span>
    </span><span class="entity"><span>Method.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="HOL.slow|method"><span>slow</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cla_method'</span></span><span> </span><span class="entity"><span>slow_tac</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"classical prover (slow depth-first)"</span></span><span> </span><span>#&gt;</span><span>
    </span><span class="entity"><span>Method.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="HOL.best|method"><span>best</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cla_method'</span></span><span> </span><span class="entity"><span>best_tac</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"classical prover (best-first)"</span></span><span> </span><span>#&gt;</span><span>
    </span><span class="entity"><span>Method.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="HOL.deepen|method"><span>deepen</span></span><span>›</span></span></span><span>
      </span><span class="main"><span>(</span></span><span>Scan.lift</span><span> </span><span class="main"><span>(</span></span><span>Scan.optional</span><span> </span><span>Parse.nat</span><span> </span><span class="inner_numeral"><span>4</span></span><span class="main"><span>)</span></span><span> </span><span>--|</span><span> </span><span class="entity"><span>Method.sections</span></span><span> </span><span class="entity"><span>cla_modifiers</span></span><span>
        </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>SIMPLE_METHOD'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>deepen_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="inner_quoted"><span>"classical prover (iterative deepening)"</span></span><span> </span><span>#&gt;</span><span>
    </span><span class="entity"><span>Method.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="HOL.safe|method"><span>safe</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cla_method</span></span><span> </span><span class="main"><span>(</span></span><span>CHANGED_PROP</span><span> </span><span>o</span><span> </span><span class="entity"><span>safe_tac</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="inner_quoted"><span>"classical prover (apply safe rules)"</span></span><span> </span><span>#&gt;</span><span>
    </span><span class="entity"><span>Method.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="HOL.safe_step|method"><span>safe_step</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cla_method'</span></span><span> </span><span class="entity"><span>safe_step_tac</span></span><span class="main"><span>)</span></span><span>
      </span><span class="inner_quoted"><span>"single classical step (safe rules)"</span></span><span> </span><span>#&gt;</span><span>
    </span><span class="entity"><span>Method.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="HOL.inst_step|method"><span>inst_step</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cla_method'</span></span><span> </span><span class="entity"><span>inst_step_tac</span></span><span class="main"><span>)</span></span><span>
      </span><span class="inner_quoted"><span>"single classical step (safe rules, allow instantiations)"</span></span><span> </span><span>#&gt;</span><span>
    </span><span class="entity"><span>Method.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="HOL.step|method"><span>step</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cla_method'</span></span><span> </span><span class="entity"><span>step_tac</span></span><span class="main"><span>)</span></span><span>
      </span><span class="inner_quoted"><span>"single classical step (safe and unsafe rules)"</span></span><span> </span><span>#&gt;</span><span>
    </span><span class="entity"><span>Method.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="HOL.slow_step|method"><span>slow_step</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cla_method'</span></span><span> </span><span class="entity"><span>slow_step_tac</span></span><span class="main"><span>)</span></span><span>
      </span><span class="inner_quoted"><span>"single classical step (safe and unsafe rules, allow backtracking)"</span></span><span> </span><span>#&gt;</span><span>
    </span><span class="entity"><span>Method.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="HOL.clarify_step|method"><span>clarify_step</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cla_method'</span></span><span> </span><span class="entity"><span>clarify_step_tac</span></span><span class="main"><span>)</span></span><span>
      </span><span class="inner_quoted"><span>"single classical step (safe rules, without splitting)"</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(** outer syntax **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Outer_Syntax.command</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword1"><span>print_claset</span></span><span>›</span></span></span><span> </span><span class="inner_quoted"><span>"print context of Classical Reasoner"</span></span><span>
    </span><span class="main"><span>(</span></span><span>Scan.succeed</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Toplevel.keep</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>print_claset</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>Toplevel.context_of</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
</span></pre>
</body>

</html>