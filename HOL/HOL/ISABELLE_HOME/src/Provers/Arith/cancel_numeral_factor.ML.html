<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹~~/src/Provers/Arith/cancel_numeral_factor.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹~~/src/Provers/Arith/cancel_numeral_factor.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*  Title:      Provers/Arith/cancel_numeral_factor.ML
    Author:     Lawrence C Paulson, Cambridge University Computer Laboratory
    Copyright   2000  University of Cambridge

Cancel common coefficients in balanced expressions:

     u*#m ~~ u'*#m'  ==  #n*u ~~ #n'*u'

where ~~ is an appropriate balancing operation (e.g. =, &lt;=, &lt;, div, /)
and d = gcd(m,m') and n=m/d and n'=m'/d.

It works by (a) massaging both sides to bring gcd(m,m') to the front:

     u*#m ~~ u'*#m'  ==  #d*(#n*u) ~~ #d*(#n'*u')

(b) then using the rule "cancel" to reach #n*u ~~ #n'*u'.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>CANCEL_NUMERAL_FACTOR_DATA</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="comment1"><span>(*abstract syntax*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_bal</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> * </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> dest_bal</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> * </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_coeff</span><span class="main"><span>:</span></span><span> </span><span>int</span><span> * </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> dest_coeff</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> * </span><span>term</span><span>
  </span><span class="comment1"><span>(*rules*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> cancel</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> neg_exchanges</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span>  </span><span class="comment1"><span>(*true if a negative coeff swaps the two operands,
                             as with &lt; and &lt;= but not = and div*)</span></span><span>
  </span><span class="comment1"><span>(*proof tools*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> prove_conv</span><span class="main"><span>:</span></span><span> </span><span>tactic</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> * </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> trans_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>  </span><span class="comment1"><span>(*applies the initial lemma*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> norm_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>              </span><span class="comment1"><span>(*proves the initial lemma*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> numeral_simp_tac</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>      </span><span class="comment1"><span>(*proves the final theorem*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> simplify_meta_eq</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>  </span><span class="comment1"><span>(*simplifies the final theorem*)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>functor</span></span></span><span> </span><span class="entity"><span>CancelNumeralFactorFun</span></span><span class="main"><span>(</span></span><span>Data</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>CANCEL_NUMERAL_FACTOR_DATA</span></span><span class="main"><span>)</span></span><span class="main"><span>:</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> proc</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>cterm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>option</span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="comment1"><span>(*the simplification procedure*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>proc</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ct</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Simplifier.prems_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>ct</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>yield_singleton</span><span> </span><span class="main"><span>(</span></span><span>Variable.import_terms</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Data.dest_bal</span></span><span> </span><span class="entity"><span>t'</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t1'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Data.dest_coeff</span></span><span> </span><span class="entity"><span>t1</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t2'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Data.dest_coeff</span></span><span> </span><span class="entity"><span>t2</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>d</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="comment1"><span>(*if both are negative, also divide through by ~1*)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m1</span></span><span>&lt;</span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>m2</span></span><span>&lt;=</span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
         </span><span class="main"><span>(</span></span><span class="entity"><span>m1</span></span><span>&lt;=</span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>m2</span></span><span>&lt;</span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>~</span><span> </span><span class="main"><span>(</span></span><span>abs</span><span> </span><span class="main"><span>(</span></span><span>Integer.gcd</span><span> </span><span class="entity"><span>m1</span></span><span> </span><span class="entity"><span>m2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>abs</span><span> </span><span class="main"><span>(</span></span><span>Integer.gcd</span><span> </span><span class="entity"><span>m1</span></span><span> </span><span class="entity"><span>m2</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>d</span></span><span class="main"><span>=</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>   </span><span class="comment1"><span>(*trivial, so do nothing*)</span></span><span>
              </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"cancel_numeral_factor"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>newshape</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Data.mk_coeff</span></span><span class="main"><span>(</span></span><span class="entity"><span>d</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Data.mk_coeff</span></span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>n1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>m1</span></span><span> </span><span>div</span><span> </span><span class="entity"><span>d</span></span><span> </span><span class="keyword2"><span class="keyword"><span>and</span></span></span><span> </span><span class="entity"><span>n2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>m2</span></span><span> </span><span>div</span><span> </span><span class="entity"><span>d</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rhs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>d</span></span><span>&lt;</span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>Data.neg_exchanges</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>Data.mk_bal</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Data.mk_coeff</span></span><span class="main"><span>(</span></span><span class="entity"><span>n2</span></span><span class="main"><span>,</span></span><span class="entity"><span>t2'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Data.mk_coeff</span></span><span class="main"><span>(</span></span><span class="entity"><span>n1</span></span><span class="main"><span>,</span></span><span class="entity"><span>t1'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Data.mk_bal</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Data.mk_coeff</span></span><span class="main"><span>(</span></span><span class="entity"><span>n1</span></span><span class="main"><span>,</span></span><span class="entity"><span>t1'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Data.mk_coeff</span></span><span class="main"><span>(</span></span><span class="entity"><span>n2</span></span><span class="main"><span>,</span></span><span class="entity"><span>t2'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>reshape</span></span><span> </span><span class="main"><span>=</span></span><span>  </span><span class="comment1"><span>(*Move d to the front and put the rest into standard form
                       i * #m * j == #d * (#n * (j * k)) *)</span></span><span>
      </span><span class="entity"><span>Data.prove_conv</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Data.norm_tac</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>prems</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>t'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Data.mk_bal</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>newshape</span></span><span class="main"><span>(</span></span><span class="entity"><span>n1</span></span><span class="main"><span>,</span></span><span class="entity"><span>t1'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>newshape</span></span><span class="main"><span>(</span></span><span class="entity"><span>n2</span></span><span class="main"><span>,</span></span><span class="entity"><span>t2'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>Data.prove_conv</span></span><span>
       </span><span class="main"><span>[</span></span><span class="entity"><span>Data.trans_tac</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>reshape</span></span><span class="main"><span>,</span></span><span> </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Data.cancel</span></span><span class="main"><span>]</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>
        </span><span class="entity"><span>Data.numeral_simp_tac</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Option.map</span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>Data.simplify_meta_eq</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span>#&gt;</span><span>
        </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Variable.export</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="comment1"><span>(* FIXME avoid handling of generic exceptions *)</span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
       </span><span class="main"><span>|</span></span><span> </span><span>TYPE</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>;</span></span><span>   </span><span class="comment1"><span>(*Typically (if thy doesn't include Numeral)
                             Undeclared type constructor "Numeral.bin"*)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>
</span></pre>
</body>

</html>